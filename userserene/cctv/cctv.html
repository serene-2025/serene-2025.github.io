<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î - GoldenLand Serene</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
            animation-delay: 0.2s;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }

        /* Modal Transitions */
        .modal-active {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        .modal-active .modal-content {
            transform: scale(1) !important;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 min-h-screen flex flex-col pb-10 overflow-hidden" id="main-body">

    <!-- ================= MODALS ================= -->

    <!-- 1. Alert Modal (General Messages) -->
    <div id="alert-modal" class="fixed inset-0 flex items-center justify-center z-[1050] bg-black/50 backdrop-blur-sm p-4 hidden transition-opacity duration-300 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-solid fa-bell text-amber-600 text-xl"></i>
            </div>
            <h3 id="alert-title" class="text-lg font-bold text-gray-800 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <p id="alert-message" class="text-gray-600 mb-6">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
            <button onclick="closeAlert()" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>

    <!-- 2. Confirm Modal (Yes/No) -->
    <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center z-[1050] bg-black/50 backdrop-blur-sm p-4 hidden transition-opacity duration-300 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-solid fa-circle-question text-blue-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-3">
                <button id="confirm-no-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2.5 px-4 rounded-lg transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-yes-btn" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- 3. Password Modal (Admin Login) -->
    <div id="password-modal" class="fixed inset-0 flex items-center justify-center z-[1050] bg-black/50 backdrop-blur-sm p-4 hidden transition-opacity duration-300 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-12 h-12 bg-stone-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-solid fa-lock text-stone-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
            <p class="text-gray-600 mb-4 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
            
            <input type="password" id="admin-password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-amber-500 outline-none text-center text-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            
            <div class="flex gap-3">
                <button onclick="closePasswordModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2.5 px-4 rounded-lg transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="submitAdminPassword()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- PDPA Warning Modal (Startup) -->
    <div id="pdpa-modal" class="fixed inset-0 flex items-center justify-center z-[1000] bg-stone-900/90 backdrop-blur-md transition-opacity duration-500">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 relative overflow-hidden animate-shake border-t-4 border-amber-500">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fa-solid fa-shield-cat text-6xl"></i>
            </div>
            <div class="p-8">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-user-shield text-amber-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 leading-tight">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA)</h2>
                    </div>
                </div>
                <div class="bg-stone-50 border border-stone-200 rounded-lg p-4 mb-6 text-sm text-stone-600 h-48 overflow-y-auto custom-scrollbar">
                    <p class="font-bold text-stone-800 mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                    <p class="mb-2">‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏ã‡∏µ‡∏£‡∏µ‡∏ô ‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ñ‡∏∂‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                    <ul class="list-disc pl-5 space-y-1 mb-2">
                        <li><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡∏•‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
                        <li><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ 30 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</li>
                        <li><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</li>
                    </ul>
                    <p class="text-xs text-stone-400 mt-2">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>
                <button onclick="acceptPDPA()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:shadow-amber-500/30 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 group">
                    <span>‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
            <div class="bg-stone-100 p-3 text-center text-xs text-stone-400">
                Golden Land Serene Data Privacy Policy
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-amber-600 to-amber-500 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2.5 rounded-full text-amber-600 w-10 h-10 flex items-center justify-center shadow-sm relative">
                    <i class="fa-solid fa-video text-lg"></i>
                    <!-- LINE Indicator -->
                    <div id="line-status-dot" class="hidden absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold leading-tight">Golden Land Serene</h1>
                    <p id="user-greeting" class="text-xs md:text-sm text-amber-100 opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î</p>
                </div>
            </div>
            <button onclick="toggleView()" id="nav-btn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-sm transition-all flex items-center gap-2 border border-white/10">
                <i class="fa-solid fa-clock-rotate-left" id="nav-icon"></i>
                <span class="hidden md:inline" id="nav-text">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-3xl flex-grow relative">
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="loading-overlay hidden">
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-circle-notch fa-spin text-amber-600 text-4xl mb-3"></i>
                <p class="text-stone-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
            </div>
        </div>

        <!-- Success Modal (After Submission) -->
        <div id="success-modal" class="fixed inset-0 flex items-center justify-center z-[1050] bg-black/50 backdrop-blur-sm p-4 hidden transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-100">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fa-solid fa-circle-check text-green-600 text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            </div>
        </div>

        <!-- Admin Header Banner -->
        <div id="admin-banner" class="hidden bg-stone-800 text-white p-3 rounded-lg mb-6 flex justify-between items-center shadow-md animate-in slide-in-from-top-2">
            <div class="flex items-center gap-2">
                <div class="bg-amber-500 p-1.5 rounded text-stone-900">
                    <i class="fa-solid fa-user-shield text-sm"></i>
                </div>
                <span class="font-bold text-sm md:text-base">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</span>
            </div>
            <button onclick="logoutAdmin()" class="text-xs bg-stone-600 hover:bg-red-600 px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                <i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>

        <!-- LINE Profile Section (Visible if logged in via LINE) -->
        <div id="line-profile-section" class="hidden bg-white p-4 rounded-xl shadow-sm border border-stone-100 mb-6 flex items-center gap-3 animate-in fade-in">
            <img id="line-avatar" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover">
            <div>
                <p class="text-xs text-stone-400">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ LINE</p>
                <h3 id="line-name" class="font-bold text-stone-800 text-lg">Loading...</h3>
            </div>
            <div class="ml-auto">
                <i class="fa-brands fa-line text-green-500 text-3xl"></i>
            </div>
        </div>

        <!-- Form View -->
        <div id="form-view" class="fade-in">
            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-stone-100">
                <div class="p-6 border-b border-stone-100 bg-amber-50/50">
                    <h2 class="text-lg font-bold text-amber-800 flex items-center gap-2">
                        <i class="fa-solid fa-file-pen"></i>
                        ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û
                    </h2>
                    <p class="text-sm text-stone-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                </div>

                <form id="request-form" onsubmit="handleSubmit(event)" class="p-6 space-y-6">
                    <!-- Form Fields -->
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-stone-400 uppercase tracking-wider mb-3">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-solid fa-user absolute left-3 top-3 text-stone-400 text-sm"></i>
                                    <input type="text" name="requester_name" required class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ã‡∏≠‡∏¢ <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-solid fa-map-location-dot absolute left-3 top-3 text-stone-400 text-sm"></i>
                                    <input type="text" name="house_number" required class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô 998/45 ‡∏ã‡∏≠‡∏¢ 8">
                                </div>
                            </div>
                            <div class="space-y-1 md:col-span-2">
                                <label class="text-sm font-medium text-stone-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-solid fa-phone absolute left-3 top-3 text-stone-400 text-sm"></i>
                                    <input type="tel" name="phone" required class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="08x-xxx-xxxx">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-stone-100 my-4"></div>

                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-stone-400 uppercase tracking-wider mb-3">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ <span class="text-red-500">*</span></label>
                                <input type="date" name="incident_date" required class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-stone-600">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <select name="location" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-white appearance-none">
                                        <option value="MainGate">‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≠‡∏° ‡∏£‡∏õ‡∏†.</option>
                                        <option value="Fitness">‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™</option>
                                        <option value="Soi1">‡∏ã‡∏≠‡∏¢ 1</option>
                                        <option value="Soi2">‡∏ã‡∏≠‡∏¢ 2</option>
                                        <option value="Soi3">‡∏ã‡∏≠‡∏¢ 3</option>
                                        <option value="Soi4">‡∏ã‡∏≠‡∏¢ 4</option>
                                        <option value="Soi5">‡∏ã‡∏≠‡∏¢ 5</option>
                                        <option value="Soi6">‡∏ã‡∏≠‡∏¢ 6</option>
                                        <option value="Soi7">‡∏ã‡∏≠‡∏¢ 7</option>
                                        <option value="Soi8">‡∏ã‡∏≠‡∏¢ 8</option>
                                        <option value="Soi9">‡∏ã‡∏≠‡∏¢ 9</option>
                                        <option value="Soi10">‡∏ã‡∏≠‡∏¢ 10</option>
                                        <option value="Soi11">‡∏ã‡∏≠‡∏¢ 11</option>
                                        <option value="Soi12">‡∏ã‡∏≠‡∏¢ 12</option>
                                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ </option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-stone-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤ <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-regular fa-clock absolute left-3 top-3 text-stone-400 text-sm"></i>
                                    <input type="time" name="time_start" required class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-stone-600">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-700">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-regular fa-clock absolute left-3 top-3 text-stone-400 text-sm"></i>
                                    <input type="time" name="time_end" required class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none text-stone-600">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-sm font-medium text-stone-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span class="text-red-500">*</span></label>
                            <textarea name="reason" required rows="3" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none transition-all resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡πÄ‡∏â‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏ô, ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢"></textarea>
                        </div>

                        <div class="flex items-center gap-3 p-3 bg-stone-50 rounded-lg border border-stone-200 hover:bg-stone-100 transition-colors">
                            <input type="checkbox" id="policeReport" name="has_police_report" class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300 cursor-pointer">
                            <label for="policeReport" class="text-sm text-stone-700 cursor-pointer select-none flex-1">
                                ‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à <span class="text-stone-400 text-xs block md:inline">(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-100 text-sm text-amber-900">
                        <div class="flex gap-2 items-start">
                            <i class="fa-solid fa-circle-exclamation mt-1 shrink-0 text-amber-600"></i>
                            <div>
                                <span class="font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</span>
                                <p class="mt-1 text-amber-800/80 leading-relaxed">
                                    ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏ï‡∏Å‡∏•‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ü‡πâ‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏î‡πÜ ‡∏≠‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡πÉ‡∏ä‡πâ ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö [‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ø‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô] ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î
                                </p>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center gap-3 pt-2 border-t border-amber-200/50">
                            <input type="checkbox" id="consent" name="consent" required class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300 cursor-pointer">
                            <label for="consent" class="font-bold cursor-pointer select-none text-amber-800">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform active:scale-[0.99] transition-all duration-200 flex items-center justify-center gap-2">
                        <i class="fa-regular fa-paper-plane"></i>
                        ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á
                    </button>
                </form>
            </div>
        </div>

        <!-- List View -->
        <div id="list-view" class="hidden fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-stone-800 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-amber-600"></i>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
                </h2>
                <span id="request-count" class="text-sm text-stone-500 bg-white px-3 py-1 rounded-full shadow-sm border">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
            
            <div id="requests-container" class="space-y-3"></div>
            
            <div id="empty-state" class="hidden text-center py-12 bg-white rounded-xl border border-dashed border-stone-300">
                <div class="inline-block p-4 bg-stone-50 rounded-full mb-3 text-stone-300">
                    <i class="fa-regular fa-folder-open text-3xl"></i>
                </div>
                <p class="text-stone-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                <button onclick="toggleView()" class="mt-4 text-amber-600 font-semibold hover:underline">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-6 text-center text-stone-400 text-sm">
        <p>¬© 2026 ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</p>
        <p class="mt-1 flex items-center justify-center gap-2 mb-2">
            <i class="fa-solid fa-phone-volume"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: @500vulmn
        </p>
        <!-- Visible Admin Button -->
        <button onclick="openPasswordModal()" class="text-xs text-stone-300 hover:text-amber-600 underline decoration-dotted transition-colors flex items-center justify-center gap-1 mx-auto">
            <i class="fa-solid fa-user-shield"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        </button>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        
        // --- LINE LIFF CONFIGURATION ---
        const LIFF_ID = '2008949012-yIProy99'; 

        // --- TELEGRAM CONFIGURATION ---
        const TELEGRAM_BOT_TOKEN = '7708637309:AAHU2swP8U67XVWITdjsxjQoqiXIL9KbBJs';
        const TELEGRAM_CHAT_ID = '7585120244';

        // Initialize Supabase Client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentView = 'form';
        let requests = [];
        let isAdmin = false; 
        let lineProfile = null;

        // Constants
        const LOCATION_LABELS = {
            'MainGate': '‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≠‡∏° ‡∏£‡∏õ‡∏†.',
            'Fitness': '‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™',
            'Soi1': '‡∏ã‡∏≠‡∏¢ 1',
            'Soi2': '‡∏ã‡∏≠‡∏¢ 2',
            'Soi3': '‡∏ã‡∏≠‡∏¢ 3',
            'Soi4': '‡∏ã‡∏≠‡∏¢ 4',
            'Soi5': '‡∏ã‡∏≠‡∏¢ 5',
            'Soi6': '‡∏ã‡∏≠‡∏¢ 6',
            'Soi7': '‡∏ã‡∏≠‡∏¢ 7',
            'Soi8': '‡∏ã‡∏≠‡∏¢ 8',
            'Soi9': '‡∏ã‡∏≠‡∏¢ 9',
            'Soi10': '‡∏ã‡∏≠‡∏¢ 10',
            'Soi11': '‡∏ã‡∏≠‡∏¢ 11',
            'Soi12': '‡∏ã‡∏≠‡∏¢ 12'
        };

        // DOM Elements
        const mainBody = document.getElementById('main-body');
        const pdpaModal = document.getElementById('pdpa-modal');
        const formView = document.getElementById('form-view');
        const listView = document.getElementById('list-view');
        const navBtn = document.getElementById('nav-btn');
        const navIcon = document.getElementById('nav-icon');
        const navText = document.getElementById('nav-text');
        const requestForm = document.getElementById('request-form');
        const successModal = document.getElementById('success-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const requestsContainer = document.getElementById('requests-container');
        const emptyState = document.getElementById('empty-state');
        const requestCount = document.getElementById('request-count');
        const adminBanner = document.getElementById('admin-banner');
        
        const lineProfileSection = document.getElementById('line-profile-section');
        const lineAvatar = document.getElementById('line-avatar');
        const lineName = document.getElementById('line-name');
        const lineStatusDot = document.getElementById('line-status-dot');
        const userGreeting = document.getElementById('user-greeting');

        // Modal Elements
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const passwordModal = document.getElementById('password-modal');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if(sessionStorage.getItem('gls_admin') === 'true') {
                isAdmin = true;
                adminBanner.classList.remove('hidden');
            }
            initializeLiff();
        });

        // --- LINE LIFF FUNCTIONS ---
        async function initializeLiff() {
            try {
                if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID') {
                    await liff.init({ liffId: LIFF_ID });
                    if (liff.isLoggedIn()) {
                        getLineProfile();
                    }
                }
            } catch (err) {
                console.error('LIFF Init Error:', err);
            }
        }

        async function getLineProfile() {
            try {
                const profile = await liff.getProfile();
                lineProfile = profile;
                lineProfileSection.classList.remove('hidden');
                lineAvatar.src = profile.pictureUrl || 'https://via.placeholder.com/150';
                lineName.textContent = profile.displayName;
                lineStatusDot.classList.remove('hidden');
                userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${profile.displayName}`;
            } catch (err) {
                console.error('Error getting profile:', err);
            }
        }

        function acceptPDPA() {
            pdpaModal.classList.add('opacity-0');
            mainBody.classList.remove('overflow-hidden');
            setTimeout(() => { pdpaModal.classList.add('hidden'); }, 500);
        }

        // --- CUSTOM MODAL FUNCTIONS ---
        function showAlert(message, title = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô") {
            const modal = alertModal;
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            
            titleEl.textContent = title;
            msgEl.textContent = message;
            
            modal.classList.remove('hidden');
            // Slight delay for animation
            setTimeout(() => {
                modal.classList.add('modal-active');
            }, 10);
        }

        function closeAlert() {
            alertModal.classList.remove('modal-active');
            setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 300);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = confirmModal;
                const msgEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                msgEl.textContent = message;
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('modal-active'), 10);

                const close = (result) => {
                    modal.classList.remove('modal-active');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    resolve(result);
                    // Clear listeners
                    yesBtn.onclick = null;
                    noBtn.onclick = null;
                };

                yesBtn.onclick = () => close(true);
                noBtn.onclick = () => close(false);
            });
        }

        function openPasswordModal() {
            if (isAdmin) {
                showAlert("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡πâ‡∏ß", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                return;
            }
            const modal = passwordModal;
            const input = document.getElementById('admin-password-input');
            
            if (input) {
                input.value = ''; // Reset input safely
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('modal-active');
                    input.focus();
                }, 10);

                // Add enter key listener
                input.onkeyup = function(e) {
                    if (e.key === 'Enter') submitAdminPassword();
                };
            } else {
                console.error("Password input not found!");
            }
        }

        function closePasswordModal() {
            passwordModal.classList.remove('modal-active');
            setTimeout(() => {
                passwordModal.classList.add('hidden');
            }, 300);
        }

        function submitAdminPassword() {
            const input = document.getElementById('admin-password-input');
            const password = input.value;

            if (password === 'admin') {
                isAdmin = true;
                sessionStorage.setItem('gls_admin', 'true');
                adminBanner.classList.remove('hidden');
                closePasswordModal();
                showAlert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                if(currentView === 'list') loadRequests();
            } else {
                // Shake input effect
                input.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                setTimeout(() => {
                    input.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                }, 500);
                showAlert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            sessionStorage.removeItem('gls_admin');
            adminBanner.classList.add('hidden');
            showAlert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            if(currentView === 'list') loadRequests();
        }

        // --- TELEGRAM NOTIFICATION FUNCTION ---
        async function sendTelegramNotification(data) {
            const message = `
üîî *‡∏°‡∏µ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà*
-----------------------------
üë§ *‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:* ${data.requester_name}
üè† *‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:* ${data.house_number}
üìû *‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:* ${data.phone}
üìÖ *‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏:* ${data.incident_date}
‚è∞ *‡πÄ‡∏ß‡∏•‡∏≤:* ${data.time_start} - ${data.time_end}
üìç *‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:* ${LOCATION_LABELS[data.location] || data.location}
üìù *‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:* ${data.reason}
üëÆ *‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°:* ${data.has_police_report ? '‚úÖ ‡∏°‡∏µ' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ'}
-----------------------------
(‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Web App)
            `.trim();

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                console.log('Telegram notification sent.');
            } catch (error) {
                console.error('Error sending Telegram notification:', error);
            }
        }

        // --- MAIN FUNCTIONS ---

        async function updateRequestStatus(id, newStatus) {
            let confirmMsg = "";
            if (newStatus === 'approved') confirmMsg = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?";
            else if (newStatus === 'rejected') confirmMsg = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?";
            else if (newStatus === 'completed') confirmMsg = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)";
            
            // Use Custom Confirm Modal
            const confirmed = await showConfirm(confirmMsg);
            if (!confirmed) return;
            
            setLoading(true);
            try {
                const { error } = await supabaseClient
                    .from('cctv_requests')
                    .update({ status: newStatus })
                    .eq('id', id);

                if (error) throw error;
                await loadRequests();
            } catch (err) {
                console.error('Error updating status:', err);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, "Error");
            } finally {
                setLoading(false);
            }
        }

        async function loadRequests() {
            setLoading(true);
            try {
                const { data, error } = await supabaseClient
                    .from('cctv_requests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                requests = data || [];
                renderRequests();
            } catch (err) {
                console.error('Error loading requests:', err);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + err.message, "Error");
            } finally {
                setLoading(false);
            }
        }

        function toggleView() {
            currentView = currentView === 'form' ? 'list' : 'form';
            updateUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (currentView === 'list') {
                loadRequests(); 
            }
        }

        function updateUI() {
            if (currentView === 'form') {
                formView.classList.remove('hidden');
                listView.classList.add('hidden');
                navIcon.className = 'fa-solid fa-clock-rotate-left';
                navText.textContent = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠';
                navBtn.innerHTML = `<i class="fa-solid fa-clock-rotate-left"></i><span class="hidden md:inline ml-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠</span>`;
            } else {
                formView.classList.add('hidden');
                listView.classList.remove('hidden');
                navIcon.className = 'fa-solid fa-file-pen';
                navText.textContent = '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á';
                navBtn.innerHTML = `<i class="fa-solid fa-file-pen"></i><span class="hidden md:inline ml-2">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</span>`;
            }
        }

        function renderRequests() {
            const visibleRequests = requests.filter(req => isAdmin || req.status !== 'completed');

            requestCount.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${visibleRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (visibleRequests.length === 0) {
                requestsContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            requestsContainer.innerHTML = visibleRequests.map(req => {
                let containerClass = "bg-white border-stone-100"; 
                let statusBadgeClass = "bg-yellow-100 text-yellow-800";
                let statusText = "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö";

                if (req.status === 'approved') {
                    containerClass = "bg-green-50 border-green-200 ring-1 ring-green-100";
                    statusBadgeClass = "bg-green-500 text-white";
                    statusText = "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß";
                } else if (req.status === 'rejected') {
                    containerClass = "bg-white border-red-100";
                    statusBadgeClass = "bg-red-100 text-red-800";
                    statusText = "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò";
                } else if (req.status === 'completed') {
                    containerClass = "bg-gray-100 border-gray-200 opacity-75";
                    statusBadgeClass = "bg-gray-600 text-white";
                    statusText = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
                }

                const incidentDate = new Date(req.incident_date).toLocaleDateString('th-TH', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });

                let adminControls = '';
                let lineInfo = '';
                
                if (req.line_display_name) {
                     lineInfo = `
                        <div class="mt-2 pt-2 border-t border-dashed border-gray-100 flex items-center gap-2 text-xs text-stone-500">
                             <i class="fa-brands fa-line text-green-500"></i> ${req.line_display_name}
                        </div>
                     `;
                }

                if (isAdmin) {
                    adminControls = `
                        <div class="mt-3 pt-3 border-t border-gray-200/50 flex gap-2 justify-end">
                            <span class="text-xs text-stone-400 mr-auto flex items-center gap-1"><i class="fa-solid fa-user-gear"></i> Admin:</span>
                            ${req.status !== 'approved' && req.status !== 'completed' ? 
                                `<button onclick="updateRequestStatus(${req.id}, 'approved')" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded transition-colors shadow-sm"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>` : ''}
                            
                            ${req.status !== 'rejected' && req.status !== 'completed' ? 
                                `<button onclick="updateRequestStatus(${req.id}, 'rejected')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded transition-colors shadow-sm"><i class="fa-solid fa-xmark"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>` : ''}
                            
                            ${req.status !== 'completed' ? 
                                `<button onclick="updateRequestStatus(${req.id}, 'completed')" class="text-xs bg-stone-600 hover:bg-stone-700 text-white px-3 py-1.5 rounded transition-colors shadow-sm"><i class="fa-solid fa-box-archive"></i> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>` : ''}
                        </div>
                    `;
                }

                return `
                    <div class="${containerClass} p-4 rounded-xl shadow-sm border hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold rounded-bl-xl ${statusBadgeClass}">
                            ${statusText}
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1">
                                <div class="text-xs text-stone-400 mb-1 flex items-center gap-1">
                                    <i class="fa-solid fa-hashtag text-[10px]"></i> ID: ${req.id}
                                </div>
                                <h3 class="font-bold text-stone-800 mb-2 text-lg">${req.reason}</h3>
                                <div class="flex flex-wrap gap-y-2 gap-x-4 text-sm text-stone-600">
                                    <span class="flex items-center gap-1.5 bg-white/50 px-2 py-1 rounded border border-black/5">
                                        <i class="fa-solid fa-map-pin text-amber-500"></i> 
                                        ${LOCATION_LABELS[req.location] || req.location}
                                    </span>
                                    <span class="flex items-center gap-1.5 bg-white/50 px-2 py-1 rounded border border-black/5">
                                        <i class="fa-regular fa-calendar-check text-amber-500"></i> 
                                        ${incidentDate} (${req.time_start.slice(0,5)} - ${req.time_end.slice(0,5)} ‡∏ô.)
                                    </span>
                                </div>
                                <div class="mt-2 text-xs text-stone-400">
                                    ‡πÇ‡∏î‡∏¢: ${req.requester_name} (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${req.house_number})
                                </div>
                                ${lineInfo}
                            </div>
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rawData = Object.fromEntries(formData.entries());
            
            const payload = {
                requester_name: rawData.requester_name,
                house_number: rawData.house_number,
                phone: rawData.phone,
                incident_date: rawData.incident_date,
                time_start: rawData.time_start,
                time_end: rawData.time_end,
                location: rawData.location,
                reason: rawData.reason,
                has_police_report: formData.get('has_police_report') === 'on',
                status: 'pending',
                line_user_id: lineProfile ? lineProfile.userId : null,
                line_display_name: lineProfile ? lineProfile.displayName : null,
                line_picture_url: lineProfile ? lineProfile.pictureUrl : null
            };

            const consent = formData.get('consent') === 'on';

            if (!consent) {
                showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
                return;
            }

            setLoading(true);

            try {
                const { data, error } = await supabaseClient
                    .from('cctv_requests')
                    .insert([payload]);

                if (error) throw error;
                
                // Send Telegram Notification
                sendTelegramNotification(payload);

                successModal.classList.remove('hidden');
                void successModal.offsetWidth; 
                successModal.classList.remove('opacity-0');
                requestForm.reset();

                setTimeout(() => {
                    successModal.classList.add('opacity-0');
                    setTimeout(() => {
                        successModal.classList.add('hidden');
                        currentView = 'list';
                        updateUI();
                        loadRequests(); 
                    }, 300);
                }, 2000);

            } catch (err) {
                console.error('Error submitting request:', err);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message, "Error");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
