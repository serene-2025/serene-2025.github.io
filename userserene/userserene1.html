

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบข้อมูลสมาชิก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f9ff;
            -webkit-tap-highlight-color: transparent;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .card {
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:active {
            transform: scale(0.97);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .btn-secondary:active {
            transform: scale(0.97);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }
        .btn-danger:active {
            transform: scale(0.97);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .readonly-field {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        /* Mobile optimizations */
        input, select {
            font-size: 16px !important; /* Prevents iOS zoom on focus */
        }
        .action-btn {
            min-width: 44px; /* Minimum touch target size */
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Card style for mobile */
        .member-card {
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .member-card:active {
            background-color: #f9fafb;
        }
        /* Fixed bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        /* Add padding to main content to account for fixed bottom nav */
        .has-bottom-nav {
            padding-bottom: 70px;
        }
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
            z-index: 40;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 20px auto;
            border-radius: 12px;
            max-width: 90%;
            animation: modalFadeIn 0.3s;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="pb-16">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg sticky top-0 z-30">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">ระบบข้อมูลสมาชิก</h1>
                <button id="refreshBtn" class="bg-white text-blue-600 px-3 py-1 rounded-lg font-medium hover:bg-blue-50 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto flex-grow p-3 has-bottom-nav">
            <!-- Form Section -->
            <div id="formSection" class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">ข้อมูลสมาชิก</h2>
                <form id="memberForm" class="space-y-4">
                    <input type="hidden" id="rowId" value="">
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="date">วันที่</label>
                        <input type="text" id="date" class="w-full px-3 py-2 border rounded-lg readonly-field text-sm" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="uid">Uid</label>
                        <input type="text" id="uid" class="w-full px-3 py-2 border rounded-lg readonly-field text-sm" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="lineName">ชื่อไลน์</label>
                        <input type="text" id="lineName" class="w-full px-3 py-2 border rounded-lg readonly-field text-sm" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="fullName">ชื่อ-สกุล</label>
                        <input type="text" id="fullName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-700 text-sm mb-1" for="houseNumber">บ้านเลขที่</label>
                            <input type="text" id="houseNumber" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm mb-1" for="soi">ซอย</label>
                            <select id="soi" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="ซอย 1">ซอย 1</option>
                                <option value="ซอย 2">ซอย 2</option>
                                <option value="ซอย 3">ซอย 3</option>
                                <option value="ซอย 4">ซอย 4</option>
                                <option value="ซอย 5">ซอย 5</option>
                                <option value="ซอย 6">ซอย 6</option>
                                <option value="ซอย 7">ซอย 7</option>
                                <option value="ซอย 8">ซอย 8</option>
                                <option value="ซอย 9">ซอย 9</option>
                                <option value="ซอย 10">ซอย 10</option>
                                <option value="ซอย 11">ซอย 11</option>
                                <option value="ซอย 12">ซอย 12</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-700 text-sm mb-1" for="residenceStatus">การอยู่</label>
                            <select id="residenceStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="เจ้าของบ้าน">เจ้าของบ้าน</option>
                                <option value="ผู้อาศัย">ผู้อาศัย</option>
                                <option value="ผู้เช่า">ผู้เช่า</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm mb-1" for="memberCount">สมาชิก</label>
                            <input type="number" id="memberCount" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="phone">เบอร์โทร</label>
                        <input type="tel" id="phone" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="email">Email</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="lineId">IDLine</label>
                        <input type="text" id="lineId" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm mb-1" for="profilePicture">รูปโปรไฟล์ (URL)</label>
                        <input type="text" id="profilePicture" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button type="submit" id="saveBtn" class="btn-primary text-white px-8 py-3 rounded-lg font-medium w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            บันทึกข้อมูล
                        </button>
                    </div>
                </form>
            </div>

            <!-- Table Section (Mobile Card View) -->
            <div id="tableSection" class="hidden">
                <div class="mb-4 sticky top-16 z-20 bg-white p-3 rounded-lg shadow">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ค้นหาสมาชิก..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pl-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                
                <div id="memberCards" class="space-y-3">
                    <!-- Member cards will be populated here -->
                </div>
                
                <div id="pagination" class="flex justify-center mt-6 space-x-2 pb-4">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button id="newMemberBtn" class="fab btn-primary text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="flex justify-around">
                <button id="formTabBtn" class="flex flex-col items-center py-3 px-6 text-blue-600 tab-active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="text-xs mt-1">แบบฟอร์ม</span>
                </button>
                <button id="tableTabBtn" class="flex flex-col items-center py-3 px-6 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    <span class="text-xs mt-1">รายการ</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Member Details Modal -->
    <div id="memberDetailsModal" class="modal">
        <div class="modal-content max-w-md mx-auto">
            <div class="p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">รายละเอียดสมาชิก</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="memberDetailsContent" class="space-y-4">
                    <!-- Member details will be populated here -->
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="closeDetailsBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">
                        ปิด
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE'; // Your Sheet ID
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyh3NCHw4PVOFiFF8pR9AMI8Nd_Z5am-rjdGAIkp82jpsXLs-7XvPullyyTQqsBOD0M/exec'; // Your App Script URL
        const SHEET_NAME = 'user'; // Your Sheet name
        const DELETE_PASSWORD = '123456'; // Password required for deletion
        const START_ROW = 3; // Start fetching data from row 3
        let allMembers = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // DOM Elements
        const formTabBtn = document.getElementById('formTabBtn');
        const tableTabBtn = document.getElementById('tableTabBtn');
        const formSection = document.getElementById('formSection');
        const tableSection = document.getElementById('tableSection');
        const memberForm = document.getElementById('memberForm');
        const memberCards = document.getElementById('memberCards');
        const pagination = document.getElementById('pagination');
        const refreshBtn = document.getElementById('refreshBtn');
        const newMemberBtn = document.getElementById('newMemberBtn');
        const searchInput = document.getElementById('searchInput');
        const memberDetailsModal = document.getElementById('memberDetailsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        const memberDetailsContent = document.getElementById('memberDetailsContent');

        // Initialize date field with current date
        document.getElementById('date').value = formatDate(new Date());

        // Tab switching
        formTabBtn.addEventListener('click', () => {
            formTabBtn.classList.add('text-blue-600', 'tab-active');
            formTabBtn.classList.remove('text-gray-500');
            tableTabBtn.classList.add('text-gray-500');
            tableTabBtn.classList.remove('text-blue-600', 'tab-active');
            formSection.classList.remove('hidden');
            tableSection.classList.add('hidden');
        });

        tableTabBtn.addEventListener('click', () => {
            tableTabBtn.classList.add('text-blue-600', 'tab-active');
            tableTabBtn.classList.remove('text-gray-500');
            formTabBtn.classList.add('text-gray-500');
            formTabBtn.classList.remove('text-blue-600', 'tab-active');
            tableSection.classList.remove('hidden');
            formSection.classList.add('hidden');
            fetchMembers();
        });

        // New member button
        newMemberBtn.addEventListener('click', () => {
            resetForm();
            formTabBtn.click();
        });

        // Refresh button
        refreshBtn.addEventListener('click', () => {
            if (tableSection.classList.contains('hidden')) {
                resetForm();
            } else {
                fetchMembers();
            }
        });

        // Search functionality
        searchInput.addEventListener('input', () => {
            filterMembers();
        });

        // Form submission
        memberForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveData();
        });

        // Modal close buttons
        closeModalBtn.addEventListener('click', () => {
            memberDetailsModal.style.display = 'none';
        });

        closeDetailsBtn.addEventListener('click', () => {
            memberDetailsModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === memberDetailsModal) {
                memberDetailsModal.style.display = 'none';
            }
        });

        // Format date to DD/MM/YYYY, HH:MM:SS
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
        }

        // Format phone number to ensure it starts with 0
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            // Remove any non-digit characters
            let digits = phone.replace(/\D/g, '');
            
            // If it doesn't start with 0, add it
            if (digits.length > 0 && digits.charAt(0) !== '0') {
                digits = '0' + digits;
            }
            
            return digits;
        }

        // Reset form
        function resetForm() {
            memberForm.reset();
            document.getElementById('rowId').value = '';
            document.getElementById('date').value = formatDate(new Date());
            document.getElementById('uid').value = '';
            document.getElementById('lineName').value = '';
            
            // Enable fields for new entry
            document.getElementById('uid').readOnly = false;
            document.getElementById('uid').classList.remove('readonly-field');
            document.getElementById('lineName').readOnly = false;
            document.getElementById('lineName').classList.remove('readonly-field');
        }

        // Save data to Google Sheets
        function saveData() {
            // Validate form
            const fullName = document.getElementById('fullName').value.trim();
            const houseNumber = document.getElementById('houseNumber').value.trim();
            let phone = document.getElementById('phone').value.trim();
            
            if (!fullName) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกชื่อ-สกุล',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            if (!houseNumber) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกบ้านเลขที่',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            if (!phone) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกเบอร์โทร',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            // Format phone number
            phone = formatPhoneNumber(phone);
            document.getElementById('phone').value = phone;
            
            // Show loading alert
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const rowId = document.getElementById('rowId').value;
            const isUpdate = rowId !== '';
            
            // Collect form data
            const formData = {
                date: document.getElementById('date').value,
                uid: document.getElementById('uid').value,
                lineName: document.getElementById('lineName').value,
                fullName: document.getElementById('fullName').value,
                houseNumber: document.getElementById('houseNumber').value,
                soi: document.getElementById('soi').value,
                residenceStatus: document.getElementById('residenceStatus').value,
                memberCount: document.getElementById('memberCount').value,
                phone: phone,
                email: document.getElementById('email').value,
                lineId: document.getElementById('lineId').value,
                profilePicture: document.getElementById('profilePicture').value,
                rowId: rowId,
                sheetName: SHEET_NAME
            };

            // Create a callback function name
            const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
            
            // Define the callback function
            window[callbackName] = function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isUpdate ? 'อัพเดทข้อมูลสำเร็จ' : 'บันทึกข้อมูลสำเร็จ',
                        confirmButtonColor: '#3b82f6'
                    });
                    resetForm();
                    if (!tableSection.classList.contains('hidden')) {
                        fetchMembers();
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.error || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonColor: '#ef4444'
                    });
                }
                // Clean up the callback function
                delete window[callbackName];
            };

            // Create script element for JSONP request
            const script = document.createElement('script');
            const params = new URLSearchParams({
                action: isUpdate ? 'update' : 'add',
                callback: callbackName,
                data: JSON.stringify(formData)
            });
            
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(script);
            
            // Remove the script element after execution
            script.onload = function() {
                document.body.removeChild(script);
            };
        }

        // Fetch members from Google Sheets
        function fetchMembers() {
            // Show loading alert
            Swal.fire({
                title: 'กำลังโหลดข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Create a callback function name
            const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
            
            // Define the callback function
            window[callbackName] = function(response) {
                if (response.success) {
                    // Filter data to start from row 3 (adjust rowId accordingly)
                    allMembers = (response.data || []).filter(member => {
                        const rowNum = parseInt(member.rowId);
                        return rowNum >= START_ROW;
                    });
                    
                    // Format phone numbers
                    allMembers.forEach(member => {
                        if (member.phone) {
                            member.phone = formatPhoneNumber(member.phone);
                        }
                    });
                    
                    filterMembers();
                    Swal.close();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.error || 'ไม่สามารถโหลดข้อมูลได้',
                        confirmButtonColor: '#ef4444'
                    });
                }
                // Clean up the callback function
                delete window[callbackName];
            };

            // Create script element for JSONP request
            const script = document.createElement('script');
            const params = new URLSearchParams({
                action: 'getAll',
                callback: callbackName,
                sheetName: SHEET_NAME
            });
            
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(script);
            
            // Remove the script element after execution
            script.onload = function() {
                document.body.removeChild(script);
            };
        }

        // Filter members based on search input
        function filterMembers() {
            const searchTerm = searchInput.value.toLowerCase();
            let filteredMembers = allMembers;
            
            if (searchTerm) {
                filteredMembers = allMembers.filter(member => 
                    (member.fullName && member.fullName.toLowerCase().includes(searchTerm)) ||
                    (member.phone && member.phone.toLowerCase().includes(searchTerm)) ||
                    (member.houseNumber && member.houseNumber.toLowerCase().includes(searchTerm)) ||
                    (member.soi && member.soi.toLowerCase().includes(searchTerm))
                );
            }
            
            displayMembers(filteredMembers);
        }

        // Display members in card view for mobile
        function displayMembers(members) {
            // Calculate pagination
            const totalPages = Math.ceil(members.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentMembers = members.slice(startIndex, endIndex);
            
            // Clear cards
            memberCards.innerHTML = '';
            
            if (currentMembers.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center py-10';
                emptyState.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p class="mt-4 text-gray-500 text-lg">ไม่พบข้อมูลสมาชิก</p>
                `;
                memberCards.appendChild(emptyState);
            } else {
                // Add members as cards
                currentMembers.forEach((member) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-4 member-card';
                    card.dataset.id = member.rowId;
                    
                    card.innerHTML = `
                        <div class="flex items-center">
                            ${member.profilePicture ? 
                                `<img src="${member.profilePicture}" alt="Profile" class="h-12 w-12 rounded-full mr-3 object-cover">` : 
                                `<div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    <span class="text-blue-500 font-medium text-lg">${member.fullName ? member.fullName.charAt(0) : '?'}</span>
                                </div>`
                            }
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-medium text-gray-900">${member.fullName || '-'}</h3>
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${member.memberCount || '0'} คน</span>
                                </div>
                                <p class="text-sm text-gray-500">${member.lineName || '-'}</p>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500">บ้านเลขที่:</span>
                                <span class="font-medium">${member.houseNumber || '-'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">ซอย:</span>
                                <span class="font-medium">${member.soi || '-'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">เบอร์โทร:</span>
                                <a href="tel:${member.phone}" class="font-medium text-blue-600">${member.phone || '-'}</a>
                            </div>
                            <div>
                                <span class="text-gray-500">การอยู่:</span>
                                <span class="font-medium">${member.residenceStatus || '-'}</span>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button class="view-btn bg-green-500 text-white px-3 py-1 rounded-lg flex items-center action-btn" data-id="${member.rowId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                ดูข้อมูล
                            </button>
                            <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-lg flex items-center action-btn" data-id="${member.rowId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                แก้ไข
                            </button>
                            <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-lg flex items-center action-btn" data-id="${member.rowId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                ลบ
                            </button>
                        </div>
                    `;
                    
                    memberCards.appendChild(card);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        viewMemberDetails(btn.dataset.id);
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        editMember(btn.dataset.id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        deleteMember(btn.dataset.id);
                    });
                });
            }
            
            // Update pagination
            updatePagination(totalPages);
        }

        // Update pagination controls
        function updatePagination(totalPages) {
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-1 rounded-md ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
            prevBtn.innerHTML = '&laquo;';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    filterMembers();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers - show fewer pages on mobile
            const maxPages = 3;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 rounded-md ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    filterMembers();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-1 rounded-md ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
            nextBtn.innerHTML = '&raquo;';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    filterMembers();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // View member details
        function viewMemberDetails(rowId) {
            const member = allMembers.find(m => m.rowId === rowId);
            if (!member) return;
            
            // Populate modal content
            memberDetailsContent.innerHTML = `
                <div class="flex flex-col items-center mb-4">
                    ${member.profilePicture ? 
                        `<img src="${member.profilePicture}" alt="Profile" class="h-24 w-24 rounded-full mb-3 object-cover">` : 
                        `<div class="h-24 w-24 rounded-full bg-blue-100 flex items-center justify-center mb-3">
                            <span class="text-blue-500 font-bold text-2xl">${member.fullName ? member.fullName.charAt(0) : '?'}</span>
                        </div>`
                    }
                    <h4 class="text-lg font-semibold text-gray-900">${member.fullName || '-'}</h4>
                    <p class="text-gray-500">${member.lineName || '-'}</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-sm text-gray-500">วันที่</p>
                            <p class="font-medium">${member.date || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Uid</p>
                            <p class="font-medium">${member.uid || '-'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-sm text-gray-500">บ้านเลขที่</p>
                            <p class="font-medium">${member.houseNumber || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">ซอย</p>
                            <p class="font-medium">${member.soi || '-'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-sm text-gray-500">การอยู่</p>
                            <p class="font-medium">${member.residenceStatus || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">สมาชิก</p>
                            <p class="font-medium">${member.memberCount || '0'} คน</p>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">เบอร์โทร</p>
                        <p class="font-medium">
                            <a href="tel:${member.phone}" class="text-blue-600">${member.phone || '-'}</a>
                        </p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">Email</p>
                        <p class="font-medium">
                            ${member.email ? `<a href="mailto:${member.email}" class="text-blue-600">${member.email}</a>` : '-'}
                        </p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">IDLine</p>
                        <p class="font-medium">${member.lineId || '-'}</p>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center space-x-3">
                    <button class="edit-modal-btn bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center" data-id="${member.rowId}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        แก้ไขข้อมูล
                    </button>
                    <button class="delete-modal-btn bg-red-500 text-white px-4 py-2 rounded-lg flex items-center" data-id="${member.rowId}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ลบข้อมูล
                    </button>
                </div>
            `;
            
            // Add event listeners to modal buttons
            const editModalBtn = memberDetailsContent.querySelector('.edit-modal-btn');
            if (editModalBtn) {
                editModalBtn.addEventListener('click', () => {
                    memberDetailsModal.style.display = 'none';
                    editMember(editModalBtn.dataset.id);
                });
            }
            
            const deleteModalBtn = memberDetailsContent.querySelector('.delete-modal-btn');
            if (deleteModalBtn) {
                deleteModalBtn.addEventListener('click', () => {
                    memberDetailsModal.style.display = 'none';
                    deleteMember(deleteModalBtn.dataset.id);
                });
            }
            
            // Show modal
            memberDetailsModal.style.display = 'block';
        }

        // Edit member
        function editMember(rowId) {
            const member = allMembers.find(m => m.rowId === rowId);
            if (!member) return;
            
            // Fill form with member data
            document.getElementById('rowId').value = member.rowId;
            document.getElementById('date').value = member.date || formatDate(new Date());
            document.getElementById('uid').value = member.uid || '';
            document.getElementById('lineName').value = member.lineName || '';
            document.getElementById('fullName').value = member.fullName || '';
            document.getElementById('houseNumber').value = member.houseNumber || '';
            
            // Set soi dropdown value
            const soiSelect = document.getElementById('soi');
            if (member.soi) {
                // Check if the soi value exists in options
                let soiExists = false;
                for (let i = 0; i < soiSelect.options.length; i++) {
                    if (soiSelect.options[i].value === member.soi) {
                        soiSelect.selectedIndex = i;
                        soiExists = true;
                        break;
                    }
                }
                // If not, add it as a new option
                if (!soiExists) {
                    const newOption = document.createElement('option');
                    newOption.value = member.soi;
                    newOption.text = member.soi;
                    soiSelect.add(newOption);
                    soiSelect.value = member.soi;
                }
            }
            
            document.getElementById('residenceStatus').value = member.residenceStatus || 'เจ้าของบ้าน';
            document.getElementById('memberCount').value = member.memberCount || '';
            document.getElementById('phone').value = member.phone || '';
            document.getElementById('email').value = member.email || '';
            document.getElementById('lineId').value = member.lineId || '';
            document.getElementById('profilePicture').value = member.profilePicture || '';
            
            // Make date, uid, and lineName read-only
            document.getElementById('uid').readOnly = true;
            document.getElementById('uid').classList.add('readonly-field');
            document.getElementById('lineName').readOnly = true;
            document.getElementById('lineName').classList.add('readonly-field');
            
            // Switch to form tab
            formTabBtn.click();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete member
        function deleteMember(rowId) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'กรุณาใส่รหัสผ่านเพื่อลบข้อมูล',
                input: 'password',
                inputPlaceholder: 'รหัสผ่าน',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ลบข้อมูล',
                cancelButtonText: 'ยกเลิก',
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณาใส่รหัสผ่าน';
                    }
                    if (value !== DELETE_PASSWORD) {
                        return 'รหัสผ่านไม่ถูกต้อง';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading alert
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        text: 'โปรดรอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Create a callback function name
                    const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
                    
                    // Define the callback function
                    window[callbackName] = function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบข้อมูลสำเร็จ',
                                confirmButtonColor: '#3b82f6'
                            });
                            fetchMembers();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.error || 'ไม่สามารถลบข้อมูลได้',
                                confirmButtonColor: '#ef4444'
                            });
                        }
                        // Clean up the callback function
                        delete window[callbackName];
                    };
                    
                    // Create script element for JSONP request
                    const script = document.createElement('script');
                    const params = new URLSearchParams({
                        action: 'delete',
                        callback: callbackName,
                        rowId: rowId,
                        sheetName: SHEET_NAME
                    });
                    
                    script.src = `${SCRIPT_URL}?${params.toString()}`;
                    document.body.appendChild(script);
                    
                    // Remove the script element after execution
                    script.onload = function() {
                        document.body.removeChild(script);
                    };
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we should show form or table view based on screen size
            if (window.innerWidth < 768) {
                formTabBtn.click();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95bb3958002b7b62',t:'MTc1MTkzMjAxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

