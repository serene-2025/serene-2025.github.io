

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบข้อมูลสมาชิก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f9ff;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .readonly-field {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold">ระบบข้อมูลสมาชิก</h1>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        รีเฟรช
                    </button>
                    <button id="newMemberBtn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        เพิ่มสมาชิกใหม่
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto flex-grow p-4">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="formTab" class="px-6 py-3 tab-active">แบบฟอร์มข้อมูล</button>
                <button id="tableTab" class="px-6 py-3">รายการสมาชิกทั้งหมด</button>
            </div>

            <!-- Form Section -->
            <div id="formSection" class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">ข้อมูลสมาชิก</h2>
                <form id="memberForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="rowId" value="">
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="date">วันที่</label>
                        <input type="text" id="date" class="w-full px-4 py-2 border rounded-lg readonly-field" readonly>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="uid">Uid</label>
                        <input type="text" id="uid" class="w-full px-4 py-2 border rounded-lg readonly-field" readonly>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="lineName">ชื่อไลน์</label>
                        <input type="text" id="lineName" class="w-full px-4 py-2 border rounded-lg readonly-field" readonly>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="fullName">ชื่อ-สกุล</label>
                        <input type="text" id="fullName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="houseNumber">บ้านเลขที่</label>
                        <input type="text" id="houseNumber" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="soi">ซอย</label>
                        <select id="soi" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="ซอย 1">ซอย 1</option>
                            <option value="ซอย 2">ซอย 2</option>
                            <option value="ซอย 3">ซอย 3</option>
                            <option value="ซอย 4">ซอย 4</option>
                            <option value="ซอย 5">ซอย 5</option>
                            <option value="ซอย 6">ซอย 6</option>
                            <option value="ซอย 7">ซอย 7</option>
                            <option value="ซอย 8">ซอย 8</option>
                            <option value="ซอย 9">ซอย 9</option>
                            <option value="ซอย 10">ซอย 10</option>
                            <option value="ซอย 11">ซอย 11</option>
                            <option value="ซอย 12">ซอย 12</option>
                        </select>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="residenceStatus">การอยู่</label>
                        <select id="residenceStatus" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="เจ้าของบ้าน">เจ้าของบ้าน</option>
                            <option value="ผู้อาศัย">ผู้อาศัย</option>
                            <option value="ผู้เช่า">ผู้เช่า</option>
                        </select>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="memberCount">สมาชิก</label>
                        <input type="number" id="memberCount" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="phone">เบอร์โทร</label>
                        <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="email">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="lineId">IDLine</label>
                        <input type="text" id="lineId" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-gray-700 mb-2" for="profilePicture">รูปโปรไฟล์ (URL)</label>
                        <input type="text" id="profilePicture" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="col-span-2 flex justify-center mt-6">
                        <button type="submit" id="saveBtn" class="btn-primary text-white px-8 py-3 rounded-lg font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            บันทึกข้อมูล
                        </button>
                    </div>
                </form>
            </div>

            <!-- Table Section -->
            <div id="tableSection" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">รายการสมาชิกทั้งหมด</h2>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ค้นหาสมาชิก..." class="w-64 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pl-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left">ชื่อ-สกุล</th>
                                <th class="py-3 px-4 text-left">บ้านเลขที่</th>
                                <th class="py-3 px-4 text-left">ซอย</th>
                                <th class="py-3 px-4 text-left">เบอร์โทร</th>
                                <th class="py-3 px-4 text-left">สมาชิก</th>
                                <th class="py-3 px-4 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="pagination" class="flex justify-center mt-6 space-x-2">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white p-4 text-center">
            <p>© 2024 ระบบข้อมูลสมาชิก - พัฒนาโดย Canva Code</p>
        </footer>
    </div>

    <script>
        // Global variables
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE'; // Your Sheet ID
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyh3NCHw4PVOFiFF8pR9AMI8Nd_Z5am-rjdGAIkp82jpsXLs-7XvPullyyTQqsBOD0M/exec'; // Your App Script URL
        const SHEET_NAME = 'user'; // Your Sheet name
        const DELETE_PASSWORD = '123456'; // Password required for deletion
        const START_ROW = 3; // Start fetching data from row 3
        let allMembers = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // DOM Elements
        const formTab = document.getElementById('formTab');
        const tableTab = document.getElementById('tableTab');
        const formSection = document.getElementById('formSection');
        const tableSection = document.getElementById('tableSection');
        const memberForm = document.getElementById('memberForm');
        const memberTableBody = document.getElementById('memberTableBody');
        const pagination = document.getElementById('pagination');
        const refreshBtn = document.getElementById('refreshBtn');
        const newMemberBtn = document.getElementById('newMemberBtn');
        const searchInput = document.getElementById('searchInput');

        // Initialize date field with current date
        document.getElementById('date').value = formatDate(new Date());

        // Tab switching
        formTab.addEventListener('click', () => {
            formTab.classList.add('tab-active');
            tableTab.classList.remove('tab-active');
            formSection.classList.remove('hidden');
            tableSection.classList.add('hidden');
        });

        tableTab.addEventListener('click', () => {
            tableTab.classList.add('tab-active');
            formTab.classList.remove('tab-active');
            tableSection.classList.remove('hidden');
            formSection.classList.add('hidden');
            fetchMembers();
        });

        // New member button
        newMemberBtn.addEventListener('click', () => {
            resetForm();
            formTab.click();
        });

        // Refresh button
        refreshBtn.addEventListener('click', () => {
            if (tableSection.classList.contains('hidden')) {
                resetForm();
            } else {
                fetchMembers();
            }
        });

        // Search functionality
        searchInput.addEventListener('input', () => {
            filterMembers();
        });

        // Form submission
        memberForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveData();
        });

        // Format date to DD/MM/YYYY, HH:MM:SS
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
        }

        // Reset form
        function resetForm() {
            memberForm.reset();
            document.getElementById('rowId').value = '';
            document.getElementById('date').value = formatDate(new Date());
            document.getElementById('uid').value = '';
            document.getElementById('lineName').value = '';
            
            // Enable fields for new entry
            document.getElementById('uid').readOnly = false;
            document.getElementById('uid').classList.remove('readonly-field');
            document.getElementById('lineName').readOnly = false;
            document.getElementById('lineName').classList.remove('readonly-field');
        }

        // Save data to Google Sheets
        function saveData() {
            // Show loading alert
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const rowId = document.getElementById('rowId').value;
            const isUpdate = rowId !== '';
            
            // Collect form data
            const formData = {
                date: document.getElementById('date').value,
                uid: document.getElementById('uid').value,
                lineName: document.getElementById('lineName').value,
                fullName: document.getElementById('fullName').value,
                houseNumber: document.getElementById('houseNumber').value,
                soi: document.getElementById('soi').value,
                residenceStatus: document.getElementById('residenceStatus').value,
                memberCount: document.getElementById('memberCount').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                lineId: document.getElementById('lineId').value,
                profilePicture: document.getElementById('profilePicture').value,
                rowId: rowId,
                sheetName: SHEET_NAME
            };

            // Create a callback function name
            const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
            
            // Define the callback function
            window[callbackName] = function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isUpdate ? 'อัพเดทข้อมูลสำเร็จ' : 'บันทึกข้อมูลสำเร็จ',
                        text: `รหัส: ${response.id || 'N/A'}`,
                        confirmButtonColor: '#3b82f6'
                    });
                    resetForm();
                    if (!tableSection.classList.contains('hidden')) {
                        fetchMembers();
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.error || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonColor: '#ef4444'
                    });
                }
                // Clean up the callback function
                delete window[callbackName];
            };

            // Create script element for JSONP request
            const script = document.createElement('script');
            const params = new URLSearchParams({
                action: isUpdate ? 'update' : 'add',
                callback: callbackName,
                data: JSON.stringify(formData)
            });
            
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(script);
            
            // Remove the script element after execution
            script.onload = function() {
                document.body.removeChild(script);
            };
        }

        // Fetch members from Google Sheets
        function fetchMembers() {
            // Show loading alert
            Swal.fire({
                title: 'กำลังโหลดข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Create a callback function name
            const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
            
            // Define the callback function
            window[callbackName] = function(response) {
                if (response.success) {
                    // Filter data to start from row 3 (adjust rowId accordingly)
                    allMembers = (response.data || []).filter(member => {
                        const rowNum = parseInt(member.rowId);
                        return rowNum >= START_ROW;
                    });
                    
                    filterMembers();
                    Swal.close();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.error || 'ไม่สามารถโหลดข้อมูลได้',
                        confirmButtonColor: '#ef4444'
                    });
                }
                // Clean up the callback function
                delete window[callbackName];
            };

            // Create script element for JSONP request
            const script = document.createElement('script');
            const params = new URLSearchParams({
                action: 'getAll',
                callback: callbackName,
                sheetName: SHEET_NAME
            });
            
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.body.appendChild(script);
            
            // Remove the script element after execution
            script.onload = function() {
                document.body.removeChild(script);
            };
        }

        // Filter members based on search input
        function filterMembers() {
            const searchTerm = searchInput.value.toLowerCase();
            let filteredMembers = allMembers;
            
            if (searchTerm) {
                filteredMembers = allMembers.filter(member => 
                    (member.fullName && member.fullName.toLowerCase().includes(searchTerm)) ||
                    (member.phone && member.phone.toLowerCase().includes(searchTerm)) ||
                    (member.houseNumber && member.houseNumber.toLowerCase().includes(searchTerm)) ||
                    (member.soi && member.soi.toLowerCase().includes(searchTerm))
                );
            }
            
            displayMembers(filteredMembers);
        }

        // Display members in the table
        function displayMembers(members) {
            // Calculate pagination
            const totalPages = Math.ceil(members.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentMembers = members.slice(startIndex, endIndex);
            
            // Clear table
            memberTableBody.innerHTML = '';
            
            if (currentMembers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500">ไม่พบข้อมูลสมาชิก</td>
                `;
                memberTableBody.appendChild(row);
            } else {
                // Add members to table
                currentMembers.forEach((member, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="flex items-center">
                                ${member.profilePicture ? 
                                    `<img src="${member.profilePicture}" alt="Profile" class="h-10 w-10 rounded-full mr-3">` : 
                                    `<div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                        <span class="text-blue-500 font-medium">${member.fullName ? member.fullName.charAt(0) : '?'}</span>
                                    </div>`
                                }
                                <div>
                                    <p class="font-medium">${member.fullName || '-'}</p>
                                    <p class="text-sm text-gray-500">${member.lineName || '-'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <p>${member.houseNumber || '-'}</p>
                        </td>
                        <td class="py-3 px-4">
                            <p>${member.soi || '-'}</p>
                        </td>
                        <td class="py-3 px-4">
                            <p>${member.phone || '-'}</p>
                            <p class="text-sm text-gray-500">${member.email || '-'}</p>
                        </td>
                        <td class="py-3 px-4">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${member.memberCount || '0'} คน</span>
                            <p class="text-sm text-gray-500 mt-1">${member.residenceStatus || '-'}</p>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <button class="edit-btn bg-blue-500 text-white p-2 rounded-lg mr-2" data-id="${member.rowId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="delete-btn bg-red-500 text-white p-2 rounded-lg" data-id="${member.rowId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    `;
                    memberTableBody.appendChild(row);
                });
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => editMember(btn.dataset.id));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteMember(btn.dataset.id));
                });
            }
            
            // Update pagination
            updatePagination(totalPages);
        }

        // Update pagination controls
        function updatePagination(totalPages) {
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-1 rounded-md ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
            prevBtn.innerHTML = '&laquo;';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    filterMembers();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 rounded-md ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    filterMembers();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-1 rounded-md ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`;
            nextBtn.innerHTML = '&raquo;';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    filterMembers();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // Edit member
        function editMember(rowId) {
            const member = allMembers.find(m => m.rowId === rowId);
            if (!member) return;
            
            // Fill form with member data
            document.getElementById('rowId').value = member.rowId;
            document.getElementById('date').value = member.date || formatDate(new Date());
            document.getElementById('uid').value = member.uid || '';
            document.getElementById('lineName').value = member.lineName || '';
            document.getElementById('fullName').value = member.fullName || '';
            document.getElementById('houseNumber').value = member.houseNumber || '';
            
            // Set soi dropdown value
            const soiSelect = document.getElementById('soi');
            if (member.soi) {
                // Check if the soi value exists in options
                let soiExists = false;
                for (let i = 0; i < soiSelect.options.length; i++) {
                    if (soiSelect.options[i].value === member.soi) {
                        soiSelect.selectedIndex = i;
                        soiExists = true;
                        break;
                    }
                }
                // If not, add it as a new option
                if (!soiExists) {
                    const newOption = document.createElement('option');
                    newOption.value = member.soi;
                    newOption.text = member.soi;
                    soiSelect.add(newOption);
                    soiSelect.value = member.soi;
                }
            }
            
            document.getElementById('residenceStatus').value = member.residenceStatus || 'เจ้าของบ้าน';
            document.getElementById('memberCount').value = member.memberCount || '';
            document.getElementById('phone').value = member.phone || '';
            document.getElementById('email').value = member.email || '';
            document.getElementById('lineId').value = member.lineId || '';
            document.getElementById('profilePicture').value = member.profilePicture || '';
            
            // Make date, uid, and lineName read-only
            document.getElementById('uid').readOnly = true;
            document.getElementById('uid').classList.add('readonly-field');
            document.getElementById('lineName').readOnly = true;
            document.getElementById('lineName').classList.add('readonly-field');
            
            // Switch to form tab
            formTab.click();
        }

        // Delete member
        function deleteMember(rowId) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'กรุณาใส่รหัสผ่านเพื่อลบข้อมูล',
                input: 'password',
                inputPlaceholder: 'รหัสผ่าน',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ลบข้อมูล',
                cancelButtonText: 'ยกเลิก',
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณาใส่รหัสผ่าน';
                    }
                    if (value !== DELETE_PASSWORD) {
                        return 'รหัสผ่านไม่ถูกต้อง';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading alert
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        text: 'โปรดรอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Create a callback function name
                    const callbackName = 'callback_' + Math.floor(Math.random() * 1000000);
                    
                    // Define the callback function
                    window[callbackName] = function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบข้อมูลสำเร็จ',
                                confirmButtonColor: '#3b82f6'
                            });
                            fetchMembers();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.error || 'ไม่สามารถลบข้อมูลได้',
                                confirmButtonColor: '#ef4444'
                            });
                        }
                        // Clean up the callback function
                        delete window[callbackName];
                    };
                    
                    // Create script element for JSONP request
                    const script = document.createElement('script');
                    const params = new URLSearchParams({
                        action: 'delete',
                        callback: callbackName,
                        rowId: rowId,
                        sheetName: SHEET_NAME
                    });
                    
                    script.src = `${SCRIPT_URL}?${params.toString()}`;
                    document.body.appendChild(script);
                    
                    // Remove the script element after execution
                    script.onload = function() {
                        document.body.removeChild(script);
                    };
                }
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95b7fb4c15ea7b52',t:'MTc1MTg5ODAxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

