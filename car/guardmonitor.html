<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guard Monitor (Status V16) - LPR System</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-dark: #111827;
            --card-dark: #1f2937;
            --text-light: #f9fafb;
            
            /* --- Status Colors --- */
            --status-member-bg: #059669;    /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥) */
            --status-visitor-bg: #d97706;   /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° (Visitor) */
            --status-blacklist-bg: #dc2626; /* ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (Blacklist) */
            --status-unpaid-bg: #ef4444;    /* ‡πÅ‡∏î‡∏á‡∏™‡∏î (‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢) */
            --status-special-bg: #f97316;   /* ‡∏™‡πâ‡∏° (‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á/‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) */
            --status-unreg-bg: #9333ea;     /* ‡∏°‡πà‡∏ß‡∏á (‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô) */
            
            --border-out: #f87171; /* ‡πÅ‡∏î‡∏á */
            --border-in: #34d399;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Prompt', sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        .main-container {
            display: grid;
            grid-template-rows: 60px 1fr; /* Header | Content */
            height: 100vh;
        }

        /* Header */
        .header-bar {
            background-color: #1f2937;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .header-title { font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        .clock-container {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .clock-time { font-size: 1.5rem; color: #9ca3af; font-family: monospace; line-height: 1; font-weight: bold; }
        .clock-date { font-size: 0.9rem; color: #6b7280; margin-top: 2px; }

        /* Sync Status */
        .sync-status {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.05);
            padding: 4px 10px; border-radius: 20px;
        }
        .sync-active { color: #3b82f6; }
        .sync-error { color: #ef4444; }

        /* Split View Area (3 Columns) */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 350px 1fr; 
            height: 100%;
            overflow: hidden;
        }

        /* Lane Columns */
        .lane-col {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--bg-dark);
            transition: background-color 0.3s;
        }

        .lane-content-wrapper {
            width: 100%; max-width: 100%; 
            display: flex; flex-direction: column; gap: 1rem; height: 100%;
        }

        /* Alert Animations */
        .alert-flash-red { animation: flash-red 1s infinite; }
        @keyframes flash-red {
            0% { background-color: var(--bg-dark); }
            50% { background-color: rgba(220, 38, 38, 0.3); }
            100% { background-color: var(--bg-dark); }
        }
        
        .alert-flash-orange { animation: flash-orange 1.5s infinite; }
        @keyframes flash-orange {
            0% { background-color: var(--bg-dark); }
            50% { background-color: rgba(249, 115, 22, 0.2); }
            100% { background-color: var(--bg-dark); }
        }

        .alert-flash-purple { animation: flash-purple 1.5s infinite; }
        @keyframes flash-purple {
            0% { background-color: var(--bg-dark); }
            50% { background-color: rgba(147, 51, 234, 0.2); }
            100% { background-color: var(--bg-dark); }
        }

        /* Center History Column */
        .history-col {
            background-color: #1f2937;
            border-left: 1px solid #374151;
            border-right: 1px solid #374151;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .history-header {
            padding: 1rem; font-weight: 600; color: #d1d5db;
            text-align: center; border-bottom: 1px solid #374151; background: #111827;
        }

        .history-list { flex-grow: 1; overflow-y: auto; padding: 1rem; }

        /* History Item Styling */
        .history-card {
            background: #374151; border-radius: 8px; padding: 0.75rem;
            margin-bottom: 0.75rem; display: flex; gap: 10px;
            align-items: center; border-left: 3px solid transparent;
            cursor: pointer; transition: background-color 0.2s;
        }
        .history-card:hover { background-color: #4b5563; }
        
        /* History Border Colors */
        .h-in { border-left-color: #34d399; }
        .h-out { border-left-color: #f87171; }
        .h-blacklist { border-left-color: #dc2626; background-color: #450a0a; }
        .h-unpaid { border-left-color: #ef4444; background-color: #450a0a; }
        .h-special { border-left-color: #f97316; background-color: #431407; }
        .h-unreg { border-left-color: #9333ea; background-color: #3b0764; } /* Purple bg for unreg */

        .history-thumb { width: 60px; height: 40px; border-radius: 4px; object-fit: cover; background: #000; }
        .history-info { flex-grow: 1; min-width: 0; }
        .history-plate { font-size: 1rem; font-weight: 600; margin: 0; line-height: 1.2; }
        .history-meta { font-size: 0.75rem; color: #9ca3af; display: flex; justify-content: space-between; margin-top: 2px; }
        
        /* History Text Colors */
        .history-house-member { font-size: 0.8rem; color: #fbbf24; margin-top: 2px; font-weight: 600; }
        .history-house-visitor { font-size: 0.8rem; color: #e5e7eb; margin-top: 2px; font-weight: 500; }
        .history-house-unpaid { font-size: 0.8rem; color: #f87171; margin-top: 2px; font-weight: 700; }
        .history-house-special { font-size: 0.8rem; color: #fdba74; margin-top: 2px; font-weight: 600; }
        .history-house-unreg { font-size: 0.8rem; color: #d8b4fe; margin-top: 2px; font-weight: 600; } /* Light purple */

        /* Lane Headers & Counters */
        .lane-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; border-radius: 8px;
            font-size: 1.5rem; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        .header-out { background: rgba(248, 113, 113, 0.1); color: #f87171; border: 1px solid #f87171; }
        .header-in { background: rgba(52, 211, 153, 0.1); color: #34d399; border: 1px solid #34d399; }

        .daily-count {
            font-size: 1.2rem; background: rgba(255,255,255,0.1);
            padding: 4px 16px; border-radius: 20px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }

        /* Image Box */
        .monitor-img-box {
            flex-grow: 1; background: #000; border-radius: 12px;
            border: 2px solid #374151; overflow: hidden;
            position: relative; display: flex; align-items: center; justify-content: center;
            min-height: 250px;
        }
        .monitor-img { width: 100%; height: 100%; object-fit: contain; }
        .no-img-placeholder { text-align: center; color: #4b5563; }

        /* Info Panel */
        .info-card {
            background: var(--card-dark); border-radius: 12px;
            padding: 1.5rem; border: 1px solid #374151;
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
        }
        .info-col { display: flex; flex-direction: column; justify-content: center; }
        .label { font-size: 1rem; color: #9ca3af; margin-bottom: 0.25rem; }
        
        .plate-display {
            font-size: 3.5rem; font-weight: 700; background: #fff; color: #000;
            border: 4px solid #000; border-radius: 8px; padding: 0.25rem 0.5rem;
            text-align: center; line-height: 1.1; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .house-display { font-size: 2.5rem; font-weight: 700; color: #fbbf24; }
        
        /* Status Badges */
        .status-badge {
            font-size: 1.5rem; font-weight: 600; padding: 0.5rem;
            border-radius: 8px; text-align: center; color: white;
            margin-top: auto; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .status-member { background-color: var(--status-member-bg); }
        .status-visitor { background-color: var(--status-visitor-bg); }
        .status-waiting { background-color: #4b5563; }
        .status-blacklist { background-color: var(--status-blacklist-bg); animation: pulse 0.5s infinite alternate; }
        .status-unpaid { background-color: var(--status-unpaid-bg); animation: pulse 1s infinite alternate; }
        .status-special { background-color: var(--status-special-bg); }
        .status-unreg { background-color: var(--status-unreg-bg); } /* Purple */

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        
        .time-group { margin-top: 0.5rem; text-align: right; }
        .time-date { font-size: 0.9rem; color: #9ca3af; margin-bottom: 2px; }
        .time-stamp { font-size: 1.4rem; color: #d1d5db; font-weight: bold; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }

        /* Modal Styles */
        .modal-content { background-color: #1f2937; color: #f9fafb; border: 1px solid #374151; }
        .modal-header { border-bottom: 1px solid #374151; }
        .modal-footer { border-top: 1px solid #374151; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 992px) {
            body { height: auto; min-height: 100vh; overflow-y: auto; }
            .main-container { display: block; height: auto; }
            .split-view { display: flex; flex-direction: column; height: auto; overflow: visible; }
            .lane-out { order: 1; border-right: none; border-bottom: 1px solid #374151; }
            .lane-in { order: 2; border-bottom: 1px solid #374151; }
            .history-col { order: 3; height: 400px; border-left: none; border-right: none; }
            .lane-col { padding: 1rem 0.5rem; }
            .monitor-img-box { min-height: 200px; max-height: 300px; }
            .info-card { padding: 1rem; gap: 0.5rem; }
            .plate-display { font-size: 2rem; }
            .house-display { font-size: 1.5rem; }
            .status-badge { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
    <h3 class="text-light">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</h3>
</div>

<audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" preload="auto"></audio>

<!-- History Detail Modal -->
<div class="modal fade" id="historyDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2 text-white-50">
                    <i data-lucide="history" size="20"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7 mb-3 mb-md-0">
                        <div class="rounded overflow-hidden border border-secondary" style="background: #000; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                            <img id="modalImg" src="" class="img-fluid" style="max-height: 400px;" alt="Vehicle Image">
                            <div id="modalNoImg" class="text-secondary d-none">
                                <i data-lucide="image-off" size="48"></i>
                                <p class="mt-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body d-flex flex-column gap-3">
                                <div>
                                    <label class="text-white-50 small">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
                                    <div id="modalPlate" class="fs-2 fw-bold text-white">-</div>
                                </div>
                                <div>
                                    <label class="text-white-50 small">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                                    <div id="modalHouse" class="fs-4 fw-bold" style="color: #fbbf24;">-</div>
                                </div>
                                <div>
                                    <label class="text-white-50 small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                    <div id="modalStatus" class="badge rounded-pill bg-secondary fs-6 px-3 py-2">Waiting</div>
                                </div>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between border-top border-secondary pt-3">
                                        <div>
                                            <div class="text-white-50 small">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</div>
                                            <div id="modalTime" class="fw-bold text-white">-</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="text-white-50 small">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</div>
                                            <div id="modalDir" class="fw-bold">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
</div>

<div class="main-container">
    <header class="header-bar">
        <div class="header-title">
            <i data-lucide="monitor" class="text-primary"></i> 
            LPR Guard Monitor
        </div>
        <div class="clock-container">
            <div id="syncStatus" class="sync-status">
                <i data-lucide="refresh-cw" size="14"></i> Auto Sync: ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°
            </div>
            <div style="text-align: right;">
                <div class="clock-time" id="liveClockTime">00:00:00</div>
                <div class="clock-date" id="liveClockDate">...</div>
            </div>
        </div>
    </header>

    <div class="split-view">
        
        <!-- LEFT: OUTBOUND -->
        <div class="lane-col lane-out">
            <div class="lane-content-wrapper">
                <div class="lane-header header-out">
                    <div><i data-lucide="arrow-left-circle" class="me-2"></i> ‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</div>
                    <div class="daily-count">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="countOut">0</span> ‡∏Ñ‡∏±‡∏ô</div>
                </div>
                
                <div class="monitor-img-box">
                    <img id="imgOut" src="" class="monitor-img" style="display: none;">
                    <div id="noImgOut" class="no-img-placeholder">
                        <i data-lucide="camera-off" size="48"></i>
                        <p class="mt-2">‡∏£‡∏≠‡∏£‡∏ñ‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å...</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-col border-end border-secondary pe-2">
                        <div class="label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</div>
                        <div id="plateOut" class="plate-display">-</div>
                    </div>
                    <div class="info-col ps-2">
                        <div class="label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        <div id="houseOut" class="house-display">-</div>
                        <div id="statusOut" class="status-badge status-waiting mt-3">Waiting</div>
                        
                        <div class="time-group">
                            <div id="dateOut" class="time-date">-</div>
                            <div id="timeOut" class="time-stamp">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER: HISTORY -->
        <div class="history-col">
            <div class="history-header">
                <i data-lucide="history" size="16"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </div>
            <div class="history-list" id="historyList">
                <!-- History Items -->
            </div>
        </div>

        <!-- RIGHT: INBOUND -->
        <div class="lane-col lane-in">
            <div class="lane-content-wrapper">
                <div class="lane-header header-in">
                    <div>‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN) <i data-lucide="arrow-right-circle" class="ms-2"></i></div>
                    <div class="daily-count">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="countIn">0</span> ‡∏Ñ‡∏±‡∏ô</div>
                </div>

                <div class="monitor-img-box">
                    <img id="imgIn" src="" class="monitor-img" style="display: none;">
                    <div id="noImgIn" class="no-img-placeholder">
                        <i data-lucide="camera-off" size="48"></i>
                        <p class="mt-2">‡∏£‡∏≠‡∏£‡∏ñ‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤...</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-col border-end border-secondary pe-2">
                        <div class="label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</div>
                        <div id="plateIn" class="plate-display">-</div>
                    </div>
                    <div class="info-col ps-2">
                        <div class="label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        <div id="houseIn" class="house-display">-</div>
                        <div id="statusIn" class="status-badge status-waiting mt-3">Waiting</div>
                        
                        <div class="time-group">
                            <div id="dateIn" class="time-date">-</div>
                            <div id="timeIn" class="time-stamp">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- SYNC CONFIGURATION ---
    const SOURCE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
    const SOURCE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU'; // Corrected
    const DEST_URL = 'https://zrpzuaaudkhkfabwbwkv.supabase.co';
    const DEST_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHp1YWF1ZGtoa2ZhYndid2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDY0MDksImV4cCI6MjA4NDY4MjQwOX0.K9pOF4yMLHDCwD17X3_7tOesBbceJmjvf7m4xqt7R6k';

    // Initialize Clients
    const syncSourceClient = supabase.createClient(SOURCE_URL, SOURCE_KEY);
    const syncDestClient = supabase.createClient(DEST_URL, DEST_KEY);
    const supabaseClient = syncDestClient; // Main client

    let carMap = new Map();
    let blacklistMap = new Map(); // Store full blacklist details

    // --- Clock ---
    function updateClock() {
        const now = new Date();
        const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };
        const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Bangkok' };
        
        document.getElementById('liveClockTime').innerText = now.toLocaleTimeString('th-TH', optionsTime);
        document.getElementById('liveClockDate').innerText = now.toLocaleDateString('th-TH', optionsDate);
    }
    setInterval(updateClock, 1000);
    updateClock(); 

    // --- Date Helper ---
    const getThaiDateRangeISO = () => {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
        const start = new Date(`${dateStr}T00:00:00+07:00`);
        const end = new Date(`${dateStr}T23:59:59.999+07:00`);
        return { start: start.toISOString(), end: end.toISOString() };
    };

    async function initSystem() {
        // Initial Data Load
        await Promise.all([fetchAllowedCars(), fetchBlacklist()]); 
        await fetchLatestState(); 
        await fetchHistory();     
        await fetchDailyCounts(); 
        
        setupRealtimeListener();
        startAutoSync(); // Start background sync
        
        document.getElementById('loadingOverlay').style.display = 'none';
        lucide.createIcons();
    }

    // --- AUTO SYNC ---
    function startAutoSync() {
        runSyncProcess();
        setInterval(runSyncProcess, 300000); // 5 minutes
    }

    async function runSyncProcess() {
        const statusEl = document.getElementById('syncStatus');
        statusEl.innerHTML = '<i data-lucide="loader" class="animate-spin" size="14"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync...';
        statusEl.className = 'sync-status';
        lucide.createIcons();

        try {
            await syncTable('allowed_cars');
            await syncTable('deleted_cars');
            await fetchAllowedCars(); // Reload cache
            
            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            statusEl.innerHTML = `<i data-lucide="check-circle" size="14"></i> Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${time}`;
            statusEl.className = 'sync-status sync-active';
        } catch (err) {
            console.error('Auto Sync Failed:', err);
            statusEl.innerHTML = `<i data-lucide="alert-circle" size="14"></i> Sync ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`;
            statusEl.className = 'sync-status sync-error';
        }
        lucide.createIcons();
    }

    async function syncTable(tableName) {
        const { data: sourceData, error: sourceError } = await syncSourceClient.from(tableName).select('*');
        if (sourceError) throw sourceError;
        if (!sourceData || sourceData.length === 0) return;

        const chunkSize = 100;
        for (let i = 0; i < sourceData.length; i += chunkSize) {
            const chunk = sourceData.slice(i, i + chunkSize);
            await syncDestClient.from(tableName).upsert(chunk, { onConflict: 'id' });
        }
    }

    // --- DATA FETCHING ---

    async function fetchAllowedCars() {
        try {
            const { data: allowedData } = await supabaseClient.from('allowed_cars').select('plate_number, house_number, list_type');
            const { data: deletedData } = await supabaseClient.from('deleted_cars').select('plate_number, house_number, list_type');

            if (allowedData) {
                allowedData.forEach(car => {
                    const cleanPlate = (car.plate_number || '').replace(/\s+/g, '').toLowerCase();
                    if (cleanPlate) carMap.set(cleanPlate, { house: car.house_number, type: car.list_type, isUnpaid: false });
                });
            }

            if (deletedData) {
                deletedData.forEach(car => {
                    const cleanPlate = (car.plate_number || '').replace(/\s+/g, '').toLowerCase();
                    if (cleanPlate) carMap.set(cleanPlate, { house: car.house_number, type: car.list_type, isUnpaid: true });
                });
            }
        } catch (err) { console.error('Cars DB Error:', err); }
    }

    async function fetchBlacklist() {
        try {
            const { data } = await supabaseClient.from('blacklist_cars').select('plate_number, category, reason');
            if (data) {
                blacklistMap.clear();
                data.forEach(item => {
                    const cleanPlate = (item.plate_number || '').replace(/\s+/g, '').toLowerCase();
                    if (cleanPlate) blacklistMap.set(cleanPlate, { category: item.category || 'blacklist', reason: item.reason });
                });
            }
        } catch (err) { console.error('Blacklist Error:', err); }
    }

    async function fetchDailyCounts() {
        try {
            const { start, end } = getThaiDateRangeISO();
            
            const { count: countIn } = await supabaseClient.from('access_logs').select('*', { count: 'exact', head: true })
                .gte('created_at', start).lte('created_at', end).eq('direction', 'in');
                
            const { count: countOut } = await supabaseClient.from('access_logs').select('*', { count: 'exact', head: true })
                .gte('created_at', start).lte('created_at', end).eq('direction', 'out');

            document.getElementById('countIn').innerText = countIn || 0;
            document.getElementById('countOut').innerText = countOut || 0;
        } catch (err) { console.error('Count Error:', err); }
    }

    async function fetchLatestState() {
        const { data: dataIn } = await supabaseClient.from('access_logs').select('*').eq('direction', 'in').order('created_at', { ascending: false }).limit(1);
        if (dataIn && dataIn.length > 0) updateDisplay(dataIn[0], 'in');
        
        const { data: dataOut } = await supabaseClient.from('access_logs').select('*').eq('direction', 'out').order('created_at', { ascending: false }).limit(1);
        if (dataOut && dataOut.length > 0) updateDisplay(dataOut[0], 'out');
    }

    async function fetchHistory() {
        const { data } = await supabaseClient.from('access_logs').select('*').order('created_at', { ascending: false }).limit(20);
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        if (data) {
            data.forEach(log => prependHistoryItem(log, false)); 
        }
        lucide.createIcons();
    }

    function setupRealtimeListener() {
        supabaseClient.channel('public:access_logs')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'access_logs' }, payload => {
                const newRecord = payload.new;
                const dir = (newRecord.direction || '').toLowerCase();
                
                if (dir === 'in') updateDisplay(newRecord, 'in');
                else if (dir === 'out') updateDisplay(newRecord, 'out');
                
                prependHistoryItem(newRecord, true);
                fetchDailyCounts(); 
            })
            .subscribe();

        supabaseClient.channel('public:blacklist_cars')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'blacklist_cars' }, () => { fetchBlacklist(); })
            .subscribe();
    }

    function playAlert() {
        const audio = document.getElementById('alertSound');
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio playback blocked:', e));
        }
    }

    function getDisplayInfo(log) {
        const plate = log.plate_number || '-';
        const cleanPlate = plate.replace(/\s+/g, '').toLowerCase();
        
        const allowedInfo = carMap.get(cleanPlate);
        let houseNo = allowedInfo ? allowedInfo.house : null;
        let isUnpaid = allowedInfo ? allowedInfo.isUnpaid : false;
        
        let isMember = (log.status || '').toLowerCase().includes('member') || allowedInfo !== undefined;
        const blacklistInfo = blacklistMap.get(cleanPlate);

        let displayHouse = houseNo;
        if (!displayHouse) displayHouse = isMember ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' : '‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠';

        let statusText = isMember ? '‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ)' : '‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠';
        let statusClass = isMember ? 'status-member' : 'status-visitor';
        
        // Priority Logic
        if (blacklistInfo) {
            const cat = blacklistInfo.category || 'blacklist';
            if (cat === 'delivery' || cat === 'school_bus') {
                statusText = cat === 'delivery' ? 'üöö ‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á' : 'üöå ‡∏£‡∏ñ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                statusClass = 'status-special'; // Orange
                displayHouse = blacklistInfo.reason || '‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
            } else if (cat === 'unregistered') {
                statusText = 'üü£ ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                statusClass = 'status-unreg'; // Purple
                displayHouse = blacklistInfo.reason || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏™‡∏ô‡∏á.';
            } else {
                statusText = 'üö® BLACKLIST üö®';
                statusClass = 'status-blacklist'; // Red
            }
        } else if (isUnpaid) {
            statusText = '‚õî ‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
            statusClass = 'status-unpaid'; // Red
        }

        return { plate, cleanPlate, displayHouse, statusText, statusClass, blacklistInfo, isMember, isUnpaid };
    }

    function updateDisplay(log, lane) {
        const suffix = lane === 'in' ? 'In' : 'Out';
        const { plate, displayHouse, statusText, statusClass, blacklistInfo, isUnpaid } = getDisplayInfo(log);
        
        // Alert Logic: True Blacklist OR Unpaid OR Unregistered
        const isAlert = (blacklistInfo && blacklistInfo.category !== 'delivery' && blacklistInfo.category !== 'school_bus') || isUnpaid;
        
        if (isAlert) playAlert();
        
        const dateObj = new Date(log.created_at);
        const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' });
        const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', timeZone: 'Asia/Bangkok' });

        document.getElementById(`plate${suffix}`).innerText = plate;
        
        const houseEl = document.getElementById(`house${suffix}`);
        houseEl.innerText = displayHouse;
        // Text Color Logic
        if (statusClass === 'status-special') houseEl.style.color = '#fdba74'; 
        else if (statusClass === 'status-unreg') houseEl.style.color = '#d8b4fe';
        else if (statusClass === 'status-member') houseEl.style.color = '#fbbf24';
        else if (statusClass === 'status-unpaid') houseEl.style.color = '#f87171';
        else houseEl.style.color = '#9ca3af';

        const statusEl = document.getElementById(`status${suffix}`);
        statusEl.innerText = statusText;
        statusEl.className = `status-badge ${statusClass} mt-3`;

        document.getElementById(`time${suffix}`).innerText = `${timeStr} ‡∏ô.`;
        document.getElementById(`date${suffix}`).innerText = dateStr;

        const imgEl = document.getElementById(`img${suffix}`);
        const noImgEl = document.getElementById(`noImg${suffix}`);
        
        if (log.image_url) {
            imgEl.style.display = 'block'; noImgEl.style.display = 'none';
            imgEl.src = log.image_url;
            imgEl.onerror = () => { imgEl.src = log.image_url + '?t=' + Date.now(); };
        } else {
            imgEl.style.display = 'none'; noImgEl.style.display = 'block';
        }

        const laneBox = document.querySelector(`.lane-${lane}`);
        laneBox.classList.remove('alert-flash-red', 'alert-flash-orange', 'alert-flash-purple'); 
        void laneBox.offsetWidth; 

        if (statusClass === 'status-blacklist' || statusClass === 'status-unpaid') {
            laneBox.classList.add('alert-flash-red');
        } else if (statusClass === 'status-special') {
            laneBox.classList.add('alert-flash-orange');
        } else if (statusClass === 'status-unreg') {
            laneBox.classList.add('alert-flash-purple');
        } else {
            laneBox.style.transition = 'background-color 0.2s';
            laneBox.style.backgroundColor = '#374151'; 
            setTimeout(() => { laneBox.style.backgroundColor = 'transparent'; }, 300);
        }
    }

    function showHistoryModal(log) {
        const { plate, displayHouse, statusText, statusClass, isMember } = getDisplayInfo(log);
        
        const dateObj = new Date(log.created_at);
        const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' });
        const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Bangkok' });
        
        const isEntry = log.direction === 'in';
        const dirText = isEntry ? '‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)' : '‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (OUT)';
        const dirClass = isEntry ? 'text-success' : 'text-danger';

        document.getElementById('modalPlate').innerText = plate;
        document.getElementById('modalHouse').innerText = displayHouse;
        
        let houseClass = 'text-light fst-italic';
        if (statusClass === 'status-special') houseClass = 'text-warning fw-bold';
        else if (statusClass === 'status-unreg') houseClass = 'text-info fw-bold'; 
        else if (statusClass === 'status-member') houseClass = 'text-warning fw-bold';
        else if (statusClass === 'status-unpaid') houseClass = 'text-danger fw-bold';
        document.getElementById('modalHouse').className = `fs-4 ${houseClass}`;
        
        const statusBadge = document.getElementById('modalStatus');
        statusBadge.innerText = statusText;
        
        let bsClass = 'bg-secondary';
        if (statusClass === 'status-blacklist' || statusClass === 'status-unpaid') bsClass = 'bg-danger';
        else if (statusClass === 'status-member') bsClass = 'bg-success';
        else if (statusClass === 'status-special') bsClass = 'bg-warning text-dark';
        else if (statusClass === 'status-unreg') bsClass = 'bg-info text-dark'; // Purple mapping
        
        statusBadge.className = `badge rounded-pill fs-6 px-3 py-2 ${bsClass}`;

        document.getElementById('modalTime').innerText = `${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr} ‡∏ô.`;
        const dirEl = document.getElementById('modalDir');
        dirEl.innerText = dirText;
        dirEl.className = `fw-bold ${dirClass}`;

        const imgEl = document.getElementById('modalImg');
        const noImgEl = document.getElementById('modalNoImg');
        if (log.image_url) {
            imgEl.style.display = 'block'; noImgEl.style.display = 'none'; imgEl.src = log.image_url;
        } else {
            imgEl.style.display = 'none'; noImgEl.classList.remove('d-none'); noImgEl.classList.add('d-flex', 'flex-column');
        }

        const modal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
        modal.show();
    }

    function prependHistoryItem(log, isNew) {
        const container = document.getElementById('historyList');
        const { plate, displayHouse, statusClass, isMember } = getDisplayInfo(log);

        const dateObj = new Date(log.created_at);
        const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' });
        const dateStr = dateObj.getDate() !== new Date().getDate() ? 
                        dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', timeZone: 'Asia/Bangkok' }) + ' ' : '';
                        
        const imgUrl = log.image_url || 'https://via.placeholder.com/60x40?text=NoImg';
        const isEntry = log.direction === 'in';
        const dirText = isEntry ? 'IN' : 'OUT';
        const dirClass = isEntry ? 'text-success' : 'text-danger';
        
        let cardClass = isEntry ? 'h-in' : 'h-out';
        if (statusClass === 'status-blacklist') cardClass = 'h-blacklist';
        else if (statusClass === 'status-unpaid') cardClass = 'h-unpaid';
        else if (statusClass === 'status-special') cardClass = 'h-special';
        else if (statusClass === 'status-unreg') cardClass = 'h-unreg';
        
        let houseClass = 'history-house-visitor';
        if (statusClass === 'status-special') houseClass = 'history-house-special';
        else if (statusClass === 'status-unreg') houseClass = 'history-house-unreg';
        else if (statusClass === 'status-member') houseClass = 'history-house-member';
        else if (statusClass === 'status-unpaid') houseClass = 'history-house-unpaid';

        const div = document.createElement('div');
        div.className = `history-card ${cardClass}`;
        div.onclick = () => { showHistoryModal(log); };

        let plateClass = '';
        if (statusClass === 'status-blacklist' || statusClass === 'status-unpaid') plateClass = 'text-danger';

        div.innerHTML = `
            <img src="${imgUrl}" class="history-thumb" onerror="this.src='https://via.placeholder.com/60x40?text=Error'">
            <div class="history-info">
                <div class="history-plate ${plateClass}">${plate}</div>
                <div class="${houseClass}">${displayHouse}</div>
                <div class="history-meta">
                    <span>${dateStr}${timeStr}</span>
                    <span class="${dirClass} fw-bold">${dirText}</span>
                </div>
            </div>
        `;

        if (isNew) {
            container.prepend(div);
            if (container.children.length > 20) container.removeChild(container.lastChild);
            lucide.createIcons();
        } else {
            container.appendChild(div);
        }
    }

    document.addEventListener('DOMContentLoaded', initSystem);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
