<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Access Control V14 (DB Settings)</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --accent-blue: #2563eb;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            
            --member-bg: #eff6ff;
            --member-text: #1d4ed8;
            --visitor-bg: #fff7ed;
            --visitor-text: #c2410c;
            --dir-in-bg: #dcfce7;
            --dir-in-text: #15803d;
            --dir-out-bg: #f1f5f9;
            --dir-out-text: #475569;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            padding-bottom: 80px;
        }

        /* Navbar */
        .app-header {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0.75rem 0;
        }

        .app-title {
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            color: var(--text-main);
            font-size: 1.15rem;
        }

        /* Dashboard Cards */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            height: 100%;
            transition: transform 0.2s;
        }
        
        .stat-title { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .stat-sub { font-size: 0.75rem; margin-top: 0.25rem; display: flex; align-items: center; gap: 4px; }
        
        .bg-gradient-blue { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border-color: #bfdbfe; }

        /* Navigation Tabs */
        .nav-pills .nav-link {
            border-radius: 50px;
            padding: 6px 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .nav-pills .nav-link.active {
            background-color: var(--accent-blue);
            color: white;
        }

        /* Card Design (Log List) */
        .log-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
            overflow: hidden;
            position: relative;
            border-left: 4px solid transparent;
        }

        .is-member { border-left-color: var(--accent-blue); }
        .is-visitor { border-left-color: #f97316; }

        .card-body { padding: 0.75rem; display: flex; gap: 0.75rem; }

        .log-img-container {
            flex-shrink: 0; width: 100px; height: 85px;
            border-radius: 8px; overflow: hidden; background: #e5e7eb;
            position: relative; border: 1px solid #d1d5db;
        }

        .log-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .img-fallback { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; background: #f3f4f6; color: #9ca3af; font-size: 0.7rem; }
        .img-link-btn { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 4px; padding: 2px 4px; font-size: 0.6rem; z-index: 10; text-decoration: none; }

        .log-content { flex-grow: 1; min-width: 0; }
        .license-plate { font-family: 'Prompt', sans-serif; font-weight: 600; font-size: 1.1rem; color: #111827; margin-bottom: 2px; line-height: 1.2; }
        
        .type-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; font-family: 'Prompt', sans-serif; }
        .type-member { background: var(--member-bg); color: var(--member-text); }
        .type-visitor { background: var(--visitor-bg); color: var(--visitor-text); }

        .house-info { display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; color: #4b5563; background-color: #f3f4f6; padding: 2px 8px; border-radius: 6px; margin-top: 2px; margin-bottom: 4px; font-weight: 600; border: 1px solid #e5e7eb; }
        
        .meta-row { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .time-text { font-size: 0.8rem; color: var(--text-muted); }
        
        .dir-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; display: flex; align-items: center; gap: 2px; }
        .dir-in { background: var(--dir-in-bg); color: var(--dir-in-text); }
        .dir-out { background: var(--dir-out-bg); color: var(--dir-out-text); }

        /* Pagination & Filter Controls */
        .bottom-controls {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 10px 15px;
            border-top: 1px solid #e5e7eb;
            z-index: 900;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .pagination-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        .btn-page { border-radius: 8px; padding: 8px 14px; font-weight: 500; font-size: 0.9rem; border: 1px solid #e5e7eb; background: white; transition: all 0.2s; }
        .btn-page:active { transform: scale(0.96); }
        .btn-page:disabled { opacity: 0.5; background: #f3f4f6; }
        
        .rows-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6px 24px 6px 10px;
            font-size: 0.85rem;
            background-color: #f9fafb;
            color: var(--text-main);
            width: auto;
            cursor: pointer;
        }

        /* Filter Section Styling */
        .filter-section { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .filter-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 500; }
        .form-select, .form-control { border-radius: 8px; border-color: #e5e7eb; font-size: 0.9rem; }

        /* Settings Page */
        .settings-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .settings-header {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div class="app-title d-flex align-items-center gap-2">
                <i data-lucide="shield-check" class="text-primary"></i>
                LPR V14
            </div>
            
            <!-- View Switcher -->
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="pills-dashboard-tab" onclick="switchView('dashboard')">
                        <i data-lucide="layout-dashboard" size="16"></i>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="pills-logs-tab" onclick="switchView('logs')">
                        <i data-lucide="list" size="16"></i>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="pills-settings-tab" onclick="switchView('settings')">
                        <i data-lucide="settings" size="16"></i>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</header>

<div class="container mt-3 pb-5">
    
    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold text-dark">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
            <div class="d-flex align-items-center gap-2">
                <i data-lucide="calendar" size="18" class="text-muted"></i>
                <input type="date" id="dashboardDateInput" class="form-control form-control-sm" style="width: 150px;" onchange="loadDashboard()">
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
                <div class="stat-card bg-gradient-blue">
                    <div class="stat-title">‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="d-flex justify-content-between align-items-end">
                        <div class="stat-value text-primary" id="statTotal">...</div>
                        <div class="p-2 bg-white rounded-circle shadow-sm"><i data-lucide="car" size="24" class="text-primary"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="stat-card">
                    <div class="stat-title">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</div>
                    <div class="row g-0">
                        <div class="col-6 border-end pe-2">
                            <div class="stat-value text-success fs-3" id="statIn">...</div>
                            <div class="stat-sub text-success"><i data-lucide="arrow-right-circle" size="12"></i> ‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</div>
                        </div>
                        <div class="col-6 ps-3">
                            <div class="stat-value text-secondary fs-3" id="statOut">...</div>
                            <div class="stat-sub text-secondary"><i data-lucide="arrow-left-circle" size="12"></i> ‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="stat-card">
                    <div class="stat-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                    <div class="row g-0">
                        <div class="col-6 border-end pe-2">
                            <div class="stat-value text-primary fs-3" id="statMember">...</div>
                            <div class="stat-sub text-primary"><i data-lucide="home" size="12"></i> ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</div>
                        </div>
                        <div class="col-6 ps-3">
                            <div class="stat-value text-warning fs-3" id="statVisitor">...</div>
                            <div class="stat-sub text-warning"><i data-lucide="user" size="12"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-bold text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h6>
            <button class="btn btn-sm btn-link text-decoration-none" onclick="goToLogsWithDate()">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div id="dashboardRecentList"></div>
    </div>

    <!-- VIEW: LOGS -->
    <div id="view-logs" class="d-none">
        <div class="filter-section">
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i data-lucide="search" size="18"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà..." onkeyup="handleFilterChange()">
                </div>
            </div>
            <div class="row g-2">
                <div class="col-12 col-md-4">
                    <div class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                    <input type="date" id="filterDate" class="form-control" onchange="handleFilterChange()">
                </div>
                <div class="col-6 col-md-3">
                    <div class="filter-label">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</div>
                    <select id="filterDir" class="form-select" onchange="handleFilterChange()">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="in">‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</option>
                        <option value="out">‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å</option>
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <div class="filter-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>
                    <select id="filterType" class="form-select" onchange="handleFilterChange()">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="member">‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="visitor">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</option>
                    </select>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i data-lucide="rotate-ccw" size="16"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                    </button>
                </div>
            </div>
        </div>
        <div id="logList"></div>
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary mb-2 spinner-border-sm"></div>
            <p class="text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        <div id="emptyState" class="text-center py-5 d-none">
            <div class="text-muted mb-2"><i data-lucide="inbox" size="32"></i></div>
            <p class="text-muted small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
        </div>
        <div style="height: 60px;"></div>
    </div>

    <!-- VIEW: SETTINGS (TELEGRAM + DB) -->
    <div id="view-settings" class="d-none">
        <div class="settings-card">
            <div class="settings-header">
                <i data-lucide="database" class="text-primary"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Cloud Database)
            </div>
            <div class="alert alert-info small">
                <i data-lucide="info" size="14"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <code>app_settings</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            </div>
            
            <div class="mb-3">
                <label class="form-label small text-muted">Telegram Bot Token</label>
                <input type="password" id="tgBotToken" class="form-control" placeholder="123456:ABC-DEF...">
            </div>
            <div class="mb-3">
                <label class="form-label small text-muted">Chat ID</label>
                <input type="text" id="tgChatId" class="form-control" placeholder="-100xxxxxxx">
            </div>
            <div class="mb-3">
                <button class="btn btn-outline-primary w-100" onclick="testTelegram()">
                    <i data-lucide="bell-ring" size="16"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                </button>
            </div>
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                <select id="tgNotifyMode" class="form-select">
                    <option value="watchlist">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (Watchlist)</option>
                    <option value="visitor">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Visitor)</option>
                    <option value="all">‡∏£‡∏ñ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô (All)</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label small text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (Watchlist)</label>
                <textarea id="tgWatchlist" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ ‡πÄ‡∏ä‡πà‡∏ô 1‡∏Å‡∏Å1234, 2‡∏Ç‡∏Ç5678"></textarea>
            </div>
            <button class="btn btn-primary w-100" onclick="saveSettingsToDB()">
                <i data-lucide="save" size="16"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
        
        <div class="settings-card">
            <div class="settings-header">
                <i data-lucide="activity" class="text-success"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
            </div>
            <div class="d-flex align-items-center justify-content-between">
                <span>Real-time Listener</span>
                <span class="badge bg-success" id="listenerStatus">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Fixed Controls -->
<div id="bottomControls" class="bottom-controls d-none">
    <div class="pagination-row">
        <div class="d-flex align-items-center gap-2">
            <select id="rowsPerPage" class="form-select rows-select" onchange="handleRowsChange()">
                <option value="20">20 / ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="50">50 / ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="100">100 / ‡∏´‡∏ô‡πâ‡∏≤</option>
            </select>
        </div>
        <div class="text-center flex-grow-1">
            <small class="text-muted fw-bold" id="pageIndicator">‡∏´‡∏ô‡πâ‡∏≤ 1</small>
            <div style="font-size: 0.7rem;" class="text-muted" id="totalCount">...</div>
        </div>
        <div class="d-flex gap-1">
            <button class="btn-page" id="prevBtn" onclick="changePage(-1)" disabled><i data-lucide="chevron-left" size="18"></i></button>
            <button class="btn-page text-primary" id="nextBtn" onclick="changePage(1)"><i data-lucide="chevron-right" size="18"></i></button>
        </div>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏° -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative text-center">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <img id="fullImage" src="" class="img-fluid rounded-3 shadow-lg" style="max-height: 80vh;">
                <div class="mt-2 text-center">
                    <a id="downloadLink" href="#" target="_blank" class="btn btn-sm btn-light rounded-pill px-3"><i data-lucide="external-link" size="14"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SB_URL = 'https://zrpzuaaudkhkfabwbwkv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHp1YWF1ZGtoa2ZhYndid2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDY0MDksImV4cCI6MjA4NDY4MjQwOX0.K9pOF4yMLHDCwD17X3_7tOesBbceJmjvf7m4xqt7R6k';
    
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    
    // Global Config
    let currentPage = 0;
    let itemsPerPage = 20;
    let totalRecords = 0;
    let searchTimeout;
    let carMap = new Map();
    let isCarMapLoaded = false;

    // App Settings (Loaded from DB)
    let appSettings = {
        tg_bot_token: '',
        tg_chat_id: '',
        tg_watchlist: '',
        tg_notify_mode: 'watchlist'
    };

    // --- Time Helpers ---
    const getThaiDateString = () => new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
    const getThaiDateRangeISO = (dateStr) => {
        const start = new Date(`${dateStr}T00:00:00+07:00`);
        const end = new Date(`${dateStr}T23:59:59.999+07:00`);
        return { start: start.toISOString(), end: end.toISOString() };
    };

    // --- VIEW SWITCHING ---
    function switchView(viewName) {
        const views = ['dashboard', 'logs', 'settings'];
        const ctrls = document.getElementById('bottomControls');
        views.forEach(v => {
            document.getElementById(`view-${v}`).classList.add('d-none');
            document.getElementById(`pills-${v}-tab`).classList.remove('active');
        });
        document.getElementById(`view-${viewName}`).classList.remove('d-none');
        document.getElementById(`pills-${viewName}-tab`).classList.add('active');

        if (viewName === 'logs') {
            ctrls.classList.remove('d-none');
            if(totalRecords === 0) fetchData();
        } else if (viewName === 'dashboard') {
            ctrls.classList.add('d-none');
            loadDashboard();
        } else {
            ctrls.classList.add('d-none');
            loadSettingsFromDB();
        }
    }

    function goToLogsWithDate() {
        document.getElementById('filterDate').value = document.getElementById('dashboardDateInput').value;
        switchView('logs');
        handleFilterChange();
    }

    // --- DASHBOARD ---
    async function loadDashboard() {
        let dateStr = document.getElementById('dashboardDateInput').value || getThaiDateString();
        document.getElementById('dashboardDateInput').value = dateStr;
        const { start, end } = getThaiDateRangeISO(dateStr);

        try {
            const qTotal = supabaseClient.from('access_logs').select('*', { count: 'exact', head: true }).gte('created_at', start).lte('created_at', end);
            const qIn = supabaseClient.from('access_logs').select('*', { count: 'exact', head: true }).gte('created_at', start).lte('created_at', end).eq('direction', 'in');
            const qOut = supabaseClient.from('access_logs').select('*', { count: 'exact', head: true }).gte('created_at', start).lte('created_at', end).eq('direction', 'out');
            const qMem = supabaseClient.from('access_logs').select('*', { count: 'exact', head: true }).gte('created_at', start).lte('created_at', end).ilike('status', '%member%');

            const [rTotal, rIn, rOut, rMem] = await Promise.all([qTotal, qIn, qOut, qMem]);
            const total = rTotal.count || 0;
            const cntMem = rMem.count || 0;

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statIn').innerText = rIn.count || 0;
            document.getElementById('statOut').innerText = rOut.count || 0;
            document.getElementById('statMember').innerText = cntMem;
            document.getElementById('statVisitor').innerText = total - cntMem;

            await fetchRecentLogsForDashboard(start, end);
        } catch (err) { console.error("Dashboard Error", err); }
    }

    async function fetchRecentLogsForDashboard(start, end) {
        const container = document.getElementById('dashboardRecentList');
        container.innerHTML = '<div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
        if (!isCarMapLoaded) await fetchAllowedCars();

        const { data } = await supabaseClient.from('access_logs').select('*').gte('created_at', start).lte('created_at', end).order('created_at', { ascending: false }).limit(5);
        container.innerHTML = '';
        if(!data || data.length === 0) {
            container.innerHTML = '<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
            return;
        }
        renderCards(data, container); 
    }

    // --- LOGS & PAGINATION ---
    function handleRowsChange() { itemsPerPage = parseInt(document.getElementById('rowsPerPage').value); currentPage = 0; fetchData(); }
    function handleFilterChange() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentPage = 0; fetchData(); }, 500); }
    function resetFilters() { document.getElementById('searchInput').value = ''; document.getElementById('filterDate').value = ''; document.getElementById('filterDir').value = 'all'; document.getElementById('filterType').value = 'all'; handleFilterChange(); }
    function changePage(delta) { currentPage += delta; if (currentPage < 0) currentPage = 0; fetchData(); document.getElementById('view-logs').scrollIntoView({ behavior: 'smooth' }); }

    async function fetchAllowedCars() {
        if (isCarMapLoaded) return;
        try {
            const { data } = await supabaseClient.from('allowed_cars').select('plate_number, house_number, list_type');
            if (data) {
                data.forEach(car => {
                    const cleanPlate = (car.plate_number || '').replace(/\s+/g, '').toLowerCase();
                    if (cleanPlate) carMap.set(cleanPlate, { house: car.house_number, type: car.list_type });
                });
                isCarMapLoaded = true;
            }
        } catch (err) { console.error(err); }
    }

    async function fetchData() {
        const listContainer = document.getElementById('logList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        listContainer.innerHTML = ''; loadingState.style.display = 'block'; emptyState.classList.add('d-none');
        if (!isCarMapLoaded) await fetchAllowedCars();

        try {
            const from = currentPage * itemsPerPage;
            const to = from + itemsPerPage - 1;
            let query = supabaseClient.from('access_logs').select('*', { count: 'exact' }).order('created_at', { ascending: false }).range(from, to);

            const searchText = document.getElementById('searchInput').value.trim();
            if (searchText) query = query.or(`plate_number.ilike.%${searchText}%,status.ilike.%${searchText}%`);
            
            const dateVal = document.getElementById('filterDate').value;
            if (dateVal) { const { start, end } = getThaiDateRangeISO(dateVal); query = query.gte('created_at', start).lte('created_at', end); }

            const dirVal = document.getElementById('filterDir').value;
            if (dirVal !== 'all') query = query.eq('direction', dirVal);
            
            const typeVal = document.getElementById('filterType').value;
            if (typeVal === 'member') query = query.ilike('status', '%member%');
            else if (typeVal === 'visitor') query = query.not('status', 'ilike', '%member%');

            const { data, count } = await query;
            totalRecords = count || 0;
            updatePaginationUI(data ? data.length : 0);
            
            loadingState.style.display = 'none';
            if (!data || data.length === 0) { emptyState.classList.remove('d-none'); return; }
            renderCards(data, listContainer);
        } catch (err) { console.error(err); loadingState.style.display = 'none'; }
    }

    function updatePaginationUI(currentCount) {
        document.getElementById('pageIndicator').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage + 1}`;
        document.getElementById('totalCount').innerText = `‡∏£‡∏ß‡∏° ${totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = (currentPage * itemsPerPage) + currentCount >= totalRecords;
    }

    function renderCards(data, container) {
        data.forEach(item => {
            const dateObj = new Date(item.created_at);
            const timeStr = dateObj.toLocaleTimeString('th-TH', { timeZone: 'Asia/Bangkok', hour: '2-digit', minute: '2-digit' });
            const dateStr = dateObj.toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok', day: 'numeric', month: 'short' });
            
            const rawUrl = (item.image_url && item.image_url.trim() !== '') ? item.image_url.trim() : null;
            const cleanPlate = (item.plate_number || '').replace(/\s+/g, '').toLowerCase();
            const allowedInfo = carMap.get(cleanPlate); 
            const houseNo = allowedInfo ? allowedInfo.house : null;
            
            const isMember = (item.status || '').toLowerCase().includes('member') || allowedInfo !== undefined;
            const typeConfig = isMember ? { label: '‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô', icon: 'home', bgClass: 'type-member', cardClass: 'is-member' } : { label: '‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', icon: 'user', bgClass: 'type-visitor', cardClass: 'is-visitor' };
            
            const dirLabel = item.direction === 'in' ? '‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏≠‡∏≠‡∏Å';
            const dirClass = item.direction === 'in' ? 'dir-in' : 'dir-out';
            const dirIcon = item.direction === 'in' ? 'arrow-right' : 'arrow-left';

            const card = document.createElement('div');
            card.className = `log-card ${typeConfig.cardClass}`;
            let imageHtml = rawUrl ? `<div class="log-img-container" onclick="openImage('${rawUrl}')"><img src="${rawUrl}" class="log-img" referrerpolicy="no-referrer" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="img-fallback"><i data-lucide="image-off" size="16"></i><span class="mt-1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ</span></div><a href="${rawUrl}" target="_blank" class="img-link-btn" onclick="event.stopPropagation()"><i data-lucide="external-link" size="10"></i></a></div>` : `<div class="log-img-container d-flex align-items-center justify-content-center text-muted"><i data-lucide="camera-off" size="20"></i></div>`;
            let houseHtml = houseNo ? `<div class="house-info"><i data-lucide="home" size="12"></i><span>${houseNo}</span></div>` : '';

            card.innerHTML = `<div class="card-body">${imageHtml}<div class="log-content"><div class="d-flex justify-content-between align-items-start"><div class="license-plate">${item.plate_number || '-'}</div><span class="type-badge ${typeConfig.bgClass}"><i data-lucide="${typeConfig.icon}" size="10"></i> ${typeConfig.label}</span></div>${houseHtml}<div class="meta-row"><div class="time-text">${timeStr} ‡∏ô. <span class="opacity-75">| ${dateStr}</span></div><span class="dir-badge ${dirClass}">${dirLabel} <i data-lucide="${dirIcon}" size="10"></i></span></div><div class="text-muted small mt-1" style="font-size: 0.7rem;">${item.camera_name || 'Camera'} (${Math.round((item.confidence||0)*100)}%)</div></div></div>`;
            container.appendChild(card);
        });
        lucide.createIcons();
    }

    function openImage(url) {
        document.getElementById('fullImage').src = url;
        document.getElementById('downloadLink').href = url;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    // --- DB SETTINGS LOGIC ---
    async function loadSettingsFromDB() {
        try {
            const { data, error } = await supabaseClient.from('app_settings').select('*');
            if (error) throw error;

            if (data) {
                // Map DB rows to appSettings object
                data.forEach(row => {
                    if(appSettings.hasOwnProperty(row.key)) {
                        appSettings[row.key] = row.value;
                    }
                });
                
                // Update UI
                document.getElementById('tgBotToken').value = appSettings.tg_bot_token;
                document.getElementById('tgChatId').value = appSettings.tg_chat_id;
                document.getElementById('tgWatchlist').value = appSettings.tg_watchlist;
                document.getElementById('tgNotifyMode').value = appSettings.tg_notify_mode;
            }
        } catch (err) {
            console.error('Failed to load settings:', err.message);
        }
    }

    async function saveSettingsToDB() {
        const newSettings = [
            { key: 'tg_bot_token', value: document.getElementById('tgBotToken').value.trim() },
            { key: 'tg_chat_id', value: document.getElementById('tgChatId').value.trim() },
            { key: 'tg_watchlist', value: document.getElementById('tgWatchlist').value.trim() },
            { key: 'tg_notify_mode', value: document.getElementById('tgNotifyMode').value }
        ];

        try {
            const { error } = await supabaseClient.from('app_settings').upsert(newSettings);
            if (error) throw error;
            
            // Update local state immediately
            newSettings.forEach(item => appSettings[item.key] = item.value);
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (err) {
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
        }
    }

    async function sendTelegramMessage(text) {
        if (!appSettings.tg_bot_token || !appSettings.tg_chat_id) return;
        let url = `https://api.telegram.org/bot${appSettings.tg_bot_token}/sendMessage?chat_id=${appSettings.tg_chat_id}&text=${encodeURIComponent(text)}&parse_mode=HTML`;
        try { await fetch(url); } catch (e) { console.error('Telegram Send Error', e); }
    }

    async function testTelegram() {
        // Use values from UI inputs for testing
        const token = document.getElementById('tgBotToken').value.trim();
        const chatId = document.getElementById('tgChatId').value.trim();
        
        if (!token || !chatId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Token ‡πÅ‡∏•‡∏∞ Chat ID ‡∏Å‡πà‡∏≠‡∏ô');
        
        let url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent('üîî <strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</strong>\n‡∏£‡∏∞‡∏ö‡∏ö LPR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß')}&parse_mode=HTML`;
        
        try {
            const res = await fetch(url);
            const json = await res.json();
            if(json.ok) alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            else alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + json.description);
        } catch (e) {
            alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
        }
    }

    // --- REALTIME LISTENER ---
    function setupRealtimeListener() {
        supabaseClient
            .channel('public:access_logs')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'access_logs' }, payload => {
                handleNewLog(payload.new);
                if(!document.getElementById('view-dashboard').classList.contains('d-none')) loadDashboard(); 
            })
            .subscribe();
    }

    async function handleNewLog(newRecord) {
        // Ensure settings are loaded
        if (!appSettings.tg_bot_token) await loadSettingsFromDB();
        if (!isCarMapLoaded) await fetchAllowedCars();
        
        const plate = (newRecord.plate_number || '').trim();
        const cleanPlate = plate.replace(/\s+/g, '').toLowerCase();
        
        const watchlist = (appSettings.tg_watchlist || '').split(',').map(s => s.trim().toLowerCase()).filter(s => s);
        
        let shouldNotify = false;
        
        // 1. Watchlist
        if (watchlist.includes(cleanPlate) || watchlist.includes(plate)) {
            shouldNotify = true;
        } 
        // 2. Mode Checks
        else if (appSettings.tg_notify_mode === 'all') {
            shouldNotify = true;
        } else if (appSettings.tg_notify_mode === 'visitor') {
            const allowedInfo = carMap.get(cleanPlate);
            const isMember = (newRecord.status || '').toLowerCase().includes('member') || allowedInfo !== undefined;
            if (!isMember) shouldNotify = true;
        }

        if (shouldNotify) {
            const timeStr = new Date(newRecord.created_at).toLocaleTimeString('th-TH', { timeZone: 'Asia/Bangkok', hour: '2-digit', minute: '2-digit' });
            const dirIcon = newRecord.direction === 'in' ? 'üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤' : 'üî¥ ‡∏≠‡∏≠‡∏Å';
            const imgLink = newRecord.image_url ? `<a href="${newRecord.image_url}">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a>` : '';
            
            const msg = `üö® <strong>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏ñ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</strong>\n` +
                        `üöó ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: <b>${plate}</b>\n` +
                        `üïí ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}\n` +
                        `üìç ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á: ${dirIcon}\n` +
                        `${imgLink}`;
            
            sendTelegramMessage(msg);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        switchView('dashboard');
        loadSettingsFromDB(); // Load settings on start
        setupRealtimeListener();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
