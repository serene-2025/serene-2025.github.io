<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Access Control V6</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --accent-blue: #2563eb;
            --member-bg: #eff6ff;
            --member-text: #1d4ed8;
            --visitor-bg: #fff7ed;
            --visitor-text: #c2410c;
            --dir-in-bg: #dcfce7;
            --dir-in-text: #15803d;
            --dir-out-bg: #f1f5f9;
            --dir-out-text: #475569;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            padding-bottom: 90px;
        }

        /* Navbar */
        .app-header {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0.75rem 0;
        }

        .app-title {
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            color: var(--text-main);
            font-size: 1.15rem;
        }

        /* Search Bar */
        .search-wrapper { position: relative; margin-top: 0.5rem; }
        .search-input {
            border-radius: 12px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding-left: 2.5rem;
            padding-right: 1rem;
            height: 42px;
            font-size: 0.95rem;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%;
            transform: translateY(-50%); color: #9ca3af;
        }

        /* Card Design */
        .log-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
            overflow: hidden;
            position: relative;
            border-left: 4px solid transparent;
        }

        .is-member { border-left-color: var(--accent-blue); }
        .is-visitor { border-left-color: #f97316; }

        .card-body {
            padding: 0.75rem;
            display: flex;
            gap: 0.75rem;
        }

        /* Image Thumbnail Area */
        .log-img-container {
            flex-shrink: 0;
            width: 100px;
            height: 75px;
            border-radius: 8px;
            overflow: hidden;
            background: #e5e7eb;
            position: relative;
            border: 1px solid #d1d5db;
        }

        .log-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Fallback when image fails */
        .img-fallback {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            color: #9ca3af;
            font-size: 0.7rem;
            text-align: center;
        }
        
        .img-link-btn {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.6rem;
            z-index: 10;
            text-decoration: none;
        }

        /* Content Layout */
        .log-content { flex-grow: 1; min-width: 0; }

        .license-plate {
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            color: #111827;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .type-badge {
            display: inline-flex; align-items: center; gap: 3px;
            padding: 2px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 600;
            font-family: 'Prompt', sans-serif;
        }
        .type-member { background: var(--member-bg); color: var(--member-text); }
        .type-visitor { background: var(--visitor-bg); color: var(--visitor-text); }

        .meta-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 6px;
        }

        .time-text { font-size: 0.8rem; color: var(--text-muted); }

        .dir-badge {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            font-weight: 600; display: flex; align-items: center; gap: 2px;
        }
        .dir-in { background: var(--dir-in-bg); color: var(--dir-in-text); }
        .dir-out { background: var(--dir-out-bg); color: var(--dir-out-text); }

        /* Pagination Bar */
        .pagination-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 10px 15px;
            border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 900;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }
        
        .btn-page {
            border-radius: 8px; padding: 6px 12px;
            font-weight: 500; font-size: 0.85rem;
            border: 1px solid #e5e7eb; background: white;
        }
        .btn-page:disabled { opacity: 0.5; background: #f3f4f6; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div class="app-title d-flex align-items-center gap-2">
                <i data-lucide="shield-check" class="text-primary"></i>
                LPR System
            </div>
            <div class="text-muted small fw-medium" id="pageIndicator">หน้า 1</div>
        </div>
        
        <div class="search-wrapper">
            <i data-lucide="search" size="16" class="search-icon"></i>
            <input type="text" id="searchInput" class="search-input form-control" placeholder="ค้นหาทะเบียน..." onkeyup="handleSearch(this.value)">
        </div>
    </div>
</header>

<div class="container mt-3">
    <!-- รายการข้อมูล -->
    <div id="logList"></div>
    
    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary mb-2 spinner-border-sm"></div>
        <p class="text-muted small">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <div class="text-muted mb-2"><i data-lucide="inbox" size="32"></i></div>
        <p class="text-muted small">ไม่พบข้อมูล</p>
    </div>
</div>

<!-- Pagination Controls -->
<div class="pagination-bar">
    <button class="btn-page" id="prevBtn" onclick="changePage(-1)" disabled>
        <i data-lucide="chevron-left" size="16" style="vertical-align: text-bottom;"></i> ก่อนหน้า
    </button>
    <span class="text-muted small fw-medium" id="totalCount">...</span>
    <button class="btn-page text-primary" id="nextBtn" onclick="changePage(1)">
        ถัดไป <i data-lucide="chevron-right" size="16" style="vertical-align: text-bottom;"></i>
    </button>
</div>

<!-- Modal สำหรับดูรูปเต็ม -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative text-center">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <img id="fullImage" src="" class="img-fluid rounded-3 shadow-lg" style="max-height: 80vh;">
                <div class="mt-2 text-center">
                    <a id="downloadLink" href="#" target="_blank" class="btn btn-sm btn-light rounded-pill px-3">
                        <i data-lucide="external-link" size="14"></i> เปิดรูปต้นฉบับ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SB_URL = 'https://zrpzuaaudkhkfabwbwkv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHp1YWF1ZGtoa2ZhYndid2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDY0MDksImV4cCI6MjA4NDY4MjQwOX0.K9pOF4yMLHDCwD17X3_7tOesBbceJmjvf7m4xqt7R6k';
    
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    
    // Config
    let currentPage = 0;
    const itemsPerPage = 20; 
    let currentSearch = '';
    let totalRecords = 0;
    let searchTimeout;

    // Search Logic
    function handleSearch(val) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = val.trim();
            currentPage = 0;
            fetchData();
        }, 500);
    }

    // Page Change Logic
    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 0) currentPage = 0;
        fetchData();
        window.scrollTo(0, 0);
    }

    // Main Fetch Function
    async function fetchData() {
        const listContainer = document.getElementById('logList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        listContainer.innerHTML = '';
        loadingState.style.display = 'block';
        emptyState.classList.add('d-none');

        try {
            const from = currentPage * itemsPerPage;
            const to = from + itemsPerPage - 1;

            let query = supabaseClient
                .from('access_logs')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false })
                .range(from, to);

            if (currentSearch) {
                query = query.or(`plate_number.ilike.%${currentSearch}%,status.ilike.%${currentSearch}%`);
            }

            const { data, error, count } = await query;

            if (error) throw error;

            totalRecords = count || 0;
            updatePaginationUI(data.length);
            
            loadingState.style.display = 'none';
            
            if (data.length === 0) {
                emptyState.classList.remove('d-none');
                return;
            }

            renderList(data);

        } catch (err) {
            console.error(err);
            loadingState.style.display = 'none';
            listContainer.innerHTML = `<div class="text-center text-danger py-4 small">Error: ${err.message}</div>`;
        }
    }

    function updatePaginationUI(currentCount) {
        document.getElementById('pageIndicator').innerText = `หน้า ${currentPage + 1}`;
        document.getElementById('totalCount').innerText = `${totalRecords} รายการ`;
        
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentPage === 0;
        const loadedCount = (currentPage * itemsPerPage) + currentCount;
        nextBtn.disabled = loadedCount >= totalRecords;
    }

    function renderList(data) {
        const listContainer = document.getElementById('logList');

        data.forEach(item => {
            const dateObj = new Date(item.created_at);
            const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
            
            // 1. ตรวจสอบว่ามี URL จริงหรือไม่
            const rawUrl = (item.image_url && item.image_url.trim() !== '') ? item.image_url.trim() : null;

            // Type Logic
            const statusRaw = (item.status || '').toLowerCase();
            const isMember = statusRaw === 'member';
            const typeConfig = isMember 
                ? { label: 'ลูกบ้าน', icon: 'home', bgClass: 'type-member', cardClass: 'is-member' }
                : { label: 'ผู้มาติดต่อ', icon: 'user', bgClass: 'type-visitor', cardClass: 'is-visitor' };

            // Direction Logic
            const isEntry = item.direction === 'in';
            const dirLabel = isEntry ? 'เข้า' : 'ออก';
            const dirClass = isEntry ? 'dir-in' : 'dir-out';
            const dirIcon = isEntry ? 'arrow-right' : 'arrow-left';

            const card = document.createElement('div');
            card.className = `log-card ${typeConfig.cardClass}`;
            
            // HTML Image Block
            // ใช้ rawUrl โดยตรง ไม่เติม ?t= เพื่อหลีกเลี่ยง 404
            // ใส่ referrerpolicy="no-referrer" เพื่อความชัวร์
            let imageHtml = '';
            if (rawUrl) {
                imageHtml = `
                    <div class="log-img-container" onclick="openImage('${rawUrl}')">
                        <img src="${rawUrl}" 
                             class="log-img" 
                             referrerpolicy="no-referrer"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        
                        <!-- แสดงเมื่อรูปพัง -->
                        <div class="img-fallback">
                            <i data-lucide="image-off" size="16"></i>
                            <span class="mt-1">ไม่พบรูป</span>
                        </div>

                        <!-- ปุ่มเปิดดูต้นฉบับ -->
                        <a href="${rawUrl}" target="_blank" class="img-link-btn" onclick="event.stopPropagation()">
                            <i data-lucide="external-link" size="10"></i> Link
                        </a>
                    </div>
                `;
            } else {
                imageHtml = `
                    <div class="log-img-container d-flex align-items-center justify-content-center text-muted">
                         <i data-lucide="camera-off" size="20"></i>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="card-body">
                    ${imageHtml}
                    
                    <div class="log-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="license-plate">${item.plate_number || '-'}</div>
                            <span class="type-badge ${typeConfig.bgClass}">
                                <i data-lucide="${typeConfig.icon}" size="10"></i> ${typeConfig.label}
                            </span>
                        </div>
                        
                        <div class="meta-row">
                            <div class="time-text">
                                ${timeStr} น. <span class="opacity-75">| ${dateStr}</span>
                            </div>
                            <span class="dir-badge ${dirClass}">
                                ${dirLabel} <i data-lucide="${dirIcon}" size="10"></i>
                            </span>
                        </div>
                        <div class="text-muted small mt-1" style="font-size: 0.7rem;">
                           ${item.camera_name || 'Camera'} (${Math.round((item.confidence||0)*100)}%)
                        </div>
                    </div>
                </div>
            `;
            listContainer.appendChild(card);
        });
        
        lucide.createIcons();
    }

    function openImage(url) {
        if(!url) return;
        document.getElementById('fullImage').src = url;
        document.getElementById('downloadLink').href = url;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        fetchData();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
