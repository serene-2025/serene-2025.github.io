<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Register V2 (Autocomplete)</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-bg: #f1f5f9;
            --text-main: #0f172a;
            --accent-blue: #2563eb;
            --accent-red: #ef4444;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            padding-bottom: 90px;
        }

        /* Header */
        .mobile-header {
            background: white;
            padding: 1rem;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
        }
        .app-title {
            font-family: 'Prompt', sans-serif; font-weight: 600; font-size: 1.1rem;
            display: flex; align-items: center; gap: 8px;
        }

        /* Cards */
        .log-card {
            background: white; border-radius: 12px; padding: 10px;
            margin-bottom: 10px; border: 1px solid #e2e8f0;
            display: flex; gap: 10px; align-items: center;
            position: relative; overflow: hidden;
        }
        .log-card:active { background-color: #f8fafc; }

        .log-thumb {
            width: 80px; height: 60px; border-radius: 8px; object-fit: cover;
            background: #cbd5e1; flex-shrink: 0; cursor: pointer;
        }

        .plate-text {
            font-family: 'Prompt', sans-serif; font-weight: 600; font-size: 1.1rem;
            color: var(--text-main);
        }

        .time-text { font-size: 0.8rem; color: #64748b; }

        /* Form */
        .preview-img-box {
            width: 100%; height: 200px; background: #e2e8f0;
            border-radius: 12px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border: 2px dashed #cbd5e1;
            cursor: pointer;
        }
        .preview-img { width: 100%; height: 100%; object-fit: cover; }

        .form-control, .form-select {
            border-radius: 10px; padding: 12px; font-size: 1rem;
            margin-bottom: 15px; border: 1px solid #cbd5e1;
        }

        .btn-main {
            background-color: var(--accent-blue); color: white;
            border: none; border-radius: 12px; padding: 14px;
            width: 100%; font-weight: 600; font-size: 1rem;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around;
            padding: 8px 0; z-index: 1000;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        .nav-item {
            background: none; border: none; color: #94a3b8;
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; width: 33%; gap: 4px;
        }
        .nav-item.active { color: var(--accent-blue); font-weight: 600; }

        /* Section Visibility */
        .view-section { display: none; padding: 15px; }
        .view-section.active { display: block; }

        /* Badge Styles */
        .badge-cat { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-orange { background: #ffedd5; color: #9a3412; }
        .bg-purple { background: #f3e8ff; color: #6b21a8; }
        
        /* Select Button */
        .btn-select {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: var(--accent-blue); color: white; border: none;
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem;
        }

        /* Image Modal */
        .modal-img-container {
            background: #000;
            display: flex; justify-content: center; align-items: center;
            min-height: 250px;
        }
        .modal-full-img {
            max-width: 100%; max-height: 80vh; object-fit: contain;
        }
    </style>
</head>
<body>

<header class="mobile-header">
    <div class="app-title">
        <i data-lucide="database" class="text-primary"></i> Smart Register V2
    </div>
</header>

<!-- TAB 1: VISITOR LOGS -->
<div id="view-visitors" class="view-section active">
    <h6 class="text-muted fw-bold mb-3">‡∏£‡∏ñ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</h6>
    <div id="visitorList" class="d-flex flex-column gap-2">
        <div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
</div>

<!-- TAB 2: REGISTER FORM -->
<div id="view-register" class="view-section">
    <div class="card p-3 border-0 shadow-sm rounded-4">
        <h6 class="fw-bold mb-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h6>
        
        <div class="preview-img-box" id="previewBox" onclick="showFullImageFromForm()">
            <span class="text-muted small"><i data-lucide="image" class="mb-1"></i><br>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</span>
            <img id="formImage" class="preview-img d-none">
        </div>
        
        <input type="hidden" id="inputImageUrl">

        <form id="regForm" onsubmit="handleSave(event)">
            <label class="small text-muted mb-1">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
            <input type="text" id="inputPlate" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1‡∏Å‡∏Ç1234" required>

            <label class="small text-muted mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <select id="inputCategory" class="form-select" required>
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                <option value="delivery">üöö ‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (Delivery)</option>
                <option value="school_bus">üöå ‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                <option value="blacklist">üö® Blacklist (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤)</option>
                <option value="unregistered">üü£ ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</option>
            </select>

            <label class="small text-muted mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <!-- Autocomplete Feature -->
            <input type="text" id="inputReason" class="form-control" list="reasonHistory" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà...">
            <datalist id="reasonHistory">
                <!-- Will be populated by JS -->
            </datalist>

            <button type="submit" class="btn-main" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
    </div>
</div>

<!-- TAB 3: SAVED LIST -->
<div id="view-saved" class="view-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-muted fw-bold mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h6>
        <button class="btn btn-sm btn-light border" onclick="fetchSavedList()"><i data-lucide="refresh-cw" size="14"></i></button>
    </div>
    <div id="savedList" class="d-flex flex-column gap-2"></div>
</div>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('visitors')">
        <i data-lucide="history"></i> ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
    </button>
    <button class="nav-item" onclick="switchTab('register')">
        <i data-lucide="plus-circle"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    </button>
    <button class="nav-item" onclick="switchTab('saved')">
        <i data-lucide="list"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
    </button>
</nav>

<!-- IMAGE MODAL -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary py-2">
                <h6 class="modal-title text-light" id="modalTitle">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 modal-img-container">
                <img id="fullImage" src="" class="modal-full-img">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SB_URL = 'https://zrpzuaaudkhkfabwbwkv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHp1YWF1ZGtoa2ZhYndid2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDY0MDksImV4cCI6MjA4NDY4MjQwOX0.K9pOF4yMLHDCwD17X3_7tOesBbceJmjvf7m4xqt7R6k';
    
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        fetchVisitorLogs();
        loadReasonHistory(); // Load autocomplete options
    });

    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`view-${tabName}`).classList.add('active');
        
        // Update nav icon state
        const iconMap = { 'visitors': 0, 'register': 1, 'saved': 2 };
        document.querySelectorAll('.nav-item')[iconMap[tabName]].classList.add('active');

        if(tabName === 'visitors') fetchVisitorLogs();
        if(tabName === 'saved') fetchSavedList();
    }

    // --- 1. FETCH VISITOR LOGS ---
    async function fetchVisitorLogs() {
        const container = document.getElementById('visitorList');
        try {
            const { data, error } = await supabaseClient
                .from('access_logs')
                .select('*')
                .not('status', 'ilike', '%member%')
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) throw error;

            container.innerHTML = '';
            data.forEach(log => {
                const timeStr = new Date(log.created_at).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                const imgUrl = log.image_url || '';
                
                const div = document.createElement('div');
                div.className = 'log-card';
                div.innerHTML = `
                    <img src="${imgUrl || 'https://via.placeholder.com/80x60?text=NoImg'}" class="log-thumb" onclick="showFullImage('${imgUrl}', '${log.plate_number}')">
                    <div style="flex-grow:1; min-width:0;">
                        <div class="plate-text">${log.plate_number || '-'}</div>
                        <div class="time-text">
                            <i data-lucide="clock" size="12"></i> ${timeStr} ‡∏ô. 
                            <span class="badge bg-light text-dark border ms-1">${log.direction}</span>
                        </div>
                    </div>
                    <button class="btn-select" onclick="selectVisitor('${log.plate_number}', '${imgUrl}')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        } catch (err) {
            container.innerHTML = `<div class="text-center text-danger py-4">Error: ${err.message}</div>`;
        }
    }

    // --- 2. SELECT VISITOR ---
    function selectVisitor(plate, imgUrl) {
        document.getElementById('inputPlate').value = plate;
        document.getElementById('inputImageUrl').value = imgUrl;
        
        const imgEl = document.getElementById('formImage');
        if (imgUrl) {
            imgEl.src = imgUrl;
            imgEl.classList.remove('d-none');
        } else {
            imgEl.classList.add('d-none');
        }
        switchTab('register');
    }

    // --- 3. SAVE DATA + AUTOCOMPLETE ---
    async function handleSave(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSave');
        const plate = document.getElementById('inputPlate').value.trim();
        const category = document.getElementById('inputCategory').value;
        const reason = document.getElementById('inputReason').value.trim();
        const imgUrl = document.getElementById('inputImageUrl').value;

        if (!plate || !category) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');

        // Save Reason to History (LocalStorage)
        if (reason) saveReasonHistory(reason);

        btn.disabled = true;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        try {
            const { data: existing } = await supabaseClient.from('blacklist_cars').select('id').eq('plate_number', plate);
            if (existing && existing.length > 0) throw new Error('‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');

            const { error } = await supabaseClient.from('blacklist_cars').insert([{
                plate_number: plate,
                category: category,
                reason: reason,
                image_url: imgUrl
            }]);

            if (error) throw error;

            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
            
            document.getElementById('regForm').reset();
            document.getElementById('formImage').classList.add('d-none');
            switchTab('saved');

        } catch (err) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }
    }

    // --- 4. FETCH SAVED LIST ---
    async function fetchSavedList() {
        const container = document.getElementById('savedList');
        try {
            const { data, error } = await supabaseClient
                .from('blacklist_cars')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            container.innerHTML = '';
            if(data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            data.forEach(item => {
                let badgeClass = 'bg-light text-dark';
                let catName = item.category;
                if(item.category === 'blacklist') { badgeClass = 'bg-red'; catName = 'Blacklist'; }
                if(item.category === 'delivery') { badgeClass = 'bg-orange'; catName = '‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á'; }
                if(item.category === 'school_bus') { badgeClass = 'bg-orange'; catName = '‡∏£‡∏ñ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; }
                if(item.category === 'unregistered') { badgeClass = 'bg-purple'; catName = '‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; }

                const div = document.createElement('div');
                div.className = 'log-card';
                div.innerHTML = `
                    <img src="${item.image_url || 'https://via.placeholder.com/80x60?text=NoImg'}" class="log-thumb" onclick="showFullImage('${item.image_url}', '${item.plate_number}')">
                    <div style="flex-grow:1; min-width:0;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="plate-text">${item.plate_number}</div>
                            <span class="badge-cat ${badgeClass}">${catName}</span>
                        </div>
                        <div class="text-muted small text-truncate">${item.reason || '-'}</div>
                    </div>
                    <button class="btn btn-sm text-danger border-0 bg-transparent" onclick="deleteItem(${item.id})">
                        <i data-lucide="trash-2"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        } catch (err) { console.error(err); }
    }

    async function deleteItem(id) {
        if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        await supabaseClient.from('blacklist_cars').delete().eq('id', id);
        fetchSavedList();
    }

    // --- UTILS: IMAGE MODAL ---
    function showFullImage(url, title) {
        if (!url || url.includes('placeholder')) return;
        document.getElementById('fullImage').src = url;
        document.getElementById('modalTitle').innerText = `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ${title || ''}`;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    function showFullImageFromForm() {
        const url = document.getElementById('inputImageUrl').value;
        const plate = document.getElementById('inputPlate').value;
        showFullImage(url, plate);
    }

    // --- UTILS: AUTOCOMPLETE REASON ---
    function saveReasonHistory(reason) {
        if(!reason) return;
        let history = JSON.parse(localStorage.getItem('reasonHistory') || '[]');
        if (!history.includes(reason)) {
            history.unshift(reason); // Add new to top
            if (history.length > 50) history.pop(); // Keep max 20 items
            localStorage.setItem('reasonHistory', JSON.stringify(history));
            loadReasonHistory(); // Refresh list
        }
    }

    function loadReasonHistory() {
        const history = JSON.parse(localStorage.getItem('reasonHistory') || '[]');
        const datalist = document.getElementById('reasonHistory');
        datalist.innerHTML = '';
        history.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalist.appendChild(option);
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
