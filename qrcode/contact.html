

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนผู้มาติดต่อหมู่บ้าน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }
        #video, #canvas {
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #4f46e5;
        }
        #canvas {
            display: none;
        }
        .camera-button {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        .required-field::after {
            content: "*";
            color: #ef4444;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <header class="bg-indigo-600 text-white rounded-lg shadow-lg p-6 mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center">ระบบลงทะเบียนผู้มาติดต่อหมู่บ้าน</h1>
        </header>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-indigo-800 border-b pb-2">แบบฟอร์มลงทะเบียนผู้มาติดต่อ</h2>
            
            <form id="visitorForm" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1 required-field">ชื่อผู้มาติดต่อ</label>
                    <input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1 required-field">เบอร์โทร</label>
                    <input type="tel" id="phone" name="phone" required pattern="[0-9]{9,10}" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="houseNumber" class="block text-sm font-medium text-gray-700 mb-1 required-field">บ้านเลขที่</label>
                    <input type="text" id="houseNumber" name="houseNumber" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-1 required-field">เหตุผลในการเข้า</label>
                    <textarea id="reason" name="reason" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24"></textarea>
                </div>
                
                <div>
                    <label for="datetime" class="block text-sm font-medium text-gray-700 mb-1 required-field">วันที่/เวลา</label>
                    <input type="datetime-local" id="datetime" name="datetime" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3 required-field">ถ่ายภาพผู้มาติดต่อ</label>
                    <div class="camera-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <button type="button" id="captureBtn" class="camera-button bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-full shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                    <input type="hidden" id="photoData" name="photoData">
                    <p id="photoStatus" class="mt-2 text-sm text-gray-500 text-center">กรุณาถ่ายภาพ</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">พิกัด GPS</label>
                    <div class="flex space-x-2">
                        <input type="text" id="latitude" name="latitude" readonly placeholder="ละติจูด" class="w-1/2 px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                        <input type="text" id="longitude" name="longitude" readonly placeholder="ลองจิจูด" class="w-1/2 px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
                    <p id="locationStatus" class="mt-1 text-sm text-gray-500">กำลังรับพิกัด GPS...</p>
                </div>
                
                <div class="pt-4">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition duration-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        บันทึกข้อมูล
                    </button>
                </div>
            </form>
        </div>

        <div id="resultSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-800 border-b pb-2">ข้อมูลการลงทะเบียน</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-lg shadow">
                        <div class="flex justify-center mb-4">
                            <div id="qrcode" class="border-4 border-white rounded-lg shadow-md p-2 bg-white"></div>
                        </div>
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-indigo-800">รหัสผู้มาติดต่อ</h3>
                            <p id="visitorCode" class="text-2xl font-bold text-indigo-600 mt-1"></p>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-3">ข้อมูลผู้มาติดต่อ</h3>
                        <div class="space-y-2">
                            <p><span class="font-medium">ชื่อ:</span> <span id="resultName"></span></p>
                            <p><span class="font-medium">เบอร์โทร:</span> <span id="resultPhone"></span></p>
                            <p><span class="font-medium">บ้านเลขที่:</span> <span id="resultHouse"></span></p>
                            <p><span class="font-medium">เหตุผล:</span> <span id="resultReason"></span></p>
                            <p><span class="font-medium">วันที่/เวลา:</span> <span id="resultDatetime"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="newRegistrationBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300">
                        ลงทะเบียนใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // กำหนด URL ของ Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxY1aNDYgX02pODAe7ytcSTWQxkFLtm1L_1eToNS8sdAIuUnYTvBe86soTfEYzCMvj5bA/exec';
        
        // ตั้งค่าวันที่และเวลาปัจจุบัน
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // ตัวแปรสำหรับกล้อง
        let stream;
        let photoTaken = false;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const photoStatus = document.getElementById('photoStatus');
        const photoData = document.getElementById('photoData');
        
        // เริ่มการทำงานของกล้อง
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera:', err);
                photoStatus.textContent = 'ไม่สามารถเข้าถึงกล้องได้ กรุณาอนุญาตการใช้งานกล้อง';
                photoStatus.classList.add('text-red-500');
            }
        }
        
        // เริ่มการทำงานของกล้องเมื่อโหลดหน้า
        startCamera();
        
        // ถ่ายภาพ
        captureBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // ลดขนาดรูปภาพเพื่อให้ส่งข้อมูลได้เร็วขึ้น
            const smallCanvas = document.createElement('canvas');
            const smallContext = smallCanvas.getContext('2d');
            const MAX_WIDTH = 320;
            const MAX_HEIGHT = 240;
            let width = canvas.width;
            let height = canvas.height;
            
            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            
            smallCanvas.width = width;
            smallCanvas.height = height;
            smallContext.drawImage(canvas, 0, 0, width, height);
            
            photoData.value = smallCanvas.toDataURL('image/jpeg', 0.7);
            photoTaken = true;
            photoStatus.textContent = 'ถ่ายภาพเรียบร้อยแล้ว';
            photoStatus.classList.remove('text-gray-500');
            photoStatus.classList.add('text-green-600');
            
            // แสดงภาพที่ถ่าย
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureBtn.textContent = 'ถ่ายใหม่';
            captureBtn.addEventListener('click', () => {
                video.style.display = 'block';
                canvas.style.display = 'none';
                photoTaken = false;
                photoStatus.textContent = 'กรุณาถ่ายภาพ';
                photoStatus.classList.remove('text-green-600');
                photoStatus.classList.add('text-gray-500');
            }, { once: true });
        });
        
        // รับพิกัด GPS
        const latitude = document.getElementById('latitude');
        const longitude = document.getElementById('longitude');
        const locationStatus = document.getElementById('locationStatus');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitude.value = position.coords.latitude;
                    longitude.value = position.coords.longitude;
                    locationStatus.textContent = 'รับพิกัด GPS สำเร็จ';
                    locationStatus.classList.remove('text-gray-500');
                    locationStatus.classList.add('text-green-600');
                },
                (error) => {
                    console.error('Error getting location:', error);
                    locationStatus.textContent = 'ไม่สามารถรับพิกัด GPS ได้';
                    locationStatus.classList.remove('text-gray-500');
                    locationStatus.classList.add('text-red-500');
                }
            );
        } else {
            locationStatus.textContent = 'เบราว์เซอร์ไม่รองรับการรับพิกัด GPS';
            locationStatus.classList.remove('text-gray-500');
            locationStatus.classList.add('text-red-500');
        }
        
        // ฟังก์ชันสำหรับเรียกใช้ JSONP
        function jsonp(url) {
            return new Promise((resolve, reject) => {
                // สร้างชื่อฟังก์ชันแบบสุ่ม
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // สร้าง script element
                const script = document.createElement('script');
                
                // ตั้งค่า callback function
                window[callbackName] = function(data) {
                    // ลบ script element
                    document.body.removeChild(script);
                    // ลบ callback function
                    delete window[callbackName];
                    // ส่งข้อมูลกลับ
                    resolve(data);
                };
                
                // ตั้งค่า error handler
                script.onerror = function() {
                    // ลบ script element
                    document.body.removeChild(script);
                    // ลบ callback function
                    delete window[callbackName];
                    // ส่งข้อผิดพลาดกลับ
                    reject(new Error('JSONP request failed'));
                };
                
                // เพิ่ม callback parameter ใน URL
                const separator = url.indexOf('?') !== -1 ? '&' : '?';
                script.src = url + separator + 'callback=' + callbackName;
                
                // เพิ่ม script element ลงใน document
                document.body.appendChild(script);
            });
        }
        
        // ฟังก์ชันสำหรับขอรหัสใหม่
        async function getNewCode() {
            try {
                const url = `${SCRIPT_URL}?action=getCode`;
                const response = await jsonp(url);
                
                if (response.status === 'success') {
                    return response.code;
                } else {
                    throw new Error(response.message || 'ไม่สามารถขอรหัสใหม่ได้');
                }
            } catch (error) {
                console.error('Error getting new code:', error);
                throw error;
            }
        }
        
        // ฟังก์ชันสำหรับบันทึกข้อมูล
        async function saveData(data) {
            try {
                // สร้าง URL พร้อมพารามิเตอร์
                let url = `${SCRIPT_URL}?action=saveData`;
                for (const key in data) {
                    if (key !== 'photoData') { // ไม่รวมข้อมูลรูปภาพใน URL
                        url += `&${key}=${encodeURIComponent(data[key])}`;
                    }
                }
                
                // ส่งข้อมูลรูปภาพแยกต่างหาก (ถ้ามี)
                if (data.photoData) {
                    url += `&hasPhoto=true`;
                    // หมายเหตุ: ในสถานการณ์จริง คุณอาจต้องแบ่งข้อมูลรูปภาพเป็นส่วนๆ
                    // หรือใช้วิธีอื่นในการส่งข้อมูลขนาดใหญ่
                }
                
                const response = await jsonp(url);
                
                if (response.status === 'success') {
                    return response;
                } else {
                    throw new Error(response.message || 'ไม่สามารถบันทึกข้อมูลได้');
                }
            } catch (error) {
                console.error('Error saving data:', error);
                throw error;
            }
        }
        
        // ส่งข้อมูลแบบฟอร์ม
        const form = document.getElementById('visitorForm');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!photoTaken) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาถ่ายภาพ',
                    text: 'โปรดถ่ายภาพผู้มาติดต่อก่อนบันทึกข้อมูล',
                    confirmButtonColor: '#4f46e5'
                });
                return;
            }
            
            // แสดง loading
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                // ขอรหัสใหม่
                const visitorCode = await getNewCode();
                
                // สร้างข้อมูลสำหรับส่ง
                const formData = {
                    code: visitorCode,
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    houseNumber: document.getElementById('houseNumber').value,
                    reason: document.getElementById('reason').value,
                    datetime: document.getElementById('datetime').value,
                    photoData: document.getElementById('photoData').value,
                    latitude: document.getElementById('latitude').value,
                    longitude: document.getElementById('longitude').value
                };
                
                // บันทึกข้อมูล
                await saveData(formData);
                
                // แสดงผลลัพธ์
                document.getElementById('visitorCode').textContent = visitorCode;
                document.getElementById('resultName').textContent = formData.name;
                document.getElementById('resultPhone').textContent = formData.phone;
                document.getElementById('resultHouse').textContent = formData.houseNumber;
                document.getElementById('resultReason').textContent = formData.reason;
                
                // จัดรูปแบบวันที่และเวลา
                const dateObj = new Date(formData.datetime);
                const formattedDate = dateObj.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('resultDatetime').textContent = formattedDate;
                
                // สร้าง QR Code
                const qrcodeContainer = document.getElementById('qrcode');
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, {
                    text: visitorCode,
                    width: 128,
                    height: 128,
                    colorDark: '#4f46e5',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // แสดงส่วนผลลัพธ์
                document.getElementById('resultSection').classList.remove('hidden');
                
                // เลื่อนไปยังส่วนผลลัพธ์
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
                
                // ปิด loading
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกข้อมูลสำเร็จ',
                    text: `รหัสผู้มาติดต่อของคุณคือ: ${visitorCode}`,
                    confirmButtonColor: '#4f46e5'
                });
                
                // หยุดกล้อง
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
            } catch (error) {
                console.error('Error submitting form:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                    confirmButtonColor: '#4f46e5'
                });
            }
        });
        
        // ปุ่มลงทะเบียนใหม่
        document.getElementById('newRegistrationBtn').addEventListener('click', () => {
            // รีเซ็ตฟอร์ม
            form.reset();
            document.getElementById('datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // รีเซ็ตกล้อง
            photoTaken = false;
            photoStatus.textContent = 'กรุณาถ่ายภาพ';
            photoStatus.classList.remove('text-green-600');
            photoStatus.classList.add('text-gray-500');
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            // เริ่มกล้องใหม่
            startCamera();
            
            // ซ่อนส่วนผลลัพธ์
            document.getElementById('resultSection').classList.add('hidden');
            
            // เลื่อนไปยังด้านบนของฟอร์ม
            form.scrollIntoView({ behavior: 'smooth' });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'961b779de77aee62',t:'MTc1Mjk0MTE5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

