<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visitor Pass - Goldenland Serene</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #06b6d4;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #1e293b;
        }

        .card {
            background: var(--glass-bg);
            border-radius: 24px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            position: relative;
        }

        /* Profile Section */
        .profile-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #334155;
        }

        /* Form Elements */
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #64748b; }
        
        input {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-size: 1.1rem; text-align: center; font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-family: 'Kanit', sans-serif; transition: 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-line { background: #06c755; color: white; margin-top: 10px; }
        .btn-save { background: #0ea5e9; color: white; margin-top: 10px; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* Ticket UI */
        .ticket-wrapper {
            background: white; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 20px; margin-top: 20px; display: none;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE -->
    <div id="liff-loading">
        <i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
    </div>
    
    <div id="user-profile" class="hidden profile-area">
        <img id="userPicture" src="https://via.placeholder.com/80" class="profile-img" crossorigin="anonymous">
        <div class="profile-name">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName">User</span></div>
    </div>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ -->
    <div id="setup-form" class="hidden">
        <div class="input-group">
            <label><i class="fa-solid fa-house"></i> ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
            <input type="text" id="houseNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô 99/88">
        </div>
        
        <button class="btn btn-primary" onclick="generatePass()" id="genBtn">
            <i class="fa-solid fa-qrcode"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
        </button>
    </div>

    <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå QR Code -->
    <div id="pass-info" class="ticket-wrapper">
        <div id="capture-area" style="background:white; padding:10px; border-radius:10px;">
            <h3 style="margin:0; color:var(--primary);">VISITOR PASS</h3>
            <div style="font-size:0.8rem; color:#94a3b8;">Requested by: <span id="displayRequester"></span></div>
            <div id="qrcode" style="margin:15px 0; display:flex; justify-content:center;"></div>
            <div style="font-size:1.5rem; font-weight:bold; color:#334155;" id="displayHouse"></div>
            <div style="font-size:0.9rem; color:#64748b;" id="expDate"></div>
        </div>

        <button class="btn btn-save" onclick="saveAsImage()">
            <i class="fa-solid fa-download"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        </button>
        <button class="btn btn-line" onclick="shareToLine()">
            <i class="fa-brands fa-line"></i> ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
        </button>
        <button class="btn" style="background:transparent; color:#94a3b8; margin-top:5px;" onclick="location.reload()">
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>
</div>

<script>
    // --- Config ---
    const LIFF_ID = "2000143615-rk76Q732"; // **‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà**
    const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    let lineProfile = null;
    let generatedPass = "";

    // --- 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö LIFF ---
    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            lineProfile = await liff.getProfile();
            
            document.getElementById('liff-loading').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            document.getElementById('setup-form').classList.remove('hidden');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á cache ‡πÅ‡∏•‡∏∞ crossorigin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö html2canvas
            document.getElementById('userPicture').src = lineProfile.pictureUrl + "?" + new Date().getTime(); 
            document.getElementById('userName').innerText = lineProfile.displayName;

        } catch (err) {
            console.error(err);
            document.getElementById('liff-loading').innerHTML = `<span style="color:red">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE</span>`;
        }
    }
    main();

    // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ ---
    async function generatePass() {
        const house = document.getElementById('houseNumber').value.trim();
        if (!house) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', 'warning');

        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';

        try {
            let isUnique = false;
            let code = "";

            while (!isUnique) {
                code = Math.floor(100000 + Math.random() * 900000).toString();
                const { data: active } = await supabaseClient.from('access_tokens').select('id').eq('token_code', code).maybeSingle();
                const { data: deleted } = await supabaseClient.from('access_delete').select('id').eq('token_code', code).maybeSingle();
                if (!active && !deleted) isUnique = true;
            }

            const exp = new Date();
            exp.setHours(exp.getHours() + 24);

            const { error } = await supabaseClient.from('access_tokens').insert([{
                token_code: code,
                house_number: house,
                status: 'active',
                type: 'visitor',
                valid_until: exp.toISOString(),
                use_count: 0,
                requester_line_id: lineProfile?.userId || 'unknown',
                requester_name: lineProfile?.displayName || 'Guest',
                requester_picture: lineProfile?.pictureUrl || ''
            }]);

            if (error) throw error;

            generatedPass = code;
            showQR(code, house, exp);
            triggerConfetti();

        } catch (error) {
            Swal.fire('Error', error.message, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-qrcode"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code';
        }
    }

    function showQR(code, house, expDate) {
        document.getElementById('setup-form').classList.add('hidden');
        document.getElementById('pass-info').style.display = 'block';
        
        document.getElementById('displayHouse').innerText = house;
        document.getElementById('displayRequester').innerText = lineProfile?.displayName;
        
        const dateOptions = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('expDate').innerText = "‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: " + expDate.toLocaleDateString('th-TH', dateOptions);

        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, { text: code, width: 180, height: 180 });
    }

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFF) ---
    function saveAsImage() {
        const element = document.getElementById('capture-area');
        
        // ‡πÅ‡∏™‡∏î‡∏á Loading
        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading() }
        });

        // ‡πÉ‡∏ä‡πâ html2canvas ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ (useCORS: true ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)
        html2canvas(element, { scale: 3, useCORS: true }).then(canvas => {
            const dataUrl = canvas.toDataURL("image/png");
            Swal.close(); // ‡∏õ‡∏¥‡∏î Loading

            if (liff.isInClient() && (liff.getOS() === "ios" || liff.getOS() === "android")) {
                // *** ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE LIFF ***
                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ô Popup ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Save
                Swal.fire({
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û',
                    text: 'üëâ ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" (Save Image)',
                    imageUrl: dataUrl,
                    imageWidth: 280,
                    imageAlt: 'Visitor Pass',
                    showConfirmButton: true,
                    confirmButtonText: '‡∏õ‡∏¥‡∏î',
                    confirmButtonColor: '#4f46e5'
                });
            } else {
                // *** ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Browser ‡∏õ‡∏Å‡∏ï‡∏¥ ***
                // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                const link = document.createElement('a');
                link.download = `Pass-${generatedPass}.png`;
                link.href = dataUrl;
                link.click();
            }
        }).catch(err => {
            Swal.close();
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: ' + err.message, 'error');
        });
    }

    function shareToLine() {
        if (liff.isInClient()) {
            liff.sendMessages([{
                type: 'text',
                text: `üè† ‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô\nüìç ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${document.getElementById('displayHouse').innerText}\nüîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ${generatedPass}`
            }]).then(() => {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }).catch((err) => {
                liff.shareTargetPicker([{
                    type: 'text',
                    text: `üè† ‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô\nüìç ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${document.getElementById('displayHouse').innerText}\nüîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ${generatedPass}`
                }]);
            });
        } else {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
        }
    }

    function triggerConfetti() {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
</script>
</body>
</html>
