<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --border-color: rgba(255, 255, 255, 0.6);
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --input-text: #1f2937;
            --navbar-text: #1f2937; /* Dark text for light mode navbar */
            --navbar-bg: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --panel-bg: rgba(30, 41, 59, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(15, 23, 42, 0.6);
            --input-border: rgba(148, 163, 184, 0.2);
            --input-text: #f1f5f9;
            --navbar-text: #e2e8f0;
            --navbar-bg: rgba(15, 23, 42, 0.8);
        }

        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .glass-panel { 
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            transition: background 0.3s;
        }

        .input-field {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--input-text);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }

        /* Navbar & Gradient - Adjusted for readability */
        .gradient-bg { 
            background: var(--navbar-bg); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        .navbar-text { color: var(--navbar-text); }

        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Tabs */
        .tab-btn { transition: all 0.2s ease; color: var(--text-color); opacity: 0.7; }
        .tab-btn.tab-active { 
            color: #4f46e5; 
            border-bottom: 3px solid #4f46e5; 
            background: rgba(79, 70, 229, 0.1); 
            font-weight: 600; 
            opacity: 1;
        }
        [data-theme="dark"] .tab-btn.tab-active { color: #a5b4fc; border-bottom-color: #a5b4fc; background: rgba(79, 70, 229, 0.25); }
        .tab-btn:hover { background-color: rgba(0,0,0,0.05); opacity: 1; }
        [data-theme="dark"] .tab-btn:hover { background-color: rgba(255,255,255,0.1); }

        /* Chat */
        .chat-container { background-image: url('https://kiumelolsilduqnvrekf.supabase.co/storage/v1/object/public/user-images/bg-chat.png'); background-size: cover; background-position: center; } 
        .chat-bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; position: relative; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-user { background: linear-gradient(135deg, #4f46e5, #6366f1); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-bot { background: white; color: #1f2937; border-bottom-left-radius: 4px; margin-right: auto; }
        [data-theme="dark"] .chat-bot { background: #334155; color: #f1f5f9; }
        
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); display: none; z-index: 9999; }
        
        /* Larger Headers */
        h1.main-title { font-size: 1.5rem; letter-spacing: -0.025em; }
        h2.section-title { font-size: 1.5rem; letter-spacing: -0.01em; }
        h3.card-title { font-size: 1.25rem; }
    </style>
</head>
<body class="min-h-screen pb-10">
    
    <!-- Navbar -->
    <div class="gradient-bg shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 text-white p-2.5 rounded-xl shadow-md"><i class="fas fa-database text-2xl"></i></div>
                <div>
                    <h1 class="main-title font-bold navbar-text leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h1>
                    <p class="text-sm navbar-text opacity-80 font-light">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô AI Assistant</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="bg-gray-200 dark:bg-white/10 p-2.5 rounded-full hover:bg-gray-300 dark:hover:bg-white/20 transition backdrop-blur-sm navbar-text border border-gray-300 dark:border-white/10">
                    <i class="fas fa-sun text-lg" id="themeIcon"></i>
                </button>
                <div class="text-xs font-medium bg-gray-200 dark:bg-white/10 px-4 py-1.5 rounded-full border border-gray-300 dark:border-white/20 navbar-text backdrop-blur-sm">v2.7 Pro</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="container mx-auto px-4 mt-2">
            <div class="flex overflow-x-auto gap-2 pb-0 no-scrollbar">
                <button id="keywordsTab" class="tab-btn tab-active py-3 px-6 text-base rounded-t-xl whitespace-nowrap"><i class="fas fa-key mr-2"></i>‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</button>
                <button id="permissionsTab" class="tab-btn tab-inactive py-3 px-6 text-base rounded-t-xl whitespace-nowrap"><i class="fas fa-shield-alt mr-2"></i>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                <button id="dataaiTab" class="tab-btn tab-inactive py-3 px-6 text-base rounded-t-xl whitespace-nowrap"><i class="fas fa-book mr-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ AI</button>
                <button id="userProfilesTab" class="tab-btn tab-inactive py-3 px-6 text-base rounded-t-xl whitespace-nowrap"><i class="fas fa-users mr-2"></i>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                <button id="chatHistoryTab" class="tab-btn tab-inactive py-3 px-6 text-base rounded-t-xl whitespace-nowrap"><i class="fas fa-comments mr-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î -->
        <div id="keywordsPage" class="fade-in">
            <div class="glass-panel rounded-3xl p-8 mb-8">
                <div class="flex items-center gap-4 mb-8 pb-5 border-b border-gray-200/50">
                    <div class="w-14 h-14 rounded-2xl bg-indigo-500/10 flex items-center justify-center text-indigo-600 shadow-sm"><i class="fas fa-plus text-2xl"></i></div>
                    <div>
                        <h2 class="section-title font-bold text-indigo-600 dark:text-indigo-400">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h2>
                        <p class="text-gray-500 dark:text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó</p>
                    </div>
                </div>
                <form id="keywordForm" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="lg:col-span-2">
                            <label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üéØ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Keyword)</label>
                            <input type="text" id="keyword" name="keyword" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô" required>
                        </div>
                        <div>
                            <label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (Text)</label>
                            <textarea id="reply_text" name="reply_text" rows="3" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥"></textarea>
                        </div>
                        <div>
                            <label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üß© Flex Message (JSON)</label>
                            <textarea id="reply_flex" name="reply_flex" rows="3" class="input-field w-full px-5 py-3.5 rounded-2xl text-sm font-mono shadow-sm" placeholder='{"type": "flex", ...}'></textarea>
                        </div>
                        <div><label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label><input type="url" id="reply_image" name="reply_image" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm" placeholder="https://..."></div>
                        <div><label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üì± Rich Menu ID</label><input type="text" id="reply_richmenu" name="reply_richmenu" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm"></div>
                        <div><label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üìÑ Template (JSON)</label><input type="text" id="reply_template" name="reply_template" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm"></div>
                        <div><label class="block text-base font-semibold mb-2 text-gray-700 dark:text-gray-300">üîÑ Postback Data</label><input type="text" id="reply_postback" name="reply_postback" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm"></div>
                        <div class="lg:col-span-2">
                            <label class="block text-base font-semibold mb-2 text-indigo-600 dark:text-indigo-400">ü§ñ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© AI (Prompt)</label>
                            <textarea id="reply_prompt" name="reply_prompt" rows="2" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm border-indigo-200 dark:border-indigo-800" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ..."></textarea>
                        </div>
                        <div class="lg:col-span-2">
                            <label class="flex items-center gap-3 cursor-pointer p-4 rounded-2xl border border-gray-200/50 hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition bg-white/30 dark:bg-black/20">
                                <input type="checkbox" id="require_vip" name="require_vip" class="w-6 h-6 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="font-semibold text-gray-700 dark:text-gray-300 text-lg">üëë ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VIP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex gap-4 justify-end pt-6 border-t border-gray-200/50">
                        <button type="button" onclick="resetKeywordForm()" class="px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-500 font-bold hover:bg-gray-100 transition">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                        <button type="submit" class="px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-1 transition btn-hover text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>

            <div class="glass-panel rounded-3xl p-8">
                <h3 class="card-title font-bold mb-6 flex items-center gap-3 text-gray-800 dark:text-white"><i class="fas fa-list text-indigo-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="overflow-x-auto rounded-2xl border border-gray-200/50">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100/50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 uppercase text-xs font-bold tracking-wider">
                            <tr><th class="p-4">‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</th><th class="p-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th><th class="p-4 text-center">VIP</th><th class="p-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                        </thead>
                        <tbody id="recordsList" class="text-sm divide-y divide-gray-200/50 dark:divide-gray-700/50"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå -->
        <div id="permissionsPage" class="hidden fade-in">
            <div class="glass-panel rounded-3xl p-8 mb-8">
                <h2 class="section-title font-bold mb-8 flex items-center gap-3 text-emerald-600 dark:text-emerald-400"><i class="fas fa-user-shield text-3xl"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h2>
                <form id="permissionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><label class="block text-base font-semibold mb-2">User ID ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label><input type="text" id="permUserId" name="userId" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm" required></div>
                        <div><label class="block text-base font-semibold mb-2">‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</label><input type="text" id="permKeyword" name="keyword" class="input-field w-full px-5 py-3.5 rounded-2xl text-base shadow-sm" required></div>
                        <div class="md:col-span-2">
                            <label class="flex items-center gap-4 cursor-pointer p-4 rounded-2xl border border-emerald-200/50 bg-emerald-50/30 dark:bg-emerald-900/10">
                                <input type="checkbox" id="permVip" name="vip" class="w-6 h-6 text-emerald-600 rounded border-emerald-300 focus:ring-emerald-500">
                                <span class="font-bold text-emerald-700 dark:text-emerald-400 text-lg">‡∏°‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ VIP (‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©)</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end pt-6"><button type="submit" class="bg-emerald-600 text-white px-10 py-3 rounded-2xl font-bold text-lg shadow-lg hover:bg-emerald-700 btn-hover">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button></div>
                </form>
            </div>
            <div class="glass-panel rounded-3xl p-8">
                <h3 class="card-title font-bold mb-6 text-gray-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <div class="overflow-x-auto rounded-2xl border border-gray-200/50"><table class="w-full text-left"><tbody id="permissionsList" class="text-sm divide-y divide-gray-200/50 dark:divide-gray-700/50"></tbody></table></div>
            </div>
        </div>

        <!-- 3. ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ AI -->
        <div id="dataaiPage" class="hidden fade-in">
            <div class="glass-panel rounded-3xl p-8 mb-8">
                <h2 class="section-title font-bold mb-8 flex items-center gap-3 text-pink-600 dark:text-pink-400"><i class="fas fa-brain text-3xl"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ AI</h2>
                <form id="dataaiForm" class="space-y-6">
                    <div><label class="block text-base font-semibold mb-3">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (‡∏™‡∏≠‡∏ô AI)</label><textarea id="content" name="content" rows="6" class="input-field w-full px-5 py-4 rounded-2xl text-base shadow-sm leading-relaxed" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ..." required></textarea></div>
                    <div class="flex justify-end pt-4"><button type="submit" class="bg-pink-600 text-white px-10 py-3 rounded-2xl font-bold text-lg shadow-lg hover:bg-pink-700 btn-hover">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</button></div>
                </form>
            </div>
            <div class="glass-panel rounded-3xl p-8">
                <h3 class="card-title font-bold mb-6 text-gray-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <div class="overflow-x-auto rounded-2xl border border-gray-200/50"><table class="w-full text-left"><tbody id="dataaiList" class="text-sm divide-y divide-gray-200/50 dark:divide-gray-700/50"></tbody></table></div>
            </div>
        </div>

        <!-- 4. ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
        <div id="userProfilesPage" class="hidden fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-8">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-600 shadow-sm"><i class="fas fa-users-cog text-3xl"></i></div>
                    <div><h2 class="section-title font-bold text-gray-800 dark:text-white">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><p class="text-base text-gray-500 dark:text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p></div>
                </div>
                <button onclick="openAddUserProfileModal()" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-700 btn-hover flex items-center gap-2"><i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>

            <!-- Master Switches (Updated to Toggle Style) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel rounded-3xl p-6 border-l-8 border-indigo-500 flex justify-between items-center relative overflow-hidden">
                    <div class="z-10">
                        <h3 class="font-bold text-xl text-indigo-600 dark:text-indigo-400">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå AI ‡∏´‡∏•‡∏±‡∏Å</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Master AI Switch</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer z-10">
                        <input type="checkbox" id="masterAIToggle" onchange="toggleAllAI(this.checked)" class="sr-only peer">
                        <div class="w-16 h-9 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-indigo-600 shadow-inner"></div>
                    </label>
                </div>
                <div class="glass-panel rounded-3xl p-6 border-l-8 border-pink-500 flex justify-between items-center relative overflow-hidden">
                    <div class="z-10">
                        <h3 class="font-bold text-xl text-pink-600 dark:text-pink-400">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Master KW Switch</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer z-10">
                        <input type="checkbox" id="masterKeywordToggle" onchange="toggleAllKeywords(this.checked)" class="sr-only peer">
                        <div class="w-16 h-9 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-pink-600 shadow-inner"></div>
                    </label>
                </div>
            </div>

            <div id="profileCardContainer" class="hidden mb-8"><div class="glass-panel rounded-3xl p-8 relative border-l-8 border-indigo-500 shadow-xl"><button onclick="document.getElementById('profileCardContainer').classList.add('hidden')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-700 dark:hover:text-white transition"><i class="fas fa-times text-2xl"></i></button><div id="profileCardContent"></div></div></div>
            
            <div class="glass-panel rounded-3xl p-8">
                <div class="overflow-x-auto rounded-2xl border border-gray-200/50"><table class="w-full text-left"><thead class="bg-gray-100/50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 uppercase text-xs font-bold tracking-wider"><tr><th class="p-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th class="p-4 text-center">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="userProfilesTable" class="text-sm divide-y divide-gray-200/50 dark:divide-gray-700/50"></tbody></table></div>
            </div>
        </div>

        <!-- 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó -->
        <div id="chatHistoryPage" class="hidden fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-6 mb-8">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center shadow-sm"><i class="fas fa-history text-2xl"></i></div>
                    <h2 class="section-title font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h2>
                </div>
                <div class="flex gap-3 w-full sm:w-auto">
                    <input type="text" id="searchUserId" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="input-field w-full px-5 py-3 rounded-2xl shadow-sm">
                    <button onclick="searchChatHistory()" class="bg-orange-600 text-white px-8 py-3 rounded-2xl hover:bg-orange-700 shadow-lg font-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>
            <div class="glass-panel rounded-3xl p-8">
                <div class="overflow-x-auto rounded-2xl border border-gray-200/50"><table class="w-full text-left"><thead class="bg-gray-100/50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 uppercase text-xs font-bold tracking-wider"><tr><th class="p-4">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th class="p-4 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-4">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th class="p-4 text-right">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="p-4 text-center">‡∏î‡∏π‡πÅ‡∏ä‡∏ó</th></tr></thead><tbody id="chatUsersTable" class="text-sm divide-y divide-gray-200/50 dark:divide-gray-700/50"></tbody></table></div>
            </div>
        </div>

        <!-- Modals -->
        <div id="chatHistoryModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[9000] p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel rounded-3xl w-full max-w-4xl h-[90vh] flex flex-col relative overflow-hidden bg-white dark:bg-gray-800 border border-gray-200/20 shadow-2xl">
                <div class="px-8 py-5 border-b border-gray-200/10 flex justify-between items-center bg-gray-50/80 dark:bg-gray-900/80 backdrop-blur-md z-10">
                    <div class="flex items-center gap-4"><div id="modalUserAvatar" class="w-12 h-12 rounded-full bg-gray-300 bg-cover border-2 border-white dark:border-gray-600 shadow-md"></div><div><h3 id="modalUserName" class="font-bold text-xl text-gray-800 dark:text-white">Loading...</h3><p id="modalUserId" class="text-xs text-gray-500 font-mono"></p></div></div>
                    <button onclick="closeChatHistoryModal()" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-red-500 hover:text-white flex items-center justify-center transition"><i class="fas fa-times"></i></button>
                </div>
                <div id="chatMessagesContainer" class="flex-1 overflow-y-auto p-8 chat-container space-y-6"></div>
            </div>
        </div>

        <div id="knowledgeBaseModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[9100] p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel rounded-3xl w-full max-w-2xl p-8 relative bg-white dark:bg-gray-800 border border-gray-200/20 shadow-2xl">
                <button onclick="document.getElementById('knowledgeBaseModal').classList.add('hidden')" class="absolute top-6 right-6 opacity-60 hover:opacity-100 hover:text-red-500 transition"><i class="fas fa-times text-2xl"></i></button>
                <h3 class="text-2xl font-bold mb-6 text-pink-600 dark:text-pink-400 flex items-center gap-3"><i class="fas fa-file-alt"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</h3>
                <div class="bg-gray-100 dark:bg-gray-900 p-8 rounded-2xl text-lg leading-relaxed overflow-y-auto max-h-[60vh] border border-gray-200/20 shadow-inner text-gray-700 dark:text-gray-300" id="knowledgeDetailContent"></div>
            </div>
        </div>

        <div id="addUserProfileModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[9200] p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel rounded-3xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-10 relative bg-white dark:bg-gray-800 border border-gray-200/20 shadow-2xl">
                <button onclick="closeAddUserProfileModal()" class="absolute top-8 right-8 opacity-60 hover:opacity-100 hover:text-red-500 transition"><i class="fas fa-times text-2xl"></i></button>
                <h3 class="text-2xl font-bold mb-10 text-indigo-600 dark:text-indigo-400 border-b border-gray-200/30 pb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <form id="userProfileForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-base font-semibold mb-2">User ID</label><input type="text" id="editProfileUserId" name="userId" class="input-field w-full px-5 py-3.5 rounded-2xl" required></div>
                        <div><label class="block text-base font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label><input type="text" id="editDisplayName" name="displayName" class="input-field w-full px-5 py-3.5 rounded-2xl"></div>
                        <div><label class="block text-base font-semibold mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="editEmail" name="email" class="input-field w-full px-5 py-3.5 rounded-2xl"></div>
                        <div><label class="block text-base font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="editPhone" name="phone" class="input-field w-full px-5 py-3.5 rounded-2xl"></div>
                        <div><label class="block text-base font-semibold mb-2">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label><select id="editRole" name="role" class="input-field w-full px-5 py-3.5 rounded-2xl"><option value="user">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option><option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option><option value="vip">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VIP</option></select></div>
                        <div class="flex flex-col pt-2 gap-4">
                            <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <span class="font-medium text-lg">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="editAiEnabled" name="ai_enabled" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600 shadow-sm"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <span class="font-medium text-lg">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="editKeywordsEnabled" name="keywords_enabled" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-pink-600 shadow-sm"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-10 pt-6 border-t border-gray-200/20">
                        <button type="button" onclick="closeAddUserProfileModal()" class="px-8 py-3 rounded-xl border-2 border-gray-300 text-gray-500 font-bold hover:bg-gray-100 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-10 py-3 rounded-xl bg-indigo-600 text-white font-bold text-lg shadow-lg hover:bg-indigo-700 btn-hover">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="loading-overlay" class="flex flex-col items-center justify-center gap-6 fixed inset-0 hidden z-[9999]">
            <div class="relative w-20 h-20">
                <div class="w-full h-full border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
            </div>
            <p class="text-xl font-bold text-white tracking-widest animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
    </div>

    <script>
        // Config & State
        var supabaseUrl = 'https://kiumelolsilduqnvrekf.supabase.co';
        var supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        var allKeywords=[], allChatUsers=[];
        var editingKeywordId=null, editingPermissionId=null, editingDataAIId=null, editingUserProfileId=null;

        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th');

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Setup
        function setupTabs() {
            const tabs = ['keywords', 'permissions', 'dataai', 'userProfiles', 'chatHistory'];
            tabs.forEach(t => {
                document.getElementById(`${t}Tab`).onclick = () => {
                    tabs.forEach(x => {
                        document.getElementById(`${x}Page`).classList.add('hidden');
                        document.getElementById(`${x}Tab`).classList.replace('tab-active', 'tab-inactive');
                    });
                    document.getElementById(`${t}Page`).classList.remove('hidden');
                    document.getElementById(`${t}Tab`).classList.replace('tab-inactive', 'tab-active');
                    
                    if(t==='keywords') loadKeywords();
                    if(t==='permissions') loadPermissions();
                    if(t==='dataai') loadDataAI();
                    if(t==='userProfiles') loadUserProfiles();
                    if(t==='chatHistory') loadChatUsers();
                }
            });
        }

        function setupForms() {
            // Keyword
            document.getElementById('keywordForm').onsubmit = async (e) => {
                e.preventDefault();
                const d = new FormData(e.target);
                const data = { keyword: d.get('keyword'), reply_text: d.get('reply_text'), reply_flex: d.get('reply_flex'), reply_image: d.get('reply_image'), reply_richmenu: d.get('reply_richmenu'), reply_template: d.get('reply_template'), reply_postback: d.get('reply_postback'), reply_prompt: d.get('reply_prompt'), require_vip: d.get('require_vip')==='on' };
                try {
                    if(editingKeywordId) await supabase.from('keywords').update(data).eq('id', editingKeywordId);
                    else await supabase.from('keywords').insert([data]);
                    Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}); resetKeywordForm(); loadKeywords();
                } catch(err){ Swal.fire({icon:'error', text:err.message}); }
            };
            // Permission
            document.getElementById('permissionForm').onsubmit = async (e) => {
                e.preventDefault();
                const data = { userId: document.getElementById('permUserId').value, keyword: document.getElementById('permKeyword').value, vip: document.getElementById('permVip').checked };
                try {
                    if(editingPermissionId) await supabase.from('keyword_permissions').update(data).eq('id', editingPermissionId);
                    else await supabase.from('keyword_permissions').insert([data]);
                    Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}); document.getElementById('permissionForm').reset(); editingPermissionId=null; loadPermissions();
                } catch(err){ Swal.fire({icon:'error', text:err.message}); }
            };
            // DataAI
            document.getElementById('dataaiForm').onsubmit = async (e) => {
                e.preventDefault();
                const content = document.getElementById('content').value;
                try {
                    if(editingDataAIId) await supabase.from('dataai').update({content}).eq('id', editingDataAIId);
                    else await supabase.from('dataai').insert([{content}]);
                    Swal.fire({icon:'success', title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}); document.getElementById('dataaiForm').reset(); editingDataAIId=null; loadDataAI();
                } catch(err){ Swal.fire({icon:'error', text:err.message}); }
            };
            // User Profile (Corrected IDs)
            document.getElementById('userProfileForm').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    userId: document.getElementById('editProfileUserId').value,
                    displayName: document.getElementById('editDisplayName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    ai_enabled: document.getElementById('editAiEnabled').checked,
                    keywords_enabled: document.getElementById('editKeywordsEnabled').checked
                };
                try {
                    await supabase.from('user_profiles').upsert(data, { onConflict: 'userId' });
                    Swal.fire({icon:'success', title:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}); closeAddUserProfileModal(); loadUserProfiles();
                } catch(err){ Swal.fire({icon:'error', text:err.message}); }
            };
        }

        // --- Data Loading ---
        async function loadKeywords() {
            const { data } = await supabase.from('keywords').select('*').order('created_at', {ascending: false});
            allKeywords = data || [];
            document.getElementById('recordsList').innerHTML = allKeywords.map(i => `
                <tr class="hover:bg-gray-500/5 transition">
                    <td class="p-4 font-bold text-indigo-500 text-lg">${i.keyword}</td>
                    <td class="p-4"><span class="bg-gray-500/10 border border-gray-500/20 px-3 py-1 rounded-lg text-xs font-semibold">${i.reply_prompt?'AI':i.reply_flex?'Flex':i.reply_image?'Img':'Text'}</span></td>
                    <td class="p-4 text-sm opacity-70 truncate max-w-xs font-light">${i.reply_prompt||i.reply_text||'(Complex)'}</td>
                    <td class="p-4 text-center">${i.require_vip?'<span class="text-yellow-500 bg-yellow-100/20 px-2 py-1 rounded border border-yellow-500/30">üëë VIP</span>':'<span class="opacity-30">-</span>'}</td>
                    <td class="p-4 text-right">
                        <button onclick="editKeyword(${i.id})" class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg mx-1 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteKeyword(${i.id})" class="text-red-500 hover:bg-red-100 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        async function loadPermissions() {
            const { data } = await supabase.from('keyword_permissions').select('*').order('created_at', {ascending: false});
            document.getElementById('permissionsList').innerHTML = data.map(p => `
                <tr class="hover:bg-gray-500/5 transition">
                    <td class="p-4 font-mono text-sm">${p.userId}</td>
                    <td class="p-4 font-bold text-emerald-500 text-lg">${p.keyword}</td>
                    <td class="p-4 text-center">${p.vip?'<span class="bg-emerald-500/10 text-emerald-500 px-3 py-1 rounded-lg border border-emerald-500/20 font-bold text-xs">VIP ACCESS</span>':'<span class="opacity-30">-</span>'}</td>
                    <td class="p-4 text-right">
                        <button onclick="editPermission(${p.id})" class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg mx-1 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePermission(${p.id})" class="text-red-500 hover:bg-red-100 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        async function loadDataAI() {
            const { data } = await supabase.from('dataai').select('*').order('created_at', {ascending: false});
            document.getElementById('dataaiList').innerHTML = data.map((d,i) => `
                <tr class="hover:bg-gray-500/5 transition cursor-pointer" onclick="openKnowledgeModal('${d.content.replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/\n/g,'<br>')}')">
                    <td class="p-4 font-light text-sm opacity-80 leading-relaxed line-clamp-2">${d.content.substring(0,80)}...</td>
                    <td class="p-4 text-center" onclick="event.stopPropagation()">
                        <button onclick="editDataAI(${d.id})" class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg mx-1 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteDataAI(${d.id})" class="text-red-500 hover:bg-red-100 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        // [Updated] Load User Profiles with Sorting
        async function loadUserProfiles() {
            // 1. Fetch Profiles
            const { data: profiles } = await supabase.from('user_profiles').select('*');
            
            // 2. Fetch Chat History to determine last active
            const { data: chats } = await supabase.from('chat_history').select('user_id, created_at').order('created_at', {ascending: false});
            
            // 3. Map Last Active Time
            const lastActiveMap = {};
            if (chats) {
                chats.forEach(c => {
                    if (!lastActiveMap[c.user_id]) {
                        lastActiveMap[c.user_id] = new Date(c.created_at).getTime();
                    }
                });
            }

            // 4. Merge and Sort
            profiles.forEach(p => {
                const chatTime = lastActiveMap[p.userId] || 0;
                const updateTime = new Date(p.updated_at || 0).getTime();
                p._sortTime = Math.max(chatTime, updateTime); // Sort by latest activity
                if (typeof p.keywords_enabled === 'undefined') p.keywords_enabled = true;
            });
            
            // Sort Descending
            profiles.sort((a, b) => b._sortTime - a._sortTime);

            // Sync Master Toggles
            if(profiles.length > 0) {
                document.getElementById('masterAIToggle').checked = profiles.every(u => u.ai_enabled);
                document.getElementById('masterKeywordToggle').checked = profiles.every(u => u.keywords_enabled !== false);
            }

            document.getElementById('userProfilesTable').innerHTML = profiles.map(u => `
                <tr class="hover:bg-gray-500/5 transition cursor-pointer" onclick="showProfileCard('${u.userId}')">
                    <td class="p-4">
                        <div class="flex items-center gap-4">
                            <img src="${u.pictureUrl||'https://via.placeholder.com/40'}" class="w-12 h-12 rounded-full border-2 border-gray-200/50 shadow-sm object-cover">
                            <div><div class="font-bold text-base text-gray-800 dark:text-white">${u.displayName||'Unknown'}</div><div class="text-xs opacity-50 font-mono">${u.userId.substring(0,12)}...</div></div>
                        </div>
                    </td>
                    <td class="p-4 text-center" onclick="event.stopPropagation()">
                        <div class="flex justify-center gap-4">
                            <!-- AI Toggle Switch -->
                            <div class="flex flex-col items-center gap-1">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" onchange="toggleUserAI('${u.userId}',this.checked)" ${u.ai_enabled?'checked':''}>
                                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600 shadow-inner"></div>
                                </label>
                                <span class="text-[9px] font-bold tracking-wide opacity-60">AI</span>
                            </div>
                            <!-- Keyword Toggle Switch -->
                            <div class="flex flex-col items-center gap-1">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" onchange="toggleUserKeywords('${u.userId}',this.checked)" ${u.keywords_enabled!==false?'checked':''}>
                                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600 shadow-inner"></div>
                                </label>
                                <span class="text-[9px] font-bold tracking-wide opacity-60">KW</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold border ${u.status==='follow'?'border-green-500/30 text-green-600 bg-green-500/10':'border-gray-500/30 text-gray-500'}">${u.status||'-'}</span></td>
                    <td class="p-4 text-center" onclick="event.stopPropagation()">
                        <button onclick="editUserProfile('${u.userId}')" class="text-blue-500 hover:bg-blue-100 p-2.5 rounded-xl mx-1 transition"><i class="fas fa-user-edit text-lg"></i></button>
                        <button onclick="deleteUserProfile('${u.userId}')" class="text-red-500 hover:bg-red-100 p-2.5 rounded-xl transition"><i class="fas fa-trash-alt text-lg"></i></button>
                    </td>
                </tr>`).join('');
        }

        async function loadChatUsers() {
            const { data } = await supabase.from('chat_history').select('user_id, message, created_at').order('created_at', {ascending: false});
            const userMap = {};
            data.forEach(c => { if(!userMap[c.user_id]) userMap[c.user_id] = {id: c.user_id, count:0, msg: c.message, time: c.created_at}; userMap[c.user_id].count++; });
            const list = Object.values(userMap);
            
            // Get Profiles for improved display
            const userIds = list.map(u => u.id);
            const { data: profiles } = await supabase.from('user_profiles').select('userId, displayName, pictureUrl').in('userId', userIds);

            document.getElementById('chatUsersTable').innerHTML = list.map(u => {
                const profile = profiles?.find(p => p.userId === u.id) || {};
                const displayName = profile.displayName || u.id.substring(0,10) + '...';
                const pictureUrl = profile.pictureUrl || 'https://via.placeholder.com/40';

                return `
                <tr class="hover:bg-gray-500/5 transition">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                             <img src="${pictureUrl}" class="w-10 h-10 rounded-full border border-gray-200/50 shadow-sm object-cover">
                             <div class="font-semibold text-gray-700 dark:text-gray-200">${displayName}</div>
                        </div>
                    </td>
                    <td class="p-4 text-center"><span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs font-bold">${u.count}</span></td>
                    <td class="p-4 text-sm opacity-70 truncate max-w-xs font-light">${u.msg}</td>
                    <td class="p-4 text-right text-xs opacity-50 font-mono">${dayjs(u.time).fromNow()}</td>
                    <td class="p-4 text-center"><button onclick="viewChatHistory('${u.id}')" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded-lg transition font-medium text-sm">‡∏î‡∏π‡πÅ‡∏ä‡∏ó <i class="fas fa-chevron-right ml-1"></i></button></td>
                </tr>`;
            }).join('');
        }

        // Helpers
        function resetKeywordForm(){ document.getElementById('keywordForm').reset(); editingKeywordId=null; }
        async function editKeyword(id){
            const {data} = await supabase.from('keywords').select('*').eq('id',id).single();
            if(data){
                ['keyword','reply_text','reply_flex','reply_image','reply_richmenu','reply_template','reply_postback','reply_prompt'].forEach(k => document.getElementById(k).value = data[k]||'');
                document.getElementById('require_vip').checked = data.require_vip;
                editingKeywordId=id; document.getElementById('keywordForm').scrollIntoView({behavior:'smooth'});
            }
        }
        async function deleteKeyword(id){ if(confirm('‡∏•‡∏ö?')){ await supabase.from('keywords').delete().eq('id',id); loadKeywords(); } }
        
        async function editDataAI(id){ const {data}=await supabase.from('dataai').select('*').eq('id',id).single(); if(data){ document.getElementById('content').value=data.content; editingDataAIId=id; document.getElementById('dataaiForm').scrollIntoView({behavior:'smooth'}); } }
        async function deleteDataAI(id){ if(confirm('‡∏•‡∏ö?')){ await supabase.from('dataai').delete().eq('id',id); loadDataAI(); } }
        function openKnowledgeModal(c){ document.getElementById('knowledgeDetailContent').innerHTML=c; document.getElementById('knowledgeBaseModal').classList.remove('hidden'); }

        async function editPermission(id){ 
            const {data} = await supabase.from('keyword_permissions').select('*').eq('id',id).single();
            if(data){ document.getElementById('permUserId').value=data.userId; document.getElementById('permKeyword').value=data.keyword; document.getElementById('permVip').checked=data.vip; editingPermissionId=id; document.getElementById('permissionForm').scrollIntoView({behavior:'smooth'}); }
        }
        async function deletePermission(id){ if(confirm('‡∏•‡∏ö?')){ await supabase.from('keyword_permissions').delete().eq('id',id); loadPermissions(); } }

        // Fix: Edit User Profile Function
        async function editUserProfile(userId) {
            const { data } = await supabase.from('user_profiles').select('*').eq('userId', userId).single();
            if (data) {
                document.getElementById('editProfileUserId').value = data.userId;
                document.getElementById('editDisplayName').value = data.displayName || '';
                document.getElementById('editEmail').value = data.email || '';
                document.getElementById('editPhone').value = data.phone || '';
                document.getElementById('editRole').value = data.role || 'user';
                document.getElementById('editAiEnabled').checked = data.ai_enabled;
                document.getElementById('editKeywordsEnabled').checked = data.keywords_enabled !== false;
                
                // Show Modal
                document.getElementById('addUserProfileModal').classList.remove('hidden');
            }
        }
        function openAddUserProfileModal(){ document.getElementById('userProfileForm').reset(); document.getElementById('editProfileUserId').readOnly=false; document.getElementById('addUserProfileModal').classList.remove('hidden'); }
        function closeAddUserProfileModal(){ document.getElementById('addUserProfileModal').classList.add('hidden'); }
        async function deleteUserProfile(id){ if(confirm('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å?')){ await supabase.from('user_profiles').delete().eq('userId',id); loadUserProfiles(); } }
        
        async function toggleUserAI(uid, v){ await supabase.from('user_profiles').update({ai_enabled:v}).eq('userId',uid); }
        async function toggleUserKeywords(uid, v){ await supabase.from('user_profiles').update({keywords_enabled:v}).eq('userId',uid); }
        async function toggleAllAI(v){ if(confirm(v?'‡πÄ‡∏õ‡∏¥‡∏î AI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?':'‡∏õ‡∏¥‡∏î AI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ await supabase.from('user_profiles').update({ai_enabled:v}).neq('userId','x'); loadUserProfiles(); } else document.getElementById('masterAIToggle').checked=!v; }
        async function toggleAllKeywords(v){ if(confirm(v?'‡πÄ‡∏õ‡∏¥‡∏î Keywords ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?':'‡∏õ‡∏¥‡∏î Keywords ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ await supabase.from('user_profiles').update({keywords_enabled:v}).neq('userId','x'); loadUserProfiles(); } else document.getElementById('masterKeywordToggle').checked=!v; }

        async function viewChatHistory(uid) {
            const m=document.getElementById('chatHistoryModal'); m.classList.remove('hidden');
            const c=document.getElementById('chatMessagesContainer'); c.innerHTML='<div class="text-center py-10 opacity-50">Loading...</div>';
            
            const {data:p} = await supabase.from('user_profiles').select('*').eq('userId',uid).single();
            document.getElementById('modalUserName').textContent = p?.displayName || 'Unknown';
            document.getElementById('modalUserAvatar').style.backgroundImage = `url('${p?.pictureUrl||''}')`;

            const {data:msgs} = await supabase.from('chat_history').select('*').eq('user_id',uid).order('created_at',{ascending:true});
            c.innerHTML = (msgs||[]).map(m => {
                const u = m.role==='user';
                return `<div class="flex ${u?'justify-end':'justify-start'} mb-4 fade-in">
                    ${!u ? `<div class="w-8 h-8 rounded-full mr-3 bg-indigo-500 text-white flex items-center justify-center text-xs shadow-md border-2 border-white"><i class="fas fa-robot"></i></div>` : ''}
                    <div class="chat-bubble ${u?'chat-user':'chat-bot'}">
                        ${m.message}
                        <div class="text-[10px] opacity-70 text-right mt-1 font-mono">${dayjs(m.created_at).format('HH:mm')}</div>
                    </div>
                    ${u ? `<div class="w-8 h-8 rounded-full ml-3 bg-gray-300 bg-cover border-2 border-white shadow-md" style="background-image:url('${p?.pictureUrl}')"></div>` : ''}
                </div>`;
            }).join('');
            c.scrollTop = c.scrollHeight;
        }
        function closeChatHistoryModal(){ document.getElementById('chatHistoryModal').classList.add('hidden'); }
        async function showProfileCard(uid){
            const {data:u} = await supabase.from('user_profiles').select('*').eq('userId',uid).single();
            if(!u) return;
            const c = document.getElementById('profileCardContainer');
            document.getElementById('profileCardContent').innerHTML = `
                <div class="flex items-center gap-6">
                    <img src="${u.pictureUrl}" class="w-24 h-24 rounded-full border-4 border-indigo-500/20 shadow-xl object-cover">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-1">${u.displayName}</h3>
                        <p class="text-xs font-mono opacity-60 bg-black/5 dark:bg-white/10 px-2 py-0.5 rounded inline-block mb-3 border border-black/5">${u.userId}</p>
                        <div class="text-sm opacity-80 grid grid-cols-2 gap-x-6 gap-y-1">
                            <span><i class="fas fa-envelope w-5 text-center opacity-50"></i> ${u.email||'-'}</span> 
                            <span><i class="fas fa-phone w-5 text-center opacity-50"></i> ${u.phone||'-'}</span>
                            <span><i class="fas fa-user-tag w-5 text-center opacity-50"></i> ${u.role||'user'}</span> 
                            <span><i class="fas fa-robot w-5 text-center opacity-50"></i> AI: <span class="${u.ai_enabled?'text-green-500 font-bold':'text-red-500 font-bold'}">${u.ai_enabled?'ON':'OFF'}</span></span>
                        </div>
                    </div>
                </div>`;
            c.classList.remove('hidden');
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs(); setupForms(); loadKeywords();
            
            // Check Local Storage Theme
            if(localStorage.getItem('theme') === 'dark') toggleTheme();
        });
        
        // Save Theme Preference
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
</body>
</html>
