<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keywords Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Rich Menu Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Prompt', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
        .glass-effect { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .input-focus:focus { 
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-hover:hover { transform: translateY(-2px); }
        .tab-active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: #ffffff !important;
            border-bottom: 3px solid #f59e0b;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .tab-inactive {
            background: rgba(30, 41, 59, 0.7);
            color: rgba(255, 255, 255, 0.8);
        }
        .tab-inactive:hover {
            background: rgba(30, 41, 59, 0.9);
            color: #fff;
        }
        
        /* Styles for Rich Menu Manager */
        .rich-menu-wrapper {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            color: #F0F0F0;
        }
        .glass-dark {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-warning { background: linear-gradient(135deg, #eab308, #ca8a04); color: #1e293b; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: scale(1); }
        .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.9); opacity: 0; }
        
        .default-menu-card {
            border: 2px solid #fbbf24;
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.1), rgba(0, 0, 0, 0.2));
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
        }
        
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: none; z-index: 9999; }

        @media (max-width: 768px) {
            .mobile-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .mobile-hidden { display: none; }
            .tab-mobile { font-size: 0.75rem; padding: 0.75rem 0.5rem; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8">
    <div class="container mx-auto px-2 sm:px-4 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-2">
                <i class="fas fa-database mr-2 sm:mr-3"></i>Keywords Management System
            </h1>
            <p class="text-white/80 text-sm sm:text-base lg:text-lg">ระบบจัดการข้อมูลหลังบ้านและ AI Assistant</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="glass-effect rounded-xl sm:rounded-2xl shadow-2xl mb-6 sm:mb-8">
            <div class="flex overflow-x-auto mobile-scroll">
                <button id="keywordsTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold rounded-tl-xl sm:rounded-tl-2xl tab-active transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile">
                    <i class="fas fa-key mr-1 sm:mr-2"></i><span class="hidden sm:inline">Keywords</span>
                </button>
                <button id="permissionsTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold tab-inactive transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile">
                    <i class="fas fa-shield-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Permissions</span>
                </button>
                <button id="richMenuTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold tab-inactive transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile text-yellow-300">
                    <i class="fas fa-th-large mr-1 sm:mr-2"></i><span class="hidden sm:inline">Rich Menu</span>
                </button>
                <button id="dataaiTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold tab-inactive transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile">
                    <i class="fas fa-database mr-1 sm:mr-2"></i><span class="hidden sm:inline">Knowledge Base</span>
                </button>
                <button id="userProfilesTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold tab-inactive transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile">
                    <i class="fas fa-users mr-1 sm:mr-2"></i><span class="hidden sm:inline">Users</span>
                </button>
                <button id="chatHistoryTab" class="flex-1 min-w-max py-3 px-3 sm:py-4 sm:px-6 font-semibold rounded-tr-xl sm:rounded-tr-2xl tab-inactive transition-all duration-300 hover:shadow-lg text-xs sm:text-sm tab-mobile">
                    <i class="fas fa-comments mr-1 sm:mr-2"></i><span class="hidden sm:inline">Chat History</span>
                </button>
            </div>
        </div>

        <!-- 1. Keywords Page -->
        <div id="keywordsPage">
            <div class="glass-effect rounded-xl sm:rounded-2xl shadow-2xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8">
                <form id="keywordForm" class="space-y-4 sm:space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                        <div class="lg:col-span-2">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-key text-blue-500 mr-2"></i>Keyword</label>
                            <input type="text" id="keyword" name="keyword" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="คำที่ลูกค้าพิมพ์มา" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-comment text-green-500 mr-2"></i>Reply Text</label>
                            <textarea id="reply_text" name="reply_text" rows="3" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="ข้อความตอบกลับ"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-code text-purple-500 mr-2"></i>Reply Flex</label>
                            <textarea id="reply_flex" name="reply_flex" rows="3" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="JSON Flex Message"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-image text-pink-500 mr-2"></i>Reply Image</label>
                            <input type="url" id="reply_image" name="reply_image" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="URL รูปภาพ">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-template text-orange-500 mr-2"></i>Reply Template</label>
                            <input type="text" id="reply_template" name="reply_template" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="JSON Template">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-bars text-indigo-500 mr-2"></i>Reply Rich Menu</label>
                            <input type="text" id="reply_richmenu" name="reply_richmenu" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="Rich Menu ID">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-reply text-teal-500 mr-2"></i>Reply Postback</label>
                            <input type="text" id="reply_postback" name="reply_postback" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="Postback Data">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Reply Prompt (AI)</label>
                            <textarea id="reply_prompt" name="reply_prompt" rows="2" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 input-focus text-sm sm:text-base" placeholder="Prompt สำหรับให้ AI สร้างคำตอบ"></textarea>
                        </div>
                        <div class="lg:col-span-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="require_vip" name="require_vip" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                                <span class="text-gray-700 font-semibold text-sm sm:text-base"><i class="fas fa-crown text-yellow-500 mr-2"></i>Require VIP (เฉพาะสมาชิก VIP)</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-3 pt-4 sm:pt-6">
                        <button type="button" onclick="resetKeywordForm()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all shadow-lg w-full sm:w-auto"><i class="fas fa-times mr-2"></i>ล้างฟอร์ม</button>
                        <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all w-full sm:w-auto"><i class="fas fa-save mr-2"></i>บันทึก Keyword</button>
                    </div>
                </form>
            </div>

            <!-- List -->
            <div class="glass-effect rounded-xl sm:rounded-2xl shadow-2xl p-4 sm:p-6 lg:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center"><i class="fas fa-list text-blue-500 mr-2 sm:mr-3"></i>รายการ Keywords</h2>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <button onclick="filterKeywords('all')" class="filter-btn filter-active px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all shadow-sm">ทั้งหมด</button>
                        <button onclick="filterKeywords('text')" class="filter-btn filter-inactive px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all shadow-sm">Text</button>
                        <button onclick="filterKeywords('flex')" class="filter-btn filter-inactive px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all shadow-sm">Flex</button>
                        <button onclick="filterKeywords('prompt')" class="filter-btn filter-inactive px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all shadow-sm">AI Prompt</button>
                    </div>
                </div>
                <div class="overflow-x-auto mobile-scroll">
                    <table class="w-full min-w-max">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 text-sm">Keyword</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 text-sm">Type</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 text-sm mobile-hidden">Content Preview</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 text-sm">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Permissions Page -->
        <div id="permissionsPage" class="hidden">
            <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8">
                <form id="permissionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-gray-700 font-semibold mb-2">User ID</label><input type="text" id="permUserId" name="userId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-focus" placeholder="Uxxxxxxxx..." required></div>
                        <div><label class="block text-gray-700 font-semibold mb-2">Keyword</label><input type="text" id="permKeyword" name="keyword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-focus" placeholder="เช่น 'admin'" required></div>
                        <div class="md:col-span-2"><label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" id="permVip" name="vip" class="w-5 h-5 text-green-600 rounded"><span class="text-gray-800 font-semibold">Grant VIP Status</span></label></div>
                    </div>
                    <div class="flex justify-center gap-3 pt-6">
                        <button type="submit" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-8 py-3 rounded-lg font-semibold shadow-lg">บันทึกสิทธิ์</button>
                    </div>
                </form>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">รายการสิทธิ์ทั้งหมด</h2>
                <div class="overflow-x-auto"><table class="w-full"><tbody id="permissionsList"></tbody></table></div>
            </div>
        </div>

        <!-- 3. Rich Menu Manager Page -->
        <div id="richMenuPage" class="hidden">
            <div class="rich-menu-wrapper rounded-3xl p-6 shadow-2xl border border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                    <div class="text-center md:text-left">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 via-blue-400 to-cyan-300 drop-shadow-sm">Rich Menu API Manager</h2>
                        <p class="text-blue-300/70 mt-1 font-light">จัดการเมนู LINE Official Account</p>
                    </div>
                    <div class="flex gap-3 flex-wrap justify-center">
                        <button onclick="showTaskManager()" class="bg-purple-600/20 hover:bg-purple-600/30 border border-purple-500/30 text-purple-200 px-5 py-2.5 rounded-xl font-medium backdrop-blur transition flex items-center gap-2"><i class="fas fa-clock"></i> ตารางงาน</button>
                        <button id="reloadRichMenuBtn" class="bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-2.5 rounded-xl font-medium backdrop-blur transition flex items-center gap-2"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
                        <button id="cancelDefaultBtn" class="btn-danger text-white px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center gap-2"><i class="fas fa-ban"></i> ล้างเมนูหลัก</button>
                    </div>
                </div>
                <main id="richmenu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="col-span-full text-center text-gray-400 py-10">กำลังโหลดข้อมูล...</div>
                </main>
            </div>
        </div>

        <!-- 4. DataAI Page -->
        <div id="dataaiPage" class="hidden">
            <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8">
                <form id="dataaiForm" class="space-y-6">
                    <div><label class="block text-gray-700 font-semibold mb-2">เนื้อหาความรู้</label><textarea id="content" name="content" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 input-focus" placeholder="ข้อมูลสำหรับสอน AI" required></textarea></div>
                    <div class="flex justify-end gap-3"><button type="submit" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-6 py-2 rounded-lg font-semibold shadow">เพิ่มข้อมูล</button></div>
                </form>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">รายการความรู้</h2>
                <div class="overflow-x-auto"><table class="w-full"><tbody id="dataaiList"></tbody></table></div>
            </div>
        </div>

        <!-- 5. User Profiles Page -->
        <div id="userProfilesPage" class="hidden">
            <div class="mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-white"><i class="fas fa-users mr-2"></i>จัดการสมาชิก</h2>
                    <button onclick="openAddUserProfileModal()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold shadow"><i class="fas fa-plus mr-2"></i>เพิ่มสมาชิก</button>
                </div>
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 border border-white/20 text-white flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-robot text-2xl"></i></div>
                        <div><h3 class="text-lg font-bold">ควบคุม AI ทั้งระบบ</h3><p class="text-white/80 text-sm">เปิด/ปิด AI สำหรับทุกคน</p></div>
                    </div>
                    <div class="flex items-center space-x-3 bg-black/20 px-4 py-2 rounded-full">
                        <span class="text-sm font-medium">ปิดทั้งหมด</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="masterAIToggle" onchange="toggleAllAI(this.checked)" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-400 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-400"></div>
                        </label>
                        <span class="text-sm font-medium">เปิดทั้งหมด</span>
                    </div>
                </div>
            </div>
            <div id="profileCardContainer" class="hidden mb-6"><div class="glass-effect rounded-2xl shadow-xl p-6 relative"><button onclick="document.getElementById('profileCardContainer').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><div id="profileCardContent"></div></div></div>
            <div class="glass-effect rounded-2xl shadow-2xl p-6"><div class="overflow-x-auto"><table class="w-full"><tbody id="userProfilesTable"></tbody></table></div></div>
        </div>

        <!-- 6. Chat History Page -->
        <div id="chatHistoryPage" class="hidden">
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-white"><i class="fas fa-comments mr-2"></i>ประวัติการสนทนา</h2>
                <div class="flex w-full sm:w-auto gap-2">
                    <input type="text" id="searchUserId" placeholder="ค้นหา..." class="px-4 py-2 rounded-lg border-0 w-full">
                    <button onclick="searchChatHistory()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-6"><div class="overflow-x-auto"><table class="w-full"><tbody id="chatUsersTable"></tbody></table></div></div>
        </div>

        <!-- MODALS (Rich Menu Manager) -->
        <div id="authModal" class="hidden fixed inset-0 z-[9500] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideAuthModal(false)"></div>
            <div class="bg-[#1e293b] border border-red-500/30 rounded-2xl shadow-2xl max-w-xs w-full p-6 modal-card z-10 relative text-center">
                <h3 class="text-xl font-bold text-white mb-2">Admin Access</h3>
                <p class="text-gray-400 text-sm mb-4">กรุณากรอกรหัสผ่านเพื่อดำเนินการ</p>
                <input type="password" id="auth-input" class="w-full bg-black/40 border border-gray-600 rounded-lg px-4 py-2 text-white text-center mb-4 tracking-widest text-lg">
                <div class="flex gap-2"><button onclick="hideAuthModal(false)" class="flex-1 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 text-sm font-medium">ยกเลิก</button><button onclick="submitAuth()" class="flex-1 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 font-bold text-sm">ยืนยัน</button></div>
            </div>
        </div>

        <div id="scheduleModal" class="hidden fixed inset-0 z-[9200] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideScheduleModal()"></div>
            <div class="bg-[#1e293b] rounded-2xl shadow-2xl max-w-lg w-full p-6 z-10 modal-card border border-white/10 relative text-white">
                <h3 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-clock text-purple-400"></i> <span id="schedule-title-text">ตั้งเวลา</span></h3>
                <div class="space-y-4">
                    <div class="p-3 bg-white/5 rounded-lg border border-white/5"><p class="text-sm text-gray-400">Menu:</p><p id="schedule-menu-name" class="font-bold text-blue-300 truncate">Menu Name</p><p class="text-sm text-gray-400 mt-2">Target:</p><p id="schedule-target-info" class="font-bold text-green-300">Selected Users</p></div>
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Action</label><select id="schedule-action" class="w-full bg-black/30 border border-gray-600 rounded-xl px-4 py-3 text-white"><option value="link">ติดตั้งเมนู (Link)</option><option value="unlink">ยกเลิกเมนู (Unlink)</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Time</label><input type="datetime-local" id="schedule-time" class="w-full bg-black/30 border border-gray-600 rounded-xl px-4 py-3 text-white"></div>
                </div>
                <div class="flex justify-end pt-6 gap-3"><button onclick="hideScheduleModal()" class="px-5 py-2.5 bg-gray-700 rounded-xl">ยกเลิก</button><button id="schedule-save-btn" class="btn-purple px-6 py-2.5 font-bold rounded-xl">บันทึก</button></div>
            </div>
        </div>

        <div id="userSearchModal" class="hidden fixed inset-0 z-[9100] flex items-center justify-center p-4 modal-leave-to"><div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="hideUserSearchModal(null)"></div><div class="bg-[#1e293b] rounded-2xl shadow-2xl max-w-xl w-full p-6 z-10 modal-card border border-white/10 flex flex-col max-h-[85vh] text-white"><div class="flex justify-between items-center mb-4"><h3 id="search-modal-title" class="text-xl font-bold">เลือกผู้ใช้</h3><button onclick="hideUserSearchModal(null)" class="text-gray-400"><i class="fas fa-times"></i></button></div><div class="flex flex-col gap-3"><input id="modal-user-search" class="block w-full px-4 py-3 border border-gray-600 rounded-xl bg-black/20 text-white placeholder-gray-400" placeholder="ค้นหาชื่อ หรือ ID..."><div class="flex gap-2"><button id="modal-user-search-btn" class="flex-1 btn-primary py-2.5 rounded-xl font-semibold text-sm">ค้นหา</button><button id="modal-user-all-btn" class="flex-1 bg-gray-700 text-white py-2.5 rounded-xl font-semibold text-sm">โหลดทั้งหมด</button></div><div id="modal-user-select-all-container" class="hidden"><button id="modal-user-select-all-btn" class="btn-success w-full py-2 rounded-xl font-bold text-sm text-white">เลือกทั้งหมด</button></div></div><div id="modal-user-results" class="mt-4 flex-1 overflow-y-auto border border-white/5 rounded-xl bg-black/20 min-h-[250px] p-2 custom-scrollbar"></div><div class="flex justify-end pt-4 mt-2 gap-3 border-t border-white/10"><button id="search-cancel-btn" class="px-6 py-2.5 bg-transparent border border-gray-600 rounded-xl">ปิด</button><button id="search-ok-btn" class="btn-primary px-8 py-2.5 rounded-xl font-bold" disabled>ยืนยัน (0)</button></div></div></div>

        <div id="taskManagerModal" class="hidden fixed inset-0 z-[9300] flex items-center justify-center p-4 modal-leave-to"><div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideTaskManager()"></div><div class="bg-[#1e293b] rounded-2xl shadow-2xl max-w-4xl w-full p-6 z-10 modal-card border border-white/10 flex flex-col max-h-[90vh] text-white"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">จัดการตารางงาน</h3><button onclick="hideTaskManager()" class="text-gray-400"><i class="fas fa-times"></i></button></div><div class="flex justify-between items-center gap-3 mb-4"><div class="flex p-1 bg-black/30 rounded-xl border border-white/5"><button onclick="switchScheduleTab('pending')" id="tab-pending" class="px-6 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">รอทำงาน</button><button onclick="switchScheduleTab('completed')" id="tab-completed" class="px-6 py-2 rounded-lg text-sm font-medium text-gray-400">เสร็จแล้ว</button></div><div class="flex gap-2"><button onclick="loadSchedules()" class="px-4 py-2 bg-white/5 rounded-lg text-sm">รีเฟรช</button></div></div><div id="schedule-list" class="flex-1 overflow-y-auto bg-black/20 rounded-xl border border-white/5 p-2 space-y-2 min-h-[300px]"></div></div></div>

        <div id="loading-overlay" class="flex flex-col items-center justify-center gap-4"><div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div><p id="loading-text" class="text-xl font-medium text-blue-100 tracking-wide animate-pulse">Loading...</p></div>
        <div id="toast-container" class="fixed top-4 right-4 z-[9900] space-y-2 pointer-events-none"></div>
        <div id="lightbox-modal" class="fixed inset-0 z-[10000] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl" onclick="closeLightbox()"><img id="lightbox-image" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl" onclick="event.stopPropagation()"><button class="absolute top-4 right-4 text-white" onclick="closeLightbox()"><i class="fas fa-times fa-2x"></i></button></div>

        <!-- Add/Edit User Modal (General) -->
        <div id="addUserProfileModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="glass-effect bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
                <button onclick="closeAddUserProfileModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
                <h3 class="text-2xl font-bold text-gray-800 mb-6">จัดการข้อมูลสมาชิก</h3>
                <form id="userProfileForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="label-text">User ID</label><input type="text" id="profileUserId" name="userId" class="input-field w-full border p-2 rounded" required></div>
                        <div><label class="label-text">Display Name</label><input type="text" id="displayName" name="displayName" class="input-field w-full border p-2 rounded"></div>
                        <div><label class="label-text">Email</label><input type="email" id="email" name="email" class="input-field w-full border p-2 rounded"></div>
                        <div><label class="label-text">Phone</label><input type="tel" id="phone" name="phone" class="input-field w-full border p-2 rounded"></div>
                        <div><label class="label-text">Role</label><select id="role" name="role" class="input-field w-full border p-2 rounded"><option value="user">User</option><option value="admin">Admin</option><option value="vip">VIP</option></select></div>
                        <div class="flex flex-col pt-6 gap-2">
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="aiEnabled" name="ai_enabled" class="w-5 h-5 text-indigo-600 rounded"><span class="font-semibold text-gray-700">AI Assistant</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="keywordsEnabled" name="keywords_enabled" class="w-5 h-5 text-pink-600 rounded"><span class="font-semibold text-gray-700">Keywords Reply</span></label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeAddUserProfileModal()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg">ยกเลิก</button><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow">บันทึก</button></div>
                </form>
            </div>
        </div>
        
        <!-- Chat History Modal -->
        <div id="chatHistoryModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-2">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <div class="flex items-center gap-3"><div id="modalUserAvatar" class="w-10 h-10 rounded-full bg-gray-300 bg-cover bg-center"></div><div><h3 id="modalUserName" class="font-bold text-gray-800 text-lg">Chat History</h3><p id="modalUserId" class="text-xs text-gray-500"></p></div></div>
                    <button onclick="closeChatHistoryModal()" class="text-gray-400 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
                </div>
                <div id="chatMessagesContainer" class="flex-1 overflow-y-auto p-4 bg-gray-100 flex flex-col gap-2"></div>
                <div class="p-4 border-t bg-white rounded-b-2xl"><div class="grid grid-cols-3 gap-4 text-center"><div class="bg-blue-50 p-2 rounded-lg"><span class="block text-xs text-blue-500 font-bold">TOTAL</span><span id="totalMessages" class="text-lg font-bold text-blue-700">0</span></div><div class="bg-green-50 p-2 rounded-lg"><span class="block text-xs text-green-500 font-bold">USER</span><span id="userMessages" class="text-lg font-bold text-green-700">0</span></div><div class="bg-purple-50 p-2 rounded-lg"><span class="block text-xs text-purple-500 font-bold">AI BOT</span><span id="botMessages" class="text-lg font-bold text-purple-700">0</span></div></div></div>
            </div>
        </div>

    </div>

    <!-- Initialization Script -->
    <script>
        // 1. CONFIGURATION (Global)
        var supabaseUrl = 'https://kiumelolsilduqnvrekf.supabase.co';
        var supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // --- Shared State Variables ---
        var allKeywords = [];
        var allChatUsers = [];
        var editingKeywordId = null;
        var editingPermissionId = null;
        var editingDataAIId = null;
        var editingUserProfileId = null;
        
        // --- Rich Menu State ---
        const ADMIN_PASSWORD = "1234";
        let richMenuDataCache = new Map();
        let currentDefaultMenuId = null;
        let resolveAuth = null;
        let resolveUserSearch = null;
        let selectedUsers = new Set();
        let currentScheduleData = null;
        let currentScheduleTab = 'pending';

        // Initialize Day.js
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th');

        // --- 2. CORE FUNCTIONS (Declared First to fix ReferenceError) ---

        // >>> FIX: Declare setupTabs before DOMContentLoaded <<<
        function setupTabs() {
            const tabs = ['keywords', 'permissions', 'richMenu', 'dataai', 'userProfiles', 'chatHistory'];
            tabs.forEach(tab => {
                const tabEl = document.getElementById(`${tab}Tab`);
                if (tabEl) {
                    tabEl.addEventListener('click', () => {
                        tabs.forEach(t => {
                            const p = document.getElementById(`${t}Page`);
                            if(p) p.classList.add('hidden');
                            const btn = document.getElementById(`${t}Tab`);
                            if(btn) { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
                        });
                        
                        const page = document.getElementById(`${tab}Page`);
                        if(page) page.classList.remove('hidden');
                        
                        tabEl.classList.add('tab-active');
                        tabEl.classList.remove('tab-inactive');

                        if(tab === 'keywords') loadKeywords();
                        if(tab === 'permissions') loadPermissions();
                        if(tab === 'dataai') loadDataAI();
                        if(tab === 'userProfiles') loadUserProfiles();
                        if(tab === 'chatHistory') loadChatUsers();
                        if(tab === 'richMenu') loadRichMenus(); // Load Rich Menu Data
                    });
                }
            });
        }

        function setupForms() {
            // Keyword Form
            document.getElementById('keywordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    keyword: formData.get('keyword'),
                    reply_text: formData.get('reply_text'),
                    reply_flex: formData.get('reply_flex'),
                    reply_image: formData.get('reply_image'),
                    reply_template: formData.get('reply_template'),
                    reply_richmenu: formData.get('reply_richmenu'),
                    reply_postback: formData.get('reply_postback'),
                    reply_prompt: formData.get('reply_prompt'),
                    require_vip: formData.get('require_vip') === 'on'
                };
                
                try {
                    if(editingKeywordId) {
                        await supabase.from('keywords').update(data).eq('id', editingKeywordId);
                        Swal.fire('Updated', 'แก้ไขข้อมูลเรียบร้อย', 'success');
                    } else {
                        await supabase.from('keywords').insert([data]);
                        Swal.fire('Saved', 'บันทึกข้อมูลเรียบร้อย', 'success');
                    }
                    resetKeywordForm();
                    loadKeywords();
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            });

            // Permission Form
            document.getElementById('permissionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    userId: document.getElementById('permUserId').value,
                    keyword: document.getElementById('permKeyword').value,
                    vip: document.getElementById('permVip').checked
                };
                try {
                    if(editingPermissionId) await supabase.from('keyword_permissions').update(data).eq('id', editingPermissionId);
                    else await supabase.from('keyword_permissions').insert([data]);
                    Swal.fire('Success', 'บันทึกสิทธิ์เรียบร้อย', 'success');
                    document.getElementById('permissionForm').reset();
                    editingPermissionId = null;
                    loadPermissions();
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            });

            // DataAI Form
            document.getElementById('dataaiForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = document.getElementById('content').value;
                try {
                    if(editingDataAIId) await supabase.from('dataai').update({content}).eq('id', editingDataAIId);
                    else await supabase.from('dataai').insert([{content}]);
                    Swal.fire('Success', 'บันทึกความรู้เรียบร้อย', 'success');
                    document.getElementById('dataaiForm').reset();
                    editingDataAIId = null;
                    loadDataAI();
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            });

            // User Profile Form
            document.getElementById('userProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('profileUserId').value;
                const data = {
                    userId: userId,
                    displayName: document.getElementById('displayName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    role: document.getElementById('role').value,
                    ai_enabled: document.getElementById('aiEnabled').checked,
                    keywords_enabled: document.getElementById('keywordsEnabled').checked
                };
                
                try {
                    const { error } = await supabase.from('user_profiles').upsert(data, { onConflict: 'userId' });
                    if(error) throw error;
                    Swal.fire('Success', 'บันทึกข้อมูลสมาชิกเรียบร้อย', 'success');
                    closeAddUserProfileModal();
                    loadUserProfiles();
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            });
        }

        async function loadKeywords() {
            const { data, error } = await supabase.from('keywords').select('*').order('created_at', {ascending: false});
            if(error) return console.error(error);
            allKeywords = data;
            renderKeywords(data);
        }

        function renderKeywords(list) {
            const tbody = document.getElementById('recordsList');
            tbody.innerHTML = list.map(item => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-medium text-blue-700">${item.keyword}</td>
                    <td class="py-3 px-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${getKeywordType(item)}</span></td>
                    <td class="py-3 px-4 text-gray-500 text-sm truncate max-w-xs mobile-hidden">${getKeywordContent(item)}</td>
                    <td class="py-3 px-4">${item.require_vip ? '<span class="text-yellow-600 text-xs font-bold"><i class="fas fa-crown"></i> VIP</span>' : '<span class="text-green-600 text-xs">Public</span>'}</td>
                    <td class="py-3 px-4 flex gap-2">
                        <button onclick="editKeyword(${item.id})" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteKeyword(${item.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function getKeywordType(item) {
            if(item.reply_prompt) return 'AI Prompt';
            if(item.reply_flex) return 'Flex Msg';
            if(item.reply_image) return 'Image';
            if(item.reply_richmenu) return 'Rich Menu';
            if(item.reply_postback) return 'Postback';
            if(item.reply_template) return 'Template';
            return 'Text';
        }
        function getKeywordContent(item) {
            return item.reply_prompt || item.reply_text || item.reply_image || item.reply_richmenu || item.reply_postback || '(Complex Content)';
        }

        async function loadPermissions() {
            const { data: perms } = await supabase.from('keyword_permissions').select('*').order('created_at', {ascending: false});
            // Get User Profiles to match images
            const userIds = perms.map(p => p.userId);
            let profiles = [];
            if(userIds.length > 0) {
                const { data: p } = await supabase.from('user_profiles').select('userId, pictureUrl, displayName').in('userId', userIds);
                profiles = p || [];
            }

            document.getElementById('permissionsList').innerHTML = perms.map(p => {
                const profile = profiles.find(u => u.userId === p.userId) || {};
                const name = profile.displayName || p.userId.substring(0,6)+'...';
                return `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4">
                        <div class="flex items-center gap-3">
                            <div><div class="font-bold text-sm text-gray-800">${name}</div><div class="text-xs text-gray-500 font-mono">${p.userId.substring(0,8)}...</div></div>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-sm font-bold text-blue-600 bg-blue-50 rounded-lg text-center">${p.keyword}</td>
                    <td class="py-3 px-4 text-center">${p.vip ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold"><i class="fas fa-crown"></i> VIP</span>' : '<span class="text-gray-400 text-xs">Regular</span>'}</td>
                    <td class="py-3 px-4 text-center">
                         <button onclick="editPermission(${p.id})" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePermission(${p.id})" class="text-red-500 hover:text-red-700 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function loadDataAI() {
            const { data } = await supabase.from('dataai').select('*').order('created_at', {ascending: false});
            document.getElementById('dataaiList').innerHTML = data.map((d, index) => {
                const date = new Date(d.created_at).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                const shortContent = d.content.length > 60 ? d.content.substring(0, 60) + '...' : d.content;
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 text-center text-gray-400 font-mono">${index + 1}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 relative group">${shortContent}</td>
                    <td class="py-3 px-4 text-center text-xs text-gray-500">${date}</td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="editDataAI(${d.id})" class="text-blue-500 mr-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteDataAI(${d.id})" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function loadUserProfiles() {
            // 1. Fetch Profiles
            const { data: profiles } = await supabase.from('user_profiles').select('*');
            // 2. Fetch latest chat time for sorting (fetch simplified)
            const { data: chats } = await supabase.from('chat_history').select('user_id, created_at').order('created_at', {ascending: false});
            // 3. Create map of latest interaction
            const lastActiveMap = {};
            if (chats) {
                chats.forEach(c => {
                    if (!lastActiveMap[c.user_id]) {
                        lastActiveMap[c.user_id] = new Date(c.created_at).getTime();
                    }
                });
            }
            // 4. Merge and Sort
            profiles.forEach(p => {
                const chatTime = lastActiveMap[p.userId] || 0;
                const updateTime = new Date(p.updated_at || 0).getTime();
                p._sortTime = Math.max(chatTime, updateTime);
                if (typeof p.keywords_enabled === 'undefined') p.keywords_enabled = true;
            });
            profiles.sort((a, b) => b._sortTime - a._sortTime);
            
            // Update Master Toggle
            const toggle = document.getElementById('masterAIToggle');
            if (toggle && profiles.length > 0) {
                const allEnabled = profiles.every(u => u.ai_enabled);
                toggle.checked = allEnabled;
            }

            document.getElementById('userProfilesTable').innerHTML = profiles.map(u => {
                const statusClass = u.status === 'follow' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                const statusIcon = u.status === 'follow' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-user-slash"></i>';
                return `
                <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="showProfileCard('${u.userId}')">
                    <td class="py-3 px-4">
                        <div class="flex items-center gap-3">
                            <img src="${u.pictureUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover border border-gray-300">
                            <div><div class="font-bold text-gray-800">${u.displayName || 'Unknown'}</div><div class="text-xs text-gray-500 font-mono">${u.userId.substring(0, 10)}...</div></div>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center" onclick="event.stopPropagation()">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleUserAI('${u.userId}', this.checked)" ${u.ai_enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </td>
                     <td class="py-3 px-4 text-center" onclick="event.stopPropagation()">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleUserKeywords('${u.userId}', this.checked)" ${u.keywords_enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                        </label>
                    </td>
                    <td class="py-3 px-4 text-center"><span class="${statusClass} px-2 py-1 rounded-full text-xs font-medium">${statusIcon} ${u.status || 'unknown'}</span></td>
                    <td class="py-3 px-4 text-sm font-medium text-gray-600">${u.role || 'user'}</td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="event.stopPropagation(); editUserProfile('${u.userId}')" class="text-blue-600 hover:text-blue-800 p-1 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="event.stopPropagation(); deleteUserProfile('${u.userId}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function loadChatUsers() {
            const tbody = document.getElementById('chatUsersTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i></td></tr>';
            const { data, error } = await supabase.from('chat_history').select('user_id, message, created_at, role').order('created_at', {ascending: false});
            if(error) return console.error(error);
            const userMap = {};
            data.forEach(chat => {
                if(!userMap[chat.user_id]) {
                    userMap[chat.user_id] = { userId: chat.user_id, count: 0, lastMsg: chat.message, lastTime: chat.created_at };
                }
                userMap[chat.user_id].count++;
            });
            allChatUsers = Object.values(userMap);
            const userIds = allChatUsers.map(u => u.userId);
            let profiles = [];
            if (userIds.length > 0) {
                const { data: p } = await supabase.from('user_profiles').select('userId, displayName, pictureUrl').in('userId', userIds);
                profiles = p || [];
            }
            renderChatUsers(allChatUsers, profiles);
        }

        // --- Helper Functions ---
        function resetKeywordForm() { document.getElementById('keywordForm').reset(); editingKeywordId = null; }
        function resetDataAIForm() { document.getElementById('dataaiForm').reset(); editingDataAIId = null; }
        function openAddUserProfileModal() { document.getElementById('userProfileForm').reset(); document.getElementById('profileUserId').readOnly = false; document.getElementById('addUserProfileModal').classList.remove('hidden'); }
        function closeAddUserProfileModal() { document.getElementById('addUserProfileModal').classList.add('hidden'); }
        function filterKeywords(type) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(b => { b.classList.remove('filter-active'); b.classList.add('filter-inactive'); });
            // event might be undefined if called directly
            if(event && event.target) { event.target.classList.add('filter-active'); event.target.classList.remove('filter-inactive'); }
            
            if(type === 'all') return renderKeywords(allKeywords);
            const filtered = allKeywords.filter(k => {
                if(type === 'text') return k.reply_text && !k.reply_flex;
                if(type === 'flex') return k.reply_flex;
                if(type === 'prompt') return k.reply_prompt;
                return true;
            });
            renderKeywords(filtered);
        }
        
        // --- Edit/Delete/Toggle Functions ---
        async function editKeyword(id) {
            const { data } = await supabase.from('keywords').select('*').eq('id', id).single();
            if(!data) return;
            editingKeywordId = id;
            document.getElementById('keyword').value = data.keyword;
            document.getElementById('reply_text').value = data.reply_text || '';
            document.getElementById('reply_flex').value = data.reply_flex || '';
            document.getElementById('reply_image').value = data.reply_image || '';
            document.getElementById('reply_template').value = data.reply_template || '';
            document.getElementById('reply_richmenu').value = data.reply_richmenu || '';
            document.getElementById('reply_postback').value = data.reply_postback || '';
            document.getElementById('reply_prompt').value = data.reply_prompt || '';
            document.getElementById('require_vip').checked = data.require_vip;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        async function editDataAI(id) {
            const { data } = await supabase.from('dataai').select('*').eq('id', id).single();
            editingDataAIId = id;
            document.getElementById('content').value = data.content;
            document.getElementById('dataaiForm').scrollIntoView({ behavior: 'smooth' });
        }
        async function editPermission(id) {
            const { data } = await supabase.from('keyword_permissions').select('*').eq('id', id).single();
            if(!data) return;
            editingPermissionId = id;
            document.getElementById('permUserId').value = data.userId;
            document.getElementById('permKeyword').value = data.keyword;
            document.getElementById('permVip').checked = data.vip;
            document.getElementById('permissionForm').scrollIntoView({ behavior: 'smooth' });
        }
        async function editUserProfile(userId) {
            const { data } = await supabase.from('user_profiles').select('*').eq('userId', userId).single();
            if(data) {
                document.getElementById('profileUserId').value = data.userId;
                document.getElementById('profileUserId').readOnly = true; 
                document.getElementById('displayName').value = data.displayName || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('phone').value = data.phone || '';
                document.getElementById('role').value = data.role || 'user';
                document.getElementById('aiEnabled').checked = data.ai_enabled;
                document.getElementById('keywordsEnabled').checked = data.keywords_enabled !== false;
                document.getElementById('addUserProfileModal').classList.remove('hidden');
            }
        }
        async function deleteKeyword(id) { if(confirm('Delete?')) { await supabase.from('keywords').delete().eq('id', id); loadKeywords(); } }
        async function deletePermission(id) { if(confirm('Delete?')) { await supabase.from('keyword_permissions').delete().eq('id', id); loadPermissions(); } }
        async function deleteDataAI(id) { if(confirm('Delete?')) { await supabase.from('dataai').delete().eq('id', id); loadDataAI(); } }
        async function deleteUserProfile(userId) { if(confirm('Delete User?')) { await supabase.from('user_profiles').delete().eq('userId', userId); loadUserProfiles(); } }
        
        async function toggleUserAI(userId, enabled) {
            try { await supabase.from('user_profiles').update({ ai_enabled: enabled }).eq('userId', userId); } 
            catch (err) { Swal.fire('Error', 'Update failed', 'error'); }
        }
        async function toggleUserKeywords(userId, enabled) {
            try { await supabase.from('user_profiles').update({ keywords_enabled: enabled }).eq('userId', userId); }
            catch (err) { Swal.fire('Error', 'Update failed', 'error'); loadUserProfiles(); }
        }
        async function toggleAllAI(checked) {
            if (await Swal.fire({ title: 'ยืนยัน?', text: checked ? "เปิด AI ทุกคน" : "ปิด AI ทุกคน", icon: 'warning', showCancelButton: true }).then(r=>r.isConfirmed)) {
                const { error } = await supabase.from('user_profiles').update({ ai_enabled: checked }).neq('userId', 'placeholder');
                if (error) { Swal.fire('Error', error.message, 'error'); document.getElementById('masterAIToggle').checked = !checked; }
                else { Swal.fire('Success', 'Updated', 'success'); loadUserProfiles(); }
            } else { document.getElementById('masterAIToggle').checked = !checked; }
        }

        // --- Chat Functions ---
        function renderChatUsers(users, profiles) {
            const tbody = document.getElementById('chatUsersTable');
            tbody.innerHTML = users.map(u => {
                const profile = profiles.find(p => p.userId === u.userId) || {};
                const name = profile.displayName || u.userId.substring(0, 8);
                const pic = profile.pictureUrl || 'https://via.placeholder.com/40';
                const time = new Date(u.lastTime).toLocaleString('th-TH');
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4"><div class="flex items-center gap-3"><img src="${pic}" class="w-8 h-8 rounded-full"><span class="font-medium text-sm text-gray-700">${name}</span></div></td>
                    <td class="py-3 px-4 text-center text-sm font-bold text-blue-600">${u.count}</td>
                    <td class="py-3 px-4 text-sm text-gray-500 truncate max-w-xs">${u.lastMsg}</td>
                    <td class="py-3 px-4 text-xs text-gray-400">${time}</td>
                    <td class="py-3 px-4 text-center"><button onclick="viewChatHistory('${u.userId}')" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-200">View Chat</button></td>
                </tr>`;
            }).join('');
        }
        function searchChatHistory() {
            const term = document.getElementById('searchUserId').value.toLowerCase();
            if(!term) { loadChatUsers(); return; }
            const filtered = allChatUsers.filter(u => u.userId.toLowerCase().includes(term));
            if (filtered.length > 0) {
                supabase.from('user_profiles').select('userId, displayName, pictureUrl').in('userId', filtered.map(u=>u.userId))
                    .then(({data}) => renderChatUsers(filtered, data || []));
            } else { renderChatUsers([], []); }
        }
        async function viewChatHistory(userId) {
            const modal = document.getElementById('chatHistoryModal');
            const container = document.getElementById('chatMessagesContainer');
            modal.classList.remove('hidden');
            container.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i></div>';
            document.getElementById('modalUserId').textContent = userId;
            const { data: profile } = await supabase.from('user_profiles').select('*').eq('userId', userId).single();
            document.getElementById('modalUserName').textContent = profile ? profile.displayName : 'Unknown';
            document.getElementById('modalUserAvatar').style.backgroundImage = `url('${profile ? profile.pictureUrl : ''}')`;
            
            const { data: messages } = await supabase.from('chat_history').select('*').eq('user_id', userId).order('created_at', {ascending: true});
            let html = '', userCount = 0, botCount = 0;
            if(messages) {
                messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    if(isUser) userCount++; else botCount++;
                    const alignClass = isUser ? 'chat-user' : 'chat-bot';
                    html += `<div class="chat-bubble ${alignClass} text-sm">${isUser?'':'<i class="fas fa-robot text-blue-500 mr-2"></i>'} ${msg.message}<div class="text-[10px] opacity-70 mt-1 text-right">${new Date(msg.created_at).toLocaleTimeString('th-TH')}</div></div>`;
                });
            }
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
            document.getElementById('totalMessages').innerText = messages ? messages.length : 0;
            document.getElementById('userMessages').innerText = userCount;
            document.getElementById('botMessages').innerText = botCount;
        }
        function closeChatHistoryModal() { document.getElementById('chatHistoryModal').classList.add('hidden'); }
        async function showProfileCard(userId) {
            const { data: u } = await supabase.from('user_profiles').select('*').eq('userId', userId).single();
            if(!u) return;
            const container = document.getElementById('profileCardContainer');
            const content = document.getElementById('profileCardContent');
            content.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-6 items-center">
                    <img src="${u.pictureUrl || 'https://via.placeholder.com/80'}" class="w-24 h-24 rounded-full border-4 border-white shadow-lg">
                    <div class="flex-1 text-center sm:text-left space-y-2">
                        <h3 class="text-2xl font-bold text-gray-800">${u.displayName || 'No Name'}</h3>
                        <p class="text-gray-500 text-sm font-mono bg-gray-100 inline-block px-2 rounded">${u.userId}</p>
                        <div class="grid grid-cols-2 gap-4 mt-2 text-sm text-gray-600">
                            <div><i class="fas fa-envelope mr-2"></i> ${u.email || '-'}</div>
                            <div><i class="fas fa-phone mr-2"></i> ${u.phone || '-'}</div>
                            <div><i class="fas fa-user-tag mr-2"></i> Role: ${u.role || 'user'}</div>
                            <div><i class="fas fa-robot mr-2"></i> AI: ${u.ai_enabled ? 'Active' : 'Disabled'}</div>
                        </div>
                    </div>
                </div>`;
            container.classList.remove('hidden');
        }

        // --- 3. RICH MENU FUNCTIONS (Merged) ---
        const showLoading = (text) => { document.getElementById('loading-text').textContent = text; document.getElementById('loading-overlay').style.display = 'flex'; };
        const hideLoading = () => { document.getElementById('loading-overlay').style.display = 'none'; };
        const showToast = (icon, title) => {
            const container = document.getElementById('toast-container');
            const color = icon === 'success' ? 'bg-green-600' : 'bg-red-600';
            const toast = document.createElement('div');
            toast.className = `p-4 flex items-center rounded-xl shadow-xl text-white ${color} transition-all duration-300 transform translate-x-full opacity-0`;
            toast.innerHTML = `<span class="font-medium">${title}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('translate-x-full', 'opacity-0'); });
            setTimeout(() => { toast.remove(); }, 3000);
        };
        window.openLightbox = (url) => { document.getElementById('lightbox-image').src=url; document.getElementById('lightbox-modal').classList.remove('hidden'); };
        window.closeLightbox = () => { document.getElementById('lightbox-modal').classList.add('hidden'); };

        async function invokeFunction(payload) {
            const { data, error } = await supabase.functions.invoke('manage-rich-menu', { body: payload });
            if (error) throw error; return data;
        }

        async function loadRichMenus() {
            showLoading('กำลังโหลดเมนู...');
            const grid = document.getElementById('richmenu-grid');
            grid.innerHTML = '';
            try {
                const [listRes, defaultRes] = await Promise.all([
                    invokeFunction({ action: 'getList' }),
                    invokeFunction({ action: 'getDefault' }).catch(() => ({ richMenuId: null }))
                ]);
                currentDefaultMenuId = defaultRes.richMenuId;
                const { richmenus } = listRes;
                
                if (!richmenus || richmenus.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">ไม่พบ Rich Menu</div>';
                    return;
                }

                richmenus.forEach(menu => {
                    grid.appendChild(renderRichMenuCard(menu));
                    richMenuDataCache.set(menu.richMenuId, menu);
                });

                // Load images in background
                richmenus.forEach(async (menu) => {
                    try {
                        const { imageBase64 } = await invokeFunction({ action: 'getRichMenuImage', richMenuId: menu.richMenuId });
                        const card = document.getElementById(`menu-${menu.richMenuId}`);
                        if(card && imageBase64) {
                            // Extract raw base64 (remove prefix) for consistency in cache
                            const rawBase64 = imageBase64.replace(/^data:image\/\w+;base64,/, '');
                            richMenuDataCache.get(menu.richMenuId).imageBase64 = rawBase64;
                            // Set src with prefix provided by backend (or construct it)
                            card.querySelector('img').src = imageBase64; 
                        }
                    } catch(e){}
                });
            } catch (err) { console.error(err); showToast('error', 'โหลดข้อมูลล้มเหลว: ' + err.message); } 
            finally { hideLoading(); }
        }

        function renderRichMenuCard(menu) {
            const isDefault = menu.richMenuId === currentDefaultMenuId;
            const card = document.createElement('div');
            card.id = `menu-${menu.richMenuId}`;
            const defaultClass = isDefault ? 'default-menu-card' : 'glass-dark';
            card.className = `${defaultClass} rounded-2xl p-5 flex flex-col gap-4 fade-in relative hover:shadow-lg transition-all`;
            const aspectRatio = menu.size ? `${menu.size.width} / ${menu.size.height}` : '2500 / 843';
            const badgeHTML = isDefault ? `<div class="absolute top-0 left-0 bg-yellow-500 text-black text-xs font-bold px-3 py-1 rounded-br-lg z-10">MENU หลัก</div>` : '';

            // Ensure image src has prefix if base64 exists (assuming cache has raw or prefixed, handle carefully)
            // Ideally, cache stores raw. UI adds prefix.
            // But let's check: invokeFunction 'getRichMenuImage' returns full data URI.
            // So menu.imageBase64 here (from cache) might be raw or full.
            // Let's assume full data URI for simplicity in initial render if available.
            const imgSrc = menu.imageBase64 ? (menu.imageBase64.startsWith('data:') ? menu.imageBase64 : `data:image/png;base64,${menu.imageBase64}`) : '';

            card.innerHTML = `
                ${badgeHTML}
                <div class="relative group cursor-pointer" onclick="openLightbox(this.querySelector('img').src)">
                    <div class="bg-gray-800 rounded-xl overflow-hidden aspect-[${aspectRatio}] border border-white/5">
                        <img src="${imgSrc}" class="w-full h-full object-cover" />
                    </div>
                    <div class="absolute top-2 right-2 bg-black/70 text-xs px-2 py-1 rounded text-white">${menu.chatBarText || 'Menu'}</div>
                    <button onclick="event.stopPropagation(); openScheduleModal('${menu.richMenuId}', '${menu.name}')" class="absolute top-2 left-2 bg-purple-600 text-white p-1.5 rounded shadow"><i class="fas fa-clock"></i></button>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-lg text-blue-300 truncate" title="${menu.name}">${menu.name}</h3>
                    <p class="text-xs text-gray-500 font-mono truncate cursor-pointer" onclick="navigator.clipboard.writeText('${menu.richMenuId}');showToast('success','Copied ID')">${menu.richMenuId}</p>
                </div>
                <div class="mt-auto pt-4 border-t border-white/5 grid grid-cols-2 gap-2 text-xs font-semibold">
                    <button onclick="handleLinkUser('${menu.richMenuId}')" class="btn-success py-2 rounded text-white">ติดตั้ง</button>
                    <button onclick="handleUnlinkUser('${menu.richMenuId}')" class="btn-warning py-2 rounded text-black">ยกเลิก</button>
                    <button onclick="handleSetDefault('${menu.richMenuId}', '${menu.name}')" class="btn-primary py-2 rounded text-white col-span-2" ${isDefault ? 'disabled style="opacity:0.5"' : ''}>${isDefault ? 'เป็นเมนูหลักแล้ว' : 'ตั้งเป็นเมนูหลัก'}</button>
                    <button onclick="checkAuthAndRun(() => handleDeleteMenu('${menu.richMenuId}', '${menu.name}'))" class="btn-danger py-2 rounded text-white col-span-2">ลบเมนู</button>
                </div>`;
            return card;
        }

        // Rich Menu Actions
        async function handleLinkUser(id) { const u = await showUserSearchModal('เลือกผู้ใช้ที่จะติดตั้ง'); if(u&&u.length>0) { showLoading('Processing...'); try{ await invokeFunction({action:'bulkLink', userIds:u, richMenuId:id}); showToast('success','Success'); confetti({particleCount:100,spread:70,origin:{y:0.6}}); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleUnlinkUser(id) { const u = await showUserSearchModal('เลือกผู้ใช้ที่จะยกเลิก'); if(u&&u.length>0) { showLoading('Processing...'); try{ await invokeFunction({action:'bulkUnlink', userIds:u}); showToast('success','Success'); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleSetDefault(id, name) { if(confirm(`ตั้ง "${name}" เป็นเมนูหลัก?`)){ showLoading('Saving...'); try{ await invokeFunction({action:'setDefault', richMenuId:id}); showToast('success','Success'); confetti({particleCount:100,spread:70,origin:{y:0.6}}); loadRichMenus(); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleDeleteMenu(id, name) { if(confirm(`ลบเมนู "${name}"?`)){ showLoading('Deleting...'); try{ await invokeFunction({action:'delete', richMenuId:id}); showToast('success','Deleted'); document.getElementById(`menu-${id}`).remove(); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleCancelDefault() {
            checkAuthAndRun(async () => {
                if(confirm('ยกเลิกเมนูหลักสำหรับทุกคน?')){
                    showLoading('Processing...');
                    try{ await invokeFunction({action:'cancelDefault'}); showToast('success','Cancelled'); loadRichMenus(); }
                    catch(e){ showToast('error',e.message); } finally{ hideLoading(); }
                }
            });
        }

        // Auth Logic
        async function checkAuthAndRun(callback) {
            const isAuthenticated = await showAuthModal();
            if (isAuthenticated) callback();
        }
        window.showAuthModal = () => {
            return new Promise((resolve) => {
                resolveAuth = resolve;
                const modal = document.getElementById('authModal');
                const input = document.getElementById('auth-input');
                input.value = '';
                modal.classList.remove('hidden');
                modal.classList.remove('modal-leave-to');
                input.focus();
                input.onkeydown = (e) => { if (e.key === 'Enter') submitAuth(); };
            });
        };
        window.hideAuthModal = (auth) => {
            document.getElementById('authModal').classList.add('hidden');
            if (resolveAuth) { resolveAuth(auth); resolveAuth = null; }
        };
        window.submitAuth = () => {
            if (document.getElementById('auth-input').value === ADMIN_PASSWORD) hideAuthModal(true);
            else { showToast('error', 'รหัสผ่านผิด'); document.getElementById('auth-input').value=''; }
        };

        // User Search Modal Logic
        const userSearchModal = document.getElementById('userSearchModal');
        const resultsContainer = document.getElementById('modal-user-results');
        window.showUserSearchModal = (title) => {
            return new Promise((resolve) => {
                resolveUserSearch = resolve;
                selectedUsers.clear();
                document.getElementById('modal-user-search').value = '';
                resultsContainer.innerHTML = '<div class="text-center text-gray-400 mt-10">ค้นหาหรือโหลดทั้งหมด</div>';
                document.getElementById('search-modal-title').textContent = title;
                document.getElementById('modal-user-select-all-container').classList.add('hidden');
                updateSelectedCount();
                userSearchModal.classList.remove('hidden');
                userSearchModal.classList.remove('modal-leave-to');
                
                document.getElementById('modal-user-search-btn').onclick = async () => {
                    const t = document.getElementById('modal-user-search').value.trim();
                    if(t.length < 2) return;
                    renderUsers((await invokeFunction({action:'getUsersWithRichMenu', searchTerm:t})).users);
                };
                document.getElementById('modal-user-all-btn').onclick = async () => {
                    renderUsers((await invokeFunction({action:'getUsersWithRichMenu', allUsers:true})).users);
                };
                document.getElementById('search-ok-btn').onclick = () => hideUserSearchModal(Array.from(selectedUsers));
                document.getElementById('search-cancel-btn').onclick = () => hideUserSearchModal(null);
                document.getElementById('modal-user-select-all-btn').onclick = () => {
                    resultsContainer.querySelectorAll('input').forEach(c => {
                        c.checked = true; selectedUsers.add(c.dataset.userid);
                    });
                    updateSelectedCount();
                };
            });
        };
        window.hideUserSearchModal = (res) => {
            userSearchModal.classList.add('hidden');
            if(resolveUserSearch) { resolveUserSearch(res); resolveUserSearch = null; }
        };
        function updateSelectedCount() {
            const btn = document.getElementById('search-ok-btn');
            btn.textContent = `ยืนยัน (${selectedUsers.size})`;
            btn.disabled = selectedUsers.size === 0;
        }
        function renderUsers(users) {
            resultsContainer.innerHTML = '';
            if(!users || users.length === 0) { resultsContainer.innerHTML = '<div class="text-center p-4">ไม่พบข้อมูล</div>'; return; }
            document.getElementById('modal-user-select-all-container').classList.remove('hidden');
            users.forEach(u => {
                const el = document.createElement('label');
                el.className = 'flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 cursor-pointer mb-1 border border-transparent';
                const hasMenu = u.linkedRichMenuId ? '<span class="text-green-400 text-xs">มีเมนู</span>' : '<span class="text-gray-500 text-xs">ไม่มี</span>';
                el.innerHTML = `<input type="checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-500 text-blue-500" data-userid="${u.userId}">
                    <img src="${u.pictureUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full bg-gray-700">
                    <div class="flex-1 min-w-0"><p class="font-bold text-white truncate text-sm">${u.displayName}</p><p class="text-xs text-gray-400 truncate font-mono">${u.userId}</p></div>
                    ${hasMenu}`;
                el.querySelector('input').onchange = (e) => {
                    if(e.target.checked) { selectedUsers.add(u.userId); el.classList.add('bg-blue-900/40', 'border-blue-500/50'); }
                    else { selectedUsers.delete(u.userId); el.classList.remove('bg-blue-900/40', 'border-blue-500/50'); }
                    updateSelectedCount();
                };
                resultsContainer.appendChild(el);
            });
        }

        // Schedule Modal Logic
        const scheduleModal = document.getElementById('scheduleModal');
        window.openScheduleModal = async (menuId, menuName, existing = null) => {
            let targetType = 'specific', ids = [];
            if(existing) {
                targetType = existing.target_type; ids = existing.user_ids || [];
                currentScheduleData = { isEdit: true, id: existing.id, richMenuId: menuId, targetType, targetIds: ids };
                document.getElementById('schedule-title-text').textContent = "แก้ไขตาราง";
                document.getElementById('schedule-action').value = existing.action_type;
                const d = new Date(existing.scheduled_time);
                const o = d.getTimezoneOffset() * 60000;
                document.getElementById('schedule-time').value = (new Date(d - o)).toISOString().slice(0,16);
            } else {
                const r = await showUserSearchModal(`เลือกเป้าหมายสำหรับ "${menuName}"`);
                if(r === null) return;
                if(r.length === 0) { if(!confirm('ไม่เลือกใคร = ตั้งให้ทุกคน (All Users)?')) return; targetType = 'all'; }
                else ids = r;
                currentScheduleData = { isEdit: false, richMenuId: menuId, targetType, targetIds: ids };
                document.getElementById('schedule-title-text').textContent = "ตั้งเวลาใหม่";
                document.getElementById('schedule-time').value = '';
            }
            document.getElementById('schedule-menu-name').textContent = menuName;
            document.getElementById('schedule-target-info').textContent = targetType === 'all' ? 'ทุกคน (All Users)' : `${ids.length} คน`;
            scheduleModal.classList.remove('hidden');
            scheduleModal.classList.remove('modal-leave-to');
        };
        window.hideScheduleModal = () => { scheduleModal.classList.add('hidden'); currentScheduleData = null; };
        document.getElementById('schedule-save-btn').onclick = async () => {
            const time = document.getElementById('schedule-time').value;
            const action = document.getElementById('schedule-action').value;
            if(!time) return showToast('error', 'เลือกเวลา');
            showLoading('Saving...');
            try {
                await invokeFunction({
                    action: currentScheduleData.isEdit ? 'updateSchedule' : 'createSchedule',
                    id: currentScheduleData.id,
                    richMenuId: currentScheduleData.richMenuId,
                    userIds: currentScheduleData.targetIds,
                    targetType: currentScheduleData.targetType,
                    actionType: action,
                    scheduledTime: new Date(time).toISOString()
                });
                showToast('success', 'บันทึกสำเร็จ');
                hideScheduleModal();
                if(document.getElementById('taskManagerModal').classList.contains('hidden') === false) loadSchedules();
            } catch(e) { showToast('error', e.message); } finally { hideLoading(); }
        };

        // Task Manager Logic
        const taskManagerModal = document.getElementById('taskManagerModal');
        window.showTaskManager = () => { taskManagerModal.classList.remove('hidden'); taskManagerModal.classList.remove('modal-leave-to'); loadSchedules(); };
        window.hideTaskManager = () => { taskManagerModal.classList.add('hidden'); };
        window.switchScheduleTab = (t) => {
            currentScheduleTab = t;
            document.getElementById('tab-pending').className = t === 'pending' ? 'px-6 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white' : 'px-6 py-2 rounded-lg text-sm font-medium text-gray-400';
            document.getElementById('tab-completed').className = t === 'completed' ? 'px-6 py-2 rounded-lg text-sm font-medium bg-green-600 text-white' : 'px-6 py-2 rounded-lg text-sm font-medium text-gray-400';
            loadSchedules();
        };
        
        // --- 4. Updated Task Manager Display (Image + Execute Now) ---
        window.loadSchedules = async () => {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '<div class="text-center p-4 text-gray-400">Loading...</div>';
            try {
                const { schedules } = await invokeFunction({ action: 'getSchedules', status: currentScheduleTab });
                if(!schedules || schedules.length === 0) { list.innerHTML = '<div class="text-center p-8 text-gray-500">ไม่มีรายการ</div>'; return; }
                list.innerHTML = '';
                
                schedules.forEach(t => {
                    const isDue = new Date(t.scheduled_time) <= new Date() && t.status === 'pending';
                    let cachedMenu = richMenuDataCache.get(t.rich_menu_id);
                    const menuName = cachedMenu?.name || t.rich_menu_id;
                    let menuImage = cachedMenu?.imageBase64; // Can be raw base64 or data uri

                    const el = document.createElement('div');
                    el.className = `p-3 rounded-xl border flex items-center gap-4 ${isDue ? 'border-yellow-500/30 bg-yellow-900/10' : 'border-white/5 bg-white/5'} transition-all hover:bg-white/10`;
                    
                    if (!menuImage) {
                        invokeFunction({ action: 'getRichMenuImage', richMenuId: t.rich_menu_id }).then(res => {
                            if(res.imageBase64) {
                                // Strip prefix if present for raw cache consistency, or store as is
                                const rawBase64 = res.imageBase64.replace(/^data:image\/\w+;base64,/, '');
                                if(cachedMenu) cachedMenu.imageBase64 = rawBase64;
                                else richMenuDataCache.set(t.rich_menu_id, { name: t.rich_menu_id, imageBase64: rawBase64 });
                                const imgEl = document.getElementById(`sched-img-${t.id}`);
                                if(imgEl) imgEl.src = res.imageBase64; // Use full URI
                            }
                        }).catch(() => {});
                    }

                    // Construct image src correctly
                    const displayImageSrc = menuImage ? (menuImage.startsWith('data:') ? menuImage : `data:image/png;base64,${menuImage}`) : 'https://via.placeholder.com/64?text=...';

                    let actionBtn = '';
                    if (currentScheduleTab === 'pending') {
                        actionBtn = `
                            <button onclick='executeTaskNow("${t.id}")' class="p-2 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 rounded-lg text-white text-xs font-bold whitespace-nowrap shadow-lg transform hover:scale-105 transition-all" title="ทำงานทันที"><i class="fas fa-bolt"></i> Run</button>
                            <button onclick='editTask(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 transition-colors"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTask(${t.id})" class="p-2 bg-gray-700 hover:bg-red-900/50 rounded-lg text-red-400 transition-colors"><i class="fas fa-trash"></i></button>`;
                    } else {
                        const statusColor = t.status === 'failed' ? 'bg-red-900/50 text-red-300 border-red-500/30' : 'bg-green-900/50 text-green-300 border-green-500/30';
                        actionBtn = `<span class="px-3 py-1 rounded-lg text-xs border ${statusColor} font-mono">${t.status}</span>`;
                    }

                    let targetDisplay = '';
                    if (t.target_type === 'all') {
                        targetDisplay = '<span class="text-purple-300 font-bold"><i class="fas fa-users"></i> ทุกคน (All Users)</span>';
                    } else {
                        const count = t.user_ids ? t.user_ids.length : 0;
                        targetDisplay = `<span class="text-blue-300 font-bold"><i class="fas fa-user-check"></i> ${count} คน</span>`;
                    }

                    el.innerHTML = `
                        <div class="w-16 h-16 bg-gray-800 rounded-lg overflow-hidden flex-shrink-0 border border-white/10 relative group">
                            <img id="sched-img-${t.id}" src="${displayImageSrc}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/64?text=No+Img'">
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center gap-1">
                            <div class="text-xs text-gray-400 flex items-center gap-2">
                                <i class="far fa-clock text-purple-400"></i> 
                                <span class="${isDue ? 'text-yellow-400 font-bold' : ''}">${dayjs(t.scheduled_time).format('D MMM BB HH:mm')}</span>
                                <span class="opacity-50">(${dayjs(t.scheduled_time).fromNow()})</span>
                            </div>
                            <div class="font-bold text-white truncate text-base">
                                <span class="${t.action_type==='link'?'text-green-400':'text-red-400'} mr-1">[${t.action_type==='link'?'Link':'Unlink'}]</span> 
                                ${menuName}
                            </div>
                            <div class="text-xs text-gray-400">${targetDisplay}</div>
                        </div>
                        <div class="flex gap-2 items-center pl-2 border-l border-white/5">${actionBtn}</div>`;
                    list.appendChild(el);
                });
            } catch(e) { list.innerHTML = `<div class="text-red-400 text-center p-4"><i class="fas fa-exclamation-circle mr-2"></i>${e.message}</div>`; }
        };
        window.executeTaskNow = async (id) => {
            if(!confirm('ยืนยันที่จะรันงานนี้ "ทันที" โดยไม่รอเวลา?')) return;
            showLoading('Executing...');
            try {
                await invokeFunction({ action: 'executeSchedule', id: id }); 
                showToast('success', 'Executed Successfully');
                switchScheduleTab('completed'); 
            } catch(e) {
                showToast('error', e.message);
                loadSchedules(); 
            } finally { hideLoading(); }
        };
        window.editTask = (t) => openScheduleModal(t.rich_menu_id, richMenuDataCache.get(t.rich_menu_id)?.name || t.rich_menu_id, t);
        window.deleteTask = async (id) => { if(confirm('ลบรายการ?')) { try { await invokeFunction({action:'deleteSchedule', id}); loadSchedules(); } catch(e){showToast('error',e.message);} } };

        // 4. INITIALIZATION (Must be last)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing application...');
            
            // Validate Supabase
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase not loaded');
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้', 'error');
                return;
            }

            // Setup Listeners
            setupTabs();
            setupForms();
            
            // Initial Data Load
            loadKeywords();
            
            // Search Input Listener
            const searchUserId = document.getElementById('searchUserId');
            if (searchUserId) {
                searchUserId.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') searchChatHistory();
                });
            }
            
            console.log('Application initialized successfully');
        });
    </script>
</body>
</html>
