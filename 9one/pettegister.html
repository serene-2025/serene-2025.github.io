<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á - ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡∏™‡πÑ‡∏õ‡∏£‡πå</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // ==========================================
        // ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
        // ==========================================
        const SUPABASE_URL = 'https://dueckgfsbageeomiybav.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1ZWNrZ2ZzYmFnZWVvbWl5YmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MzU4MjEsImV4cCI6MjA4NDMxMTgyMX0.69yySB2muOFaG51Wu1l2ZxDjbYgpNOiBxR2Wjy0Y10s';
        
        // ==========================================
        // ü§ñ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram Bot
        // ==========================================
        const TELEGRAM_TOKEN = '8279169798:AAG-JnddhWhscK_Zr5vRCx9naaRDVMBZ9XQ';
        let TELEGRAM_CHAT_ID = '-1003502117297'; 

        // ==========================================
        // üü¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE LIFF
        // ==========================================
        const LIFF_ID = '2008923148-q3n1xlu2'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

        // Initialize Client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981', // Emerald 500
                        secondary: '#6366f1', // Indigo 500
                        accent: '#f59e0b', // Amber 500
                        dark: {
                            bg: '#0f172a', // Slate 900
                            card: '#1e293b', // Slate 800
                            input: '#334155', // Slate 700
                            text: '#f1f5f9' // Slate 100
                        }
                    },
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-nav {
            background: rgba(15, 23, 42, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-preview {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 1rem;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .image-preview {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        .dark #loadingOverlay {
            background: rgba(15, 23, 42, 0.9);
        }

        .nav-active {
            color: #10b981;
            background-color: #ecfdf5;
            border: 1px solid #d1fae5;
        }
        .dark .nav-active {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Admin Button Pulse */
        .admin-active {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #fca5a5;
        }
        .dark .admin-active {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        /* Modal Transition */
        #imageModal, #welcomeModal {
            transition: opacity 0.3s ease;
        }
        #modalImage, #welcomeModalContent {
            transition: transform 0.3s ease;
        }
        /* Summary Card Gradient Border */
        .summary-card {
            position: relative;
            overflow: hidden;
        }
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--tw-gradient-from), var(--tw-gradient-to));
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-800 dark:text-dark-text antialiased min-h-screen pb-20 lg:pb-0 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="glass-nav sticky top-0 z-50 shadow-sm dark:shadow-lg transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between mb-2 md:mb-0">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('register')">
                    <div class="bg-gradient-to-tr from-primary to-emerald-300 w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-200 dark:shadow-emerald-900/50">
                        <i class="fa-solid fa-paw text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold leading-tight text-slate-800 dark:text-white">PetRegister <span class="text-primary text-xs bg-emerald-100 dark:bg-emerald-900/50 px-2 py-0.5 rounded-full border border-emerald-200 dark:border-emerald-500/30">Online</span></h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400">‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡∏™‡πÑ‡∏õ‡∏£‡πå</p>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-2 bg-slate-100/80 dark:bg-slate-800/50 p-1 rounded-xl border border-slate-200 dark:border-slate-700">
                    <button onclick="switchView('register')" id="btn-nav-register" class="px-5 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white shadow-sm hover:shadow">
                        <i class="fa-solid fa-plus-circle"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                    <button onclick="switchView('list')" id="btn-nav-list" class="px-5 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white shadow-sm hover:shadow">
                        <i class="fa-solid fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                    
                    <div class="w-px h-6 bg-slate-300 dark:bg-slate-600 mx-1"></div>

                    <!-- Admin Export Button (Hidden by default) -->
                    <button onclick="exportData()" id="btn-export" class="hidden px-4 py-2 rounded-lg text-sm font-semibold bg-emerald-500/10 text-emerald-600 hover:bg-emerald-500 hover:text-white transition-all items-center gap-2">
                        <i class="fa-solid fa-file-csv"></i> Export
                    </button>

                    <!-- Admin Toggle -->
                    <button onclick="toggleAdmin()" id="btn-admin" class="w-9 h-9 rounded-full flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö">
                        <i class="fa-solid fa-lock"></i>
                    </button>
                    
                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" id="btn-theme" class="w-9 h-9 rounded-full flex items-center justify-center text-slate-400 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-colors" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </div>

                <!-- Mobile Header Buttons -->
                <div class="flex items-center gap-2 md:hidden">
                    <button onclick="exportData()" id="mob-btn-export" class="hidden w-9 h-9 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-full flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                        <i class="fa-solid fa-file-csv text-sm"></i>
                    </button>
                    <button onclick="toggleTheme()" id="mob-btn-theme" class="w-9 h-9 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full flex items-center justify-center text-slate-400">
                        <i class="fa-solid fa-moon text-sm"></i>
                    </button>
                    <button onclick="toggleAdmin()" id="mob-btn-admin" class="w-9 h-9 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full flex items-center justify-center text-slate-400">
                        <i class="fa-solid fa-lock text-sm"></i>
                    </button>
                    <button onclick="switchView('register')" class="w-9 h-9 bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-emerald-200 dark:shadow-emerald-900/50">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu Tabs -->
            <div class="flex md:hidden border-t border-slate-200 dark:border-slate-700 pt-2 gap-2">
                <button onclick="switchView('register')" id="mob-nav-register" class="flex-1 py-2 text-center text-sm font-semibold rounded-lg transition-colors bg-slate-100 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300">
                    ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                </button>
                <button onclick="switchView('list')" id="mob-nav-list" class="flex-1 py-2 text-center text-sm font-semibold rounded-lg transition-colors bg-slate-100 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300">
                    ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>
        </div>
        
        <!-- Admin Banner -->
        <div id="adminBanner" class="hidden bg-red-500 dark:bg-red-900/80 text-white dark:text-red-100 border-b border-red-600 dark:border-red-700 text-center text-xs py-1.5 font-bold tracking-wider backdrop-blur-sm">
            <i class="fa-solid fa-shield-halved mr-1"></i> ADMIN MODE ACTIVE
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6 min-h-[80vh]">

        <!-- View: Register (Default Visible) -->
        <div id="view-register" class="fade-in">
            <div class="max-w-2xl mx-auto">
                
                <!-- LINE Profile Section (Displays if logged in via LINE) -->
                <div id="lineProfileSection" class="hidden mb-6 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-4 rounded-2xl flex items-center gap-4">
                    <img id="lineAvatar" src="" class="w-12 h-12 rounded-full border-2 border-white dark:border-slate-700 shadow-sm">
                    <div>
                        <p class="text-xs text-green-600 dark:text-green-400 font-bold uppercase">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</p>
                        <h3 id="lineName" class="text-slate-800 dark:text-white font-semibold">Username</h3>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-black/20 p-6 md:p-8 border border-slate-100 dark:border-slate-700 relative overflow-hidden transition-colors duration-300">
                    <!-- Background Decor -->
                    <div class="hidden dark:block absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full blur-3xl -mr-10 -mt-10"></div>
                    
                    <div class="mb-8 text-center relative z-10">
                        <span id="formBadge" class="bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 border border-transparent dark:border-emerald-500/30 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">New Registration</span>
                        <h2 id="formTitle" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white mt-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        
                        <!-- Cancel Edit Button -->
                        <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden absolute top-0 right-0 text-slate-400 hover:text-red-500 dark:hover:text-red-400 text-sm font-medium">
                            <i class="fa-solid fa-times mr-1"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>

                    <form id="petForm" onsubmit="handleRegister(event)" class="space-y-6 relative z-10">
                        
                        <!-- Owner Section -->
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 space-y-4">
                            <div class="flex items-center gap-2 text-secondary font-bold text-lg">
                                <i class="fa-regular fa-id-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
                                <input type="text" id="ownerName" required 
                                    class="w-full px-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:border-primary transition-all outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 shadow-sm text-slate-800 dark:text-white" 
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏£‡∏±‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå">
                            </div>

                            <div class="grid grid-cols-5 gap-3">
                                <div class="col-span-3">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></label>
                                    <input type="text" id="houseNo" required 
                                        class="w-full px-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:border-primary transition-all outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 shadow-sm text-slate-800 dark:text-white" 
                                        placeholder="997/99">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡∏ã‡∏≠‡∏¢ <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select id="soi" required class="w-full px-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:border-primary transition-all outline-none appearance-none shadow-sm text-center text-slate-800 dark:text-white">
                                            <option value="" class="text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                            <script>
                                                for(let i=1; i<=20; i++) {
                                                    document.write(`<option value="${i}">‡∏ã‡∏≠‡∏¢ ${i}</option>`);
                                                }
                                            </script>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-slate-400 text-xs pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i class="fa-solid fa-phone absolute left-4 top-3.5 text-slate-400"></i>
                                    <input type="tel" id="phone" required inputmode="numeric"
                                        class="w-full pl-10 pr-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:border-primary transition-all outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 shadow-sm text-slate-800 dark:text-white" 
                                        placeholder="08x-xxx-xxxx">
                                </div>
                            </div>
                        </div>

                        <!-- Pet Section -->
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 space-y-4">
                            <div class="flex items-center gap-2 text-accent font-bold text-lg">
                                <i class="fa-solid fa-cat"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select id="petType" class="w-full px-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-accent/50 dark:focus:border-accent transition-all outline-none appearance-none shadow-sm text-slate-800 dark:text-white">
                                            <option value="‡∏™‡∏∏‡∏ô‡∏±‡∏Ç">üêï ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
                                            <option value="‡πÅ‡∏°‡∏ß">üêà ‡πÅ‡∏°‡∏ß</option>
                                            <option value="‡∏ô‡∏Å">ü¶ú ‡∏ô‡∏Å</option>
                                            <option value="‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢">üêá ‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</option>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üêæ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 text-xs pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <span class="text-red-500">*</span></label>
                                    <input type="text" id="petName" required 
                                        class="w-full px-4 py-3 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-accent/50 dark:focus:border-accent transition-all outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 shadow-sm text-slate-800 dark:text-white" 
                                        placeholder="‡∏ô‡πâ‡∏≠‡∏á‡∏ñ‡∏∏‡∏á‡∏ó‡∏≠‡∏á">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 ml-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á <span class="text-red-500">*</span></label>
                                <div class="group relative w-full h-64 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl hover:bg-white dark:hover:bg-slate-800 hover:border-primary transition-all cursor-pointer flex flex-col items-center justify-center overflow-hidden bg-white/50 dark:bg-slate-900/30" 
                                    onclick="document.getElementById('petImage').click()">
                                    
                                    <div class="space-y-2 text-center z-10 p-4 transition-all duration-300" id="uploadPlaceholder">
                                        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto text-slate-400 dark:text-slate-500 group-hover:text-primary group-hover:scale-110 transition-all shadow-sm">
                                            <i class="fa-solid fa-camera text-3xl"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-slate-600 dark:text-slate-400">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</p>
                                            <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG (Max 10MB)</p>
                                        </div>
                                    </div>

                                    <img id="preview" class="image-preview absolute inset-0 z-20 h-full">
                                    <input id="petImage" type="file" class="sr-only" accept="image/*" onchange="previewImage(this)">
                                    
                                    <button type="button" id="removeImgBtn" onclick="removeImage(event)" 
                                        class="hidden absolute top-2 right-2 z-30 bg-white/90 dark:bg-black/60 hover:text-red-500 dark:hover:bg-red-500 dark:hover:text-white text-red-500 dark:text-white w-9 h-9 rounded-full shadow-md backdrop-blur-sm hover:scale-110 transition flex items-center justify-center border border-transparent dark:border-white/10">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex gap-3">
                            <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-primary to-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200 dark:shadow-emerald-900/50 hover:shadow-emerald-300 dark:hover:shadow-emerald-500/30 hover:-translate-y-1 active:translate-y-0 transition-all text-lg flex items-center justify-center gap-2 group">
                                <span id="submitBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                <i id="submitBtnIcon" class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- View: List (Hidden by default) -->
        <div id="view-list" class="hidden fade-in">
            
            <!-- Summary Dashboard -->
            <div id="summarySection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- Javascript will populate this -->
            </div>

            <!-- Search & Filters -->
            <div class="bg-white dark:bg-dark-card rounded-3xl p-3 shadow-sm dark:shadow-lg mb-8 flex items-center gap-3 border border-slate-100 dark:border-slate-700 sticky top-[80px] md:top-24 z-40 backdrop-blur-lg bg-opacity-90 dark:bg-opacity-90">
                <div class="flex-1 relative">
                    <i class="fa-solid fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="searchInput" onkeyup="filterPets()" 
                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà..." 
                        class="w-full pl-12 pr-4 py-3 bg-transparent dark:bg-slate-900 border border-transparent dark:border-slate-700 focus:border-transparent dark:focus:border-primary focus:ring-0 dark:focus:ring-0 text-slate-700 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 rounded-2xl outline-none transition-colors">
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 border border-transparent dark:border-slate-700 px-4 py-2 rounded-2xl text-sm font-semibold text-slate-500 dark:text-slate-300 whitespace-nowrap hidden sm:flex items-center gap-2">
                    <i class="fa-solid fa-layer-group text-primary"></i>
                    <span id="count">...</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
            </div>

            <!-- Grid Content -->
            <div id="petGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                <!-- Javascript will populate this -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
                <div class="w-40 h-40 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6">
                    <i class="fa-solid fa-paw text-6xl text-slate-300 dark:text-slate-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-700 dark:text-white">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <p class="text-slate-500 dark:text-slate-400 mt-2 max-w-xs mx-auto">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
        </div>
    </div>

    <!-- Image Modal (Full Screen) -->
    <div id="imageModal" class="fixed inset-0 z-[100] hidden bg-black/95 backdrop-blur-md flex items-center justify-center p-4 cursor-zoom-out opacity-0" onclick="closeImageModal()">
        <img id="modalImage" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300 border border-white/10">
        <button class="absolute top-5 right-5 text-white/70 hover:text-white text-4xl focus:outline-none w-12 h-12 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/20 transition-all">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/70 dark:bg-black/80 backdrop-blur-md transition-opacity duration-300 opacity-0 hidden">
        <div class="bg-white dark:bg-dark-card border border-transparent dark:border-slate-700 rounded-2xl shadow-2xl max-w-md w-full p-6 text-center transform scale-95 transition-transform duration-300" id="welcomeModalContent">
            <div class="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 border border-transparent dark:border-emerald-500/30 rounded-full flex items-center justify-center mx-auto mb-4 text-primary shadow-none dark:shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                <i class="fa-solid fa-database text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6 leading-relaxed text-sm">
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
            </p>
            <button onclick="closeWelcomeModal()" class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-emerald-600 transition shadow-lg shadow-emerald-200 dark:shadow-emerald-900/50">
                ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-center">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary mb-3"></i>
        <p class="text-slate-600 dark:text-slate-300 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 transform translate-y-32 opacity-0 transition-all duration-500 z-[60] w-max max-w-[90vw]">
        <div class="bg-slate-800 dark:bg-slate-800 text-white border border-slate-700 px-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 backdrop-blur-md">
            <div id="toastIcon" class="bg-emerald-500 rounded-full p-1"><i class="fa-solid fa-check text-xs text-white"></i></div>
            <span id="toastMessage" class="font-medium text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
        </div>
    </div>

    <script>
        // State management
        let pets = [];
        let currentImageBase64 = null;
        let currentView = 'register'; 
        let isAdmin = false; 
        let editingPetId = null; 
        let existingImageUrl = null;
        let lineProfile = null; // Store LINE Profile

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Theme Initialization
            initTheme();

            // Initialize LIFF
            await initLiff();

            fetchPets();
            updateViewUI();
            
            const savedChatId = localStorage.getItem('tg_chat_id');
            if(savedChatId) TELEGRAM_CHAT_ID = savedChatId;

            // Show Welcome Modal
            showWelcomeModal();
        });

        // ==========================================
        // üü¢ LINE LIFF Logic
        // ==========================================
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    lineProfile = await liff.getProfile();
                    updateLineProfileUI();
                } else {
                    // Optional: liff.login(); if you want to force login
                    console.log('LIFF not logged in');
                }
            } catch (err) {
                console.error('LIFF Init failed', err);
            }
        }

        function updateLineProfileUI() {
            if (lineProfile) {
                document.getElementById('lineProfileSection').classList.remove('hidden');
                document.getElementById('lineAvatar').src = lineProfile.pictureUrl;
                document.getElementById('lineName').innerText = lineProfile.displayName;
                
                // --- Modified: Do NOT auto-fill ownerName with LINE name ---
                // const ownerInput = document.getElementById('ownerName');
                // if(!ownerInput.value) {
                //     ownerInput.value = lineProfile.displayName;
                // }
            }
        }

        // ==========================================
        // üìä Export to CSV
        // ==========================================
        function exportData() {
            if (!pets.length) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', true);
                return;
            }
            
            // Create CSV Content
            // BOM \uFEFF ensures Excel reads UTF-8 correctly (Thai characters)
            let csvContent = "\uFEFF";
            csvContent += "ID,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á,‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ã‡∏≠‡∏¢,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á,‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û\n";

            pets.forEach(pet => {
                // Wrap fields in quotes to handle commas within data
                const dateStr = new Date(pet.created_at).toLocaleString('th-TH');
                const row = [
                    pet.id,
                    `"${dateStr}"`,
                    `"${pet.ownername || ''}"`,
                    `"${pet.houseno || ''}"`,
                    `"${pet.soi || ''}"`,
                    `"${pet.phone || ''}"`,
                    `"${pet.pettype || ''}"`,
                    `"${pet.petname || ''}"`,
                    `"${pet.image || ''}"`
                ];
                csvContent += row.join(",") + "\n";
            });

            // Create Blob and Download Link
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            const timestamp = new Date().toISOString().slice(0,10);
            link.setAttribute("href", url);
            link.setAttribute("download", `pet_data_export_${timestamp}.csv`);
            link.style.visibility = "hidden";
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        // ==========================================
        // üåì Theme Logic
        // ==========================================
        function initTheme() {
            // Check local storage
            const savedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            
            // If saved as light, remove dark class
            if (savedTheme === 'light') {
                html.classList.remove('dark');
            } else {
                // Default to dark if not set or set to dark
                html.classList.add('dark');
            }
            updateThemeUI();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            updateThemeUI();
        }

        function updateThemeUI() {
            const isDark = document.documentElement.classList.contains('dark');
            const btn = document.getElementById('btn-theme');
            const mobBtn = document.getElementById('mob-btn-theme');
            
            // Note: Icon represents the current state (Moon = Dark Mode is On)
            if (isDark) {
                if(btn) btn.innerHTML = '<i class="fa-solid fa-moon"></i>';
                if(mobBtn) {
                    mobBtn.innerHTML = '<i class="fa-solid fa-moon text-sm"></i>';
                    mobBtn.className = "w-9 h-9 bg-slate-800 border border-slate-700 rounded-full flex items-center justify-center text-slate-400";
                }
            } else {
                if(btn) btn.innerHTML = '<i class="fa-solid fa-sun"></i>';
                if(mobBtn) {
                    mobBtn.innerHTML = '<i class="fa-solid fa-sun text-sm"></i>';
                    mobBtn.className = "w-9 h-9 bg-white border border-slate-200 rounded-full flex items-center justify-center text-amber-500 shadow-sm";
                }
            }
        }

        // ==========================================
        // üîê Admin & Navigation Logic
        // ==========================================
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î Admin ‡πÅ‡∏•‡πâ‡∏ß');
            } else {
                const pass = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö ");
                if (pass === '1234') {
                    isAdmin = true;
                    showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } else if (pass !== null) {
                    showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
                }
            }
            updateAdminUI();
            renderPets(pets); 
        }

        function updateAdminUI() {
            const btn = document.getElementById('btn-admin');
            const mobBtn = document.getElementById('mob-btn-admin');
            const banner = document.getElementById('adminBanner');
            
            // Export Buttons
            const btnExport = document.getElementById('btn-export');
            const mobBtnExport = document.getElementById('mob-btn-export');
            
            if (isAdmin) {
                btn?.classList.add('admin-active', 'text-red-500');
                btn.innerHTML = '<i class="fa-solid fa-unlock"></i>';
                mobBtn?.classList.add('admin-active', 'text-red-500');
                mobBtn.innerHTML = '<i class="fa-solid fa-unlock text-sm"></i>';
                banner.classList.remove('hidden');
                
                // Show Export
                btnExport.classList.remove('hidden');
                btnExport.classList.add('flex');
                mobBtnExport.classList.remove('hidden');
                
            } else {
                btn?.classList.remove('admin-active', 'text-red-500');
                btn.innerHTML = '<i class="fa-solid fa-lock"></i>';
                mobBtn?.classList.remove('admin-active', 'text-red-500');
                mobBtn.innerHTML = '<i class="fa-solid fa-lock text-sm"></i>';
                banner.classList.add('hidden');
                
                // Hide Export
                btnExport.classList.add('hidden');
                btnExport.classList.remove('flex');
                mobBtnExport.classList.add('hidden');
            }
        }

        function switchView(viewName) {
            currentView = viewName;
            updateViewUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateViewUI() {
            const listSection = document.getElementById('view-list');
            const registerSection = document.getElementById('view-register');
            const btnList = document.getElementById('btn-nav-list');
            const btnReg = document.getElementById('btn-nav-register');
            const mobList = document.getElementById('mob-nav-list');
            const mobReg = document.getElementById('mob-nav-register');

            if (currentView === 'list') {
                listSection.classList.remove('hidden');
                registerSection.classList.add('hidden');
                
                btnList?.classList.add('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                btnList?.classList.remove('text-slate-600', 'dark:text-slate-300');
                
                btnReg?.classList.remove('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                btnReg?.classList.add('text-slate-600', 'dark:text-slate-300');

                mobList?.classList.add('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                mobList?.classList.remove('bg-slate-100', 'dark:bg-slate-800/50', 'text-slate-600', 'dark:text-slate-300');
                
                mobReg?.classList.remove('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                mobReg?.classList.add('bg-slate-100', 'dark:bg-slate-800/50', 'text-slate-600', 'dark:text-slate-300');

            } else {
                listSection.classList.add('hidden');
                registerSection.classList.remove('hidden');
                
                btnReg?.classList.add('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                btnReg?.classList.remove('text-slate-600', 'dark:text-slate-300');
                
                btnList?.classList.remove('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                btnList?.classList.add('text-slate-600', 'dark:text-slate-300');

                mobReg?.classList.add('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                mobReg?.classList.remove('bg-slate-100', 'dark:bg-slate-800/50', 'text-slate-600', 'dark:text-slate-300');
                
                mobList?.classList.remove('bg-emerald-50', 'text-primary', 'dark:bg-emerald-900/20', 'dark:text-primary');
                mobList?.classList.add('bg-slate-100', 'dark:bg-slate-800/50', 'text-slate-600', 'dark:text-slate-300');
            }
        }

        // ==========================================
        // üì∑ Image Modal Logic
        // ==========================================
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modalImg.src = src;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalImg.classList.remove('scale-95');
                modalImg.classList.add('scale-100');
            }, 10);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');

            modal.classList.add('opacity-0');
            modalImg.classList.remove('scale-100');
            modalImg.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modalImg.src = '';
            }, 300);
        }

        // ==========================================
        // üëã Welcome Modal Logic
        // ==========================================
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const content = document.getElementById('welcomeModalContent');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const content = document.getElementById('welcomeModalContent');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // ==========================================
        // üì¢ Telegram Notification
        // ==========================================
        async function notifyTelegram(pet) {
            if (!TELEGRAM_CHAT_ID) {
                 console.log('Telegram Notification skipped: No Chat ID');
                 return;
            }

            const message = `üì¢ *‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà*
            
üë§ *‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:* ${pet.ownername}
üè† *‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:* ${pet.houseno} (‡∏ã‡∏≠‡∏¢ ${pet.soi})
üê∂ *‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á:* ${pet.petname} (${pet.pettype})
üìû *‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:* ${pet.phone}
üïí *‡πÄ‡∏ß‡∏•‡∏≤:* ${new Date().toLocaleString('th-TH')}`;

            try {
                let url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
                let body = {};

                if (pet.image) {
                    url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto`;
                    body = {
                        chat_id: TELEGRAM_CHAT_ID,
                        photo: pet.image,
                        caption: message,
                        parse_mode: 'Markdown'
                    };
                } else {
                    body = {
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    };
                }

                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                console.log('Telegram notification sent');

            } catch (error) {
                console.error('Telegram Notification Error:', error);
            }
        }


        // ==========================================
        // ‚úèÔ∏è Edit & Delete Logic
        // ==========================================

        function editPet(id) {
            const pet = pets.find(p => p.id === id);
            if (!pet) return;

            editingPetId = id;
            existingImageUrl = pet.image;
            
            document.getElementById('ownerName').value = pet.ownername;
            document.getElementById('houseNo').value = pet.houseno;
            document.getElementById('soi').value = pet.soi;
            document.getElementById('phone').value = pet.phone;
            document.getElementById('petType').value = pet.pettype;
            document.getElementById('petName').value = pet.petname;

            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('uploadPlaceholder');
            const removeBtn = document.getElementById('removeImgBtn');

            if (pet.image) {
                preview.src = pet.image;
                preview.style.display = 'block';
                placeholder.classList.add('opacity-0');
                removeBtn.classList.remove('hidden');
            } else {
                removeImage(null);
            }

            document.getElementById('formTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á';
            document.getElementById('formBadge').innerText = 'Editing Mode';
            document.getElementById('formBadge').className = 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 border border-transparent dark:border-amber-500/30 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider';
            document.getElementById('submitBtnText').innerText = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('submitBtnIcon').className = 'fa-solid fa-save';
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            switchView('register');
        }

        function cancelEdit() {
            editingPetId = null;
            existingImageUrl = null;
            resetForm();
            
            document.getElementById('formTitle').innerText = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á';
            document.getElementById('formBadge').innerText = 'New Registration';
            document.getElementById('formBadge').className = 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 border border-transparent dark:border-emerald-500/30 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider';
            document.getElementById('submitBtnText').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('submitBtnIcon').className = 'fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        async function deletePet(id) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) return;
            setLoading(true);

            const { data: petData } = await supabaseClient
                .from('pets')
                .select('image')
                .eq('id', id)
                .single();

            if (petData && petData.image && petData.image.includes('/img/')) {
                try {
                    const urlParts = petData.image.split('/img/');
                    if (urlParts.length > 1) {
                        const filePath = urlParts[1];
                        await supabaseClient.storage.from('img').remove([filePath]);
                    }
                } catch (err) {
                    console.warn('Could not delete image file:', err);
                }
            }
            
            const { error } = await supabaseClient
                .from('pets')
                .delete()
                .eq('id', id);

            if (error) {
                showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
            } else {
                showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                fetchPets();
            }
            setLoading(false);
        }

        // ==========================================
        // üîÑ Data Operations
        // ==========================================

        async function fetchPets() {
            setLoading(true);
            const { data, error } = await supabaseClient
                .from('pets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching pets:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', true);
            } else {
                pets = data;
                renderPets(pets);
            }
            setLoading(false);
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        async function handleRegister(e) {
            e.preventDefault();

            // Validate Image
            if (!currentImageBase64 && !existingImageUrl) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á', true);
                document.getElementById('petImage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            setLoading(true);

            // 1. If logged in via LINE, save user first
            if (lineProfile) {
                try {
                    const { error: userError } = await supabaseClient
                        .from('users')
                        .upsert({
                            id: lineProfile.userId,
                            display_name: lineProfile.displayName,
                            picture_url: lineProfile.pictureUrl,
                            updated_at: new Date()
                        });
                    
                    if (userError) {
                        console.warn("Could not save LINE user to 'users' table. Make sure the table exists.", userError);
                    }
                } catch (err) {
                    console.warn("User save failed", err);
                }
            }

            let finalImageUrl = existingImageUrl; 

            // 2. Upload Image
            if (currentImageBase64) {
                try {
                    const blob = dataURLtoBlob(currentImageBase64);
                    const fileName = `pet-${Date.now()}-${Math.floor(Math.random() * 1000)}.jpg`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseClient
                        .storage
                        .from('img')
                        .upload(fileName, blob, { cacheControl: '3600', upsert: false });

                    if (uploadError) {
                        if(uploadError.message.includes('Bucket not found')) {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Bucket ‡∏ä‡∏∑‡πà‡∏≠ "img"\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Bucket ‡πÉ‡∏ô Supabase Storage ‡∏ä‡∏∑‡πà‡∏≠ "img" ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Public');
                            setLoading(false);
                            return; 
                        } else if (uploadError.message.includes('security policy') || uploadError.message.includes('new row violates')) {
                            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (RLS Policy)\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ: ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Supabase > Storage > Policies ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î New Policy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£ Insert');
                        } else {
                            throw uploadError;
                        }
                    } else {
                        const { data: { publicUrl } } = supabaseClient
                            .storage
                            .from('img')
                            .getPublicUrl(fileName);
                        
                        finalImageUrl = publicUrl;
                    }

                } catch (err) {
                    console.error('Upload Error Details:', err);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ' + err.message + '\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà');
                }
            }

            const petData = {
                ownername: document.getElementById('ownerName').value,
                houseno: document.getElementById('houseNo').value,
                soi: document.getElementById('soi').value || '-',
                phone: document.getElementById('phone').value,
                pettype: document.getElementById('petType').value,
                petname: document.getElementById('petName').value,
                image: finalImageUrl,
                line_user_id: lineProfile ? lineProfile.userId : null,
                line_name: lineProfile ? lineProfile.displayName : null // --- Added LINE Name storage ---
            };

            let error;

            if (editingPetId) {
                // UPDATE
                const response = await supabaseClient
                    .from('pets')
                    .update(petData)
                    .eq('id', editingPetId);
                error = response.error;
            } else {
                // INSERT
                const response = await supabaseClient
                    .from('pets')
                    .insert([petData]);
                error = response.error;
                
                // üîî Notify Telegram only on NEW registration
                if (!error) {
                    notifyTelegram(petData);
                }
            }

            if (error) {
                console.error('Error saving:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, true);
            } else {
                showToast(editingPetId ? '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                cancelEdit(); 
                await fetchPets();
            }
            setLoading(false);
        }

        // ==========================================
        // üñºÔ∏è Image & Render
        // ==========================================
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 10 * 1024 * 1024) {
                    showToast('‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB)', true);
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        currentImageBase64 = compressedDataUrl;

                        const preview = document.getElementById('preview');
                        const placeholder = document.getElementById('uploadPlaceholder');
                        const removeBtn = document.getElementById('removeImgBtn');
                        preview.src = compressedDataUrl;
                        preview.style.display = 'block';
                        placeholder.classList.add('opacity-0');
                        removeBtn.classList.remove('hidden');
                    };
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage(e) {
            if(e) e.stopPropagation();
            document.getElementById('petImage').value = '';
            currentImageBase64 = null;
            
            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('uploadPlaceholder');
            const removeBtn = document.getElementById('removeImgBtn');
            preview.style.display = 'none';
            preview.src = '';
            placeholder.classList.remove('opacity-0');
            removeBtn.classList.add('hidden');
        }

        function resetForm() {
            document.getElementById('petForm').reset();
            removeImage(null);
            currentImageBase64 = null;
        }

        function renderPets(data) {
            // Update Summary
            const summaryEl = document.getElementById('summarySection');
            const total = data.length;
            const dogs = data.filter(p => p.pettype === '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç').length;
            const cats = data.filter(p => p.pettype === '‡πÅ‡∏°‡∏ß').length;
            const birds = data.filter(p => p.pettype === '‡∏ô‡∏Å').length;
            const others = total - (dogs + cats + birds);

            // Generate Summary HTML with adaptive colors
            summaryEl.innerHTML = `
                <div class="summary-card bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between" style="--tw-gradient-from: #10b981; --tw-gradient-to: #34d399;">
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <h4 class="text-3xl font-bold text-slate-800 dark:text-white">${total}</h4>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                </div>
                <div class="summary-card bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between" style="--tw-gradient-from: #f97316; --tw-gradient-to: #fdba74;">
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</p>
                        <h4 class="text-3xl font-bold text-slate-800 dark:text-white">${dogs}</h4>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center">
                        <i class="fa-solid fa-dog"></i>
                    </div>
                </div>
                <div class="summary-card bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between" style="--tw-gradient-from: #3b82f6; --tw-gradient-to: #93c5fd;">
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">‡πÅ‡∏°‡∏ß</p>
                        <h4 class="text-3xl font-bold text-slate-800 dark:text-white">${cats}</h4>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center">
                        <i class="fa-solid fa-cat"></i>
                    </div>
                </div>
                <div class="summary-card bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between" style="--tw-gradient-from: #8b5cf6; --tw-gradient-to: #c4b5fd;">
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
                        <h4 class="text-3xl font-bold text-slate-800 dark:text-white">${birds + others}</h4>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 flex items-center justify-center">
                        <i class="fa-solid fa-paw"></i>
                    </div>
                </div>
            `;

            const grid = document.getElementById('petGrid');
            const empty = document.getElementById('emptyState');
            const count = document.getElementById('count');
            
            grid.innerHTML = '';
            count.innerText = data.length;

            if (data.length === 0) {
                empty.classList.remove('hidden');
                return;
            } else {
                empty.classList.add('hidden');
            }

            data.forEach((pet, index) => {
                // Adaptive colors for tags
                let typeColor = 'bg-slate-100 text-slate-600 border border-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-600';
                if(pet.pettype === '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç') typeColor = 'bg-orange-50 text-orange-600 border border-orange-100 dark:bg-orange-900/40 dark:text-orange-200 dark:border-orange-700/50';
                else if(pet.pettype === '‡πÅ‡∏°‡∏ß') typeColor = 'bg-blue-50 text-blue-600 border border-blue-100 dark:bg-blue-900/40 dark:text-blue-200 dark:border-blue-700/50';
                else if(pet.pettype === '‡∏ô‡∏Å') typeColor = 'bg-sky-50 text-sky-600 border border-sky-100 dark:bg-sky-900/40 dark:text-sky-200 dark:border-sky-700/50';

                const displayImage = pet.image || 'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60';
                const dateObj = new Date(pet.created_at);
                const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const delay = index < 8 ? `animation-delay: ${index * 50}ms` : '';

                // Admin Buttons
                const adminControls = isAdmin ? `
                    <div class="absolute top-3 right-3 flex gap-2 z-10">
                        <button onclick="editPet(${pet.id})" class="bg-white/90 hover:bg-white dark:bg-black/50 dark:hover:bg-black/70 text-amber-500 hover:text-amber-600 dark:text-amber-400 dark:hover:text-amber-300 w-8 h-8 rounded-full backdrop-blur-md flex items-center justify-center shadow-sm transition-all transform hover:scale-110 border border-transparent dark:border-white/10">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="deletePet(${pet.id})" class="bg-white/90 hover:bg-white dark:bg-black/50 dark:hover:bg-black/70 text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 w-8 h-8 rounded-full backdrop-blur-md flex items-center justify-center shadow-sm transition-all transform hover:scale-110 border border-transparent dark:border-white/10">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                ` : '';

                const card = `
                    <div class="bg-white dark:bg-dark-card rounded-3xl p-3 shadow-sm dark:shadow-lg hover:shadow-xl dark:hover:shadow-2xl dark:hover:shadow-black/20 transition-all duration-300 border border-slate-100 dark:border-slate-700 group fade-in flex flex-col relative" style="${delay}">
                        <div class="relative h-48 rounded-2xl overflow-hidden bg-slate-100 dark:bg-slate-900 mb-3 shrink-0 cursor-zoom-in" onclick="openImageModal('${displayImage}')">
                            <img src="${displayImage}" alt="${pet.petname}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 dark:opacity-90 group-hover:opacity-100">
                            <div class="absolute top-3 left-3">
                                <span class="${typeColor} text-xs font-bold px-3 py-1.5 rounded-full shadow-sm backdrop-blur-md">
                                    ${pet.pettype}
                                </span>
                            </div>
                            <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/30 dark:bg-black/50 text-white text-xs px-2 py-1 rounded-md backdrop-blur-sm pointer-events-none border border-transparent dark:border-white/10">
                                <i class="fa-solid fa-magnifying-glass-plus mr-1"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ
                            </div>
                            ${adminControls}
                        </div>
                        
                        <div class="px-2 pb-2 flex-1 flex flex-col">
                            <div class="flex justify-between items-end mb-3">
                                <h3 class="text-xl font-bold text-slate-800 dark:text-white leading-none truncate pr-2">${pet.petname}</h3>
                                <div class="text-right shrink-0">
                                    <span class="text-[10px] text-slate-400 dark:text-slate-500 block">${dateStr}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 mt-auto border border-transparent dark:border-slate-700/50">
                                <!-- Owner -->
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-500 flex items-center justify-center shrink-0 mt-0.5">
                                        <i class="fa-solid fa-user text-xs"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</p>
                                        <p class="text-sm font-medium text-slate-700 dark:text-slate-200">${pet.ownername}</p>
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-500 flex items-center justify-center shrink-0 mt-0.5">
                                        <i class="fa-solid fa-map-location-dot text-xs"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</p>
                                        <p class="text-sm font-medium text-slate-700 dark:text-slate-200">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${pet.houseno} <span class="text-slate-400 mx-1">|</span> ‡∏ã‡∏≠‡∏¢ ${pet.soi}</p>
                                    </div>
                                </div>

                                <!-- Phone -->
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 rounded-lg bg-rose-100 dark:bg-rose-900/30 text-rose-500 flex items-center justify-center shrink-0 mt-0.5">
                                        <i class="fa-solid fa-phone text-xs"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</p>
                                        <a href="tel:${pet.phone}" class="text-sm font-medium text-slate-700 dark:text-slate-200 hover:text-primary transition">${pet.phone}</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        function filterPets() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = pets.filter(pet => {
                return (pet.ownername && pet.ownername.toLowerCase().includes(query)) || 
                       (pet.houseno && pet.houseno.toLowerCase().includes(query)) ||
                       (pet.petname && pet.petname.toLowerCase().includes(query));
            });
            renderPets(filtered);
        }

        function setLoading(isLoading) {
            const overlay = document.getElementById('loadingOverlay');
            if(isLoading) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            const iconContainer = document.getElementById('toastIcon');
            
            if (!msg || !iconContainer) return;

            msg.innerText = message;
            
            if(isError) {
                iconContainer.className = 'bg-red-500 rounded-full p-1';
                iconContainer.innerHTML = '<i class="fa-solid fa-exclamation text-xs text-white"></i>';
            } else {
                iconContainer.className = 'bg-emerald-500 rounded-full p-1';
                iconContainer.innerHTML = '<i class="fa-solid fa-check text-xs text-white"></i>';
            }

            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-32', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
