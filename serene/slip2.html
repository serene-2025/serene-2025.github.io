<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1571/1571031.png" type="image/png">

  <!-- Import Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Boxicons (Modern Icons) -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CSS Style -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');

    /* --- Theme Variables --- */
    :root {
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-color: #333333;
        --text-muted: #6c757d;
        --input-bg: #ffffff;
        --input-border: #ced4da;
        --input-text: #212529;
        --modal-bg: #ffffff;
        --table-head-bg: #e9ecef;
        --table-row-hover: #f2f2f2;
        --table-text: #212529;
        --table-border: #dee2e6;
        --alert-bg-light: #f8f9fa;
    }

    body.dark-mode {
        --bg-color: #18191a;
        --card-bg: #242526;
        --text-color: #e4e6eb;
        --text-muted: #b0b3b8;
        --input-bg: #3a3b3c;
        --input-border: #505153;
        --input-text: #e4e6eb;
        --modal-bg: #242526;
        --table-head-bg: #3a3b3c;
        --table-row-hover: #303031;
        --table-text: #e4e6eb;
        --table-border: #444444;
        --alert-bg-light: #242526;
    }

    * {
      font-family: 'Kanit', sans-serif;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Override Bootstrap Components for Dark Mode */
    .bg-white {
        background-color: var(--card-bg) !important;
        color: var(--text-color);
    }

    .form-control, .form-select {
        background-color: var(--input-bg);
        border-color: var(--input-border);
        color: var(--input-text);
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--input-bg);
        color: var(--input-text);
        border-color: #0f9b0f;
        box-shadow: 0 0 0 0.25rem rgba(15, 155, 15, 0.25);
    }
    
    .form-control::placeholder {
        color: var(--text-muted);
    }

    .card {
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    .bg-light {
        background-color: var(--alert-bg-light) !important;
        color: var(--text-color);
    }

    .table {
        color: var(--table-text);
        border-color: var(--table-border);
    }
    
    .table thead th {
        background-color: var(--table-head-bg);
        border-color: var(--table-border);
        color: var(--text-color);
    }
    
    .table tbody td {
        background-color: var(--card-bg);
        border-color: var(--table-border);
        color: var(--table-text);
    }

    .table-striped > tbody > tr:nth-of-type(odd) > * {
         background-color: rgba(0, 0, 0, 0.05);
         color: var(--table-text);
    }

    body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * {
         background-color: rgba(255, 255, 255, 0.05);
    }

    .modal-content {
        background-color: var(--modal-bg);
        color: var(--text-color);
    }

    .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    body.dark-mode .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    body:not(.dark-mode) .modal-header .btn-close {
         filter: none;
    }
    
    .text-muted {
        color: var(--text-muted) !important;
    }

    /* --- Custom Styles --- */
    .card-shadow {
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: none;
    }

    /* Modern Icon Styles */
    .icon-modern {
        font-size: 1.4rem;
        margin-right: 8px;
        vertical-align: text-bottom;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        transition: transform 0.2s;
    }
    
    .form-label:hover .icon-modern {
        transform: scale(1.1);
    }

    .input-box {
      margin-bottom: 2%;
    }

    /* Table Styles */
    .table-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
    }

    .table-responsive {
      overflow-x: auto;
      font-size: 14px;
    }

    #dataTable th,
    #dataTable td {
      width: auto;
      white-space: nowrap;
      padding: 8px;
      vertical-align: middle;
    }

    strong {
      display: inline-block;
      margin: 0;
      font-size: 1.5rem;
      padding: 2px 5px;
      border-radius: 3px;
      background-color: #eaeaea;
      color: #b9316f;
      font-weight: 600;
    }
    
    body.dark-mode strong {
        background-color: #4a4a4a;
        color: #ff85b3;
    }

    /* Animation for the unpaid status box */
    .fade-in {
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-gradient {
        background: linear-gradient(45deg, #198754, #20c997);
        border: none;
        color: white;
    }
    .btn-gradient:hover {
        background: linear-gradient(45deg, #157347, #1ba87e);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(32, 201, 151, 0.4);
    }

    /* Theme Toggle Button */
    .theme-toggle-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 1050;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: var(--card-bg);
        border: 1px solid var(--input-border);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }
    
    .theme-toggle-btn:hover {
        transform: scale(1.05);
    }
    
    .theme-toggle-btn i {
        font-size: 1.5rem;
        color: var(--text-color);
        transition: transform 0.3s ease;
    }
    
    /* Sun/Moon rotation animation */
    .rotate-icon {
        transform: rotate(360deg);
    }
  </style>
</head>

<body>
  <!-- Theme Toggle Button -->
  <div class="theme-toggle-btn" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á">
      <i class='bx bxs-moon'></i>
  </div>

  <div class="container-fluid mb-4 pt-3">
    <div class="col-md-8 mx-auto bg-white p-4 rounded card-shadow">
      <form class="needs-validation" novalidate id="user_form" onsubmit="getAllElmForm(this)">
        <div class="col-md-12 text-center mb-4">
          <h4 class="mb-2 p-3 text-white rounded shadow-sm" style="background: linear-gradient(to right, #0f9b0f, #52c234);">
            <i class='bx bxs-buildings fs-3'></i> üí¥ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á Serene 
          </h4>
        </div>

        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold">
            <i class='bx bxs-user-detail text-primary icon-modern'></i> 
            ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à <span style="color: red;">*</span>
          </label>
          <input type="text" class="form-control" id="name" name="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
        </div>
        
        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold">
            <i class='bx bxs-home-smile text-success icon-modern'></i> 
            ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span style="color: red;">*</span>
          </label>
          <input type="text" class="form-control" id="name1" name="name1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 999/99" required>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                <i class='bx bxs-calendar text-warning icon-modern'></i> 
                ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span>
              </label>
              <select class="form-select" id="name2" name="name2" required>
                <option selected disabled value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
                <option>‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                <option>‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                <option>‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                <i class='bx bxs-calendar-star text-warning icon-modern'></i> 
                ‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span>
              </label>
              <select class="form-select" id="name3" name="name3" required>
                <option selected disabled value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>
                <option>2567</option>
                <option>2568</option>
                <option>2569</option>
                <option>2570</option>
                <option>2571</option>
              </select>
            </div>
        </div>

        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold">
            <i class='bx bxs-wallet-alt text-info icon-modern'></i> 
            ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span>
          </label>
          <div class="d-flex gap-3 ps-2">
              <div class="form-check">
                  <input type="radio" class="form-check-input" id="pay_transfer" name="name4" value="‡πÇ‡∏≠‡∏ô" required checked>
                  <label class="form-check-label" for="pay_transfer"><i class='bx bx-transfer'></i> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
              </div>
              <div class="form-check">
                  <input type="radio" class="form-check-input" id="pay_cash" name="name4" value="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î" required>
                  <label class="form-check-label" for="pay_cash"><i class='bx bx-money'></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
              </div>
          </div>
        </div>

        <div class="col-md-12 col-12 mb-3">
          <label class="form-label fw-bold">
            <i class='bx bxs-camera-plus text-danger icon-modern'></i> 
            ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (‡∏™‡∏•‡∏¥‡∏õ) <span style="color: red;">*</span>
          </label>
          <input type="file" class="form-control" id="file_image" name="file_image" onchange="fileValidation()" accept="image/*" required>
        </div>
        
        <div class="input-box text-center" id="imgbox">
            <img id="picdata" src="" class="img-fluid rounded shadow-sm border" style="display:none; max-height: 300px;">
            <p class="mt-2 text-muted small" id="file_input_help"></p>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class='bx bxs-edit-alt text-secondary icon-modern'></i> 
            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) 
          </label>
          <textarea class="form-control" id="name5" name="name5" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>

        <button type="submit" id="btn_1" class="btn btn-secondary btn-lg w-100 rounded shadow transition-all" disabled>
          <i class='bx bxs-save'></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button class="btn btn-lg w-100 btn-light text-success border" style="display: none;" type="button" id="btn_2" disabled>
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </button>
      </form>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -->
      <div id="unpaidStatusContainer" class="mt-4 fade-in" style="display:none;">
        <div class="card border-danger shadow-sm">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fs-6"><i class='bx bxs-error-circle'></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span id="statusHouseNo"></span>)</h5>
                <span class="badge bg-white text-danger" id="totalCountBadge">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th class="py-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="py-2">‡∏õ‡∏µ</th>
                                <th class="py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="unpaidStatusBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="p-2 text-center bg-light border-top">
                    <div class="mb-1"><small class="text-danger fw-bold">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</small></div>
                    <div><small class="text-muted fw-bold">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà</small></div>
                </div>
            </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12 text-center">
          <div class="alert alert-warning shadow-sm" role="alert">
            <i class='bx bxs-comment-error fs-5 align-middle me-1'></i> <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏¥‡∏•‡∏•‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
          </div>
          
          <div class="card bg-light border-0 mt-3">
              <div class="card-body">
                  <h6 class="text-primary fw-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h6>
                  <p class="small text-muted mb-0">
                    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö Real-time<br>
                    ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a class="text-decoration-none fw-bold" href="https://line.me/ti/p/OZwGJgp1Qq" target="_blank">
                        <i class='bx bxl-line text-success fs-5 align-middle'></i> Line Admin
                    </a>
                  </p>
              </div>
          </div>
        </div>
      </div>
      
      <div class="text-center mt-4 text-muted small">
          9one ¬© 2024 V.4
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Main Script -->
  <script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbz6Ua9LYQikcgL8OcT3CkEcxfxQNFctPZ1fg5dDP6WTRQEZpvklObLufFFx2a-XBeruYw/exec";

    // --- Supabase Configuration ---
    const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Supabase Client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global variables for LIFF profile
    let uid = ""; 
    let uname = ""; 
    let picture = ""; 
    let xos = ""; 
    let emailL = "";

    $(document).ready(function() {
      const liffId = "2008964543-QdqO2fMF";
      
      // Load saved theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
          const icon = document.querySelector('.theme-toggle-btn i');
          icon.classList.remove('bxs-moon');
          icon.classList.add('bxs-sun');
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
      initializeLiff(liffId);
    });

    // Toggle Theme Function
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const icon = document.querySelector('.theme-toggle-btn i');
        
        // Add rotation animation
        icon.classList.add('rotate-icon');
        setTimeout(() => icon.classList.remove('rotate-icon'), 300);

        if (document.body.classList.contains('dark-mode')) {
            icon.classList.remove('bxs-moon');
            icon.classList.add('bxs-sun');
            localStorage.setItem('theme', 'dark');
        } else {
            icon.classList.remove('bxs-sun');
            icon.classList.add('bxs-moon');
            localStorage.setItem('theme', 'light');
        }
    }

    function initializeLiff(liffId) {
      liff
        .init({
          liffId: liffId,
          withLoginOnExternalBrowser: true
        })
        .then(async () => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£ Login
          if (!liff.isInClient() && !liff.isLoggedIn()) {
             // window.alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
             const destinationUrl = window.location.href;
             liff.login({ redirectUri: destinationUrl });
          } else {
             // ‡∏î‡∏∂‡∏á UID ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏à‡∏≤‡∏Å decoded token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
             const idToken = liff.getDecodedIDToken();
             if (idToken) {
                 uid = idToken.sub;
                 emailL = idToken.email;
             }
          }
          
          const urlParms = new URLSearchParams(window.location.search)
          id = urlParms.get('id')

          // Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          if (id) {
             await reloadData(id)
          } 
          
          await Dropdown()
          sessionStorage.setItem('idProduct', JSON.stringify(id));

          liff.getProfile().then(function(profile) {
            uid = profile.userId;
            uname = profile.displayName;
            picture = profile.pictureUrl;
            // xos = liff.getOS(); // ‡∏ö‡∏≤‡∏á version ‡∏Ç‡∏≠‡∏á LIFF ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ deprecated
          }).catch(err => console.error("Get Profile Error:", err));
        })
        .catch((err) => {
          console.log('LIFF Initialization failed ', err);
        });
    }

    // --- Function ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (Supabase) ---
    async function checkUnpaidStatus(houseNumber) {
      const container = document.getElementById('unpaidStatusContainer');
      const tableBody = document.getElementById('unpaidStatusBody');
      
      if(!houseNumber || houseNumber.length < 2) {
          container.style.display = 'none';
          return;
      }

      console.log("Checking status for:", houseNumber);

      try {
        const { data, error } = await supabaseClient
          .from('house_payments')
          .select('*')
          .eq('house_numbe', houseNumber); 

        if (error) {
          console.error("Supabase Error:", error);
          container.style.display = 'none';
          return;
        }

        let totalUnpaidCount = 0;
        tableBody.innerHTML = ''; 

        if (data && data.length > 0) {
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

            data.forEach(row => {
                months.forEach((monthKey, index) => {
                    const status = row[monthKey];
                    if (status && (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢' || status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢')) {
                        totalUnpaidCount++;
                        const rowHtml = `
                          <tr>
                            <td class="align-middle">${thaiMonths[index]}</td>
                            <td class="align-middle">${row.year || '-'}</td>
                            <td class="align-middle"><span class="badge bg-danger rounded-pill">${status}</span></td>
                          </tr>
                        `;
                        tableBody.innerHTML += rowHtml;
                    }
                });
            });
        }

        if (totalUnpaidCount > 0) {
            document.getElementById('statusHouseNo').innerText = houseNumber;
            document.getElementById('totalCountBadge').innerText = totalUnpaidCount + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            container.style.display = 'block';
        } else {
            console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà " + houseNumber);
            container.style.display = 'none';
        }

      } catch (err) {
        console.error("Check Status Failed:", err);
        container.style.display = 'none';
      }
    }

    function sendFlexMessage(uid, uname, picture, name, name1, name2, name3, uploadedImageUrl) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE App ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!liff.isInClient()) {
         console.warn("sendFlexMessage: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE App (‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Browser) ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á Flex Message ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
         return; 
      }

      // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠ Default
      const displayImage = uploadedImageUrl || picture || "https://cdn-icons-png.flaticon.com/512/1571/1571031.png";

      const flexMessage = {
        type: "flex",
        altText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        contents: {
          "type": "bubble",
          "hero": {
            "type": "image",
            "url": displayImage, // ‡πÉ‡∏ä‡πâ URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Server (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            "size": "full",
            "aspectRatio": "20:13",
            "aspectMode": "cover",
            "action": {
              "type": "uri",
              "uri": "https://liff.line.me/2000143615-7xXDlXpx"
            }
          },
          "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "üí¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
                "weight": "bold",
                "size": "xl"
              },
              {
                "type": "box",
                "layout": "vertical",
                "margin": "lg",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "flex": 2
                      },
                      {
                        "type": "text",
                        "text": "" + new Date().toLocaleString('th-TH'),
                        "wrap": true,
                        "color": "#666666",
                        "size": "xs",
                        "flex": 5
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "flex": 2
                      },
                      {
                        "type": "text",
                        "text": "" + (uname || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"),
                        "wrap": true,
                        "color": "#666666",
                        "size": "xs",
                        "flex": 5
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "Uid : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "flex": 2
                      },
                      {
                        "type": "text",
                        "text": "" + uid,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5
                      }
                    ]
                  },
                  {
                    "type": "separator"
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "ü§µ‚Äç‚ôÇÔ∏è ‡∏ä‡∏∑‡πà‡∏≠ : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "wrap": true,
                        "flex": 3,
                        "margin": "md",
                        "gravity": "center"
                      },
                      {
                        "type": "text",
                        "text": "" + name,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5,
                        "align": "end",
                        "gravity": "center"
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "üè° ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "wrap": true,
                        "flex": 3,
                        "margin": "md",
                        "gravity": "center"
                      },
                      {
                        "type": "text",
                        "text": "" + name1,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5,
                        "align": "end",
                        "gravity": "center"
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "üìÜ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "wrap": true,
                        "flex": 3,
                        "margin": "md",
                        "gravity": "center"
                      },
                      {
                        "type": "text",
                        "text": "" + name2,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5,
                        "align": "end",
                        "gravity": "center"
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "üóì ‡∏õ‡∏µ : ",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "wrap": true,
                        "flex": 3,
                        "margin": "md",
                        "gravity": "center"
                      },
                      {
                        "type": "text",
                        "text": "" + name3,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5,
                        "align": "end",
                        "gravity": "center"
                      }
                    ]
                  },
                  {
                    "type": "separator"
                  },
                  {
                    "type": "text",
                    "text": " ",
                    "wrap": true,
                    "size": "xs",
                    "color": "#8C8C8C",
                    "contents": [
                      {
                        "type": "span",
                        "text": "‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
                      }
                    ]
                  },
                  {
                    "type": "text",
                    "text": " ",
                    "wrap": true,
                    "size": "xs",
                    "color": "#8C8C8C",
                    "contents": [
                      {
                        "type": "span",
                        "text": "‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ : ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"
                      }
                    ]
                  },
                ]
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "vertical",
            "spacing": "sm",
            "contents": [
              {
                "type": "button",
                "style": "primary",
                "height": "sm",
                "action": {
                  "type": "uri",
                  "label": "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                  "uri": "https://liff.line.me/2000143615-7xXDlXpx"
                }
              },
              {
                "type": "box",
                "layout": "vertical",
                "contents": [],
                "margin": "sm"
              }
            ],
            "flex": 0
          }
        }
      };

      liff
        .sendMessages([flexMessage])
        .then(() => console.log("FlexMessage sent to", uid))
        .catch((err) => console.error("Error sending FlexMessage:", err));
    }

    /**‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á */
    function preventFormSubmit() {
      var forms = document.querySelectorAll("form");
      for (var i = 0; i < forms.length; i++) {
        forms[i].addEventListener("submit", function(event) {
          event.preventDefault();
        });
      }
    }
    window.addEventListener("load", preventFormSubmit);

    /** ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå */
    async function reloadData(id) {
        Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà <strong></strong> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ.',
        timer: 5000,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading()
          const b = Swal.getHtmlContainer().querySelector('strong')
          timerInterval = setInterval(() => {
            b.textContent = (Swal.getTimerLeft() / 1000).toFixed(0)
          }, 100)
        },
        willClose: () => {
          clearInterval(timerInterval)
        }
      }).then((result) => {
        if (result.dismiss === Swal.DismissReason.timer) {
          console.log('I was closed by the timer')
        }
      })

      const obj = {};
      obj.uid = id
      const formData = JSON.stringify(obj);

      let config = {
        method: "post",
        maxBodyLength: Infinity,
        url: `${urlAPI}?action=loadDataRegister`,
        headers: {},
        data: formData,
        mode: 'no-cors',
      };

      axios
        .request(config)
        .then((response) => {
          const msgResponse = response.data;
          const datareturn = msgResponse.data.split(",")

          if (msgResponse.msg == "SUCCESS") {
            $('#databox').removeClass('d-none');
            $("#picdataRe").attr("src", datareturn[9]);
            $("#idR").html(idR)
            $("#nameR").html(nameR)
            $("#detailR").html(detailR)
          } else {
            Swal.fire({
              title: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: `${msgResponse.msg}`,
              icon: 'error',
              showCancelButton: false,
              confirmButtonColor: '#d33',
              confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            }).then((result) => {
              if (result.isConfirmed) {
                // liff.closeWindow()
              }
            })
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    //‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown 
    async function Dropdown() {
      try {
        $.ajax({
          url: `${urlAPI}?type=namelist`,
          type: 'GET',
          dataType: 'json', 
          success: function(res) {
            dropdownListlevel(res)
          }
        });
      } catch (error) {
        console.error(error);
      }
    }

    /** Function ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å - Restore ‡∏à‡∏≤‡∏Å script.js ‡πÄ‡∏î‡∏¥‡∏° */
    function getAllElmForm(data) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UID ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      if (!uid) {
         // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á UID ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å context (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î)
         if(liff.isLoggedIn()){
             const idToken = liff.getDecodedIDToken();
             if(idToken) uid = idToken.sub;
         }
      }

      const name = document.getElementById("name").value;
      const name1 = document.getElementById("name1").value;
      const name2 = document.getElementById("name2").value;
      const name3 = document.getElementById("name3").value;

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        html: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà <strong></strong> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ.',
        timer: 10000,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading()
          const b = Swal.getHtmlContainer().querySelector('strong')
          timerInterval = setInterval(() => {
            b.textContent = (Swal.getTimerLeft() / 1000).toFixed(0)
          }, 100)
        },
        willClose: () => {
          clearInterval(timerInterval)
        }
      }).then((result) => {
        if (result.dismiss === Swal.DismissReason.timer) {
          console.log('I was closed by the timer')
        }
      })

      const form = document.getElementById("user_form");

      $("#btn_1").hide();
      $("#btn_2").show();
      var obj = {};
      var data = new FormData();

      var all = document.querySelectorAll(
        "#user_form input, #user_form select, #user_form textarea"
      );

      for (let field of all) {
        if (field.type != "button" && field.type != "submit") {
          if (field.type == "radio" || field.type == "checkbox") {
            if (field.checked) {
              data.append(field.name, field.value);
            }
          } else {
            data.append(field.name, field.value);
          }
        }
      }
      for (let [key, val] of data.entries()) {
        obj[key] = val;
      }

      obj.imageFile = document.getElementById("picdata").src
      obj.uid = uid || "No-UID"; // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ No-UID ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á client
      const formData = JSON.stringify(obj);
      console.log("Saving Data with Payload:", formData);

      let config = {
        method: "post",
        maxBodyLength: Infinity,
        url: `${urlAPI}?action=saveDataNew`,
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Content-Type: text/plain ‡πÅ‡∏•‡∏∞‡∏•‡∏ö no-cors
        headers: { "Content-Type": "text/plain" },
        data: formData,
        // mode: 'no-cors', // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ axios ‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏î‡πâ
      };

      axios
        .request(config)
        .then((response) => {
          const msgResponse = response.data;
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
          console.log("Server Response:", msgResponse);
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ msgResponse ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏µ status SUCCESS
          // GAS ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON
          if (msgResponse && msgResponse.msg == "SUCCESS") {
             handleSuccess(msgResponse);
          } else if (typeof msgResponse === 'string' && msgResponse.includes("SUCCESS")) {
             // ‡∏Å‡∏£‡∏ì‡∏µ GAS ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô string (‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
             try {
                const parsed = JSON.parse(msgResponse);
                if(parsed.msg == "SUCCESS") handleSuccess(parsed);
                else handleError(parsed);
             } catch(e) {
                // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ SUCCESS ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
                handleSuccess({ msg: "SUCCESS" });
             }
          } else {
             // ‡∏ñ‡πâ‡∏≤ response status 200 ‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ body ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
             // ‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡∏ß‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ error ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
             // ‡πÅ‡∏ï‡πà code ‡πÄ‡∏î‡∏¥‡∏° check msgResponse.msg ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏£ handle error
             handleError(msgResponse);
          }
        })
        .catch(err => {
            console.error("Axios Error:", err);
            handleError({ msg: "Connection Error: " + err.message });
        });

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
      function handleSuccess(msgResponse) {
        $("#btn_2").hide();
        $("#btn_1").show();
        $('#picdata').hide()
        $("#picdata").attr("src", "")
        $("#file_input_help").html("")
        document.getElementById("user_form").reset();
        document
          .getElementsByClassName("needs-validation")[0]
          .classList.remove("was-validated");

        // ‡∏£‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å msgResponse ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ key ‡∏Ñ‡∏∑‡∏≠ link ‡∏´‡∏£‡∏∑‡∏≠ url)
        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ undefined ‡πÅ‡∏•‡∏∞ sendFlexMessage ‡∏à‡∏∞‡πÑ‡∏õ‡πÉ‡∏ä‡πâ logic fallback ‡πÄ‡∏î‡∏¥‡∏°
        const uploadedUrl = msgResponse.link || msgResponse.url;
        console.log("Image URL for Flex:", uploadedUrl);

        // ‡∏™‡πà‡∏á Flex Message ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        sendFlexMessage(uid, uname, picture, name, name1, name2, name3, uploadedUrl);

        Swal.fire({
          title: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
          text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
          icon: 'success',
          showCancelButton: false,
          confirmButtonColor: '#3085d6',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then(async (result) => {
          if (result.isConfirmed) {
            reloadData(msgResponse.id)
            liff.closeWindow()
          }
        })
      }

      function handleError(msgResponse) {
        $("#btn_2").hide();
        $("#btn_1").show();
        $('#picdata').hide()
        $("#picdata").attr("src", "")
        $("#file_input_help").html("")
        document
          .getElementsByClassName("needs-validation")[0]
          .classList.remove("was-validated");

        Swal.fire({
          title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: `${msgResponse ? msgResponse.msg : "Unknown Error"}`,
          icon: 'error',
          showCancelButton: false,
          confirmButtonColor: '#d33',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then((result) => {
          if (result.isConfirmed) {
            //liff.closeWindow()
          }
        })
      }
    }

    // Upload & Preview Image
    let imgupload = document.getElementById('file_image');
    imgupload.addEventListener('change', function(e) {
      if (e.target.files[0]) {
        let imageVal = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
             document.getElementById("picdata").src = e.target.result;
             document.getElementById('picdata').style.display = 'block';
        }
        reader.readAsDataURL(imageVal);
      } else {
        document.getElementById("picdata").src = "";
        document.getElementById('picdata').style.display = 'none';
      }
    });

    // Validation
    function fileValidation() {
      var fileInput = document.querySelector("#file_image");
      var filePath = fileInput.value;
      var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;

      if(fileInput.files.length > 0){
          var iConvert = (fileInput.files[0].size / (1024 * 1024)).toFixed(2);
          let txt = "‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå: " + iConvert + " MB";
          $("#file_input_help").html(txt)
    
          if (fileInput.files[0].size > 3 * 1048576) {
            Swal.fire({ position: 'top', icon: 'info', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô !', text: '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 mb' });
            fileInput.value = '';
            document.getElementById('picdata').style.display = 'none';
          } else if (!allowedExtensions.exec(filePath)) {
            Swal.fire({ position: 'top', icon: 'error', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!!', showConfirmButton: false, timer: 1500 });
            fileInput.value = '';
            document.getElementById('picdata').style.display = 'none';
          }
      }
    }

    (function() {
      "use strict";
      var forms = document.querySelectorAll(".needs-validation");
      Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener("submit", function(event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
              Swal.fire({ title: "‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", icon: "warning", confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á" });
            }
            form.classList.add("was-validated");
          }, false);
      });
    })();

    // Form Validity Check Realtime
    function checkFormValidity() {
      const name = document.getElementById('name').value;
      const name1 = document.getElementById('name1').value;
      const name2 = document.getElementById('name2').value;
      const name3 = document.getElementById('name3').value;
      const file_image = document.getElementById('file_image').value;
      const name4 = document.querySelector('input[name="name4"]:checked');

      const btn = document.getElementById('btn_1');
      if (name && name1 && name2 && name3 && file_image && name4) {
        btn.disabled = false;
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-gradient'); // Change to modern gradient class
      } else {
        btn.disabled = true;
        btn.classList.remove('btn-gradient');
        btn.classList.add('btn-secondary');
      }
    }

    document.getElementById('name').addEventListener('input', checkFormValidity);
    document.getElementById('name1').addEventListener('input', checkFormValidity);
    document.getElementById('name2').addEventListener('change', checkFormValidity);
    document.getElementById('name3').addEventListener('change', checkFormValidity);
    document.getElementById('file_image').addEventListener('change', checkFormValidity);
    document.querySelectorAll('input[name="name4"]').forEach(radio => {
      radio.addEventListener('change', checkFormValidity);
    });

    // --- Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ---
    let debounceTimer; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    document.getElementById('name1').addEventListener('input', function() {
        const houseNo = this.value;
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timer ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏±‡∏ß‡πÜ)
        clearTimeout(debounceTimer);
        
        // ‡∏ï‡∏±‡πâ‡∏á timer ‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        debounceTimer = setTimeout(() => {
            checkUnpaidStatus(houseNo);
        }, 1000); 
    });

    // Load/Save LocalStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedName = localStorage.getItem('name');
      const savedHouseNumber = localStorage.getItem('name1');

      if (savedName) document.getElementById('name').value = savedName;
      if (savedHouseNumber) {
          document.getElementById('name1').value = savedHouseNumber;
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
          checkUnpaidStatus(savedHouseNumber);
      }

      checkFormValidity();
    });

    document.getElementById('user_form').addEventListener('submit', function(event) {
       const name = document.getElementById('name').value;
       const houseNumber = document.getElementById('name1').value;
       localStorage.setItem('name', name);
       localStorage.setItem('name1', houseNumber);
    });
  </script>
</body>
</html>
