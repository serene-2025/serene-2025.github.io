<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Kanit', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .card-hover {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .month-card {
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .status-advance { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .status-exempt { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .status-contact-admin { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        

        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .month-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .month-card {
                padding: 8px 6px;
                font-size: 0.7rem;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20"></div>
        <div class="relative container mx-auto px-6 py-12 text-center">
            <div class="mb-8">
                <i class="fas fa-home text-6xl text-white mb-4 opacity-90"></i>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
                </h1>
                <p class="text-xl text-white/80 max-w-2xl mx-auto">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢
                </p>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="container mx-auto px-6 py-8">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-6 shadow-xl">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 998/1"
                                class="w-full pl-12 pr-4 py-4 text-lg border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/30 focus:border-purple-500 focus:outline-none transition-all duration-300"
                            >
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            onclick="searchData()" 
                            class="px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg"
                        >
                            <i class="fas fa-search mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                        <button 
                            onclick="showAllData()" 
                            class="px-8 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-300 shadow-lg"
                        >
                            <i class="fas fa-list mr-2"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>
                
                <div id="searchInfo" class="mt-4 text-center text-gray-600 hidden">
                    <span id="searchResult"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden container mx-auto px-6 py-12">
        <div class="text-center">
            <div class="glass-effect rounded-2xl p-12 max-w-md mx-auto">
                <i class="fas fa-spinner loading-spinner text-4xl text-purple-600 mb-4"></i>
                <p class="text-xl text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="container mx-auto px-6 py-8">
        <div id="results" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3"></div>
    </div>

    <!-- Connection Warning -->
    <div id="apiWarning" class="hidden container mx-auto px-6 mb-8">
        <div class="glass-effect rounded-2xl p-6 border-l-4 border-red-500">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-4 mt-1"></i>
                <div>
                    <h3 class="text-xl font-semibold text-red-700 mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ</h3>
                    <div class="text-red-600 space-y-2">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li>Google Sheets ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô "Anyone with the link can view"</li>
                            <li>Spreadsheet ID ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                            <li>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ" ‡∏™‡∏∞‡∏Å‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                            <li>‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Results -->
    <div id="noResults" class="hidden container mx-auto px-6 py-12">
        <div class="text-center">
            <div class="glass-effect rounded-2xl p-12 max-w-md mx-auto">
                <i class="fas fa-search text-6xl text-gray-400 mb-6"></i>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">
                            <i class="fas fa-receipt mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                        </h2>
                        <p id="modalHouseNo" class="text-blue-100"></p>
                    </div>
                    <button onclick="closePaymentModal()" class="text-white hover:text-gray-200 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="paymentDetailsContent">
                    <!-- Payment details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE';
        const SHEET_NAME = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
        const PAYMENT_SHEET_ID = '1mRI_UrDLCy_4I6guONsscwJwWvLWyEgHB9VEEfCSZNA';
        const PAYMENT_SHEET_NAME = '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        
        // Telegram Configuration
        const TELEGRAM_TOKEN = '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo';
        const TELEGRAM_CHAT_ID = '7585120244';
        
        const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', 
                           '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
        
        let allData = [];
        let paymentData = [];

        async function loadPaymentData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${PAYMENT_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PAYMENT_SHEET_NAME)}`;
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á...');
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows && rows.length > 1) {
                    paymentData = rows.slice(1).filter(row => {
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E (index 4): ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F (index 5): ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô  
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G (index 6): ‡∏õ‡∏µ
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N (index 13): ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                        const houseNo = row[4];
                        const month = row[5];
                        const year = row[6];
                        const status = row[13];
                        
                        return houseNo && month && year && status && 
                               houseNo.trim() !== '' && month.trim() !== '' && 
                               year.trim() !== '' && status.trim() !== '';
                    });
                    
                    console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', paymentData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    return Promise.resolve();
                } else {
                    console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô Google Sheets');
                    paymentData = [];
                    return Promise.resolve();
                }
                
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢:', error);
                paymentData = [];
                return Promise.resolve();
            }
        }

        async function loadData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...');
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows && rows.length > 1) {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A-T (20 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å)
                    allData = rows.slice(1).filter(row => {
                        const [invNo, houseNo, soi, name] = row;
                        return invNo && houseNo && soi && name && 
                               invNo !== 'undefined' && houseNo !== 'undefined' && 
                               soi !== 'undefined' && name !== 'undefined' &&
                               invNo.trim() !== '' && houseNo.trim() !== '' && 
                               soi.trim() !== '' && name.trim() !== '';
                    }).map(row => row.slice(0, 20)); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A-T
                    
                    console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', allData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    hideApiKeyWarning();
                    return Promise.resolve();
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets');
                }
                
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
                showApiKeyWarning();
                allData = [];
                return Promise.resolve();
            }
        }

        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    
                    row.push(current.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }

        function getMonthStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß')) return 'status-paid';
            if (statusLower.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢')) return 'status-unpaid';
            if (statusLower.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) return 'status-advance';
            if (statusLower.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return 'status-exempt';
            if (statusLower.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || statusLower.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'status-pending';
            if (statusLower.includes('‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô')) return 'status-contact-admin';
            return 'bg-gray-200 text-gray-800';
        }

        function calculateOverdueStatus(monthlyStatuses) {
            let overdueCount = 0;
            const currentMonth = new Date().getMonth();
            
            for (let i = 0; i <= currentMonth; i++) {
                const status = monthlyStatuses[i]?.toLowerCase() || '';
                if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                    overdueCount++;
                }
            }

            if (overdueCount === 0) return { 
                text: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 
                icon: 'fas fa-check-circle', 
                color: 'text-white',
                headerBg: 'from-green-500 to-green-600'
            };
            if (overdueCount === 1) return { 
                text: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 
                icon: 'fas fa-exclamation-triangle', 
                color: 'text-white',
                headerBg: 'from-yellow-500 to-yellow-600'
            };
            if (overdueCount === 2) return { 
                text: '‡∏£‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 
                icon: 'fas fa-bell', 
                color: 'text-white',
                headerBg: 'from-orange-400 to-orange-500'
            };
            if (overdueCount === 3) return { 
                text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 
                icon: 'fas fa-file-invoice', 
                color: 'text-white',
                headerBg: 'from-orange-500 to-red-400'
            };
            if (overdueCount >= 4 && overdueCount <= 5) return { 
                text: '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ', 
                icon: 'fas fa-ban', 
                color: 'text-white',
                headerBg: 'from-red-500 to-red-600'
            };
            if (overdueCount >= 6) return { 
                text: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', 
                icon: 'fas fa-gavel', 
                color: 'text-white',
                headerBg: 'from-red-700 to-red-800'
            };
            
            return { 
                text: `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, 
                icon: 'fas fa-times-circle', 
                color: 'text-white',
                headerBg: 'from-red-500 to-red-600'
            };
        }

        function calculateTotalAmount(monthlyStatuses) {
            let totalPaid = 0;
            let totalUnpaid = 0;
            let totalAdvance = 0;

            monthlyStatuses.forEach(status => {
                const statusLower = status.toLowerCase();
                if (statusLower.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß')) {
                    totalPaid += 300;
                } else if (statusLower.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || statusLower.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || statusLower.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                    totalUnpaid += 300;
                } else if (statusLower.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                    totalAdvance += 300;
                }
            });

            return { totalPaid, totalUnpaid, totalAdvance };
        }

        async function sendTelegramNotification(houseNo, searchResults) {
            try {
                if (!searchResults || searchResults.length === 0) {
                    return;
                }

                let message = `üè† *‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤*\n`;
                message += `üìç ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: *${houseNo}*\n`;
                message += `üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: *${searchResults.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£*\n\n`;

                searchResults.forEach((rowData, index) => {
                    const [invNo, houseNo, soi, name, transferDate, status, dueMonth, year, ...monthlyStatuses] = rowData;
                    const updatedMonthlyStatuses = updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses);
                    const overdueStatus = calculateOverdueStatus(updatedMonthlyStatuses);
                    const amounts = calculateTotalAmount(updatedMonthlyStatuses);

                    message += `üìã *‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1} (‡∏õ‡∏µ ${year})*\n`;
                    message += `üë§ ‡∏ä‡∏∑‡πà‡∏≠: ${name}\n`;
                    message += `üèòÔ∏è ‡∏ã‡∏≠‡∏¢: ${soi}\n`;
                    message += `üìÖ ‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô: ${transferDate}\n`;
                    message += `üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}\n`;
                    message += `‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: *${overdueStatus.text}*\n`;
                    
                    message += `üí∞ *‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:*\n`;
                    message += `‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${amounts.totalPaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
                    message += `‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${amounts.totalUnpaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
                    message += `üîÑ ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ${amounts.totalAdvance.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    message += `üìÖ *‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:*\n`;
                    const monthlyStatus = updatedMonthlyStatuses.slice(0, 12).map((status, monthIndex) => {
                        const monthName = monthNames[monthIndex];
                        let emoji = '‚ùì';
                        if (status.toLowerCase().includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß')) emoji = '‚úÖ';
                        else if (status.toLowerCase().includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢')) emoji = '‚ùå';
                        else if (status.toLowerCase().includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) emoji = 'üîÑ';
                        else if (status.toLowerCase().includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) emoji = '‚≠ï';
                        else if (status.toLowerCase().includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.toLowerCase().includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) emoji = '‚è≥';
                        
                        return `${emoji} ${monthName}`;
                    }).join(' ');
                    
                    message += monthlyStatus + '\n';
                    
                    if (index < searchResults.length - 1) {
                        message += '\n' + '‚îÄ'.repeat(30) + '\n\n';
                    }
                });

                message += `\nüïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${new Date().toLocaleString('th-TH')}`;

                const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
                
                const response = await fetch(telegramUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                if (response.ok) {
                    console.log('‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Telegram:', await response.text());
                }

            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram:', error);
            }
        }

        function showApiKeyWarning() {
            document.getElementById('apiWarning').classList.remove('hidden');
        }

        function hideApiKeyWarning() {
            document.getElementById('apiWarning').classList.add('hidden');
        }

        function updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á monthlyStatuses ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
            const updatedStatuses = [...monthlyStatuses];
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
            const payments = paymentData.filter(payment => {
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E (index 4): ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F (index 5): ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô  
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G (index 6): ‡∏õ‡∏µ
                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N (index 13): ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                const paymentHouseNo = payment[4]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E
                const paymentMonth = payment[5];   // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F
                const paymentYear = payment[6];    // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G
                const paymentStatus = payment[13]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N
                
                return paymentHouseNo && paymentMonth && paymentYear && paymentStatus &&
                       paymentHouseNo.trim() === houseNo.trim() && 
                       paymentYear.trim() === year.trim();
            });
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢
            payments.forEach(payment => {
                const paymentMonth = payment[5];   // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const paymentStatus = payment[13]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                const monthIndex = parseInt(paymentMonth) - 1; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô index (0-11)
                
                if (monthIndex >= 0 && monthIndex < 12 && paymentStatus) {
                    const statusLower = paymentStatus.toLowerCase().trim();
                    
                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
                    if (statusLower.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                        updatedStatuses[monthIndex] = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                    } else if (statusLower.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß')) {
                        updatedStatuses[monthIndex] = '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (statusLower.includes('‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô')) {
                        updatedStatuses[monthIndex] = '‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
                    }
                }
            });
            
            return updatedStatuses;
        }

        function createCard(rowData) {
            const [invNo, houseNo, soi, name, transferDate, status, dueMonth, year, ...monthlyStatuses] = rowData;
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢
            const updatedMonthlyStatuses = updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses);
            
            const overdueStatus = calculateOverdueStatus(updatedMonthlyStatuses);
            const amounts = calculateTotalAmount(updatedMonthlyStatuses);

            return `
                <div class="bg-white rounded-2xl shadow-xl card-hover overflow-hidden fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r ${overdueStatus.headerBg} text-white p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold mb-1">
                                    <i class="fas fa-home mr-2"></i>${houseNo}
                                </h3>
                                <p class="text-white/80">${soi}</p>
                            </div>
                            <div class="text-right">
                                <i class="${overdueStatus.icon} ${overdueStatus.color} text-2xl mb-1"></i>
                                <p class="text-sm font-medium">${overdueStatus.text}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6">
                        <!-- Personal Info -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-user mr-2 text-purple-600"></i>${name}
                            </h4>
                            <div class="grid grid-cols-1 gap-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà :</span>
                                    <span class="font-semibold">${houseNo}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">‡∏ã‡∏≠‡∏¢ :</span>
                                    <span class="font-semibold">${soi}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô :</span>
                                    <span class="font-semibold">${transferDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ :</span>
                                    <span class="font-semibold text-purple-600">${status}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Status Grid -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-semibold text-gray-700 flex items-center">
                                    <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>
                                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${year})
                                </h5>
                                <button 
                                    onclick="showPaymentDetails('${houseNo}')" 
                                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 shadow-md"
                                >
                                    <i class="fas fa-info-circle mr-1"></i>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                            <div class="month-grid">
                                ${updatedMonthlyStatuses.slice(0, 12).map((monthStatus, index) => `
                                    <div class="month-card ${getMonthStatusClass(monthStatus)}" title="${monthNames[index]}: ${monthStatus}">
                                        <div class="font-bold">${monthNames[index]}</div>
                                        <div class="text-xs mt-1 leading-tight">${monthStatus}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4">
                            <h5 class="font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (300 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                            </h5>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600 mb-1">
                                        ${amounts.totalPaid.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600 mb-1">
                                        ${amounts.totalUnpaid.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600 mb-1">
                                        ${amounts.totalAdvance.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const noResults = document.getElementById('noResults');
            const searchInfo = document.getElementById('searchInfo');
            const searchResult = document.getElementById('searchResult');

            if (!searchTerm) {
                showAllData();
                return;
            }

            loading.classList.remove('hidden');
            results.innerHTML = '';
            noResults.classList.add('hidden');
            searchInfo.classList.add('hidden');

            setTimeout(async () => {
                const filteredData = allData.filter(row => {
                    const houseNo = row[1];
                    return houseNo && houseNo.toString().trim() === searchTerm;
                });

                loading.classList.add('hidden');

                if (filteredData.length > 0) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 7) ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                    const sortedFilteredData = filteredData.sort((a, b) => {
                        const yearA = parseInt(a[7]) || 0;
                        const yearB = parseInt(b[7]) || 0;
                        return yearB - yearA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                    });
                    
                    results.innerHTML = sortedFilteredData.map(createCard).join('');
                    searchResult.innerHTML = `<i class="fas fa-check-circle mr-2"></i>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà "${searchTerm}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)`;
                    searchInfo.classList.remove('hidden');
                    
                    // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
                    await sendTelegramNotification(searchTerm, sortedFilteredData);
                } else {
                    noResults.classList.remove('hidden');
                    searchResult.innerHTML = `<i class="fas fa-times-circle mr-2"></i>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà "${searchTerm}"`;
                    searchInfo.classList.remove('hidden');
                }
            }, 1000);
        }

        function showAllData() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const noResults = document.getElementById('noResults');
            const searchInfo = document.getElementById('searchInfo');
            const searchResult = document.getElementById('searchResult');

            loading.classList.remove('hidden');
            results.innerHTML = '';
            noResults.classList.add('hidden');
            searchInfo.classList.add('hidden');

            setTimeout(() => {
                loading.classList.add('hidden');

                if (allData.length > 0) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 7) ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                    const sortedData = [...allData].sort((a, b) => {
                        const yearA = parseInt(a[7]) || 0;
                        const yearB = parseInt(b[7]) || 0;
                        return yearB - yearA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                    });
                    
                    results.innerHTML = sortedData.map(createCard).join('');
                    searchResult.innerHTML = `<i class="fas fa-list mr-2"></i>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)`;
                    searchInfo.classList.remove('hidden');
                } else {
                    noResults.classList.remove('hidden');
                    searchResult.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`;
                    searchInfo.classList.remove('hidden');
                }
            }, 1000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        function showPaymentDetails(houseNo) {
            const modal = document.getElementById('paymentModal');
            const modalHouseNo = document.getElementById('modalHouseNo');
            const content = document.getElementById('paymentDetailsContent');
            
            modalHouseNo.textContent = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${houseNo}`;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
            const housePayments = paymentData.filter(payment => {
                const paymentHouseNo = payment[4]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E: ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
                return paymentHouseNo && paymentHouseNo.trim() === houseNo.trim();
            });
            
            if (housePayments.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</h3>
                        <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>
                    </div>
                `;
            } else {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÑ‡∏õ
                const sortedPayments = housePayments.sort((a, b) => {
                    const yearA = parseInt(a[6]) || 0; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G: ‡∏õ‡∏µ
                    const yearB = parseInt(b[6]) || 0;
                    const monthA = parseInt(a[5]) || 0; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    const monthB = parseInt(b[5]) || 0;
                    
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                    if (yearA !== yearB) return yearB - yearA;
                    // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÑ‡∏õ)
                    return monthB - monthA;
                });
                
                content.innerHTML = `
                    <div class="space-y-4">
                        ${sortedPayments.map(payment => createPaymentCard(payment)).join('')}
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function createPaymentCard(payment) {
            const [id, date, uid, name, houseNo, month, year, paymentType, note, amountText, amount, imageUrl, checker, status, checkDate, pdfUrl] = payment;
            
            const monthName = monthNames[parseInt(month) - 1] || month;
            const statusClass = getPaymentStatusClass(status);
            const statusIcon = getPaymentStatusIcon(status);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠
            const nameColors = [
                'text-purple-600', 'text-blue-600', 'text-green-600', 'text-red-600', 
                'text-yellow-600', 'text-pink-600', 'text-indigo-600', 'text-teal-600'
            ];
            const nameColorIndex = name.length % nameColors.length;
            const nameColor = nameColors[nameColorIndex];
            
            return `
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-all duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-1">
                                ${monthName} ${year}
                            </h4>
                            <p class="text-sm font-semibold ${nameColor} bg-white px-3 py-1 rounded-full inline-block">${name}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                                <i class="${statusIcon} mr-1"></i>${status}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</span>
                                <span class="font-medium text-sm">${date}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢:</span>
                                <span class="font-medium text-sm">${paymentType}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span>
                                <span class="font-bold text-green-600">${parseInt(amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
                                <span class="font-medium text-sm">${checker || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
                                <span class="font-medium text-sm">${checkDate || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">ID:</span>
                                <span class="font-mono text-xs text-gray-600">${id}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${note ? `
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span>
                            <p class="text-sm text-gray-700 mt-1 bg-yellow-50 p-2 rounded">${note}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2 flex-wrap">
                        ${imageUrl ? `
                            <a href="${imageUrl}" target="_blank" class="inline-flex items-center px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-receipt mr-1"></i>‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ
                            </a>
                        ` : ''}
                        ${pdfUrl ? `
                            <a href="${pdfUrl}" target="_blank" class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">
                                <i class="fas fa-file-invoice mr-1"></i>‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function getPaymentStatusClass(status) {
            const statusLower = status?.toLowerCase() || '';
            if (statusLower.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß')) return 'bg-green-100 text-green-800';
            if (statusLower.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'bg-yellow-100 text-yellow-800';
            if (statusLower.includes('‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô')) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }
        
        function getPaymentStatusIcon(status) {
            const statusLower = status?.toLowerCase() || '';
            if (statusLower.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß')) return 'fas fa-check-circle';
            if (statusLower.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'fas fa-clock';
            if (statusLower.includes('‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô')) return 'fas fa-exclamation-triangle';
            return 'fas fa-question-circle';
        }
        
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            Promise.all([loadData(), loadPaymentData()]).then(() => {
                if (allData.length > 0) {
                    showAllData();
                }
            });
        });
    </script>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-6 text-center">
            <div class="mb-4">
                <i class="fas fa-home text-3xl text-purple-400 mb-2"></i>
                <h3 class="text-xl font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h3>
            </div>
            <div class="border-t border-gray-700 pt-4">
                <p class="text-gray-400">
                    ¬© 2025 <span class="text-purple-400 font-semibold">9one</span> - All rights reserved
                </p>
            </div>
        </div>
    </footer>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97cff18972427b48',t:'MTc1NzUxNzk4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
