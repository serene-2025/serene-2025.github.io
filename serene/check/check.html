<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบค้นหาข้อมูลใบแจ้งหนี้</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Kanit', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .card-hover {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .month-card {
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .status-advance { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .status-exempt { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .status-contact-admin { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        

        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .month-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .month-card {
                padding: 8px 6px;
                font-size: 0.7rem;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20"></div>
        <div class="relative container mx-auto px-6 py-12 text-center">
            <div class="mb-8">
                <i class="fas fa-home text-6xl text-white mb-4 opacity-90"></i>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
                    ระบบค้นหาข้อมูลใบแจ้งหนี้
                </h1>
                <p class="text-xl text-white/80 max-w-2xl mx-auto">
                    ค้นหาและตรวจสอบสถานะการชำระเงินค่าส่วนกลางได้อย่างง่ายดาย
                </p>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="container mx-auto px-6 py-8">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-6 shadow-xl">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="กรอกบ้านเลขที่ เช่น 998/1"
                                class="w-full pl-12 pr-4 py-4 text-lg border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/30 focus:border-purple-500 focus:outline-none transition-all duration-300"
                            >
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            onclick="searchData()" 
                            class="px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg"
                        >
                            <i class="fas fa-search mr-2"></i>ค้นหา
                        </button>
                        <button 
                            onclick="showAllData()" 
                            class="px-8 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-300 shadow-lg"
                        >
                            <i class="fas fa-list mr-2"></i>ทั้งหมด
                        </button>
                    </div>
                </div>
                
                <div id="searchInfo" class="mt-4 text-center text-gray-600 hidden">
                    <span id="searchResult"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden container mx-auto px-6 py-12">
        <div class="text-center">
            <div class="glass-effect rounded-2xl p-12 max-w-md mx-auto">
                <i class="fas fa-spinner loading-spinner text-4xl text-purple-600 mb-4"></i>
                <p class="text-xl text-gray-700">กำลังค้นหาข้อมูล...</p>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="container mx-auto px-6 py-8">
        <div id="results" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3"></div>
    </div>

    <!-- Connection Warning -->
    <div id="apiWarning" class="hidden container mx-auto px-6 mb-8">
        <div class="glass-effect rounded-2xl p-6 border-l-4 border-red-500">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-4 mt-1"></i>
                <div>
                    <h3 class="text-xl font-semibold text-red-700 mb-2">ไม่สามารถเชื่อมต่อ Google Sheets ได้</h3>
                    <div class="text-red-600 space-y-2">
                        <p>กรุณาตรวจสอบ:</p>
                        <ul class="list-disc list-inside space-y-1 ml-4">
                            <li>Google Sheets ได้ถูกแชร์เป็น "Anyone with the link can view"</li>
                            <li>Spreadsheet ID ถูกต้อง</li>
                            <li>ชื่อชีต: "ข้อมูลใบแจ้งหนี้" สะกดถูกต้อง</li>
                            <li>ลองรีเฟรชหน้าเว็บใหม่</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Results -->
    <div id="noResults" class="hidden container mx-auto px-6 py-12">
        <div class="text-center">
            <div class="glass-effect rounded-2xl p-12 max-w-md mx-auto">
                <i class="fas fa-search text-6xl text-gray-400 mb-6"></i>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">ไม่พบข้อมูล</h3>
                <p class="text-gray-500">กรุณาตรวจสอบบ้านเลขที่และลองค้นหาใหม่อีกครั้ง</p>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">
                            <i class="fas fa-receipt mr-2"></i>ข้อมูลการจ่ายค่าส่วนกลาง
                        </h2>
                        <p id="modalHouseNo" class="text-blue-100"></p>
                    </div>
                    <button onclick="closePaymentModal()" class="text-white hover:text-gray-200 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="paymentDetailsContent">
                    <!-- Payment details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE';
        const SHEET_NAME = 'ข้อมูลใบแจ้งหนี้';
        
        // ข้อมูลการจ่ายค่าส่วนกลาง
        const PAYMENT_SHEET_ID = '1mRI_UrDLCy_4I6guONsscwJwWvLWyEgHB9VEEfCSZNA';
        const PAYMENT_SHEET_NAME = 'ค่าส่วนกลาง';
        
        // Telegram Configuration
        const TELEGRAM_TOKEN = '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo';
        const TELEGRAM_CHAT_ID = '7585120244';
        
        const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 
                           'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
        
        let allData = [];
        let paymentData = [];

        async function loadPaymentData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${PAYMENT_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PAYMENT_SHEET_NAME)}`;
                console.log('กำลังโหลดข้อมูลการจ่ายค่าส่วนกลาง...');
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows && rows.length > 1) {
                    paymentData = rows.slice(1).filter(row => {
                        // คอลัมน์ E (index 4): บ้านเลขที่
                        // คอลัมน์ F (index 5): เดือน  
                        // คอลัมน์ G (index 6): ปี
                        // คอลัมน์ N (index 13): สถานะการตรวจสอบ
                        const houseNo = row[4];
                        const month = row[5];
                        const year = row[6];
                        const status = row[13];
                        
                        return houseNo && month && year && status && 
                               houseNo.trim() !== '' && month.trim() !== '' && 
                               year.trim() !== '' && status.trim() !== '';
                    });
                    
                    console.log('โหลดข้อมูลการจ่ายสำเร็จ:', paymentData.length, 'รายการ');
                    return Promise.resolve();
                } else {
                    console.log('ไม่พบข้อมูลการจ่ายใน Google Sheets');
                    paymentData = [];
                    return Promise.resolve();
                }
                
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลการจ่าย:', error);
                paymentData = [];
                return Promise.resolve();
            }
        }

        async function loadData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                console.log('กำลังโหลดข้อมูลจาก Google Sheets...');
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows && rows.length > 1) {
                    // กรองข้อมูลและเอาเฉพาะคอลัมน์ A-T (20 คอลัมน์แรก)
                    allData = rows.slice(1).filter(row => {
                        const [invNo, houseNo, soi, name] = row;
                        return invNo && houseNo && soi && name && 
                               invNo !== 'undefined' && houseNo !== 'undefined' && 
                               soi !== 'undefined' && name !== 'undefined' &&
                               invNo.trim() !== '' && houseNo.trim() !== '' && 
                               soi.trim() !== '' && name.trim() !== '';
                    }).map(row => row.slice(0, 20)); // เอาเฉพาะคอลัมน์ A-T
                    
                    console.log('โหลดข้อมูลสำเร็จ:', allData.length, 'รายการ');
                    hideApiKeyWarning();
                    return Promise.resolve();
                } else {
                    throw new Error('ไม่พบข้อมูลใน Google Sheets');
                }
                
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการโหลดข้อมูล:', error);
                showApiKeyWarning();
                allData = [];
                return Promise.resolve();
            }
        }

        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    
                    row.push(current.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }

        function getMonthStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('จ่ายแล้ว')) return 'status-paid';
            if (statusLower.includes('ยังไม่จ่าย')) return 'status-unpaid';
            if (statusLower.includes('ล่วงหน้า')) return 'status-advance';
            if (statusLower.includes('ไม่เก็บ')) return 'status-exempt';
            if (statusLower.includes('รอข้อมูล') || statusLower.includes('รอตรวจสอบ')) return 'status-pending';
            if (statusLower.includes('ให้ติดต่อแอดมิน')) return 'status-contact-admin';
            return 'bg-gray-200 text-gray-800';
        }

        function calculateOverdueStatus(monthlyStatuses) {
            let overdueCount = 0;
            const currentMonth = new Date().getMonth();
            
            for (let i = 0; i <= currentMonth; i++) {
                const status = monthlyStatuses[i]?.toLowerCase() || '';
                if (status.includes('ยังไม่จ่าย') || status.includes('รอข้อมูล') || status.includes('รอตรวจสอบ')) {
                    overdueCount++;
                }
            }

            if (overdueCount === 0) return { 
                text: 'ชำระครบถ้วน', 
                icon: 'fas fa-check-circle', 
                color: 'text-white',
                headerBg: 'from-green-500 to-green-600'
            };
            if (overdueCount === 1) return { 
                text: 'ค้างชำระ 1 เดือน', 
                icon: 'fas fa-exclamation-triangle', 
                color: 'text-white',
                headerBg: 'from-yellow-500 to-yellow-600'
            };
            if (overdueCount === 2) return { 
                text: 'รอแจ้งเตือน', 
                icon: 'fas fa-bell', 
                color: 'text-white',
                headerBg: 'from-orange-400 to-orange-500'
            };
            if (overdueCount === 3) return { 
                text: 'กำลังออกใบเตือน', 
                icon: 'fas fa-file-invoice', 
                color: 'text-white',
                headerBg: 'from-orange-500 to-red-400'
            };
            if (overdueCount >= 4 && overdueCount <= 5) return { 
                text: 'ระงับสิทธ์ต่างๆ', 
                icon: 'fas fa-ban', 
                color: 'text-white',
                headerBg: 'from-red-500 to-red-600'
            };
            if (overdueCount >= 6) return { 
                text: 'แจ้งอายัดที่ดิน', 
                icon: 'fas fa-gavel', 
                color: 'text-white',
                headerBg: 'from-red-700 to-red-800'
            };
            
            return { 
                text: `ค้างชำระ ${overdueCount} เดือน`, 
                icon: 'fas fa-times-circle', 
                color: 'text-white',
                headerBg: 'from-red-500 to-red-600'
            };
        }

        function calculateTotalAmount(monthlyStatuses) {
            let totalPaid = 0;
            let totalUnpaid = 0;
            let totalAdvance = 0;

            monthlyStatuses.forEach(status => {
                const statusLower = status.toLowerCase();
                if (statusLower.includes('จ่ายแล้ว')) {
                    totalPaid += 300;
                } else if (statusLower.includes('ยังไม่จ่าย') || statusLower.includes('รอข้อมูล') || statusLower.includes('รอตรวจสอบ')) {
                    totalUnpaid += 300;
                } else if (statusLower.includes('ล่วงหน้า')) {
                    totalAdvance += 300;
                }
            });

            return { totalPaid, totalUnpaid, totalAdvance };
        }

        async function sendTelegramNotification(houseNo, searchResults) {
            try {
                if (!searchResults || searchResults.length === 0) {
                    return;
                }

                let message = `🏠 *ข้อมูลการค้นหา*\n`;
                message += `📍 บ้านเลขที่: *${houseNo}*\n`;
                message += `📊 พบข้อมูล: *${searchResults.length} รายการ*\n\n`;

                searchResults.forEach((rowData, index) => {
                    const [invNo, houseNo, soi, name, transferDate, status, dueMonth, year, ...monthlyStatuses] = rowData;
                    const updatedMonthlyStatuses = updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses);
                    const overdueStatus = calculateOverdueStatus(updatedMonthlyStatuses);
                    const amounts = calculateTotalAmount(updatedMonthlyStatuses);

                    message += `📋 *รายการที่ ${index + 1} (ปี ${year})*\n`;
                    message += `👤 ชื่อ: ${name}\n`;
                    message += `🏘️ ซอย: ${soi}\n`;
                    message += `📅 วันโอน: ${transferDate}\n`;
                    message += `📊 สถานะ: ${status}\n`;
                    message += `⚠️ สถานะการแจ้งเตือน: *${overdueStatus.text}*\n`;
                    
                    message += `💰 *สรุปการเงิน:*\n`;
                    message += `✅ จ่ายแล้ว: ${amounts.totalPaid.toLocaleString()} บาท\n`;
                    message += `❌ ค้างชำระ: ${amounts.totalUnpaid.toLocaleString()} บาท\n`;
                    message += `🔄 ล่วงหน้า: ${amounts.totalAdvance.toLocaleString()} บาท\n`;

                    // แสดงสถานะรายเดือน
                    message += `📅 *สถานะรายเดือน:*\n`;
                    const monthlyStatus = updatedMonthlyStatuses.slice(0, 12).map((status, monthIndex) => {
                        const monthName = monthNames[monthIndex];
                        let emoji = '❓';
                        if (status.toLowerCase().includes('จ่ายแล้ว')) emoji = '✅';
                        else if (status.toLowerCase().includes('ยังไม่จ่าย')) emoji = '❌';
                        else if (status.toLowerCase().includes('ล่วงหน้า')) emoji = '🔄';
                        else if (status.toLowerCase().includes('ไม่เก็บ')) emoji = '⭕';
                        else if (status.toLowerCase().includes('รอข้อมูล') || status.toLowerCase().includes('รอตรวจสอบ')) emoji = '⏳';
                        
                        return `${emoji} ${monthName}`;
                    }).join(' ');
                    
                    message += monthlyStatus + '\n';
                    
                    if (index < searchResults.length - 1) {
                        message += '\n' + '─'.repeat(30) + '\n\n';
                    }
                });

                message += `\n🕐 เวลาค้นหา: ${new Date().toLocaleString('th-TH')}`;

                const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
                
                const response = await fetch(telegramUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                if (response.ok) {
                    console.log('ส่งการแจ้งเตือน Telegram สำเร็จ');
                } else {
                    console.error('เกิดข้อผิดพลาดในการส่ง Telegram:', await response.text());
                }

            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการส่งการแจ้งเตือน Telegram:', error);
            }
        }

        function showApiKeyWarning() {
            document.getElementById('apiWarning').classList.remove('hidden');
        }

        function hideApiKeyWarning() {
            document.getElementById('apiWarning').classList.add('hidden');
        }

        function updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses) {
            // สร้างสำเนาของ monthlyStatuses เพื่อไม่ให้แก้ไขข้อมูลต้นฉบับ
            const updatedStatuses = [...monthlyStatuses];
            
            // ค้นหาข้อมูลการจ่ายที่ตรงกับบ้านเลขที่และปี
            const payments = paymentData.filter(payment => {
                // คอลัมน์ E (index 4): บ้านเลขที่
                // คอลัมน์ F (index 5): เดือน  
                // คอลัมน์ G (index 6): ปี
                // คอลัมน์ N (index 13): สถานะการตรวจสอบ
                const paymentHouseNo = payment[4]; // คอลัมน์ E
                const paymentMonth = payment[5];   // คอลัมน์ F
                const paymentYear = payment[6];    // คอลัมน์ G
                const paymentStatus = payment[13]; // คอลัมน์ N
                
                return paymentHouseNo && paymentMonth && paymentYear && paymentStatus &&
                       paymentHouseNo.trim() === houseNo.trim() && 
                       paymentYear.trim() === year.trim();
            });
            
            // อัพเดทสถานะตามข้อมูลการจ่าย
            payments.forEach(payment => {
                const paymentMonth = payment[5];   // คอลัมน์ F: เดือน
                const paymentStatus = payment[13]; // คอลัมน์ N: สถานะการตรวจสอบ
                const monthIndex = parseInt(paymentMonth) - 1; // แปลงเดือนเป็น index (0-11)
                
                if (monthIndex >= 0 && monthIndex < 12 && paymentStatus) {
                    const statusLower = paymentStatus.toLowerCase().trim();
                    
                    // อัพเดทสถานะตามเงื่อนไข
                    if (statusLower.includes('รอตรวจสอบ')) {
                        updatedStatuses[monthIndex] = 'รอตรวจสอบ';
                    } else if (statusLower.includes('ตรวจสอบแล้ว')) {
                        updatedStatuses[monthIndex] = 'จ่ายแล้ว';
                    } else if (statusLower.includes('ให้ติดต่อแอดมิน')) {
                        updatedStatuses[monthIndex] = 'ให้ติดต่อแอดมิน';
                    }
                }
            });
            
            return updatedStatuses;
        }

        function createCard(rowData) {
            const [invNo, houseNo, soi, name, transferDate, status, dueMonth, year, ...monthlyStatuses] = rowData;
            
            // อัพเดทสถานะรายเดือนด้วยข้อมูลการจ่าย
            const updatedMonthlyStatuses = updateMonthlyStatusWithPayments(houseNo, year, monthlyStatuses);
            
            const overdueStatus = calculateOverdueStatus(updatedMonthlyStatuses);
            const amounts = calculateTotalAmount(updatedMonthlyStatuses);

            return `
                <div class="bg-white rounded-2xl shadow-xl card-hover overflow-hidden fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r ${overdueStatus.headerBg} text-white p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold mb-1">
                                    <i class="fas fa-home mr-2"></i>${houseNo}
                                </h3>
                                <p class="text-white/80">${soi}</p>
                            </div>
                            <div class="text-right">
                                <i class="${overdueStatus.icon} ${overdueStatus.color} text-2xl mb-1"></i>
                                <p class="text-sm font-medium">${overdueStatus.text}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6">
                        <!-- Personal Info -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-user mr-2 text-purple-600"></i>${name}
                            </h4>
                            <div class="grid grid-cols-1 gap-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">บ้านเลขที่ :</span>
                                    <span class="font-semibold">${houseNo}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">ซอย :</span>
                                    <span class="font-semibold">${soi}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">วันโอน :</span>
                                    <span class="font-semibold">${transferDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">สถานะ :</span>
                                    <span class="font-semibold text-purple-600">${status}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Status Grid -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-semibold text-gray-700 flex items-center">
                                    <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>
                                    สถานะรายเดือน (${year})
                                </h5>
                                <button 
                                    onclick="showPaymentDetails('${houseNo}')" 
                                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 shadow-md"
                                >
                                    <i class="fas fa-info-circle mr-1"></i>แสดงข้อมูล
                                </button>
                            </div>
                            <div class="month-grid">
                                ${updatedMonthlyStatuses.slice(0, 12).map((monthStatus, index) => `
                                    <div class="month-card ${getMonthStatusClass(monthStatus)}" title="${monthNames[index]}: ${monthStatus}">
                                        <div class="font-bold">${monthNames[index]}</div>
                                        <div class="text-xs mt-1 leading-tight">${monthStatus}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4">
                            <h5 class="font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                                สรุปการเงิน (300 บาท/เดือน)
                            </h5>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600 mb-1">
                                        ${amounts.totalPaid.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">จ่ายแล้ว</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600 mb-1">
                                        ${amounts.totalUnpaid.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">ค้างชำระ</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600 mb-1">
                                        ${amounts.totalAdvance.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500">ล่วงหน้า</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const noResults = document.getElementById('noResults');
            const searchInfo = document.getElementById('searchInfo');
            const searchResult = document.getElementById('searchResult');

            if (!searchTerm) {
                showAllData();
                return;
            }

            loading.classList.remove('hidden');
            results.innerHTML = '';
            noResults.classList.add('hidden');
            searchInfo.classList.add('hidden');

            setTimeout(async () => {
                const filteredData = allData.filter(row => {
                    const houseNo = row[1];
                    return houseNo && houseNo.toString().trim() === searchTerm;
                });

                loading.classList.add('hidden');

                if (filteredData.length > 0) {
                    // เรียงข้อมูลตามปี (คอลัมน์ที่ 7) จากมากไปน้อย
                    const sortedFilteredData = filteredData.sort((a, b) => {
                        const yearA = parseInt(a[7]) || 0;
                        const yearB = parseInt(b[7]) || 0;
                        return yearB - yearA; // เรียงจากมากไปน้อย (ปีล่าสุดก่อน)
                    });
                    
                    results.innerHTML = sortedFilteredData.map(createCard).join('');
                    searchResult.innerHTML = `<i class="fas fa-check-circle mr-2"></i>พบข้อมูลบ้านเลขที่ "${searchTerm}" จำนวน ${filteredData.length} รายการ (เรียงตามปีล่าสุด)`;
                    searchInfo.classList.remove('hidden');
                    
                    // ส่งการแจ้งเตือน Telegram
                    await sendTelegramNotification(searchTerm, sortedFilteredData);
                } else {
                    noResults.classList.remove('hidden');
                    searchResult.innerHTML = `<i class="fas fa-times-circle mr-2"></i>ไม่พบข้อมูลบ้านเลขที่ "${searchTerm}"`;
                    searchInfo.classList.remove('hidden');
                }
            }, 1000);
        }

        function showAllData() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const noResults = document.getElementById('noResults');
            const searchInfo = document.getElementById('searchInfo');
            const searchResult = document.getElementById('searchResult');

            loading.classList.remove('hidden');
            results.innerHTML = '';
            noResults.classList.add('hidden');
            searchInfo.classList.add('hidden');

            setTimeout(() => {
                loading.classList.add('hidden');

                if (allData.length > 0) {
                    // เรียงข้อมูลตามปี (คอลัมน์ที่ 7) จากมากไปน้อย
                    const sortedData = [...allData].sort((a, b) => {
                        const yearA = parseInt(a[7]) || 0;
                        const yearB = parseInt(b[7]) || 0;
                        return yearB - yearA; // เรียงจากมากไปน้อย (ปีล่าสุดก่อน)
                    });
                    
                    results.innerHTML = sortedData.map(createCard).join('');
                    searchResult.innerHTML = `<i class="fas fa-list mr-2"></i>แสดงข้อมูลทั้งหมด ${allData.length} รายการ (เรียงตามปีล่าสุด)`;
                    searchInfo.classList.remove('hidden');
                } else {
                    noResults.classList.remove('hidden');
                    searchResult.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>ไม่มีข้อมูลในระบบ`;
                    searchInfo.classList.remove('hidden');
                }
            }, 1000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        function showPaymentDetails(houseNo) {
            const modal = document.getElementById('paymentModal');
            const modalHouseNo = document.getElementById('modalHouseNo');
            const content = document.getElementById('paymentDetailsContent');
            
            modalHouseNo.textContent = `บ้านเลขที่: ${houseNo}`;
            
            // กรองข้อมูลการจ่ายตามบ้านเลขที่
            const housePayments = paymentData.filter(payment => {
                const paymentHouseNo = payment[4]; // คอลัมน์ E: บ้านเลขที่
                return paymentHouseNo && paymentHouseNo.trim() === houseNo.trim();
            });
            
            if (housePayments.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">ไม่พบข้อมูลการจ่าย</h3>
                        <p class="text-gray-500">ยังไม่มีข้อมูลการจ่ายค่าส่วนกลางสำหรับบ้านเลขที่นี้</p>
                    </div>
                `;
            } else {
                // เรียงข้อมูลตามปีล่าสุดก่อน แล้วเดือนล่าสุดลงไป
                const sortedPayments = housePayments.sort((a, b) => {
                    const yearA = parseInt(a[6]) || 0; // คอลัมน์ G: ปี
                    const yearB = parseInt(b[6]) || 0;
                    const monthA = parseInt(a[5]) || 0; // คอลัมน์ F: เดือน
                    const monthB = parseInt(b[5]) || 0;
                    
                    // เรียงปีจากมากไปน้อย (ปีล่าสุดก่อน)
                    if (yearA !== yearB) return yearB - yearA;
                    // ถ้าปีเดียวกัน เรียงเดือนจากมากไปน้อย (เดือนล่าสุดลงไป)
                    return monthB - monthA;
                });
                
                content.innerHTML = `
                    <div class="space-y-4">
                        ${sortedPayments.map(payment => createPaymentCard(payment)).join('')}
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function createPaymentCard(payment) {
            const [id, date, uid, name, houseNo, month, year, paymentType, note, amountText, amount, imageUrl, checker, status, checkDate, pdfUrl] = payment;
            
            const monthName = monthNames[parseInt(month) - 1] || month;
            const statusClass = getPaymentStatusClass(status);
            const statusIcon = getPaymentStatusIcon(status);
            
            // สร้างสีสำหรับชื่อ
            const nameColors = [
                'text-purple-600', 'text-blue-600', 'text-green-600', 'text-red-600', 
                'text-yellow-600', 'text-pink-600', 'text-indigo-600', 'text-teal-600'
            ];
            const nameColorIndex = name.length % nameColors.length;
            const nameColor = nameColors[nameColorIndex];
            
            return `
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-all duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-1">
                                ${monthName} ${year}
                            </h4>
                            <p class="text-sm font-semibold ${nameColor} bg-white px-3 py-1 rounded-full inline-block">${name}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                                <i class="${statusIcon} mr-1"></i>${status}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">วันที่แจ้ง:</span>
                                <span class="font-medium text-sm">${date}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">การจ่าย:</span>
                                <span class="font-medium text-sm">${paymentType}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">จำนวน:</span>
                                <span class="font-bold text-green-600">${parseInt(amount).toLocaleString()} บาท</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">ผู้ตรวจสอบ:</span>
                                <span class="font-medium text-sm">${checker || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">วันที่ตรวจสอบ:</span>
                                <span class="font-medium text-sm">${checkDate || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 text-sm">ID:</span>
                                <span class="font-mono text-xs text-gray-600">${id}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${note ? `
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">หมายเหตุ:</span>
                            <p class="text-sm text-gray-700 mt-1 bg-yellow-50 p-2 rounded">${note}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2 flex-wrap">
                        ${imageUrl ? `
                            <a href="${imageUrl}" target="_blank" class="inline-flex items-center px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-receipt mr-1"></i>ดูสลิป
                            </a>
                        ` : ''}
                        ${pdfUrl ? `
                            <a href="${pdfUrl}" target="_blank" class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">
                                <i class="fas fa-file-invoice mr-1"></i>ดูใบเสร็จ
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function getPaymentStatusClass(status) {
            const statusLower = status?.toLowerCase() || '';
            if (statusLower.includes('ตรวจสอบแล้ว')) return 'bg-green-100 text-green-800';
            if (statusLower.includes('รอตรวจสอบ')) return 'bg-yellow-100 text-yellow-800';
            if (statusLower.includes('ให้ติดต่อแอดมิน')) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }
        
        function getPaymentStatusIcon(status) {
            const statusLower = status?.toLowerCase() || '';
            if (statusLower.includes('ตรวจสอบแล้ว')) return 'fas fa-check-circle';
            if (statusLower.includes('รอตรวจสอบ')) return 'fas fa-clock';
            if (statusLower.includes('ให้ติดต่อแอดมิน')) return 'fas fa-exclamation-triangle';
            return 'fas fa-question-circle';
        }
        
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            Promise.all([loadData(), loadPaymentData()]).then(() => {
                if (allData.length > 0) {
                    showAllData();
                }
            });
        });
    </script>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-6 text-center">
            <div class="mb-4">
                <i class="fas fa-home text-3xl text-purple-400 mb-2"></i>
                <h3 class="text-xl font-semibold">ระบบค้นหาข้อมูลใบแจ้งหนี้</h3>
            </div>
            <div class="border-t border-gray-700 pt-4">
                <p class="text-gray-400">
                    © 2025 <span class="text-purple-400 font-semibold">9one</span> - All rights reserved
                </p>
            </div>
        </div>
    </footer>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97cff18972427b48',t:'MTc1NzUxNzk4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
