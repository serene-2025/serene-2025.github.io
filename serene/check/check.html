<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามค่าส่วนกลาง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .slide-up {
            animation: slideUp 0.8s ease-out forwards;
        }
        
        .bounce-in {
            animation: bounceIn 1s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(255, 255, 255, 0.1) inset,
                0 -2px 8px rgba(0, 0, 0, 0.05) inset;
            position: relative;
            overflow: hidden;
        }
        
        .glass-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            pointer-events: none;
            z-index: 1;
            animation: glassShine 3s ease-in-out infinite;
        }
        
        .glass-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes glassShine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        
        .hover-lift {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            transform-style: preserve-3d;
        }
        
        .hover-lift:hover {
            transform: translateY(-12px) scale(1.03) rotateX(5deg);
            box-shadow: 
                0 35px 60px -12px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.15),
                0 0 20px rgba(255, 255, 255, 0.1);
        }
        
        .hover-lift::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
            border-radius: inherit;
            opacity: 0;
            transition: all 0.4s ease;
            pointer-events: none;
            z-index: -1;
        }
        
        .hover-lift:hover::after {
            opacity: 1;
            transform: scale(1.02);
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 8px rgba(34, 197, 94, 0.6),
                    0 0 16px rgba(34, 197, 94, 0.4),
                    0 0 24px rgba(34, 197, 94, 0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 
                    0 0 16px rgba(34, 197, 94, 0.8),
                    0 0 32px rgba(34, 197, 94, 0.6),
                    0 0 48px rgba(34, 197, 94, 0.4),
                    0 0 64px rgba(34, 197, 94, 0.2);
                transform: scale(1.1);
            }
        }
        
        .neon-text {
            text-shadow: 
                0 0 5px rgba(255, 255, 255, 0.8),
                0 0 10px rgba(255, 255, 255, 0.6),
                0 0 15px rgba(255, 255, 255, 0.4),
                0 0 20px rgba(102, 126, 234, 0.6),
                0 0 35px rgba(102, 126, 234, 0.4),
                0 0 40px rgba(102, 126, 234, 0.2);
            animation: neonFlicker 3s ease-in-out infinite alternate;
        }
        
        @keyframes neonFlicker {
            0%, 100% { 
                text-shadow: 
                    0 0 5px rgba(255, 255, 255, 0.8),
                    0 0 10px rgba(255, 255, 255, 0.6),
                    0 0 15px rgba(255, 255, 255, 0.4),
                    0 0 20px rgba(102, 126, 234, 0.6),
                    0 0 35px rgba(102, 126, 234, 0.4),
                    0 0 40px rgba(102, 126, 234, 0.2);
            }
            50% { 
                text-shadow: 
                    0 0 2px rgba(255, 255, 255, 0.9),
                    0 0 5px rgba(255, 255, 255, 0.7),
                    0 0 8px rgba(255, 255, 255, 0.5),
                    0 0 12px rgba(102, 126, 234, 0.8),
                    0 0 18px rgba(102, 126, 234, 0.6),
                    0 0 25px rgba(102, 126, 234, 0.4);
            }
        }
        

    </style>
</head>
<body class="gradient-bg min-h-screen">

    
    <div class="container mx-auto px-4 py-8 relative z-10" style="position: relative; z-index: 10;">
        <!-- Header -->
        <div class="glass-effect rounded-2xl p-8 mb-8 fade-in" style="position: relative; z-index: 5;">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-full mb-4 bounce-in">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-white mb-3 neon-text">ระบบติดตามค่าส่วนกลาง</h1>
                <p class="text-white text-opacity-90 text-lg">อัตราค่าส่วนกลาง: 300 บาท/เดือน</p>
                <div class="mt-4 inline-flex items-center px-4 py-2 bg-white bg-opacity-20 rounded-full">
                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-glow"></div>
                    <span class="text-white text-sm">ระบบออนไลน์</span>
                </div>
            </div>
        </div>



        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" style="position: relative; z-index: 5;">
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-1">จ่ายแล้ว</p>
                        <p class="text-3xl font-bold text-green-600" id="paidCount">0</p>
                        <p class="text-xs text-green-500 mt-1">✓ เดือนที่ชำระแล้ว</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-2xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-1">ยังไม่จ่าย</p>
                        <p class="text-3xl font-bold text-red-600" id="unpaidCount">0</p>
                        <p class="text-xs text-red-500 mt-1">⚠ เดือนที่ค้างชำระ</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-400 to-red-600 p-4 rounded-2xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-1">ยอดค้างชำระ</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalUnpaid">0 บาท</p>
                        <p class="text-xs text-blue-500 mt-1">💰 รวมทั้งหมด</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-2xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-1">อัตราการจ่าย</p>
                        <p class="text-3xl font-bold text-purple-600" id="paymentRate">0%</p>
                        <p class="text-xs text-purple-500 mt-1">📊 เปอร์เซ็นต์</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-400 to-purple-600 p-4 rounded-2xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary Section -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 slide-up" style="animation-delay: 0.5s; position: relative; z-index: 5;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg class="w-7 h-7 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                สรุปข้อมูลทางการเงิน
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-blue-700">💰 รายได้รวมทั้งหมด</h4>
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-blue-800" id="totalRevenue">0 บาท</p>
                    <p class="text-xs text-blue-600 mt-1">จากการชำระทั้งหมด</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-green-700">✅ รายได้ที่ได้รับ</h4>
                        <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-green-800" id="collectedRevenue">0 บาท</p>
                    <p class="text-xs text-green-600 mt-1">จากการจ่ายแล้ว</p>
                </div>
                
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border border-red-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-red-700">⚠️ รายได้ค้างรับ</h4>
                        <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-red-800" id="pendingRevenue">0 บาท</p>
                    <p class="text-xs text-red-600 mt-1">ยังไม่ได้รับชำระ</p>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-purple-700">📊 เฉลี่ยต่อบ้าน</h4>
                        <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-purple-800" id="averagePerRoom">0 บาท</p>
                    <p class="text-xs text-purple-600 mt-1">ค่าเฉลี่ยค้างชำระ</p>
                </div>
            </div>
            
            <!-- Monthly/Yearly Summary Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        สรุปรายเดือน
                    </h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto" id="monthlySummary">
                        <!-- Monthly data will be populated here -->
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-indigo-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        สรุปรายปี
                    </h3>
                    <div class="space-y-3" id="yearlySummary">
                        <!-- Yearly data will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Controls -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 slide-up" style="animation-delay: 0.55s; position: relative; z-index: 5;">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        ตัวเลือกการแสดงข้อมูล
                    </h3>
                </div>
                
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center">
                        <label class="text-sm font-medium text-gray-700 mr-2">ปีที่แสดง:</label>
                        <select id="chartYearFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
                            <option value="all">ทุกปี</option>
                            <option value="2567">ปี 2567</option>
                            <option value="2568">ปี 2568</option>
                            <option value="2569">ปี 2569</option>
                            <option value="2570">ปี 2570</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <label class="text-sm font-medium text-gray-700 mr-2">แสดงข้อมูล:</label>
                        <select id="dataDisplayMode" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
                            <option value="all">ทั้งหมด</option>
                            <option value="financial">สรุปการเงิน</option>
                            <option value="charts">กราฟเท่านั้น</option>
                            <option value="summary">สรุปเท่านั้น</option>
                        </select>
                    </div>
                    
                    <button id="updateChartsBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        อัปเดต
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" style="position: relative; z-index: 5;">
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.6s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                        สถานะการชำระ
                    </h3>
                    <div class="text-sm text-gray-500" id="chartYearDisplay">ทุกปี</div>
                </div>
                <div class="relative h-64">
                    <canvas id="paymentStatusChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift slide-up" style="animation-delay: 0.7s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        ยอดเงินรายเดือน
                    </h3>
                    <div class="text-sm text-gray-500" id="monthlyChartYearDisplay">ทุกปี</div>
                </div>
                <div class="relative h-64">
                    <canvas id="monthlyAmountChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 slide-up" style="animation-delay: 0.7s; position: relative; z-index: 5;">
            <div class="flex flex-col lg:flex-row gap-4 items-center">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="unpaid">ยังไม่จ่าย</option>
                            <option value="all">ทั้งหมด</option>
                            <option value="paid">จ่ายแล้ว</option>
                            <option value="advance">จ่ายล่วงหน้า</option>
                            <option value="pending">รอข้อมูล</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <select id="yearFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">ทุกปี</option>
                            <option value="2567">ปี 2567</option>
                            <option value="2568">ปี 2568</option>
                            <option value="2569">ปี 2569</option>
                            <option value="2570">ปี 2570</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        <select id="viewMode" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="monthly">แสดงรายเดือน</option>
                            <option value="yearly">แสดงรายปี</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        <select id="rowsPerPage" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="10">10 แถว</option>
                            <option value="20">20 แถว</option>
                            <option value="50">50 แถว</option>
                            <option value="all">ทั้งหมด</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 flex-1">
                    <div class="relative flex-1 flex">
                        <input type="text" id="searchInput" placeholder="ค้นหาหมายเลขบ้านแบบแม่นยำ เช่น 998/27 (แสดงเฉพาะบ้านนั้น) หรือ 998 (แสดงทุกหน่วย) หรือชื่อผู้เช่า..." 
                               class="flex-1 px-12 py-3 border border-gray-300 rounded-l-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white/80 backdrop-blur-sm focus:bg-white transition-all duration-300 shadow-lg hover:shadow-xl">
                        <button id="searchBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-r-2xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <span class="hidden sm:inline">ค้นหา</span>
                        </button>
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <button id="refreshBtn" class="px-6 py-3 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white rounded-2xl hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 transition-all duration-500 flex items-center gap-2 shadow-lg hover:shadow-2xl transform hover:scale-110 hover:rotate-1 relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-20 group-hover:animate-pulse"></div>
                            <svg class="w-4 h-4 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="hidden sm:inline relative z-10">รีเฟรช</span>
                        </button>
                        
                        <div class="ml-3 flex items-center">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-glow" id="autoRefreshIndicator"></div>
                            <span class="text-xs text-gray-500">อัปเดตอัตโนมัติ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden slide-up" style="animation-delay: 0.8s; position: relative; z-index: 5;">
            <div class="px-6 py-6 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            รายการค้างชำระ
                        </h2>
                        <p class="text-gray-600 mt-1">รายการที่ยังไม่ได้ชำระค่าส่วนกลาง</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">แสดงผล</p>
                        <p class="text-lg font-semibold text-red-600" id="displayedRows">0 รายการ</p>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-gray-100 to-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">🏠 บ้าน</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">👤 ชื่อ</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">📅 เดือน/ปี</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">📊 จำนวนเดือน</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">💰 ยอดรวม</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">⚠️ สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="bg-white divide-y divide-gray-100">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        แสดง <span id="startRow">1</span>-<span id="endRow">10</span> จาก <span id="totalRows">0</span> รายการ
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPage" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ← ก่อนหน้า
                        </button>
                        <button id="nextPage" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ถัดไป →
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-xl shadow-lg p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="text-red-800 font-medium">ไม่สามารถโหลดข้อมูลได้</h3>
                    <p class="text-red-600 text-sm mt-1">กรุณาตรวจสอบ URL และสิทธิ์การเข้าถึง Google Sheets</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let chartYearFilter = 'all';
        let dataDisplayMode = 'all';
        const MONTHLY_FEE = 300;
        const SHEETS_ID = "1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE";
        const SHEETS_URL = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
        
        // Local Storage configuration
        const STORAGE_KEY = 'maintenanceFeeData';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        const LAST_UPDATE_KEY = 'lastDataUpdate';
        let isBackgroundLoading = false;

        // Month mapping for Thai months
        const monthMapping = {
            'มกราคม': 1, 'กุมภาพันธ์': 2, 'มีนาคม': 3, 'เมษายน': 4, 'พฤษภาคม': 5, 'มิถุนายน': 6,
            'กรกฎาคม': 7, 'สิงหาคม': 8, 'กันยายน': 9, 'ตุลาคม': 10, 'พฤศจิกายน': 11, 'ธันวาคม': 12
        };

        const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];

        // Local Storage Functions
        function saveDataToStorage(data) {
            try {
                const storageData = {
                    data: data,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(storageData));
                localStorage.setItem(LAST_UPDATE_KEY, Date.now().toString());
                console.log('Data saved to localStorage:', data.length, 'records');
            } catch (error) {
                console.warn('Failed to save data to localStorage:', error);
            }
        }

        function loadDataFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return null;

                const storageData = JSON.parse(stored);
                const age = Date.now() - storageData.timestamp;
                
                // Check if data is still fresh
                if (age > CACHE_DURATION) {
                    console.log('Cached data expired, age:', Math.round(age / 1000), 'seconds');
                    return null;
                }

                console.log('Loaded data from localStorage:', storageData.data.length, 'records, age:', Math.round(age / 1000), 'seconds');
                return storageData.data;
            } catch (error) {
                console.warn('Failed to load data from localStorage:', error);
                return null;
            }
        }

        function clearStorageCache() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(LAST_UPDATE_KEY);
                console.log('Storage cache cleared');
            } catch (error) {
                console.warn('Failed to clear storage cache:', error);
            }
        }

        function getLastUpdateTime() {
            try {
                const lastUpdate = localStorage.getItem(LAST_UPDATE_KEY);
                return lastUpdate ? parseInt(lastUpdate) : 0;
            } catch (error) {
                return 0;
            }
        }

        function formatCacheAge(timestamp) {
            const age = Date.now() - timestamp;
            const minutes = Math.floor(age / (1000 * 60));
            const seconds = Math.floor((age % (1000 * 60)) / 1000);
            
            if (minutes > 0) {
                return `${minutes} นาที ${seconds} วินาที`;
            } else {
                return `${seconds} วินาที`;
            }
        }

        async function fetchGoogleSheetsData() {
            try {
                // Try multiple approaches for better reliability
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`,
                    `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/export?format=csv&gid=0`,
                    SHEETS_URL
                ];
                
                for (let i = 0; i < urls.length; i++) {
                    try {
                        console.log(`Trying URL ${i + 1}:`, urls[i]);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // Increased timeout
                        
                        const response = await fetch(urls[i], {
                            signal: controller.signal,
                            cache: 'no-cache',
                            mode: 'cors',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*'
                            }
                        });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            console.warn(`URL ${i + 1} failed with status:`, response.status);
                            continue;
                        }
                        
                        const csvText = await response.text();
                        console.log('CSV data length:', csvText.length);
                        
                        if (csvText.length < 100) {
                            console.warn(`URL ${i + 1} returned insufficient data`);
                            continue;
                        }
                        
                        const parsedData = parseCSVData(csvText);
                        if (parsedData.length > 0) {
                            console.log('Successfully parsed data:', parsedData.length, 'records');
                            return parsedData;
                        }
                    } catch (urlError) {
                        console.warn(`URL ${i + 1} failed:`, urlError.message);
                        continue;
                    }
                }
                
                throw new Error('All URL attempts failed');
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                // Return expanded sample data for demonstration
                return getExpandedSampleData();
            }
        }

        // Background loading function
        async function loadDataInBackground() {
            if (isBackgroundLoading) {
                console.log('Background loading already in progress');
                return;
            }

            try {
                isBackgroundLoading = true;
                console.log('Starting background data refresh...');
                
                const freshData = await fetchGoogleSheetsData();
                
                if (freshData && freshData.length > 0) {
                    // Save fresh data to storage
                    saveDataToStorage(freshData);
                    
                    // Update current data if it's different
                    if (JSON.stringify(allData) !== JSON.stringify(freshData)) {
                        console.log('New data detected, updating display...');
                        allData = freshData;
                        filterData();
                        updateSummary();
                        createPaymentStatusChart();
                        createMonthlyAmountChart();
                        
                        // Show subtle notification
                        showUpdateNotification();
                    } else {
                        console.log('No changes detected in background refresh');
                    }
                }
            } catch (error) {
                console.error('Background loading failed:', error);
            } finally {
                isBackgroundLoading = false;
            }
        }

        function showUpdateNotification() {
            // Create a subtle notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ข้อมูลอัปเดตแล้ว
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];

            // Find column indices
            const houseNumIndex = headers.findIndex(h => h.includes('บ้านเลขที่'));
            const nameIndex = headers.findIndex(h => h.includes('ชื่อ-สกุล'));
            const yearIndex = headers.findIndex(h => h.includes('ปี'));
            const monthStartIndex = headers.findIndex(h => h.includes('มกราคม'));

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const row = lines[i].split(',').map(cell => cell.replace(/"/g, '').trim());
                if (row.length < headers.length) continue;

                const houseNum = row[houseNumIndex] || '';
                const name = row[nameIndex] || '';
                const year = parseInt(row[yearIndex]) || 2567;

                if (!houseNum || !name) continue;

                // Process monthly payment data
                const monthlyPayments = [];
                for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                    const cellValue = row[monthStartIndex + monthIndex] || '';
                    monthlyPayments.push(cellValue);
                }

                // Calculate payment periods and status
                const paymentPeriods = calculatePaymentPeriods(monthlyPayments, year);
                
                paymentPeriods.forEach(period => {
                    data.push({
                        room: houseNum,
                        name: name,
                        months: period.months,
                        status: period.status,
                        period: period.periodText,
                        year: year,
                        monthStart: period.startMonth,
                        monthEnd: period.endMonth
                    });
                });
            }

            return data;
        }

        function calculatePaymentPeriods(monthlyPayments, year) {
            const periods = [];
            let currentPeriod = null;

            monthlyPayments.forEach((payment, index) => {
                const monthNum = index + 1;
                
                // Define payment status based on database values
                let status = null;
                let shouldTrack = true;
                
                switch (payment.trim()) {
                    case 'จ่ายแล้ว':
                        status = 'paid';
                        break;
                    case 'ยังไม่จ่าย':
                        status = 'unpaid';
                        break;
                    case 'ล่วงหน้า':
                        status = 'advance';
                        break;
                    case 'รอข้อมูล':
                        status = 'pending';
                        break;
                    case 'ไม่เก็บ':
                        shouldTrack = false;
                        break;
                    case '':
                        status = 'unpaid'; // Empty cells treated as unpaid
                        break;
                    default:
                        status = 'unpaid'; // Unknown values treated as unpaid
                        break;
                }

                if (!shouldTrack) {
                    // End current period for 'ไม่เก็บ'
                    if (currentPeriod && currentPeriod.months > 0) {
                        currentPeriod.periodText = formatPeriod(currentPeriod.startMonth, currentPeriod.endMonth, year);
                        periods.push({...currentPeriod});
                        currentPeriod = null;
                    }
                    return;
                }

                if (!currentPeriod) {
                    currentPeriod = {
                        startMonth: monthNum,
                        endMonth: monthNum,
                        months: 1,
                        status: status
                    };
                } else if (currentPeriod.status === status) {
                    // Continue current period
                    currentPeriod.endMonth = monthNum;
                    currentPeriod.months++;
                } else {
                    // End current period and start new period
                    if (currentPeriod.months > 0) {
                        currentPeriod.periodText = formatPeriod(currentPeriod.startMonth, currentPeriod.endMonth, year);
                        periods.push({...currentPeriod});
                    }
                    currentPeriod = {
                        startMonth: monthNum,
                        endMonth: monthNum,
                        months: 1,
                        status: status
                    };
                }
            });

            // Add final period if exists
            if (currentPeriod && currentPeriod.months > 0) {
                currentPeriod.periodText = formatPeriod(currentPeriod.startMonth, currentPeriod.endMonth, year);
                periods.push(currentPeriod);
            }

            return periods.filter(p => p.months > 0);
        }

        function formatPeriod(startMonth, endMonth, year) {
            if (startMonth === endMonth) {
                return `${monthNames[startMonth - 1]} ${year}`;
            } else {
                return `${monthNames[startMonth - 1]}-${monthNames[endMonth - 1]} ${year}`;
            }
        }

        function getSampleData() {
            // Fallback sample data based on your sheet structure with all status types
            return [
                { room: "998/1", name: "นางสาวสุนันทา สุขแก้ว/นางสาวชุติมา ศิริสอน", months: 7, status: "unpaid", period: "ม.ค.-ก.ค. 2567", year: 2567, monthStart: 1, monthEnd: 7 },
                { room: "998/1", name: "นางสาวสุนันทา สุขแก้ว/นางสาวชุติมา ศิริสอน", months: 5, status: "paid", period: "ส.ค.-ธ.ค. 2567", year: 2567, monthStart: 8, monthEnd: 12 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 3, status: "advance", period: "ม.ค.-มี.ค. 2568", year: 2568, monthStart: 1, monthEnd: 3 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 5, status: "paid", period: "ส.ค.-ธ.ค. 2567", year: 2567, monthStart: 8, monthEnd: 12 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 1, status: "unpaid", period: "ก.พ. 2567", year: 2567, monthStart: 2, monthEnd: 2 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 2, status: "pending", period: "พ.ย.-ธ.ค. 2567", year: 2567, monthStart: 11, monthEnd: 12 },
                { room: "998/4", name: "นางสาวสุจิตรา มูลลี", months: 1, status: "unpaid", period: "ก.พ. 2567", year: 2567, monthStart: 2, monthEnd: 2 },
                { room: "998/4", name: "นางสาวสุจิตรา มูลลี", months: 5, status: "paid", period: "ส.ค.-ธ.ค. 2567", year: 2567, monthStart: 8, monthEnd: 12 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 4, status: "unpaid", period: "ม.ค.-เม.ย. 2567", year: 2567, monthStart: 1, monthEnd: 4 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 2, status: "advance", period: "พ.ค.-มิ.ย. 2567", year: 2567, monthStart: 5, monthEnd: 6 },
                { room: "998/6", name: "นายประยุทธ์ ใจดี", months: 3, status: "pending", period: "ต.ค.-ธ.ค. 2567", year: 2567, monthStart: 10, monthEnd: 12 }
            ];
        }

        function getExpandedSampleData() {
            // More comprehensive sample data for better demonstration
            return [
                // 2567 Data
                { room: "998/1", name: "นางสาวสุนันทา สุขแก้ว/นางสาวชุติมา ศิริสอน", months: 7, status: "unpaid", period: "ม.ค.-ก.ค. 2567", year: 2567, monthStart: 1, monthEnd: 7 },
                { room: "998/1", name: "นางสาวสุนันทา สุขแก้ว/นางสาวชุติมา ศิริสอน", months: 5, status: "paid", period: "ส.ค.-ธ.ค. 2567", year: 2567, monthStart: 8, monthEnd: 12 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 8, status: "paid", period: "ม.ค.-ส.ค. 2567", year: 2567, monthStart: 1, monthEnd: 8 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 4, status: "unpaid", period: "ก.ย.-ธ.ค. 2567", year: 2567, monthStart: 9, monthEnd: 12 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 6, status: "paid", period: "ม.ค.-มิ.ย. 2567", year: 2567, monthStart: 1, monthEnd: 6 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 6, status: "unpaid", period: "ก.ค.-ธ.ค. 2567", year: 2567, monthStart: 7, monthEnd: 12 },
                { room: "998/4", name: "นางสาวสุจิตรา มูลลี", months: 3, status: "unpaid", period: "ม.ค.-มี.ค. 2567", year: 2567, monthStart: 1, monthEnd: 3 },
                { room: "998/4", name: "นางสาวสุจิตรา มูลลี", months: 9, status: "paid", period: "เม.ย.-ธ.ค. 2567", year: 2567, monthStart: 4, monthEnd: 12 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 4, status: "unpaid", period: "ม.ค.-เม.ย. 2567", year: 2567, monthStart: 1, monthEnd: 4 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 8, status: "paid", period: "พ.ค.-ธ.ค. 2567", year: 2567, monthStart: 5, monthEnd: 12 },
                { room: "998/6", name: "นายประยุทธ์ ใจดี", months: 12, status: "paid", period: "ม.ค.-ธ.ค. 2567", year: 2567, monthStart: 1, monthEnd: 12 },
                { room: "998/7", name: "นางสาวมาลี จันทร์เพ็ญ", months: 5, status: "unpaid", period: "ม.ค.-พ.ค. 2567", year: 2567, monthStart: 1, monthEnd: 5 },
                { room: "998/7", name: "นางสาวมาลี จันทร์เพ็ญ", months: 7, status: "paid", period: "มิ.ย.-ธ.ค. 2567", year: 2567, monthStart: 6, monthEnd: 12 },
                { room: "998/8", name: "นายสมชาย รักดี", months: 2, status: "pending", period: "ม.ค.-ก.พ. 2567", year: 2567, monthStart: 1, monthEnd: 2 },
                { room: "998/8", name: "นายสมชาย รักดี", months: 10, status: "paid", period: "มี.ค.-ธ.ค. 2567", year: 2567, monthStart: 3, monthEnd: 12 },
                { room: "998/9", name: "นางสาวจิรา สวยงาม", months: 8, status: "unpaid", period: "ม.ค.-ส.ค. 2567", year: 2567, monthStart: 1, monthEnd: 8 },
                { room: "998/9", name: "นางสาวจิรา สวยงาม", months: 4, status: "paid", period: "ก.ย.-ธ.ค. 2567", year: 2567, monthStart: 9, monthEnd: 12 },
                { room: "998/10", name: "นายวิชัย มั่นคง", months: 3, status: "advance", period: "ม.ค.-มี.ค. 2567", year: 2567, monthStart: 1, monthEnd: 3 },
                { room: "998/10", name: "นายวิชัย มั่นคง", months: 9, status: "paid", period: "เม.ย.-ธ.ค. 2567", year: 2567, monthStart: 4, monthEnd: 12 },
                
                // 2568 Data (Current/Future)
                { room: "998/1", name: "นางสาวสุนันทา สุขแก้ว/นางสาวชุติมา ศิริสอน", months: 12, status: "unpaid", period: "ม.ค.-ธ.ค. 2568", year: 2568, monthStart: 1, monthEnd: 12 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 6, status: "advance", period: "ม.ค.-มิ.ย. 2568", year: 2568, monthStart: 1, monthEnd: 6 },
                { room: "998/2", name: "นางสาวศิริรัตน์ ภาอุภัย", months: 6, status: "unpaid", period: "ก.ค.-ธ.ค. 2568", year: 2568, monthStart: 7, monthEnd: 12 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 9, status: "unpaid", period: "ม.ค.-ก.ย. 2568", year: 2568, monthStart: 1, monthEnd: 9 },
                { room: "998/3", name: "นายธวัช ปงรังษี", months: 3, status: "pending", period: "ต.ค.-ธ.ค. 2568", year: 2568, monthStart: 10, monthEnd: 12 },
                { room: "998/4", name: "นางสาวสุจิตรา มูลลี", months: 12, status: "paid", period: "ม.ค.-ธ.ค. 2568", year: 2568, monthStart: 1, monthEnd: 12 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 7, status: "unpaid", period: "ม.ค.-ก.ค. 2568", year: 2568, monthStart: 1, monthEnd: 7 },
                { room: "998/5", name: "นายสุริยา เหล่าโนนขวา", months: 5, status: "paid", period: "ส.ค.-ธ.ค. 2568", year: 2568, monthStart: 8, monthEnd: 12 },
                { room: "998/6", name: "นายประยุทธ์ ใจดี", months: 4, status: "paid", period: "ม.ค.-เม.ย. 2568", year: 2568, monthStart: 1, monthEnd: 4 },
                { room: "998/6", name: "นายประยุทธ์ ใจดี", months: 8, status: "unpaid", period: "พ.ค.-ธ.ค. 2568", year: 2568, monthStart: 5, monthEnd: 12 },
                { room: "998/7", name: "นางสาวมาลี จันทร์เพ็ญ", months: 10, status: "unpaid", period: "ม.ค.-ต.ค. 2568", year: 2568, monthStart: 1, monthEnd: 10 },
                { room: "998/7", name: "นางสาวมาลี จันทร์เพ็ญ", months: 2, status: "pending", period: "พ.ย.-ธ.ค. 2568", year: 2568, monthStart: 11, monthEnd: 12 },
                { room: "998/8", name: "นายสมชาย รักดี", months: 8, status: "paid", period: "ม.ค.-ส.ค. 2568", year: 2568, monthStart: 1, monthEnd: 8 },
                { room: "998/8", name: "นายสมชาย รักดี", months: 4, status: "unpaid", period: "ก.ย.-ธ.ค. 2568", year: 2568, monthStart: 9, monthEnd: 12 },
                { room: "998/9", name: "นางสาวจิรา สวยงาม", months: 6, status: "unpaid", period: "ม.ค.-มิ.ย. 2568", year: 2568, monthStart: 1, monthEnd: 6 },
                { room: "998/9", name: "นางสาวจิรา สวยงาม", months: 6, status: "paid", period: "ก.ค.-ธ.ค. 2568", year: 2568, monthStart: 7, monthEnd: 12 },
                { room: "998/10", name: "นายวิชัย มั่นคง", months: 12, status: "advance", period: "ม.ค.-ธ.ค. 2568", year: 2568, monthStart: 1, monthEnd: 12 }
            ];
        }

        let paymentChart, monthlyChart;

        function createPaymentStatusChart() {
            const ctx = document.getElementById('paymentStatusChart').getContext('2d');
            
            // Filter data by selected year
            let chartData = allData;
            if (chartYearFilter !== 'all') {
                chartData = allData.filter(item => item.year == chartYearFilter);
            }
            
            // Count months for each status
            const paidCount = chartData.filter(item => item.status === 'paid').reduce((sum, item) => sum + item.months, 0);
            const unpaidCount = chartData.filter(item => item.status === 'unpaid').reduce((sum, item) => sum + item.months, 0);
            const advanceCount = chartData.filter(item => item.status === 'advance').reduce((sum, item) => sum + item.months, 0);
            const pendingCount = chartData.filter(item => item.status === 'pending').reduce((sum, item) => sum + item.months, 0);

            if (paymentChart) paymentChart.destroy();

            const chartDataValues = [];
            const chartLabels = [];
            const chartColors = [];
            const chartBorderColors = [];

            if (paidCount > 0) {
                chartDataValues.push(paidCount);
                chartLabels.push('จ่ายแล้ว');
                chartColors.push('rgba(34, 197, 94, 0.8)');
                chartBorderColors.push('rgba(34, 197, 94, 1)');
            }
            if (unpaidCount > 0) {
                chartDataValues.push(unpaidCount);
                chartLabels.push('ยังไม่จ่าย');
                chartColors.push('rgba(239, 68, 68, 0.8)');
                chartBorderColors.push('rgba(239, 68, 68, 1)');
            }
            if (advanceCount > 0) {
                chartDataValues.push(advanceCount);
                chartLabels.push('จ่ายล่วงหน้า');
                chartColors.push('rgba(59, 130, 246, 0.8)');
                chartBorderColors.push('rgba(59, 130, 246, 1)');
            }
            if (pendingCount > 0) {
                chartDataValues.push(pendingCount);
                chartLabels.push('รอข้อมูล');
                chartColors.push('rgba(245, 158, 11, 0.8)');
                chartBorderColors.push('rgba(245, 158, 11, 1)');
            }

            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartDataValues,
                        backgroundColor: chartColors,
                        borderColor: chartBorderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    family: 'Sarabun',
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyAmountChart() {
            const ctx = document.getElementById('monthlyAmountChart').getContext('2d');
            
            // Filter data by selected year
            let chartData = allData;
            if (chartYearFilter !== 'all') {
                chartData = allData.filter(item => item.year == chartYearFilter);
            }
            
            // Group data by months owed
            const monthsData = {};
            chartData.forEach(item => {
                if (item.status === 'unpaid') {
                    monthsData[item.months] = (monthsData[item.months] || 0) + 1;
                }
            });

            const labels = Object.keys(monthsData).sort((a, b) => a - b).map(m => `${m} เดือน`);
            const data = Object.keys(monthsData).sort((a, b) => a - b).map(m => monthsData[m] * m * MONTHLY_FEE);

            if (monthlyChart) monthlyChart.destroy();

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดเงิน (บาท)',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' บาท';
                                },
                                font: {
                                    family: 'Sarabun'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Sarabun'
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadData(forceRefresh = false) {
            try {
                console.log('Starting data load...', forceRefresh ? '(forced refresh)' : '');
                
                // Try to load from cache first (unless forced refresh)
                if (!forceRefresh) {
                    const cachedData = loadDataFromStorage();
                    if (cachedData && cachedData.length > 0) {
                        console.log('Using cached data for instant load');
                        allData = cachedData;
                        
                        // Process and display cached data immediately
                        filterData();
                        updateSummary();
                        createPaymentStatusChart();
                        createMonthlyAmountChart();
                        
                        // Show cache status
                        showCacheStatus();
                        
                        // Start background refresh for fresh data
                        setTimeout(() => loadDataInBackground(), 1000);
                        return;
                    }
                }
                
                // Show loading state for fresh data fetch
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
                
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">${forceRefresh ? 'กำลังรีเฟรชข้อมูล...' : 'กำลังโหลดข้อมูลจาก Google Sheets...'}</p>
                        <p class="text-sm text-gray-500 mt-2">กรุณารอสักครู่</p>
                    `;
                }
                
                // Fetch fresh data from Google Sheets
                const fetchPromise = fetchGoogleSheetsData();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Data fetch timeout')), 20000)
                );
                
                const freshData = await Promise.race([fetchPromise, timeoutPromise]);
                console.log('Fresh data loaded successfully:', freshData.length, 'records');
                
                if (freshData && freshData.length > 0) {
                    allData = freshData;
                    // Save to cache
                    saveDataToStorage(freshData);
                } else {
                    console.warn('No fresh data found, using sample data');
                    allData = getExpandedSampleData();
                }
                
                // Process and display data
                filterData();
                updateSummary();
                createPaymentStatusChart();
                createMonthlyAmountChart();
                
                document.getElementById('loadingState').classList.add('hidden');
                console.log('Data processing completed');
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').classList.add('hidden');
                
                // Try cached data as fallback
                const cachedData = loadDataFromStorage();
                if (cachedData && cachedData.length > 0) {
                    console.log('Using cached data as fallback');
                    allData = cachedData;
                    showCacheStatus(true); // Show as fallback
                } else {
                    // Show error with fallback option
                    const errorElement = document.getElementById('errorState');
                    if (errorElement) {
                        errorElement.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="text-yellow-800 font-medium">ใช้ข้อมูลตัวอย่าง</h3>
                                    <p class="text-yellow-600 text-sm mt-1">ไม่สามารถเชื่อมต่อ Google Sheets ได้ กำลังแสดงข้อมูลตัวอย่าง</p>
                                    <div class="mt-2 space-x-2">
                                        <button onclick="manualRefresh()" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700">
                                            ลองใหม่
                                        </button>
                                        <button onclick="clearStorageCache(); location.reload();" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">
                                            ล้างแคช
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        errorElement.classList.remove('hidden');
                    }
                    
                    // Use expanded sample data as final fallback
                    allData = getExpandedSampleData();
                    console.log('Using sample data:', allData.length, 'records');
                }
                
                filterData();
                updateSummary();
                createPaymentStatusChart();
                createMonthlyAmountChart();
            }
        }

        function showCacheStatus(isFallback = false) {
            const lastUpdate = getLastUpdateTime();
            if (lastUpdate === 0) return;
            
            const cacheAge = formatCacheAge(lastUpdate);
            const statusColor = isFallback ? 'bg-orange-500' : 'bg-blue-500';
            const statusText = isFallback ? 'ใช้ข้อมูลแคช (ออฟไลน์)' : 'ข้อมูลจากแคช';
            
            // Create cache status indicator
            const indicator = document.createElement('div');
            indicator.className = `fixed bottom-4 left-4 ${statusColor} text-white px-3 py-2 rounded-lg shadow-lg z-40 text-sm transform translate-y-full transition-transform duration-300`;
            indicator.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <div class="font-medium">${statusText}</div>
                        <div class="text-xs opacity-90">อัปเดตล่าสุด: ${cacheAge}ที่แล้ว</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(indicator);
            
            // Animate in
            setTimeout(() => {
                indicator.classList.remove('translate-y-full');
            }, 100);
            
            // Auto hide after 5 seconds (unless it's fallback mode)
            if (!isFallback) {
                setTimeout(() => {
                    indicator.classList.add('translate-y-full');
                    setTimeout(() => {
                        if (document.body.contains(indicator)) {
                            document.body.removeChild(indicator);
                        }
                    }, 300);
                }, 5000);
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const viewMode = document.getElementById('viewMode').value;

            // Calculate pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = rowsPerPage === 'all' ? data.length : startIndex + parseInt(rowsPerPage);
            const paginatedData = rowsPerPage === 'all' ? data : data.slice(startIndex, endIndex);

            if (viewMode === 'yearly') {
                displayYearlyData(paginatedData, data.length, startIndex, Math.min(endIndex, data.length));
            } else {
                displayMonthlyData(paginatedData, data.length, startIndex, Math.min(endIndex, data.length));
            }
        }

        function displayMonthlyData(paginatedData, totalLength, startIndex, endIndex) {
            const tbody = document.getElementById('dataTable');
            
            paginatedData.forEach((item, index) => {
                const total = item.months * MONTHLY_FEE;
                
                // Define status display based on all possible statuses
                let statusClass, statusText;
                switch (item.status) {
                    case 'paid':
                        statusClass = 'bg-green-100 text-green-800 border-green-200';
                        statusText = '✅ จ่ายแล้ว';
                        break;
                    case 'unpaid':
                        statusClass = 'bg-red-100 text-red-800 border-red-200';
                        statusText = '❌ ยังไม่จ่าย';
                        break;
                    case 'advance':
                        statusClass = 'bg-blue-100 text-blue-800 border-blue-200';
                        statusText = '💰 จ่ายล่วงหน้า';
                        break;
                    case 'pending':
                        statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        statusText = '⏳ รอข้อมูล';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800 border-gray-200';
                        statusText = '❓ ไม่ระบุ';
                        break;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300 transform hover:scale-[1.01] hover:shadow-md border-l-4 border-transparent hover:border-blue-400';
                row.style.animationDelay = `${index * 0.05}s`;
                row.classList.add('fade-in');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <span class="text-blue-600 font-bold text-sm">${item.room}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.period}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${item.months} เดือน
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">${total.toLocaleString()} บาท</div>
                        <div class="text-xs text-gray-500">${MONTHLY_FEE} × ${item.months}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationInfo(totalLength, startIndex, endIndex);
        }

        function displayYearlyData(paginatedData, totalLength, startIndex, endIndex) {
            const tbody = document.getElementById('dataTable');
            
            // Group data by room and year
            const yearlyGrouped = {};
            paginatedData.forEach(item => {
                const key = `${item.room}-${item.year}`;
                if (!yearlyGrouped[key]) {
                    yearlyGrouped[key] = {
                        room: item.room,
                        name: item.name,
                        year: item.year,
                        totalMonths: 0,
                        paidMonths: 0,
                        unpaidMonths: 0,
                        advanceMonths: 0,
                        pendingMonths: 0,
                        totalAmount: 0,
                        paidAmount: 0,
                        unpaidAmount: 0,
                        advanceAmount: 0,
                        pendingAmount: 0,
                        periods: []
                    };
                }
                
                const group = yearlyGrouped[key];
                group.totalMonths += item.months;
                group.totalAmount += item.months * MONTHLY_FEE;
                group.periods.push(item.period);
                
                switch (item.status) {
                    case 'paid':
                        group.paidMonths += item.months;
                        group.paidAmount += item.months * MONTHLY_FEE;
                        break;
                    case 'unpaid':
                        group.unpaidMonths += item.months;
                        group.unpaidAmount += item.months * MONTHLY_FEE;
                        break;
                    case 'advance':
                        group.advanceMonths += item.months;
                        group.advanceAmount += item.months * MONTHLY_FEE;
                        break;
                    case 'pending':
                        group.pendingMonths += item.months;
                        group.pendingAmount += item.months * MONTHLY_FEE;
                        break;
                }
            });

            Object.values(yearlyGrouped).forEach((group, index) => {
                const paymentRate = group.totalMonths > 0 ? Math.round((group.paidMonths / group.totalMonths) * 100) : 0;
                const statusClass = paymentRate === 100 ? 'bg-green-100 text-green-800' : paymentRate >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300 transform hover:scale-[1.01] hover:shadow-md border-l-4 border-transparent hover:border-blue-400';
                row.style.animationDelay = `${index * 0.05}s`;
                row.classList.add('fade-in');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <span class="text-blue-600 font-bold text-sm">${group.room}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${group.name}</div>
                        <div class="text-xs text-gray-500">ปี ${group.year}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        <div class="space-y-1">
                            <div class="text-green-600">จ่าย: ${group.paidMonths} เดือน</div>
                            <div class="text-red-600">ค้าง: ${group.unpaidMonths} เดือน</div>
                            ${group.advanceMonths > 0 ? `<div class="text-blue-600">ล่วงหน้า: ${group.advanceMonths} เดือน</div>` : ''}
                            ${group.pendingMonths > 0 ? `<div class="text-yellow-600">รอข้อมูล: ${group.pendingMonths} เดือน</div>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${group.totalMonths} เดือน
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">${group.totalAmount.toLocaleString()} บาท</div>
                        <div class="text-xs text-green-600">ได้รับ: ${group.paidAmount.toLocaleString()} บาท</div>
                        <div class="text-xs text-red-600">ค้าง: ${group.unpaidAmount.toLocaleString()} บาท</div>
                        ${group.advanceAmount > 0 ? `<div class="text-xs text-blue-600">ล่วงหน้า: ${group.advanceAmount.toLocaleString()} บาท</div>` : ''}
                        ${group.pendingAmount > 0 ? `<div class="text-xs text-yellow-600">รอข้อมูล: ${group.pendingAmount.toLocaleString()} บาท</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                            ${paymentRate}% ชำระแล้ว
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationInfo(totalLength, startIndex, endIndex);
        }

        function updatePaginationInfo(total, start, end) {
            document.getElementById('totalRows').textContent = total;
            document.getElementById('startRow').textContent = total > 0 ? start + 1 : 0;
            document.getElementById('endRow').textContent = end;
            document.getElementById('displayedRows').textContent = `${total} รายการ`;

            const totalPages = Math.ceil(total / (rowsPerPage === 'all' ? total : parseInt(rowsPerPage)));
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages || rowsPerPage === 'all';
        }

        function updateDisplayMode() {
            const financialSection = document.querySelector('.bg-white.rounded-2xl.shadow-xl.p-8.mb-8.slide-up');
            const chartsSection = document.getElementById('chartsSection');
            const summaryCards = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-4.gap-6.mb-8');
            
            // Show/hide sections based on display mode
            switch (dataDisplayMode) {
                case 'financial':
                    if (financialSection) financialSection.style.display = 'block';
                    if (chartsSection) chartsSection.style.display = 'none';
                    if (summaryCards) summaryCards.style.display = 'grid';
                    break;
                case 'charts':
                    if (financialSection) financialSection.style.display = 'none';
                    if (chartsSection) chartsSection.style.display = 'grid';
                    if (summaryCards) summaryCards.style.display = 'grid';
                    break;
                case 'summary':
                    if (financialSection) financialSection.style.display = 'none';
                    if (chartsSection) chartsSection.style.display = 'none';
                    if (summaryCards) summaryCards.style.display = 'grid';
                    break;
                default: // 'all'
                    if (financialSection) financialSection.style.display = 'block';
                    if (chartsSection) chartsSection.style.display = 'grid';
                    if (summaryCards) summaryCards.style.display = 'grid';
                    break;
            }
            
            // Update year display labels
            const yearText = chartYearFilter === 'all' ? 'ทุกปี' : `ปี ${chartYearFilter}`;
            const chartYearDisplay = document.getElementById('chartYearDisplay');
            const monthlyChartYearDisplay = document.getElementById('monthlyChartYearDisplay');
            if (chartYearDisplay) chartYearDisplay.textContent = yearText;
            if (monthlyChartYearDisplay) monthlyChartYearDisplay.textContent = yearText;
        }

        function updateSummary() {
            // Filter data by selected year for summary calculations
            let summaryData = allData;
            if (chartYearFilter !== 'all') {
                summaryData = allData.filter(item => item.year == chartYearFilter);
            }
            
            // Calculate months for all statuses
            const paidMonths = summaryData
                .filter(item => item.status === 'paid')
                .reduce((sum, item) => sum + item.months, 0);
            const unpaidMonths = summaryData
                .filter(item => item.status === 'unpaid')
                .reduce((sum, item) => sum + item.months, 0);
            const advanceMonths = summaryData
                .filter(item => item.status === 'advance')
                .reduce((sum, item) => sum + item.months, 0);
            const pendingMonths = summaryData
                .filter(item => item.status === 'pending')
                .reduce((sum, item) => sum + item.months, 0);
            
            // Total months that require payment (excluding 'ไม่เก็บ')
            const totalMonths = paidMonths + unpaidMonths + advanceMonths + pendingMonths;
            
            // Calculate amounts
            const totalUnpaid = summaryData
                .filter(item => item.status === 'unpaid')
                .reduce((sum, item) => sum + (item.months * MONTHLY_FEE), 0);
            const paymentRate = totalMonths > 0 ? Math.round((paidMonths / totalMonths) * 100) : 0;

            // Calculate comprehensive financial data
            const totalRevenue = summaryData.reduce((sum, item) => sum + (item.months * MONTHLY_FEE), 0);
            const collectedRevenue = summaryData
                .filter(item => item.status === 'paid' || item.status === 'advance')
                .reduce((sum, item) => sum + (item.months * MONTHLY_FEE), 0);
            const pendingRevenue = totalUnpaid + summaryData
                .filter(item => item.status === 'pending')
                .reduce((sum, item) => sum + (item.months * MONTHLY_FEE), 0);
            const uniqueHouses = [...new Set(summaryData.filter(item => item.status === 'unpaid').map(item => item.room))];
            const averagePerHouse = uniqueHouses.length > 0 ? Math.round(totalUnpaid / uniqueHouses.length) : 0;

            // Animate numbers - show months with suffix
            animateNumber('paidCount', paidMonths, ' เดือน');
            animateNumber('unpaidCount', unpaidMonths, ' เดือน');
            animateNumber('paymentRate', paymentRate, '%');
            animateNumber('totalRevenue', totalRevenue);
            animateNumber('collectedRevenue', collectedRevenue);
            animateNumber('pendingRevenue', pendingRevenue);
            animateNumber('averagePerRoom', averagePerHouse);
            
            document.getElementById('totalUnpaid').textContent = totalUnpaid.toLocaleString() + ' บาท';
            
            // Generate monthly and yearly summaries
            generateMonthlySummary();
            generateYearlySummary();
            
            // Update display mode
            updateDisplayMode();
        }

        function generateMonthlySummary() {
            const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const monthlyData = {};

            // Process data for monthly summary
            allData.forEach(item => {
                const year = item.year;
                if (!monthlyData[year]) monthlyData[year] = {};
                
                // Handle cross-year periods
                if (item.monthStart > item.monthEnd) {
                    // Previous year months
                    for (let m = item.monthStart; m <= 12; m++) {
                        const key = `${year-1}-${m}`;
                        if (!monthlyData[year-1]) monthlyData[year-1] = {};
                        if (!monthlyData[year-1][m]) monthlyData[year-1][m] = { paid: 0, unpaid: 0, advance: 0, pending: 0, total: 0 };
                        monthlyData[year-1][m].total += MONTHLY_FEE;
                        monthlyData[year-1][m][item.status] += MONTHLY_FEE;
                    }
                    // Current year months
                    for (let m = 1; m <= item.monthEnd; m++) {
                        if (!monthlyData[year][m]) monthlyData[year][m] = { paid: 0, unpaid: 0, advance: 0, pending: 0, total: 0 };
                        monthlyData[year][m].total += MONTHLY_FEE;
                        monthlyData[year][m][item.status] += MONTHLY_FEE;
                    }
                } else {
                    // Same year period
                    for (let m = item.monthStart; m <= item.monthEnd; m++) {
                        if (!monthlyData[year][m]) monthlyData[year][m] = { paid: 0, unpaid: 0, advance: 0, pending: 0, total: 0 };
                        monthlyData[year][m].total += MONTHLY_FEE;
                        monthlyData[year][m][item.status] += MONTHLY_FEE;
                    }
                }
            });

            const container = document.getElementById('monthlySummary');
            container.innerHTML = '';

            // Sort years and months
            const sortedYears = Object.keys(monthlyData).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const yearData = monthlyData[year];
                const sortedMonths = Object.keys(yearData).sort((a, b) => b - a);
                
                sortedMonths.forEach(month => {
                    const data = yearData[month];
                    const monthName = monthNames[month - 1];
                    const paymentRate = data.total > 0 ? Math.round((data.paid / data.total) * 100) : 0;
                    
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow';
                    monthDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-800">${monthName} ${year}</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${paymentRate === 100 ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">${paymentRate}%</span>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">รวม:</span>
                                <span class="font-medium">${data.total.toLocaleString()} บาท</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-600">จ่ายแล้ว:</span>
                                <span class="text-green-600 font-medium">${data.paid.toLocaleString()} บาท</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-red-600">ค้างชำระ:</span>
                                <span class="text-red-600 font-medium">${data.unpaid.toLocaleString()} บาท</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(monthDiv);
                });
            });
        }

        function generateYearlySummary() {
            const yearlyData = {};

            // Process data for yearly summary
            allData.forEach(item => {
                const year = item.year;
                if (!yearlyData[year]) yearlyData[year] = { paid: 0, unpaid: 0, total: 0, rooms: new Set() };
                
                const amount = item.months * MONTHLY_FEE;
                yearlyData[year].total += amount;
                yearlyData[year].rooms.add(item.room);
                
                if (item.status === 'paid') {
                    yearlyData[year].paid += amount;
                } else {
                    yearlyData[year].unpaid += amount;
                }
            });

            const container = document.getElementById('yearlySummary');
            container.innerHTML = '';

            // Sort years (newest first)
            const sortedYears = Object.keys(yearlyData).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const data = yearlyData[year];
                const paymentRate = data.total > 0 ? Math.round((data.paid / data.total) * 100) : 0;
                const roomCount = data.rooms.size;
                
                const yearDiv = document.createElement('div');
                yearDiv.className = 'bg-white rounded-lg p-6 border border-gray-200 hover:shadow-md transition-shadow';
                yearDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-gray-800">ปี ${year}</h4>
                        <div class="text-right">
                            <div class="text-xs px-3 py-1 rounded-full ${paymentRate >= 80 ? 'bg-green-100 text-green-800' : paymentRate >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${paymentRate}% ชำระแล้ว</div>
                            <div class="text-xs text-gray-500 mt-1">${roomCount} บ้าน</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <div class="text-blue-600 text-xs font-medium">รายได้รวม</div>
                            <div class="text-blue-800 font-bold text-lg">${data.total.toLocaleString()}</div>
                            <div class="text-blue-600 text-xs">บาท</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="text-green-600 text-xs font-medium">ได้รับแล้ว</div>
                            <div class="text-green-800 font-bold text-lg">${data.paid.toLocaleString()}</div>
                            <div class="text-green-600 text-xs">บาท</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3">
                            <div class="text-red-600 text-xs font-medium">ค้างรับ</div>
                            <div class="text-red-800 font-bold text-lg">${data.unpaid.toLocaleString()}</div>
                            <div class="text-red-600 text-xs">บาท</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3">
                            <div class="text-purple-600 text-xs font-medium">เฉลี่ย/บ้าน</div>
                            <div class="text-purple-800 font-bold text-lg">${Math.round(data.total / roomCount).toLocaleString()}</div>
                            <div class="text-purple-600 text-xs">บาท</div>
                        </div>
                    </div>
                `;
                container.appendChild(yearDiv);
            });
        }

        function animateNumber(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = 0;
            const duration = 1500;
            const startTime = performance.now();

            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                
                if (suffix === '%') {
                    element.textContent = currentValue + suffix;
                } else if (suffix === ' เดือน') {
                    element.textContent = currentValue.toLocaleString() + suffix;
                } else if (suffix === '') {
                    element.textContent = currentValue.toLocaleString() + ' บาท';
                } else {
                    element.textContent = currentValue.toLocaleString() + suffix;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        function filterData() {
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            rowsPerPage = document.getElementById('rowsPerPage').value;
            currentPage = 1; // Reset to first page when filtering

            filteredData = allData;

            // Filter by status
            if (statusFilter !== 'all') {
                filteredData = filteredData.filter(item => item.status === statusFilter);
            }

            // Filter by year
            if (yearFilter !== 'all') {
                filteredData = filteredData.filter(item => item.year == yearFilter);
            }

            // Enhanced search functionality for house numbers
            if (searchTerm) {
                filteredData = filteredData.filter(item => {
                    const name = item.name.toLowerCase();
                    const room = item.room.toLowerCase();
                    
                    // Check for exact house number match first (highest priority)
                    if (room === searchTerm) {
                        return true;
                    }
                    
                    // Check if search term looks like a house number (contains numbers and possibly /)
                    const isHouseNumberSearch = /^\d+([\/]\d+)?$/.test(searchTerm);
                    
                    if (isHouseNumberSearch) {
                        // For house number searches, prioritize exact matches
                        if (room === searchTerm) {
                            return true;
                        }
                        
                        // If searching for base number (e.g., "998"), show all units
                        if (!searchTerm.includes('/') && room.startsWith(searchTerm + '/')) {
                            return true;
                        }
                        
                        // Exact partial matching for house numbers
                        return room.includes(searchTerm);
                    } else {
                        // For name searches or general text searches
                        const nameMatch = name.includes(searchTerm);
                        const roomMatch = room.includes(searchTerm);
                        
                        // Also check for partial house number matching
                        const partialRoomMatch = searchTerm.split('/').some(part => {
                            const trimmedPart = part.trim();
                            return trimmedPart && room.includes(trimmedPart);
                        });
                        
                        return nameMatch || roomMatch || partialRoomMatch;
                    }
                });
            }

            displayData(filteredData);
        }

        // Auto-refresh functionality
        let autoRefreshInterval;

        function startAutoRefresh() {
            // Background refresh every 3 minutes for fresh data
            autoRefreshInterval = setInterval(async () => {
                try {
                    const indicator = document.getElementById('autoRefreshIndicator');
                    if (indicator) {
                        indicator.classList.add('animate-pulse');
                    }
                    
                    // Use background loading to avoid disrupting user experience
                    await loadDataInBackground();
                    
                    if (indicator) {
                        indicator.classList.remove('animate-pulse');
                    }
                } catch (error) {
                    console.error('Auto-refresh failed:', error);
                }
            }, 3 * 60 * 1000); // 3 minutes
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function manualRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = `
                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span class="hidden sm:inline">กำลังโหลด...</span>
            `;
            refreshBtn.disabled = true;
            
            try {
                // Force refresh bypasses cache
                await loadData(true);
            } catch (error) {
                console.error('Manual refresh failed:', error);
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Pagination functions
        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / (rowsPerPage === 'all' ? filteredData.length : parseInt(rowsPerPage)));
            if (currentPage < totalPages && rowsPerPage !== 'all') {
                currentPage++;
                displayData(filteredData);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayData(filteredData);
            }
        }

        // Chart control functions
        function updateCharts() {
            chartYearFilter = document.getElementById('chartYearFilter').value;
            dataDisplayMode = document.getElementById('dataDisplayMode').value;
            
            updateSummary();
            createPaymentStatusChart();
            createMonthlyAmountChart();
        }

        function performSearch() {
            filterData();
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', filterData);
        document.getElementById('yearFilter').addEventListener('change', filterData);
        document.getElementById('viewMode').addEventListener('change', filterData);
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('rowsPerPage').addEventListener('change', filterData);
        document.getElementById('nextPage').addEventListener('click', nextPage);
        document.getElementById('prevPage').addEventListener('click', prevPage);
        document.getElementById('refreshBtn').addEventListener('click', manualRefresh);
        document.getElementById('chartYearFilter').addEventListener('change', updateCharts);
        document.getElementById('dataDisplayMode').addEventListener('change', updateCharts);
        document.getElementById('updateChartsBtn').addEventListener('click', updateCharts);

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Page loaded, starting data initialization...');
                await loadData();
                startAutoRefresh();
                console.log('Data initialization completed');
            } catch (error) {
                console.error('Initial load failed:', error);
                // Force load sample data if everything fails
                allData = getExpandedSampleData();
                filterData();
                updateSummary();
                createPaymentStatusChart();
                createMonthlyAmountChart();
            }
        });

        // Stop auto-refresh when page is hidden/closed
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else if (!autoRefreshInterval) {
                startAutoRefresh();
            }
        });

        // Stop auto-refresh before page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980c4ce51234ee3d',t:'MTc1ODE1MDg3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
