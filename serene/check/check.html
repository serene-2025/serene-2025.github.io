<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .animated-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .loading { 
            animation: spin 1s linear infinite; 
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }
        
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .card-hover:hover::before {
            left: 100%;
        }
        
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-text {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8),
                         0 0 10px rgba(255, 255, 255, 0.8),
                         0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 300% 300%;
            animation: gradientBorder 3s ease infinite;
        }
        
        @keyframes gradientBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .status-badge {
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="animated-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-6">
            <div class="glass-effect rounded-2xl p-4 mb-6">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button 
                        id="searchPageBtn"
                        class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
                    >
                        üîç ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button 
                        id="summaryPageBtn"
                        class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
                    >
                        üìä ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center mb-8 floating">
            <div class="glass-effect rounded-2xl p-8 mb-6">
                <h1 id="pageTitle" class="text-5xl font-bold text-white mb-4 neon-text">
                    üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
                </h1>
                <p id="pageSubtitle" class="text-white text-xl opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</p>
                <div class="flex justify-center mt-4 space-x-2">
                    <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce"></div>
                    <div class="w-3 h-3 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>

        <div id="searchPage">
            <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 border-2 gradient-border">
                <div class="bg-white bg-opacity-90 rounded-xl p-6">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 998/5"
                                    class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 outline-none text-lg transition-all duration-300 shadow-inner"
                                >
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <select 
                                    id="yearSelect" 
                                    class="pl-10 pr-8 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none text-lg transition-all duration-300 shadow-inner bg-white min-w-[160px]"
                                >
                                    <option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                                    <option value="2570">üìÖ ‡∏õ‡∏µ 2570</option>
                                    <option value="2569">üìÖ ‡∏õ‡∏µ 2569</option>
                                    <option value="2568">üìÖ ‡∏õ‡∏µ 2568</option>
                                    <option value="2567">üìÖ ‡∏õ‡∏µ 2567</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button 
                                id="searchBtn"
                                class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl pulse-button transform hover:scale-105"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                            <button 
                                id="loadAllBtn"
                                class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
                            >
                                üìã ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button 
                                id="clearBtn"
                                class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
                            >
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                            </button>
</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="summaryPage" class="hidden">
            <div class="glass-effect rounded-2xl shadow-2xl p-6 mb-8 border-2 gradient-border">
                <div class="bg-white bg-opacity-90 rounded-xl p-4">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <div class="text-center sm:text-left">
                            <label class="text-lg font-bold text-gray-700">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                            <div class="text-sm text-green-600 font-medium mt-1">üîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏à‡∏≤‡∏Å Google Sheets</div>
                        </div>
                        <select 
                            id="summaryYearSelect" 
                            class="px-6 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none text-lg transition-all duration-300 shadow-inner bg-white min-w-[160px]"
                        >
                            <option value="2570">üìÖ ‡∏õ‡∏µ 2570</option>
                            <option value="2569">üìÖ ‡∏õ‡∏µ 2569</option>
                            <option value="2568">üìÖ ‡∏õ‡∏µ 2568</option>
                            <option value="2567">üìÖ ‡∏õ‡∏µ 2567</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">üí∞</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
                    <p id="totalIncome" class="text-3xl font-bold text-yellow-300">0 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">‚úÖ</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <p id="totalPaid" class="text-3xl font-bold text-green-300">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">‚ö†Ô∏è</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h3>
                    <p id="totalOverdue" class="text-3xl font-bold text-red-300">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">üìä</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö</h3>
                    <p id="collectionRate" class="text-3xl font-bold text-blue-300">0%</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-white text-xl font-bold mb-4 text-center">üìÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <div class="bg-white rounded-xl p-4">
                        <canvas id="monthlyChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-white text-xl font-bold mb-4 text-center">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                    <div class="bg-white rounded-xl p-4">
                        <canvas id="yearlyChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6 mb-8">
                <h3 class="text-white text-xl font-bold mb-4 text-center">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <div class="bg-white rounded-xl p-4">
                    <div id="monthlyStats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        </div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6 mb-8">
                <h3 class="text-white text-xl font-bold mb-4 text-center">üéØ ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <div class="bg-white rounded-xl p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <div class="text-2xl mb-2">üèÜ</div>
                            <h4 class="font-bold text-green-700 mb-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                            <p id="bestMonth" class="text-green-600 font-medium">-</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-xl">
                            <div class="text-2xl mb-2">üìâ</div>
                            <h4 class="font-bold text-red-700 mb-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                            <p id="worstMonth" class="text-red-600 font-medium">-</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-xl">
                            <div class="text-2xl mb-2">üìä</div>
                            <h4 class="font-bold text-blue-700 mb-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <p id="avgMonth" class="text-blue-600 font-medium">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-white text-xl font-bold mb-4 text-center">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h3>
                <div class="bg-white rounded-xl p-4">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTableBody">
                                </tbody>
                        </table>
                    </div>
                    <div id="overduePagination" class="flex justify-center mt-4">
                        </div>
                </div>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-12">
            <div class="glass-effect rounded-2xl p-8 mx-auto max-w-md">
                <div class="loading w-12 h-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-6"></div>
                <p class="text-white text-xl font-medium">‚ú® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                <div class="flex justify-center mt-4 space-x-1">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mb-6">
            <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-4 rounded-2xl shadow-lg">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">‚ö†Ô∏è</div>
                    <div>
                        <p class="font-bold text-lg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</p>
                        <p id="errorText" class="opacity-90"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsCount" class="hidden mb-6">
            <div class="glass-effect rounded-xl p-4 text-center">
                <p class="text-white text-xl font-medium">
                    üéØ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="countNumber" class="font-bold text-yellow-300 text-2xl">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </p>
            </div>
        </div>

        <div id="dataContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>

        <div id="noResults" class="hidden text-center py-12">
            <div class="glass-effect rounded-2xl p-12 mx-auto max-w-md">
                <div class="text-6xl mb-6 floating">üîç</div>
                <h3 class="text-2xl font-bold text-white mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-white opacity-80 text-lg">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <div class="mt-6 flex justify-center space-x-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE';
        const SHEET_NAME = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
        let allData = [];
        let currentPage = 'search';
        let monthlyChart = null;
        let yearlyChart = null;

        // Month names in Thai
        const monthNames = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];
        
        const monthShortNames = [
            '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
            '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
        ];

        // Pagination variables for overdue list
        let currentPageOverdue = 1;
        const overdueItemsPerPage = 10; // Set initial items per page to 10
        let totalOverdueItems = 0;

        // Load data specifically for summary page (separate from search page)
        async function loadSummaryData() {
            try {
                // Try multiple URL formats for better compatibility
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`
                ];
                
                let data = null;
                
                // Try CSV format first (more reliable)
                for (let i = 0; i < urls.length; i++) {
                    try {
                        console.log(`Trying summary URL ${i + 1}:`, urls[i]);
                        const response = await fetch(urls[i]);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        if (i < 2) { // CSV formats
                            const csvText = await response.text();
                            console.log('Summary CSV Response length:', csvText.length);
                            
                            if (csvText.length > 0 && !csvText.includes('<!DOCTYPE html>')) {
                                data = parseCSVData(csvText);
                                console.log('Parsed summary CSV data:', data.length, 'records');
                                break;
                            }
                        } else { // JSON format
                            const text = await response.text();
                            console.log('Summary JSON Response length:', text.length);
                            
                            if (text.includes('google.visualization.Query.setResponse')) {
                                const jsonData = JSON.parse(text.substring(47).slice(0, -2));
                                data = parseJSONData(jsonData);
                                console.log('Parsed summary JSON data:', data.length, 'records');
                                break;
                            }
                        }
                    } catch (error) {
                        console.error(`Summary URL ${i + 1} failed:`, error);
                        continue;
                    }
                }
                
                if (!data || data.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞');
                }
                
                console.log('Successfully loaded summary data:', data.length, 'records');
                return data;
                
            } catch (error) {
                console.error('Error loading summary data:', error);
                throw error;
            }
        }

        // Load data from Google Sheets (for search page)
        async function loadData() {
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            
            loading.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`
                ];
                
                let data = null;
                
                for (let i = 0; i < urls.length; i++) {
                    try {
                        console.log(`Trying URL ${i + 1}:`, urls[i]);
                        const response = await fetch(urls[i]);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        if (i < 2) { // CSV formats
                            const csvText = await response.text();
                            console.log('CSV Response length:', csvText.length);
                            
                            if (csvText.length > 0 && !csvText.includes('<!DOCTYPE html>')) {
                                data = parseCSVData(csvText);
                                console.log('Parsed CSV data:', data.length, 'records');
                                break;
                            }
                        } else { // JSON format
                            const text = await response.text();
                            console.log('JSON Response length:', text.length);
                            
                            if (text.includes('google.visualization.Query.setResponse')) {
                                const jsonData = JSON.parse(text.substring(47).slice(0, -2));
                                data = parseJSONData(jsonData);
                                console.log('Parsed JSON data:', data.length, 'records');
                                break;
                            }
                        }
                    } catch (error) {
                        console.error(`URL ${i + 1} failed:`, error);
                        continue;
                    }
                }
                
                if (!data || data.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞');
                }
                
                allData = data;
                loading.classList.add('hidden');
                console.log('Successfully loaded', allData.length, 'records');
                return allData;
                
            } catch (error) {
                loading.classList.add('hidden');
                const errorMsg = error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Spreadsheet ID ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå';
                showError(errorMsg);
                console.error('Error loading data:', error);
                return [];
            }
        }

        // Parse CSV data
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const columns = parseCSVLine(line);
                    
                    // Check if the record has enough columns to be valid, at least 8 basic ones
                    if (columns.length >= 8 && columns[0] !== undefined && columns[0] !== '') { 
                        const record = {
                            id: columns[0] || '',
                            houseNumber: columns[1] || '',
                            soi: columns[2] || '',
                            name: columns[3] || '',
                            transferDate: columns[4] || '',
                            status: columns[5] || '',
                            dueMonth: columns[6] || '',
                            year: columns[7] || '',
                            payments: {}
                        };
                        
                        // Get payment status for each month (columns 8-19)
                        for (let j = 0; j < 12; j++) {
                            const monthIndex = j + 8;
                            record.payments[monthNames[j]] = columns[monthIndex] || '';
                        }
                        
                        data.push(record);
                    }
                }
            }
            
            return data;
        }

        // Parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Parse JSON data (fallback)
        function parseJSONData(jsonData) {
            const rows = jsonData.table.rows;
            const data = [];
            
            // Skip header row and process data
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.c && row.c[0] && row.c[0].v) {
                    const record = {
                        id: row.c[0]?.v || '',
                        houseNumber: row.c[1]?.v || '',
                        soi: row.c[2]?.v || '',
                        name: row.c[3]?.v || '',
                        transferDate: row.c[4]?.v || '',
                        status: row.c[5]?.v || '',
                        dueMonth: row.c[6]?.v || '',
                        year: row.c[7]?.v || '',
                        payments: {}
                    };
                    
                    // Get payment status for each month
                    for (let j = 0; j < 12; j++) {
                        const monthIndex = j + 8;
                        record.payments[monthNames[j]] = row.c[monthIndex]?.v || '';
                    }
                    
                    data.push(record);
                }
            }
            
            return data;
        }

        // Display error message
        function showError(message) {
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorTextP = document.getElementById('errorText');
            errorTextP.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        // Render data cards for search results
        function renderCards(data) {
            const container = document.getElementById('dataContainer');
            container.innerHTML = ''; // Clear previous cards
            const resultsCountDiv = document.getElementById('resultsCount');
            const countNumberSpan = document.getElementById('countNumber');
            const noResultsDiv = document.getElementById('noResults');

            if (data.length === 0) {
                noResultsDiv.classList.remove('hidden');
                resultsCountDiv.classList.add('hidden');
                return;
            }

            noResultsDiv.classList.add('hidden');
            resultsCountDiv.classList.remove('hidden');
            countNumberSpan.textContent = data.length;

            data.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('card-hover', 'glass-effect', 'rounded-2xl', 'p-6', 'text-center', 'shadow-lg');

                // Determine status color
                let statusColor = 'text-gray-400'; // Default
                if (item.status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                    statusColor = 'text-green-400';
                } else if (item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞') {
                    statusColor = 'text-red-400';
                } else if (item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
                    statusColor = 'text-yellow-400';
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-left">
                            <h3 class="text-white text-lg font-bold">${item.houseNumber}${item.soi ? '/' + item.soi : ''}</h3>
                            <p class="text-white opacity-80 text-sm">${item.name}</p>
                        </div>
                        <span class="status-badge text-sm font-semibold px-3 py-1 rounded-full ${statusColor}">
                            ${item.status}
                        </span>
                    </div>
                    <div class="text-left mb-3">
                        <p class="text-gray-300 text-xs">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á:</p>
                        <p class="text-white font-medium">${item.dueMonth || '-'}</p>
                    </div>
                    <div class="text-left mb-3">
                        <p class="text-gray-300 text-xs">‡∏õ‡∏µ:</p>
                        <p class="text-white font-medium">${item.year || '-'}</p>
                    </div>
                    <div class="text-left">
                        <p class="text-gray-300 text-xs">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô:</p>
                        <p class="text-white font-medium">${item.transferDate || '-'}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Filter data based on search input and year
        function filterData() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const yearSelect = document.getElementById('yearSelect').value;

            const filtered = allData.filter(item => {
                const matchesSearch = item.houseNumber.toLowerCase().includes(searchInput) ||
                                    item.name.toLowerCase().includes(searchInput) ||
                                    item.soi.toLowerCase().includes(searchInput);
                const matchesYear = yearSelect === '' || item.year === yearSelect;
                return matchesSearch && matchesYear;
            });

            renderCards(filtered);
        }

        // Populate the overdue table
        function populateOverdueTable(data) {
            const tableBody = document.getElementById('overdueTableBody');
            tableBody.innerHTML = ''; // Clear previous rows

            const startIndex = (currentPageOverdue - 1) * overdueItemsPerPage;
            const endIndex = startIndex + overdueItemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td></tr>`;
                return;
            }

            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');

                // Determine status badge color
                let statusBadgeColor = 'bg-gray-400'; // Default
                let warningStatusText = item.status;
                if (item.status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                    statusBadgeColor = 'bg-green-500';
                } else if (item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞') {
                    statusBadgeColor = 'bg-red-500';
                } else if (item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
                    statusBadgeColor = 'bg-yellow-500';
                }

                row.innerHTML = `
                    <td class="px-4 py-3 text-center">${startIndex + index + 1}</td>
                    <td class="px-4 py-3">${item.houseNumber}${item.soi ? '/' + item.soi : ''}</td>
                    <td class="px-4 py-3">${item.name}</td>
                    <td class="px-4 py-3 text-center">${item.dueMonth || '-'}</td>
                    <td class="px-4 py-3 text-center">${formatCurrency(calculateTotalDue(item))}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="text-white text-xs font-medium px-2.5 py-0.5 rounded ${statusBadgeColor}">
                            ${warningStatusText}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            renderOverduePagination(data.length);
        }

        // Calculate total due amount for a record
        function calculateTotalDue(item) {
            // Assuming a fixed amount of 1000 per month for calculation purposes
            // In a real scenario, this amount should come from your data or configuration
            const monthlyRate = 1000; 
            let overdueCount = 0;

            // Count overdue months based on status and payments
            if (item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
                // Count based on whether each month's payment is empty or not '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                for (const month in item.payments) {
                    if (item.payments[month] !== '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' && item.payments[month] !== '') {
                        overdueCount++;
                    }
                }
                // If no specific overdue month is identified but status is overdue, count all 12 months
                if (overdueCount === 0 && (item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')) {
                    overdueCount = 12;
                }
            }

            return overdueCount * monthlyRate;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        }

        // Render pagination for the overdue list
        function renderOverduePagination(totalItems) {
            const paginationDiv = document.getElementById('overduePagination');
            paginationDiv.innerHTML = '';
            totalOverdueItems = totalItems;
            const totalPages = Math.ceil(totalOverdueItems / overdueItemsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('px-3', 'py-1', 'mx-1', 'rounded', 'focus:outline-none', 'transition-colors');
                if (i === currentPageOverdue) {
                    button.classList.add('bg-blue-600', 'text-white');
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
                button.addEventListener('click', () => {
                    currentPageOverdue = i;
                    populateOverdueTable(getOverdueData()); // Re-populate table with new page
                });
                paginationDiv.appendChild(button);
            }
        }

        // Get filtered overdue data
        function getOverdueData() {
            const summaryYear = document.getElementById('summaryYearSelect').value;
            return allData.filter(item => item.year === summaryYear && (item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'));
        }

        // Update summary statistics
        function updateSummaryStats(data) {
            const summaryYear = document.getElementById('summaryYearSelect').value;
            const filteredData = data.filter(item => item.year === summaryYear);

            let totalIncome = 0;
            let totalPaidCount = 0;
            let totalOverdueCount = 0;
            const monthlyTotals = {}; // { 'January': { paid: 0, due: 0 }, ... }

            // Initialize monthly totals for the selected year
            monthNames.forEach(month => {
                monthlyTotals[month] = { paid: 0, due: 0, paidCount: 0, overdueCount: 0 };
            });

            filteredData.forEach(item => {
                let itemPaidCount = 0;
                let itemOverdueCount = 0;
                let itemTotalDue = 0;

                // Process payments for the current year's selected month
                for (const month of monthNames) {
                    const paymentStatus = item.payments[month];
                    const monthlyRate = 1000; // Assuming a fixed rate per month

                    if (paymentStatus === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                        totalPaidCount++;
                        itemPaidCount++;
                        monthlyTotals[month].paid += monthlyRate;
                        monthlyTotals[month].paidCount++;
                    } else if (paymentStatus !== '' && paymentStatus !== undefined) { // Handle other statuses like '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' or empty
                        totalOverdueCount++;
                        itemOverdueCount++;
                        itemTotalDue += monthlyRate;
                        monthlyTotals[month].due += monthlyRate;
                        monthlyTotals[month].overdueCount++;
                    }
                }
                totalIncome += itemTotalDue; // Sum of amounts due from overdue items
            });

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalPaid').textContent = `${totalPaidCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('totalOverdue').textContent = `${totalOverdueCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            // Calculate collection rate
            const collectionRate = totalPaidCount > 0 ? (totalPaidCount / (totalPaidCount + totalOverdueCount)) * 100 : 0;
            document.getElementById('collectionRate').textContent = `${collectionRate.toFixed(2)}%`;

            // Update monthly stats
            updateMonthlyStats(monthlyTotals, summaryYear);

            // Update collection performance
            updateCollectionPerformance(monthlyTotals);

            // Populate and render overdue table for the selected year
            currentPageOverdue = 1; // Reset to first page for overdue list
            populateOverdueTable(getOverdueData());
        }

        // Update monthly statistics display
        function updateMonthlyStats(monthlyTotals, year) {
            const monthlyStatsDiv = document.getElementById('monthlyStats');
            monthlyStatsDiv.innerHTML = ''; // Clear previous stats

            const sortedMonths = monthNames; // Use the defined order

            sortedMonths.forEach(month => {
                const monthData = monthlyTotals[month];
                const statElement = document.createElement('div');
                statElement.classList.add('text-center', 'p-2', 'bg-blue-50', 'rounded-lg'); // Adjusted styling
                
                const monthLabel = monthShortNames[monthNames.indexOf(month)]; // Use short names

                statElement.innerHTML = `
                    <div class="text-lg font-semibold text-blue-800">${monthLabel}</div>
                    <p class="text-sm text-green-700 font-medium mt-1">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${monthData.paidCount}</p>
                    <p class="text-sm text-red-700 font-medium">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${monthData.overdueCount}</p>
                `;
                monthlyStatsDiv.appendChild(statElement);
            });
        }
        
        // Update collection performance metrics
        function updateCollectionPerformance(monthlyTotals) {
            let bestMonth = { name: '-', rate: -1 };
            let worstMonth = { name: '-', rate: 101 }; // Initialize with a rate > 100%
            let totalMonthlyRate = 0;
            let validMonthsCount = 0;

            monthNames.forEach(month => {
                const monthData = monthlyTotals[month];
                const totalForMonth = monthData.paidCount + monthData.overdueCount;
                let currentMonthRate = 0;

                if (totalForMonth > 0) {
                    currentMonthRate = (monthData.paidCount / totalForMonth) * 100;
                    totalMonthlyRate += currentMonthRate;
                    validMonthsCount++;

                    if (currentMonthRate > bestMonth.rate) {
                        bestMonth = { name: monthShortNames[monthNames.indexOf(month)], rate: currentMonthRate };
                    }
                    if (currentMonthRate < worstMonth.rate) {
                        worstMonth = { name: monthShortNames[monthNames.indexOf(month)], rate: currentMonthRate };
                    }
                }
            });

            document.getElementById('bestMonth').textContent = `${bestMonth.name} (${bestMonth.rate.toFixed(2)}%)`;
            document.getElementById('worstMonth').textContent = `${worstMonth.name} (${worstMonth.rate.toFixed(2)}%)`;
            const avgMonthRate = validMonthsCount > 0 ? totalMonthlyRate / validMonthsCount : 0;
            document.getElementById('avgMonth').textContent = `${avgMonthRate.toFixed(2)}%`;
        }

        // Initialize charts
        function initializeCharts(data) {
            // Filter data for the current year (or a default year if no selection)
            const summaryYear = document.getElementById('summaryYearSelect').value;
            const filteredData = data.filter(item => item.year === summaryYear);

            // Prepare data for monthly chart
            const monthlyData = {
                labels: monthShortNames,
                datasets: [
                    {
                        label: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        data: monthNames.map(month => filteredData.filter(item => item.payments[month] === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß').length),
                        backgroundColor: 'rgba(76, 187, 23, 0.6)',
                        borderColor: 'rgba(76, 187, 23, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                        barPercentage: 0.6
                    },
                    {
                        label: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞',
                        data: monthNames.map(month => filteredData.filter(item => item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || item.status === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô').length), // Count based on status for simplicity
                        backgroundColor: 'rgba(239, 68, 68, 0.6)', // red-500
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }
                ]
            };

            // Prepare data for yearly comparison chart
            const yearCounts = {};
            data.forEach(item => {
                yearCounts[item.year] = (yearCounts[item.year] || 0) + 1;
            });
            const sortedYears = Object.keys(yearCounts).sort((a, b) => parseInt(a) - parseInt(b));
            const yearlyData = {
                labels: sortedYears,
                datasets: [
                    {
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                        data: sortedYears.map(year => yearCounts[year]),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // blue-500
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }
                ]
            };

            // Destroy existing charts if they exist
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            if (yearlyChart) {
                yearlyChart.destroy();
            }

            // Render monthly chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: monthlyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${summaryYear})`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' }
                        }
                    }
                }
            });

            // Render yearly comparison chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'bar',
                data: yearlyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡∏õ‡∏µ',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' }
                        }
                    }
                }
            });
        }

        // Handle page switching
        function switchPage(pageId) {
            const searchPage = document.getElementById('searchPage');
            const summaryPage = document.getElementById('summaryPage');
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');

            // Hide all pages first
            searchPage.classList.add('hidden');
            summaryPage.classList.add('hidden');

            if (pageId === 'search') {
                searchPage.classList.remove('hidden');
                pageTitle.textContent = 'üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
                pageSubtitle.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô';
                currentPage = 'search';
                // Re-render cards with current filter if needed
                filterData(); 
            } else if (pageId === 'summary') {
                summaryPage.classList.remove('hidden');
                pageTitle.textContent = 'üìä ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                pageSubtitle.textContent = '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô';
                currentPage = 'summary';
                // Load and display summary data
                loadAndDisplaySummary();
            }
        }

        async function loadAndDisplaySummary() {
            const loading = document.getElementById('loading');
            const summaryPageContent = document.getElementById('summaryPage'); // Ensure this is the main container for summary
            
            loading.classList.remove('hidden');
            summaryPageContent.classList.add('hidden'); // Hide content while loading

            try {
                const summaryData = await loadSummaryData();
                if (summaryData && summaryData.length > 0) {
                    initializeCharts(summaryData); // Initialize charts first
                    updateSummaryStats(summaryData); // Then update stats which uses charts data
                    summaryPageContent.classList.remove('hidden'); // Show content after loading
                } else {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ");
                }
            } catch (error) {
                showError(error.message);
                summaryPageContent.classList.remove('hidden'); // Show page even if error, to display error message
            } finally {
                loading.classList.add('hidden'); // Hide loading indicator
            }
        }

        // Event Listeners
        document.getElementById('searchPageBtn').addEventListener('click', () => switchPage('search'));
        document.getElementById('summaryPageBtn').addEventListener('click', () => switchPage('summary'));
        document.getElementById('searchBtn').addEventListener('click', filterData);
        document.getElementById('loadAllBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearSelect').value = '';
            filterData();
        });
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearSelect').value = '';
            filterData(); // Re-render with empty filters
        });
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('yearSelect').addEventListener('change', filterData);
        document.getElementById('summaryYearSelect').addEventListener('change', () => loadAndDisplaySummary());
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            switchPage('search'); // Start on the search page
            loadData(); // Load data for the search page
        });

    </script>
</body>
</html>
