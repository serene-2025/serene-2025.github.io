<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .animated-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .loading { 
            animation: spin 1s linear infinite; 
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }
        
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .card-hover:hover::before {
            left: 100%;
        }
        
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-text {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8),
                         0 0 10px rgba(255, 255, 255, 0.8),
                         0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 300% 300%;
            animation: gradientBorder 3s ease infinite;
        }
        
        @keyframes gradientBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .status-badge {
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="animated-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Navigation -->
        <div class="text-center mb-6">
            <div class="glass-effect rounded-2xl p-4 mb-6">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button 
                        id="searchPageBtn"
                        class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
                    >
                        üîç ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button 
                        id="summaryPageBtn"
                        class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
                    >
                        üìä ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>



        <!-- Header -->
        <div class="text-center mb-8 floating">
            <div class="glass-effect rounded-2xl p-8 mb-6">
                <h1 id="pageTitle" class="text-5xl font-bold text-white mb-4 neon-text">
                    üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
                </h1>
                <p id="pageSubtitle" class="text-white text-xl opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</p>
                <div class="flex justify-center mt-4 space-x-2">
                    <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce"></div>
                    <div class="w-3 h-3 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
                

            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage">
            <!-- Search Section -->
            <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 border-2 gradient-border">
                <div class="bg-white bg-opacity-90 rounded-xl p-6">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•, ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ..."
                                    class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 outline-none text-lg transition-all duration-300 shadow-inner"
                                >
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <select 
                                    id="yearSelect" 
                                    class="pl-10 pr-8 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none text-lg transition-all duration-300 shadow-inner bg-white min-w-[160px]"
                                >
                                    <option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                                    <option value="2570">üìÖ ‡∏õ‡∏µ 2570</option>
                                    <option value="2569">üìÖ ‡∏õ‡∏µ 2569</option>
                                    <option value="2568">üìÖ ‡∏õ‡∏µ 2568</option>
                                    <option value="2567">üìÖ ‡∏õ‡∏µ 2567</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button 
                                id="searchBtn"
                                class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl pulse-button transform hover:scale-105"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                            <button 
                                id="loadAllBtn"
                                class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
                            >
                                üìã ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button 
                                id="clearBtn"
                                class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
                            >
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Page -->
        <div id="summaryPage" class="hidden">
            <!-- Year Selection for Summary -->
            <div class="glass-effect rounded-2xl shadow-2xl p-6 mb-8 border-2 gradient-border">
                <div class="bg-white bg-opacity-90 rounded-xl p-4">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <label class="text-lg font-bold text-gray-700">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                        <select 
                            id="summaryYearSelect" 
                            class="px-6 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none text-lg transition-all duration-300 shadow-inner bg-white min-w-[160px]"
                        >
                            <option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                            <option value="2570">üìÖ ‡∏õ‡∏µ 2570</option>
                            <option value="2569">üìÖ ‡∏õ‡∏µ 2569</option>
                            <option value="2568">üìÖ ‡∏õ‡∏µ 2568</option>
                            <option value="2567">üìÖ ‡∏õ‡∏µ 2567</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">üí∞</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
                    <p id="totalIncome" class="text-3xl font-bold text-yellow-300">0 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">‚úÖ</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <p id="totalPaid" class="text-3xl font-bold text-green-300">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">‚ö†Ô∏è</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h3>
                    <p id="totalOverdue" class="text-3xl font-bold text-red-300">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-3">üìä</div>
                    <h3 class="text-white text-lg font-bold mb-2">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö</h3>
                    <p id="collectionRate" class="text-3xl font-bold text-blue-300">0%</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Collection Comparison Chart -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-white text-xl font-bold mb-4 text-center">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="bg-white rounded-xl p-4">
                        <canvas id="monthlyChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- Yearly Comparison Chart -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-white text-xl font-bold mb-4 text-center">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                    <div class="bg-white rounded-xl p-4">
                        <canvas id="yearlyChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Statistics -->
            <div class="glass-effect rounded-2xl p-6 mb-8">
                <h3 class="text-white text-xl font-bold mb-4 text-center">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <div class="bg-white rounded-xl p-4">
                    <div id="monthlyStats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <!-- Monthly stats will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Collection Performance -->
            <div class="glass-effect rounded-2xl p-6 mb-8">
                <h3 class="text-white text-xl font-bold mb-4 text-center">üéØ ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <div class="bg-white rounded-xl p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <div class="text-2xl mb-2">üèÜ</div>
                            <h4 class="font-bold text-green-700 mb-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                            <p id="bestMonth" class="text-green-600 font-medium">-</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-xl">
                            <div class="text-2xl mb-2">üìâ</div>
                            <h4 class="font-bold text-red-700 mb-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                            <p id="worstMonth" class="text-red-600 font-medium">-</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-xl">
                            <div class="text-2xl mb-2">üìä</div>
                            <h4 class="font-bold text-blue-700 mb-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <p id="avgMonth" class="text-blue-600 font-medium">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue List -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h3 class="text-white text-xl font-bold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h3>
                    <div class="flex items-center gap-4 mt-2 sm:mt-0">
                        <select id="overdueYearFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                            <option value="">üìÖ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                            <option value="2570">üìÖ ‡∏õ‡∏µ 2570</option>
                            <option value="2569">üìÖ ‡∏õ‡∏µ 2569</option>
                            <option value="2568">üìÖ ‡∏õ‡∏µ 2568</option>
                            <option value="2567">üìÖ ‡∏õ‡∏µ 2567</option>
                        </select>
                        <div class="text-white text-sm">
                            ‡∏£‡∏ß‡∏° <span id="totalOverdueCount" class="font-bold text-yellow-300">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏õ‡∏µ</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTableBody">
                                <!-- Overdue records will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div id="overduePagination" class="flex justify-center items-center gap-2 mt-4 pt-4 border-t border-gray-200">
                        <button id="prevPageBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            ‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤</span>
                            <span id="currentPageNum" class="px-3 py-1 bg-blue-500 text-white rounded-lg font-bold">1</span>
                            <span class="text-sm text-gray-600">‡∏à‡∏≤‡∏Å</span>
                            <span id="totalPagesNum" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg font-bold">1</span>
                        </div>
                        <button id="nextPageBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-12">
            <div class="glass-effect rounded-2xl p-8 mx-auto max-w-md">
                <div class="loading w-12 h-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-6"></div>
                <p class="text-white text-xl font-medium">‚ú® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                <div class="flex justify-center mt-4 space-x-1">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mb-6">
            <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-4 rounded-2xl shadow-lg">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">‚ö†Ô∏è</div>
                    <div>
                        <p class="font-bold text-lg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</p>
                        <p id="errorText" class="opacity-90"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div id="resultsCount" class="hidden mb-6">
            <div class="glass-effect rounded-2xl p-4 text-center">
                <p class="text-white text-lg">
                    üéØ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="countNumber" class="font-bold text-yellow-300">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </p>
            </div>
        </div>

        <!-- Data Container -->
        <div id="dataContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Search results will be displayed here -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="glass-effect rounded-2xl p-12 mx-auto max-w-md">
                <div class="text-6xl mb-6 floating">üîç</div>
                <h3 class="text-2xl font-bold text-white mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-white opacity-80 text-lg">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <div class="mt-6 flex justify-center space-x-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const SHEET_ID = '1yklkO0OaVsZKpJc4EGcNDkpRsNd8DNWiJKlUnpBwBEE';
        const SHEET_NAME = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
        let allData = [];
        let currentPage = 'search';
        let monthlyChart = null;
        let yearlyChart = null;
        let allOverdueData = [];
        let currentOverduePage = 1;
        const overdueItemsPerPage = 20;

        // Month names in Thai
        const monthNames = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];
        
        const monthShortNames = [
            '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
            '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
        ];

        // Load data from Google Sheets CSV
        async function loadData() {
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            
            loading.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                console.log('Loading CSV from:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV loaded, length:', csvText.length);
                
                if (!csvText.trim()) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô');
                }
                
                allData = parseCSV(csvText);
                loading.classList.add('hidden');
                console.log('Successfully loaded', allData.length, 'records');
                return allData;
                
            } catch (error) {
                loading.classList.add('hidden');
                let errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                }
                
                showError(errorMsg);
                console.error('Error loading data:', error);
                return [];
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            // Remove quotes and split headers
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            console.log('CSV Headers:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;
                
                const record = {
                    id: values[0] || '',
                    name: values[1] || '',
                    houseNumber: values[2] || '',
                    soi: values[3] || '',
                    transferDate: values[4] || '',
                    dueMonth: values[5] || '',
                    year: values[6] || '',
                    payments: {}
                };
                
                // Map payment status for each month (columns 7-18)
                const monthNames = [
                    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                ];
                
                monthNames.forEach((month, index) => {
                    const columnIndex = 7 + index;
                    record.payments[month] = values[columnIndex] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                });
                
                data.push(record);
            }
            
            return data;
        }

        // Parse a single CSV line handling quotes and commas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Display data as cards
        function displayData(data) {
            const container = document.getElementById('dataContainer');
            const resultsCount = document.getElementById('resultsCount');
            const countNumber = document.getElementById('countNumber');
            const noResults = document.getElementById('noResults');
            
            container.innerHTML = '';
            
            if (data.length === 0) {
                noResults.classList.remove('hidden');
                resultsCount.classList.add('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            resultsCount.classList.remove('hidden');
            countNumber.textContent = data.length;
            
            // Sort data by year (newest first), then by house number (ascending)
            const sortedData = [...data].sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                
                // First sort by year (descending - newest first)
                if (yearB !== yearA) {
                    return yearB - yearA;
                }
                
                // Then sort by house number (ascending)
                const houseA = a.houseNumber || '';
                const houseB = b.houseNumber || '';
                
                // Extract numeric part for proper sorting
                const numA = parseInt(houseA.replace(/\D/g, '')) || 0;
                const numB = parseInt(houseB.replace(/\D/g, '')) || 0;
                
                if (numA !== numB) {
                    return numA - numB;
                }
                
                // If numeric parts are same, sort alphabetically
                return houseA.localeCompare(houseB, 'th');
            });
            
            // Group by year for better display
            const groupedByYear = {};
            sortedData.forEach(record => {
                const year = record.year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ';
                if (!groupedByYear[year]) {
                    groupedByYear[year] = [];
                }
                groupedByYear[year].push(record);
            });
            
            // Display grouped data with year headers
            const years = Object.keys(groupedByYear).sort((a, b) => {
                const yearA = parseInt(a) || 0;
                const yearB = parseInt(b) || 0;
                return yearB - yearA; // Newest year first
            });
            
            years.forEach(year => {
                // Add year header
                const yearHeader = document.createElement('div');
                yearHeader.className = 'col-span-full mb-4';
                yearHeader.innerHTML = `
                    <div class="glass-effect rounded-xl p-4 text-center">
                        <h2 class="text-2xl font-bold text-white neon-text">
                            üìÖ ‡∏õ‡∏µ ${year} 
                            <span class="text-lg opacity-80">(${groupedByYear[year].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                        </h2>
                    </div>
                `;
                container.appendChild(yearHeader);
                
                // Add cards for this year
                groupedByYear[year].forEach(record => {
                    const card = createCard(record);
                    container.appendChild(card);
                });
            });
        }

        // Get overdue status based on unpaid months
        function getOverdueStatus(unpaidCount) {
            if (unpaidCount === 0) {
                return {
                    text: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
                    icon: '‚úÖ',
                    color: 'bg-green-500 text-white'
                };
            } else if (unpaidCount === 1) {
                return {
                    text: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                    icon: '‚ö†Ô∏è',
                    color: 'bg-yellow-500 text-white'
                };
            } else if (unpaidCount === 2) {
                return {
                    text: '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                    icon: '‚è∞',
                    color: 'bg-orange-500 text-white'
                };
            } else if (unpaidCount >= 3 && unpaidCount <= 5) {
                return {
                    text: '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'üìÆ',
                    color: 'bg-red-500 text-white'
                };
            } else if (unpaidCount >= 6) {
                return {
                    text: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô',
                    icon: 'üö®',
                    color: 'bg-red-700 text-white'
                };
            } else {
                return {
                    text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    icon: '‚ùì',
                    color: 'bg-gray-500 text-white'
                };
            }
        }

        // Create individual card
        function createCard(record) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl shadow-2xl p-0 card-hover overflow-hidden';
            
            // Count paid months (including ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö for display but not for amount calculation)
            const paidMonths = Object.values(record.payments).filter(status => 
                status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' || status === '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö'
            ).length;
            
            // Count only paid months that require payment for amount calculation
            const paidAmountMonths = Object.values(record.payments).filter(status => 
                status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤'
            ).length;
            
            // Calculate overdue months
            const unpaidMonths = Object.values(record.payments).filter(status => 
                status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'
            ).length;
            
            // Get card gradient based on overdue status
            const getCardGradient = (unpaidCount) => {
                if (unpaidCount === 0) {
                    return 'from-green-400 to-green-500'; // All paid - Green
                } else if (unpaidCount === 1) {
                    return 'from-yellow-400 to-orange-400'; // 1 month overdue - Yellow/Light Orange
                } else if (unpaidCount === 2) {
                    return 'from-orange-500 to-red-400'; // 2 months overdue - Light Red
                } else if (unpaidCount >= 3) {
                    return 'from-red-500 to-red-600'; // 3+ months overdue - Dark Red
                } else {
                    return 'from-blue-400 to-blue-500'; // Default - Blue
                }
            };
            
            const cardGradient = getCardGradient(unpaidMonths);
            const overdueStatus = getOverdueStatus(unpaidMonths);
            
            card.innerHTML = `
                <div class="bg-gradient-to-r ${cardGradient} p-5 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-white bg-opacity-10 rounded-full -mr-12 -mt-12"></div>
                    <div class="absolute bottom-0 left-0 w-20 h-20 bg-white bg-opacity-10 rounded-full -ml-10 -mb-10"></div>
                    <div class="relative z-10 flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-2xl font-bold text-white mb-1 neon-text truncate">üìÖ ‡∏õ‡∏µ ${record.year}</h3>
                            <p class="text-white text-sm opacity-90 truncate">‡∏£‡∏´‡∏±‡∏™: ${record.id}</p>
                        </div>
                        <div class="ml-3 flex-shrink-0">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${overdueStatus.color} shadow-lg whitespace-nowrap status-badge">
                                ${overdueStatus.icon} ${overdueStatus.text}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- Personal Information -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                            <div class="text-center space-y-2">
                                <div class="font-bold text-xl text-blue-700">${record.name}</div>
                                <div class="text-gray-600">üè† ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${record.houseNumber} ${record.soi}</div>
                                <div class="text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ: ${record.id}</div>
                            </div>
                        </div>
                        
                        <!-- Payment Summary -->
                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-4 rounded-xl border border-emerald-200">
                            <h5 class="font-bold text-gray-800 mb-3 text-center">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${paidMonths}</div>
                                    <div class="text-sm text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                                    <div class="text-xs text-green-600 font-medium">${paidAmountMonths * 300} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600">${unpaidMonths}</div>
                                    <div class="text-sm text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                                    <div class="text-xs text-red-600 font-medium">${unpaidMonths * 300} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer and Due Information -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-xs text-gray-600 mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</div>
                                    <div class="font-bold text-purple-600">${record.transferDate}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-600 mb-1">‚è∞ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
                                    <div class="font-bold text-orange-600">${record.dueMonth}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Payment Status -->
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl">
                            <h4 class="font-bold text-gray-800 mb-3 text-center">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <div class="grid grid-cols-4 gap-2">
                                ${monthNames.map((month, index) => {
                                    const status = record.payments[month] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                                    let statusClass = 'bg-gray-200 text-gray-700';
                                    let statusIcon = '‚ùì';
                                    
                                    if (status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                                        statusClass = 'bg-green-500 text-white';
                                        statusIcon = '‚úÖ';
                                    } else if (status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤') {
                                        statusClass = 'bg-blue-500 text-white';
                                        statusIcon = '‚è∞';
                                    } else if (status === '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö') {
                                        statusClass = 'bg-purple-500 text-white';
                                        statusIcon = 'üö´';
                                    } else if (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') {
                                        statusClass = 'bg-red-500 text-white';
                                        statusIcon = '‚ùå';
                                    } else if (status === '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                                        statusClass = 'bg-yellow-500 text-white';
                                        statusIcon = '‚è≥';
                                    }
                                    
                                    return `
                                        <div class="text-center p-2 rounded-lg ${statusClass} shadow-sm transform hover:scale-105 transition-all duration-200">
                                            <div class="text-xs font-bold mb-1">${monthShortNames[index]}</div>
                                            <div class="text-lg">${statusIcon}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Status Legend -->
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="flex items-center gap-1">
                                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                        <span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                        <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                                        <span>‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                                        <span>‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Search functionality
        function searchData() {
            if (allData.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedYear = document.getElementById('yearSelect').value;
            
            let filteredData = allData;
            
            // Filter by year if selected
            if (selectedYear) {
                filteredData = filteredData.filter(record => record.year === selectedYear);
            }
            
            // Filter by search term if provided
            if (searchTerm !== '') {
                filteredData = filteredData.filter(record => {
                    const matchName = record.name && record.name.toLowerCase().includes(searchTerm);
                    const matchHouse = record.houseNumber && record.houseNumber.toLowerCase() === searchTerm;
                    const matchId = record.id && record.id.toLowerCase().includes(searchTerm);
                    const matchSoi = record.soi && record.soi.toLowerCase().includes(searchTerm);
                    
                    return matchName || matchHouse || matchId || matchSoi;
                });
            }
            
            displayData(filteredData);
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearSelect').value = '';
            displayData(allData);
        }

        // Load all data
        async function loadAllData() {
            const data = await loadData();
            if (data.length > 0) {
                displayData(data);
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) {
                existingSuccess.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message mb-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-2xl shadow-lg';
            successDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">‚úÖ</div>
                    <div>
                        <p class="font-bold text-lg">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                        <p class="opacity-90">${message}</p>
                    </div>
                </div>
            `;
            
            const container = document.querySelector('.container');
            const firstChild = container.firstElementChild;
            container.insertBefore(successDiv, firstChild);
            
            // Auto remove success message after 3 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Enter key search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        // Page Navigation
        async function showPage(page) {
            currentPage = page;
            
            // Hide all pages
            document.getElementById('searchPage').classList.add('hidden');
            document.getElementById('summaryPage').classList.add('hidden');
            
            // Update navigation buttons
            document.getElementById('searchPageBtn').classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-purple-700');
            document.getElementById('summaryPageBtn').classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-purple-700');
            
            if (page === 'search') {
                document.getElementById('searchPage').classList.remove('hidden');
                document.getElementById('searchPageBtn').classList.add('bg-gradient-to-r', 'from-purple-600', 'to-purple-700');
                document.getElementById('pageTitle').textContent = 'üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
                document.getElementById('pageSubtitle').textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô';
            } else if (page === 'summary') {
                document.getElementById('summaryPage').classList.remove('hidden');
                document.getElementById('summaryPageBtn').classList.add('bg-gradient-to-r', 'from-purple-600', 'to-purple-700');
                document.getElementById('pageTitle').textContent = 'üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';
                document.getElementById('pageSubtitle').textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏õ‡∏µ';
                await updateSummary();
            }
        }

        // Update Summary Data
        async function updateSummary() {
            const selectedYear = document.getElementById('summaryYearSelect').value;
            
            // Use existing data if available, otherwise load it
            let yearData = [];
            if (allData.length === 0) {
                await loadAllData();
            }
            
            // Filter data for selected year
            if (selectedYear) {
                yearData = allData.filter(record => record.year === selectedYear);
            } else {
                yearData = allData;
            }
            
            if (yearData.length === 0) {
                // Reset all displays to zero if no data
                document.getElementById('totalIncome').textContent = '0 ‡∏ö‡∏≤‡∏ó';
                document.getElementById('totalPaid').textContent = '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                document.getElementById('totalOverdue').textContent = '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                document.getElementById('collectionRate').textContent = '0%';
                
                // Clear other sections
                document.getElementById('monthlyStats').innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                document.getElementById('overdueTableBody').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td></tr>';
                
                // Clear charts
                if (monthlyChart) {
                    monthlyChart.destroy();
                    monthlyChart = null;
                }
                if (yearlyChart) {
                    yearlyChart.destroy();
                    yearlyChart = null;
                }
                
                return;
            }
            
            // Enhanced calculation variables
            let totalActualIncome = 0;        // ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß + ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
            let totalExpectedIncome = 0;      // ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            let totalPaidTransactions = 0;    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            let totalOverdueTransactions = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞
            let totalHouseholds = yearData.length; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            
            const monthlyStats = {};
            const overdueList = [];
            const householdSummary = [];
            
            // Initialize monthly stats with enhanced tracking
            monthNames.forEach(month => {
                monthlyStats[month] = { 
                    paid: 0,           // ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß + ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                    overdue: 0,        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢
                    noCollection: 0,   // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö
                    waitingData: 0,    // ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    total: 0,          // ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    income: 0          // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                };
            });
            
            // Process each household record
            yearData.forEach(record => {
                let householdPaid = 0;
                let householdOverdue = 0;
                let householdIncome = 0;
                let householdExpected = 0;
                const householdMonthlyStatus = {};
                
                monthNames.forEach(month => {
                    const status = record.payments[month] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    householdMonthlyStatus[month] = status;
                    
                    // Count for monthly statistics
                    monthlyStats[month].total++;
                    
                    if (status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤') {
                        monthlyStats[month].paid++;
                        monthlyStats[month].income += 300;
                        householdPaid++;
                        householdIncome += 300;
                        totalActualIncome += 300;
                        totalPaidTransactions++;
                    } else if (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') {
                        monthlyStats[month].overdue++;
                        householdOverdue++;
                        totalOverdueTransactions++;
                        householdExpected += 300; // ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                    } else if (status === '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö') {
                        monthlyStats[month].noCollection++;
                        // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
                    } else if (status === '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                        monthlyStats[month].waitingData++;
                        householdExpected += 300; // ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ
                    } else {
                        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ
                        householdExpected += 300;
                    }
                });
                
                // Calculate total expected income (paid + should be paid)
                totalExpectedIncome += (householdIncome + householdExpected);
                
                // Add to household summary
                householdSummary.push({
                    ...record,
                    paidMonths: householdPaid,
                    overdueMonths: householdOverdue,
                    actualIncome: householdIncome,
                    expectedIncome: householdIncome + householdExpected,
                    monthlyStatus: householdMonthlyStatus
                });
                
                // Add to overdue list if has overdue payments
                if (householdOverdue > 0) {
                    overdueList.push({
                        ...record,
                        overdueMonths: householdOverdue,
                        overdueAmount: householdOverdue * 300,
                        paidMonths: householdPaid
                    });
                }
            });
            
            // Calculate enhanced metrics
            const collectionRate = totalExpectedIncome > 0 ? 
                ((totalActualIncome / totalExpectedIncome) * 100).toFixed(1) : 0;
            
            const averageIncomePerHousehold = totalHouseholds > 0 ? 
                (totalActualIncome / totalHouseholds).toFixed(0) : 0;
            
            const overdueRate = (totalPaidTransactions + totalOverdueTransactions) > 0 ? 
                ((totalOverdueTransactions / (totalPaidTransactions + totalOverdueTransactions)) * 100).toFixed(1) : 0;
            
            // Update summary cards with enhanced data
            document.getElementById('totalIncome').innerHTML = `
                <div class="text-3xl font-bold text-yellow-300">${totalActualIncome.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                <div class="text-sm text-yellow-200 mt-1">‡∏à‡∏≤‡∏Å ${totalExpectedIncome.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</div>
            `;
            
            document.getElementById('totalPaid').innerHTML = `
                <div class="text-3xl font-bold text-green-300">${totalPaidTransactions.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                <div class="text-sm text-green-200 mt-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${averageIncomePerHousehold} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</div>
            `;
            
            document.getElementById('totalOverdue').innerHTML = `
                <div class="text-3xl font-bold text-red-300">${totalOverdueTransactions.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                <div class="text-sm text-red-200 mt-1">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${overdueRate}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            `;
            
            document.getElementById('collectionRate').innerHTML = `
                <div class="text-3xl font-bold text-blue-300">${collectionRate}%</div>
                <div class="text-sm text-blue-200 mt-1">‡∏à‡∏≤‡∏Å ${totalHouseholds} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</div>
            `;
            
            // Update charts with enhanced data
            updateCharts(monthlyStats, selectedYear);
            
            // Update monthly statistics
            updateMonthlyStatistics(monthlyStats);
            
            // Update performance metrics
            updatePerformanceMetrics(monthlyStats);
            
            // Update overdue table with enhanced data
            updateOverdueTable(overdueList);
            
            // Log summary for debugging (can be removed in production)
            console.log('Summary Calculations:', {
                selectedYear,
                totalHouseholds,
                totalActualIncome,
                totalExpectedIncome,
                totalPaidTransactions,
                totalOverdueTransactions,
                collectionRate: collectionRate + '%'
            });
        }

        // Update Charts
        function updateCharts(monthlyStats, selectedYear) {
            const monthLabels = monthShortNames;
            
            // Prepare comparison data
            const paidData = monthNames.map(month => monthlyStats[month].paid);
            const overdueData = monthNames.map(month => monthlyStats[month].overdue);
            const noCollectionData = monthNames.map(month => monthlyStats[month].noCollection);
            const waitingData = monthNames.map(month => monthlyStats[month].waitingData);
            
            // Collection Comparison Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß + ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)',
                            data: paidData,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢)',
                            data: overdueData,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                            data: noCollectionData,
                            backgroundColor: 'rgba(147, 51, 234, 0.8)',
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                            data: waitingData,
                            backgroundColor: 'rgba(251, 191, 36, 0.8)',
                            borderColor: 'rgba(251, 191, 36, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Yearly Comparison Chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            if (yearlyChart) {
                yearlyChart.destroy();
            }
            
            // Calculate yearly comparison data
            const years = ['2567', '2568', '2569', '2570'];
            const yearlyData = years.map(year => {
                const yearRecords = allData.filter(record => record.year === year);
                let yearPaid = 0;
                
                yearRecords.forEach(record => {
                    monthNames.forEach(month => {
                        const status = record.payments[month] || '';
                        if (status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤') {
                            yearPaid++;
                        }
                    });
                });
                
                return yearPaid;
            });
            
            yearlyChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°',
                        data: yearlyData,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update Monthly Statistics with Enhanced Display
        function updateMonthlyStatistics(monthlyStats) {
            const container = document.getElementById('monthlyStats');
            container.innerHTML = '';
            
            monthNames.forEach((month, index) => {
                const stats = monthlyStats[month];
                const percentage = stats.total > 0 ? ((stats.paid / stats.total) * 100).toFixed(1) : 0;
                const income = stats.income || 0;
                
                // Determine color based on collection rate
                let colorClass = 'bg-gray-50 border-gray-200';
                let textColorClass = 'text-gray-700';
                let percentageColorClass = 'text-gray-500';
                
                if (percentage >= 90) {
                    colorClass = 'bg-green-50 border-green-200';
                    textColorClass = 'text-green-700';
                    percentageColorClass = 'text-green-600';
                } else if (percentage >= 75) {
                    colorClass = 'bg-blue-50 border-blue-200';
                    textColorClass = 'text-blue-700';
                    percentageColorClass = 'text-blue-600';
                } else if (percentage >= 50) {
                    colorClass = 'bg-yellow-50 border-yellow-200';
                    textColorClass = 'text-yellow-700';
                    percentageColorClass = 'text-yellow-600';
                } else if (percentage > 0) {
                    colorClass = 'bg-red-50 border-red-200';
                    textColorClass = 'text-red-700';
                    percentageColorClass = 'text-red-600';
                }
                
                const div = document.createElement('div');
                div.className = `text-center p-3 ${colorClass} rounded-lg border-2 hover:shadow-md transition-all duration-200`;
                div.innerHTML = `
                    <div class="font-bold text-sm ${textColorClass} mb-2">${monthShortNames[index]}</div>
                    <div class="space-y-1">
                        <div class="text-lg font-bold ${textColorClass}">${stats.paid}/${stats.total}</div>
                        <div class="text-xs ${percentageColorClass} font-medium">${percentage}%</div>
                        <div class="text-xs text-gray-600 mt-1">${income.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                        ${stats.overdue > 0 ? `<div class="text-xs text-red-500">‡∏Ñ‡πâ‡∏≤‡∏á ${stats.overdue}</div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Update Performance Metrics with Enhanced Analysis
        function updatePerformanceMetrics(monthlyStats) {
            let bestMonth = '';
            let worstMonth = '';
            let bestRate = -1;
            let worstRate = 101;
            let totalRate = 0;
            let totalIncome = 0;
            let validMonths = 0;
            let bestIncomeMonth = '';
            let bestIncomeAmount = 0;
            
            monthNames.forEach((month, index) => {
                const stats = monthlyStats[month];
                if (stats.total > 0) {
                    const rate = (stats.paid / stats.total) * 100;
                    const income = stats.income || 0;
                    
                    totalRate += rate;
                    totalIncome += income;
                    validMonths++;
                    
                    // Track best collection rate
                    if (rate > bestRate) {
                        bestRate = rate;
                        bestMonth = monthShortNames[index] + ' (' + rate.toFixed(1) + '%)';
                    }
                    
                    // Track worst collection rate
                    if (rate < worstRate) {
                        worstRate = rate;
                        worstMonth = monthShortNames[index] + ' (' + rate.toFixed(1) + '%)';
                    }
                    
                    // Track best income month
                    if (income > bestIncomeAmount) {
                        bestIncomeAmount = income;
                        bestIncomeMonth = monthShortNames[index] + ' (' + income.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó)';
                    }
                }
            });
            
            const avgRate = validMonths > 0 ? (totalRate / validMonths).toFixed(1) : 0;
            const avgIncome = validMonths > 0 ? (totalIncome / validMonths).toFixed(0) : 0;
            
            // Enhanced display with more details
            document.getElementById('bestMonth').innerHTML = `
                <div class="font-bold text-green-600">${bestMonth || '-'}</div>
                ${bestIncomeMonth ? `<div class="text-xs text-gray-500 mt-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${bestIncomeMonth}</div>` : ''}
            `;
            
            document.getElementById('worstMonth').innerHTML = `
                <div class="font-bold text-red-600">${worstMonth || '-'}</div>
                ${worstRate < 101 ? `<div class="text-xs text-gray-500 mt-1">‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>` : ''}
            `;
            
            document.getElementById('avgMonth').innerHTML = `
                <div class="font-bold text-blue-600">${avgRate}%</div>
                <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${parseInt(avgIncome).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            `;
        }

        // Update Overdue Table with Enhanced Information and Pagination
        function updateOverdueTable(overdueList) {
            // Store all overdue data for pagination
            allOverdueData = [...overdueList];
            
            // Apply year filter if selected
            const selectedYear = document.getElementById('overdueYearFilter').value;
            let filteredData = allOverdueData;
            
            if (selectedYear) {
                filteredData = allOverdueData.filter(record => record.year === selectedYear);
            }
            
            // Update total count
            document.getElementById('totalOverdueCount').textContent = filteredData.length;
            
            // Sort by overdue months (descending), then by overdue amount (descending)
            filteredData.sort((a, b) => {
                if (b.overdueMonths !== a.overdueMonths) {
                    return b.overdueMonths - a.overdueMonths;
                }
                return b.overdueAmount - a.overdueAmount;
            });
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredData.length / overdueItemsPerPage);
            const startIndex = (currentOverduePage - 1) * overdueItemsPerPage;
            const endIndex = startIndex + overdueItemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Update pagination display
            document.getElementById('currentPageNum').textContent = currentOverduePage;
            document.getElementById('totalPagesNum').textContent = totalPages;
            
            // Update pagination buttons
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            prevBtn.disabled = currentOverduePage <= 1;
            nextBtn.disabled = currentOverduePage >= totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Render table
            const tbody = document.getElementById('overdueTableBody');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">üéâ</div>
                        <div class="font-medium">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                        <div class="text-sm">${selectedYear ? '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ' + selectedYear : '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß'}</div>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            pageData.forEach((record, index) => {
                const globalIndex = startIndex + index + 1; // Global ranking
                
                const getOverdueStatus = (months, paidMonths) => {
                    let statusInfo = {};
                    
                    if (months === 1) {
                        statusInfo = { text: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', class: 'bg-yellow-100 text-yellow-800', priority: '‡∏õ‡∏Å‡∏ï‡∏¥' };
                    } else if (months === 2) {
                        statusInfo = { text: '‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', class: 'bg-orange-100 text-orange-800', priority: '‡∏£‡∏∞‡∏ß‡∏±‡∏á' };
                    } else if (months >= 3 && months <= 5) {
                        statusInfo = { text: '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-red-100 text-red-800', priority: '‡∏î‡πà‡∏ß‡∏ô' };
                    } else if (months >= 6) {
                        statusInfo = { text: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', class: 'bg-red-200 text-red-900', priority: '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å' };
                    } else {
                        statusInfo = { text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', class: 'bg-gray-100 text-gray-800', priority: '-' };
                    }
                    
                    return statusInfo;
                };
                
                const status = getOverdueStatus(record.overdueMonths, record.paidMonths || 0);
                const collectionRate = record.paidMonths ? 
                    ((record.paidMonths / (record.paidMonths + record.overdueMonths)) * 100).toFixed(1) : 0;
                
                // Determine row color based on severity
                let rowClass = 'bg-white hover:bg-gray-50';
                if (index % 2 === 1) rowClass = 'bg-gray-50 hover:bg-gray-100';
                
                if (record.overdueMonths >= 6) {
                    rowClass += ' border-l-4 border-red-500';
                } else if (record.overdueMonths >= 3) {
                    rowClass += ' border-l-4 border-orange-500';
                } else if (record.overdueMonths >= 2) {
                    rowClass += ' border-l-4 border-yellow-500';
                }
                
                const row = document.createElement('tr');
                row.className = rowClass + ' transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${globalIndex}</span>
                            ${record.overdueMonths >= 6 ? '<span class="text-red-500">üö®</span>' : 
                              record.overdueMonths >= 3 ? '<span class="text-orange-500">‚ö†Ô∏è</span>' : 
                              '<span class="text-yellow-500">‚è∞</span>'}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${record.houseNumber}</div>
                        <div class="text-xs text-gray-500">${record.soi || ''}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${record.name}</div>
                        <div class="text-xs text-gray-500">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${record.paidMonths || 0}/12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="font-bold text-blue-600">${record.year}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="font-bold text-red-600 text-lg">${record.overdueMonths}</div>
                        <div class="text-xs text-gray-500">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="font-bold text-red-600">${record.overdueAmount.toLocaleString()}</div>
                        <div class="text-xs text-gray-500">‡∏ö‡∏≤‡∏ó</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="space-y-1">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${status.class} block">
                                ${status.text}
                            </span>
                            <div class="text-xs text-gray-500">
                                ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ä‡∏≥‡∏£‡∏∞ ${collectionRate}%
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add summary row at the bottom (only on last page)
            if (currentOverduePage === totalPages && filteredData.length > 0) {
                const totalOverdueAmount = filteredData.reduce((sum, record) => sum + record.overdueAmount, 0);
                const avgOverdueMonths = filteredData.length > 0 ? 
                    (filteredData.reduce((sum, record) => sum + record.overdueMonths, 0) / filteredData.length).toFixed(1) : 0;
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-gradient-to-r from-red-50 to-orange-50 border-t-2 border-red-200 font-bold';
                summaryRow.innerHTML = `
                    <td class="px-4 py-4 text-center text-red-700">üìä</td>
                    <td class="px-4 py-4 text-red-700">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°</td>
                    <td class="px-4 py-4 text-red-700">${filteredData.length} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</td>
                    <td class="px-4 py-4 text-center text-red-700">
                        <div class="text-sm">${selectedYear || '‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ'}</div>
                    </td>
                    <td class="px-4 py-4 text-center text-red-700">
                        <div>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgOverdueMonths}</div>
                        <div class="text-xs font-normal">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                    </td>
                    <td class="px-4 py-4 text-center text-red-700">
                        <div>${totalOverdueAmount.toLocaleString()}</div>
                        <div class="text-xs font-normal">‡∏ö‡∏≤‡∏ó</div>
                    </td>
                    <td class="px-4 py-4 text-center text-red-700">
                        <div class="text-sm">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                    </td>
                `;
                tbody.appendChild(summaryRow);
            }
        }

        // Pagination functions
        function goToPreviousPage() {
            if (currentOverduePage > 1) {
                currentOverduePage--;
                updateOverdueTable(allOverdueData);
            }
        }

        function goToNextPage() {
            const selectedYear = document.getElementById('overdueYearFilter').value;
            let filteredData = allOverdueData;
            
            if (selectedYear) {
                filteredData = allOverdueData.filter(record => record.year === selectedYear);
            }
            
            const totalPages = Math.ceil(filteredData.length / overdueItemsPerPage);
            
            if (currentOverduePage < totalPages) {
                currentOverduePage++;
                updateOverdueTable(allOverdueData);
            }
        }

        function filterOverdueByYear() {
            currentOverduePage = 1; // Reset to first page when filtering
            updateOverdueTable(allOverdueData);
        }

        // Test connection
        async function testConnection() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                console.log('Testing connection to:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (response.ok) {
                    const csvText = await response.text();
                    const testData = parseCSV(csvText);
                    
                    showSuccessMessage(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${testData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    console.log('Connection test successful, found', testData.length, 'records');
                    
                    // Load the actual data
                    await loadAllData();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showError('‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
                console.error('Connection test failed:', error);
            }
        }

        // Initialize page
        window.addEventListener('load', async () => {
            // Add event listeners
            document.getElementById('searchPageBtn').addEventListener('click', () => showPage('search'));
            document.getElementById('summaryPageBtn').addEventListener('click', () => showPage('summary'));
            document.getElementById('searchBtn').addEventListener('click', searchData);
            document.getElementById('loadAllBtn').addEventListener('click', loadAllData);
            document.getElementById('clearBtn').addEventListener('click', clearFilters);

            document.getElementById('yearSelect').addEventListener('change', searchData);
            document.getElementById('summaryYearSelect').addEventListener('change', updateSummary);
            document.getElementById('prevPageBtn').addEventListener('click', goToPreviousPage);
            document.getElementById('nextPageBtn').addEventListener('click', goToNextPage);
            document.getElementById('overdueYearFilter').addEventListener('change', filterOverdueByYear);
            
            // Try to load data automatically
            try {
                await loadAllData();
            } catch (error) {
                console.log('Auto-load failed, user can try manual load');
            }
            
            showPage('search');
        });


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e8170f440e7b54',t:'MTc2MDQ1NTUzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
