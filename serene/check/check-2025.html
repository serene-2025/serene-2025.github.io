<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            backdrop-filter: blur(10px);
        }
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .status-card {
            position: relative;
            overflow: hidden;
        }
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .status-card:hover::before {
            left: 100%;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <div class="glass-effect shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4 shadow-lg">
                    <span class="text-3xl">üè†</span>
                </div>
                <h1 class="text-4xl font-bold gradient-text mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h1>
                <p class="text-gray-600 text-lg">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <div class="mt-4 flex justify-center space-x-4 text-sm text-gray-500">
                    <span class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="glass-effect rounded-3xl shadow-2xl p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üè† ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                    <input type="text" id="houseSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 998/1" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                    <select id="yearSearch" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                        <option value="2567">2567</option>
                        <option value="2566">2566</option>
                        <option value="2565">2565</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="searchData()" 
                        class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-4 rounded-2xl font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:scale-105">
                    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="clearSearch()" 
                        class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-4 rounded-2xl font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:scale-105">
                    üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-8">
            <div class="search-animation text-4xl mb-4">üîç</div>
            <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- Results -->
        <div id="results" class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üòî</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
            <p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        </div>

        <!-- Payment History Modal -->
        <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-indigo-500 via-indigo-600 to-purple-600 p-6 text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>
                            <p class="text-indigo-100 mt-1" id="modalHouseNumber">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: -</p>
                        </div>
                        <button onclick="closePaymentModal()" 
                                class="text-white hover:text-gray-200 text-2xl font-bold w-10 h-10 rounded-full hover:bg-white hover:bg-opacity-20 transition-all">
                            ‚úï
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6 bg-gradient-to-b from-white to-gray-50 max-h-[70vh] overflow-y-auto">
                    <!-- Loading -->
                    <div id="modalLoading" class="text-center py-8">
                        <div class="search-animation text-4xl mb-4">üìä</div>
                        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>

                    <!-- Payment History List -->
                    <div id="paymentHistoryList" class="hidden">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                            <p class="text-sm text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
                        </div>
                        
                        <!-- Table Header -->
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-6 gap-2 md:gap-4 text-xs md:text-sm font-semibold text-gray-700">
                                <div>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</div>
                                <div>üë§ ‡∏ä‡∏∑‡πà‡∏≠</div>
                                <div>üè† ‡∏ö‡πâ‡∏≤‡∏ô</div>
                                <div>üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                                <div>üìÖ ‡∏õ‡∏µ</div>
                                <div>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                            </div>
                        </div>

                        <!-- Payment Records -->
                        <div id="paymentRecords" class="space-y-2">
                            <!-- Records will be populated here -->
                        </div>
                    </div>

                    <!-- No Payment Data -->
                    <div id="noPaymentData" class="hidden text-center py-8">
                        <div class="text-4xl mb-4">üìã</div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3>
                        <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="relative max-w-4xl w-full max-h-[90vh] bg-white rounded-3xl overflow-hidden shadow-2xl">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-white flex justify-between items-center">
                    <h3 class="text-lg font-bold" id="imageModalTitle">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                    <button onclick="closeImageModal()" 
                            class="text-white hover:text-gray-200 text-2xl font-bold w-10 h-10 rounded-full hover:bg-white hover:bg-opacity-20 transition-all">
                        ‚úï
                    </button>
                </div>
                
                <!-- Image Content -->
                <div class="p-4 bg-gray-50 max-h-[80vh] overflow-auto flex items-center justify-center">
                    <div id="imageLoading" class="text-center py-8">
                        <div class="search-animation text-4xl mb-4">üñºÔ∏è</div>
                        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</p>
                    </div>
                    <img id="modalImage" class="hidden max-w-full max-h-full object-contain rounded-lg shadow-lg" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                    <div id="imageError" class="hidden text-center py-8">
                        <div class="text-4xl mb-4">‚ùå</div>
                        <p class="text-red-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://kiumelolsilduqnvrekf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Month names in Thai (abbreviated)
        const monthNames = {
            january_status: '‡∏°.‡∏Ñ.',
            february_status: '‡∏Å.‡∏û.',
            march_status: '‡∏°‡∏µ.‡∏Ñ.',
            april_status: '‡πÄ‡∏°.‡∏¢.',
            may_status: '‡∏û.‡∏Ñ.',
            june_status: '‡∏°‡∏¥.‡∏¢.',
            july_status: '‡∏Å.‡∏Ñ.',
            august_status: '‡∏™.‡∏Ñ.',
            september_status: '‡∏Å.‡∏¢.',
            october_status: '‡∏ï.‡∏Ñ.',
            november_status: '‡∏û.‡∏¢.',
            december_status: '‡∏ò.‡∏Ñ.'
        };

        // Monthly fee calculation
        const MONTHLY_FEE = 300;

        // Load all data on page load
        window.addEventListener('load', () => {
            searchData();
        });

        // Add enter key support for search inputs
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        async function searchData() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const noResults = document.getElementById('noResults');

            // Show loading
            loading.classList.remove('hidden');
            results.innerHTML = '';
            noResults.classList.add('hidden');

            try {
                // Get search values
                const houseNumber = document.getElementById('houseSearch').value.trim();
                const paymentYear = document.getElementById('yearSearch').value;

                // Build query with timeout
                let query = supabase.from('inv').select('*');

                if (houseNumber) {
                    query = query.eq('house_number', houseNumber);
                }
                if (paymentYear) {
                    query = query.eq('payment_year', parseInt(paymentYear));
                }

                // Add timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á')), 10000);
                });

                const queryPromise = query.order('payment_year', { ascending: false }).order('house_number');

                const { data, error } = await Promise.race([queryPromise, timeoutPromise]);

                if (error) {
                    throw error;
                }

                // Hide loading
                loading.classList.add('hidden');

                if (data && data.length > 0) {
                    displayResults(data);
                } else {
                    noResults.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                loading.classList.add('hidden');
                
                // Show sample data if connection fails
                if (error.message.includes('timeout') || error.message.includes('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤')) {
                    displaySampleData();
                } else {
                    results.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>
                            <button onclick="displaySampleData()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                        </div>
                    `;
                }
            }
        }

        function getWarningStatus(item) {
            const monthStatuses = getMonthStatuses(item);
            const unpaidMonths = monthStatuses.filter(m => m.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢').length;
            
            if (unpaidMonths === 0) {
                return { 
                    status: '‡∏õ‡∏Å‡∏ï‡∏¥', 
                    icon: '‚úÖ', 
                    color: 'bg-green-500', 
                    textColor: 'text-white',
                    headerGradient: 'from-green-500 via-green-600 to-emerald-600'
                };
            } else if (unpaidMonths === 1) {
                return { 
                    status: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 
                    icon: '‚ö†Ô∏è', 
                    color: 'bg-yellow-500', 
                    textColor: 'text-white',
                    headerGradient: 'from-yellow-400 via-yellow-500 to-amber-500'
                };
            } else if (unpaidMonths === 2) {
                return { 
                    status: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô 1-2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏£‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 
                    icon: 'üìã', 
                    color: 'bg-orange-500', 
                    textColor: 'text-white',
                    headerGradient: 'from-orange-400 via-orange-500 to-amber-500'
                };
            } else if (unpaidMonths === 3) {
                return { 
                    status: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 
                    icon: 'üìÆ', 
                    color: 'bg-red-500', 
                    textColor: 'text-white',
                    headerGradient: 'from-red-400 via-red-500 to-red-600'
                };
            } else if (unpaidMonths >= 4 && unpaidMonths <= 5) {
                return { 
                    status: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 3-5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ', 
                    icon: 'üö´', 
                    color: 'bg-red-600', 
                    textColor: 'text-white',
                    headerGradient: 'from-red-500 via-red-600 to-red-700'
                };
            } else {
                return { 
                    status: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', 
                    icon: 'üö®', 
                    color: 'bg-red-800', 
                    textColor: 'text-white',
                    headerGradient: 'from-red-700 via-red-800 to-red-900'
                };
            }
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            
            results.innerHTML = data.map(item => {
                const monthStatuses = getMonthStatuses(item);
                const paidCount = monthStatuses.filter(m => m.status === '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || m.status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤').length;
                const unpaidCount = monthStatuses.filter(m => m.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢' || m.status === '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•').length;
                const totalMonths = monthStatuses.length;
                const warningStatus = getWarningStatus(item);
                const totalAmount = unpaidCount * MONTHLY_FEE;
                
                return `
                    <div class="glass-effect rounded-3xl shadow-2xl card-hover status-card border border-white border-opacity-20 overflow-hidden">
                        <!-- Colorful Header -->
                        <div class="bg-gradient-to-r ${warningStatus.headerGradient} p-4 md:p-6 text-white relative overflow-hidden">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center space-x-2">
                                    <span class="text-2xl">üè†</span>
                                    <span class="text-2xl md:text-3xl font-bold">${item.house_number}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs opacity-75">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
                                    <div class="text-sm font-medium">#${item.invoice_id}</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center space-x-2 bg-white bg-opacity-20 rounded-full px-3 py-2">
                                <span class="text-lg">${warningStatus.icon}</span>
                                <span class="text-sm md:text-base font-medium text-center">${warningStatus.status}</span>
                            </div>
                        </div>

                        <div class="p-4 md:p-6 bg-gradient-to-b from-white to-gray-50">

                            <!-- Owner Info -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-2 flex items-center">
                                    <span class="mr-2">üë§</span>
                                    <span>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>
                                </p>
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-800 text-sm md:text-base" id="owner-${item.invoice_id}">${item.owner_name.split(' ')[0]} xxxxxxx</p>
                                    <button onclick="toggleOwnerName('${item.invoice_id}', '${item.owner_name}')" 
                                            class="text-xs bg-blue-500 text-white px-3 py-1.5 rounded-full hover:bg-blue-600 transition-colors shadow-sm">
                                        üîç ‡πÅ‡∏™‡∏î‡∏á
                                    </button>
                                </div>
                            </div>

                            <!-- Property Info in Rows -->
                            <div class="mb-4 space-y-2 text-xs md:text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 flex items-center">
                                        <span class="mr-1">üèòÔ∏è</span>
                                        <span>‡∏ã‡∏≠‡∏¢:</span>
                                    </span>
                                    <span class="font-medium">${item.soi_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 flex items-center">
                                        <span class="mr-1">üìÖ</span>
                                        <span>‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô:</span>
                                    </span>
                                    <span class="font-medium">${item.transfer_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 flex items-center">
                                        <span class="mr-1">üìä</span>
                                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                    </span>
                                    <span class="font-medium">${item.start_due_month || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                            </div>

                            <!-- Payment Progress -->
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs md:text-sm font-medium text-gray-700 flex items-center">
                                        <span class="mr-1">üí≥</span>
                                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</span>
                                    </span>
                                    <span class="text-xs md:text-sm text-gray-600 font-bold">${paidCount}/${totalMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500 shadow-sm" 
                                         style="width: ${(paidCount/totalMonths)*100}%"></div>
                                </div>
                            </div>

                            <!-- Monthly Status -->
                            <div class="mb-4">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 space-y-2 sm:space-y-0">
                                    <h4 class="text-xs md:text-sm font-semibold text-gray-700 flex items-center">
                                        <span class="mr-1">üìÖ</span>
                                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${item.payment_year})</span>
                                    </h4>
                                    <button onclick="showPaymentHistory('${item.house_number}')" 
                                            class="text-xs bg-indigo-500 text-white px-3 py-2 rounded-full hover:bg-indigo-600 transition-colors shadow-sm flex items-center justify-center space-x-1 w-full sm:w-auto">
                                        <span>üìä</span>
                                        <span>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-3 gap-1.5 md:gap-2">
                                    ${monthStatuses.map(month => `
                                        <div class="text-center p-2 md:p-3 rounded-lg text-xs font-medium ${getStatusClass(month.status)} border border-opacity-20">
                                            <div class="font-semibold mb-1">${month.name}</div>
                                            <div class="text-xs leading-tight">${month.status}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Financial Summary -->
                            <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                                <h4 class="text-xs md:text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                    <span class="mr-1">üí∞</span>
                                    <span>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (300 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>
                                </h4>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="bg-green-100 p-2 md:p-3 rounded-lg text-center shadow-sm">
                                        <p class="text-green-700 font-medium flex items-center justify-center mb-1">
                                            <span class="mr-1">‚úÖ</span>
                                            <span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                                        </p>
                                        <p class="text-green-600 font-bold text-sm">${(paidCount * MONTHLY_FEE).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                                    </div>
                                    <div class="bg-red-100 p-2 md:p-3 rounded-lg text-center shadow-sm">
                                        <p class="text-red-700 font-medium flex items-center justify-center mb-1">
                                            <span class="mr-1">‚ùå</span>
                                            <span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                                        </p>
                                        <p class="text-red-600 font-bold text-sm">${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                                    </div>
                                    <div class="bg-yellow-100 p-2 md:p-3 rounded-lg text-center shadow-sm">
                                        <p class="text-yellow-700 font-medium flex items-center justify-center mb-1">
                                            <span class="mr-1">‚è≥</span>
                                            <span>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                        </p>
                                        <p class="text-yellow-600 font-bold text-sm">${(monthStatuses.filter(m => m.status === '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•').length * MONTHLY_FEE).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                                    </div>
                                    <div class="bg-blue-100 p-2 md:p-3 rounded-lg text-center shadow-sm">
                                        <p class="text-blue-700 font-medium flex items-center justify-center mb-1">
                                            <span class="mr-1">üîµ</span>
                                            <span>‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
                                        </p>
                                        <p class="text-blue-600 font-bold text-sm">${(monthStatuses.filter(m => m.status === '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤').length * MONTHLY_FEE).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                `;
            }).join('');
        }

        function getMonthStatuses(item) {
            return Object.entries(monthNames).map(([key, name]) => ({
                name: name,
                status: item[key] || '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö'
            }));
        }

        function getStatusClass(status) {
            switch(status) {
                case '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß':
                    return 'bg-gradient-to-r from-green-400 to-green-600 text-white shadow-lg';
                case '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢':
                    return 'bg-gradient-to-r from-red-400 to-red-600 text-white shadow-lg';
                case '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•':
                    return 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg';
                case '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤':
                    return 'bg-gradient-to-r from-blue-400 to-blue-600 text-white shadow-lg';
                case '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö':
                    return 'bg-gradient-to-r from-purple-400 to-purple-600 text-white shadow-lg';
                case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':
                    return 'bg-gradient-to-r from-orange-400 to-orange-600 text-white shadow-lg';
                case '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß':
                    return 'bg-gradient-to-r from-teal-400 to-teal-600 text-white shadow-lg';
                case '‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô':
                    return 'bg-gradient-to-r from-pink-400 to-pink-600 text-white shadow-lg';
                case '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô':
                    return 'bg-gradient-to-r from-indigo-400 to-indigo-600 text-white shadow-lg';
                default:
                    return 'bg-gradient-to-r from-gray-400 to-gray-600 text-white shadow-lg';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß':
                    return '‚úÖ';
                case '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢':
                    return '‚ùå';
                case '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•':
                    return '‚è≥';
                case '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤':
                    return 'üîµ';
                case '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö':
                    return 'üü£';
                default:
                    return '‚ûñ';
            }
        }

        function clearSearch() {
            document.getElementById('houseSearch').value = '';
            document.getElementById('yearSearch').value = '';
            searchData();
        }

        function toggleOwnerName(invoiceId, fullName) {
            const element = document.getElementById(`owner-${invoiceId}`);
            const button = element.nextElementSibling;
            
            if (element.textContent.includes('xxxxxxx')) {
                element.textContent = fullName;
                button.textContent = 'üôà ‡∏ã‡πà‡∏≠‡∏ô';
            } else {
                element.textContent = fullName.split(' ')[0] + ' xxxxxxx';
                button.textContent = 'üîç ‡πÅ‡∏™‡∏î‡∏á';
            }
        }

        function displaySampleData() {
            const sampleData = [
                {
                    invoice_id: 'INV001',
                    house_number: '998/1',
                    owner_name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                    soi_number: '5',
                    transfer_date: '2567-01-15',
                    start_due_month: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡πá‡∏ö ‡∏°.‡∏Ñ. 2567',
                    payment_year: 2567,
                    january_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    february_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    march_status: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢',
                    april_status: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢',
                    may_status: '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    june_status: '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                    july_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                    august_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                    september_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                    october_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                    november_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö',
                    december_status: '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö'
                },
                {
                    invoice_id: 'INV002',
                    house_number: '999/2',
                    owner_name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°',
                    soi_number: '3',
                    transfer_date: '2566-12-01',
                    start_due_month: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡πá‡∏ö ‡∏ò.‡∏Ñ. 2566',
                    payment_year: 2567,
                    january_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    february_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    march_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    april_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    may_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    june_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    july_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    august_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    september_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    october_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    november_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    december_status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                }
            ];
            
            displayResults(sampleData);
        }

        async function showPaymentHistory(houseNumber) {
            const modal = document.getElementById('paymentModal');
            const modalLoading = document.getElementById('modalLoading');
            const paymentHistoryList = document.getElementById('paymentHistoryList');
            const noPaymentData = document.getElementById('noPaymentData');
            const modalHouseNumber = document.getElementById('modalHouseNumber');
            const paymentRecords = document.getElementById('paymentRecords');

            // Show modal and loading
            modal.classList.remove('hidden');
            modalLoading.classList.remove('hidden');
            paymentHistoryList.classList.add('hidden');
            noPaymentData.classList.add('hidden');
            modalHouseNumber.textContent = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${houseNumber}`;

            try {
                // Add timeout for payment history query
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤')), 8000);
                });

                const queryPromise = supabase
                    .from('payment_duplicate')
                    .select('*')
                    .eq('house_number', houseNumber)
                    .order('date_notified', { ascending: false });

                const { data, error } = await Promise.race([queryPromise, timeoutPromise]);

                if (error) {
                    throw error;
                }

                // Hide loading
                modalLoading.classList.add('hidden');

                if (data && data.length > 0) {
                    // Show payment history
                    paymentHistoryList.classList.remove('hidden');
                    displayPaymentRecords(data);
                } else {
                    // Show no data message
                    noPaymentData.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error fetching payment history:', error);
                modalLoading.classList.add('hidden');
                
                // Show sample payment data if connection fails
                if (error.message.includes('timeout') || error.message.includes('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤')) {
                    displaySamplePaymentRecords(houseNumber);
                    paymentHistoryList.classList.remove('hidden');
                } else {
                    paymentRecords.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>
                            <button onclick="displaySamplePaymentRecords('${houseNumber}')" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                        </div>
                    `;
                    paymentHistoryList.classList.remove('hidden');
                }
            }
        }

        function displaySamplePaymentRecords(houseNumber) {
            const sampleRecords = [
                {
                    date_notified: '2024-03-15T10:30:00',
                    full_name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                    house_number: houseNumber,
                    payment_month: '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                    payment_year: '2567',
                    status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    photo_url: 'https://via.placeholder.com/400x600/4CAF50/white?text=‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                    pdf_url: 'https://via.placeholder.com/400x600/F44336/white?text=‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£+PDF'
                },
                {
                    date_notified: '2024-02-15T14:20:00',
                    full_name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                    house_number: houseNumber,
                    payment_month: '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                    payment_year: '2567',
                    status: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    photo_url: 'https://via.placeholder.com/400x600/2196F3/white?text=‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô+2',
                    pdf_url: ''
                },
                {
                    date_notified: '2024-01-15T09:15:00',
                    full_name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                    house_number: houseNumber,
                    payment_month: '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                    payment_year: '2567',
                    status: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
                    photo_url: '',
                    pdf_url: 'https://via.placeholder.com/400x600/FF9800/white?text=‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£+PDF+2'
                }
            ];
            
            displayPaymentRecords(sampleRecords);
        }

        function displayPaymentRecords(records) {
            const paymentRecords = document.getElementById('paymentRecords');
            
            paymentRecords.innerHTML = records.map(record => {
                const notifiedDate = record.date_notified ? 
                    new Date(record.date_notified).toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const statusClass = getPaymentStatusClass(record.status);
                
                // Check if photo_url or pdf_url exists
                const hasPhoto = record.photo_url && record.photo_url.trim() !== '';
                const hasPdf = record.pdf_url && record.pdf_url.trim() !== '';
                
                return `
                    <div class="bg-white rounded-lg p-3 md:p-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                        <!-- Desktop/Tablet Layout -->
                        <div class="hidden md:block">
                            <div class="grid grid-cols-6 gap-4 text-sm mb-3">
                                <div class="text-gray-700">
                                    <span class="font-medium">${notifiedDate}</span>
                                </div>
                                <div class="text-gray-700">
                                    <span class="font-medium">${record.full_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="text-gray-700">
                                    <span class="font-medium">${record.house_number}</span>
                                </div>
                                <div class="text-gray-700">
                                    <span class="font-medium">${record.payment_month || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="text-gray-700">
                                    <span class="font-medium">${record.payment_year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${record.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                                    </span>
                                </div>
                            </div>
                            ${(hasPhoto || hasPdf) ? `
                                <div class="flex space-x-2">
                                    ${hasPhoto ? `
                                        <button onclick="showImage('${record.photo_url}', '‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')" 
                                                class="bg-green-500 text-white px-3 py-1.5 rounded-full text-xs hover:bg-green-600 transition-colors flex items-center space-x-1">
                                            <span>üì∑</span>
                                            <span>‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</span>
                                        </button>
                                    ` : ''}
                                    ${hasPdf ? `
                                        <button onclick="showPdf('${record.pdf_url}', '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF')" 
                                                class="bg-red-500 text-white px-3 py-1.5 rounded-full text-xs hover:bg-red-600 transition-colors flex items-center space-x-1">
                                            <span>üìÑ</span>
                                            <span>‡∏î‡∏π PDF</span>
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>

                        <!-- Mobile Layout -->
                        <div class="md:hidden">
                            <div class="space-y-2 text-xs mb-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                                    <span class="font-medium">${notifiedDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏ä‡∏∑‡πà‡∏≠:</span>
                                    <span class="font-medium">${record.full_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏ö‡πâ‡∏≤‡∏ô:</span>
                                    <span class="font-medium">${record.house_number}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ:</span>
                                    <span class="font-medium">${record.payment_month || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}/${record.payment_year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${record.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                                    </span>
                                </div>
                            </div>
                            ${(hasPhoto || hasPdf) ? `
                                <div class="grid grid-cols-2 gap-2">
                                    ${hasPhoto ? `
                                        <button onclick="showImage('${record.photo_url}', '‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')" 
                                                class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs hover:bg-green-600 transition-colors flex items-center justify-center space-x-1">
                                            <span>üì∑</span>
                                            <span>‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</span>
                                        </button>
                                    ` : ''}
                                    ${hasPdf ? `
                                        <button onclick="showPdf('${record.pdf_url}', '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF')" 
                                                class="bg-red-500 text-white px-3 py-2 rounded-lg text-xs hover:bg-red-600 transition-colors flex items-center justify-center space-x-1">
                                            <span>üìÑ</span>
                                            <span>‡∏î‡∏π PDF</span>
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getPaymentStatusClass(status) {
            switch(status) {
                case '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß':
                    return 'bg-green-100 text-green-800';
                case '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢':
                    return 'bg-red-100 text-red-800';
                case '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•':
                    return 'bg-yellow-100 text-yellow-800';
                case '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤':
                    return 'bg-blue-100 text-blue-800';
                case '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö':
                    return 'bg-purple-100 text-purple-800';
                case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':
                    return 'bg-orange-100 text-orange-800';
                case '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß':
                    return 'bg-teal-100 text-teal-800';
                case '‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô':
                    return 'bg-pink-100 text-pink-800';
                case '‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô':
                    return 'bg-indigo-100 text-indigo-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
        }

        function showImage(imageUrl, title) {
            const modal = document.getElementById('imageModal');
            const modalTitle = document.getElementById('imageModalTitle');
            const imageLoading = document.getElementById('imageLoading');
            const modalImage = document.getElementById('modalImage');
            const imageError = document.getElementById('imageError');

            // Show modal and loading
            modal.classList.remove('hidden');
            modalTitle.textContent = title;
            imageLoading.classList.remove('hidden');
            modalImage.classList.add('hidden');
            imageError.classList.add('hidden');

            // Load image
            const img = new Image();
            img.onload = function() {
                imageLoading.classList.add('hidden');
                modalImage.src = imageUrl;
                modalImage.classList.remove('hidden');
            };
            img.onerror = function() {
                imageLoading.classList.add('hidden');
                imageError.classList.remove('hidden');
            };
            img.src = imageUrl;
        }

        async function showPdf(pdfUrl, title) {
            const modal = document.getElementById('imageModal');
            const modalTitle = document.getElementById('imageModalTitle');
            const imageLoading = document.getElementById('imageLoading');
            const modalImage = document.getElementById('modalImage');
            const imageError = document.getElementById('imageError');

            // Show modal and loading
            modal.classList.remove('hidden');
            modalTitle.textContent = title + ' (‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å PDF)';
            imageLoading.classList.remove('hidden');
            modalImage.classList.add('hidden');
            imageError.classList.add('hidden');

            try {
                // Try multiple PDF to image conversion services
                const conversionServices = [
                    // Google Drive PDF viewer (works for public PDFs)
                    `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(pdfUrl)}`,
                    // PDF.js viewer
                    `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(pdfUrl)}`,
                    // Alternative: Try to load as image directly (in case it's already converted)
                    pdfUrl.replace('.pdf', '.jpg').replace('.PDF', '.jpg'),
                    pdfUrl.replace('.pdf', '.png').replace('.PDF', '.png')
                ];

                let loaded = false;
                
                // Try each service
                for (let i = 0; i < conversionServices.length && !loaded; i++) {
                    try {
                        const serviceUrl = conversionServices[i];
                        
                        if (i < 2) {
                            // For PDF viewers, create an iframe
                            const iframe = document.createElement('iframe');
                            iframe.src = serviceUrl;
                            iframe.style.width = '100%';
                            iframe.style.height = '600px';
                            iframe.style.border = 'none';
                            iframe.style.borderRadius = '8px';
                            
                            // Replace image with iframe
                            imageLoading.classList.add('hidden');
                            modalImage.style.display = 'none';
                            
                            // Clear previous content and add iframe
                            const imageContainer = modalImage.parentElement;
                            const existingIframe = imageContainer.querySelector('iframe');
                            if (existingIframe) {
                                existingIframe.remove();
                            }
                            
                            imageContainer.appendChild(iframe);
                            loaded = true;
                            break;
                        } else {
                            // For image URLs, try to load as image
                            await new Promise((resolve, reject) => {
                                const img = new Image();
                                img.onload = () => {
                                    imageLoading.classList.add('hidden');
                                    modalImage.src = serviceUrl;
                                    modalImage.style.display = 'block';
                                    modalImage.classList.remove('hidden');
                                    
                                    // Remove any existing iframe
                                    const existingIframe = modalImage.parentElement.querySelector('iframe');
                                    if (existingIframe) {
                                        existingIframe.remove();
                                    }
                                    
                                    loaded = true;
                                    resolve();
                                };
                                img.onerror = reject;
                                img.src = serviceUrl;
                            });
                            
                            if (loaded) break;
                        }
                    } catch (error) {
                        console.log(`Service ${i + 1} failed:`, error);
                        continue;
                    }
                }

                if (!loaded) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ');
                }

            } catch (error) {
                console.error('Error converting PDF:', error);
                imageLoading.classList.add('hidden');
                
                // Show error with option to open PDF directly
                const imageContainer = modalImage.parentElement;
                const existingIframe = imageContainer.querySelector('iframe');
                if (existingIframe) {
                    existingIframe.remove();
                }
                
                imageError.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">üìÑ</div>
                        <p class="text-red-600 mb-4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
                        <div class="space-y-2">
                            <button onclick="window.open('${pdfUrl}', '_blank')" 
                                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                üîó ‡πÄ‡∏õ‡∏¥‡∏î PDF ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
                            </button>
                            <br>
                            <button onclick="downloadPdf('${pdfUrl}')" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
                            </button>
                        </div>
                    </div>
                `;
                imageError.classList.remove('hidden');
            }
        }

        function downloadPdf(pdfUrl) {
            try {
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = 'document.pdf';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Download failed:', error);
                // Fallback: open in new tab
                window.open(pdfUrl, '_blank');
            }
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const imageContainer = modalImage.parentElement;
            
            // Clean up
            modal.classList.add('hidden');
            modalImage.src = '';
            modalImage.style.display = 'block';
            
            // Remove any existing iframe
            const existingIframe = imageContainer.querySelector('iframe');
            if (existingIframe) {
                existingIframe.remove();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const paymentModal = document.getElementById('paymentModal');
            const imageModal = document.getElementById('imageModal');
            
            if (e.target === paymentModal) {
                closePaymentModal();
            }
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePaymentModal();
                closeImageModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'981e70f4d7f57b50',t:'MTc1ODM0MTA5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
