<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        .glow-animation {
            animation: glow 2s ease-in-out infinite;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-full font-sans relative overflow-x-hidden">
    <!-- Animated Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-gradient-to-r from-blue-200 to-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse"></div>
        <div class="absolute top-3/4 right-1/4 w-72 h-72 bg-gradient-to-r from-pink-200 to-orange-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse" style="animation-delay: 2s;"></div>
        <div class="absolute top-1/2 left-1/2 w-80 h-80 bg-gradient-to-r from-indigo-200 to-cyan-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse" style="animation-delay: 4s;"></div>
    </div>
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Header with Modern Design -->
        <header class="text-center mb-12 relative">
            <div class="float-animation">
                <h1 class="text-5xl font-black gradient-text mb-4 tracking-tight">
                    üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
                </h1>
            </div>
            <div class="relative">
                <p class="text-xl text-gray-600 font-medium mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <p class="text-sm text-gray-500">üí° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢</p>
            </div>
            
            <!-- Decorative Elements -->
            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-4">
                <div class="w-20 h-1 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full"></div>
            </div>
        </header>

        <!-- Search Section with Enhanced Design -->
        <div class="bg-white rounded-3xl shadow-2xl p-8 mb-12 border border-gray-100 glass-effect relative overflow-hidden">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-5">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full transform translate-x-16 -translate-y-16"></div>
                <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-pink-400 to-orange-400 rounded-full transform -translate-x-12 translate-y-12"></div>
            </div>
            
            <div class="relative z-10">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1">
                        <label for="searchInput" class="block text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <span class="text-lg">üîç</span>
                            <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 998/1, 998/2..."
                                class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-purple-200 focus:border-purple-400 outline-none transition-all duration-300 text-lg font-medium shadow-inner bg-gray-50 focus:bg-white"
                            >
                            <div class="absolute inset-0 rounded-2xl shimmer opacity-0 hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            id="searchBtn" 
                            class="px-8 py-4 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded-2xl transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2"
                        >
                            <span class="animate-pulse">üîç</span>
                            <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                        </button>
                        <button 
                            id="loadAllBtn" 
                            class="px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white rounded-2xl transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2"
                        >
                            <span class="animate-bounce">üìã</span>
                            <span>‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center py-8">
            <div class="loading inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div>
            <p class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <p class="font-medium">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</p>
            <p id="errorText"></p>
        </div>

        <!-- Results Counter -->
        <div id="resultsCounter" class="hidden mb-4 text-gray-600">
            ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="resultCount" class="font-semibold text-blue-600">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>

        <!-- Results Grid -->
        <div id="resultsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
            <!-- Cards will be inserted here -->
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üìÑ</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p class="text-gray-500 mb-4">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <div class="text-sm text-gray-400">
                <p>üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</p>
                <p>‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 998/1, 998/2</p>
                <p>‚Ä¢ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏≠‡∏¢</p>
                <p>‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            </div>
        </div>

        <!-- Debug Information -->
        <div id="debugInfo" class="hidden mt-8 p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
            <h4 class="font-bold mb-2">üîß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏ö‡∏±‡∏Å</h4>
            <div id="debugContent"></div>
        </div>

        <!-- Detail Modal -->
        <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-full overflow-y-auto">
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-xl">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>
                        <button onclick="closeDetails()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
                    </div>
                    <p id="detailHouseNumber" class="text-blue-100 mt-2"></p>
                </div>
                
                <div class="p-4 md:p-6">
                    <!-- Loading for detail -->
                    <div id="detailLoading" class="hidden text-center py-8">
                        <div class="loading inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div>
                        <p class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                    
                    <!-- Detail content -->
                    <div id="detailContent">
                        <!-- Content will be inserted here -->
                    </div>
                    
                    <!-- No detail data -->
                    <div id="noDetailData" class="hidden text-center py-8">
                        <div class="text-6xl mb-4">üìã</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h3>
                        <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-70 flex items-start justify-center p-4 pt-8">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-full overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span>üñºÔ∏è</span>
                        <span>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                    </h3>
                    <button onclick="closeImageModal()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
                </div>
                
                <div class="p-6 bg-gray-50 max-h-96 overflow-y-auto">
                    <div class="text-center">
                        <img id="modalImage" src="" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà" class="max-w-full mx-auto rounded-lg shadow-lg border border-gray-300 hover:shadow-xl transition-shadow duration-300" 
                             onerror="this.src=''; this.alt='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'; this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="hidden bg-red-50 border border-red-200 rounded-2xl p-8">
                            <div class="text-red-500 text-6xl mb-4">üñºÔ∏è</div>
                            <h3 class="text-xl font-semibold text-red-700 mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</h3>
                            <p class="text-red-600">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Modal -->
        <div id="pdfModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-80 flex items-start justify-center p-4 pt-8">
            <div class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-full overflow-hidden">
                <div class="bg-gradient-to-r from-red-600 to-pink-600 text-white p-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span>üìÑ</span>
                        <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</span>
                    </h3>
                    <button onclick="closePdfModal()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
                </div>
                
                <div class="p-6 bg-gray-50 max-h-96 overflow-y-auto">
                    <div id="pdfModalContent" class="text-center">
                        <!-- PDF images will be displayed here -->
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        const SHEET_ID = '15yFZ3qgIycp48T4SVPsNVP43U6cERQfJFiMaAQDH73Y';
        const SHEET_GID = '736091982';
        const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
        
        console.log('Sheet ID:', SHEET_ID);
        console.log('Sheet GID:', SHEET_GID);
        console.log('API URL:', API_URL);
        
        // Detail sheet constants
        const DETAIL_SHEET_ID = '1mRI_UrDLCy_4I6guONsscwJwWvLWyEgHB9VEEfCSZNA';
        const DETAIL_SHEET_GID = '2106428771';
        const DETAIL_API_URL = `https://docs.google.com/spreadsheets/d/${DETAIL_SHEET_ID}/export?format=csv&gid=${DETAIL_SHEET_GID}`;

        let allData = [];
        
        // Month names in Thai (short form)
        const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
        
        // Monthly fee
        const MONTHLY_FEE = 300;

        // Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const loadAllBtn = document.getElementById('loadAllBtn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const resultsCounter = document.getElementById('resultsCounter');
        const resultCount = document.getElementById('resultCount');
        const resultsGrid = document.getElementById('resultsGrid');
        const noResults = document.getElementById('noResults');

        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        loadAllBtn.addEventListener('click', loadAllData);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });

        async function fetchData() {
            try {
                showLoading(true);
                hideError();
                
                console.log('Fetching data from:', API_URL);
                
                // Try to fetch data with proper CORS handling
                const response = await fetch(API_URL + '&_=' + Date.now(), {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('Raw CSV response length:', text.length);
                console.log('Raw CSV preview:', text.substring(0, 500));
                
                if (!text || text.trim() === '') {
                    throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö');
                }
                
                // Parse CSV data
                const lines = text.split('\n').filter(line => line.trim() !== '');
                console.log('Total lines found:', lines.length);
                
                if (lines.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï');
                }
                
                // If only header exists, create sample data
                if (lines.length === 1) {
                    console.log('Only header found, creating sample data...');
                    return createSampleData();
                }
                
                // Process CSV data (skip header row)
                const dataRows = lines.slice(1);
                const processedData = [];
                
                dataRows.forEach((line, index) => {
                    try {
                        const row = parseCSVLine(line);
                        console.log(`Processing row ${index + 1}:`, row);
                        
                        // Skip empty rows
                        if (row.length === 0 || row.every(cell => !cell || cell.trim() === '')) {
                            console.log(`Skipping empty row ${index + 1}`);
                            return;
                        }
                        
                        // Ensure minimum required columns (pad with empty strings)
                        while (row.length < 20) {
                            row.push('');
                        }
                        
                        // Validate essential data
                        const houseNumber = String(row[1] || '').trim();
                        if (houseNumber && houseNumber !== '') {
                            processedData.push({
                                id: index + 1,
                                data: row
                            });
                        } else {
                            console.warn(`Row ${index + 1} missing house number:`, row);
                        }
                    } catch (rowError) {
                        console.error(`Error processing row ${index + 1}:`, rowError, line);
                    }
                });
                
                console.log('Successfully processed data count:', processedData.length);
                
                if (processedData.length === 0) {
                    console.log('No valid data found, creating sample data...');
                    return createSampleData();
                }
                
                allData = processedData;
                return processedData;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                console.log('Fetch failed, using sample data...');
                
                // Show error but also provide sample data
                showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ: ${error.message} - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á`);
                
                const sampleData = createSampleData();
                allData = sampleData;
                return sampleData;
            } finally {
                showLoading(false);
            }
        }
        
        // Helper function to parse CSV line properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            // Handle empty line
            if (!line || line.trim() === '') {
                return [];
            }
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // Handle escaped quotes
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            // Remove quotes from fields and clean up
            return result.map(field => {
                // Remove surrounding quotes
                field = field.replace(/^"(.*)"$/, '$1');
                // Clean up any remaining escaped quotes
                field = field.replace(/""/g, '"');
                return field;
            });
        }

        async function loadAllData() {
            try {
                showLoading(true);
                hideError();
                
                // If we don't have data yet, fetch it
                if (!allData || allData.length === 0) {
                    console.log('No cached data, fetching...');
                    const data = await fetchData();
                    allData = data;
                }
                
                console.log('Displaying all data:', allData.length, 'records');
                await displayResults(allData);
                
            } catch (error) {
                console.error('Error in loadAllData:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
                showLoading(false);
            }
        }

        async function performSearch() {
            try {
                const query = searchInput.value.trim();
                
                if (!query) {
                    showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 998/1');
                    return;
                }

                showLoading(true);
                hideError();

                // Ensure we have data to search
                if (!allData || allData.length === 0) {
                    console.log('No data available for search, fetching...');
                    const data = await fetchData();
                    allData = data;
                }

                console.log('Searching for:', query);
                console.log('In data set of:', allData.length, 'records');

                // Search for matches in house number column (index 1)
                // Support both exact match and partial match
                const queryLower = query.toLowerCase();
                const filteredData = allData.filter(item => {
                    if (!item || !item.data || !Array.isArray(item.data)) {
                        return false;
                    }
                    
                    const houseNumber = String(item.data[1] || '').toLowerCase().trim();
                    const name = String(item.data[3] || '').toLowerCase().trim();
                    const soi = String(item.data[2] || '').toLowerCase().trim();
                    
                    // Search in house number (exact match preferred, partial match as fallback)
                    return houseNumber === queryLower || 
                           houseNumber.includes(queryLower) ||
                           name.includes(queryLower) ||
                           soi.includes(queryLower);
                });

                console.log('Search results:', filteredData.length, 'records found');
                await displayResults(filteredData);
                
            } catch (error) {
                console.error('Error in performSearch:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
            } finally {
                showLoading(false);
            }
        }

        async function displayResults(data) {
            hideError();
            resultsGrid.innerHTML = '';
            
            console.log('Displaying results for data:', data);
            console.log('Data type:', typeof data, 'Length:', data ? data.length : 'undefined');
            
            if (!data || data.length === 0) {
                console.log('No data to display');
                showNoResults(true);
                showResultsCounter(false);
                
                // Show debug info if no data
                if (allData && allData.length > 0) {
                    console.log('All data exists but filtered data is empty');
                    console.log('Sample of all data:', allData.slice(0, 3));
                }
                return;
            }

            showNoResults(false);
            showResultsCounter(true);
            resultCount.textContent = data.length;

            // Create all cards synchronously for better performance
            const fragment = document.createDocumentFragment();
            let cardCount = 0;
            
            for (const item of data) {
                console.log(`Creating card ${cardCount + 1} for item:`, item);
                if (item && item.data && Array.isArray(item.data)) {
                    try {
                        const card = createCard(item.data);
                        if (card) {
                            fragment.appendChild(card);
                            cardCount++;
                        }
                    } catch (error) {
                        console.error('Error creating card:', error, item);
                    }
                } else {
                    console.warn('Invalid item data:', item);
                }
            }
            
            console.log(`Successfully created ${cardCount} cards out of ${data.length} items`);
            resultsGrid.appendChild(fragment);
            
            // Load pending payment history asynchronously after cards are displayed
            setTimeout(() => {
                data.forEach(item => {
                    if (item && item.data) {
                        const houseNumber = item.data[1]; // House number is now in column 1
                        if (houseNumber) {
                            loadPendingHistoryForCard(houseNumber);
                        }
                    }
                });
            }, 100);
        }

        function getPaymentStatus(statusText) {
            const status = String(statusText).toLowerCase();
            
            if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('paid')) {
                return { status: 'paid', color: 'bg-green-500 text-white border-green-500', icon: '' };
            } else if (status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                return { status: 'advance', color: 'bg-blue-500 text-white border-blue-500', icon: '' };
            } else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) {
                return { status: 'waiting', color: 'bg-yellow-500 text-white border-yellow-500', icon: '' };
            } else if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) {
                return { status: 'exempt', color: 'bg-purple-500 text-white border-purple-500', icon: '' };
            } else {
                return { status: 'unpaid', color: 'bg-red-500 text-white border-red-500', icon: '' };
            }
        }

        function calculateOverdueStatus(rowData) {
            const monthlyPayments = rowData.slice(8, 20); // Columns 8-19 (Jan-Dec)
            let overdueMonths = 0;
            
            // Count unpaid months (excluding "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö" and "‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤")
            for (let i = 0; i < monthlyPayments.length; i++) {
                const payment = getPaymentStatus(monthlyPayments[i]);
                if (payment.status === 'unpaid' || payment.status === 'waiting') {
                    overdueMonths++;
                }
            }
            
            if (overdueMonths === 0) {
                return { 
                    text: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 
                    color: 'bg-green-500', 
                    icon: '‚úÖ',
                    headerColor: 'bg-gradient-to-r from-green-500 to-green-600'
                };
            } else if (overdueMonths <= 2) {
                return { 
                    text: `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, 
                    color: 'bg-orange-400', 
                    icon: '‚ö†Ô∏è',
                    headerColor: 'bg-gradient-to-r from-orange-400 to-orange-500'
                };
            } else {
                return { 
                    text: `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, 
                    color: 'bg-red-500', 
                    icon: 'üö®',
                    headerColor: 'bg-gradient-to-r from-red-500 to-red-600'
                };
            }
        }

        function calculateTotalAmount(rowData) {
            const monthlyPayments = rowData.slice(8, 20); // Columns 8-19 (Jan-Dec)
            let totalMonths = 0;
            
            for (let i = 0; i < monthlyPayments.length; i++) {
                const payment = getPaymentStatus(monthlyPayments[i]);
                if (payment.status === 'paid' || payment.status === 'advance' || payment.status === 'unpaid' || payment.status === 'waiting') {
                    totalMonths++;
                }
            }
            
            return totalMonths * MONTHLY_FEE;
        }

        function calculatePaymentSummary(rowData) {
            const monthlyPayments = rowData.slice(8, 20); // Columns 8-19 (Jan-Dec)
            let paidCount = 0;
            let unpaidCount = 0;
            let advanceCount = 0;
            let waitingCount = 0;
            let exemptCount = 0;
            
            for (let i = 0; i < monthlyPayments.length; i++) {
                const payment = getPaymentStatus(monthlyPayments[i]);
                switch (payment.status) {
                    case 'paid':
                        paidCount++;
                        break;
                    case 'unpaid':
                        unpaidCount++;
                        break;
                    case 'advance':
                        advanceCount++;
                        break;
                    case 'waiting':
                        waitingCount++;
                        break;
                    case 'exempt':
                        exemptCount++;
                        break;
                }
            }
            
            const paidAmount = paidCount * MONTHLY_FEE;
            const unpaidAmount = unpaidCount * MONTHLY_FEE;
            
            return `
                <div class="space-y-2">
                    <h5 class="text-sm font-medium text-gray-700">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h5>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-green-50 p-2 rounded">
                            <div class="text-green-700 font-medium">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${paidCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                            <div class="text-green-600">${paidAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded">
                            <div class="text-red-700 font-medium">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢: ${unpaidCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                            <div class="text-red-600">${unpaidAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                        ${advanceCount > 0 ? `
                        <div class="bg-blue-50 p-2 rounded">
                            <div class="text-blue-700 font-medium">‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ${advanceCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>` : ''}
                        ${waitingCount > 0 ? `
                        <div class="bg-yellow-50 p-2 rounded">
                            <div class="text-yellow-700 font-medium">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${waitingCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>` : ''}
                        ${exemptCount > 0 ? `
                        <div class="bg-purple-50 p-2 rounded">
                            <div class="text-purple-700 font-medium">‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö: ${exemptCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        function maskName(fullName) {
            if (!fullName || fullName === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠') return fullName;
            
            const words = fullName.split(' ');
            if (words.length === 0) return fullName;
            
            // Show first word, mask the rest with shorter x's
            const firstWord = words[0];
            const maskedPart = 'x'.repeat(6); // Fixed 6 x's instead of variable length
            
            return `${firstWord} ${maskedPart}`;
        }

        function createCard(rowData) {
            console.log('Creating card with rowData:', rowData);
            console.log('RowData type:', typeof rowData, 'Is array:', Array.isArray(rowData), 'Length:', rowData ? rowData.length : 'undefined');
            
            if (!rowData || !Array.isArray(rowData)) {
                console.error('Invalid rowData for card:', rowData);
                const errorCard = document.createElement('div');
                errorCard.className = 'bg-red-100 border border-red-300 rounded-lg p-4';
                errorCard.innerHTML = '<p class="text-red-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>';
                return errorCard;
            }
            
            // Ensure we have enough data
            if (rowData.length < 8) {
                console.warn('Insufficient data in row:', rowData);
                // Pad with empty strings
                while (rowData.length < 20) {
                    rowData.push('');
                }
            }
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl shadow-xl overflow-hidden card-hover backdrop-blur-sm border border-gray-100';
            
            // Extract data based on correct column structure
            const invoiceNumber = String(rowData[0] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const houseNumber = String(rowData[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const soi = String(rowData[2] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const name = String(rowData[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠');
            const transferDate = String(rowData[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const paymentStatus = String(rowData[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const dueMonth = String(rowData[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
            const year = String(rowData[7] || new Date().getFullYear());
            
            console.log('Card data extracted:', {
                invoiceNumber, houseNumber, soi, name, transferDate, paymentStatus, dueMonth, year
            });
            
            // Validate essential data
            if (!houseNumber || houseNumber === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                console.warn('No house number found in row:', rowData);
            }
            
            // Calculate overdue status and total amount
            const overdueStatus = calculateOverdueStatus(rowData);
            const totalAmount = calculateTotalAmount(rowData);
            
            // Create monthly payment status grid (3x4)
            const monthlyStatus = createMonthlyStatusGrid(rowData);
            
            // Mask name for privacy
            const maskedName = maskName(name);
            const cardId = `card-${houseNumber.replace('/', '-')}`;
            
            card.innerHTML = `
                <div class="relative overflow-hidden">
                    <!-- Animated Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute top-0 left-0 w-20 h-20 bg-white rounded-full transform -translate-x-10 -translate-y-10"></div>
                        <div class="absolute bottom-0 right-0 w-16 h-16 bg-white rounded-full transform translate-x-8 translate-y-8"></div>
                    </div>
                    
                    <!-- Colorful Header with Glassmorphism -->
                    <div class="${overdueStatus.headerColor} text-white p-4 md:p-6 relative">
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                                <h3 class="text-2xl font-bold">üè† ${houseNumber}</h3>
                            </div>
                            <p class="text-white text-opacity-90 text-sm font-medium">${soi}</p>
                        </div>
                        
                        <!-- Floating Status Badge -->
                        <div class="absolute top-4 right-4">
                            <div class="${overdueStatus.color} text-white px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg backdrop-blur-sm border border-white border-opacity-20">
                                <span class="animate-bounce">${overdueStatus.icon}</span>
                                <span>${overdueStatus.text}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 md:p-6">
                    <!-- Name Section with Privacy Toggle -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">üë§</span>
                                    <h4 id="name-${cardId}" class="text-lg font-bold text-gray-800 transition-all duration-300">${maskedName}</h4>
                                </div>
                                <button 
                                    onclick="toggleNameVisibility('${cardId}', '${name.replace(/'/g, "\\'")}', '${maskedName.replace(/'/g, "\\'")}')" 
                                    class="text-xs bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white px-3 py-1 rounded-full transition-all duration-300 transform hover:scale-105 shadow-md"
                                >
                                    <span id="toggle-${cardId}">üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Grid with Compact Design -->
                    <div class="space-y-2 md:space-y-3 mb-4 md:mb-6">
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-2 md:p-3 rounded-lg border border-purple-100">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-purple-700">üìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà INV</span>
                                <span class="font-bold text-purple-800 text-sm">${invoiceNumber}</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-2 md:p-3 rounded-lg border border-blue-100">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-blue-700">üìÖ ‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô</span>
                                <span class="font-bold text-blue-800 text-sm">${transferDate}</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-2 md:p-3 rounded-lg border border-green-100">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-green-700">‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                                <span class="font-bold text-green-800 text-sm">${paymentStatus}</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 p-2 md:p-3 rounded-lg border border-orange-100">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-orange-700">‚è∞ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                                <span class="font-bold text-orange-800 text-sm">${dueMonth}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Button with Enhanced Design -->
                    <div class="mb-4 md:mb-6">
                        <button onclick="showDetails('${houseNumber}')" class="w-full bg-gradient-to-r from-violet-500 via-purple-500 to-pink-500 hover:from-violet-600 hover:via-purple-600 hover:to-pink-600 text-white py-3 md:py-4 px-4 md:px-6 rounded-2xl transition-all duration-300 text-sm font-bold shadow-lg hover:shadow-xl transform hover:scale-[1.02] flex items-center justify-center gap-2">
                            <span class="animate-pulse">üìã</span>
                            <span>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span class="ml-2">‚Üí</span>
                        </button>
                    </div>
                    
                    <!-- Monthly Status with Enhanced Design -->
                    <div class="mb-4 md:mb-6">
                        <div class="flex items-center gap-2 mb-3 md:mb-4">
                            <span class="text-lg md:text-xl">üìä</span>
                            <h4 class="text-xs md:text-sm font-bold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ ${year}</h4>
                        </div>
                        ${monthlyStatus}
                    </div>
                    
                    <!-- Pending History Container -->
                    <div id="pending-${houseNumber}" class="pending-history-container mb-4">
                        <!-- Pending history will be loaded here -->
                    </div>
                    
                    <!-- Payment Summary with Modern Card Design -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-3 md:p-5 border border-gray-200 shadow-inner">
                        ${calculatePaymentSummary(rowData)}
                    </div>
                </div>
            `;
            
            return card;
        }

        function toggleNameVisibility(cardId, fullName, maskedName) {
            const nameElement = document.getElementById(`name-${cardId}`);
            const toggleElement = document.getElementById(`toggle-${cardId}`);
            
            if (nameElement.textContent === maskedName) {
                // Show full name
                nameElement.textContent = fullName;
                nameElement.classList.add('text-green-600');
                toggleElement.innerHTML = 'üôà ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠';
            } else {
                // Show masked name
                nameElement.textContent = maskedName;
                nameElement.classList.remove('text-green-600');
                toggleElement.innerHTML = 'üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°';
            }
        }

        function createMonthlyStatusGrid(rowData) {
            // Create 3x4 grid for months with enhanced design
            let grid = '<div class="grid grid-cols-3 gap-2 md:gap-3">';
            
            for (let i = 0; i < 12; i++) {
                const monthName = monthNames[i];
                // Payment status starts from column 8 (index 8-19 for Jan-Dec)
                const statusText = rowData[i + 8] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢';
                const paymentInfo = getPaymentStatus(statusText);
                
                // Get display text for status
                let displayStatus = '';
                switch (paymentInfo.status) {
                    case 'paid':
                        displayStatus = '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                        break;
                    case 'advance':
                        displayStatus = '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤';
                        break;
                    case 'waiting':
                        displayStatus = '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                        break;
                    case 'exempt':
                        displayStatus = '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö';
                        break;
                    default:
                        displayStatus = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢';
                }
                
                grid += `
                    <div class="text-center p-2 md:p-3 rounded-xl border-2 ${paymentInfo.color} transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md">
                        <div class="text-xs font-bold mb-1">${monthName}</div>
                        <div class="text-xs font-medium">${displayStatus}</div>
                    </div>
                `;
            }
            
            grid += '</div>';
            return grid;
        }

        // Cache for detail data to avoid multiple fetches
        let detailDataCache = null;
        
        async function loadPendingHistoryForCard(houseNumber) {
            try {
                // Fetch detail data only once and cache it
                if (!detailDataCache) {
                    const response = await fetch(DETAIL_API_URL);
                    const text = await response.text();
                    
                    // Parse CSV data for detail sheet
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    const dataRows = lines.slice(1); // Skip header row
                    detailDataCache = dataRows.map(line => parseCSVLine(line));
                }
                
                // Filter data by house number (column index 4) and status "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" (column index 13)
                const pendingData = detailDataCache.filter(row => {
                    const rowHouseNumber = String(row[4] || '');
                    const status = String(row[13] || '');
                    return rowHouseNumber === houseNumber && status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                });
                
                const container = document.getElementById(`pending-${houseNumber}`);
                if (!container || pendingData.length === 0) {
                    return;
                }
                
                // Create pending payment list
                let pendingList = '<div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">';
                pendingList += '<h5 class="text-xs font-medium text-yellow-800 mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5>';
                pendingList += '<div class="space-y-1">';
                
                pendingData.forEach(row => {
                    const month = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const year = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const status = row[13] || '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                    
                    pendingList += `
                        <div class="text-xs text-yellow-700 flex justify-between items-center">
                            <span>${month} ${year}</span>
                            <span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded-full text-xs">${status}</span>
                        </div>
                    `;
                });
                
                pendingList += '</div></div>';
                container.innerHTML = pendingList;
                
            } catch (error) {
                console.error('Error fetching pending payment history:', error);
            }
        }

        async function getPendingPaymentHistory(houseNumber) {
            // This function is kept for compatibility but now returns empty
            // Pending history is loaded asynchronously via loadPendingHistoryForCard
            return '';
        }

        function showLoading(show) {
            loading.classList.toggle('hidden', !show);
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function showResultsCounter(show) {
            resultsCounter.classList.toggle('hidden', !show);
        }

        function showNoResults(show) {
            noResults.classList.toggle('hidden', !show);
        }

        // Detail functions
        async function showDetails(houseNumber) {
            const modal = document.getElementById('detailModal');
            const detailHouseNumber = document.getElementById('detailHouseNumber');
            const detailLoading = document.getElementById('detailLoading');
            const detailContent = document.getElementById('detailContent');
            const noDetailData = document.getElementById('noDetailData');
            
            // Show modal
            modal.classList.remove('hidden');
            detailHouseNumber.textContent = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${houseNumber}`;
            
            // Show loading
            detailLoading.classList.remove('hidden');
            detailContent.innerHTML = '';
            noDetailData.classList.add('hidden');
            
            try {
                // Fetch detail data with fresh request (don't use cache for modal)
                const response = await fetch(DETAIL_API_URL + '&_=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Detail CSV Response length:', text.length);
                
                // Parse CSV data
                const lines = text.split('\n').filter(line => line.trim() !== '');
                console.log('Total detail lines:', lines.length);
                
                if (lines.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï');
                }
                
                // Process CSV data (skip header row)
                const dataRows = lines.slice(1);
                const allDetailData = dataRows.map(line => parseCSVLine(line));
                
                console.log('Total detail rows:', allDetailData.length);
                
                // Filter data by house number (column index 4)
                const filteredData = allDetailData.filter(row => {
                    const rowHouseNumber = String(row[4] || '').trim();
                    const searchHouseNumber = String(houseNumber).trim();
                    console.log('Comparing:', rowHouseNumber, 'with', searchHouseNumber);
                    return rowHouseNumber === searchHouseNumber;
                });
                
                console.log('Filtered detail data:', filteredData.length, 'records found');
                
                detailLoading.classList.add('hidden');
                
                if (filteredData.length === 0) {
                    console.log('No detail data found for house number:', houseNumber);
                    noDetailData.classList.remove('hidden');
                    return;
                }
                
                // Display detail data
                displayDetailData(filteredData);
                
            } catch (error) {
                console.error('Error fetching detail data:', error);
                detailLoading.classList.add('hidden');
                detailContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-semibold text-red-700 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p class="text-red-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}</p>
                        <button onclick="showDetails('${houseNumber}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                `;
            }
        }
        
        function closeDetails() {
            document.getElementById('detailModal').classList.add('hidden');
        }
        
        function displayDetailData(data) {
            const detailContent = document.getElementById('detailContent');
            
            console.log('Displaying detail data:', data);
            
            // Sort data by date (newest first)
            const sortedData = data.sort((a, b) => {
                const dateA = new Date(a[1] || 0);
                const dateB = new Date(b[1] || 0);
                return dateB - dateA;
            });
            
            let html = `
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-xl">üìã</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h3>
                            <p class="text-sm text-gray-500">‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        </div>
                    </div>
                    <div class="space-y-4">
            `;
            
            sortedData.forEach((row, index) => {
                console.log(`Row ${index}:`, row);
                
                const id = row[0] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const date = row[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const name = row[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                const houseNumber = row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const month = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const year = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const paymentMethod = row[7] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const note = row[8] || '';
                const amountText = row[9] || '';
                const amount = row[10] || 0;
                const imageUrl = row[11] || '';
                const checker = row[12] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const status = row[13] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const checkDate = row[14] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const pdfUrl = row[15] || '';
                
                // Format date properly - handle Google Sheets Date objects
                let formattedDate = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (date && date !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    try {
                        let dateObj;
                        
                        // Check if it's a Google Sheets Date object format like "Date(2024,8,1,15,22,23)"
                        if (typeof date === 'string' && date.startsWith('Date(')) {
                            // Extract parameters from Date(year,month,day,hour,minute,second)
                            const params = date.match(/Date\(([^)]+)\)/);
                            if (params && params[1]) {
                                const parts = params[1].split(',').map(p => parseInt(p.trim()));
                                if (parts.length >= 3) {
                                    // Note: Google Sheets months are 0-based, so we don't subtract 1
                                    const year = parts[0];
                                    const month = parts[1]; // Already 0-based from Google Sheets
                                    const day = parts[2];
                                    const hour = parts[3] || 0;
                                    const minute = parts[4] || 0;
                                    const second = parts[5] || 0;
                                    
                                    dateObj = new Date(year, month, day, hour, minute, second);
                                }
                            }
                        } else if (typeof date === 'string') {
                            // Try parsing as ISO string first
                            dateObj = new Date(date);
                            // If invalid, try other formats
                            if (isNaN(dateObj.getTime())) {
                                // Try parsing Thai date format
                                const parts = date.split('/');
                                if (parts.length === 3) {
                                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            }
                        } else if (typeof date === 'object' && date.v) {
                            dateObj = new Date(date.v);
                        } else {
                            dateObj = new Date(date);
                        }
                        
                        if (dateObj && !isNaN(dateObj.getTime())) {
                            // Format with date and time
                            formattedDate = dateObj.toLocaleDateString('th-TH', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                weekday: 'long'
                            }) + ' ‡πÄ‡∏ß‡∏•‡∏≤ ' + dateObj.toLocaleTimeString('th-TH', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        } else {
                            formattedDate = String(date);
                        }
                    } catch (e) {
                        console.error('Date parsing error:', e, date);
                        formattedDate = String(date);
                    }
                }
                
                // Format check date - handle Google Sheets Date objects
                let formattedCheckDate = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (checkDate && checkDate !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    try {
                        let checkDateObj;
                        
                        // Check if it's a Google Sheets Date object format like "Date(2024,8,11)"
                        if (typeof checkDate === 'string' && checkDate.startsWith('Date(')) {
                            // Extract parameters from Date(year,month,day)
                            const params = checkDate.match(/Date\(([^)]+)\)/);
                            if (params && params[1]) {
                                const parts = params[1].split(',').map(p => parseInt(p.trim()));
                                if (parts.length >= 3) {
                                    // Note: Google Sheets months are 0-based, so we don't subtract 1
                                    const year = parts[0];
                                    const month = parts[1]; // Already 0-based from Google Sheets
                                    const day = parts[2];
                                    
                                    checkDateObj = new Date(year, month, day);
                                }
                            }
                        } else if (typeof checkDate === 'string') {
                            checkDateObj = new Date(checkDate);
                            if (isNaN(checkDateObj.getTime())) {
                                const parts = checkDate.split('/');
                                if (parts.length === 3) {
                                    checkDateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            }
                        } else {
                            checkDateObj = new Date(checkDate);
                        }
                        
                        if (checkDateObj && !isNaN(checkDateObj.getTime())) {
                            formattedCheckDate = checkDateObj.toLocaleDateString('th-TH', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                weekday: 'long'
                            });
                        } else {
                            formattedCheckDate = String(checkDate);
                        }
                    } catch (e) {
                        console.error('Check date parsing error:', e, checkDate);
                        formattedCheckDate = String(checkDate);
                    }
                }
                
                // Enhanced status styling
                let statusBadge = '';
                let cardGradient = '';
                let statusIcon = '';
                
                if (status === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') {
                    statusBadge = 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg';
                    cardGradient = 'bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 border-green-200';
                    statusIcon = '‚úÖ';
                } else if (status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                    statusBadge = 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg';
                    cardGradient = 'bg-gradient-to-br from-yellow-50 via-orange-50 to-amber-50 border-yellow-200';
                    statusIcon = '‚è≥';
                } else {
                    statusBadge = 'bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-lg';
                    cardGradient = 'bg-gradient-to-br from-gray-50 via-slate-50 to-zinc-50 border-gray-200';
                    statusIcon = 'üìã';
                }
                
                // Payment method icon
                let methodIcon = 'üí≥';
                if (paymentMethod.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î')) methodIcon = 'üíµ';
                else if (paymentMethod.includes('‡πÇ‡∏≠‡∏ô')) methodIcon = 'üè¶';
                else if (paymentMethod.includes('QR')) methodIcon = 'üì±';
                
                html += `
                    <div class="relative overflow-hidden rounded-2xl ${cardGradient} border-2 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02]">
                        <!-- Decorative background elements -->
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full transform translate-x-16 -translate-y-16"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full transform -translate-x-12 translate-y-12"></div>
                        
                        <div class="relative p-6">
                            <!-- Header with month/year and status -->
                            <div class="flex justify-between items-start mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center shadow-lg">
                                        <span class="text-white text-lg font-bold">${month.substring(0, 3)}</span>
                                    </div>
                                    <div>
                                        <h4 class="text-xl font-bold text-gray-800">${month} ${year}</h4>
                                        <p class="text-sm text-gray-600 flex items-center gap-1">
                                            <span>üè†</span>
                                            <span>ID: ${id} | ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${houseNumber}</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="px-4 py-2 rounded-full text-sm font-bold ${statusBadge} flex items-center gap-2 animate-pulse">
                                        <span>${statusIcon}</span>
                                        <span>${status}</span>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Main info grid with colorful cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-white bg-opacity-70 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-50 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üë§</span>
                                        <p class="text-sm font-medium text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                                    </div>
                                    <p class="font-bold text-gray-800">${name}</p>
                                </div>
                                
                                <div class="bg-white bg-opacity-70 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-50 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üìÖ</span>
                                        <p class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</p>
                                    </div>
                                    <p class="font-bold text-gray-800">${formattedDate}</p>
                                </div>
                                
                                <div class="bg-white bg-opacity-70 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-50 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">${methodIcon}</span>
                                        <p class="text-sm font-medium text-gray-600">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</p>
                                    </div>
                                    <p class="font-bold text-gray-800">${paymentMethod}</p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-4 border border-green-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üí∞</span>
                                        <p class="text-sm font-medium text-green-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                    </div>
                                    <p class="font-bold text-green-800 text-lg">${Number(amount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                                </div>
                                
                                <div class="bg-white bg-opacity-70 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-50 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üë®‚Äçüíº</span>
                                        <p class="text-sm font-medium text-gray-600">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                                    </div>
                                    <p class="font-bold text-gray-800">${checker}</p>
                                </div>
                                
                                ${checkDate && checkDate !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? `
                                <div class="bg-white bg-opacity-70 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-50 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">‚úÖ</span>
                                        <p class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                                    </div>
                                    <p class="font-bold text-gray-800">${formattedCheckDate}</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Notes and additional info -->
                            ${note ? `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-xl p-4 border border-blue-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üìù</span>
                                        <p class="text-sm font-medium text-blue-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</p>
                                    </div>
                                    <p class="text-blue-800 font-medium">${note}</p>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${amountText ? `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4 border border-purple-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">üíµ</span>
                                        <p class="text-sm font-medium text-purple-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                    </div>
                                    <p class="text-purple-800 font-medium">${amountText}</p>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Image display in card -->
                            ${imageUrl ? `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-indigo-100 to-purple-100 rounded-xl p-4 border border-indigo-200">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-lg">üñºÔ∏è</span>
                                        <p class="text-sm font-medium text-indigo-700">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                    </div>
                                    <!-- Image preview -->
                                    <div class="mb-3 bg-white rounded-lg p-2 shadow-inner">
                                        <img src="${imageUrl}" alt="‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" 
                                             class="w-full max-h-48 object-contain rounded-lg cursor-pointer hover:shadow-lg transition-shadow duration-300" 
                                             onclick="showImageModal('${imageUrl}')"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                            <div class="text-red-500 text-2xl mb-2">üñºÔ∏è</div>
                                            <p class="text-red-600 text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
                                        </div>
                                    </div>
                                    <button onclick="showImageModal('${imageUrl}')" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white py-2 px-4 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                        <span>üîç</span>
                                        <span>‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</span>
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- PDF display in card -->
                            ${pdfUrl ? `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-red-100 to-pink-100 rounded-xl p-4 border border-red-200">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-lg">üìÑ</span>
                                        <p class="text-sm font-medium text-red-700">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</p>
                                    </div>
                                    <!-- PDF preview container -->
                                    <div id="pdf-preview-${id}" class="mb-3 bg-white rounded-lg p-2 shadow-inner hidden">
                                        <div class="text-center">
                                            <div class="loading-pdf hidden">
                                                <div class="inline-block w-6 h-6 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                                                <p class="text-sm text-gray-600 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á PDF...</p>
                                            </div>
                                            <div class="pdf-images-container"></div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="convertPdfToImages('${pdfUrl}', '${id}')" class="flex-1 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white py-2 px-4 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                            <span>üñºÔ∏è</span>
                                            <span>‡∏î‡∏π PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ</span>
                                        </button>
                                        <a href="${pdfUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 bg-gradient-to-r from-gray-500 to-slate-500 hover:from-gray-600 hover:to-slate-600 text-white py-2 px-4 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2 no-underline">
                                            <span>üìÑ</span>
                                            <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Action buttons -->
                            <div class="flex gap-3 flex-wrap">
                                <!-- Additional action buttons can be added here -->
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            detailContent.innerHTML = html;
        }
        
        // Image Modal Functions
        function showImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageUrl;
            modal.classList.remove('hidden');
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
        }

        // PDF Modal Functions
        function showPdfModal(images) {
            const modal = document.getElementById('pdfModal');
            const content = document.getElementById('pdfModalContent');
            
            content.innerHTML = '';
            
            if (images && images.length > 0) {
                images.forEach((imageDataUrl, index) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'mb-4';
                    
                    const pageLabel = document.createElement('h4');
                    pageLabel.className = 'text-lg font-bold text-gray-700 mb-2';
                    pageLabel.textContent = `‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1}`;
                    
                    const img = document.createElement('img');
                    img.src = imageDataUrl;
                    img.alt = `PDF ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${index + 1}`;
                    img.className = 'max-w-full mx-auto rounded-lg shadow-lg border border-gray-300 hover:shadow-xl transition-shadow duration-300 cursor-pointer';
                    img.onclick = () => showImageModal(imageDataUrl);
                    
                    imgContainer.appendChild(pageLabel);
                    imgContainer.appendChild(img);
                    content.appendChild(imgContainer);
                });
            } else {
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-8">
                        <div class="text-red-500 text-6xl mb-4">üìÑ</div>
                        <h3 class="text-xl font-semibold text-red-700 mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÑ‡∏î‡πâ</h3>
                        <p class="text-red-600">‡πÑ‡∏ü‡∏•‡πå PDF ‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }
        
        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            modal.classList.add('hidden');
        }

        // PDF to Images Conversion
        async function convertPdfToImages(pdfUrl, recordId) {
            const previewContainer = document.getElementById(`pdf-preview-${recordId}`);
            const loadingElement = previewContainer.querySelector('.loading-pdf');
            const imagesContainer = previewContainer.querySelector('.pdf-images-container');
            
            try {
                // Show loading
                previewContainer.classList.remove('hidden');
                loadingElement.classList.remove('hidden');
                imagesContainer.innerHTML = '';
                
                // Convert Google Drive URL to direct download URL if needed
                let directUrl = pdfUrl;
                if (pdfUrl.includes('drive.google.com')) {
                    const fileId = extractGoogleDriveFileId(pdfUrl);
                    if (fileId) {
                        directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    }
                }
                
                // Set PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Load PDF
                const pdf = await pdfjsLib.getDocument({
                    url: directUrl,
                    httpHeaders: {
                        'Access-Control-Allow-Origin': '*'
                    }
                }).promise;
                
                const images = [];
                
                // Convert each page to image
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const scale = 2.0; // Higher scale for better quality
                    const viewport = page.getViewport({ scale });
                    
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Render page to canvas
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    // Convert canvas to image data URL
                    const imageDataUrl = canvas.toDataURL('image/png', 0.9);
                    images.push(imageDataUrl);
                    
                    // Create preview image in card
                    const imgElement = document.createElement('img');
                    imgElement.src = imageDataUrl;
                    imgElement.alt = `PDF ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${pageNum}`;
                    imgElement.className = 'w-full max-h-32 object-contain rounded-lg mb-2 cursor-pointer hover:shadow-lg transition-shadow duration-300';
                    imgElement.onclick = () => showPdfModal(images);
                    
                    const pageLabel = document.createElement('p');
                    pageLabel.className = 'text-xs text-gray-600 mb-2';
                    pageLabel.textContent = `‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${pageNum}`;
                    
                    imagesContainer.appendChild(pageLabel);
                    imagesContainer.appendChild(imgElement);
                }
                
                // Hide loading
                loadingElement.classList.add('hidden');
                
                // Add view all button
                const viewAllBtn = document.createElement('button');
                viewAllBtn.className = 'w-full mt-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white py-2 px-4 rounded-lg text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105';
                viewAllBtn.innerHTML = '<span>üîç</span> <span>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</span>';
                viewAllBtn.onclick = () => showPdfModal(images);
                imagesContainer.appendChild(viewAllBtn);
                
            } catch (error) {
                console.error('Error converting PDF to images:', error);
                
                // Hide loading and show error
                loadingElement.classList.add('hidden');
                imagesContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-red-500 text-2xl mb-2">‚ö†Ô∏è</div>
                        <p class="text-red-600 text-sm mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÑ‡∏î‡πâ</p>
                        <p class="text-red-500 text-xs">${error.message}</p>
                        <button onclick="window.open('${pdfUrl}', '_blank')" class="mt-2 bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-xs">
                            ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                        </button>
                    </div>
                `;
            }
        }

        // Helper function to extract Google Drive file ID
        function extractGoogleDriveFileId(url) {
            const patterns = [
                /\/file\/d\/([a-zA-Z0-9-_]+)/,
                /id=([a-zA-Z0-9-_]+)/,
                /\/d\/([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }
        

        

        
        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeDetails();
            }
        });
        
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') {
                closeImageModal();
            }
        });
        
        document.getElementById('pdfModal').addEventListener('click', (e) => {
            if (e.target.id === 'pdfModal') {
                closePdfModal();
            }
        });
        

        
        // Sample data for testing and fallback
        function createSampleData() {
            console.log('Creating sample data...');
            return [
                {
                    id: 1,
                    data: ['INV001', '998/1', '‡∏ã‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1', '‡∏ô‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', '15/01/2024', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '2024', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢']
                },
                {
                    id: 2,
                    data: ['INV002', '998/2', '‡∏ã‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 2', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö', '10/02/2024', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '2024', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢']
                },
                {
                    id: 3,
                    data: ['INV003', '998/3', '‡∏ã‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 3', '‡∏ô‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏™‡∏≤‡∏°', '05/03/2024', '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '2024', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢']
                },
                {
                    id: 4,
                    data: ['INV004', '998/4', '‡∏ã‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 4', '‡∏ô‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏™‡∏µ‡πà', '20/04/2024', '‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '2024', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', '‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤']
                },
                {
                    id: 5,
                    data: ['INV005', '998/5', '‡∏ã‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 5', '‡∏ô‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏´‡πâ‡∏≤', '12/05/2024', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '2024', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö']
                }
            ];
        }

        // Test data for debugging (kept for compatibility)
        function createTestData() {
            return createSampleData();
        }

        // Initialize the application
        async function initializeApp() {
            console.log('Initializing application...');
            
            try {
                // Try to load real data first
                console.log('Attempting to load real data...');
                const data = await fetchData();
                
                if (data && data.length > 0) {
                    console.log('Successfully loaded data:', data.length, 'records');
                    await displayResults(data);
                } else {
                    console.log('No data returned, this should not happen as fetchData provides fallback');
                    // This should not happen as fetchData now always returns sample data on failure
                    const sampleData = createSampleData();
                    allData = sampleData;
                    await displayResults(sampleData);
                }
                
            } catch (error) {
                console.error('Critical error during initialization:', error);
                
                // Last resort fallback
                try {
                    const sampleData = createSampleData();
                    allData = sampleData;
                    await displayResults(sampleData);
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
                } catch (fallbackError) {
                    console.error('Even fallback failed:', fallbackError);
                    showError('‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
                }
            }
        }

        // Load initial data when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // Document is already loaded
            initializeApp();
        }

        // Also listen for window load as backup
        window.addEventListener('load', () => {
            // Only initialize if not already done
            if (!allData || allData.length === 0) {
                console.log('Backup initialization triggered...');
                initializeApp();
            }
        });
        
        // Add error handling for uncaught errors
        window.addEventListener('error', (event) => {
            console.error('Uncaught error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'993e859e725bee2d',t:'MTc2MTM2MTgzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
