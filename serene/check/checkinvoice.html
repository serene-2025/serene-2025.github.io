import React, { useState, useEffect } from 'react';
import { Search, Home, User, Clock, CreditCard, Menu, X, Coins, CheckCircle, AlertCircle, AlertTriangle, ShieldAlert, FileWarning, HelpCircle, Mail, Eye, EyeOff, FileText, Receipt, Calendar, ChevronRight, Image as ImageIcon, ExternalLink, UserCheck, Banknote, MessageSquare, Hash, Fingerprint, Type, CalendarCheck, BadgeCheck, Bell, ZoomIn, RefreshCw, Loader2 } from 'lucide-react';

// --- Supabase Configuration ---
const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';

// --- Telegram Configuration ---
const TELEGRAM_TOKEN = '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo';
const TELEGRAM_CHAT_ID = '7585120244';

const App = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [payments, setPayments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [supabase, setSupabase] = useState(null);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const [allPendingFees, setAllPendingFees] = useState([]);

  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤ ID ‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏á
  const [visibleNames, setVisibleNames] = useState({});

  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  const [detailModalOpen, setDetailModalOpen] = useState(false);
  const [selectedHouse, setSelectedHouse] = useState(null);
  const [historyData, setHistoryData] = useState([]);
  const [historyLoading, setHistoryLoading] = useState(false);

  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏î‡∏π PDF
  const [pdfModalOpen, setPdfModalOpen] = useState(false);
  const [selectedPdfUrl, setSelectedPdfUrl] = useState(null);

  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  const [imageModalOpen, setImageModalOpen] = useState(false);
  const [selectedImageUrl, setSelectedImageUrl] = useState(null);

  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Loading ‡∏Å‡∏≤‡∏£ Sync
  const [syncingId, setSyncingId] = useState(null);
  const [isAutoSyncing, setIsAutoSyncing] = useState(false); // New state for bulk sync status

  // Mapping ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô Column Database
  const monthMap = {
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 'jan', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 'feb', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 'mar', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 'apr',
    '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 'may', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 'jun', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 'jul', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 'aug',
    '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 'sep', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 'oct', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 'nov', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 'dec'
  };
  
  // Months Array for iteration
  const months = [
    { key: 'jan', label: '‡∏°.‡∏Ñ.' }, { key: 'feb', label: '‡∏Å.‡∏û.' }, { key: 'mar', label: '‡∏°‡∏µ.‡∏Ñ.' },
    { key: 'apr', label: '‡πÄ‡∏°.‡∏¢.' }, { key: 'may', label: '‡∏û.‡∏Ñ.' }, { key: 'jun', label: '‡∏°‡∏¥.‡∏¢.' },
    { key: 'jul', label: '‡∏Å.‡∏Ñ.' }, { key: 'aug', label: '‡∏™.‡∏Ñ.' }, { key: 'sep', label: '‡∏Å.‡∏¢.' },
    { key: 'oct', label: '‡∏ï.‡∏Ñ.' }, { key: 'nov', label: '‡∏û.‡∏¢.' }, { key: 'dec', label: '‡∏ò.‡∏Ñ.' },
  ];

  // Helper to generate unique key for UI items
  const getItemKey = (item) => `${item.house_numbe}-${item.year}`;

  // Load Fonts and Supabase
  useEffect(() => {
    // Load Kanit Font
    const link = document.createElement('link');
    link.href = 'https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap';
    link.rel = 'stylesheet';
    document.head.appendChild(link);

    // Load Supabase
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
    script.async = true;
    script.onload = () => {
      if (window.supabase) {
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        setSupabase(client);
      }
    };
    document.body.appendChild(script);

    return () => {
      document.head.removeChild(link);
      if (document.body.contains(script)) document.body.removeChild(script);
    };
  }, []);

  // --- Telegram Notification Logic ---
  const sendTelegramNotification = async (houseNo, searchResults) => {
    try {
        if (!searchResults || searchResults.length === 0) {
            return;
        }

        let message = `üè† *‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤*\n`;
        message += `üìç ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: *${houseNo}*\n`;
        message += `üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: *${searchResults.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£*\n\n`;

        searchResults.forEach((item, index) => {
            // Calculate financials for this specific item
            let paidCount = 0;
            let overdueCount = 0;
            let advanceCount = 0;
            let waitingCount = 0;
            const RATE = 300;

            const monthlyStatus = months.map(m => {
                const status = item[m.key] || '';
                let emoji = '‚ùì'; // Default

                if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) {
                    emoji = '‚úÖ';
                    paidCount++;
                } else if (status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                    emoji = 'üîÑ';
                    advanceCount++;
                } else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) {
                    emoji = '‚ùå';
                    overdueCount++;
                } else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                    emoji = '‚è≥';
                    waitingCount++;
                } else if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) {
                    emoji = '‚≠ï';
                }

                return `${emoji} ${m.label}`;
            }).join(' ');

            // Calculate amounts
            const totalPaid = paidCount * RATE;
            const totalUnpaid = overdueCount * RATE;
            const totalAdvance = advanceCount * RATE;

            // Determine Alert Status text
            let alertStatusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
            if (overdueCount > 0) alertStatusText = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            else if (waitingCount > 0) alertStatusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            else if (paidCount > 0 || advanceCount > 0) alertStatusText = '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';

            message += `üìã *‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1} (‡∏õ‡∏µ ${item.year})*\n`;
            message += `üë§ ‡∏ä‡∏∑‡πà‡∏≠: ${item.owner_name || '-'}\n`;
            message += `üèòÔ∏è ‡∏ã‡∏≠‡∏¢: ${item.soi || '-'}\n`;
            message += `üìÖ ‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô: ${item.transfer_date || '-'}\n`;
            message += `üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${item.status || '-'}\n`;
            message += `‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: *${alertStatusText}*\n`;
            
            message += `üí∞ *‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:*\n`;
            message += `‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${totalPaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            message += `‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${totalUnpaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            message += `üîÑ ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ${totalAdvance.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            message += `üìÖ *‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:*\n`;
            message += monthlyStatus + '\n';
            
            if (index < searchResults.length - 1) {
                message += '\n' + '‚îÄ'.repeat(30) + '\n\n';
            }
        });

        message += `\nüïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${new Date().toLocaleString('th-TH')}`;

        const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
        
        const response = await fetch(telegramUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            })
        });

        if (response.ok) {
            console.log('‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Telegram:', await response.text());
        }

    } catch (error) {
        console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram:', error);
    }
  };

  // --- Core Sync Logic (Separated for reuse) ---
  const syncHouseLogic = async (item) => {
    if (!supabase) return false;

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
        const { data: feeHistory, error: feeError } = await supabase
            .from('common_fees')
            .select('*')
            .eq('house_number', item.house_numbe)
            .eq('year', item.year);

        if (feeError) throw feeError;

        if (feeHistory && feeHistory.length > 0) {
            let updates = {};
            let hasUpdates = false;

            // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Update Object
            feeHistory.forEach(fee => {
                const monthCol = monthMap[fee.month];
                if (monthCol) {
                    const currentStatus = item[monthCol];
                    // Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    if (fee.status.includes('‡∏£‡∏≠') || fee.status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') && !fee.status.includes('‡πÅ‡∏•‡πâ‡∏ß')) {
                        if (currentStatus !== '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') {
                            updates[monthCol] = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                            hasUpdates = true;
                        }
                    } else if (fee.status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || fee.status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || fee.status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')) {
                        if (currentStatus !== '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                            updates[monthCol] = '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                            hasUpdates = true;
                        }
                    }
                }
            });

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• house_payments ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
            if (hasUpdates) {
                const { error: updateError } = await supabase
                    .from('house_payments')
                    .update(updates)
                    .eq('house_numbe', item.house_numbe)
                    .eq('year', item.year);

                if (updateError) throw updateError;
                return true; // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            }
        }
        return false; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    } catch (err) {
        console.error(`Sync Error for ${item.house_numbe}:`, err);
        return false;
    }
  };

  // Fetch House Payments (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
  const fetchPayments = async (search = '', autoSync = false) => {
    if (!supabase) return [];

    setLoading(true);
    if (autoSync) setIsAutoSyncing(true);
    setError(null);
    try {
      let query = supabase.from('house_payments').select('*');

      if (search) {
        query = query.or(`house_numbe.ilike.%${search}%,owner_name.ilike.%${search}%`);
      }

      const { data, error } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });

      if (error) throw error;

      let finalData = data || [];

      if (search) {
        const lowerSearch = search.trim().toLowerCase();
        const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
        if (exactMatches.length > 0) {
           finalData = exactMatches;
        }
      }

      // --- AUTO SYNC LOGIC ---
      if (autoSync && finalData.length > 0) {
          let anyUpdated = false;
          // ‡πÉ‡∏ä‡πâ Promise.all ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Sync ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏ô‡∏≤‡∏ô (Parallel) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
          const syncPromises = finalData.map(async (item) => {
              const updated = await syncHouseLogic(item);
              return updated;
          });
          
          const results = await Promise.all(syncPromises);
          if (results.some(r => r === true)) {
              anyUpdated = true;
          }

          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          if (anyUpdated) {
             const { data: refreshedData, error: refreshError } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });
             if (!refreshError && refreshedData) {
                 finalData = refreshedData;
                 // Filter again if needed
                 if (search) {
                    const lowerSearch = search.trim().toLowerCase();
                    const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
                    if (exactMatches.length > 0) finalData = exactMatches;
                 }
             }
          }
      }

      setPayments(finalData);
      return finalData; // RETURN DATA FOR TELEGRAM
    } catch (err) {
      console.error('Error:', err);
      setError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      return [];
    } finally {
      setLoading(false);
      setIsAutoSyncing(false);
    }
  };

  // Fetch All Pending Fees (‡∏ï‡∏≤‡∏£‡∏≤‡∏á common_fees: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
  const fetchAllPendingFees = async () => {
    if (!supabase) return;
    try {
      const { data, error } = await supabase
        .from('common_fees')
        .select('*')
        .eq('status', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');

      if (error) throw error;
      setAllPendingFees(data || []);
    } catch (err) {
      console.error('Error fetching pending fees:', err);
    }
  };

  // --- UI Wrapper for Individual Sync ---
  const handleSyncStatus = async (item) => {
    const itemKey = getItemKey(item);
    setSyncingId(itemKey);
    
    try {
        const updated = await syncHouseLogic(item);
        if (updated) {
            await fetchPayments(searchTerm, false); // Fetch ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Auto Sync ‡∏ã‡πâ‡∏≥
            await fetchAllPendingFees();
        }
    } catch (err) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
    } finally {
        setSyncingId(null);
    }
  };

  // Fetch specific history for modal
  const fetchHistory = async (houseNumber) => {
    if (!supabase) return;
    setHistoryLoading(true);
    setHistoryData([]);
    
    try {
      const { data, error } = await supabase
        .from('common_fees')
        .select('*')
        .eq('house_number', houseNumber)
        .order('reported_at', { ascending: false });

      if (error) throw error;
      setHistoryData(data || []);
    } catch (err) {
      console.error('Error fetching history:', err);
    } finally {
      setHistoryLoading(false);
    }
  };

  const openDetailModal = (item) => {
    setSelectedHouse(item);
    setDetailModalOpen(true);
    fetchHistory(item.house_numbe);
  };

  const closeDetailModal = () => {
    setDetailModalOpen(false);
    setSelectedHouse(null);
    setHistoryData([]);
  };

  const getDrivePreviewUrl = (url) => {
    if (!url) return '';
    return url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview');
  };

  const openPdfModal = (url) => {
    setSelectedPdfUrl(getDrivePreviewUrl(url));
    setPdfModalOpen(true);
  };

  const closePdfModal = () => {
    setPdfModalOpen(false);
    setSelectedPdfUrl(null);
  };

  // Image Modal Functions
  const openImageModal = (url) => {
    setSelectedImageUrl(url);
    setImageModalOpen(true);
  };

  const closeImageModal = () => {
    setImageModalOpen(false);
    setSelectedImageUrl(null);
  };

  useEffect(() => {
    if (supabase) {
      // Initial load without auto sync
      const delayDebounceFn = setTimeout(() => {
        fetchPayments(searchTerm, false);
        fetchAllPendingFees();
      }, 500);
      return () => clearTimeout(delayDebounceFn);
    }
  }, [searchTerm, supabase]); // Note: This handles typing search (debounced)

  // Handler for explicit Search Button click
  const handleSearchClick = async () => {
      // Trigger fetch with AUTO SYNC enabled
      const results = await fetchPayments(searchTerm, true); 
      await fetchAllPendingFees();
      
      // --- TRIGGER TELEGRAM ALERT ---
      if (searchTerm.trim()) {
        sendTelegramNotification(searchTerm, results);
      }
  };

  const maskName = (fullName) => {
      if (!fullName || fullName.length <= 3) return fullName;
      const prefixes = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á', '‡∏î‡∏£.', '‡∏®.', '‡∏£‡∏®.', '‡∏ú‡∏®.', '‡∏≠.', '‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ'];
      let prefix = '';
      let nameWithoutPrefix = fullName;
      for (const p of prefixes) {
          if (fullName.startsWith(p)) {
              prefix = p;
              nameWithoutPrefix = fullName.substring(p.length).trim();
              break;
          }
      }
      const nameParts = nameWithoutPrefix.split(/\s+/);
      if (nameParts.length === 0) return fullName;
      const firstName = nameParts[0];
      if (nameParts.length === 1) {
          if (firstName.length <= 3) return fullName;
          return (prefix ? prefix + ' ' : '') + firstName.substring(0, 3) + 'xxxxxxx';
      }
      return (prefix ? prefix + ' ' : '') + firstName + ' xxxxxxx';
  };

  // FIXED: Use composite key for visibility toggle
  const toggleNameVisibility = (key) => {
    setVisibleNames(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const getStatusColor = (status) => {
    if (!status) return 'bg-gray-100 text-gray-400 border-gray-200';
    if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) return 'bg-green-100 text-green-700 border-green-200';
    if (status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) return 'bg-blue-100 text-blue-700 border-blue-200';
    if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) return 'bg-red-100 text-red-700 border-red-200';
    if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
    if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return 'bg-gray-100 text-gray-400 border-gray-200';
    return 'bg-gray-50 text-gray-600 border-gray-200';
  };

  const calculateFinancials = (item) => {
    let paidCount = 0;
    let overdueCount = 0;
    let waitingCount = 0;
    const RATE = 300;
    months.forEach(month => {
      const status = item[month.key];
      if (!status) return;
      if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) paidCount++;
      else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) overdueCount++;
      else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) waitingCount++;
    });
    return { paid: paidCount * RATE, overdue: overdueCount * RATE, waiting: waitingCount * RATE, overdueMonths: overdueCount, waitingMonths: waitingCount };
  };

  const getHeaderStyle = (financials) => {
    const { overdueMonths, waitingMonths } = financials;
    if (overdueMonths === 0 && waitingMonths > 0) return { bg: 'bg-gradient-to-r from-yellow-400 to-yellow-500', border: 'border-yellow-500', text: 'text-slate-900', statusText: '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', icon: <HelpCircle size={20} className="text-slate-900" /> };
    if (overdueMonths === 0) return { bg: 'bg-gradient-to-r from-green-500 to-green-600', border: 'border-green-600', text: 'text-white', statusText: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', icon: <CheckCircle size={20} className="text-white" /> };
    if (overdueMonths > 6) return { bg: 'bg-gradient-to-r from-red-800 to-red-900', border: 'border-red-900', text: 'text-white', statusText: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', icon: <ShieldAlert size={20} className="text-white" /> };
    if (overdueMonths >= 3) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', border: 'border-red-600', text: 'text-white', statusText: '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ', icon: <Mail size={20} className="text-white" /> };
    return { bg: 'bg-gradient-to-r from-orange-400 to-orange-500', border: 'border-orange-500', text: 'text-white', statusText: `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, icon: <AlertTriangle size={20} className="text-white" /> };
  };

  const getHistoryStatusBadge = (status) => {
    if (!status) return <span className="text-gray-400">-</span>;
    if (status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á') || status.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')) {
       return <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200 flex items-center gap-1"><CheckCircle size={10}/> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>;
    }
    if (status.includes('‡∏£‡∏≠') || status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
       return <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200 flex items-center gap-1"><Clock size={10}/> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>;
    }
    if (status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
       return <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200 flex items-center gap-1"><X size={10}/> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>;
    }
    return <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-200">{status}</span>;
  };

  const getHistoryCardHeaderStyle = (status) => {
    if (!status) return { 
        bg: 'bg-gradient-to-r from-slate-50 to-white', 
        text: 'text-slate-700', 
        iconColor: 'text-indigo-600', 
        iconBg: 'bg-indigo-100', 
        border: 'border-slate-100' 
    };
    
    if (status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á') || status.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')) {
       return { 
         bg: 'bg-gradient-to-r from-emerald-500 to-green-600', 
         text: 'text-white', 
         iconColor: 'text-emerald-600', 
         iconBg: 'bg-white', 
         border: 'border-emerald-600' 
       };
    }
    
    if (status.includes('‡∏£‡∏≠') || status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
       return { 
         bg: 'bg-gradient-to-r from-amber-400 to-orange-500', 
         text: 'text-white',
         iconColor: 'text-amber-600',
         iconBg: 'bg-white',
         border: 'border-amber-500'
       };
    }

    if (status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
        return { 
         bg: 'bg-gradient-to-r from-red-500 to-red-600', 
         text: 'text-white', 
         iconColor: 'text-red-600', 
         iconBg: 'bg-white', 
         border: 'border-red-600' 
       };
    }

    return { 
        bg: 'bg-gradient-to-r from-slate-50 to-white', 
        text: 'text-slate-700', 
        iconColor: 'text-indigo-600', 
        iconBg: 'bg-indigo-100', 
        border: 'border-slate-100' 
    };
  };

  const getHistoryHeaderBadge = (status) => {
    const textClass = status?.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status?.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') ? 'text-emerald-700' :
                      status?.includes('‡∏£‡∏≠') ? 'text-amber-700' :
                      status?.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status?.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') ? 'text-red-700' : 'text-slate-700';
    
    return (
        <span className={`bg-white ${textClass} px-2 py-0.5 rounded text-[10px] font-bold shadow-sm flex items-center gap-1 whitespace-nowrap`}>
            {status || '-'}
        </span>
    );
  };

  const DetailRow = ({ label, value, icon: Icon, color = "text-slate-700" }) => (
    <div className="flex flex-col">
        <span className="text-[10px] text-slate-400 mb-0.5 flex items-center gap-1">
            {Icon && <Icon size={10} />} {label}
        </span>
        <span className={`text-xs font-semibold ${color} truncate`}>{value || '-'}</span>
    </div>
  );

  return (
    <div className="min-h-screen text-slate-800" style={{ fontFamily: "'Kanit', sans-serif" }}>
      
      {/* Background */}
      <div className="fixed inset-0 -z-10 bg-gradient-to-br from-[#1e3c72] via-[#2a5298] via-[#667eea] via-[#764ba2] to-[#8e44ad]"></div>
      <div className="fixed inset-0 -z-10 opacity-30 bg-[radial-gradient(circle_at_20%_80%,rgba(120,119,198,0.3),transparent_25%),radial-gradient(circle_at_80%_20%,rgba(255,255,255,0.2),transparent_25%)]"></div>

      {/* Navbar */}
      <nav className="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center gap-3">
              <div className="bg-white/20 p-2 rounded-lg text-white">
                <Home size={24} />
              </div>
              <span className="text-white text-xl font-bold tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
            </div>
            <div className="md:hidden">
              <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-white p-2 hover:bg-white/10 rounded-lg">
                {isMenuOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>
          </div>
        </div>
        {isMenuOpen && (
          <div className="md:hidden px-4 pb-4 animate-in slide-in-from-top-2">
            <div className="flex gap-2">
              <div className="relative flex-1">
                <input
                  type="text"
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô..."
                  className="w-full pl-10 pr-4 py-2 bg-white/90 rounded-lg text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-400"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                <Search className="absolute left-3 top-2.5 text-slate-400" size={18} />
              </div>
              <button 
                onClick={handleSearchClick}
                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2"
              >
                {isAutoSyncing ? <Loader2 size={18} className="animate-spin"/> : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}
              </button>
            </div>
          </div>
        )}
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="hidden md:block max-w-3xl mx-auto mb-10 text-center">
          <h2 className="text-4xl font-bold text-white mb-2 drop-shadow-md">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>
          <p className="text-indigo-100 text-lg mb-4 font-medium drop-shadow-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢</p>
          <div className="mb-8 text-indigo-200 text-sm space-y-1">
              <p>‚úÖ1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
              <p>‚úÖ2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
          </div>
          
          <div className="flex gap-3 items-stretch justify-center">
              <div className="relative group flex-1">
                <div className="absolute -inset-1 bg-gradient-to-r from-blue-400 to-purple-400 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
                <div className="relative h-full">
                  <input
                    type="text"
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 99/1)..."
                    className="w-full h-full pl-12 pr-4 py-4 bg-white/95 backdrop-blur rounded-xl text-lg text-slate-900 placeholder-slate-400 shadow-xl focus:outline-none focus:ring-2 focus:ring-white/50"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                  <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={24} />
                </div>
              </div>
              <button 
                onClick={handleSearchClick}
                disabled={loading}
                className="bg-white/90 hover:bg-white text-indigo-600 font-bold px-8 rounded-xl shadow-xl transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2 backdrop-blur-sm border border-white/50 disabled:opacity-80 disabled:cursor-not-allowed"
              >
                 {isAutoSyncing ? <Loader2 size={24} className="animate-spin text-indigo-600" /> : <Search size={22} />}
                 <span className="text-lg">{isAutoSyncing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}</span>
              </button>
          </div>
        </div>

        {!supabase ? (
          <div className="text-center py-20">
            <div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div>
            <p className="text-white/80 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
        ) : loading ? (
          <div className="text-center py-20 flex flex-col items-center">
            <div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div>
            {isAutoSyncing && <p className="text-white/80 animate-pulse font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>}
          </div>
        ) : error ? (
          <div className="max-w-md mx-auto bg-red-500/10 backdrop-blur border border-red-500/30 p-4 rounded-xl text-center text-white">
            <AlertCircle className="mx-auto mb-2 text-red-300" size={32} />
            <p>{error}</p>
          </div>
        ) : payments.length === 0 ? (
          <div className="text-center py-20 bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 max-w-lg mx-auto">
            <div className="bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Search className="text-white/50" size={32} />
            </div>
            <p className="text-xl text-white font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <p className="text-white/60 mt-2">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            {payments.map((item) => {
              const financials = calculateFinancials(item);
              const headerStyle = getHeaderStyle(financials);
              const itemKey = getItemKey(item);
              const isNameVisible = visibleNames[itemKey];
              const isSyncing = syncingId === itemKey;
              
              // Filter pending fees for this house
              const housePendingFees = allPendingFees.filter(f => 
                (f.house_number || '').trim() === (item.house_numbe || '').trim()
              );
              const pendingTotal = housePendingFees.reduce((sum, f) => sum + (f.amount || 0), 0);
              
              return (
                <div 
                  key={itemKey} 
                  className="bg-white rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 flex flex-col"
                >
                  {/* Status Header */}
                  <div className={`${headerStyle.bg} px-5 py-4 border-b ${headerStyle.border} flex justify-between items-start transition-colors duration-300`}>
                    <div>
                      <h3 className={`text-2xl font-bold flex items-center gap-2 ${headerStyle.text}`}>
                          <Home className={headerStyle.text} size={24} />
                          {item.house_numbe}
                      </h3>
                      <div className={`text-xs mt-1 font-medium px-2 py-0.5 rounded-full w-fit bg-white/20 backdrop-blur-sm ${headerStyle.text}`}>
                         ‡∏õ‡∏µ {item.year}
                      </div>
                    </div>
                    <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg whitespace-nowrap bg-white text-slate-800`}>
                        {React.cloneElement(headerStyle.icon, { className: 'text-slate-700' })}
                        <span className="text-slate-700">{headerStyle.statusText}</span>
                    </div>
                  </div>

                  <div className="p-5 bg-white flex-1 flex flex-col">
                    
                    {/* --- Pending Fees Alert Box --- */}
                    {housePendingFees.length > 0 && (
                      <div 
                        onClick={() => openDetailModal(item)}
                        className="mb-5 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-3 flex items-start justify-between shadow-sm animate-pulse cursor-pointer hover:bg-orange-100 transition-colors"
                        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                      >
                         <div className="flex items-start gap-3">
                            <div className="bg-white p-2 rounded-full shadow-sm text-orange-500 mt-1">
                               <Bell size={20} />
                            </div>
                            <div>
                               <h5 className="text-sm font-bold text-orange-800 mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5>
                               <div className="flex flex-wrap gap-1">
                                 {housePendingFees.map((fee, idx) => (
                                   <span key={idx} className="text-[10px] bg-white/80 px-2 py-0.5 rounded text-orange-700 border border-orange-100 font-medium">
                                     {fee.month} {fee.year}
                                   </span>
                                 ))}
                               </div>
                            </div>
                         </div>
                         <div className="text-right pl-2 whitespace-nowrap">
                            <span className="text-[10px] text-orange-600 font-semibold block">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                            <h4 className="text-lg font-bold text-orange-800">‡∏ø{pendingTotal.toLocaleString()}</h4>
                         </div>
                      </div>
                    )}

                    {/* House Info */}
                    <div className="mb-5 pb-4 border-b border-slate-100 space-y-2">
                      <div className="flex items-center justify-between gap-2 font-bold text-lg text-slate-800">
                         <div className="flex items-center gap-2">
                           <User size={18} className="text-blue-500" />
                           <span>{isNameVisible ? item.owner_name : maskName(item.owner_name)}</span>
                         </div>
                         <button 
                           onClick={() => toggleNameVisibility(itemKey)}
                           className="text-slate-400 hover:text-blue-600 transition-colors p-1 rounded-full hover:bg-blue-50"
                           title={isNameVisible ? "‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠" : "‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°"}
                         >
                           {isNameVisible ? <EyeOff size={18} /> : <Eye size={18} />}
                         </button>
                      </div>
                      <div className="grid grid-cols-1 gap-1.5 text-sm">
                        <div className="flex justify-between items-center"><span className="text-slate-500">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span><span className="font-medium text-slate-700">{item.house_numbe}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-500">‡∏ã‡∏≠‡∏¢:</span><span className="font-medium text-slate-700">{item.soi || '-'}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-500">‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô:</span><span className="font-medium text-slate-700">{item.transfer_date || '-'}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span><span className={`font-medium text-slate-700`}>{item.status || '-'}</span></div>
                      </div>
                    </div>

                    <button 
                       onClick={() => openDetailModal(item)}
                       className="w-full mb-4 py-2.5 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 font-bold text-sm flex items-center justify-center gap-2 transition-colors duration-200 border border-indigo-100 shadow-sm"
                    >
                       <FileText size={18} />
                       ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô
                    </button>

                    <div className="mb-3 font-bold text-slate-700 flex items-center justify-between">
                       <div className="flex items-center gap-2">
                          <Clock size={16} className="text-blue-500" />
                          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ({item.year})
                       </div>
                       
                       {/* Sync Button */}
                       <button 
                          onClick={() => handleSyncStatus(item)}
                          disabled={isSyncing}
                          className={`p-1.5 rounded-full hover:bg-slate-100 transition-colors ${isSyncing ? 'animate-spin text-slate-400' : 'text-blue-600 hover:text-blue-800'}`}
                          title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô"
                       >
                          <RefreshCw size={16} />
                       </button>
                    </div>
                    
                    <div className="grid grid-cols-4 gap-2 mb-4">
                      {months.map((month) => {
                         const status = item[month.key];
                         const colorClass = getStatusColor(status);
                         return (
                           <div key={month.key} className={`flex flex-col items-center justify-center p-2 rounded-lg border ${colorClass} min-h-[50px]`}>
                             <span className="text-[10px] font-bold uppercase opacity-60 mb-1">{month.label}</span>
                             <span className="text-[11px] font-semibold text-center leading-tight break-words w-full">{status || '-'}</span>
                           </div>
                         );
                      })}
                    </div>

                    <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 mb-0 mt-auto">
                      <div className="flex items-center gap-1 text-xs font-bold text-slate-400 mb-2"><Coins size={12} />‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (300 ‡∏ö./‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
                      <div className="flex justify-between items-center text-xs">
                        <div className="flex flex-col items-center flex-1 border-r border-slate-200"><span className="text-green-600 font-bold text-sm">‡∏ø{financials.paid.toLocaleString()}</span><span className="text-slate-400">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span></div>
                        <div className="flex flex-col items-center flex-1 border-r border-slate-200"><span className="text-red-500 font-bold text-sm">‡∏ø{financials.overdue.toLocaleString()}</span><span className="text-slate-400">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span></div>
                        <div className="flex flex-col items-center flex-1"><span className="text-yellow-600 font-bold text-sm">‡∏ø{financials.waiting.toLocaleString()}</span><span className="text-slate-400">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></div>
                      </div>
                    </div>

                  </div>
                </div>
              );
            })}
          </div>
        )}
      </main>

      {/* --- HISTORY DETAIL MODAL --- */}
      {detailModalOpen && (
         <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={closeDetailModal}></div>
            <div className="relative bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col animate-in fade-in zoom-in-95 duration-200">
               
               <div className="bg-gradient-to-r from-indigo-600 to-violet-600 px-6 py-4 flex justify-between items-center shrink-0 shadow-md">
                  <div className="text-white">
                     <h3 className="text-xl font-bold flex items-center gap-2">
                        <Receipt className="text-indigo-200" />
                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô
                     </h3>
                     <p className="text-indigo-100 text-sm opacity-90 mt-1 flex items-center gap-1">
                        <Home size={14} /> ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà {selectedHouse?.house_numbe}
                     </p>
                  </div>
                  <button onClick={closeDetailModal} className="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition-colors">
                     <X size={24} />
                  </button>
               </div>

               <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                  {historyLoading ? (
                     <div className="flex flex-col items-center justify-center py-12 text-slate-400">
                        <div className="animate-spin rounded-full h-10 w-10 border-4 border-indigo-200 border-t-indigo-600 mb-4"></div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                     </div>
                  ) : historyData.length === 0 ? (
                     <div className="flex flex-col items-center justify-center py-16 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-white">
                        <FileText size={48} className="mb-4 opacity-20" />
                        <p className="text-lg font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</p>
                        <p className="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö common_fees</p>
                     </div>
                  ) : (
                     <div className="space-y-6">
                        <div className="flex items-center gap-2 text-sm font-bold text-slate-500 mb-2 px-1">
                           <FileText size={16} /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({historyData.length})
                        </div>
                        
                        {historyData.map((record, idx) => {
                           // Determine header style based on status
                           const headerStyle = getHistoryCardHeaderStyle(record.status);
                           
                           return (
                           <div key={record.id || idx} className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 group">
                              
                              {/* --- Card Header with Dynamic Color --- */}
                              <div className={`${headerStyle.bg} px-4 py-3 border-b ${headerStyle.border} flex justify-between items-center`}>
                                 <div className="flex items-center gap-2">
                                    <div className={`${headerStyle.iconBg} p-1.5 rounded-lg ${headerStyle.iconColor}`}>
                                       <Calendar size={16} />
                                    </div>
                                    <span className={`font-bold text-base ${headerStyle.text}`}>
                                       {record.month} {record.year}
                                    </span>
                                 </div>
                                 {getHistoryHeaderBadge(record.status)}
                              </div>

                              {/* --- Slip Image at Top --- */}
                              {record.image_url ? (
                                <div 
                                    className="relative h-48 sm:h-64 w-full bg-slate-100 border-b border-slate-100 group cursor-pointer"
                                    onClick={() => openImageModal(record.image_url)}
                                >
                                    <img 
                                        src={record.image_url} 
                                        alt="Payment Slip" 
                                        className="w-full h-full object-cover"
                                        loading="lazy"
                                    />
                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                        <span className="bg-black/50 text-white px-3 py-1.5 rounded-full text-sm font-medium backdrop-blur-sm flex items-center gap-2">
                                            <ZoomIn size={16} /> ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                        </span>
                                    </div>
                                    <button 
                                        className="absolute bottom-3 right-3 bg-white/90 backdrop-blur-sm text-slate-700 hover:text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold shadow-md flex items-center gap-1.5 hover:bg-white transition-all transform hover:scale-105"
                                        onClick={(e) => {
                                            e.stopPropagation(); 
                                            openImageModal(record.image_url);
                                        }}
                                    >
                                        <ImageIcon size={16} /> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°
                                    </button>
                                </div>
                              ) : (
                                <div className="h-32 bg-slate-50 flex flex-col items-center justify-center text-slate-300 border-b border-slate-100">
                                    <ImageIcon size={32} className="mb-2 opacity-50" />
                                    <span className="text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</span>
                                </div>
                              )}

                              {/* --- Card Body --- */}
                              <div className="p-4">
                                  
                                  {/* Hero Amount & Date */}
                                  <div className="flex justify-between items-end mb-4 pb-4 border-b border-slate-100 border-dashed">
                                      <div>
                                          <span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>
                                          <h4 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-600">
                                             ‡∏ø{(record.amount || 0).toLocaleString()}
                                          </h4>
                                      </div>
                                      <div className="text-right">
                                          <span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</span>
                                          <div className="text-xs font-medium text-slate-600 bg-slate-50 px-2 py-1 rounded border border-slate-100 flex items-center gap-1">
                                             <Clock size={10} />
                                             {record.reported_at 
                                                ? new Date(record.reported_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' })
                                                : '-'
                                             }
                                          </div>
                                      </div>
                                  </div>

                                  {/* Detailed Info Grid */}
                                  <div className="grid grid-cols-2 gap-x-4 gap-y-3 bg-slate-50 p-3 rounded-xl border border-slate-100 mb-3">
                                      <DetailRow label="ID" value={record.id} icon={Hash} />
                                      <DetailRow label="UID" value={record.user_id ? maskName(record.user_id) : '-'} icon={Fingerprint} />
                                      <DetailRow label="‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" value={record.name} icon={User} />
                                      <DetailRow label="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" value={record.house_number} icon={Home} />
                                      <DetailRow label="‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢" value={record.payment_method} icon={Banknote} color="text-emerald-600" />
                                      <DetailRow label="‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" value={record.amount_text} icon={Type} />
                                      <div className="col-span-2 pt-2 mt-1 border-t border-slate-200 grid grid-cols-2 gap-4">
                                          <DetailRow label="‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" value={record.inspector} icon={UserCheck} color="text-purple-600" />
                                          <DetailRow label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" value={record.inspected_at ? new Date(record.inspected_at).toLocaleDateString('th-TH') : '-'} icon={CalendarCheck} />
                                      </div>
                                  </div>

                                  {/* Remark */}
                                  {record.remark && (
                                     <div className="mb-3 bg-amber-50 border border-amber-100 rounded-lg p-2.5 flex gap-2 items-start">
                                        <MessageSquare size={14} className="text-amber-500 mt-0.5 shrink-0" />
                                        <div>
                                           <span className="text-[10px] font-bold text-amber-700 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span>
                                           <p className="text-xs text-amber-900 leading-relaxed">{record.remark}</p>
                                        </div>
                                     </div>
                                  )}

                                  {/* PDF Button */}
                                  {record.pdf_url && (
                                     <button 
                                       onClick={() => openPdfModal(record.pdf_url)}
                                       className="w-full flex items-center justify-center gap-2 text-blue-600 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-lg text-xs font-bold transition-all border border-blue-200"
                                     >
                                        <FileText size={14} /> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF
                                     </button>
                                  )}
                              </div>
                           </div>
                        );
                        })}
                     </div>
                  )}
               </div>

               <div className="bg-white p-4 border-t border-slate-100 text-center text-xs text-slate-400">
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á common_fees
               </div>

            </div>
         </div>
      )}

      {/* --- PDF MODAL --- */}
      {pdfModalOpen && selectedPdfUrl && (
         <div className="fixed inset-0 z-[110] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onClick={closePdfModal}></div>
            <div className="relative bg-white rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl animate-in fade-in zoom-in-95 duration-200">
               
               <div className="flex justify-between items-center p-4 border-b border-slate-200 bg-slate-50 rounded-t-2xl">
                  <h3 className="font-bold text-slate-800 flex items-center gap-2">
                     <FileText className="text-red-500" />
                     ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF
                  </h3>
                  <div className="flex items-center gap-2">
                     <a href={selectedPdfUrl.replace('/preview', '/view')} target="_blank" rel="noreferrer" className="text-slate-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà">
                        <ExternalLink size={20} />
                     </a>
                     <button onClick={closePdfModal} className="text-slate-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50">
                        <X size={24} />
                     </button>
                  </div>
               </div>
               
               <div className="flex-1 bg-slate-100 relative">
                  <iframe 
                     src={selectedPdfUrl} 
                     className="w-full h-full" 
                     title="PDF Preview"
                     allow="autoplay"
                  ></iframe>
               </div>
            </div>
         </div>
      )}

      {/* --- IMAGE MODAL (NEW) --- */}
      {imageModalOpen && selectedImageUrl && (
         <div className="fixed inset-0 z-[120] flex items-center justify-center p-4" onClick={closeImageModal}>
            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
            <div className="relative w-full max-w-4xl h-full max-h-[90vh] flex flex-col items-center justify-center animate-in fade-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}>
               
               {/* Close Button */}
               <button 
                  onClick={closeImageModal} 
                  className="absolute -top-12 right-0 text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"
               >
                  <X size={32} />
               </button>

               <img 
                  src={selectedImageUrl} 
                  alt="Full Slip" 
                  className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
               />
               
               {/* Download/Open External Link */}
               <div className="absolute -bottom-12 left-0 right-0 flex justify-center gap-4">
                   <a href={selectedImageUrl} target="_blank" rel="noreferrer" className="text-white/80 hover:text-white text-sm flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full hover:bg-white/20 transition-colors">
                       <ExternalLink size={16} /> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                   </a>
               </div>
            </div>
         </div>
      )}

      {/* Footer */}
      <footer className="text-center py-6 text-white/60 text-sm">
        <p>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á | ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</p>
      </footer>
    </div>
  );
};

export default App;
