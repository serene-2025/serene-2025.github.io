<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á | ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React & Icons -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0"
      }
    }
    </script>

    <style>
        body { font-family: 'Kanit', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.5s ease-out forwards; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Home, User, Clock, CreditCard, Menu, X, Coins, CheckCircle, 
            AlertCircle, AlertTriangle, ShieldAlert, FileWarning, HelpCircle, Mail, 
            Eye, EyeOff, FileText, Receipt, Calendar, ChevronRight, Image as ImageIcon, 
            ExternalLink, UserCheck, Banknote, MessageSquare, Hash, Fingerprint, Type, 
            CalendarCheck, BadgeCheck, Bell, ZoomIn, RefreshCw, Loader2, Sparkles, ThumbsUp, Printer, ArrowUp,
            LayoutDashboard, BarChart3, Filter, CalendarCheck2, Info, MapPin
        } from 'lucide-react';

        // --- Configuration ---
        const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        const TELEGRAM_TOKEN = '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo';
        const TELEGRAM_CHAT_ID = '7585120244';

        // --- Helpers ---
        const monthMap = { '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 'jan', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 'feb', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 'mar', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 'apr', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 'may', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 'jun', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 'jul', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 'aug', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 'sep', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 'oct', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 'nov', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 'dec' };
        const months = [ { key: 'jan', label: '‡∏°.‡∏Ñ.' }, { key: 'feb', label: '‡∏Å.‡∏û.' }, { key: 'mar', label: '‡∏°‡∏µ.‡∏Ñ.' }, { key: 'apr', label: '‡πÄ‡∏°.‡∏¢.' }, { key: 'may', label: '‡∏û.‡∏Ñ.' }, { key: 'jun', label: '‡∏°‡∏¥.‡∏¢.' }, { key: 'jul', label: '‡∏Å.‡∏Ñ.' }, { key: 'aug', label: '‡∏™.‡∏Ñ.' }, { key: 'sep', label: '‡∏Å.‡∏¢.' }, { key: 'oct', label: '‡∏ï.‡∏Ñ.' }, { key: 'nov', label: '‡∏û.‡∏¢.' }, { key: 'dec', label: '‡∏ò.‡∏Ñ.' } ];
        const getItemKey = (item) => `${item.house_numbe}-${item.year}`;
        const maskName = (fullName) => {
            if (!fullName || fullName.length <= 3) return fullName;
            const prefixes = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á', '‡∏î‡∏£.', '‡∏®.', '‡∏£‡∏®.', '‡∏ú‡∏®.', '‡∏≠.', '‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ'];
            let prefix = ''; let nameWithoutPrefix = fullName;
            for (const p of prefixes) { if (fullName.startsWith(p)) { prefix = p; nameWithoutPrefix = fullName.substring(p.length).trim(); break; } }
            const nameParts = nameWithoutPrefix.split(/\s+/);
            if (nameParts.length === 0) return fullName;
            const firstName = nameParts[0];
            if (nameParts.length === 1) return (prefix ? prefix + ' ' : '') + firstName.substring(0, 3) + 'xxxxxxx';
            return (prefix ? prefix + ' ' : '') + firstName + ' xxxxxxx';
        };
        const getStatusColor = (status) => {
            if (!status) return 'bg-gray-100 text-gray-400 border-gray-200';
            if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) return 'bg-green-100 text-green-700 border-green-200';
            if (status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) return 'bg-blue-100 text-blue-700 border-blue-200';
            if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) return 'bg-red-100 text-red-700 border-red-200';
            if (status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'bg-orange-100 text-orange-700 border-orange-200';
            if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
            if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return 'bg-gray-100 text-gray-400 border-gray-200';
            return 'bg-gray-50 text-gray-600 border-gray-200';
        };
        
        const calculateFinancials = (item) => {
            let paidCount = 0; let overdueCount = 0; let waitingCount = 0; const RATE = 300; let totalMonths = 0;
            let headerOverdueCount = 0; let headerWaitingCount = 0;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthIdx = now.getMonth();
            const itemYear = parseInt(item.year);
            const compareYear = itemYear > 2400 ? currentYear + 543 : currentYear;

            months.forEach((month, idx) => {
                const status = item[month.key];
                if (!status || status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return;
                totalMonths++;
                if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) paidCount++;
                else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) overdueCount++;
                else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) waitingCount++;
                let isEffective = false;
                if (itemYear < compareYear) isEffective = true;
                else if (itemYear === compareYear && idx <= currentMonthIdx) isEffective = true;
                if (isEffective) {
                    if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) headerOverdueCount++;
                    else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) headerWaitingCount++;
                }
            });
            return { paid: paidCount * RATE, overdue: overdueCount * RATE, waiting: waitingCount * RATE, overdueMonths: headerOverdueCount, waitingMonths: headerWaitingCount, totalMonths: totalMonths, counts: { paid: paidCount, overdue: overdueCount, waiting: waitingCount } };
        };

        const getHeaderStyle = (financials) => {
            const { overdueMonths, waitingMonths } = financials;
            if (overdueMonths === 0 && waitingMonths === 0) return { bg: 'bg-gradient-to-r from-green-500 to-green-600', border: 'border-green-600', text: 'text-white', statusText: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', icon: <CheckCircle size={20} className="text-white" /> };
            if (overdueMonths > 6) return { bg: 'bg-gradient-to-r from-red-800 to-red-900', border: 'border-red-900', text: 'text-white', statusText: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', icon: <ShieldAlert size={20} className="text-white" /> };
            if (overdueMonths >= 3) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', border: 'border-red-600', text: 'text-white', statusText: '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ', icon: <Mail size={20} className="text-white" /> };
            let statusText = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            let icon = <AlertTriangle size={20} className="text-slate-900" />;
            if (overdueMonths === 0 && waitingMonths > 0) { statusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; icon = <HelpCircle size={20} className="text-slate-900" />; }
            return { bg: 'bg-gradient-to-r from-yellow-400 to-yellow-500', border: 'border-yellow-500', text: 'text-slate-900', statusText: statusText, icon: icon };
        };

        const getYearBadgeStyle = (year) => {
            const y = parseInt(year);
            if (y === 2025 || y === 2568) return "bg-indigo-600 text-white shadow-lg shadow-indigo-500/40 border-indigo-400";
            if (y === 2024 || y === 2567) return "bg-emerald-600 text-white shadow-lg shadow-emerald-500/40 border-emerald-400";
            if (y === 2023 || y === 2566) return "bg-rose-500 text-white shadow-lg shadow-rose-500/40 border-rose-400";
            if (y === 2022 || y === 2565) return "bg-amber-500 text-white shadow-lg shadow-amber-500/40 border-amber-400";
            return "bg-slate-600 text-white shadow-lg shadow-slate-500/40 border-slate-500";
        };

        const getHistoryStatusBadge = (status) => {
            if (!status) return <span className="text-gray-400">-</span>;
            if (status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á') || status.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')) return <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200 flex items-center gap-1"><CheckCircle size={10}/> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>;
            if (status.includes('‡∏£‡∏≠') || status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200 flex items-center gap-1"><Clock size={10}/> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>;
            if (status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) return <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200 flex items-center gap-1"><X size={10}/> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>;
            return <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-200">{status}</span>;
        };
        const getHistoryCardHeaderStyle = (status) => {
            if (!status) return { bg: 'bg-gradient-to-r from-slate-50 to-white', text: 'text-slate-700', iconColor: 'text-indigo-600', iconBg: 'bg-indigo-100', border: 'border-slate-100' };
            if (status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á') || status.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')) return { bg: 'bg-gradient-to-r from-emerald-500 to-green-600', text: 'text-white', iconColor: 'text-emerald-600', iconBg: 'bg-white', border: 'border-emerald-600' };
            if (status.includes('‡∏£‡∏≠') || status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return { bg: 'bg-gradient-to-r from-amber-400 to-orange-500', text: 'text-white', iconColor: 'text-amber-600', iconBg: 'bg-white', border: 'border-amber-500' };
            if (status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', text: 'text-white', iconColor: 'text-red-600', iconBg: 'bg-white', border: 'border-red-600' };
            return { bg: 'bg-gradient-to-r from-slate-50 to-white', text: 'text-slate-700', iconColor: 'text-indigo-600', iconBg: 'bg-indigo-100', border: 'border-slate-100' };
        };
        const getHistoryHeaderBadge = (status) => {
            const textClass = status?.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || status?.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') ? 'text-emerald-700' : status?.includes('‡∏£‡∏≠') ? 'text-amber-700' : status?.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status?.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') ? 'text-red-700' : 'text-slate-700';
            return <span className={`bg-white ${textClass} px-2 py-0.5 rounded text-[10px] font-bold shadow-sm flex items-center gap-1 whitespace-nowrap`}>{status || '-'}</span>;
        };

        // --- Sub-components ---
        const DetailRow = ({ label, value, icon: Icon, color = "text-slate-700" }) => (
            <div className="flex flex-col">
                <span className="text-[10px] text-slate-400 mb-0.5 flex items-center gap-1">{Icon && <Icon size={10} />} {label}</span>
                <span className={`text-xs font-semibold ${color} truncate`}>{value || '-'}</span>
            </div>
        );

        const SummaryChart = ({ financials }) => {
            const total = financials.totalMonths || 12;
            const paidPct = (financials.counts.paid / total) * 100;
            const overduePct = (financials.counts.overdue / total) * 100;
            const waitingPct = (financials.counts.waiting / total) * 100;
            const gradient = `conic-gradient(#22c55e 0% ${paidPct}%, #ef4444 ${paidPct}% ${paidPct + overduePct}%, #eab308 ${paidPct + overduePct}% ${paidPct + overduePct + waitingPct}%, #f3f4f6 ${paidPct + overduePct + waitingPct}% 100%)`;
            return (
                <div className="flex items-center gap-4 bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4">
                    <div className="relative w-16 h-16 rounded-full shrink-0 shadow-inner" style={{ background: gradient }}>
                        <div className="absolute inset-2 bg-white rounded-full flex items-center justify-center">
                            <span className="text-xs font-bold text-slate-600">{Math.round(paidPct)}%</span>
                        </div>
                    </div>
                    <div className="flex-1 grid grid-cols-2 gap-2 text-xs">
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-green-500"></div><span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß {financials.counts.paid}</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-500"></div><span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ {financials.counts.overdue}</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-yellow-500"></div><span>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {financials.counts.waiting}</span></div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ supabase }) => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [yearFilter, setYearFilter] = useState('all');
            const [monthFilter, setMonthFilter] = useState('all');

            useEffect(() => {
                const fetchAllData = async () => {
                    if (!supabase) return;
                    setLoading(true);
                    try {
                        const { data, error } = await supabase.from('house_payments').select('*');
                        if (error) throw error;
                        setRawData(data);
                        setYearFilter('all');
                    } catch (err) { console.error("Dashboard Error:", err); } 
                    finally { setLoading(false); }
                };
                fetchAllData();
            }, [supabase]);

            const stats = useMemo(() => {
                if (!rawData.length) return null;

                const filteredData = yearFilter === 'all' 
                    ? rawData 
                    : rawData.filter(item => String(item.year) === yearFilter);

                const totalHouses = filteredData.length;
                let totalPaidAmount = 0, totalUnpaidAmount = 0, totalWaitingAmount = 0;
                const RATE = 300;
                
                const monthlyChartStats = months.map(m => ({ ...m, paid: 0, unpaid: 0, waiting: 0 }));
                const overdueMap = {};
                const soiOverdueMap = {}; 

                filteredData.forEach(item => {
                    let itemOverdueCount = 0; 
                    let itemOverdueAmount = 0;

                    months.forEach((m, idx) => {
                        const status = item[m.key] || '';
                        
                        if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                            monthlyChartStats[idx].paid++;
                        } else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) {
                            monthlyChartStats[idx].unpaid++;
                        } else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                            monthlyChartStats[idx].waiting++;
                        }

                        const isTargetMonth = monthFilter === 'all' || m.key === monthFilter;
                        if (isTargetMonth) {
                            if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                                totalPaidAmount += RATE;
                            } else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) {
                                totalUnpaidAmount += RATE;
                                itemOverdueCount++;
                                itemOverdueAmount += RATE;
                            } else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
                                totalWaitingAmount += RATE;
                            }
                        }
                    });

                    if (itemOverdueCount > 0) {
                        if (!overdueMap[item.house_numbe]) {
                            overdueMap[item.house_numbe] = { 
                                houseNo: item.house_numbe, 
                                totalMonths: 0, 
                                totalAmount: 0 
                            };
                        }
                        overdueMap[item.house_numbe].totalMonths += itemOverdueCount;
                        overdueMap[item.house_numbe].totalAmount += (itemOverdueCount * RATE);
                    }

                    if (itemOverdueAmount > 0) {
                        const soiName = item.soi ? item.soi.trim() : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ã‡∏≠‡∏¢';
                        if (!soiOverdueMap[soiName]) {
                            soiOverdueMap[soiName] = 0;
                        }
                        soiOverdueMap[soiName] += itemOverdueAmount;
                    }
                });

                const totalExpected = totalPaidAmount + totalUnpaidAmount + totalWaitingAmount;
                const paidPercentage = totalExpected > 0 ? (totalPaidAmount / totalExpected) * 100 : 0;
                const overdueList = Object.values(overdueMap).sort((a, b) => b.totalAmount - a.totalAmount);
                const soiList = Object.entries(soiOverdueMap)
                    .map(([name, amount]) => ({ name, amount }))
                    .sort((a, b) => b.amount - a.amount);

                return { 
                    totalHouses, totalPaidAmount, totalUnpaidAmount, totalWaitingAmount, 
                    paidPercentage, monthlyChartStats, overdueList, soiList 
                };
            }, [rawData, yearFilter, monthFilter]);

            const availableYears = useMemo(() => [...new Set(rawData.map(d => d.year))].sort((a,b) => b-a), [rawData]);

            if (loading) return <div className="flex flex-col items-center justify-center py-20 text-white"><Loader2 size={48} className="animate-spin mb-4" /><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°...</p></div>;
            if (!stats) return <div className="text-center py-20 text-white"><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>;

            return (
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-up">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-bold text-white mb-2 drop-shadow-md flex items-center justify-center gap-3"><LayoutDashboard size={32} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
                        <p className="text-indigo-100">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    </div>

                    <div className="bg-white/10 backdrop-blur-md p-4 rounded-2xl mb-8 flex flex-col md:flex-row gap-4 items-center justify-center border border-white/20 shadow-lg">
                        <div className="flex items-center gap-2 text-white font-medium"><Filter size={20} /> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</div>
                        
                        <div className="flex gap-4">
                            <select 
                                value={yearFilter} 
                                onChange={(e) => setYearFilter(e.target.value)}
                                className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400"
                            >
                                <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                                {availableYears.map(y => <option key={y} value={y}>‡∏õ‡∏µ {y}</option>)}
                            </select>

                            <select 
                                value={monthFilter} 
                                onChange={(e) => setMonthFilter(e.target.value)}
                                className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400"
                            >
                                <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                {months.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-white rounded-2xl p-6 shadow-lg border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Coins size={80} className="text-green-600" /></div>
                            <span className="text-slate-500 text-sm font-medium mb-1">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)</span>
                            <h3 className="text-3xl font-bold text-green-600">{stats.totalPaidAmount.toLocaleString()}</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-green-100 text-green-700 rounded-lg">{stats.paidPercentage.toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div className="bg-white rounded-2xl p-6 shadow-lg border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><AlertCircle size={80} className="text-red-600" /></div>
                            <span className="text-slate-500 text-sm font-medium mb-1">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)</span>
                            <h3 className="text-3xl font-bold text-red-500">{stats.totalUnpaidAmount.toLocaleString()}</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-red-100 text-red-700 rounded-lg">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                        </div>
                        <div className="bg-white rounded-2xl p-6 shadow-lg border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Home size={80} className="text-blue-600" /></div>
                            <span className="text-slate-500 text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡πâ‡∏≤‡∏ô (‡∏õ‡∏µ {yearFilter === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : yearFilter})</span>
                            <h3 className="text-3xl font-bold text-slate-800">{stats.totalHouses} ‡∏´‡∏•‡∏±‡∏á</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded-lg">‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 mb-8">
                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <MapPin className="text-orange-500" /> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ã‡∏≠‡∏¢
                        </h3>
                        {stats.soiList.length > 0 ? (
                            <div className="space-y-4">
                                {stats.soiList.map((soi, index) => {
                                    const maxAmount = stats.soiList[0].amount;
                                    const percentage = (soi.amount / maxAmount) * 100;
                                    return (
                                        <div key={index} className="flex items-center gap-4">
                                            <div className="w-20 text-sm font-bold text-slate-600 shrink-0">{soi.name}</div>
                                            <div className="flex-1 h-4 bg-slate-100 rounded-full overflow-hidden relative">
                                                <div 
                                                    className="h-full bg-gradient-to-r from-orange-400 to-red-500 rounded-full relative"
                                                    style={{ width: `${percentage}%` }}
                                                ></div>
                                            </div>
                                            <div className="w-24 text-right text-sm font-bold text-red-600 shrink-0">‡∏ø{soi.amount.toLocaleString()}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center py-8 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                        )}
                    </div>
                    
                    <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 mb-8">
                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><BarChart3 className="text-indigo-500" /> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏µ {yearFilter === 'all' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : yearFilter})</h3>
                        <div className="h-64 flex items-end justify-between gap-2 md:gap-4 overflow-x-auto pb-2">
                            {stats.monthlyChartStats.map((m, idx) => {
                                const paidHeight = (m.paid / (stats.totalHouses || 1)) * 100;
                                const unpaidHeight = (m.unpaid / (stats.totalHouses || 1)) * 100;
                                return (
                                    <div key={idx} className="flex flex-col items-center gap-2 h-full justify-end flex-1 min-w-[40px]">
                                        <div className="w-full bg-slate-100 rounded-t-lg relative flex flex-col justify-end overflow-hidden h-full">
                                            <div className="bg-red-400 w-full transition-all duration-1000 ease-out hover:bg-red-500 relative group" style={{ height: `${unpaidHeight}%` }}><div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none z-10">‡∏Ñ‡πâ‡∏≤‡∏á {m.unpaid}</div></div>
                                            <div className="bg-green-500 w-full transition-all duration-1000 ease-out hover:bg-green-600 relative group" style={{ height: `${paidHeight}%` }}><div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none z-10">‡∏à‡πà‡∏≤‡∏¢ {m.paid}</div></div>
                                        </div>
                                        <span className="text-xs font-bold text-slate-500">{m.label}</span>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="flex justify-center gap-4 mt-6 text-xs font-medium text-slate-600">
                            <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-green-500 rounded-sm"></div> ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                            <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-red-400 rounded-sm"></div> ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100">
                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <FileWarning className="text-red-500" /> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ({stats.overdueList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                        </h3>
                        <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="px-4 py-3 rounded-tl-lg">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                        <th className="px-4 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                        <th className="px-4 py-3 text-right rounded-tr-lg">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {stats.overdueList.length > 0 ? (
                                        stats.overdueList.map((house, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-4 py-3 font-medium text-slate-800 flex items-center gap-2">
                                                    <Home size={16} className="text-slate-400" /> {house.houseNo}
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className="bg-red-100 text-red-700 px-2 py-1 rounded-md text-xs font-bold">
                                                        {house.totalMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right font-bold text-red-600">
                                                    ‡∏ø{house.totalAmount.toLocaleString()}
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan="3" className="px-4 py-8 text-center text-slate-400">
                                                <div className="flex flex-col items-center gap-2">
                                                    <CheckCircle size={32} className="text-green-400" />
                                                    <span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</span>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const HomeContent = ({ payments, loading, error, supabase, openDetailModal, handleSyncStatus, handlePrint, toggleNameVisibility, visibleNames, syncingId, allPendingFees }) => {
            if (!supabase) return <div className="text-center py-20 no-print"><div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div><p className="text-white/80 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>;
            if (loading) return <div className="text-center py-20 flex flex-col items-center no-print"><div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div><p className="text-white/80 animate-pulse font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p></div>;
            if (error) return <div className="max-w-md mx-auto bg-red-500/10 backdrop-blur border border-red-500/30 p-4 rounded-xl text-center text-white no-print"><AlertCircle className="mx-auto mb-2 text-red-300" size={32} /><p>{error}</p></div>;
            
            if (payments.length === 0) {
                return (
                    <div className="py-12 px-4 no-print animate-fade-up">
                        <div className="max-w-4xl mx-auto bg-white/10 backdrop-blur-lg rounded-3xl border border-white/20 p-8 md:p-12 shadow-2xl">
                            <div className="text-center mb-12">
                                <div className="bg-indigo-500/20 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_15px_rgba(99,102,241,0.5)] border border-indigo-400/30"><Home className="text-white w-12 h-12" /></div>
                                <h3 className="text-3xl font-bold text-white mb-4 drop-shadow-lg">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                                <p className="text-indigo-100 text-lg max-w-2xl mx-auto font-light">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á<br className="hidden md:block"/>‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50"><div className="bg-blue-100 p-3.5 rounded-xl text-blue-600 shadow-inner"><Search size={28} /></div><div><h4 className="font-bold text-slate-800 text-xl mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</h4><p className="text-slate-600 text-sm">‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p></div></div>
                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50"><div className="bg-green-100 p-3.5 rounded-xl text-green-600 shadow-inner"><RefreshCw size={28} /></div><div><h4 className="font-bold text-slate-800 text-xl mb-1">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h4><p className="text-slate-600 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</p></div></div>
                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50"><div className="bg-orange-100 p-3.5 rounded-xl text-orange-600 shadow-inner"><AlertTriangle size={28} /></div><div><h4 className="font-bold text-slate-800 text-xl mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h4><p className="text-slate-600 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p></div></div>
                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50"><div className="bg-purple-100 p-3.5 rounded-xl text-purple-600 shadow-inner"><FileText size={28} /></div><div><h4 className="font-bold text-slate-800 text-xl mb-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</h4><p className="text-slate-600 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
                            </div>
                            <div className="mt-10 text-center"><span className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/20 text-white text-sm font-medium backdrop-blur border border-white/30 animate-pulse"><Sparkles size={16} /> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</span></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    {payments.map((item, index) => {
                        const financials = calculateFinancials(item);
                        const headerStyle = getHeaderStyle(financials);
                        const itemKey = getItemKey(item);
                        const isNameVisible = visibleNames[itemKey];
                        const isSyncing = syncingId === itemKey;
                        const housePendingFees = allPendingFees.filter(f => (f.house_number || '').trim() === (item.house_numbe || '').trim());
                        const pendingTotal = housePendingFees.reduce((sum, f) => sum + (f.amount || 0), 0);
                        const yearBadgeStyle = getYearBadgeStyle(item.year);

                        return (
                            <div key={itemKey} className="bg-white rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 flex flex-col print-container animate-fade-up" style={{ animationDelay: `${index * 100}ms` }}>
                                <div className={`${headerStyle.bg} px-5 py-4 border-b ${headerStyle.border} flex justify-between items-start transition-colors duration-300`}>
                                    <div><h3 className={`text-2xl font-bold flex items-center gap-2 ${headerStyle.text}`}><Home className={headerStyle.text} size={24} /> {item.house_numbe}</h3>
                                    <div className={`text-base mt-2 font-bold px-4 py-1.5 rounded-full w-fit backdrop-blur-md border border-white/30 shadow-md ${yearBadgeStyle}`}>
                                        ‡∏õ‡∏µ {item.year}
                                    </div>
                                    </div>
                                    <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg whitespace-nowrap bg-white text-slate-800`}>{React.cloneElement(headerStyle.icon, { className: 'text-slate-700' })} <span className="text-slate-700">{headerStyle.statusText}</span></div>
                                </div>
                                <div className="p-5 bg-white flex-1 flex flex-col">
                                    {housePendingFees.length > 0 && (
                                        <div onClick={() => openDetailModal(item)} className="mb-5 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-3 flex items-start justify-between shadow-sm animate-pulse cursor-pointer hover:bg-orange-100 transition-colors no-print" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                            <div className="flex items-start gap-3"><div className="bg-white p-2 rounded-full shadow-sm text-orange-500 mt-1"><Bell size={20} /></div><div><h5 className="text-sm font-bold text-orange-800 mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5><div className="flex flex-wrap gap-1">{housePendingFees.map((fee, idx) => (<span key={idx} className="text-[10px] bg-white/80 px-2 py-0.5 rounded text-orange-700 border border-orange-100 font-medium">{fee.month} {fee.year}</span>))}</div></div></div>
                                            <div className="text-right pl-2 whitespace-nowrap"><span className="text-[10px] text-orange-600 font-semibold block">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><h4 className="text-lg font-bold text-orange-800">‡∏ø{pendingTotal.toLocaleString()}</h4></div>
                                        </div>
                                    )}
                                    <SummaryChart financials={financials} />
                                    <div className="mb-5 pb-4 border-b border-slate-100 space-y-2">
                                        <div className="flex items-center justify-between gap-2 font-bold text-lg text-slate-800"><div className="flex items-center gap-2"><User size={18} className="text-blue-500" /><span>{isNameVisible ? item.owner_name : maskName(item.owner_name)}</span></div><button onClick={() => toggleNameVisibility(itemKey)} className="text-slate-400 hover:text-blue-600 transition-colors p-1 rounded-full hover:bg-blue-50 no-print" title={isNameVisible ? "‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠" : "‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°"}>{isNameVisible ? <EyeOff size={18} /> : <Eye size={18} />}</button></div>
                                        <div className="grid grid-cols-1 gap-1.5 text-sm">
                                            <div className="flex justify-between items-center"><span className="text-slate-500">üè† ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà :</span><span className="font-medium text-slate-700">{item.house_numbe}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500">üìç ‡∏ã‡∏≠‡∏¢ :</span><span className="font-medium text-slate-700">{item.soi || '-'}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500">üìÖ ‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô :</span><span className="font-medium text-slate-700">{item.transfer_date || '-'}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô :</span><span className={`font-medium text-slate-700`}>{item.status || '-'}</span></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mb-4 no-print"><button onClick={() => openDetailModal(item)} className="flex-1 py-2.5 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 font-bold text-sm flex items-center justify-center gap-2 transition-colors duration-200 border border-indigo-100 shadow-sm"><FileText size={18} /><span>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</span></button><button onClick={handlePrint} className="flex-none px-4 py-2.5 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold text-sm flex items-center justify-center gap-2 transition-colors border border-slate-200" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"><Printer size={18} /></button></div>
                                    <div className="mb-3 font-bold text-slate-700 flex items-center justify-between">
                                        <div className="flex items-center gap-2"><Clock size={16} className="text-blue-500" /> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ({item.year})</div>
                                        <button onClick={() => handleSyncStatus(item)} disabled={isSyncing} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition-all no-print ${isSyncing ? 'bg-gray-100 text-gray-400 cursor-wait' : 'bg-orange-500 text-white hover:bg-orange-600 shadow-sm hover:shadow-md'}`}><RefreshCw size={14} className={isSyncing ? 'animate-spin' : ''} /><span>{isSyncing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó' : '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó'}</span></button>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {months.map((month) => {
                                            const status = item[month.key];
                                            const colorClass = getStatusColor(status);
                                            return (<div key={month.key} className={`flex flex-col items-center justify-center p-2 rounded-lg border ${colorClass} min-h-[50px]`}><span className="text-[10px] font-bold uppercase opacity-60 mb-1">{month.label}</span><span className="text-[11px] font-semibold text-center leading-tight break-words w-full">{status || '-'}</span></div>);
                                        })}
                                    </div>
                                    <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 mb-0 mt-auto">
                                        <div className="flex items-center gap-1 text-xs font-bold text-slate-400 mb-2"><Coins size={12} />‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (300 ‡∏ö./‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
                                        <div className="flex justify-between items-center text-xs">
                                            <div className="flex flex-col items-center flex-1 border-r border-slate-200"><span className="text-green-600 font-bold text-sm">‡∏ø{financials.paid.toLocaleString()}</span><span className="text-slate-400">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span></div>
                                            <div className="flex flex-col items-center flex-1 border-r border-slate-200"><span className="text-red-500 font-bold text-sm">‡∏ø{financials.overdue.toLocaleString()}</span><span className="text-slate-400">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span></div>
                                            <div className="flex flex-col items-center flex-1"><span className="text-yellow-600 font-bold text-sm">‡∏ø{financials.waiting.toLocaleString()}</span><span className="text-slate-400">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [searchTerm, setSearchTerm] = useState('');
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [supabase, setSupabase] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showScrollTop, setShowScrollTop] = useState(false);
            
            const [allPendingFees, setAllPendingFees] = useState([]);
            const [visibleNames, setVisibleNames] = useState({});
            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [selectedHouse, setSelectedHouse] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            const [historyLoading, setHistoryLoading] = useState(false);
            const [pdfModalOpen, setPdfModalOpen] = useState(false);
            const [selectedPdfUrl, setSelectedPdfUrl] = useState(null);
            const [imageModalOpen, setImageModalOpen] = useState(false);
            const [selectedImageUrl, setSelectedImageUrl] = useState(null);
            const [syncingId, setSyncingId] = useState(null);
            const [isAutoSyncing, setIsAutoSyncing] = useState(false); 
            const [showThankYouModal, setShowThankYouModal] = useState(false);
            const [showOverdueModal, setShowOverdueModal] = useState(false);
            const [resultModal, setResultModal] = useState({ isOpen: false, type: 'success', message: '' });

            useEffect(() => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.async = true;
                script.onload = () => { if (window.supabase) setSupabase(window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)); };
                document.body.appendChild(script);
                const handleScroll = () => setShowScrollTop(window.scrollY > 300);
                window.addEventListener('scroll', handleScroll);
                return () => {
                    if (document.body.contains(script)) document.body.removeChild(script);
                    window.removeEventListener('scroll', handleScroll);
                };
            }, []);

            const sendTelegramNotification = async (houseNo, searchResults) => {
                try {
                    if (!searchResults || searchResults.length === 0) return;
                    let message = `üè† *‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤*\nüìç ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: *${houseNo}*\nüìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: *${searchResults.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£*\n\n`;
                    searchResults.forEach((item, index) => {
                        let paidCount = 0, overdueCount = 0, advanceCount = 0, waitingCount = 0; const RATE = 300;
                        const monthlyStatus = months.map(m => {
                            const status = item[m.key] || '';
                            let emoji = '‚ùì';
                            if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) { emoji = '‚úÖ'; paidCount++; }
                            else if (status.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) { emoji = 'üîÑ'; advanceCount++; }
                            else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) { emoji = '‚ùå'; overdueCount++; }
                            else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') || status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) { emoji = '‚è≥'; waitingCount++; }
                            else if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) { emoji = '‚≠ï'; }
                            return `${emoji} ${m.label}`;
                        }).join(' ');
                        const totalPaid = paidCount * RATE, totalUnpaid = overdueCount * RATE, totalAdvance = advanceCount * RATE;
                        let alertStatusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
                        if (overdueCount > 0) alertStatusText = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                        else if (waitingCount > 0) alertStatusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                        else if (paidCount > 0 || advanceCount > 0) alertStatusText = '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
                        message += `üìã *‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1} (‡∏õ‡∏µ ${item.year})*\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${item.owner_name || '-'}\nüèòÔ∏è ‡∏ã‡∏≠‡∏¢: ${item.soi || '-'}\nüìÖ ‡∏ß‡∏±‡∏ô‡πÇ‡∏≠‡∏ô: ${item.transfer_date || '-'}\nüìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${item.status || '-'}\n‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: *${alertStatusText}*\nüí∞ *‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:*\n‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${totalPaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${totalUnpaid.toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüîÑ ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ${totalAdvance.toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüìÖ *‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:*\n${monthlyStatus}\n`;
                        if (index < searchResults.length - 1) message += '\n' + '‚îÄ'.repeat(30) + '\n\n';
                    });
                    message += `\nüïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${new Date().toLocaleString('th-TH')}`;
                    await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: 'Markdown' }) });
                } catch (error) { console.error('Telegram Error:', error); }
            };

            const syncHouseLogic = async (item) => {
                if (!supabase) return false;
                try {
                    const { data: feeHistory, error: feeError } = await supabase.from('common_fees').select('*').eq('house_number', item.house_numbe).eq('year', item.year).order('reported_at', { ascending: true });
                    if (feeError) throw feeError;
                    if (feeHistory && feeHistory.length > 0) {
                        let updates = {}, hasUpdates = false;
                        feeHistory.forEach(fee => {
                            const monthCol = monthMap[fee.month];
                            if (monthCol) {
                                const currentStatus = item[monthCol];
                                const isPending = (fee.status.includes('‡∏£‡∏≠') || fee.status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') || fee.status.includes('‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô')) && !fee.status.includes('‡πÅ‡∏•‡πâ‡∏ß');
                                const isPaid = fee.status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') || fee.status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || fee.status.includes('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                                if (isPending && currentStatus !== '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { updates[monthCol] = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; hasUpdates = true; }
                                else if (isPaid && currentStatus !== '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') { updates[monthCol] = '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'; hasUpdates = true; }
                            }
                        });
                        if (hasUpdates) { await supabase.from('house_payments').update(updates).eq('house_numbe', item.house_numbe).eq('year', item.year); return true; }
                    }
                    return false;
                } catch (err) { console.error(err); return false; }
            };

            const fetchPayments = async (search = '', autoSync = false) => {
                if (!supabase) return [];
                setLoading(true);
                try {
                    let query = supabase.from('house_payments').select('*');
                    if (search) query = query.or(`house_numbe.ilike.%${search}%,owner_name.ilike.%${search}%`);
                    const { data, error } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });
                    if (error) throw error;
                    let finalData = data || [];
                    if (search) {
                        const lowerSearch = search.trim().toLowerCase();
                        const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
                        if (exactMatches.length > 0) finalData = exactMatches;
                    }
                    if (autoSync && finalData.length > 0) {
                        const syncPromises = finalData.map(async (item) => await syncHouseLogic(item));
                        const results = await Promise.all(syncPromises);
                        if (results.some(r => r === true)) {
                            const { data: refreshedData } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });
                            if (refreshedData) finalData = refreshedData;
                            if (search) {
                                const lowerSearch = search.trim().toLowerCase();
                                const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
                                if (exactMatches.length > 0) finalData = exactMatches;
                            }
                        }
                    }
                    setPayments(finalData);
                    return finalData;
                } catch (err) { setError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'); return []; } finally { setLoading(false); }
            };

            const fetchAllPendingFees = async () => {
                if (!supabase) return;
                const { data } = await supabase.from('common_fees').select('*').eq('status', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                setAllPendingFees(data || []);
            };

            const handleSyncStatus = async (item) => {
                const itemKey = getItemKey(item);
                setSyncingId(itemKey);
                try {
                    await syncHouseLogic(item);
                    await Promise.all([fetchPayments(searchTerm, false), fetchAllPendingFees()]);
                } catch (err) { 
                    setResultModal({ isOpen: true, type: 'error', message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' });
                } finally { setSyncingId(null); }
            };

            const fetchHistory = async (houseNumber) => {
                if (!supabase) return;
                setHistoryLoading(true);
                const { data } = await supabase.from('common_fees').select('*').eq('house_number', houseNumber).order('reported_at', { ascending: false });
                setHistoryData(data || []);
                setHistoryLoading(false);
            };

            // Handlers
            const openDetailModal = (item) => { setSelectedHouse(item); setDetailModalOpen(true); fetchHistory(item.house_numbe); };
            const closeDetailModal = () => { setDetailModalOpen(false); setSelectedHouse(null); setHistoryData([]); };
            const openPdfModal = (url) => { setSelectedPdfUrl(url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview')); setPdfModalOpen(true); };
            const closePdfModal = () => { setPdfModalOpen(false); setSelectedPdfUrl(null); };
            const openImageModal = (url) => { setSelectedImageUrl(url); setImageModalOpen(true); };
            const closeImageModal = () => { setImageModalOpen(false); setSelectedImageUrl(null); };
            const handlePrint = () => window.print();
            const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            const handleKeyDown = (e) => { if (e.key === 'Enter') handleSearchClick(); };
            const toggleNameVisibility = (key) => setVisibleNames(prev => ({ ...prev, [key]: !prev[key] }));

            const handleSearchClick = async () => {
                setLoading(true);
                const results = await fetchPayments(searchTerm, true);
                await fetchAllPendingFees();
                if (results && results.length > 0) {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonthIdx = now.getMonth(); 

                    const hasIssue = results.some(item => {
                        const itemYear = parseInt(item.year);
                        if (isNaN(itemYear)) return false;
                        const compareYear = itemYear > 2400 ? currentYear + 543 : currentYear;

                        return months.some((m, idx) => {
                            let shouldCheck = false;
                            if (itemYear < compareYear) shouldCheck = true;
                            else if (itemYear === compareYear) {
                                if (idx <= currentMonthIdx) shouldCheck = true;
                            }

                            if (shouldCheck) {
                                const status = item[m.key] || '';
                                return status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á') || status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                            }
                            return false;
                        });
                    });

                    if (hasIssue) { setShowOverdueModal(true); setTimeout(() => setShowOverdueModal(false), 3000); }
                    else { setShowThankYouModal(true); setTimeout(() => setShowThankYouModal(false), 3000); }
                }
                if (searchTerm.trim()) sendTelegramNotification(searchTerm, results);
            };

            return (
                <div className="min-h-screen text-slate-800">
                    <div className="fixed inset-0 -z-10 bg-gradient-to-br from-[#1e3c72] via-[#2a5298] via-[#667eea] via-[#764ba2] to-[#8e44ad]"></div>
                    <div className="fixed inset-0 -z-10 opacity-30 bg-[radial-gradient(circle_at_20%_80%,rgba(120,119,198,0.3),transparent_25%),radial-gradient(circle_at_80%_20%,rgba(255,255,255,0.2),transparent_25%)]"></div>

                    <nav className="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-lg text-white"><Home size={24} /></div><span className="text-white text-xl font-bold tracking-wide">üè° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span></div>
                                <div className="hidden md:flex gap-4">
                                    <button onClick={() => setCurrentPage('home')} className={`px-4 py-2 rounded-full font-medium transition-all ${currentPage === 'home' ? 'bg-white text-indigo-600 shadow-md' : 'text-white/80 hover:bg-white/10'}`}><div className="flex items-center gap-2"><Search size={18} /> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div></button>
                                    <button onClick={() => setCurrentPage('dashboard')} className={`px-4 py-2 rounded-full font-medium transition-all ${currentPage === 'dashboard' ? 'bg-white text-indigo-600 shadow-md' : 'text-white/80 hover:bg-white/10'}`}><div className="flex items-center gap-2"><LayoutDashboard size={18} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div></button>
                                </div>
                                <div className="md:hidden"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-white p-2 hover:bg-white/10 rounded-lg">{isMenuOpen ? <X size={24} /> : <Menu size={24} />}</button></div>
                            </div>
                        </div>
                        {isMenuOpen && (
                            <div className="md:hidden px-4 pb-4 animate-in slide-in-from-top-2">
                                <div className="flex flex-col gap-2 mb-4 bg-white/10 p-2 rounded-xl backdrop-blur-sm">
                                    <button onClick={() => { setCurrentPage('home'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium flex items-center gap-3 ${currentPage === 'home' ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'}`}><Search size={20} /> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                    <button onClick={() => { setCurrentPage('dashboard'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium flex items-center gap-3 ${currentPage === 'dashboard' ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'}`}><LayoutDashboard size={20} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
                                </div>
                                {currentPage === 'home' && (
                                    <div className="flex gap-2"><div className="relative flex-1"><input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 998/1)" className="w-full pl-10 pr-4 py-2 bg-white/90 rounded-lg text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={handleKeyDown} /><Search className="absolute left-3 top-2.5 text-slate-400" size={18} /></div><button onClick={handleSearchClick} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2">{isAutoSyncing ? <Loader2 size={18} className="animate-spin"/> : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}</button></div>
                                )}
                            </div>
                        )}
                    </nav>

                    <main>
                        {currentPage === 'dashboard' ? (
                            <Dashboard supabase={supabase} />
                        ) : (
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                                <div className="max-w-3xl mx-auto mb-10 text-center no-print">
                                    <h2 className="text-2xl md:text-4xl font-bold text-white mb-2 drop-shadow-md">üè° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>
                                    <p className="text-indigo-100 text-lg mb-4 font-medium drop-shadow-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢</p>
                                    <div className="mb-8 text-indigo-200 text-sm space-y-1"><p>‚úÖ 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p><p>‚úÖ 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p></div>
                                    <div className="flex flex-col sm:flex-row gap-3 items-stretch justify-center">
                                        <div className="relative group flex-1"><div className="absolute -inset-1 bg-gradient-to-r from-blue-400 to-purple-400 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-200"></div><div className="relative h-full"><input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 998/1)" className="w-full h-full pl-12 pr-4 py-4 bg-white/95 backdrop-blur rounded-xl text-lg text-slate-900 placeholder-slate-400 shadow-xl focus:outline-none focus:ring-2 focus:ring-white/50" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={handleKeyDown} /><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={24} /></div></div>
                                        <button onClick={handleSearchClick} disabled={loading} className="bg-white/90 hover:bg-white text-indigo-600 font-bold px-8 py-4 sm:py-0 rounded-xl shadow-xl transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 backdrop-blur-sm border border-white/50 disabled:opacity-80 disabled:cursor-not-allowed">{isAutoSyncing ? <Loader2 size={24} className="animate-spin text-indigo-600" /> : <Search size={22} />}<span className="text-lg">{isAutoSyncing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}</span></button>
                                    </div>
                                </div>
                                <HomeContent 
                                    payments={payments} loading={loading} error={error} supabase={supabase}
                                    openDetailModal={openDetailModal} handleSyncStatus={handleSyncStatus} 
                                    handlePrint={handlePrint} toggleNameVisibility={toggleNameVisibility} 
                                    visibleNames={visibleNames} syncingId={syncingId} allPendingFees={allPendingFees} 
                                />
                            </div>
                        )}
                    </main>

                    {showScrollTop && <button onClick={scrollToTop} className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all animate-fade-up z-50 no-print" aria-label="Scroll to top"><ArrowUp size={24} /></button>}
                    
                    {/* --- ALL MODALS --- */}
                    {showThankYouModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-300 no-print"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div className="relative bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 animate-pop-in border-4 border-green-100"><div className="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-green-100 mb-6 shadow-inner"><ThumbsUp className="h-14 w-14 text-green-600" /></div><h3 className="text-2xl font-extrabold text-gray-900 mb-2">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞!</h3><p className="text-gray-600 text-lg">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p><p className="text-sm text-green-600 mt-4 font-bold flex items-center justify-center gap-1"><Home size={14}/> ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</p></div></div>
                    )}
                    {showOverdueModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-300 no-print"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div className="relative bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 animate-pop-in border-4 border-red-100"><div className="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-red-100 mb-6 shadow-inner"><AlertTriangle className="h-14 w-14 text-red-600" /></div><h3 className="text-2xl font-extrabold text-gray-900 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3><p className="text-gray-600 text-lg">‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p><p className="text-sm text-red-600 mt-4 font-bold flex items-center justify-center gap-1"><Home size={14}/> ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</p></div></div>
                    )}
                    {detailModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 no-print">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={closeDetailModal}></div>
                            <div className="relative bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col animate-in fade-in zoom-in-95 duration-200">
                                <div className="bg-gradient-to-r from-indigo-600 to-violet-600 px-6 py-4 flex justify-between items-center shrink-0 shadow-md"><div className="text-white"><h3 className="text-xl font-bold flex items-center gap-2"><Receipt className="text-indigo-200" /> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</h3><p className="text-indigo-100 text-sm opacity-90 mt-1 flex items-center gap-1"><Home size={14} /> ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà {selectedHouse?.house_numbe}</p></div><button onClick={closeDetailModal} className="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition-colors"><X size={24} /></button></div>
                                <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                                    {historyLoading ? <div className="flex flex-col items-center justify-center py-12 text-slate-400"><div className="animate-spin rounded-full h-10 w-10 border-4 border-indigo-200 border-t-indigo-600 mb-4"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div> : historyData.length === 0 ? <div className="flex flex-col items-center justify-center py-16 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-white"><FileText size={48} className="mb-4 opacity-20" /><p className="text-lg font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</p><p className="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö common_fees</p></div> : (
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2 text-sm font-bold text-slate-500 mb-2 px-1"><FileText size={16} /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({historyData.length})</div>
                                            {historyData.map((record, idx) => {
                                                const headerStyle = getHistoryCardHeaderStyle(record.status);
                                                return (
                                                    <div key={record.id || idx} className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 group">
                                                        <div className={`${headerStyle.bg} px-4 py-3 border-b ${headerStyle.border} flex justify-between items-center`}><div className="flex items-center gap-2"><div className={`${headerStyle.iconBg} p-1.5 rounded-lg ${headerStyle.iconColor}`}><Calendar size={16} /></div><span className={`font-bold text-base ${headerStyle.text}`}>{record.month} {record.year}</span></div>{getHistoryHeaderBadge(record.status)}</div>
                                                        {record.image_url ? (<div className="relative h-48 sm:h-64 w-full bg-slate-100 border-b border-slate-100 group cursor-pointer" onClick={() => openImageModal(record.image_url)}><img src={record.image_url} alt="Payment Slip" className="w-full h-full object-cover" loading="lazy" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100"><span className="bg-black/50 text-white px-3 py-1.5 rounded-full text-sm font-medium backdrop-blur-sm flex items-center gap-2"><ZoomIn size={16} /> ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span></div><button className="absolute bottom-3 right-3 bg-white/90 backdrop-blur-sm text-slate-700 hover:text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold shadow-md flex items-center gap-1.5 hover:bg-white transition-all transform hover:scale-105" onClick={(e) => { e.stopPropagation(); openImageModal(record.image_url); }}><ImageIcon size={16} /> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°</button></div>) : (<div className="h-32 bg-slate-50 flex flex-col items-center justify-center text-slate-300 border-b border-slate-100"><ImageIcon size={32} className="mb-2 opacity-50" /><span className="text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</span></div>)}
                                                        <div className="p-4">
                                                            <div className="flex justify-between items-end mb-4 pb-4 border-b border-slate-100 border-dashed"><div><span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><h4 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-600">‡∏ø{(record.amount || 0).toLocaleString()}</h4></div><div className="text-right"><span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</span><div className="text-xs font-medium text-slate-600 bg-slate-50 px-2 py-1 rounded border border-slate-100 flex items-center gap-1"><Clock size={10} />{record.reported_at ? new Date(record.reported_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' }) : '-'}</div></div></div>
                                                            <div className="grid grid-cols-2 gap-x-4 gap-y-3 bg-slate-50 p-3 rounded-xl border border-slate-100 mb-3"><DetailRow label="ID" value={record.id} icon={Hash} color="text-indigo-600" /><DetailRow label="UID" value={record.user_id ? maskName(record.user_id) : '-'} icon={Fingerprint} /><DetailRow label="‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" value={record.name} icon={User} color="text-blue-600" /><DetailRow label="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" value={record.house_number} icon={Home} color="text-orange-600" /><DetailRow label="‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢" value={record.payment_method} icon={Banknote} color="text-emerald-600" /><DetailRow label="‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" value={record.amount_text} icon={Type} /><div className="col-span-2 pt-2 mt-1 border-t border-slate-200 grid grid-cols-2 gap-4"><DetailRow label="‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" value={record.inspector} icon={UserCheck} color="text-purple-600" /><DetailRow label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" value={record.inspected_at ? new Date(record.inspected_at).toLocaleDateString('th-TH') : '-'} icon={CalendarCheck} color="text-teal-600" /></div></div>
                                                            {record.remark && (<div className="mb-3 bg-amber-50 border border-amber-100 rounded-lg p-2.5 flex gap-2 items-start"><MessageSquare size={14} className="text-amber-500 mt-0.5 shrink-0" /><div><span className="text-[10px] font-bold text-amber-700 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span><p className="text-xs text-amber-900 leading-relaxed">{record.remark}</p></div></div>)}
                                                            {record.pdf_url && (<button onClick={() => openPdfModal(record.pdf_url)} className="w-full flex items-center justify-center gap-2 text-blue-600 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-lg text-xs font-bold transition-all border border-blue-200"><FileText size={14} /> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF</button>)}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white p-4 border-t border-slate-100 text-center text-xs text-slate-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á common_fees</div>
                            </div>
                        </div>
                    )}
                    {pdfModalOpen && selectedPdfUrl && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 no-print"><div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onClick={closePdfModal}></div><div className="relative bg-white rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl animate-in fade-in zoom-in-95 duration-200"><div className="flex justify-between items-center p-4 border-b border-slate-200 bg-slate-50 rounded-t-2xl"><h3 className="font-bold text-slate-800 flex items-center gap-2"><FileText className="text-red-500" /> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF</h3><div className="flex items-center gap-2"><a href={selectedPdfUrl.replace('/preview', '/view')} target="_blank" rel="noreferrer" className="text-slate-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà"><ExternalLink size={20} /></a><button onClick={closePdfModal} className="text-slate-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50"><X size={24} /></button></div></div><div className="flex-1 bg-slate-100 relative"><iframe src={selectedPdfUrl} className="w-full h-full" title="PDF Preview" allow="autoplay"></iframe></div></div></div>
                    )}
                    {imageModalOpen && selectedImageUrl && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 no-print" onClick={closeImageModal}><div className="absolute inset-0 bg-black/90 backdrop-blur-sm"></div><div className="relative w-full max-w-4xl h-full max-h-[90vh] flex flex-col items-center justify-center animate-in fade-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}><button onClick={closeImageModal} className="absolute -top-12 right-0 text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"><X size={32} /></button><img src={selectedImageUrl} alt="Full Slip" className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" /><div className="absolute -bottom-12 left-0 right-0 flex justify-center gap-4"><a href={selectedImageUrl} target="_blank" rel="noreferrer" className="text-white/80 hover:text-white text-sm flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full hover:bg-white/20 transition-colors"><ExternalLink size={16} /> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a></div></div></div>
                    )}

                    {/* Result Alert Modal */}
                    {resultModal.isOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-200 no-print">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                            <div className={`relative bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-100 border-2 ${resultModal.type === 'success' ? 'border-green-100' : 'border-red-100'}`}>
                                <div className="text-center">
                                    <div className={`mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4 ${resultModal.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {resultModal.type === 'success' ? <CheckCircle size={32} /> : <AlertTriangle size={32} />}
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-2">{resultModal.type === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'}</h3>
                                    <p className="text-slate-500 text-sm mb-6">{resultModal.message}</p>
                                    <button 
                                        onClick={() => setResultModal(prev => ({ ...prev, isOpen: false }))}
                                        className={`px-6 py-2 rounded-lg font-medium shadow-md transition-colors text-white ${resultModal.type === 'success' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}
                                    >
                                        ‡∏ï‡∏Å‡∏•‡∏á
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="text-center py-6 text-white/60 text-sm no-print"><p>9one ¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á | ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</p></footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
