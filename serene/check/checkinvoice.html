<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á | ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0"
      }
    }
    </script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Animations */
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.5s ease-out forwards; }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }

        .cursor-wait { cursor: wait; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .print-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; margin-bottom: 20px; }
            .print-break-inside-avoid { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Home, User, Clock, CreditCard, Menu, X, Coins, CheckCircle, 
            AlertCircle, AlertTriangle, ShieldAlert, FileWarning, HelpCircle, Mail, 
            Eye, EyeOff, FileText, Receipt, Calendar, ChevronRight, Image as ImageIcon, 
            ExternalLink, UserCheck, Banknote, MessageSquare, Hash, Fingerprint, Type, 
            CalendarCheck, BadgeCheck, Bell, ZoomIn, RefreshCw, Loader2, Sparkles, ThumbsUp, Printer, ArrowUp,
            LayoutDashboard, BarChart3, Filter, CalendarCheck2, Info, MapPin, Hourglass, Settings, Lock, Save, Globe
        } from 'lucide-react';

        // --- Configuration ---
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ Environment Variable ‡πÉ‡∏ô Production ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Proxy Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á Key
        const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        
        // Telegram Configuration (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
        const TELEGRAM_TOKEN = '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo';
        const TELEGRAM_CHAT_ID = '7585120244';
        
        const ADMIN_PIN = '9999'; 

        // --- Constants & Helpers ---
        const monthMap = { '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 'jan', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 'feb', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 'mar', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 'apr', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 'may', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 'jun', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 'jul', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 'aug', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 'sep', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 'oct', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 'nov', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 'dec' };
        const months = [ 
            { key: 'jan', label: '‡∏°.‡∏Ñ.', full: '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°' }, { key: 'feb', label: '‡∏Å.‡∏û.', full: '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå' }, 
            { key: 'mar', label: '‡∏°‡∏µ.‡∏Ñ.', full: '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°' }, { key: 'apr', label: '‡πÄ‡∏°.‡∏¢.', full: '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô' }, 
            { key: 'may', label: '‡∏û.‡∏Ñ.', full: '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°' }, { key: 'jun', label: '‡∏°‡∏¥.‡∏¢.', full: '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô' }, 
            { key: 'jul', label: '‡∏Å.‡∏Ñ.', full: '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°' }, { key: 'aug', label: '‡∏™.‡∏Ñ.', full: '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°' }, 
            { key: 'sep', label: '‡∏Å.‡∏¢.', full: '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô' }, { key: 'oct', label: '‡∏ï.‡∏Ñ.', full: '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°' }, 
            { key: 'nov', label: '‡∏û.‡∏¢.', full: '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô' }, { key: 'dec', label: '‡∏ò.‡∏Ñ.', full: '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°' } 
        ];

        const getItemKey = (item) => `${item.house_numbe}-${item.year}`;

        const maskName = (fullName) => {
            if (!fullName || fullName.length <= 3) return fullName || '-';
            const prefixes = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á', '‡∏î‡∏£.', '‡∏®.', '‡∏£‡∏®.', '‡∏ú‡∏®.', '‡∏≠.', '‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ', '‡∏û‡∏•.‡∏ï.'];
            let prefix = ''; let nameWithoutPrefix = fullName;
            for (const p of prefixes) { if (fullName.startsWith(p)) { prefix = p; nameWithoutPrefix = fullName.substring(p.length).trim(); break; } }
            const nameParts = nameWithoutPrefix.split(/\s+/);
            if (nameParts.length === 0) return fullName;
            const firstName = nameParts[0];
            return (prefix ? prefix + ' ' : '') + firstName + ' xxxxxxx';
        };

        const getStatusColor = (status) => {
            if (!status) return 'bg-gray-50 text-gray-300 border-gray-100';
            const s = status.toLowerCase();
            if (s.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || s.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) return 'bg-emerald-100 text-emerald-700 border-emerald-200';
            if (s.includes('‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) return 'bg-sky-100 text-sky-700 border-sky-200';
            if (s.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || s.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) return 'bg-rose-100 text-rose-700 border-rose-200';
            if (s.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return 'bg-orange-100 text-orange-700 border-orange-200';
            if (s.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) return 'bg-amber-50 text-amber-600 border-amber-100';
            if (s.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return 'bg-gray-100 text-gray-400 border-gray-200';
            return 'bg-gray-50 text-gray-600 border-gray-200';
        };
        
        const calculateFinancials = (item) => {
            let paidCount = 0, overdueCount = 0, waitingCount = 0, futureCount = 0, totalMonths = 0;
            let headerOverdueCount = 0, headerWaitingCount = 0;
            const RATE = 300;
            
            const now = new Date();
            const currentYearAD = now.getFullYear();
            const currentMonthIdx = now.getMonth(); // 0-11
            
            const itemYear = parseInt(item.year);
            // Convert Thai year to AD for comparison if needed (assuming DB uses Thai years mostly)
            const isThaiYear = itemYear > 2400;
            const compareYearAD = isThaiYear ? itemYear - 543 : itemYear;

            months.forEach((month, idx) => {
                const status = item[month.key] || '';
                if (status.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö')) return;
                
                totalMonths++;
                if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) paidCount++;
                else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) overdueCount++;
                else if (status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) waitingCount++;
                else futureCount++; // Assume anything else (empty/null/‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) is future/unknown

                // Determine "Effective" status for header alert
                let isPastOrPresent = false;
                if (compareYearAD < currentYearAD) isPastOrPresent = true;
                else if (compareYearAD === currentYearAD && idx <= currentMonthIdx) isPastOrPresent = true;

                if (isPastOrPresent) {
                    if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) headerOverdueCount++;
                    else if (status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) headerWaitingCount++;
                }
            });
            return { paid: paidCount * RATE, overdue: overdueCount * RATE, waiting: waitingCount * RATE, future: futureCount * RATE, overdueMonths: headerOverdueCount, waitingMonths: headerWaitingCount, totalMonths: totalMonths, counts: { paid: paidCount, overdue: overdueCount, waiting: waitingCount, future: futureCount } };
        };

        const getHeaderStyle = (financials) => {
            const { overdueMonths, waitingMonths } = financials;
            if (overdueMonths === 0 && waitingMonths === 0) return { bg: 'bg-gradient-to-r from-emerald-500 to-green-600', border: 'border-green-600', text: 'text-white', statusText: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', icon: <CheckCircle size={20} className="text-white" /> };
            if (overdueMonths > 6) return { bg: 'bg-gradient-to-r from-red-800 to-red-900', border: 'border-red-900', text: 'text-white', statusText: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', icon: <ShieldAlert size={20} className="text-white" /> };
            if (overdueMonths >= 3) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', border: 'border-red-600', text: 'text-white', statusText: '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ', icon: <Mail size={20} className="text-white" /> };
            
            let statusText = overdueMonths > 0 ? `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô` : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥';
            let icon = <AlertTriangle size={20} className="text-slate-900" />;
            
            if (overdueMonths === 0 && waitingMonths > 0) { 
                statusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î'; 
                icon = <HelpCircle size={20} className="text-slate-900" />; 
            }
            
            return { bg: 'bg-gradient-to-r from-amber-400 to-orange-500', border: 'border-orange-500', text: 'text-white', statusText: statusText, icon: icon };
        };

        const getYearBadgeStyle = (year) => {
            const y = parseInt(year);
            const cur = new Date().getFullYear();
            const curTH = cur + 543;
            
            if (y === cur || y === curTH) return "bg-indigo-600 text-white shadow-lg shadow-indigo-500/40 border-indigo-400";
            if (y === cur - 1 || y === curTH - 1) return "bg-emerald-600 text-white shadow-lg shadow-emerald-500/40 border-emerald-400";
            if (y === cur - 2 || y === curTH - 2) return "bg-rose-500 text-white shadow-lg shadow-rose-500/40 border-rose-400";
            
            return "bg-slate-600 text-white shadow-lg shadow-slate-500/40 border-slate-500";
        };

        // --- Components ---

        const DetailRow = ({ label, value, icon: Icon, color = "text-slate-700" }) => (
            <div className="flex flex-col">
                <span className="text-[10px] text-slate-400 mb-0.5 flex items-center gap-1">{Icon && <Icon size={10} />} {label}</span>
                <span className={`text-xs font-semibold ${color} truncate`}>{value || '-'}</span>
            </div>
        );

        const SummaryChart = ({ financials }) => {
            const total = financials.totalMonths || 12;
            const paidPct = (financials.counts.paid / total) * 100;
            const overduePct = (financials.counts.overdue / total) * 100;
            const waitingPct = (financials.counts.waiting / total) * 100;
            // The rest is future
            
            const gradient = `conic-gradient(
                #22c55e 0% ${paidPct}%, 
                #ef4444 ${paidPct}% ${paidPct + overduePct}%, 
                #f59e0b ${paidPct + overduePct}% ${paidPct + overduePct + waitingPct}%, 
                #f3f4f6 ${paidPct + overduePct + waitingPct}% 100%
            )`;
            
            return (
                <div className="flex items-center gap-4 bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4">
                    <div className="relative w-16 h-16 rounded-full shrink-0 shadow-inner" style={{ background: gradient }}>
                        <div className="absolute inset-2 bg-white rounded-full flex items-center justify-center">
                            <span className="text-xs font-bold text-slate-600">{Math.round(paidPct)}%</span>
                        </div>
                    </div>
                    <div className="flex-1 grid grid-cols-2 gap-2 text-xs">
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-green-500"></div><span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ({financials.counts.paid})</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-500"></div><span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ({financials.counts.overdue})</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-amber-500"></div><span>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ({financials.counts.waiting})</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-gray-200"></div><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á ({financials.counts.future})</span></div>
                    </div>
                </div>
            );
        };

        // --- Main App Components ---

        const AdminPanel = ({ config, onSave, onCancel, isSaving }) => {
            const [localConfig, setLocalConfig] = useState(config);
            const [pin, setPin] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [error, setError] = useState('');
            const [allYears, setAllYears] = useState([]);

            useEffect(() => {
                const current = new Date().getFullYear() + 543;
                const years = [];
                for(let i = current + 2; i >= current - 5; i--) { 
                    years.push(i);
                }
                setAllYears(years);
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (pin === ADMIN_PIN) {
                    setIsAuthenticated(true);
                    setError('');
                } else {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            };

            const toggleYear = (year) => {
                const newManualYears = localConfig.manualYears.includes(year)
                    ? localConfig.manualYears.filter(y => y !== year)
                    : [...localConfig.manualYears, year];
                setLocalConfig({ ...localConfig, manualYears: newManualYears });
            };

            if (!isAuthenticated) {
                return (
                    <div className="min-h-[60vh] flex items-center justify-center px-4 animate-fade-up">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm border border-slate-100">
                            <div className="text-center mb-6">
                                <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                                    <Lock size={32} />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
                            </div>
                            <form onSubmit={handleLogin}>
                                <input
                                    type="password"
                                    value={pin}
                                    onChange={(e) => setPin(e.target.value)}
                                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN"
                                    className="w-full px-4 py-3 rounded-lg border border-slate-200 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-lg tracking-widest"
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-xs text-center mb-4">{error}</p>}
                                <div className="flex gap-3">
                                    <button type="button" onClick={onCancel} className="flex-1 py-2.5 rounded-lg bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button type="submit" className="flex-1 py-2.5 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto px-4 py-8 animate-fade-up">
                    <div className="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                        <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Settings size={20} /> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
                        </div>
                        <div className="p-6">
                            <div className="mb-6">
                                <label className="flex items-center justify-between p-4 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors">
                                    <div>
                                        <span className="font-bold text-slate-700 block">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (Manual Mode)</span>
                                        <span className="text-xs text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</span>
                                    </div>
                                    <div className={`w-12 h-6 rounded-full p-1 transition-colors ${localConfig.useManual ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                                        <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${localConfig.useManual ? 'translate-x-6' : ''}`}></div>
                                    </div>
                                    <input type="checkbox" className="hidden" checked={localConfig.useManual} onChange={(e) => setLocalConfig({...localConfig, useManual: e.target.checked})} />
                                </label>
                            </div>

                            {localConfig.useManual ? (
                                <div className="space-y-3">
                                    <h4 className="font-bold text-slate-600 text-sm mb-2 flex items-center gap-2"><Globe size={16} /> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</h4>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {allYears.map(year => (
                                            <label key={year} className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${localConfig.manualYears.includes(year) ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-500'}`}>
                                                <div className={`w-5 h-5 rounded flex items-center justify-center border ${localConfig.manualYears.includes(year) ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'}`}>
                                                    {localConfig.manualYears.includes(year) && <CheckCircle size={14} className="text-white" />}
                                                </div>
                                                <span className="font-bold">‡∏õ‡∏µ {year}</span>
                                                <input type="checkbox" className="hidden" checked={localConfig.manualYears.includes(year)} onChange={() => toggleYear(year)} />
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="p-4 bg-blue-50 rounded-xl border border-blue-100 text-blue-800 text-sm flex items-start gap-3">
                                    <Info size={20} className="shrink-0 mt-0.5" />
                                    <div>
                                        <strong>‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <br/>
                                        (‡∏õ‡∏µ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                            <button onClick={onCancel} disabled={isSaving} className="px-6 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-200 transition-colors disabled:opacity-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button onClick={() => onSave(localConfig)} disabled={isSaving} className="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-md transition-colors flex items-center gap-2 disabled:opacity-50">
                                {isSaving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ supabase, appConfig }) => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [yearFilter, setYearFilter] = useState('all');
            const [monthFilter, setMonthFilter] = useState('all');

            useEffect(() => {
                const fetchAllData = async () => {
                    if (!supabase) return;
                    setLoading(true);
                    try {
                        const { data, error } = await supabase.from('house_payments').select('*');
                        if (error) throw error;
                        setRawData(data || []);
                    } catch (err) { console.error("Dashboard Error:", err); } 
                    finally { setLoading(false); }
                };
                fetchAllData();
            }, [supabase]);

            const filteredRawData = useMemo(() => {
                const currentThaiYear = new Date().getFullYear() + 543;
                return rawData.filter(item => {
                    const y = parseInt(item.year);
                    if (appConfig.useManual) return appConfig.manualYears.includes(y);
                    return y <= currentThaiYear;
                });
            }, [rawData, appConfig]);

            const stats = useMemo(() => {
                if (!filteredRawData.length) return null;

                const filteredData = yearFilter === 'all' 
                    ? filteredRawData 
                    : filteredRawData.filter(item => String(item.year) === yearFilter);

                const totalHouses = filteredData.length;
                let totalPaidAmount = 0, totalUnpaidAmount = 0, totalFutureAmount = 0;
                const RATE = 300;
                
                const monthlyChartStats = months.map(m => ({ ...m, paid: 0, unpaid: 0, waiting: 0 }));
                const overdueMap = {};
                const soiOverdueMap = {}; 

                filteredData.forEach(item => {
                    let itemOverdueCount = 0; 
                    let itemOverdueAmount = 0;

                    months.forEach((m, idx) => {
                        const status = item[m.key] || '';
                        
                        // Chart Logic
                        if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) monthlyChartStats[idx].paid++;
                        else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) monthlyChartStats[idx].unpaid++;
                        else if (status.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) monthlyChartStats[idx].waiting++;

                        // Amounts Logic
                        const isTargetMonth = monthFilter === 'all' || m.key === monthFilter;
                        if (isTargetMonth) {
                            if (status.includes('‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || status.includes('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß')) totalPaidAmount += RATE;
                            else if (status.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢') || status.includes('‡∏Ñ‡πâ‡∏≤‡∏á')) {
                                totalUnpaidAmount += RATE;
                                itemOverdueCount++;
                                itemOverdueAmount += RATE;
                            } else if (status.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) {
                                totalFutureAmount += RATE;
                            }
                        }
                    });

                    if (itemOverdueCount > 0) {
                        const key = item.house_numbe;
                        if (!overdueMap[key]) overdueMap[key] = { houseNo: item.house_numbe, totalMonths: 0, totalAmount: 0 };
                        overdueMap[key].totalMonths += itemOverdueCount;
                        overdueMap[key].totalAmount += (itemOverdueCount * RATE);
                    }

                    if (itemOverdueAmount > 0) {
                        const soiName = item.soi ? item.soi.trim() : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ã‡∏≠‡∏¢';
                        soiOverdueMap[soiName] = (soiOverdueMap[soiName] || 0) + itemOverdueAmount;
                    }
                });

                const totalExpected = totalPaidAmount + totalUnpaidAmount + totalFutureAmount;
                const paidPercentage = totalExpected > 0 ? (totalPaidAmount / totalExpected) * 100 : 0;
                const overdueList = Object.values(overdueMap).sort((a, b) => b.totalAmount - a.totalAmount);
                const soiList = Object.entries(soiOverdueMap)
                    .map(([name, amount]) => ({ name, amount }))
                    .sort((a, b) => b.amount - a.amount);

                return { totalHouses, totalPaidAmount, totalUnpaidAmount, totalFutureAmount, paidPercentage, monthlyChartStats, overdueList, soiList };
            }, [filteredRawData, yearFilter, monthFilter]);

            const availableYears = useMemo(() => [...new Set(filteredRawData.map(d => d.year))].sort((a,b) => b-a), [filteredRawData]);

            if (loading) return <div className="flex flex-col items-center justify-center py-20 text-white"><Loader2 size={48} className="animate-spin mb-4" /><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°...</p></div>;
            if (!stats) return <div className="text-center py-20 text-white"><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>;

            return (
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-up">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-bold text-white mb-2 drop-shadow-md flex items-center justify-center gap-3"><LayoutDashboard size={32} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
                    </div>

                    <div className="bg-white/10 backdrop-blur-md p-4 rounded-2xl mb-8 flex flex-col md:flex-row gap-4 items-center justify-center border border-white/20 shadow-lg">
                        <div className="flex items-center gap-2 text-white font-medium"><Filter size={20} /> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</div>
                        <div className="flex gap-4">
                            <select value={yearFilter} onChange={(e) => setYearFilter(e.target.value)} className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400">
                                <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                                {availableYears.map(y => <option key={y} value={y}>‡∏õ‡∏µ {y}</option>)}
                            </select>
                            <select value={monthFilter} onChange={(e) => setMonthFilter(e.target.value)} className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400">
                                <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                {months.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        {[{ label: '‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ', value: stats.totalPaidAmount, color: 'text-green-600', subColor: 'bg-green-100 text-green-700', icon: Coins, subText: `${stats.paidPercentage.toFixed(1)}%` },
                          { label: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞', value: stats.totalUnpaidAmount, color: 'text-red-500', subColor: 'bg-red-100 text-red-700', icon: AlertCircle, subText: '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' },
                          { label: '‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö', value: stats.totalFutureAmount, color: 'text-yellow-600', subColor: 'bg-yellow-100 text-yellow-700', icon: Hourglass, subText: '‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤' },
                          { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', value: stats.totalHouses, color: 'text-slate-800', subColor: 'bg-blue-100 text-blue-700', icon: Home, subText: '‡∏´‡∏•‡∏±‡∏á (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)', suffix: '' }
                        ].map((card, i) => (
                            <div key={i} className="bg-white rounded-2xl p-5 shadow-lg border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                                <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${card.color}`}><card.icon size={60} /></div>
                                <span className="text-slate-500 text-sm font-medium mb-1">{card.label}</span>
                                <h3 className={`text-2xl font-bold ${card.color}`}>{card.value.toLocaleString()} {card.suffix === undefined ? '‡∏ø' : ''}</h3>
                                <div className={`mt-2 text-xs font-bold px-2 py-1 rounded-lg ${card.subColor}`}>{card.subText}</div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Charts & Tables would go here (Simplified for brevity as logic is same as previous) */}
                     <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 mb-8">
                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><BarChart3 className="text-indigo-500" /> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ({yearFilter === 'all' ? '‡∏£‡∏ß‡∏°' : yearFilter})</h3>
                        <div className="h-64 flex items-end justify-between gap-2 md:gap-4 overflow-x-auto pb-2">
                            {stats.monthlyChartStats.map((m, idx) => {
                                const total = stats.totalHouses || 1;
                                const paidHeight = (m.paid / total) * 100;
                                const unpaidHeight = (m.unpaid / total) * 100;
                                const waitingHeight = (m.waiting / total) * 100;
                                return (
                                    <div key={idx} className="flex flex-col items-center gap-2 h-full justify-end flex-1 min-w-[40px]">
                                        <div className="w-full bg-slate-100 rounded-t-lg relative flex flex-col justify-end overflow-hidden h-full">
                                            <div className="bg-red-400 w-full" style={{ height: `${unpaidHeight}%` }} title={`‡∏Ñ‡πâ‡∏≤‡∏á: ${m.unpaid}`}></div>
                                            <div className="bg-yellow-400 w-full" style={{ height: `${waitingHeight}%` }} title={`‡∏£‡∏≠: ${m.waiting}`}></div>
                                            <div className="bg-green-500 w-full" style={{ height: `${paidHeight}%` }} title={`‡∏à‡πà‡∏≤‡∏¢: ${m.paid}`}></div>
                                        </div>
                                        <span className="text-xs font-bold text-slate-500">{m.label}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-100">
                             <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><FileWarning className="text-red-500" /> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                             <div className="overflow-y-auto max-h-[400px]">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-50 sticky top-0"><tr><th className="px-3 py-2 text-left">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th className="px-3 py-2 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
                                    <tbody>
                                        {stats.overdueList.slice(0, 20).map((h, i) => (
                                            <tr key={i} className="border-b border-slate-50 hover:bg-slate-50">
                                                <td className="px-3 py-2 font-medium">{h.houseNo} <span className="text-xs text-red-500">({h.totalMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span></td>
                                                <td className="px-3 py-2 text-right font-bold text-red-600">‡∏ø{h.totalAmount.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                        <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-100">
                             <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><MapPin className="text-orange-500" /> ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ã‡∏≠‡∏¢</h3>
                             <div className="space-y-4 max-h-[400px] overflow-y-auto">
                                {stats.soiList.map((soi, index) => (
                                    <div key={index} className="flex items-center gap-4">
                                        <div className="w-20 text-sm font-bold text-slate-600 shrink-0">{soi.name}</div>
                                        <div className="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden relative">
                                            <div className="h-full bg-gradient-to-r from-orange-400 to-red-500" style={{ width: `${(soi.amount / stats.soiList[0].amount) * 100}%` }}></div>
                                        </div>
                                        <div className="w-20 text-right text-xs font-bold text-red-600">‡∏ø{soi.amount.toLocaleString()}</div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [searchTerm, setSearchTerm] = useState('');
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [supabase, setSupabase] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showScrollTop, setShowScrollTop] = useState(false);
            
            const [allPendingFees, setAllPendingFees] = useState([]);
            const [visibleNames, setVisibleNames] = useState({});
            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [selectedHouse, setSelectedHouse] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            const [historyLoading, setHistoryLoading] = useState(false);
            
            const [pdfModalOpen, setPdfModalOpen] = useState(false);
            const [selectedPdfUrl, setSelectedPdfUrl] = useState(null);
            const [imageModalOpen, setImageModalOpen] = useState(false);
            const [selectedImageUrl, setSelectedImageUrl] = useState(null);
            const [syncingId, setSyncingId] = useState(null);
            
            const [appConfig, setAppConfig] = useState({ useManual: false, manualYears: [] });
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [resultModal, setResultModal] = useState({ isOpen: false, type: 'success', message: '' });

            useEffect(() => {
                // Initialize Supabase
                if (window.supabase) {
                    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    setSupabase(client);
                    fetchConfig(client);
                }
                const handleScroll = () => setShowScrollTop(window.scrollY > 300);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const fetchConfig = async (client) => {
                // Try LocalStorage first (faster/fallback)
                const cached = localStorage.getItem('house_payment_config');
                if (cached) setAppConfig(JSON.parse(cached));

                try {
                    const { data, error } = await client.from('app_settings').select('config').eq('id', 1).single();
                    if (data?.config) {
                        setAppConfig(data.config);
                        localStorage.setItem('house_payment_config', JSON.stringify(data.config));
                    }
                } catch (err) { console.log('Config fetch used default/local'); }
            };

            const saveConfig = async (newConfig) => {
                setIsSaving(true);
                // Always save to LocalStorage as backup
                localStorage.setItem('house_payment_config', JSON.stringify(newConfig));
                setAppConfig(newConfig);

                try {
                    if (supabase) {
                        const { error } = await supabase.from('app_settings').upsert({ id: 1, config: newConfig });
                        if (error) throw error;
                    }
                    setShowAdminPanel(false);
                    if (searchTerm && currentPage === 'home') handleSearchClick();
                } catch (err) {
                    // RLS Error or Network Error
                    console.error('DB Save Error:', err);
                    setResultModal({ isOpen: true, type: 'error', message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô)' });
                    setShowAdminPanel(false);
                    if (searchTerm && currentPage === 'home') handleSearchClick();
                } finally {
                    setIsSaving(false);
                }
            };

            const sendTelegramNotification = async (houseNo, results) => {
                if (!TELEGRAM_TOKEN || !results.length) return;
                try {
                    // Limit items to prevent message too long error
                    const limit = 5;
                    const displayItems = results.slice(0, limit);
                    
                    let message = `üè† *‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${houseNo}*\n‡∏û‡∏ö: ${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
                    displayItems.forEach((item) => {
                        const financials = calculateFinancials(item);
                        message += `‡∏õ‡∏µ ${item.year}: ${financials.overdueMonths > 0 ? '‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á' : '‚úÖ ‡∏Ñ‡∏£‡∏ö'}\n`;
                    });
                    
                    if (results.length > limit) message += `\n...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${results.length - limit} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

                    await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: 'Markdown' }) 
                    });
                } catch (e) { console.error('Telegram fail', e); }
            };

            const fetchPayments = async (search = '') => {
                if (!supabase) return [];
                setLoading(true);
                try {
                    let query = supabase.from('house_payments').select('*');
                    if (search) query = query.or(`house_numbe.ilike.%${search}%,owner_name.ilike.%${search}%`);
                    
                    const { data, error } = await query.order('year', { ascending: false });
                    if (error) throw error;

                    // Filter logic
                    const currentThaiYear = new Date().getFullYear() + 543;
                    let finalData = (data || []).filter(item => {
                        const y = parseInt(item.year);
                        if (appConfig.useManual) return appConfig.manualYears.includes(y);
                        return y <= currentThaiYear; // Default: hide future
                    });
                    
                    setPayments(finalData);
                    return finalData;
                } catch (err) { 
                    setError('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); 
                    return [];
                } finally { setLoading(false); }
            };

            const handleSearchClick = async () => {
                setLoading(true);
                const results = await fetchPayments(searchTerm);
                if (results.length && searchTerm.trim()) sendTelegramNotification(searchTerm, results);
            };

            // Minimal wrappers for UI interactions
            const openDetailModal = async (item) => {
                setSelectedHouse(item);
                setDetailModalOpen(true);
                setHistoryLoading(true);
                if (supabase) {
                    const { data } = await supabase.from('common_fees')
                        .select('*')
                        .eq('house_number', item.house_numbe)
                        .order('reported_at', { ascending: false });
                    setHistoryData(data || []);
                }
                setHistoryLoading(false);
            };

            return (
                <div className="min-h-screen pb-10">
                    <div className="fixed inset-0 -z-10 bg-gradient-to-br from-[#1e3c72] via-[#2a5298] to-[#8e44ad]"></div>
                    
                    <nav className="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 text-white font-bold text-lg"><Home /> Smart Village</div>
                            <div className="flex gap-2">
                                <button onClick={() => setCurrentPage('home')} className={`p-2 rounded-lg ${currentPage==='home'?'bg-white text-blue-600':'text-white'}`}><Search/></button>
                                <button onClick={() => setCurrentPage('dashboard')} className={`p-2 rounded-lg ${currentPage==='dashboard'?'bg-white text-blue-600':'text-white'}`}><LayoutDashboard/></button>
                                <button onClick={() => setShowAdminPanel(true)} className="p-2 rounded-lg text-white hover:bg-white/20"><Settings/></button>
                            </div>
                        </div>
                    </nav>

                    <main className="pt-6">
                        {showAdminPanel ? (
                            <AdminPanel config={appConfig} onSave={saveConfig} onCancel={() => setShowAdminPanel(false)} isSaving={isSaving} />
                        ) : currentPage === 'dashboard' ? (
                            <Dashboard supabase={supabase} appConfig={appConfig} />
                        ) : (
                            <div className="max-w-7xl mx-auto px-4">
                                {/* Search Section */}
                                <div className="max-w-3xl mx-auto text-center mb-10 text-white no-print">
                                    <h2 className="text-3xl font-bold mb-4">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 99/99)" className="flex-1 p-4 rounded-xl text-slate-800 outline-none shadow-lg" 
                                            value={searchTerm} onChange={e => setSearchTerm(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearchClick()} />
                                        <button onClick={handleSearchClick} className="bg-white text-blue-600 px-6 rounded-xl font-bold shadow-lg hover:bg-blue-50 transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                                    </div>
                                </div>

                                {/* Results Grid */}
                                {loading ? <div className="text-center text-white"><Loader2 className="animate-spin inline-block mb-2" size={32}/><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div> : 
                                 payments.length === 0 && !error ? <div className="text-center text-white/70 mt-10"><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div> :
                                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {payments.map(item => {
                                        const financials = calculateFinancials(item);
                                        const header = getHeaderStyle(financials);
                                        const isNameVisible = visibleNames[getItemKey(item)];
                                        
                                        return (
                                            <div key={getItemKey(item)} className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 animate-fade-up">
                                                <div className={`${header.bg} px-5 py-4 flex justify-between items-center text-white`}>
                                                    <div>
                                                        <h3 className="text-xl font-bold flex items-center gap-2"><Home size={20}/> {item.house_numbe}</h3>
                                                        <span className="text-xs bg-white/20 px-2 py-0.5 rounded">‡∏õ‡∏µ {item.year}</span>
                                                    </div>
                                                    <div className="bg-white/20 px-3 py-1 rounded-lg flex items-center gap-1 text-xs font-bold backdrop-blur-sm">{header.icon} {header.statusText}</div>
                                                </div>
                                                <div className="p-5">
                                                    <SummaryChart financials={financials} />
                                                    
                                                    <div className="flex justify-between items-center mb-4">
                                                        <div className="flex items-center gap-2 font-bold text-slate-700">
                                                            <User size={16} className="text-blue-500"/> 
                                                            {isNameVisible ? item.owner_name : maskName(item.owner_name)}
                                                        </div>
                                                        <button onClick={() => setVisibleNames(prev => ({...prev, [getItemKey(item)]: !prev[getItemKey(item)]}))} className="text-slate-400 hover:text-blue-500">
                                                            {isNameVisible ? <EyeOff size={16}/> : <Eye size={16}/>}
                                                        </button>
                                                    </div>

                                                    <button onClick={() => openDetailModal(item)} className="w-full py-2 mb-4 rounded-lg bg-indigo-50 text-indigo-600 font-bold text-sm border border-indigo-100 hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                                                        <FileText size={16}/> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô
                                                    </button>

                                                    <div className="grid grid-cols-4 gap-2">
                                                        {months.map(m => (
                                                            <div key={m.key} className={`p-1 text-center rounded border ${getStatusColor(item[m.key])}`}>
                                                                <div className="text-[10px] opacity-70">{m.label}</div>
                                                                <div className="text-[10px] font-bold truncate">{item[m.key] || '-'}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                 </div>
                                }
                            </div>
                        )}
                    </main>

                    {showScrollTop && <button onClick={() => window.scrollTo({top:0, behavior:'smooth'})} className="fixed bottom-6 right-6 bg-blue-600 text-white p-3 rounded-full shadow-lg z-40"><ArrowUp/></button>}

                    {/* Modals */}
                    {detailModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={() => setDetailModalOpen(false)}>
                            <div className="bg-white w-full max-w-2xl max-h-[85vh] rounded-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-4 bg-indigo-600 text-white flex justify-between items-center">
                                    <h3 className="font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô ({selectedHouse?.house_numbe})</h3>
                                    <button onClick={() => setDetailModalOpen(false)}><X/></button>
                                </div>
                                <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                                    {historyLoading ? <div className="text-center py-10"><Loader2 className="animate-spin inline-block"/></div> : 
                                     historyData.length === 0 ? <div className="text-center py-10 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div> :
                                     historyData.map((rec, i) => (
                                        <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                            <div className="flex justify-between mb-2">
                                                <span className="font-bold text-indigo-600">{rec.month} {rec.year}</span>
                                                <span className={`text-xs px-2 py-1 rounded font-bold ${rec.status?.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')||rec.status?.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>{rec.status}</span>
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <div className="text-2xl font-bold text-slate-800">‡∏ø{(rec.amount || 0).toLocaleString()}</div>
                                                <div className="text-xs text-slate-500">{new Date(rec.reported_at).toLocaleDateString('th-TH')}</div>
                                            </div>
                                            {rec.image_url && <button onClick={() => { setSelectedImageUrl(rec.image_url); setImageModalOpen(true); }} className="mt-3 text-sm text-blue-600 underline flex items-center gap-1"><ImageIcon size={14}/> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</button>}
                                        </div>
                                     ))
                                    }
                                </div>
                            </div>
                        </div>
                    )}

                    {imageModalOpen && selectedImageUrl && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/90" onClick={() => setImageModalOpen(false)}>
                            <img src={selectedImageUrl} className="max-w-full max-h-full rounded shadow-2xl" />
                            <button className="absolute top-4 right-4 text-white p-2 bg-white/10 rounded-full"><X/></button>
                        </div>
                    )}
                    
                    {resultModal.isOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50">
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full text-center">
                                <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${resultModal.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                    {resultModal.type === 'success' ? <CheckCircle/> : <AlertTriangle/>}
                                </div>
                                <p className="mb-6">{resultModal.message}</p>
                                <button onClick={() => setResultModal({...resultModal, isOpen: false})} className="bg-slate-800 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
