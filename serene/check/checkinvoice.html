<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบค่าส่วนกลาง | หมู่บ้าน โกลเด้นแลนด์ ซีรีน</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {}
            }
        }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Import Map for React & Icons -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0"
      }
    }
    </script>

    <style>
        body { font-family: 'Kanit', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.5s ease-out forwards; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Home, User, Clock, CreditCard, Menu, X, Coins, CheckCircle, 
            AlertCircle, AlertTriangle, ShieldAlert, FileWarning, HelpCircle, Mail, 
            Eye, EyeOff, FileText, Receipt, Calendar, ChevronRight, Image as ImageIcon, 
            ExternalLink, UserCheck, Banknote, MessageSquare, Hash, Fingerprint, Type, 
            CalendarCheck, BadgeCheck, Bell, ZoomIn, RefreshCw, Loader2, Sparkles, ThumbsUp, Printer, ArrowUp,
            LayoutDashboard, BarChart3, Filter, CalendarCheck2, Info, MapPin, Hourglass, Settings, Lock, Save, Globe, Database, Download, Moon, Sun
        } from 'lucide-react';

        // --- Configuration ---
        const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
        const TELEGRAM_TOKEN = '7708637309:AAHU2swP8U67XVWITdjsxjQoqiXIL9KbBJs'; 
        const TELEGRAM_CHAT_ID = '7585120244';
        const ADMIN_PIN = '9999'; 

        // --- Helpers ---
        const monthMap = { 'มกราคม': 'jan', 'กุมภาพันธ์': 'feb', 'มีนาคม': 'mar', 'เมษายน': 'apr', 'พฤษภาคม': 'may', 'มิถุนายน': 'jun', 'กรกฎาคม': 'jul', 'สิงหาคม': 'aug', 'กันยายน': 'sep', 'ตุลาคม': 'oct', 'พฤศจิกายน': 'nov', 'ธันวาคม': 'dec' };
        const months = [ { key: 'jan', label: 'ม.ค.' }, { key: 'feb', label: 'ก.พ.' }, { key: 'mar', label: 'มี.ค.' }, { key: 'apr', label: 'เม.ย.' }, { key: 'may', label: 'พ.ค.' }, { key: 'jun', label: 'มิ.ย.' }, { key: 'jul', label: 'ก.ค.' }, { key: 'aug', label: 'ส.ค.' }, { key: 'sep', label: 'ก.ย.' }, { key: 'oct', label: 'ต.ค.' }, { key: 'nov', label: 'พ.ย.' }, { key: 'dec', label: 'ธ.ค.' } ];
        const getItemKey = (item) => `${item.house_numbe}-${item.year}`;
        const maskName = (fullName) => {
            if (!fullName || fullName.length <= 3) return fullName;
            const prefixes = ['นาย', 'นาง', 'นางสาว', 'เด็กชาย', 'เด็กหญิง', 'ดร.', 'ศ.', 'รศ.', 'ผศ.', 'อ.', 'ว่าที่ร้อยตรี'];
            let prefix = ''; let nameWithoutPrefix = fullName;
            for (const p of prefixes) { if (fullName.startsWith(p)) { prefix = p; nameWithoutPrefix = fullName.substring(p.length).trim(); break; } }
            const nameParts = nameWithoutPrefix.split(/\s+/);
            if (nameParts.length === 0) return fullName;
            const firstName = nameParts[0];
            if (nameParts.length === 1) return (prefix ? prefix + ' ' : '') + firstName.substring(0, 3) + 'xxxxxxx';
            return (prefix ? prefix + ' ' : '') + firstName + ' xxxxxxx';
        };
        const getStatusColor = (status) => {
            if (!status) return 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700';
            if (status.includes('จ่ายแล้ว') || status.includes('ชำระแล้ว')) return 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800';
            if (status.includes('ล่วงหน้า')) return 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800';
            if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) return 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800';
            if (status.includes('รอตรวจสอบ')) return 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800';
            if (status.includes('รอข้อมูล')) return 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800';
            if (status.includes('ไม่เก็บ')) return 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-gray-800 dark:text-gray-500 dark:border-gray-700';
            return 'bg-gray-50 text-gray-600 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700';
        };
        
        const calculateFinancials = (item) => {
            let paidCount = 0; let overdueCount = 0; let waitingCount = 0; let futureCount = 0; const RATE = 300; let totalMonths = 0;
            let headerOverdueCount = 0; let headerWaitingCount = 0;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthIdx = now.getMonth();
            const itemYear = parseInt(item.year);
            const compareYear = itemYear > 2400 ? currentYear + 543 : currentYear;

            months.forEach((month, idx) => {
                const status = item[month.key];
                if (!status || status.includes('ไม่เก็บ')) return;
                totalMonths++;
                if (status.includes('จ่ายแล้ว') || status.includes('ชำระแล้ว')) paidCount++;
                else if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) overdueCount++;
                else if (status.includes('รอข้อมูล')) futureCount++;
                else if (status.includes('รอตรวจสอบ')) waitingCount++;

                let isEffective = false;
                if (itemYear < compareYear) isEffective = true;
                else if (itemYear === compareYear && idx <= currentMonthIdx) isEffective = true;
                if (isEffective) {
                    if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) headerOverdueCount++;
                    else if (status.includes('รอข้อมูล') || status.includes('รอตรวจสอบ')) headerWaitingCount++;
                }
            });
            return { paid: paidCount * RATE, overdue: overdueCount * RATE, waiting: waitingCount * RATE, future: futureCount * RATE, overdueMonths: headerOverdueCount, waitingMonths: headerWaitingCount, totalMonths: totalMonths, counts: { paid: paidCount, overdue: overdueCount, waiting: waitingCount, future: futureCount } };
        };

        const getHeaderStyle = (financials) => {
            const { overdueMonths, waitingMonths } = financials;
            if (overdueMonths === 0 && waitingMonths === 0) return { bg: 'bg-gradient-to-r from-green-500 to-green-600', border: 'border-green-600 dark:border-green-500', text: 'text-white', statusText: 'ชำระครบถ้วน', icon: <CheckCircle size={20} className="text-white" /> };
            if (overdueMonths > 6) return { bg: 'bg-gradient-to-r from-red-800 to-red-900', border: 'border-red-900', text: 'text-white', statusText: 'แจ้งอายัดที่ดิน', icon: <ShieldAlert size={20} className="text-white" /> };
            if (overdueMonths >= 3) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', border: 'border-red-600', text: 'text-white', statusText: 'ระงับสิทธิ์ต่างๆ', icon: <Mail size={20} className="text-white" /> };
            let statusText = `ค้างชำระ ${overdueMonths} เดือน`;
            let icon = <AlertTriangle size={20} className="text-slate-900 dark:text-slate-900" />;
            if (overdueMonths === 0 && waitingMonths > 0) { statusText = 'รอตรวจสอบข้อมูล'; icon = <HelpCircle size={20} className="text-slate-900 dark:text-slate-900" />; }
            return { bg: 'bg-gradient-to-r from-yellow-400 to-yellow-500', border: 'border-yellow-500', text: 'text-slate-900', statusText: statusText, icon: icon };
        };

        const getYearBadgeStyle = (year) => {
            const y = parseInt(year);
            if (y === 2025 || y === 2568) return "bg-indigo-600 text-white shadow-lg shadow-indigo-500/40 border-indigo-400";
            if (y === 2024 || y === 2567) return "bg-emerald-600 text-white shadow-lg shadow-emerald-500/40 border-emerald-400";
            if (y === 2023 || y === 2566) return "bg-rose-500 text-white shadow-lg shadow-rose-500/40 border-rose-400";
            if (y === 2022 || y === 2565) return "bg-amber-500 text-white shadow-lg shadow-amber-500/40 border-amber-400";
            return "bg-slate-600 text-white shadow-lg shadow-slate-500/40 border-slate-500";
        };

        const getHistoryCardHeaderStyle = (status) => {
            if (!status) return { bg: 'bg-gradient-to-r from-slate-50 to-white dark:from-slate-700 dark:to-slate-800', text: 'text-slate-700 dark:text-slate-200', iconColor: 'text-indigo-600', iconBg: 'bg-indigo-100', border: 'border-slate-100 dark:border-slate-600' };
            if (status.includes('ตรวจสอบแล้ว') || status.includes('อนุมัติ') || status.includes('ถูกต้อง') || status.includes('เรียบร้อย')) return { bg: 'bg-gradient-to-r from-emerald-500 to-green-600', text: 'text-white', iconColor: 'text-emerald-600', iconBg: 'bg-white', border: 'border-emerald-600' };
            if (status.includes('รอ') || status.includes('ตรวจสอบ')) return { bg: 'bg-gradient-to-r from-amber-400 to-orange-500', text: 'text-white', iconColor: 'text-amber-600', iconBg: 'bg-white', border: 'border-amber-500' };
            if (status.includes('ยกเลิก') || status.includes('ไม่ผ่าน')) return { bg: 'bg-gradient-to-r from-red-500 to-red-600', text: 'text-white', iconColor: 'text-red-600', iconBg: 'bg-white', border: 'border-red-600' };
            return { bg: 'bg-gradient-to-r from-slate-50 to-white', text: 'text-slate-700', iconColor: 'text-indigo-600', iconBg: 'bg-indigo-100', border: 'border-slate-100' };
        };
        const getHistoryHeaderBadge = (status) => {
            const textClass = status?.includes('ตรวจสอบแล้ว') || status?.includes('อนุมัติ') ? 'text-emerald-700' : status?.includes('รอ') ? 'text-amber-700' : status?.includes('ยกเลิก') || status?.includes('ไม่ผ่าน') ? 'text-red-700' : 'text-slate-700';
            return <span className={`bg-white ${textClass} px-2 py-0.5 rounded text-[10px] font-bold shadow-sm flex items-center gap-1 whitespace-nowrap`}>{status || '-'}</span>;
        };

        // --- Sub-components ---
        const DetailRow = ({ label, value, icon: Icon, color = "text-slate-700 dark:text-slate-300" }) => (
            <div className="flex flex-col">
                <span className="text-[10px] text-slate-400 dark:text-slate-500 mb-0.5 flex items-center gap-1">{Icon && <Icon size={10} />} {label}</span>
                <span className={`text-xs font-semibold ${color} truncate`}>{value || '-'}</span>
            </div>
        );

        const SummaryChart = ({ financials }) => {
            const total = financials.totalMonths || 12;
            const paidPct = (financials.counts.paid / total) * 100;
            const overduePct = (financials.counts.overdue / total) * 100;
            const futurePct = (financials.counts.future / total) * 100;
            const gradient = `conic-gradient(#22c55e 0% ${paidPct}%, #ef4444 ${paidPct}% ${paidPct + overduePct}%, #eab308 ${paidPct + overduePct}% ${paidPct + overduePct + futurePct}%, #f3f4f6 ${paidPct + overduePct + futurePct}% 100%)`;
            return (
                <div className="flex items-center gap-4 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mb-4">
                    <div className="relative w-16 h-16 rounded-full shrink-0 shadow-inner" style={{ background: gradient }}>
                        <div className="absolute inset-2 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center">
                            <span className="text-xs font-bold text-slate-600 dark:text-slate-300">{Math.round(paidPct)}%</span>
                        </div>
                    </div>
                    <div className="flex-1 grid grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-300">
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-green-500"></div><span>จ่ายแล้ว {financials.counts.paid}</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-500"></div><span>ค้างชำระ {financials.counts.overdue}</span></div>
                        <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-yellow-500"></div><span>รอข้อมูล {financials.counts.future}</span></div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ config, onSave, onCancel, isSaving, onUpdateStatus }) => {
            const [localConfig, setLocalConfig] = useState(config);
            const [pin, setPin] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [error, setError] = useState('');
            const [allYears, setAllYears] = useState([]);
            
            // State for status update
            const [updateTargetYear, setUpdateTargetYear] = useState('');
            const [updateTargetMonth, setUpdateTargetMonth] = useState('');

            useEffect(() => {
                const current = new Date().getFullYear() + 543;
                const years = [];
                for(let i = current + 3; i >= current - 3; i--) { 
                    years.push(i);
                }
                setAllYears(years);
                setUpdateTargetYear(current.toString());
                setUpdateTargetMonth(months[new Date().getMonth()].key);
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (pin === ADMIN_PIN) {
                    setIsAuthenticated(true);
                    setError('');
                } else {
                    setError('รหัสผ่านไม่ถูกต้อง');
                }
            };

            const toggleYear = (year) => {
                const newManualYears = localConfig.manualYears.includes(year)
                    ? localConfig.manualYears.filter(y => y !== year)
                    : [...localConfig.manualYears, year];
                
                setLocalConfig({ ...localConfig, manualYears: newManualYears });
            };

            if (!isAuthenticated) {
                return (
                    <div className="min-h-[60vh] flex items-center justify-center px-4 animate-fade-up">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 w-full max-w-sm border border-slate-100 dark:border-slate-700">
                            <div className="text-center mb-6">
                                <div className="bg-indigo-100 dark:bg-indigo-900 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 dark:text-indigo-400">
                                    <Lock size={32} />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 dark:text-white">เข้าสู่ระบบผู้ดูแล</h3>
                                <p className="text-slate-500 dark:text-slate-400 text-sm">กรุณากรอกรหัสผ่านเพื่อตั้งค่า</p>
                            </div>
                            <form onSubmit={handleLogin}>
                                <input
                                    type="password"
                                    value={pin}
                                    onChange={(e) => setPin(e.target.value)}
                                    placeholder="รหัสผ่าน (PIN)"
                                    className="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-lg tracking-widest"
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-xs text-center mb-4">{error}</p>}
                                <div className="flex gap-3">
                                    <button type="button" onClick={onCancel} className="flex-1 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">ยกเลิก</button>
                                    <button type="submit" className="flex-1 py-2.5 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors">เข้าสู่ระบบ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto px-4 py-8 animate-fade-up">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden mb-6">
                        <div className="bg-slate-50 dark:bg-slate-700 px-6 py-4 border-b border-slate-100 dark:border-slate-600 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><Settings size={20} /> ตั้งค่าการแสดงผล</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><X size={24} /></button>
                        </div>
                        <div className="p-6">
                            <div className="mb-6">
                                <label className="flex items-center justify-between p-4 rounded-xl border border-slate-200 dark:border-slate-600 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                    <div>
                                        <span className="font-bold text-slate-700 dark:text-slate-200 block">โหมดกำหนดเอง (Manual Mode)</span>
                                        <span className="text-xs text-slate-500 dark:text-slate-400">เลือกเปิด-ปิดปีที่ต้องการแสดงผลด้วยตัวเอง (ข้อมูลปีนี้จะถูกเก็บใน Database)</span>
                                    </div>
                                    <div className={`w-12 h-6 rounded-full p-1 transition-colors ${localConfig.useManual ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                                        <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${localConfig.useManual ? 'translate-x-6' : ''}`}></div>
                                    </div>
                                    <input 
                                        type="checkbox" 
                                        className="hidden" 
                                        checked={localConfig.useManual} 
                                        onChange={(e) => setLocalConfig({...localConfig, useManual: e.target.checked})} 
                                    />
                                </label>
                            </div>

                            {localConfig.useManual ? (
                                <div className="space-y-3">
                                    <h4 className="font-bold text-slate-600 dark:text-slate-300 text-sm mb-2 flex items-center gap-2"><Globe size={16} /> เลือกปีที่อนุญาตให้แสดงผล (Public View):</h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        {allYears.map(year => (
                                            <label key={year} className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${localConfig.manualYears.includes(year) ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400'}`}>
                                                <div className={`w-5 h-5 rounded flex items-center justify-center border ${localConfig.manualYears.includes(year) ? 'bg-indigo-600 border-indigo-600' : 'bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-500'}`}>
                                                    {localConfig.manualYears.includes(year) && <CheckCircle size={14} className="text-white" />}
                                                </div>
                                                <span className="font-bold">ปี {year}</span>
                                                <input type="checkbox" className="hidden" checked={localConfig.manualYears.includes(year)} onChange={() => toggleYear(year)} />
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800 text-blue-800 dark:text-blue-300 text-sm flex items-start gap-3">
                                    <Info size={20} className="shrink-0 mt-0.5" />
                                    <div>
                                        <strong>โหมดอัตโนมัติ:</strong> ระบบจะแสดงข้อมูลปีปัจจุบันและปีก่อนหน้าทั้งหมด <br/>
                                        (ปีอนาคต จะถูกซ่อนอัตโนมัติ)
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50 flex justify-end gap-3">
                            <button onClick={onCancel} disabled={isSaving} className="px-6 py-2 rounded-lg text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors disabled:opacity-50">ยกเลิก</button>
                            <button onClick={() => onSave(localConfig)} disabled={isSaving} className="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-md transition-colors flex items-center gap-2 disabled:opacity-50">
                                {isSaving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />} บันทึกการตั้งค่า
                            </button>
                        </div>
                    </div>

                    {/* Section: Status Update */}
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                         <div className="bg-slate-50 dark:bg-slate-700 px-6 py-4 border-b border-slate-100 dark:border-slate-600">
                            <h3 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><Database size={20} /> อัพเดทสถานะรายเดือน (Batch Update)</h3>
                            <p className="text-slate-500 dark:text-slate-400 text-xs mt-1">เปลี่ยนสถานะ "รอข้อมูล" เป็น "ยังไม่จ่าย" สำหรับเดือนที่เลือก</p>
                        </div>
                        <div className="p-6">
                            <div className="flex flex-col md:flex-row gap-4 items-end">
                                <div className="w-full md:w-1/3">
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">เลือกปี</label>
                                    <select 
                                        value={updateTargetYear}
                                        onChange={(e) => setUpdateTargetYear(e.target.value)}
                                        className="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 dark:text-white"
                                    >
                                        {allYears.map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                </div>
                                <div className="w-full md:w-1/3">
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">เลือกเดือน</label>
                                    <select 
                                        value={updateTargetMonth}
                                        onChange={(e) => setUpdateTargetMonth(e.target.value)}
                                        className="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 dark:text-white"
                                    >
                                        {months.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                                    </select>
                                </div>
                                <div className="w-full md:w-1/3">
                                    <button 
                                        onClick={() => onUpdateStatus(updateTargetYear, updateTargetMonth)}
                                        disabled={isSaving} // reuse isSaving or add new loading state
                                        className="w-full px-6 py-2.5 rounded-lg bg-orange-600 text-white font-bold hover:bg-orange-700 shadow-md transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
                                    >
                                        {isSaving ? <Loader2 size={18} className="animate-spin" /> : <RefreshCw size={18} />} เริ่มอัพเดท
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ supabase, appConfig }) => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [yearFilter, setYearFilter] = useState('all');
            const [monthFilter, setMonthFilter] = useState('all');

            useEffect(() => {
                const fetchAllData = async () => {
                    if (!supabase) return;
                    setLoading(true);
                    try {
                        const { data, error } = await supabase.from('house_payments').select('*');
                        if (error) throw error;
                        setRawData(data);
                        setYearFilter('all');
                    } catch (err) { console.error("Dashboard Error:", err); } 
                    finally { setLoading(false); }
                };
                fetchAllData();
            }, [supabase]);

            // ** Filter Logic Integration **
            const filteredRawData = useMemo(() => {
                const currentThaiYear = new Date().getFullYear() + 543;
                return rawData.filter(item => {
                    const y = parseInt(item.year);
                    // 1. Admin Config Filter
                    if (appConfig.useManual) {
                        if (!appConfig.manualYears.includes(y)) return false;
                    } else {
                        // Default: Hide future years
                        if (y > currentThaiYear) return false;
                    }
                    return true;
                });
            }, [rawData, appConfig]);

            const stats = useMemo(() => {
                if (!filteredRawData.length) return null;

                const filteredData = yearFilter === 'all' 
                    ? filteredRawData 
                    : filteredRawData.filter(item => String(item.year) === yearFilter);

                const totalHouses = filteredData.length;
                let totalPaidAmount = 0, totalUnpaidAmount = 0, totalFutureAmount = 0;
                const RATE = 300;
                
                const monthlyChartStats = months.map(m => ({ ...m, paid: 0, unpaid: 0, waiting: 0 }));
                const overdueMap = {};
                const soiOverdueMap = {}; 

                filteredData.forEach(item => {
                    let itemOverdueCount = 0; 
                    let itemOverdueAmount = 0;

                    months.forEach((m, idx) => {
                        const status = item[m.key] || '';
                        
                        // Logic for Chart (counts)
                        if (status.includes('จ่ายแล้ว') || status.includes('ชำระแล้ว')) {
                            monthlyChartStats[idx].paid++;
                        } else if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) {
                            monthlyChartStats[idx].unpaid++;
                        } else if (status.includes('รอข้อมูล') || status.includes('รอตรวจสอบ')) {
                            monthlyChartStats[idx].waiting++;
                        }

                        // Logic for Summary Cards (Amounts)
                        const isTargetMonth = monthFilter === 'all' || m.key === monthFilter;
                        if (isTargetMonth) {
                            if (status.includes('จ่ายแล้ว') || status.includes('ชำระแล้ว')) {
                                totalPaidAmount += RATE;
                            } else if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) {
                                totalUnpaidAmount += RATE;
                                itemOverdueCount++;
                                itemOverdueAmount += RATE;
                            } else if (status.includes('รอข้อมูล')) {
                                totalFutureAmount += RATE;
                            }
                        }
                    });

                    if (itemOverdueCount > 0) {
                        if (!overdueMap[item.house_numbe]) {
                            overdueMap[item.house_numbe] = { 
                                houseNo: item.house_numbe, 
                                totalMonths: 0, 
                                totalAmount: 0 
                            };
                        }
                        overdueMap[item.house_numbe].totalMonths += itemOverdueCount;
                        overdueMap[item.house_numbe].totalAmount += (itemOverdueCount * RATE);
                    }

                    if (itemOverdueAmount > 0) {
                        const soiName = item.soi ? item.soi.trim() : 'ไม่ระบุซอย';
                        if (!soiOverdueMap[soiName]) {
                            soiOverdueMap[soiName] = 0;
                        }
                        soiOverdueMap[soiName] += itemOverdueAmount;
                    }
                });

                const totalExpected = totalPaidAmount + totalUnpaidAmount + totalFutureAmount;
                const paidPercentage = totalExpected > 0 ? (totalPaidAmount / totalExpected) * 100 : 0;
                const overdueList = Object.values(overdueMap).sort((a, b) => b.totalAmount - a.totalAmount);
                const soiList = Object.entries(soiOverdueMap)
                    .map(([name, amount]) => ({ name, amount }))
                    .sort((a, b) => b.amount - a.amount);

                return { 
                    totalHouses, totalPaidAmount, totalUnpaidAmount, totalFutureAmount, 
                    paidPercentage, monthlyChartStats, overdueList, soiList 
                };
            }, [filteredRawData, yearFilter, monthFilter]);

            const availableYears = useMemo(() => [...new Set(filteredRawData.map(d => d.year))].sort((a,b) => b-a), [filteredRawData]);

            // Export to CSV Function
            const exportToCSV = () => {
                if (!stats || !stats.overdueList) return;
                
                // Define CSV header
                const headers = ["บ้านเลขที่", "จำนวนเดือนที่ค้าง", "ยอดรวม (บาท)"];
                
                // Map data to rows
                const rows = stats.overdueList.map(item => [
                    item.houseNo,
                    item.totalMonths,
                    item.totalAmount
                ]);

                // Create CSV content with BOM for Excel support (Thai)
                const csvContent = "\uFEFF" + 
                    [headers.join(","), ...rows.map(e => e.join(","))].join("\n");

                // Create download link
                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `overdue_report_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (loading) return <div className="flex flex-col items-center justify-center py-20 text-white"><Loader2 size={48} className="animate-spin mb-4" /><p>กำลังคำนวณข้อมูลภาพรวม...</p></div>;
            if (!stats) return <div className="text-center py-20 text-white"><p>ไม่พบข้อมูล</p></div>;

            return (
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-up">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-bold text-white mb-2 drop-shadow-md flex items-center justify-center gap-3"><LayoutDashboard size={32} /> สรุปภาพรวมโครงการ</h2>
                        <p className="text-indigo-100">ข้อมูลสถิติการชำระค่าส่วนกลางทั้งหมด</p>
                    </div>

                    {/* Filter Bar & Export */}
                    <div className="bg-white/10 backdrop-blur-md p-4 rounded-2xl mb-8 flex flex-col md:flex-row gap-4 items-center justify-between border border-white/20 shadow-lg">
                        <div className="flex flex-col md:flex-row gap-4 items-center">
                            <div className="flex items-center gap-2 text-white font-medium"><Filter size={20} /> ตัวกรอง:</div>
                            <div className="flex gap-2">
                                <select 
                                    value={yearFilter} 
                                    onChange={(e) => setYearFilter(e.target.value)}
                                    className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-slate-700 dark:text-white"
                                >
                                    <option value="all">ทุกปี</option>
                                    {availableYears.map(y => <option key={y} value={y}>ปี {y}</option>)}
                                </select>
                                <select 
                                    value={monthFilter} 
                                    onChange={(e) => setMonthFilter(e.target.value)}
                                    className="bg-white/90 text-slate-800 px-4 py-2 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-slate-700 dark:text-white"
                                >
                                    <option value="all">ทุกเดือน</option>
                                    {months.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                                </select>
                            </div>
                        </div>
                        <button 
                            onClick={exportToCSV}
                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-md transition-colors flex items-center gap-2"
                        >
                            <Download size={18} /> Export Excel
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Coins size={60} className="text-green-600" /></div>
                            <span className="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">ยอดจัดเก็บได้ (บาท)</span>
                            <h3 className="text-2xl font-bold text-green-600 dark:text-green-400">{stats.totalPaidAmount.toLocaleString()}</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-lg">{stats.paidPercentage.toFixed(1)}% ของยอดทั้งหมด</div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><AlertCircle size={60} className="text-red-600" /></div>
                            <span className="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">ยอดค้างชำระ (บาท)</span>
                            <h3 className="text-2xl font-bold text-red-500 dark:text-red-400">{stats.totalUnpaidAmount.toLocaleString()}</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 rounded-lg">ต้องติดตาม</div>
                        </div>
                         <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Hourglass size={60} className="text-yellow-600" /></div>
                            <span className="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">ยอดรอเก็บ (อนาคต)</span>
                            <h3 className="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{stats.totalFutureAmount.toLocaleString()}</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300 rounded-lg">รอข้อมูล</div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group hover:-translate-y-1 transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Home size={60} className="text-blue-600" /></div>
                            <span className="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">จำนวนบ้าน ({yearFilter === 'all' ? 'รวม' : yearFilter})</span>
                            <h3 className="text-2xl font-bold text-slate-800 dark:text-white">{stats.totalHouses} หลัง</h3>
                            <div className="mt-2 text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 rounded-lg">ในระบบ</div>
                        </div>
                    </div>
                    
                    <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 dark:border-slate-700 mb-8">
                        <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"><BarChart3 className="text-indigo-500" /> สถิติการชำระรายเดือน ({yearFilter === 'all' ? 'รวม' : yearFilter})</h3>
                        <div className="h-64 flex items-end justify-between gap-2 md:gap-4 overflow-x-auto pb-2">
                            {stats.monthlyChartStats.map((m, idx) => {
                                const total = stats.totalHouses || 1;
                                const paidHeight = (m.paid / total) * 100;
                                const unpaidHeight = (m.unpaid / total) * 100;
                                const waitingHeight = (m.waiting / total) * 100;
                                
                                return (
                                    <div key={idx} className="flex flex-col items-center gap-2 h-full justify-end flex-1 min-w-[40px]">
                                        <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-t-lg relative flex flex-col justify-end overflow-hidden h-full">
                                            <div className="bg-red-400 w-full transition-all duration-1000 ease-out hover:bg-red-500 relative group" style={{ height: `${unpaidHeight}%` }}>
                                                {m.unpaid > 0 && <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none z-10">ค้าง {m.unpaid}</div>}
                                            </div>
                                            <div className="bg-yellow-400 w-full transition-all duration-1000 ease-out hover:bg-yellow-500 relative group" style={{ height: `${waitingHeight}%` }}>
                                                {m.waiting > 0 && <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none z-10">รอ {m.waiting}</div>}
                                            </div>
                                            <div className="bg-green-500 w-full transition-all duration-1000 ease-out hover:bg-green-600 relative group" style={{ height: `${paidHeight}%` }}>
                                                {m.paid > 0 && <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none z-10">จ่าย {m.paid}</div>}
                                            </div>
                                        </div>
                                        <span className="text-xs font-bold text-slate-500 dark:text-slate-400">{m.label}</span>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="flex justify-center gap-4 mt-6 text-xs font-medium text-slate-600 dark:text-slate-400 flex-wrap">
                            <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-green-500 rounded-sm"></div> จ่ายแล้ว</div>
                            <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-yellow-400 rounded-sm"></div> รอข้อมูล</div>
                            <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-red-400 rounded-sm"></div> ค้างชำระ</div>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 dark:border-slate-700 mb-8">
                        <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                            <FileWarning className="text-red-500" /> รายชื่อค้างชำระ ({stats.overdueList.length} รายการ)
                        </h3>
                        <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="px-4 py-3 rounded-tl-lg">บ้านเลขที่</th>
                                        <th className="px-4 py-3 text-center">จำนวนเดือน</th>
                                        <th className="px-4 py-3 text-right rounded-tr-lg">ยอดรวม (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300">
                                    {stats.overdueList.length > 0 ? (
                                        stats.overdueList.map((house, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                                <td className="px-4 py-3 font-medium flex items-center gap-2">
                                                    <Home size={16} className="text-slate-400" /> {house.houseNo}
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className="bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 px-2 py-1 rounded-md text-xs font-bold">
                                                        {house.totalMonths} เดือน
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right font-bold text-red-600 dark:text-red-400">
                                                    ฿{house.totalAmount.toLocaleString()}
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan="3" className="px-4 py-8 text-center text-slate-400">
                                                <div className="flex flex-col items-center gap-2">
                                                    <CheckCircle size={32} className="text-green-400" />
                                                    <span>ไม่พบรายการค้างชำระในช่วงเวลานี้</span>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                     {/* Soi Ranking Section */}
                    <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100 dark:border-slate-700">
                        <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                            <MapPin className="text-orange-500" /> อันดับยอดค้างชำระแยกตามซอย
                        </h3>
                        {stats.soiList.length > 0 ? (
                            <div className="space-y-4">
                                {stats.soiList.map((soi, index) => {
                                    const maxAmount = stats.soiList[0].amount;
                                    const percentage = (soi.amount / maxAmount) * 100;
                                    return (
                                        <div key={index} className="flex items-center gap-4">
                                            <div className="w-20 text-sm font-bold text-slate-600 dark:text-slate-300 shrink-0">{soi.name}</div>
                                            <div className="flex-1 h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden relative">
                                                <div 
                                                    className="h-full bg-gradient-to-r from-orange-400 to-red-500 rounded-full relative"
                                                    style={{ width: `${percentage}%` }}
                                                ></div>
                                            </div>
                                            <div className="w-24 text-right text-sm font-bold text-red-600 dark:text-red-400 shrink-0">฿{soi.amount.toLocaleString()}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center py-8 text-slate-400">ไม่พบข้อมูลยอดค้างชำระ</div>
                        )}
                    </div>
                </div>
            );
        };

        const HomeContent = ({ payments, loading, error, supabase, openDetailModal, handleSyncStatus, handlePrint, toggleNameVisibility, visibleNames, syncingId, allPendingFees }) => {
            if (!supabase) return <div className="text-center py-20 no-print"><div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div><p className="text-white/80 animate-pulse">กำลังเชื่อมต่อระบบฐานข้อมูล...</p></div>;
            if (loading) return <div className="text-center py-20 flex flex-col items-center no-print"><div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-white/30 border-t-white mb-4"></div><p className="text-white/80 animate-pulse font-medium">กำลังตรวจสอบและอัปเดตข้อมูลล่าสุด...</p></div>;
            if (error) return <div className="max-w-md mx-auto bg-red-500/10 backdrop-blur border border-red-500/30 p-4 rounded-xl text-center text-white no-print"><AlertCircle className="mx-auto mb-2 text-red-300" size={32} /><p>{error}</p></div>;
            
            if (payments.length === 0) {
                return (
                    <div className="py-12 px-4 no-print animate-fade-up">
                        <div className="max-w-4xl mx-auto bg-white/10 dark:bg-slate-800/50 backdrop-blur-lg rounded-3xl border border-white/20 p-8 md:p-12 shadow-2xl">
                            <div className="text-center mb-12">
                                <div className="bg-indigo-500/20 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_15px_rgba(99,102,241,0.5)] border border-indigo-400/30"><Home className="text-white w-12 h-12" /></div>
                                <h3 className="text-3xl font-bold text-white mb-4 drop-shadow-lg">ยินดีต้อนรับสู่ระบบตรวจสอบ</h3>
                                <p className="text-indigo-100 text-lg max-w-2xl mx-auto font-light">ระบบช่วยอำนวยความสะดวกในการตรวจสอบสถานะค่าส่วนกลาง<br className="hidden md:block"/>ของหมู่บ้าน โกลเด้นแลนด์ ซีรีน อย่างรวดเร็วและแม่นยำ</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50 dark:border-slate-700"><div className="bg-blue-100 dark:bg-blue-900/30 p-3.5 rounded-xl text-blue-600 dark:text-blue-400 shadow-inner"><Search size={28} /></div><div><h4 className="font-bold text-slate-800 dark:text-white text-xl mb-1">ค้นหาข้อมูลรวดเร็ว</h4><p className="text-slate-600 dark:text-slate-300 text-sm">เพียงพิมพ์เลขที่บ้านก็สามารถตรวจสอบข้อมูลได้ทันที รองรับการค้นหาที่แม่นยำ</p></div></div>
                                <div className="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50 dark:border-slate-700"><div className="bg-green-100 dark:bg-green-900/30 p-3.5 rounded-xl text-green-600 dark:text-green-400 shadow-inner"><RefreshCw size={28} /></div><div><h4 className="font-bold text-slate-800 dark:text-white text-xl mb-1">อัพเดทเรียลไทม์</h4><p className="text-slate-600 dark:text-slate-300 text-sm">ข้อมูลสถานะรายเดือนและประวัติการแจ้งชำระ เชื่อมต่อฐานข้อมูลโดยตรง</p></div></div>
                                <div className="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50 dark:border-slate-700"><div className="bg-orange-100 dark:bg-orange-900/30 p-3.5 rounded-xl text-orange-600 dark:text-orange-400 shadow-inner"><AlertTriangle size={28} /></div><div><h4 className="font-bold text-slate-800 dark:text-white text-xl mb-1">แจ้งเตือนอัตโนมัติ</h4><p className="text-slate-600 dark:text-slate-300 text-sm">ระบบตรวจสอบและแจ้งเตือนทันทีหากมียอดค้างชำระ หรืออยู่ในสถานะรอตรวจสอบ</p></div></div>
                                <div className="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 flex items-start gap-4 shadow-xl border border-white/50 dark:border-slate-700"><div className="bg-purple-100 dark:bg-purple-900/30 p-3.5 rounded-xl text-purple-600 dark:text-purple-400 shadow-inner"><FileText size={28} /></div><div><h4 className="font-bold text-slate-800 dark:text-white text-xl mb-1">ประวัติโปร่งใส</h4><p className="text-slate-600 dark:text-slate-300 text-sm">ตรวจสอบรายละเอียด หลักฐานสลิปโอนเงิน และประวัติย้อนหลังได้ทุกรายการ</p></div></div>
                            </div>
                            <div className="mt-10 text-center"><span className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/20 text-white text-sm font-medium backdrop-blur border border-white/30 animate-pulse"><Sparkles size={16} /> เริ่มต้นใช้งานโดยพิมพ์เลขที่บ้านด้านบน</span></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    {payments.map((item, index) => {
                        const financials = calculateFinancials(item);
                        const headerStyle = getHeaderStyle(financials);
                        const itemKey = getItemKey(item);
                        const isNameVisible = visibleNames[itemKey];
                        const isSyncing = syncingId === itemKey;
                        
                        // --- Duplicate Logic Here ---
                        const housePendingFees = allPendingFees.filter(f => (f.house_number || '').trim() === (item.house_numbe || '').trim());
                        const pendingTotal = housePendingFees.reduce((sum, f) => sum + (f.amount || 0), 0);
                        
                        // Count duplicates (month + year)
                        const feeCounts = housePendingFees.reduce((acc, fee) => {
                            const key = `${fee.month} ${fee.year}`;
                            acc[key] = (acc[key] || 0) + 1;
                            return acc;
                        }, {});

                        const yearBadgeStyle = getYearBadgeStyle(item.year);

                        return (
                            <div key={itemKey} className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 dark:border-slate-700 flex flex-col print-container animate-fade-up" style={{ animationDelay: `${index * 100}ms` }}>
                                <div className={`${headerStyle.bg} px-5 py-4 border-b ${headerStyle.border} flex justify-between items-start transition-colors duration-300`}>
                                    <div><h3 className={`text-2xl font-bold flex items-center gap-2 ${headerStyle.text}`}><Home className={headerStyle.text} size={24} /> {item.house_numbe}</h3>
                                    {/* --- Updated Year Badge --- */}
                                    <div className={`text-base mt-2 font-bold px-4 py-1.5 rounded-full w-fit backdrop-blur-md border border-white/30 shadow-md ${yearBadgeStyle}`}>
                                        ปี {item.year}
                                    </div>
                                    </div>
                                    <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg whitespace-nowrap bg-white text-slate-800`}>{React.cloneElement(headerStyle.icon, { className: 'text-slate-700' })} <span className="text-slate-700">{headerStyle.statusText}</span></div>
                                </div>
                                <div className="p-5 bg-white dark:bg-slate-800 flex-1 flex flex-col">
                                    {housePendingFees.length > 0 && (
                                        <div onClick={() => openDetailModal(item)} className="mb-5 bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-900/30 dark:to-amber-900/30 border border-orange-200 dark:border-orange-800 rounded-xl p-3 flex items-start justify-between shadow-sm animate-pulse cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors no-print" title="คลิกเพื่อดูรายละเอียด">
                                            <div className="flex items-start gap-3">
                                                <div className="bg-white dark:bg-slate-700 p-2 rounded-full shadow-sm text-orange-500"><Bell size={20} /></div>
                                                <div>
                                                    <h5 className="text-sm font-bold text-orange-800 dark:text-orange-300 mb-1">แจ้งโอนใหม่ รอตรวจสอบ</h5>
                                                    <div className="flex flex-wrap gap-1">
                                                        {housePendingFees.map((fee, idx) => {
                                                            const key = `${fee.month} ${fee.year}`;
                                                            const isDuplicate = feeCounts[key] > 1;
                                                            // Highlight Style if Duplicate
                                                            const badgeClass = isDuplicate 
                                                                ? "bg-red-600 text-white border-red-700 font-bold ring-2 ring-red-300 shadow-md" 
                                                                : "bg-white/80 dark:bg-slate-700/80 text-orange-700 dark:text-orange-300 border border-orange-100 dark:border-orange-800 font-medium";

                                                            return (
                                                                <span key={idx} className={`text-[10px] px-2 py-0.5 rounded flex items-center gap-1 ${badgeClass}`}>
                                                                    {fee.month} {fee.year}
                                                                    {isDuplicate && <span className="bg-white text-red-600 rounded-full px-1 text-[8px] font-extrabold ml-1">!</span>}
                                                                </span>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right pl-2 whitespace-nowrap"><span className="text-[10px] text-orange-600 dark:text-orange-400 font-semibold block">ยอดรวม</span><h4 className="text-lg font-bold text-orange-800 dark:text-orange-300">฿{pendingTotal.toLocaleString()}</h4></div>
                                        </div>
                                    )}
                                    <SummaryChart financials={financials} />
                                    <div className="mb-5 pb-4 border-b border-slate-100 dark:border-slate-700 space-y-2">
                                        <div className="flex items-center justify-between gap-2 font-bold text-lg text-slate-800 dark:text-white"><div className="flex items-center gap-2"><User size={18} className="text-blue-500" /><span>{isNameVisible ? item.owner_name : maskName(item.owner_name)}</span></div><button onClick={() => toggleNameVisibility(itemKey)} className="text-slate-400 hover:text-blue-600 dark:text-slate-500 dark:hover:text-blue-400 transition-colors p-1 rounded-full hover:bg-blue-50 dark:hover:bg-slate-700 no-print" title={isNameVisible ? "ซ่อนชื่อ" : "แสดงชื่อเต็ม"}>{isNameVisible ? <EyeOff size={18} /> : <Eye size={18} />}</button></div>
                                        <div className="grid grid-cols-1 gap-1.5 text-sm">
                                            <div className="flex justify-between items-center"><span className="text-slate-500 dark:text-slate-400">🏠 บ้านเลขที่ :</span><span className="font-medium text-slate-700 dark:text-slate-300">{item.house_numbe}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500 dark:text-slate-400">📍 ซอย :</span><span className="font-medium text-slate-700 dark:text-slate-300">{item.soi || '-'}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500 dark:text-slate-400">📅 วันโอน :</span><span className="font-medium text-slate-700 dark:text-slate-300">{item.transfer_date || '-'}</span></div>
                                            <div className="flex justify-between items-center"><span className="text-slate-500 dark:text-slate-400">📊 สถานะเริ่มต้น :</span><span className={`font-medium text-slate-700 dark:text-slate-300`}>{item.status || '-'}</span></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mb-4 no-print"><button onClick={() => openDetailModal(item)} className="flex-1 py-2.5 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 font-bold text-sm flex items-center justify-center gap-2 transition-colors duration-200 border border-indigo-100 dark:border-indigo-800 shadow-sm"><FileText size={18} /><span>ดูรายละเอียดการแจ้งโอน</span></button><button onClick={handlePrint} className="flex-none px-4 py-2.5 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors border border-slate-200 dark:border-slate-600" title="พิมพ์รายงาน"><Printer size={18} /></button></div>
                                    <div className="mb-3 font-bold text-slate-700 dark:text-slate-300 flex items-center justify-between">
                                        <div className="flex items-center gap-2"><Clock size={16} className="text-blue-500" /> สถานะรายเดือน ({item.year})</div>
                                        {/* Button removed */}
                                    </div>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {months.map((month) => {
                                            const status = item[month.key];
                                            const colorClass = getStatusColor(status);
                                            return (<div key={month.key} className={`flex flex-col items-center justify-center p-2 rounded-lg border ${colorClass} min-h-[50px]`}><span className="text-[10px] font-bold uppercase opacity-60 mb-1">{month.label}</span><span className="text-[11px] font-semibold text-center leading-tight break-words w-full">{status || '-'}</span></div>);
                                        })}
                                    </div>
                                    <div className="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700 mb-0 mt-auto">
                                        <div className="flex items-center gap-1 text-xs font-bold text-slate-400 dark:text-slate-500 mb-2"><Coins size={12} />สรุปยอดเงิน (300 บ./เดือน)</div>
                                        <div className="flex justify-between items-center text-xs">
                                            <div className="flex flex-col items-center flex-1 border-r border-slate-200 dark:border-slate-600"><span className="text-green-600 dark:text-green-400 font-bold text-sm">฿{financials.paid.toLocaleString()}</span><span className="text-slate-400 dark:text-slate-500">จ่ายแล้ว</span></div>
                                            <div className="flex flex-col items-center flex-1 border-r border-slate-200 dark:border-slate-600"><span className="text-red-500 dark:text-red-400 font-bold text-sm">฿{financials.overdue.toLocaleString()}</span><span className="text-slate-400 dark:text-slate-500">ค้างชำระ</span></div>
                                            <div className="flex flex-col items-center flex-1"><span className="text-yellow-600 dark:text-yellow-400 font-bold text-sm">฿{financials.future.toLocaleString()}</span><span className="text-slate-400 dark:text-slate-500">รอข้อมูล</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [searchTerm, setSearchTerm] = useState('');
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [supabase, setSupabase] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showScrollTop, setShowScrollTop] = useState(false);
            
            const [allPendingFees, setAllPendingFees] = useState([]);
            const [visibleNames, setVisibleNames] = useState({});
            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [selectedHouse, setSelectedHouse] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            const [historyLoading, setHistoryLoading] = useState(false);
            const [pdfModalOpen, setPdfModalOpen] = useState(false);
            const [selectedPdfUrl, setSelectedPdfUrl] = useState(null);
            const [imageModalOpen, setImageModalOpen] = useState(false);
            const [selectedImageUrl, setSelectedImageUrl] = useState(null);
            const [syncingId, setSyncingId] = useState(null);
            const [isAutoSyncing, setIsAutoSyncing] = useState(false); 
            const [showThankYouModal, setShowThankYouModal] = useState(false);
            const [showOverdueModal, setShowOverdueModal] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            
            // --- New Config State ---
            const [appConfig, setAppConfig] = useState({
                useManual: false,
                manualYears: []
            });
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            
            // Add state for Result Modal
            const [resultModal, setResultModal] = useState({ isOpen: false, type: 'success', message: '' });

            useEffect(() => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.async = true;
                script.onload = () => { 
                    if (window.supabase) {
                        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        setSupabase(client);
                        fetchConfig(client);
                    }
                };
                document.body.appendChild(script);
                const handleScroll = () => setShowScrollTop(window.scrollY > 300);
                window.addEventListener('scroll', handleScroll);
                
                return () => {
                    if (document.body.contains(script)) document.body.removeChild(script);
                    window.removeEventListener('scroll', handleScroll);
                };
            }, []);

            // Toggle Dark Mode
            const toggleDarkMode = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                if (newMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };

            const fetchConfig = async (client) => {
                try {
                    const { data, error } = await client
                        .from('app_settings')
                        .select('config')
                        .eq('id', 1)
                        .single();
                    
                    if (data && data.config) {
                        setAppConfig(data.config);
                    }
                } catch (err) {
                    console.error('Error fetching config from DB, using default.', err);
                }
            };

            const saveConfig = async (newConfig) => {
                if (!supabase) return;
                setIsSaving(true);
                try {
                    if (supabase) {
                        const { error } = await supabase
                            .from('app_settings')
                            .upsert({ id: 1, config: newConfig });

                        if (error) throw error;
                    }
                    
                    // Success path
                    setAppConfig(newConfig);
                    localStorage.setItem('house_payment_config', JSON.stringify(newConfig));
                    setShowAdminPanel(false);
                    // Refresh data to apply filter
                    if (searchTerm && currentPage === 'home') handleSearchClick();
                } catch (err) {
                    console.error('Error saving config:', err);
                    if (err.code === '42501') {
                         // RLS Error handling
                         setResultModal({ 
                            isOpen: true, 
                            type: 'error', 
                            message: 'ไม่สามารถบันทึกลงฐานข้อมูลได้ (ติดสิทธิ์ RLS) ระบบจะบันทึกลงในเครื่องแทน'
                        });
                        // Still save locally
                        setAppConfig(newConfig);
                        localStorage.setItem('house_payment_config', JSON.stringify(newConfig));
                        setShowAdminPanel(false);
                        if (searchTerm && currentPage === 'home') handleSearchClick();
                    } else {
                        // Other errors
                        alert('บันทึกการตั้งค่าไม่สำเร็จ: ' + err.message);
                    }
                } finally {
                    setIsSaving(false);
                }
            };

            const handleAdminUpdateStatus = async (targetYear, targetMonthKey) => {
                if (!supabase) return;
                setIsSaving(true); // Reuse loading state
                try {
                    // 1. Fetch rows that need update (Wait for data)
                    const { data: rowsToUpdate, error: fetchError } = await supabase
                        .from('house_payments')
                        .select('*')
                        .eq('year', targetYear);
                    
                    if (fetchError) throw fetchError;

                    let updatedCount = 0;
                    
                    // 2. Filter in JS (to be safe and handle 'รอข้อมูล' or null)
                    for (const row of rowsToUpdate) {
                        const currentStatus = row[targetMonthKey];
                        if (!currentStatus || currentStatus === 'รอข้อมูล') {
                            // 3. Update individually (or batch if needed, but individual is safer for composite keys logic without primary key known easily)
                            const { error: updateError } = await supabase
                                .from('house_payments')
                                .update({ [targetMonthKey]: 'ยังไม่จ่าย' })
                                .eq('house_numbe', row.house_numbe) // Assuming unique per year/house
                                .eq('year', targetYear);
                            
                            if (!updateError) updatedCount++;
                        }
                    }

                    setResultModal({
                        isOpen: true,
                        type: 'success',
                        message: `อัพเดทสถานะเรียบร้อยแล้ว จำนวน ${updatedCount} รายการ`
                    });
                    
                    // Refresh if needed
                    if (searchTerm && currentPage === 'home') handleSearchClick();

                } catch (err) {
                     console.error('Update status error:', err);
                     setResultModal({
                        isOpen: true,
                        type: 'error',
                        message: 'เกิดข้อผิดพลาด: ' + err.message
                    });
                } finally {
                    setIsSaving(false);
                }
            };


            const sendTelegramNotification = async (houseNo, searchResults) => {
                try {
                    if (!searchResults || searchResults.length === 0) return;
                    
                    // Check if token is the placeholder or likely invalid
                    if (!TELEGRAM_TOKEN || TELEGRAM_TOKEN.length < 10) {
                         console.warn("Telegram token is missing or invalid.");
                         return;
                    }

                    // Function to escape HTML special characters
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        return String(text)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    };

                    let message = `🏠 <b>ข้อมูลการค้นหา</b>\n📍 บ้านเลขที่: <b>${escapeHtml(houseNo)}</b>\n📊 พบข้อมูล: <b>${searchResults.length} รายการ</b>\n\n`;
                    
                    searchResults.forEach((item, index) => {
                        let paidCount = 0, overdueCount = 0, advanceCount = 0, waitingCount = 0; const RATE = 300;
                        const monthlyStatus = months.map(m => {
                            const status = item[m.key] || '';
                            let emoji = '❓';
                            if (status.includes('จ่ายแล้ว') || status.includes('ชำระแล้ว')) { emoji = '✅'; paidCount++; }
                            else if (status.includes('ล่วงหน้า')) { emoji = '🔄'; advanceCount++; }
                            else if (status.includes('ยังไม่จ่าย') || status.includes('ค้าง')) { emoji = '❌'; overdueCount++; }
                            else if (status.includes('รอข้อมูล') || status.includes('รอตรวจสอบ')) { emoji = '⏳'; waitingCount++; }
                            else if (status.includes('ไม่เก็บ')) { emoji = '⭕'; }
                            return `${emoji} ${m.label}`;
                        }).join(' ');
                        const totalPaid = paidCount * RATE, totalUnpaid = overdueCount * RATE, totalAdvance = advanceCount * RATE;
                        
                        let alertStatusText = 'ปกติ';
                        if (overdueCount > 0) alertStatusText = `ค้างชำระ ${overdueCount} เดือน`;
                        else if (waitingCount > 0) alertStatusText = 'รอตรวจสอบ';
                        else if (paidCount > 0 || advanceCount > 0) alertStatusText = 'ชำระครบถ้วน';
                        
                        message += `📋 <b>รายการที่ ${index + 1} (ปี ${item.year})</b>\n`;
                        message += `👤 ชื่อ: ${escapeHtml(item.owner_name || '-')}\n`;
                        message += `🏘️ ซอย: ${escapeHtml(item.soi || '-')}\n`;
                        message += `📅 วันโอน: ${escapeHtml(item.transfer_date || '-')}\n`;
                        message += `📊 สถานะ: ${escapeHtml(item.status || '-')}\n`;
                        message += `⚠️ สถานะการแจ้งเตือน: <b>${escapeHtml(alertStatusText)}</b>\n`;
                        message += `💰 <b>สรุปการเงิน:</b>\n`;
                        message += `✅ จ่ายแล้ว: ${totalPaid.toLocaleString()} บาท\n`;
                        message += `❌ ค้างชำระ: ${totalUnpaid.toLocaleString()} บาท\n`;
                        message += `🔄 ล่วงหน้า: ${totalAdvance.toLocaleString()} บาท\n`;
                        message += `📅 <b>สถานะรายเดือน:</b>\n${monthlyStatus}\n`;
                        
                        if (index < searchResults.length - 1) message += '\n' + '─'.repeat(20) + '\n\n';
                    });
                    
                    message += `\n🕐 เวลาค้นหา: ${new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', dateStyle: 'medium', timeStyle: 'medium' })}`;
                    
                    const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN.trim()}/sendMessage`;
                    
                    const response = await fetch(telegramUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ 
                            chat_id: TELEGRAM_CHAT_ID, 
                            text: message, 
                            parse_mode: 'HTML' 
                        }) 
                    });
                    
                    if (response.status === 401) {
                         console.warn("Telegram Error: Unauthorized (401). Please check your TELEGRAM_TOKEN.");
                         return;
                    }

                    const data = await response.json();
                    if (!data.ok) {
                        console.warn('Telegram API Error:', data);
                    }
                } catch (error) { console.error('Telegram Network Error:', error); }
            };

            const saveSearchLog = async (houseNo) => {
                if (!supabase || !houseNo) return;
                try {
                    const { error } = await supabase
                        .from('search_logs')
                        .insert([{ house_number: houseNo }]);
                    
                    if (error) {
                         console.error('Error saving search log to DB:', error);
                    }
                } catch (err) {
                    console.error('Exception saving search log:', err);
                }
            };

            const syncHouseLogic = async (item) => {
                if (!supabase) return false;
                try {
                    const { data: feeHistory, error: feeError } = await supabase.from('common_fees').select('*').eq('house_number', item.house_numbe).eq('year', item.year).order('reported_at', { ascending: true });
                    if (feeError) throw feeError;
                    if (feeHistory && feeHistory.length > 0) {
                        let updates = {}, hasUpdates = false;
                        feeHistory.forEach(fee => {
                            const monthCol = monthMap[fee.month];
                            if (monthCol) {
                                const currentStatus = item[monthCol];
                                const isPending = (fee.status.includes('รอ') || fee.status.includes('ตรวจสอบ') || fee.status.includes('แจ้งโอน')) && !fee.status.includes('แล้ว');
                                const isPaid = fee.status.includes('ตรวจสอบแล้ว') || fee.status.includes('อนุมัติ') || fee.status.includes('ถูกต้อง');
                                if (isPending && currentStatus !== 'รอตรวจสอบ') { updates[monthCol] = 'รอตรวจสอบ'; hasUpdates = true; }
                                else if (isPaid && currentStatus !== 'จ่ายแล้ว') { updates[monthCol] = 'จ่ายแล้ว'; hasUpdates = true; }
                            }
                        });
                        if (hasUpdates) { await supabase.from('house_payments').update(updates).eq('house_numbe', item.house_numbe).eq('year', item.year); return true; }
                    }
                    return false;
                } catch (err) { console.error(err); return false; }
            };

            const fetchPayments = async (search = '', autoSync = false) => {
                if (!supabase) return [];
                setLoading(true);
                try {
                    let query = supabase.from('house_payments').select('*');
                    if (search) query = query.or(`house_numbe.ilike.%${search}%,owner_name.ilike.%${search}%`);
                    const { data, error } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });
                    if (error) throw error;
                    
                    let finalData = data || [];
                    if (search) {
                        const lowerSearch = search.trim().toLowerCase();
                        const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
                        if (exactMatches.length > 0) finalData = exactMatches;
                    }
                    
                    // --- APPLY CONFIG FILTER ---
                    const currentThaiYear = new Date().getFullYear() + 543;
                    finalData = finalData.filter(item => {
                        const y = parseInt(item.year);
                        if (appConfig.useManual) {
                            return appConfig.manualYears.includes(y);
                        } else {
                            // Default Mode: Hide future years
                            return y <= currentThaiYear;
                        }
                    });

                    if (autoSync && finalData.length > 0) {
                        const syncPromises = finalData.map(async (item) => await syncHouseLogic(item));
                        const results = await Promise.all(syncPromises);
                        if (results.some(r => r === true)) {
                            const { data: refreshedData } = await query.order('year', { ascending: false }).order('house_numbe', { ascending: true });
                            if (refreshedData) finalData = refreshedData;
                            if (search) {
                                const lowerSearch = search.trim().toLowerCase();
                                const exactMatches = finalData.filter(item => item.house_numbe.toLowerCase() === lowerSearch);
                                if (exactMatches.length > 0) finalData = exactMatches;
                            }
                        }
                    }
                    setPayments(finalData);
                    return finalData;
                } catch (err) { setError('ไม่สามารถเชื่อมต่อฐานข้อมูลได้'); return []; } finally { setLoading(false); }
            };

            const fetchAllPendingFees = async () => {
                if (!supabase) return;
                const { data } = await supabase.from('common_fees').select('*').eq('status', 'รอตรวจสอบ');
                setAllPendingFees(data || []);
            };

            const handleSyncStatus = async (item) => {
                const itemKey = getItemKey(item);
                setSyncingId(itemKey);
                try {
                    await syncHouseLogic(item);
                    await Promise.all([fetchPayments(searchTerm, false), fetchAllPendingFees()]);
                } catch (err) { 
                    setResultModal({ isOpen: true, type: 'error', message: 'เกิดข้อผิดพลาดในการอัปเดตสถานะ' });
                } finally { setSyncingId(null); }
            };

            const fetchHistory = async (houseNumber) => {
                if (!supabase) return;
                setHistoryLoading(true);
                const { data } = await supabase.from('common_fees').select('*').eq('house_number', houseNumber).order('reported_at', { ascending: false });
                setHistoryData(data || []);
                setHistoryLoading(false);
            };

            // Handlers
            const openDetailModal = (item) => { setSelectedHouse(item); setDetailModalOpen(true); fetchHistory(item.house_numbe); };
            const closeDetailModal = () => { setDetailModalOpen(false); setSelectedHouse(null); setHistoryData([]); };
            const openPdfModal = (url) => { setSelectedPdfUrl(url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview')); setPdfModalOpen(true); };
            const closePdfModal = () => { setPdfModalOpen(false); setSelectedPdfUrl(null); };
            const openImageModal = (url) => { setSelectedImageUrl(url); setImageModalOpen(true); };
            const closeImageModal = () => { setImageModalOpen(false); setSelectedImageUrl(null); };
            const handlePrint = () => window.print();
            const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            const handleKeyDown = (e) => { if (e.key === 'Enter') handleSearchClick(); };
            const toggleNameVisibility = (key) => setVisibleNames(prev => ({ ...prev, [key]: !prev[key] }));

            const handleSearchClick = async () => {
                setLoading(true);
                
                // Save Log
                if (searchTerm.trim()) {
                    saveSearchLog(searchTerm.trim());
                }

                const results = await fetchPayments(searchTerm, true);
                await fetchAllPendingFees();
                if (results && results.length > 0) {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonthIdx = now.getMonth(); 

                    // Check overdue status with date logic
                    const hasIssue = results.some(item => {
                        const itemYear = parseInt(item.year);
                        if (isNaN(itemYear)) return false;
                        const compareYear = itemYear > 2400 ? currentYear + 543 : currentYear;

                        return months.some((m, idx) => {
                            let shouldCheck = false;
                            if (itemYear < compareYear) shouldCheck = true;
                            else if (itemYear === compareYear) {
                                if (idx <= currentMonthIdx) shouldCheck = true;
                            }

                            if (shouldCheck) {
                                const status = item[m.key] || '';
                                return status.includes('ยังไม่จ่าย') || status.includes('ค้าง') || status.includes('รอข้อมูล');
                            }
                            return false;
                        });
                    });

                    if (hasIssue) {
                        setShowOverdueModal(true);
                        setTimeout(() => setShowOverdueModal(false), 3000);
                    } else {
                        setShowThankYouModal(true);
                        // Trigger Confetti
                        if (window.confetti) {
                            window.confetti({
                                particleCount: 100,
                                spread: 70,
                                origin: { y: 0.6 }
                            });
                        }
                        setTimeout(() => setShowThankYouModal(false), 3000);
                    }
                }
                if (searchTerm.trim()) sendTelegramNotification(searchTerm, results);
            };

            return (
                <div className="min-h-screen text-slate-800">
                    <div className="fixed inset-0 -z-10 bg-gradient-to-br from-[#1e3c72] via-[#2a5298] via-[#667eea] via-[#764ba2] to-[#8e44ad]"></div>
                    <div className="fixed inset-0 -z-10 opacity-30 bg-[radial-gradient(circle_at_20%_80%,rgba(120,119,198,0.3),transparent_25%),radial-gradient(circle_at_80%_20%,rgba(255,255,255,0.2),transparent_25%)]"></div>

                    <nav className="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-lg text-white"><Home size={24} /></div><span className="text-white text-xl font-bold tracking-wide">🏡 ระบบตรวจสอบค่าส่วนกลาง</span></div>
                                <div className="hidden md:flex gap-4 items-center">
                                    <button onClick={() => setCurrentPage('home')} className={`px-4 py-2 rounded-full font-medium transition-all ${currentPage === 'home' ? 'bg-white text-indigo-600 shadow-md' : 'text-white/80 hover:bg-white/10'}`}><div className="flex items-center gap-2"><Search size={18} /> ค้นหา</div></button>
                                    <button onClick={() => setCurrentPage('dashboard')} className={`px-4 py-2 rounded-full font-medium transition-all ${currentPage === 'dashboard' ? 'bg-white text-indigo-600 shadow-md' : 'text-white/80 hover:bg-white/10'}`}><div className="flex items-center gap-2"><LayoutDashboard size={18} /> สรุปภาพรวม</div></button>
                                    <button onClick={toggleDarkMode} className="p-2 rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors" title="สลับโหมดมืด">{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                                    <button onClick={() => setShowAdminPanel(true)} className="p-2 rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors" title="ตั้งค่าระบบ"><Settings size={20} /></button>
                                </div>
                                <div className="md:hidden flex gap-2">
                                    <button onClick={toggleDarkMode} className="text-white p-2 hover:bg-white/10 rounded-lg">{darkMode ? <Sun size={24} /> : <Moon size={24} />}</button>
                                    <button onClick={() => setShowAdminPanel(true)} className="text-white p-2 hover:bg-white/10 rounded-lg"><Settings size={24} /></button>
                                    <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-white p-2 hover:bg-white/10 rounded-lg">{isMenuOpen ? <X size={24} /> : <Menu size={24} />}</button>
                                </div>
                            </div>
                        </div>
                        {isMenuOpen && (
                            <div className="md:hidden px-4 pb-4 animate-in slide-in-from-top-2">
                                <div className="flex flex-col gap-2 mb-4 bg-white/10 p-2 rounded-xl backdrop-blur-sm">
                                    <button onClick={() => { setCurrentPage('home'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium flex items-center gap-3 ${currentPage === 'home' ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'}`}><Search size={20} /> ค้นหาข้อมูล</button>
                                    <button onClick={() => { setCurrentPage('dashboard'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium flex items-center gap-3 ${currentPage === 'dashboard' ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'}`}><LayoutDashboard size={20} /> สรุปภาพรวมโครงการ</button>
                                    <button onClick={() => { setShowAdminPanel(true); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium flex items-center gap-3 text-white hover:bg-white/10`}><Settings size={20} /> ตั้งค่าระบบ</button>
                                </div>
                                {currentPage === 'home' && (
                                    <div className="flex gap-2"><div className="relative flex-1"><input type="text" placeholder="พิมพ์เลขที่บ้าน (เช่น 998/1)" className="w-full pl-10 pr-4 py-2 bg-white/90 rounded-lg text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={handleKeyDown} /><Search className="absolute left-3 top-2.5 text-slate-400" size={18} /></div><button onClick={handleSearchClick} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2">{isAutoSyncing ? <Loader2 size={18} className="animate-spin"/> : 'ค้นหา'}</button></div>
                                )}
                            </div>
                        )}
                    </nav>

                    <main>
                        {showAdminPanel ? (
                            <AdminPanel config={appConfig} onSave={saveConfig} onCancel={() => setShowAdminPanel(false)} isSaving={isSaving} onUpdateStatus={handleAdminUpdateStatus} />
                        ) : currentPage === 'dashboard' ? (
                            <Dashboard supabase={supabase} appConfig={appConfig} />
                        ) : (
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                                <div className="max-w-3xl mx-auto mb-10 text-center no-print">
                                    <h2 className="text-2xl md:text-4xl font-bold text-white mb-2 drop-shadow-md">🏡 ระบบตรวจสอบค่าส่วนกลาง</h2>
                                    <p className="text-indigo-100 text-lg mb-4 font-medium drop-shadow-sm">ตรวจสอบสถานะการชำระเงินค่าส่วนกลางได้อย่างง่ายดาย</p>
                                    <div className="mb-8 text-indigo-200 text-sm space-y-1"><p>✅ 1. ข้อมูลสถานะรายเดือน อัพเดทเรียลไทม์</p><p>✅ 2. ข้อมูลประวัติการแจ้งชำระ อัพเดทเรียลไทม์</p></div>
                                    <div className="flex flex-col sm:flex-row gap-3 items-stretch justify-center">
                                        <div className="relative group flex-1"><div className="absolute -inset-1 bg-gradient-to-r from-blue-400 to-purple-400 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-200"></div><div className="relative h-full"><input type="text" placeholder="พิมพ์เลขที่บ้าน (เช่น 998/1)" className="w-full h-full pl-12 pr-4 py-4 bg-white/95 backdrop-blur rounded-xl text-lg text-slate-900 placeholder-slate-400 shadow-xl focus:outline-none focus:ring-2 focus:ring-white/50" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={handleKeyDown} /><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={24} /></div></div>
                                        <button onClick={handleSearchClick} disabled={loading} className="bg-white/90 hover:bg-white text-indigo-600 font-bold px-8 py-4 sm:py-0 rounded-xl shadow-xl transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 backdrop-blur-sm border border-white/50 disabled:opacity-80 disabled:cursor-not-allowed">{isAutoSyncing ? <Loader2 size={24} className="animate-spin text-indigo-600" /> : <Search size={22} />}<span className="text-lg">{isAutoSyncing ? 'กำลังซิงค์...' : 'ค้นหา'}</span></button>
                                    </div>
                                </div>
                                <HomeContent 
                                    payments={payments} loading={loading} error={error} supabase={supabase}
                                    openDetailModal={openDetailModal} handleSyncStatus={handleSyncStatus} 
                                    handlePrint={handlePrint} toggleNameVisibility={toggleNameVisibility} 
                                    visibleNames={visibleNames} syncingId={syncingId} allPendingFees={allPendingFees} 
                                />
                            </div>
                        )}
                    </main>

                    {showScrollTop && <button onClick={scrollToTop} className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all animate-fade-up z-50 no-print" aria-label="Scroll to top"><ArrowUp size={24} /></button>}
                    
                    {/* --- ALL MODALS --- */}
                    {showThankYouModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-300 no-print"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div className="relative bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 animate-pop-in border-4 border-green-100"><div className="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-green-100 mb-6 shadow-inner"><ThumbsUp className="h-14 w-14 text-green-600" /></div><h3 className="text-2xl font-extrabold text-gray-900 mb-2">ขอบคุณครับ/ค่ะ!</h3><p className="text-gray-600 text-lg">ชำระค่าส่วนกลางครบถ้วนแล้ว</p><p className="text-sm text-green-600 mt-4 font-bold flex items-center justify-center gap-1"><Home size={14}/> หมู่บ้าน โกลเด้นแลนด์ ซีรีน</p></div></div>
                    )}
                    {showOverdueModal && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-300 no-print"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div className="relative bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 animate-pop-in border-4 border-red-100"><div className="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-red-100 mb-6 shadow-inner"><AlertTriangle className="h-14 w-14 text-red-600" /></div><h3 className="text-2xl font-extrabold text-gray-900 mb-2">แจ้งเตือนการชำระ</h3><p className="text-gray-600 text-lg">ยังมียอดค้างชำระ</p><p className="text-sm text-red-600 mt-4 font-bold flex items-center justify-center gap-1"><Home size={14}/> หมู่บ้าน โกลเด้นแลนด์ ซีรีน</p></div></div>
                    )}
                    {detailModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 no-print">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={closeDetailModal}></div>
                            <div className="relative bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col animate-in fade-in zoom-in-95 duration-200">
                                <div className="bg-gradient-to-r from-indigo-600 to-violet-600 px-6 py-4 flex justify-between items-center shrink-0 shadow-md"><div className="text-white"><h3 className="text-xl font-bold flex items-center gap-2"><Receipt className="text-indigo-200" /> ประวัติการแจ้งโอน</h3><p className="text-indigo-100 text-sm opacity-90 mt-1 flex items-center gap-1"><Home size={14} /> บ้านเลขที่ {selectedHouse?.house_numbe}</p></div><button onClick={closeDetailModal} className="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition-colors"><X size={24} /></button></div>
                                <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                                    {historyLoading ? <div className="flex flex-col items-center justify-center py-12 text-slate-400"><div className="animate-spin rounded-full h-10 w-10 border-4 border-indigo-200 border-t-indigo-600 mb-4"></div><p>กำลังโหลดข้อมูล...</p></div> : historyData.length === 0 ? <div className="flex flex-col items-center justify-center py-16 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-white"><FileText size={48} className="mb-4 opacity-20" /><p className="text-lg font-medium">ไม่พบประวัติการแจ้งโอน</p><p className="text-sm">ยังไม่มีข้อมูลในระบบ common_fees</p></div> : (
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2 text-sm font-bold text-slate-500 mb-2 px-1"><FileText size={16} /> รายการทั้งหมด ({historyData.length})</div>
                                            {historyData.map((record, idx) => {
                                                const headerStyle = getHistoryCardHeaderStyle(record.status);
                                                return (
                                                    <div key={record.id || idx} className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 group">
                                                        <div className={`${headerStyle.bg} px-4 py-3 border-b ${headerStyle.border} flex justify-between items-center`}><div className="flex items-center gap-2"><div className={`${headerStyle.iconBg} p-1.5 rounded-lg ${headerStyle.iconColor}`}><Calendar size={16} /></div><span className={`font-bold text-base ${headerStyle.text}`}>{record.month} {record.year}</span></div>{getHistoryHeaderBadge(record.status)}</div>
                                                        {record.image_url ? (<div className="relative h-48 sm:h-64 w-full bg-slate-100 border-b border-slate-100 group cursor-pointer" onClick={() => openImageModal(record.image_url)}><img src={record.image_url} alt="Payment Slip" className="w-full h-full object-cover" loading="lazy" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100"><span className="bg-black/50 text-white px-3 py-1.5 rounded-full text-sm font-medium backdrop-blur-sm flex items-center gap-2"><ZoomIn size={16} /> ขยายรูปภาพ</span></div><button className="absolute bottom-3 right-3 bg-white/90 backdrop-blur-sm text-slate-700 hover:text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold shadow-md flex items-center gap-1.5 hover:bg-white transition-all transform hover:scale-105" onClick={(e) => { e.stopPropagation(); openImageModal(record.image_url); }}><ImageIcon size={16} /> ดูรูปเต็ม</button></div>) : (<div className="h-32 bg-slate-50 flex flex-col items-center justify-center text-slate-300 border-b border-slate-100"><ImageIcon size={32} className="mb-2 opacity-50" /><span className="text-xs">ไม่มีรูปสลิป</span></div>)}
                                                        <div className="p-4">
                                                            <div className="flex justify-between items-end mb-4 pb-4 border-b border-slate-100 border-dashed"><div><span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">ยอดชำระ</span><h4 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-600">฿{(record.amount || 0).toLocaleString()}</h4></div><div className="text-right"><span className="text-[10px] font-semibold text-slate-400 mb-0.5 block">วันที่แจ้ง</span><div className="text-xs font-medium text-slate-600 bg-slate-50 px-2 py-1 rounded border border-slate-100 flex items-center gap-1"><Clock size={10} />{record.reported_at ? new Date(record.reported_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' }) : '-'}</div></div></div>
                                                            <div className="grid grid-cols-2 gap-x-4 gap-y-3 bg-slate-50 p-3 rounded-xl border border-slate-100 mb-3"><DetailRow label="ID" value={record.id} icon={Hash} color="text-indigo-600" /><DetailRow label="UID" value={record.user_id ? maskName(record.user_id) : '-'} icon={Fingerprint} /><DetailRow label="ผู้แจ้ง" value={record.name} icon={User} color="text-blue-600" /><DetailRow label="บ้านเลขที่" value={record.house_number} icon={Home} color="text-orange-600" /><DetailRow label="การจ่าย" value={record.payment_method} icon={Banknote} color="text-emerald-600" /><DetailRow label="ตัวหนังสือ" value={record.amount_text} icon={Type} /><div className="col-span-2 pt-2 mt-1 border-t border-slate-200 grid grid-cols-2 gap-4"><DetailRow label="ผู้ตรวจสอบ" value={record.inspector} icon={UserCheck} color="text-purple-600" /><DetailRow label="วันที่ตรวจสอบ" value={record.inspected_at ? new Date(record.inspected_at).toLocaleDateString('th-TH') : '-'} icon={CalendarCheck} color="text-teal-600" /></div></div>
                                                            {record.remark && (<div className="mb-3 bg-amber-50 border border-amber-100 rounded-lg p-2.5 flex gap-2 items-start"><MessageSquare size={14} className="text-amber-500 mt-0.5 shrink-0" /><div><span className="text-[10px] font-bold text-amber-700 block">หมายเหตุ</span><p className="text-xs text-amber-900 leading-relaxed">{record.remark}</p></div></div>)}
                                                            {record.pdf_url && (<button onClick={() => openPdfModal(record.pdf_url)} className="w-full flex items-center justify-center gap-2 text-blue-600 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-lg text-xs font-bold transition-all border border-blue-200"><FileText size={14} /> ดูเอกสารใบเสร็จ PDF</button>)}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white p-4 border-t border-slate-100 text-center text-xs text-slate-400">ข้อมูลจากตาราง common_fees</div>
                            </div>
                        </div>
                    )}
                    {pdfModalOpen && selectedPdfUrl && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 no-print"><div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onClick={closePdfModal}></div><div className="relative bg-white rounded-2xl w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl animate-in fade-in zoom-in-95 duration-200"><div className="flex justify-between items-center p-4 border-b border-slate-200 bg-slate-50 rounded-t-2xl"><h3 className="font-bold text-slate-800 flex items-center gap-2"><FileText className="text-red-500" /> เอกสารใบเสร็จ PDF</h3><div className="flex items-center gap-2"><a href={selectedPdfUrl.replace('/preview', '/view')} target="_blank" rel="noreferrer" className="text-slate-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50" title="เปิดในแท็บใหม่"><ExternalLink size={20} /></a><button onClick={closePdfModal} className="text-slate-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50"><X size={24} /></button></div></div><div className="flex-1 bg-slate-100 relative"><iframe src={selectedPdfUrl} className="w-full h-full" title="PDF Preview" allow="autoplay"></iframe></div></div></div>
                    )}
                    {imageModalOpen && selectedImageUrl && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 no-print" onClick={closeImageModal}><div className="absolute inset-0 bg-black/90 backdrop-blur-sm"></div><div className="relative w-full max-w-4xl h-full max-h-[90vh] flex flex-col items-center justify-center animate-in fade-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}><button onClick={closeImageModal} className="absolute -top-12 right-0 text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"><X size={32} /></button><img src={selectedImageUrl} alt="Full Slip" className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" /><div className="absolute -bottom-12 left-0 right-0 flex justify-center gap-4"><a href={selectedImageUrl} target="_blank" rel="noreferrer" className="text-white/80 hover:text-white text-sm flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full hover:bg-white/20 transition-colors"><ExternalLink size={16} /> เปิดรูปต้นฉบับ</a></div></div></div>
                    )}

                    {/* Result Alert Modal */}
                    {resultModal.isOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-in fade-in duration-200 no-print">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                            <div className={`relative bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-100 border-2 ${resultModal.type === 'success' ? 'border-green-100' : 'border-red-100'}`}>
                                <div className="text-center">
                                    <div className={`mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4 ${resultModal.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {resultModal.type === 'success' ? <CheckCircle size={32} /> : <AlertTriangle size={32} />}
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-2">{resultModal.type === 'success' ? 'สำเร็จ' : 'แจ้งเตือน'}</h3>
                                    <p className="text-slate-500 text-sm mb-6">{resultModal.message}</p>
                                    <button 
                                        onClick={() => setResultModal(prev => ({ ...prev, isOpen: false }))}
                                        className={`px-6 py-2 rounded-lg font-medium shadow-md transition-colors text-white ${resultModal.type === 'success' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}
                                    >
                                        ตกลง
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="text-center py-6 text-white/60 text-sm no-print"><p>9one © 2025 ระบบตรวจสอบค่าส่วนกลาง | หมู่บ้าน โกลเด้นแลนด์ ซีรีน</p></footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
