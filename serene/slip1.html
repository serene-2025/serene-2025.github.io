<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏ã‡∏µ‡∏£‡∏µ‡∏ô</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1571/1571031.png" type="image/png">

  <!-- Import Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" xintegrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CSS Style -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');

    * {
      font-family: 'Kanit', sans-serif;
    }

    body {
        background-color: #f9f9f9;
    }

    /*Profile Card 5*/
    .profile-card-5 {
      margin-top: 20px;
      border-color: #0e838bFF
    }

    .profile-card-5 .card-img-block {
      width: 91%;
      margin: 0 auto;
      position: relative;
      top: -20px;
    }

    .profile-card-5 .card-img-block img {
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.63);
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: #FFFFFF
    }

    .profile-card-5 h5 {
      color: #4E5E30;
      font-weight: 600;
    }

    .profile-card-5 h3 {
      color: #4E5E30;
      font-weight: 600;
    }

    .profile-card-5 p {
      font-size: 14px;
      font-weight: 300;
    }

    .input-box {
      margin-bottom: 2%;
    }

    /* Table Styles */
    .table-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
    }

    .table-responsive {
      overflow-x: auto;
      font-size: 14px;
    }

    #dataTable th,
    #dataTable td {
      width: auto;
      white-space: nowrap;
      padding: 8px;
      vertical-align: middle;
    }

    #dataTable thead th {
      background-color: #f7f7f7;
      border-bottom: 2px solid #ddd;
    }

    strong {
      display: inline-block;
      margin: 0;
      font-size: 1.5rem;
      padding: 2px 5px;
      border-radius: 3px;
      background-color: #eaeaea;
      color: #b9316f;
      font-weight: 600;
    }

    /* Animation for the unpaid status box */
    .fade-in {
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="container-fluid mb-4 pt-3">
    <div class="col-md-8 mx-auto bg-white p-4 rounded shadow-sm">
      <form class="needs-validation" novalidate id="user_form" onsubmit="getAllElmForm(this)">
        <div class="col-md-12 text-center mb-4">
          <h4 class="mb-2 p-3 bg-success text-white rounded shadow-sm"><i class="fa-solid fa-city"></i> üí¥ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á Serene </h4>
        </div>

        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold"><i class="fa-solid fa-circle-user text-primary"></i> ü§µ ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à <span style="color: red;">*</span></label>
          <input type="text" class="form-control" id="name" name="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
        </div>
        
        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold"><i class="fa-solid fa-house text-primary"></i> üè° ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span style="color: red;">*</span></label>
          <input type="text" class="form-control" id="name1" name="name1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 999/99" required>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold"><i class="fa-solid fa-calendar-days text-success"></i> üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span></label>
              <select class="form-select" id="name2" name="name2" required>
                <option selected disabled value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
                <option>‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                <option>‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                <option>‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                <option>‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                <option>‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold"><i class="fa-solid fa-calendar-days text-success"></i> üìÜ ‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span></label>
              <select class="form-select" id="name3" name="name3" required>
                <option selected disabled value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>
                <option>2567</option>
                <option>2568</option>
                <option>2569</option>
                <option>2570</option>
                <option>2571</option>
              </select>
            </div>
        </div>

        <div class="col-md-12 mb-3">
          <label class="form-label fw-bold"><i class="fa-solid fa-mobile-button text-warning"></i> üì± ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ <span style="color: red;">*</span></label>
          <div class="d-flex gap-3">
              <div class="form-check">
                  <input type="radio" class="form-check-input" id="pay_transfer" name="name4" value="‡πÇ‡∏≠‡∏ô" required>
                  <label class="form-check-label" for="pay_transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
              </div>
              <div class="form-check">
                  <input type="radio" class="form-check-input" id="pay_cash" name="name4" value="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î" required>
                  <label class="form-check-label" for="pay_cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
              </div>
          </div>
        </div>

        <div class="col-md-12 col-12 mb-3">
          <label class="form-label fw-bold"><i class="fa-solid fa-image text-info"></i> üì∏ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (‡∏™‡∏•‡∏¥‡∏õ) <span style="color: red;">*</span></label>
          <input type="file" class="form-control" id="file_image" name="file_image" onchange="fileValidation()" accept="image/*" required>
        </div>
        
        <div class="input-box text-center" id="imgbox">
            <img id="picdata" src="" class="img-fluid rounded shadow-sm border" style="display:none; max-height: 300px;">
            <p class="mt-2 text-muted small" id="file_input_help"></p>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold"><i class="fa-solid fa-file-pen text-secondary"></i> üìú ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) </label>
          <textarea class="form-control" id="name5" name="name5" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>

        <button type="submit" id="btn_1" class="btn btn-secondary btn-lg w-100 rounded shadow transition-all" disabled>
          <i class="fa-solid fa-floppy-disk me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button class="btn btn-lg w-100 btn-light text-success border" style="display: none;" type="button" id="btn_2" disabled>
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </button>
      </form>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -->
      <div id="unpaidStatusContainer" class="mt-4 fade-in" style="display:none;">
        <div class="card border-danger shadow-sm">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fs-6"><i class='bx bx-error-circle'></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span id="statusHouseNo"></span>)</h5>
                <span class="badge bg-white text-danger" id="totalCountBadge">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th class="py-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="py-2">‡∏õ‡∏µ</th>
                                <th class="py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="unpaidStatusBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="p-2 text-center bg-light border-top">
                    <small class="text-danger fw-bold">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</small>
                </div>
            </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12 text-center">
          <div class="alert alert-warning" role="alert">
            <i class="fa-solid fa-triangle-exclamation"></i> <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏¥‡∏•‡∏•‡∏∞ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
          </div>
          
          <div class="card bg-light border-0 mt-3">
              <div class="card-body">
                  <h6 class="text-primary fw-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h6>
                  <p class="small text-muted mb-0">
                    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö Real-time<br>
                    ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a class="text-decoration-none fw-bold" href="https://line.me/ti/p/OZwGJgp1Qq" target="_blank"><i class="fa-brands fa-line text-success"></i> Line Admin</a>
                  </p>
              </div>
          </div>
        </div>
      </div>
      
      <div class="text-center mt-4 text-muted small">
          9one ¬© 2024 V.4
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

  <!-- Main Script -->
  <script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbz6Ua9LYQikcgL8OcT3CkEcxfxQNFctPZ1fg5dDP6WTRQEZpvklObLufFFx2a-XBeruYw/exec";

    // --- Supabase Configuration ---
    const SUPABASE_URL = 'https://kiumelolsilduqnvrekf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Supabase Client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    $(document).ready(function() {
      const liffId = "2000143615-pm5EAXfb";
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
      initializeLiff(liffId);
    });

    function initializeLiff(liffId) {
      liff
        .init({
          liffId: liffId,
          withLoginOnExternalBrowser: true
        })
        .then(async () => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£ Login
          if (!liff.isInClient() && !liff.isLoggedIn()) {
             console.log("Not logged in");
          }
          
          const urlParms = new URLSearchParams(window.location.search)
          id = urlParms.get('id')

          // Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          if (id) {
             await reloadData(id)
          } 
          
          await Dropdown()
          sessionStorage.setItem('idProduct', JSON.stringify(id));

          liff.getProfile().then(function(profile) {
            uid = profile.userId;
            uname = profile.displayName;
            picture = profile.pictureUrl;
            xos = liff.getOS();
            emailL = liff.getDecodedIDToken().email;
          })
        })
        .catch((err) => {
          console.log('LIFF Initialization failed ', err);
        });
    }

    // --- Function ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (Supabase) - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á CSV ---
    async function checkUnpaidStatus(houseNumber) {
      const container = document.getElementById('unpaidStatusContainer');
      const tableBody = document.getElementById('unpaidStatusBody');
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
      if(!houseNumber || houseNumber.length < 2) {
          container.style.display = 'none';
          return;
      }

      console.log("Checking status for:", houseNumber);

      try {
        // Query Supabase: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å house_numbe (‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏° CSV)
        const { data, error } = await supabaseClient
          .from('house_payments')
          .select('*')
          .eq('house_numbe', houseNumber); 

        if (error) {
          console.error("Supabase Error:", error);
          container.style.display = 'none';
          return;
        }

        let totalUnpaidCount = 0;
        tableBody.innerHTML = ''; // Clear old data

        if (data && data.length > 0) {
            // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

            data.forEach(row => {
                months.forEach((monthKey, index) => {
                    const status = row[monthKey];
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢" ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
                    if (status && (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢' || status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢')) {
                        totalUnpaidCount++;
                        const rowHtml = `
                          <tr>
                            <td class="align-middle">${thaiMonths[index]}</td>
                            <td class="align-middle">${row.year || '-'}</td>
                            <td class="align-middle"><span class="badge bg-danger rounded-pill">${status}</span></td>
                          </tr>
                        `;
                        tableBody.innerHTML += rowHtml;
                    }
                });
            });
        }

        if (totalUnpaidCount > 0) {
            document.getElementById('statusHouseNo').innerText = houseNumber;
            document.getElementById('totalCountBadge').innerText = totalUnpaidCount + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            container.style.display = 'block';
        } else {
            console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà " + houseNumber);
            container.style.display = 'none';
        }

      } catch (err) {
        console.error("Check Status Failed:", err);
        container.style.display = 'none';
      }
    }


    function sendFlexMessage(uid, uname, picture, name, name1, name2, name3) {
        // ... (Code ‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Flex Message) ...
        console.log("Simulating Flex Message Send to: " + uid);
    }

    /**‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á */
    function preventFormSubmit() {
      var forms = document.querySelectorAll("form");
      for (var i = 0; i < forms.length; i++) {
        forms[i].addEventListener("submit", function(event) {
          event.preventDefault();
        });
      }
    }
    window.addEventListener("load", preventFormSubmit);

    /** ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå */
    async function reloadData(id) {
        // ... (Code ‡πÄ‡∏î‡∏¥‡∏°) ...
        console.log("Simulating Reload Data for ID: " + id);
    }

    //‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown 
    async function Dropdown() {
      try {
        // ... (Code ‡πÄ‡∏î‡∏¥‡∏°) ...
      } catch (error) {
        console.error(error);
      }
    }

    /** Function ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å */
    function getAllElmForm(data) {
      const name = document.getElementById("name").value;
      const name1 = document.getElementById("name1").value;
      const name2 = document.getElementById("name2").value;
      const name3 = document.getElementById("name3").value;

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        html: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
        timer: 2000,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading()
        }
      }).then((result) => {
          // Simulation Success
          Swal.fire({
              title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏≥‡∏•‡∏≠‡∏á)',
              text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
              icon: 'success',
              confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
          }).then(() => {
             // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Reload ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
             // liff.closeWindow();
             window.location.reload();
          });
      })
    }

    // Upload & Preview Image
    let imgupload = document.getElementById('file_image');
    imgupload.addEventListener('change', function(e) {
      if (e.target.files[0]) {
        let imageVal = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
             document.getElementById("picdata").src = e.target.result;
             document.getElementById('picdata').style.display = 'block';
        }
        reader.readAsDataURL(imageVal);
      } else {
        document.getElementById("picdata").src = "";
        document.getElementById('picdata').style.display = 'none';
      }
    });

    // Validation
    function fileValidation() {
      var fileInput = document.querySelector("#file_image");
      var filePath = fileInput.value;
      var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;

      if(fileInput.files.length > 0){
          var iConvert = (fileInput.files[0].size / (1024 * 1024)).toFixed(2);
          let txt = "‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå: " + iConvert + " MB";
          $("#file_input_help").html(txt)
    
          if (fileInput.files[0].size > 3 * 1048576) {
            Swal.fire({ position: 'top', icon: 'info', title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô !', text: '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 mb' });
            fileInput.value = '';
            document.getElementById('picdata').style.display = 'none';
          } else if (!allowedExtensions.exec(filePath)) {
            Swal.fire({ position: 'top', icon: 'error', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!!', showConfirmButton: false, timer: 1500 });
            fileInput.value = '';
            document.getElementById('picdata').style.display = 'none';
          }
      }
    }

    (function() {
      "use strict";
      var forms = document.querySelectorAll(".needs-validation");
      Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener("submit", function(event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
              Swal.fire({ title: "‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", icon: "warning", confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á" });
            }
            form.classList.add("was-validated");
          }, false);
      });
    })();

    // Form Validity Check Realtime
    function checkFormValidity() {
      const name = document.getElementById('name').value;
      const name1 = document.getElementById('name1').value;
      const name2 = document.getElementById('name2').value;
      const name3 = document.getElementById('name3').value;
      const file_image = document.getElementById('file_image').value;
      const name4 = document.querySelector('input[name="name4"]:checked');

      const btn = document.getElementById('btn_1');
      if (name && name1 && name2 && name3 && file_image && name4) {
        btn.disabled = false;
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');
      } else {
        btn.disabled = true;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');
      }
    }

    document.getElementById('name').addEventListener('input', checkFormValidity);
    document.getElementById('name1').addEventListener('input', checkFormValidity);
    document.getElementById('name2').addEventListener('change', checkFormValidity);
    document.getElementById('name3').addEventListener('change', checkFormValidity);
    document.getElementById('file_image').addEventListener('change', checkFormValidity);
    document.querySelectorAll('input[name="name4"]').forEach(radio => {
      radio.addEventListener('change', checkFormValidity);
    });

    // --- Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ---
    let debounceTimer; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    document.getElementById('name1').addEventListener('input', function() {
        const houseNo = this.value;
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå timer ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏±‡∏ß‡πÜ)
        clearTimeout(debounceTimer);
        
        // ‡∏ï‡∏±‡πâ‡∏á timer ‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        debounceTimer = setTimeout(() => {
            checkUnpaidStatus(houseNo);
        }, 1000); 
    });

    // Load/Save LocalStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedName = localStorage.getItem('name');
      const savedHouseNumber = localStorage.getItem('name1');

      if (savedName) document.getElementById('name').value = savedName;
      if (savedHouseNumber) {
          document.getElementById('name1').value = savedHouseNumber;
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
          checkUnpaidStatus(savedHouseNumber);
      }

      checkFormValidity();
    });

    document.getElementById('user_form').addEventListener('submit', function(event) {
       const name = document.getElementById('name').value;
       const houseNumber = document.getElementById('name1').value;
       localStorage.setItem('name', name);
       localStorage.setItem('name1', houseNumber);
    });
  </script>
</body>
</html>
