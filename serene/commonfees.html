<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจ่ายค่าส่วนกลาง</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <link href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>  
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap');
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      font-size: .875rem;
    }

    .nav-item {
      cursor: pointer;
    }

    a {
      text-decoration: none;
    }

    .btn-group-xs > .btn, .btn-xs {
      padding: .25rem .4rem;
      font-size: .875rem;
      line-height: .5;
      border-radius: .2rem;
    }

  #loading {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    background-color: rgba(255, 255, 255, 0.9);
    height: 100vh;
    width: 100vw;
  }
 </style>

</head>

<body>
    <!-- Loading Spinner -->
    <div id="loading" class="d-flex justify-content-center  align-items-center invisible">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    </div>

  <div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-light bg-primary mb-2">
      <div class="container-fluid">        

        <a class="navbar-brand text-white"><i class="fas fa-server"></i> ระบบจัดการค่าส่วนกลาง</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
           <li class="nav-item me-2 d-flex align-items-center"> 
               
               <!-- ปุ่มสำหรับ Admin (Batch PDF) -->
               <button class="btn btn-light text-primary me-2" id="btnBatchPDF" onclick="runSelectedPDFs()" style="display:none;">
                   <i class="fa-solid fa-file-pdf"></i> สร้าง PDF ที่เลือก
               </button>

               <button class="btn btn-warning me-md-2" id="btnlogin" onclick="formLogin()"><i class="fa-solid fa-right-to-bracket"></i> เข้าสู่ระบบ</button>
        <span class="logout text-white ms-2" style="display:none">
            <button class="btn btn-warning btn-sm-2" id="btnLogout" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i><i class="fa-regular fa-user ms-2"></i>&nbsp;<span id="msg-name"></span></button>
        </span>
             </li>
          </ul>
      </div>
    </nav>


    <!--แสดงตาราง DataTable-->
      <table id="datatable" class="display responsive nowrap" style="width:100%"></table>

 </div>
    <!-- Modal Add/Edit -->
    <div class="modal fade" id="Modaladd" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="ModaladdLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <!--หัวแบบฟอร์ม-->
            <h4 class="modal-title" id="ModaladdLabel"><i class="fa-solid fa-city"></i>  จ่ายค่าส่วนกลาง Serene</h4>
            <button type="button" id="btnclose" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

             <!-----------ฟอร์มบันทึกข้อมูล แก้ไข------------------->
            <form id="myForm" onsubmit="submitForm(this)">
             
                <div class="col-md-6 mb-2" style="display:none">
                  <label>ไอดี</label>
                  <input type="text" class="form-control" id="numid" name="numid">
                </div>
                <!-- UID hidden -->
                <div class="col-md-12 mb-2 text-success" id="dnote0" style="display:none">
                  <h6 label class="mb-3"><i class="fa-solid fa-calendar-days"></i>  uid *</label><br>
                  <input type="date" class="form-control"  id="uid" name="uid">
                </div>
                
                <!-- Fullname hidden for logic -->
                <div class="col-md-6 mb-2" style="display:none">
                  <label>ชื่อผู้ตรวจสอบ</label>
                  <input type="text" class="form-control" id="fullname" name="fullname">
                </div>

                <div class="col-md-12 mb-2">
                  <label ><i class="fa-solid fa-circle-user"></i>  ชื่อ ผู้บันทึกข้อมูล *</label>
                  <input type="text" class="form-control" id="datastud1" name="datastud1" placeholder="พิมพ์ชื่อ เช่น อนุชา" required>
                </div>
                <div class="col-md-12 mb-2">
                  <label ><i class="fa-solid fa-house"></i>  บ้านเลขที่ *</label>
                  <input type="text" class="form-control" id="datastud2" name="datastud2" placeholder="บ้านเลขที่ เช่น 999/99" required>
                </div>   

                <div class="col-md-12 mb-2">
                  <label ><i class="fa-solid fa-calendar-days"></i>  เดือนที่จ่าย *</label>
                  <select class="form-control"  id="datastud3" name="datastud3" required>
                        <option selected disabled value=""><---เลือกเดือน---></option>
                        <option>มกราคม</option>
                        <option>กุมภาพันธ์</option>
                        <option>มีนาคม</option>
                        <option>เมษายน</option>
                        <option>พฤษภาคม</option>
                        <option>มิถุนายน</option>
                        <option>กรกฎาคม</option>
                        <option>สิงหาคม</option>
                        <option>กันยายน</option>
                        <option>ตุลาคม</option>
                        <option>พฤศจิกายน</option>
                        <option>ธันวาคม</option>
                  </select>
                </div>
 
                 <div class="col-md-12 mb-2">
                  <h7 label class="mb-3"><i class="fa-solid fa-calendar-days"></i>  ปี *</label><br>
                  <select class="form-control"  id="datastud4" name="datastud4" required>
                        <option selected disabled value=""><----เลือกปี----></option>
                        <option>2567</option>
                        <option>2568</option>
                        <option>2569</option>
                        <option>2570</option>
                  </select>
                </div>

          <div class="col-md-12 mb-2">
            <h7 label class="mb-2"><i class="fa-solid fa-mobile-button"></i> โอน/จ่ายสด *</label><br>
            <input type="radio" class="form-check-input me-2" name="datastud5" value="โอน" required>
            <label class="form-check-label me-3">โอน</label>
            
            <input type="radio" class="form-check-input me-2" name="datastud5" value="จ่ายสด" required>
            <label class="form-check-label me-2">จ่ายสด</label>
            </div>
            
              <div class="col-md-12 col-12  mb-3">
              <label ><i class="fa-solid fa-image"></i> ถ่าย หรือ เลือก / ภาพสลิป *</label>
              <input type="file" class="form-control"  id="myFile" name="myFile" onchange="fileValidation()">
              <input id="oldfile" name="oldfile" style="display:none">
              <div id="pfile2" style="display:none">
                <div class="input-group mb-3">
                  <input type="text" id="file2" style="display:none" class="form-control" readonly>
                  <button class="btn btn-warning btn-sm" type="button" onclick="pfile2()" id="btnchangepic"><i class="fa-solid fa-image"></i> คลิกเปลี่ยนภาพใหม่</button>
                </div>
                <center><img id=oldfile2 src="" height="80px" ></center>
               
              </div>
               <center><img class="form-control-file p-2" style="max-height: 80px; margin: 0px auto; display: none; border: 0px solid #555;" src="" id="img" alt="pic">
          </center>
            </div>

            <div class="mb-3">
            <label><i class="fa-solid fa-file-pen"></i>  หมายเหตุ </label>
            <textarea class="form-control" id="datastud6" name="datastud6" rows="3" placeholder="ข้อมูลเพิ่มเติม (ถ้ามี) เช่น จ่ายล่วงหน้า 2เดือน หรือ อื่นๆ"></textarea>
             </div>

            <div class="col-md-12 mb-2" id="dnote6" style="display:none">
            <h6 label class="mb-3 text-success"><i class="fa-solid fa-circle-user "></i> ตัวหนังสือ </label><br>
            <input type="text" class="form-control text-primary" id="datastud8" name="datastud8" value="สามร้อยบาทถ้วน">
            </div>

            <div class="col-md-12 mb-2" id="dnote2" style="display:none">
                  <h6 label class="mb-3 text-success"><i class="fa-solid fa-circle-user "></i>  จำนวน *</label><br>
                  <select class="form-control text-primary "  id="datastud9" name="datastud9"> 
                        <option>300</option>
                  </select>
                </div>


                <div class="col-md-12 mb-2" id="dnote" style="display:none">
                  <h6 label class="mb-3 text-success"><i class="fa-solid fa-circle-user "></i>  สถานะการตรวจสอบ *</label><br>
                  <select class="form-control text-primary "  id="note" name="note">
                        
                        <option>ตรวจสอบแล้ว</option>
                        <option>กำลังดำเนินการ</option>
                        <option>รอข้อมูล</option>
                        <option>รอตรวจสอบ</option>
                        <option>จ่ายผิด</option>
                        <option>ยกเลิก</option>
                        <option>โอนคืน</option>
                        <option>ให้ติดต่อแอดมิน</option>
                  </select>
                </div>

                <div class="col-md-12 mb-2 text-success" id="dnote1" style="display:none">
                    <h6 label class="mb-3">
                        <i class="fa-solid fa-calendar-days"></i> วันที่ตรวจสอบ *
                    </h6>
                    <input type="date" class="form-control" id="datastud7" name="datastud7">
                </div>

               </div>
              <div class="col-md-12 mt-2 mb-3 text-center">
              <button type="submit" class="btn btn-success w-80" id="add" ><i class="fa-solid fa-floppy-disk"></i> บันทึกข้อมูล</button>
              <button class="btn btn-success w-80 text-danger" type="button" id="add2" style="display:none" disabled>
              <span class="spinner-border spinner-border-sm text-danger" role="status" aria-hidden="true"></span>
              กรุณารอสักครู่กำลังออกบิล....
              </button>
</div>
            <div class="row">
              <div class="col-md-12 mt-2 mb-3 text-center">
          <h5 class="mb-2 text-danger col-12 "></i> **ถ้าเป็นไปได้พยายามจ่าย บิลละ1เดือน เพื่อท่านจะได้เช็คข้อมูลได้ง่าย**</h5>
           <div class="row">
          <div class="col-md-12 text-blue">
          <h5 class="mb-2 text-primary"></i> ระบบช่วย บันทึกการจ่ายค่าส่วนกลาง</h5>
          <div class="col-md-12 mt-10">
            เพื่อที่จะให้สามารถ เช็คข้อมูลย้อนหลังได้ และสามารถเช็คได้ 
            <div class="col-md-12 mt-2 mb-4">
            แบบ เรียลไทม์ ได้ด้วยตัวเอง
            </div>
            </div>
            </div>
  </div>
   </div>
            </form>

          </div>
        </div>
      </div>
    </div>

    <!-- Modal Table Result -->
    <div class="modal fade" id="Modaltableresult" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="tableresultLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header bg-primary text-white ">
                <h5 class="modal-title fas fa-edit" id="tableresultLabel">  ตรวจสอบข้อมูลการบันทึก</h5>
                <button type="button" id="btnclosetableresult" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
            <table id="tb" class="table table-striped" style="width:100%"></table>

            </div>
            </div>
        </div>
    </div>

  <!-- Template Login -->
 <template id="formLogin">
   <swal-html>
 <form  onsubmit="login(this)">
                  <div class="h5 mb-3 p-2 bg-primary text-white">Login Admin</div>
                  <div class="input-group mb-3">
                      <span class="input-group-text"><i class="fa-solid fa-circle-user"></i></span>
                      <input type="text" class="form-control" id="username" placeholder="username" required>
                    </div>
                   <div class="input-group mb-3">
                      <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
                      <input type="password" class="form-control" id="password" placeholder="password" required>
                    </div>
                  <button type="submit" class="btn btn-primary" id="btn-login"><i class="fa-solid fa-right-to-bracket"></i> เข้าสู่ระบบ</button>
                </form>
                <div class="text-end">
                <i class="text-primary fa-solid fa-circle-xmark fa-lg" type="button" onclick="Swal.close()"></i>
                </div>
    </swal-html>
</template>
 
 <div class="row">
  <div class="col-md-12 text-center">
    <h7 class="mb-12">
      <a href="https://line.me/ti/p/OZwGJgp1Qq" target="_blank">9one © 2023</a>
    </h7>
  </div>
</div>
  </div>

  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js">
  </script>
  <!--DataTable-->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

<!-- ############################################################################ -->
<!-- JAVASCRIPT SECTION (รวมทุกอย่างไว้ที่นี่) -->
<!-- ############################################################################ -->
<script>
    // ********** CONFIGURATION **********
    // URL ของ Google Apps Script Web App (API)
    const API_URL = 'https://script.google.com/macros/s/AKfycbxhRu8OqqvWyb5q7_kH4KZ3VEUZPGXJXTp2hr4kFawmgX95gBCtXS34_bbAC4mczvV8/exec';
    
    // ********** GLOBAL VARIABLES **********
    let admin = "";
    var item;
    var fname = localStorage.getItem('Name');

    // ********** HELPER FUNCTIONS **********
    function loadingStart(){
        $('#loading').removeClass('invisible');
    }

    function loadingEnd(){
        $('#loading').addClass('invisible');   
    }

    // ฟังก์ชันแปลงไฟล์เป็น Base64
    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // ฟังก์ชันเรียก API (แทน google.script.run)
    function callApi(action, data = {}) {
        const payload = {
            action: action,
            ...data
        };
        
        // ใช้ fetch ส่ง POST Request
        return fetch(API_URL, {
            method: "POST",
            mode: "cors", 
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" }, // ใช้ text/plain เพื่อเลี่ยง preflight cors ของ GAS
            redirect: "follow"
        })
        .then(response => response.json())
        .catch(error => {
            console.error('API Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'ข้อผิดพลาด',
                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้'
            });
            loadingEnd();
            throw error; // ส่ง error ต่อ
        });
    }


    // ********** MAIN LOGIC **********
    
    // 1. Initial Load
    window.addEventListener('load',function(){
        loadingStart();       
        loaddata(); // โหลดข้อมูล Sheet สำหรับแก้ไข
        
        let savedUser = localStorage.getItem('userName');
        console.log('userName: ', savedUser);
        
        if(savedUser === null || savedUser === ""){
            getData(admin);         
        } else {
            admin = savedUser;
            getData(admin);
            $("#btnlogin").hide();
            $(".logout").show();
            $("#msg-name").html(admin);
            
            // แสดงปุ่ม Batch PDF ถ้าเป็น Admin
            $("#btnBatchPDF").show();
        }
        
        // Date setup
        setTodayDate();
    });

    // 2. Data Fetching
    function getData(adminUser){
        // เรียก API action: 'getData'
        callApi('getData', { admin: adminUser })
        .then(dataArray => {
             showData(dataArray);
        });
    }    
    
    function loaddata(){
        // เรียก API action: 'getDataSheet'
        callApi('getDataSheet')
        .then(datax => {
            item = datax;
            loadingEnd();
        });
    }

    function getAllData(){
         // เรียก API action: 'getData' (แบบ admin)
         callApi('getData', { admin: admin })
        .then(dataArray => {
             showData(dataArray);
        });
    }

    // 3. DataTable Display
    function showData(dataArray){
        var result = "<table class='table table-sm' style='font-size:4'>"+
                   "<thead class='bg-primary text-white'>"+
                     "<tr>";
        
        // --- เพิ่ม Checkbox Column ถ้าเป็น Admin ---
        if(admin !== "") {
             result += "<th class='text-center'><input type='checkbox' id='selectAll' onclick='toggleAll(this)'> เลือก</th>";
        }
        // ---------------------------------------

        result +=     "<th align='center'>บ้านเลขที่</th>"+
                      "<th scope='col'>เดือน</th>"+
                      "<th scope='col'>สถานะ</th>"+
                      "<th scope='col'>ปี :</th>"+
                      "<th scope='col'>สลิป </th>"+
                      "<th scope='col'>ชื่อผู้บันทึก :</th>"+
                      "<th scope='col'>การจ่าย :</th>"+
                      "<th scope='col'>หมายเหตุ :</th>"+
                      "<th scope='col'>ผู้ตรวจสอบ :</th>"+
                      "<th scope='col'>โหลดใบเสร็จ :</th>"+
                      "<th scope='col'>แก้ไข|ลบ</th>"+
                    "</tr>"+
                  "</thead>";
           
        for (var i = 0; i < dataArray.length; i++){
            result += "<tr>";
            
            // --- เพิ่ม Checkbox Cell ถ้าเป็น Admin ---
            if(admin !== "") {
                 result += "<td class='text-center'><input type='checkbox' class='rowCheckbox' value='" + dataArray[i][0] + "'></td>";
            }
            // ---------------------------------------

            result += "<td>" +dataArray[i][4]+ "</td>"; //บ้านเลขที่
            result += "<td>" +dataArray[i][5]+ "</td>"; //เดือน
            
            // Status Logic
            if (dataArray[i][13] == 'ตรวจสอบแล้ว' ){
                result += "<td><span class='text-success sfont'><i class='fa-solid fa-circle-check'></i> ตรวจสอบแล้ว</span></td>"; 
            } else if (dataArray[i][13] == 'รอตรวจสอบ' ){
                result += "<td><span class='text-warning sfont'><i class='fa-solid fa-clock'></i> รอตรวจสอบ</span></td>"; 
            } else if (dataArray[i][13] == 'กำลังดำเนินการ' ){
                result += "<td><span class='text-warning sfont'><i class='fa-solid fa-clock'></i> กำลังดำเนินการ</span></td>"; 
            } else if (dataArray[i][13] == 'ยกเลิก' ){
                result += "<td><span class='text-danger sfont'><i class='fa-solid fa-rotate-right'></i> ยกเลิก</span></td>"; 
            } else if (dataArray[i][13] == 'จ่ายผิด' ){
                result += "<td><span class='text-danger sfont'><i class='fa-solid fa-rotate-right'></i> จ่ายผิด</span></td>"; 
            } else if (dataArray[i][13] == 'โอนคืน' ){
                result += "<td><span class='text-danger sfont'><i class='fa-solid fa-rotate-right'></i> โอนคืน</span></td>"; 
            } else if (dataArray[i][13] == 'ให้ติดต่อแอดมิน' ){
                result += "<td><span class='text-primary sfont'><i class='fa-solid fa-user'></i> ให้ติดต่อแอดมิน</span></td>"; 
            }

            // Year Color Logic
            if (dataArray[i][6] == '2567') {
                result += "<td style='color: #FFD700;'>" + dataArray[i][6] + "</td>"; // สีทอง
            } else if (dataArray[i][6] == '2568') {
                result += "<td style='color: #0000FF;'>" + dataArray[i][6] + "</td>"; // Blue
            } else if (dataArray[i][6] == '2569') {
                result += "<td style='color: #800080;'>" + dataArray[i][6] + "</td>"; // Purple
            } else if (dataArray[i][6] == '2570') {
                result += "<td style='color: #808000;'>" + dataArray[i][6] + "</td>"; // Olive
            } else if (dataArray[i][6] == '2571') {
                result += "<td style='color: #800000;'>" + dataArray[i][6] + "</td>"; // Maroon
            } else {
                result += "<td>" + dataArray[i][6] + "</td>"; //ปี
            }

            // Image Logic
            if(dataArray[i][11] == ""){
                result += "<td></td>"
            }else{
                result += "<td><a href='" + (dataArray[i][11]) +"'target='_blank'><img src="+dataArray[i][11]+" height='40px'></td>";
            }
        
            result += "<td>" +dataArray[i][3]+ "</td>"; //ชื่อ  
            
            // Payment Method Logic
            if (dataArray[i][7] == 'โอน' ){
                result += "<td><span class='text-primary sfont'><i class='fa-solid fa-mobile'></i> โอน</span></td>";
            } else if (dataArray[i][7] == 'จ่ายสด' ){
                result += "<td><span class='text-success sfont'><i class='fa-solid fa-hand-holding-dollar'></i> จ่ายสด</span></td>";
            }

            result += "<td>" +dataArray[i][8]+ "</td>"; //หมายเหตุ
            result += "<td>" +dataArray[i][12]+ "</td>"; //ผู้บันทึก
            
            // PDF Logic
            if (dataArray[i][15] != ''){    
                result += "<td>" ;
                result += "<a href='" + (dataArray[i][15]) +"'target='_blank'><i class='fa-solid fa-file-pdf fa-2xl' style='color: #008000'></i></a>" ;
                result += "</td>" ; 
            }else{
                result += "<td></td>" ;
            }

            result += "<td><button type='button' class='btn btn-warning btn-xs me-2' id="+dataArray[i][0]+" onclick='updateData(this.id);' ><i class='fa-solid fa-pen-to-square'></i></button><button type='button' class='btn btn-danger btn-xs' id="+dataArray[i][0]+"  onclick='delData(this.id);'><i class='fa-solid fa-trash'></i></button></td>"; 
            result += "</tr>";
        }
        result += "</table>";
        
        var div = document.getElementById('datatable');
        div.innerHTML = result;
        loadingEnd();

        $(document).ready(function() {
            $('#datatable').DataTable({
                destroy: true,
                lengthMenu: [
                    [10, 25, 50, 100, -1],
                    ['10', '25', '50', '100', 'ทั้งหมด']
                ],
                pageLength: 50, 
                order: [[2, "รอตรวจสอบ", "ให้ติดต่อแอดมิน", "โอนคืน", "ตรวจสอบแล้ว"]],
                columnDefs: [
                    (admin === "") ? { targets: [-1], visible: false } : { targets: [-1], visible: true },
                    { targets: [0, -1], className: 'all' } 
                ],
                language: {
                    sLengthMenu: "แสดง _MENU_ ",
                    sZeroRecords: "ไม่พบข้อมูล",
                    sInfo: '<i class="fas fa-angle-double-left"></i> _START_ ถึง _END_ จาก _TOTAL_ <i class="fas fa-angle-double-right"></i>',
                    sInfoEmpty: "แสดง 0 ถึง 0 จาก 0 แถว",
                    sInfoFiltered: "(กรองข้อมูล _MAX_ ทุกแถว)",
                    sSearch: '<i class="fas fa-search" fa-2x></i> ค้นหา : ',
                    oPaginate:{
                        sPrevious: '<i class="fas fa-chevron-left fa-lg"></i>',
                        sNext: '<i class="fas fa-chevron-right fa-lg"></i>',
                    }, 
                },
            });
            $.fn.DataTable.ext.pager.numbers_length = 4;
        });  
    }

    // --- ฟังก์ชันสำหรับ Checkbox ---
    function toggleAll(source) {
        checkboxes = document.getElementsByClassName('rowCheckbox');
        for(var i=0, n=checkboxes.length;i<n;i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    // --- ฟังก์ชัน Batch Run PDF ---
    async function runSelectedPDFs() {
        // หา checkbox ที่ถูกเลือก
        let checkedBoxes = $('.rowCheckbox:checked');
        let selectedIds = [];
        
        checkedBoxes.each(function() {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'กรุณาเลือกรายการ',
                text: 'ยังไม่ได้เลือกรายการที่จะสร้าง PDF'
            });
            return;
        }

        // ยืนยันการทำรายการ
        let confirm = await Swal.fire({
            title: 'ยืนยันการสร้าง PDF',
            text: `ต้องการสร้าง PDF จำนวน ${selectedIds.length} รายการใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ใช่, สร้างเลย',
            cancelButtonText: 'ยกเลิก'
        });

        if (!confirm.isConfirmed) return;

        // เริ่มวนลูปสร้างทีละรายการ
        Swal.fire({
            title: 'กำลังดำเนินการ...',
            html: 'กำลังเตรียมข้อมูล',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        for (let i = 0; i < selectedIds.length; i++) {
            let id = selectedIds[i];
            
            // อัปเดตข้อความบน Swal
            Swal.getHtmlContainer().textContent = `กำลังสร้าง PDF รายการที่ ${i + 1} จาก ${selectedIds.length} (ID: ${id})`;
            
            try {
                // เรียก API ไปที่ GAS (เพิ่ม action: runPDF)
                await callApi('runPDF', { id: id });
            } catch (error) {
                console.error(`Error processing ID ${id}:`, error);
                // อาจจะเก็บ error ไว้บอก user ทีหลัง แต่ให้ลูปทำงานต่อ
            }
        }

        // เสร็จสิ้น
        Swal.fire({
            icon: 'success',
            title: 'เสร็จสิ้น',
            text: `ดำเนินการครบ ${selectedIds.length} รายการแล้ว`,
            timer: 2000
        });

        // โหลดข้อมูลใหม่เพื่อแสดงผลลัพธ์ (เช่น ปุ่ม PDF ขึ้นมา)
        getData(admin);
    }

    // 4. Form Submission & File Handling
    async function submitForm(formObj){
       event.preventDefault();
       $('#add2').show();
       $('#add').hide();
       
       // Prepare Data Object from Form
       const formData = new FormData(formObj);
       const obj = Object.fromEntries(formData.entries());
       
       // Handle File Upload (Convert to Base64)
       const fileInput = document.getElementById('myFile');
       if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const base64String = await toBase64(file);
            // สร้าง object ไฟล์สำหรับส่งไป GAS
            obj.myFile = {
                name: file.name,
                mimeType: file.type,
                data: base64String.split(',')[1] // เอาส่วนหัว data:image/...;base64, ออก
            };
       } else {
            obj.myFile = ""; // ไม่มีไฟล์ใหม่
       }

       let numid = $('#numid').val();
       let action = (numid == "") ? 'addRecord' : 'updateRecord';

       // Call API
       callApi(action, { form: obj })
       .then(data => {
            success(data);
       })
       .catch(err => {
            $('#add2').hide();
            $('#add').show();
       });
    }

    function success(data){
        $('#myForm')[0].reset();
        getData(admin);
        loaddata();
        $('#add2').hide();
        $('#add').show();
        $('#img').hide();
        $('#btnclose').click();
        $('#Modaltableresult').modal('show');
        Swal.fire({
            position: 'top',
            icon: 'success',
            title: 'บันทึกข้อมูลสำเร็จ',
            showConfirmButton: false,
            timer: 1500
        });

        // Show result in modal
        var result = "<table>";
        var headerRow = item[0];
        for (i = 0; i < headerRow.length; i++) {  
            result += "<tr>";
            if(data[i]==""){
                result += "";
            }else{
                result += "<th>" +headerRow[i]+ "</th>";
                result += '<td>'+ (data[i]= /www |http/.test(data[i]) ? '<a target="_blank" href='+data[i] + '><img src='+data[i]+' height="60px"></a>': data[i]) + '</td>'; 
            }
            result += "</tr>";
        }
        result += "</table>";    
        $('#tb').html(result); 
        $('#pfile2').hide();
    }

    // 5. Update & Delete
    function updateData(id){
         $('#Modaladd').modal('show');
         $('#oldfile2').show();
         $('#dnote').show();
         $('#dnote1').show();
         $('#dnote2').show();
         $('#dnote3').hide();
         $('#dnote4').hide();
         $('#dnote5').hide();
         $('#dnote6').show();
         document.getElementById('fullname').value = localStorage.getItem('Name');
         
         $('input[name="datastud5"]').prop('checked', false);

        var dataArray = item.filter(r=>{return r[0]===  id.toString()})  

        if(dataArray != ""){
            dataArray = dataArray[0]
            $('#numid').val(dataArray[0])
            $('#datastud1').val(dataArray[3])
            $('#datastud2').val(dataArray[4])
            $('#datastud3').val(dataArray[5])
            $('#datastud4').val(dataArray[6])
            
            $('input[name="datastud5"][value="' + dataArray[7] + '"]').prop('checked', true);

            $('#datastud6').val(dataArray[8])
            $('#datastud7').val(new Date().toISOString().split('T')[0]) 
            $('#datastud8').val(dataArray[9])
            $('#datastud9').val(dataArray[10])
            $('#oldfile').val(dataArray[11])
            $("#oldfile2").attr("src",dataArray[11]);
            $('#pfile2').show()
            $('#myFile').hide()
            $('#img').hide()
        }
    }

    function delData(id){
        var dataArray = item.filter(r=>{return r[0]===  id.toString()})  
        var oldfile = "";
        var record = "";

        if(dataArray != ""){
            dataArray = dataArray[0]
            oldfile =  dataArray[11]
            record = dataArray[0]
        }

        Swal.fire({
            position : 'top',
            title: 'คุณแน่ใจว่าจะลบ?',
            text: "ข้อมูลจะไม่สามารถกู้คืนได้!",
            icon: 'warning',
            showCancelButton: true,
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#0d6efd',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ตกลง',
        }).then((result) => {
            if (result.isConfirmed) {
                loadingStart();
                // Call API action: 'delRecord'
                callApi('delRecord', { record: record, oldfile: oldfile })
                .then(() => {
                    $('#myForm')[0].reset() 
                    getData(admin);
                    loadingEnd()  
                    Swal.fire({
                        position: 'top',
                        title:'เรียบร้อย!',
                        text: 'ข้อมูลถูกลบเรียบร้อย.',
                        icon: 'success',
                        confirmButtonColor: '#0d6efd',
                        confirmButtonText: 'ตกลง'
                    })
                });
            }
        });
    }

    // 6. Login Logic
    function formLogin(){
        Swal.fire({
            template: '#formLogin',
            showConfirmButton: false,
            position: 'top',
            allowOutsideClick : false,
        })
    }

    function login(){
        event.preventDefault();
        loadingStart();
        const username = $("#username").val();
        const pwd = $("#password").val();
        Swal.close();
        
        // Call API action: 'checkLogin'
        callApi('checkLogin', { username: username, pwd: pwd })
        .then(output => {
            if(output !== 'null'){
                localStorage.setItem('userName',output[0]);
                localStorage.setItem('Name',output[1]);
                admin = output[0];
                getData();
                $("#btnlogin").hide();
                $(".logout").show();
                $("#msg-name").html(admin);
                $(".fablogin").hide();
                $(".fablogout").show();
                $("#btnBatchPDF").show(); // Show PDF button
            } else {
                loadingEnd();      
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'error',
                    title: 'ไม่พบข้อมูล!!'
                });
            }
        });
    }

    function logout(){
        Swal.fire({
            position: 'top',
            title: 'คุณต้องการออกจากระบบ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0d6efd',
            cancelButtonColor: '#d33',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ตกลง'
        }).then((result) => {
            if (result.isConfirmed) {
                loadingStart();
                $(".logout").hide();
                $("#btnlogin").show();
                $(".fablogin").show();
                $(".fablogout").hide();
                $("#btnBatchPDF").hide(); // Hide PDF button
                admin = "";
                getData();
                localStorage.removeItem('userName');
                localStorage.removeItem('Name');
            }
        });
    }

    // 7. Utility
    function btnadd(){
      $('#Modaladd').modal('show');
      $('#myForm')[0].reset() 
      document.getElementById('datastud7').value = new Date().toISOString().split('T')[0]; 

      $('#pfile2').hide()
      $('#myFile').show()
      $('#img').hide()
      $('#dnote').hide()
      $('#dnote0').hide()
      $('#dnote1').hide()
      $('#dnote2').hide()
      $('#dnote3').hide()
      $('#dnote4').hide()
      $('#dnote5').hide()
      $('#dnote6').hide()
      document.getElementById('fullname').value = localStorage.getItem('Name')
    }

    function pfile2(){
        $('#myFile').show();
        $('#pfile2').hide();
    }

    function fileValidation(){
        var fileInput = document.getElementById('myFile');
        if(fileInput.files[0].size > 5 * 1048576){
            Swal.fire({
                position: 'top',
                icon: 'info',
                title: 'คำเตือน !',
                text: 'ขนาดไฟล์ต้องไม่เกิน 5 mb',
                confirmButtonColor: '#0d6efd',
                confirmButtonText: 'ตกลง!'
            });
            fileInput.value=""
        } else {  
            $('#img').show();
            var filePath = fileInput.value;
            var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;
            if(!allowedExtensions.exec(filePath)){
                Swal.fire({
                    position: 'top',
                    icon: 'error',
                    title: 'กรุณาแนบไฟล์ภาพเท่านั้น!!',
                    showConfirmButton: false,
                    timer: 1500
                });
                fileInput.value = '';
                $('#img').hide();
                return false;
            } else {
                if (fileInput.files && fileInput.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('img').src = e.target.result
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                }
            }
        }
    }

    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0]; 
        const dateInput = document.getElementById('datastud7');
        if (dateInput) {
            dateInput.value = today;
        }
    }

    const myModalEl = document.getElementById('Modaladd');
    if (myModalEl) {
        myModalEl.addEventListener('show.bs.modal', function (event) {
            setTimeout(setTodayDate, 200); 
        });
    }
</script>

</body>
</html>
