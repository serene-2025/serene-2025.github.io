<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Message for Tag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .hover-lift {
            transition: all 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.8), 0 0 30px rgba(99, 102, 241, 0.6); }
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Mobile touch improvements */
        @media (max-width: 768px) {
            .touch-manipulation {
                touch-action: manipulation;
                min-height: 44px;
                min-width: 44px;
            }
            
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .tab-button {
                min-height: 48px;
            }
        }
        
        /* Improved scrolling on mobile */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="gradient-bg rounded-2xl p-8 text-white shadow-2xl bounce-in">
                <h1 class="text-5xl font-bold mb-3 bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">
                    üöÄ Message for Tag System ‚ú®
                </h1>
                <p class="text-blue-100 text-lg font-medium">üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Message for Tag üí´</p>
                <div id="connection-status" class="mt-4 text-sm">
                    <span class="inline-block bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full pulse-glow">
                        üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                    </span>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs - Mobile Optimized -->
        <div class="bg-white rounded-2xl shadow-xl mb-8 overflow-hidden slide-in">
            <nav class="flex border-b overflow-x-auto bg-gradient-to-r from-gray-50 to-white">
                <button onclick="showTab('users')" id="users-tab" class="tab-button px-4 sm:px-8 py-4 font-semibold text-indigo-600 border-b-3 border-indigo-600 whitespace-nowrap text-sm sm:text-base bg-white shadow-sm transition-all duration-300 hover:bg-indigo-50">
                    <span class="flex items-center space-x-2">
                        <span class="text-lg">üë•</span>
                        <span>Users</span>
                    </span>
                </button>
                <button onclick="showTab('tags')" id="tags-tab" class="tab-button px-4 sm:px-8 py-4 font-semibold text-gray-500 hover:text-indigo-600 whitespace-nowrap text-sm sm:text-base transition-all duration-300 hover:bg-gray-50">
                    <span class="flex items-center space-x-2">
                        <span class="text-lg">üè∑Ô∏è</span>
                        <span>Tags</span>
                    </span>
                </button>
                <button onclick="showTab('messages')" id="messages-tab" class="tab-button px-4 sm:px-8 py-4 font-semibold text-gray-500 hover:text-indigo-600 whitespace-nowrap text-sm sm:text-base transition-all duration-300 hover:bg-gray-50">
                    <span class="flex items-center space-x-2">
                        <span class="text-lg">üí¨</span>
                        <span>Messages</span>
                    </span>
                </button>
                <button onclick="showTab('logs')" id="logs-tab" class="tab-button px-4 sm:px-8 py-4 font-semibold text-gray-500 hover:text-indigo-600 whitespace-nowrap text-sm sm:text-base transition-all duration-300 hover:bg-gray-50">
                    <span class="flex items-center space-x-2">
                        <span class="text-lg">üìä</span>
                        <span>Logs</span>
                    </span>
                </button>
                <button onclick="showTab('line-push')" id="line-push-tab" class="tab-button px-4 sm:px-8 py-4 font-semibold text-gray-500 hover:text-indigo-600 whitespace-nowrap text-sm sm:text-base transition-all duration-300 hover:bg-gray-50">
                    <span class="flex items-center space-x-2">
                        <span class="text-lg">üöÄ</span>
                        <span>LINE Push</span>
                    </span>
                </button>
            </nav>
        </div>

        <!-- Users Tab -->
        <div id="users-content" class="tab-content">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8 hover-lift border border-gray-100">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <span class="text-white text-xl">üë§</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
                </div>
                <form id="user-form" class="space-y-4">
                    <div>
                        <label for="user-id" class="block text-sm font-medium text-gray-700 mb-2">üÜî User ID</label>
                        <input type="text" id="user-id" name="userId" required placeholder="Uc55b7ece3e62dbc0cb0e8353935671e5" class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="display-name" class="block text-sm font-medium text-gray-700 mb-2">üë§ Display Name</label>
                        <input type="text" id="display-name" name="displayName" required placeholder="Ton Samaiklag" class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="picture-url" class="block text-sm font-medium text-gray-700 mb-2">üñºÔ∏è Picture URL</label>
                        <input type="url" id="picture-url" name="pictureUrl" placeholder="https://profile.line-scdn.net/..." class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="user-tags" class="block text-sm font-medium text-gray-700 mb-2">üè∑Ô∏è Tags</label>
                        <div id="tags-selector" class="w-full px-3 py-3 border border-gray-300 rounded-md min-h-[50px] bg-white">
                            <div class="text-gray-500 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Tags...</div>
                        </div>
                        <input type="hidden" id="user-tags" name="tags">
                    </div>
                    <div>
                        <label for="house-number" class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                        <input type="text" id="house-number" name="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" placeholder="998/96" class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 text-base">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ üéâ
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                <div id="users-list" class="space-y-3">
                    <div class="text-center py-4">
                        <div class="loading w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags Tab -->
        <div id="tags-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üè∑Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° Tag ‡πÉ‡∏´‡∏°‡πà ‚ú®</h2>
                <form id="tag-form" class="space-y-4">
                    <div>
                        <label for="tag-name" class="block text-sm font-medium text-gray-700 mb-2">üéØ Tag Name</label>
                        <input type="text" id="tag-name" name="tagName" required placeholder="vip, ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á, ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Tag üéä
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Tags</h3>
                <div id="tags-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center py-4 md:col-span-2 lg:col-span-3">
                        <div class="loading w-8 h-8 border-4 border-green-200 border-t-green-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messages-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üí¨ ‡∏™‡πà‡∏á Push Message üöÄ</h2>
                <form id="message-form" class="space-y-4">
                    <div>
                        <label for="message-id" class="block text-sm font-medium text-gray-700 mb-2">üÜî Message ID</label>
                        <input type="text" id="message-id" name="id" required placeholder="a123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="message-name" class="block text-sm font-medium text-gray-700 mb-2">üìù Message Name</label>
                        <input type="text" id="message-name" name="name" required placeholder="‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="message-type" class="block text-sm font-medium text-gray-700 mb-2">üì± Message Type (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 p-3 border border-gray-300 rounded-md bg-gray-50">
                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-2 rounded transition-colors">
                                <input type="checkbox" value="Text" class="rounded text-purple-600 focus:ring-purple-500" onchange="updateMessageTypes()">
                                <span class="text-sm font-medium">üìù Text</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-2 rounded transition-colors">
                                <input type="checkbox" value="Flex" class="rounded text-purple-600 focus:ring-purple-500" onchange="updateMessageTypes()">
                                <span class="text-sm font-medium">üé® Flex</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-2 rounded transition-colors">
                                <input type="checkbox" value="Image" class="rounded text-purple-600 focus:ring-purple-500" onchange="updateMessageTypes()">
                                <span class="text-sm font-medium">üñºÔ∏è Image</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-2 rounded transition-colors">
                                <input type="checkbox" value="Video" class="rounded text-purple-600 focus:ring-purple-500" onchange="updateMessageTypes()">
                                <span class="text-sm font-medium">üé¨ Video</span>
                            </label>
                        </div>
                        <input type="hidden" id="message-type" name="type" required>
                        <div id="selected-message-types" class="mt-2 flex flex-wrap gap-1"></div>
                    </div>
                    <div>
                        <label for="message-content" class="block text-sm font-medium text-gray-700 mb-2">üìÑ Content</label>
                        <div class="relative">
                            <textarea id="message-content" name="content" rows="8" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm">[{
  "type": "flex",
  "altText": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°",
  "contents": {
    
  }
}]</textarea>
                            <button type="button" onclick="formatJSON()" class="absolute top-2 right-2 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 px-3 py-1 rounded-full text-xs transition duration-200 border border-gray-300 shadow-sm">
                                üé® Format JSON ‚ú®
                            </button>
                        </div>
                        <div class="mt-3 space-y-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-700">üéØ Quick Templates:</span>
                                <button type="button" onclick="insertTemplate('base')" class="bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-700 px-3 py-1 rounded-full text-xs transition duration-200 border border-purple-200">
                                    ‚ö° Base Template
                                </button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <button type="button" onclick="insertTemplate('text')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-blue-200 flex items-center justify-center space-x-1">
                                    <span>üìù</span><span>Text</span>
                                </button>
                                <button type="button" onclick="insertTemplate('bubble')" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-green-200 flex items-center justify-center space-x-1">
                                    <span>üí¨</span><span>Bubble</span>
                                </button>
                                <button type="button" onclick="insertTemplate('carousel')" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-purple-200 flex items-center justify-center space-x-1">
                                    <span>üé†</span><span>Carousel</span>
                                </button>
                                <button type="button" onclick="insertTemplate('image')" class="bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-orange-200 flex items-center justify-center space-x-1">
                                    <span>üñºÔ∏è</span><span>Image</span>
                                </button>
                                <button type="button" onclick="insertTemplate('video')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-red-200 flex items-center justify-center space-x-1">
                                    <span>üé¨</span><span>Video</span>
                                </button>
                                <button type="button" onclick="insertTemplate('location')" class="bg-teal-100 hover:bg-teal-200 text-teal-700 px-3 py-2 rounded-lg text-xs transition duration-200 border border-teal-200 flex items-center justify-center space-x-1">
                                    <span>üìç</span><span>Location</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° üéØ
                        </button>
                    </div>
                </form>
            </div>



            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
                <div id="messages-list" class="space-y-4">
                    <div class="text-center py-4">
                        <div class="loading w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                <div id="logs-list" class="space-y-3">
                    <div class="text-center py-4">
                        <div class="loading w-8 h-8 border-4 border-orange-200 border-t-orange-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- LINE Push Message Tab -->
        <div id="line-push-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8 hover-lift border border-gray-100">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-xl flex items-center justify-center">
                        <span class="text-white text-xl">üöÄ</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">LINE Push Message for Tag System</h2>
                </div>
                
                <!-- Connection Status -->
                <div id="line-connection-status" class="mb-6 p-4 rounded-lg bg-gray-50">
                    <div class="flex items-center space-x-2">
                        <div class="loading w-4 h-4 border-2 border-gray-300 border-t-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE API...</span>
                    </div>
                </div>

                <!-- Send Message Form -->
                <form id="line-push-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="line-message-select" class="block text-sm font-medium text-gray-700 mb-2">üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                            <select id="line-message-select" name="messageId" required class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">üîΩ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</option>
                            </select>
                        </div>
                        <div>
                            <label for="line-tags-input" class="block text-sm font-medium text-gray-700 mb-2">üè∑Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tags</label>
                            <input type="text" id="line-tags-input" name="tags" placeholder="vip, ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á" required class="w-full px-3 py-3 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">üí° ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,)</p>
                        </div>
                    </div>
                    
                    <!-- Available Tags Display -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üè∑Ô∏è Tags ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà:</label>
                        <div id="available-tags-display" class="flex flex-wrap gap-2 p-3 bg-gray-50 rounded-md min-h-[50px]">
                            <div class="text-gray-500 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Tags...</div>
                        </div>
                    </div>

                    <!-- Users Preview for Selected Tags -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</label>
                        <div id="users-preview" class="p-4 bg-blue-50 rounded-md border min-h-[100px] max-h-[200px] overflow-y-auto">
                            <p class="text-gray-500 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tags ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
                        </div>
                    </div>

                    <!-- Message Preview -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üëÄ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</label>
                        <div id="message-preview" class="p-4 bg-gray-50 rounded-md border min-h-[100px]">
                            <p class="text-gray-500 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
                        </div>
                    </div>

                    <!-- Send Options -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-3">‚öôÔ∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á:</h3>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="test-mode" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-blue-700">üß™ ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 1 ‡∏Ñ‡∏ô)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="confirm-send" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-blue-700">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                            </label>
                        </div>
                    </div>

                    <!-- Send Button -->
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-medium py-4 px-6 rounded-lg transition duration-200 text-base shadow-lg">
                            üöÄ ‡∏™‡πà‡∏á LINE Push Message ‚ú®
                        </button>
                        <button type="button" onclick="previewMessage()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-4 px-6 rounded-lg transition duration-200 text-base border border-gray-300">
                            üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </form>
            </div>

            <!-- Sending Progress -->
            <div id="sending-progress" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</h3>
                <div class="space-y-4">
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-gradient-to-r from-green-500 to-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="text-center text-gray-600">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á...</div>
                    <div id="progress-details" class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-600" id="total-users">0</div>
                            <div class="text-sm text-gray-500">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600" id="success-count">0</div>
                            <div class="text-sm text-gray-500">‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-600" id="failed-count">0</div>
                            <div class="text-sm text-gray-500">‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Push History -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á LINE Push Message</h3>
                <div id="line-push-history" class="space-y-3">
                    <div class="text-center py-4">
                        <div class="loading w-8 h-8 border-4 border-green-200 border-t-green-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
            <span id="toast-message">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
        </div>


    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyLyI8xg-ADFLofen9O7h0Z3odWJ5kNtFyJBLs6YtVqb7WX5Os4cpqLr3ivGreDa8mA/exec';
        const LINE_API_URL = 'https://script.google.com/macros/s/AKfycbyFutXxWIBd5mZyU8MJA0MLVy7slHogKmAre7qnK4s9ZN3oKWpNNIyszL4T887PJhj7Sw/exec';
        let isConnected = false;
        let lineApiConnected = false;
        
        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents with fade out
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('fade-in');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-indigo-600', 'border-b-3', 'border-indigo-600', 'bg-white', 'shadow-sm');
                button.classList.add('text-gray-500');
            });
            
            // Show selected tab content with animation
            const selectedContent = document.getElementById(tabName + '-content');
            selectedContent.classList.remove('hidden');
            setTimeout(() => {
                selectedContent.classList.add('fade-in');
            }, 50);
            
            // Add active state to selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.remove('text-gray-500');
            activeTab.classList.add('text-indigo-600', 'border-b-3', 'border-indigo-600', 'bg-white', 'shadow-sm');
            
            // Load data for the selected tab
            loadTabData(tabName);
        }

        // Connection Status
        function updateConnectionStatus(connected, message = '') {
            const statusDiv = document.getElementById('connection-status');
            isConnected = connected;
            
            if (connected) {
                statusDiv.innerHTML = `
                    <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full">
                        ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    </span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full">
                        ‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets (‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Demo)
                    </span>
                `;
            }
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // Set color based on type
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white`;
            
            // Show toast
            toast.classList.remove('translate-x-full');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }



        // API Functions with proper Google Apps Script integration
        async function sendToGoogleSheets(action, data) {
            try {
                console.log('Sending to Google Sheets:', { action, data });

                
                // Map actions to match Google Apps Script expectations
                const actionMap = {
                    'addUser': 'add',
                    'updateUser': 'update', 
                    'deleteUser': 'delete',
                    'addTag': 'add',
                    'updateTag': 'update',
                    'deleteTag': 'delete',
                    'addMessage': 'add',
                    'updateMessage': 'update',
                    'deleteMessage': 'delete',
                    'addLog': 'add'
                };
                
                const mappedAction = actionMap[action] || action;
                
                // Determine sheet based on action
                let sheet = 'Users';
                if (action.includes('Tag')) sheet = 'Tags';
                else if (action.includes('Message')) sheet = 'Messages';
                else if (action.includes('Log')) sheet = 'Logs';
                
                const payload = {
                    action: mappedAction,
                    sheet: sheet,
                    data: JSON.stringify(data)
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(payload).toString()
                });
                
                const result = await response.text();
                console.log('Google Sheets response:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success) {

                        updateConnectionStatus(true);
                        return { success: true, message: 'Data saved to Google Sheets successfully' };
                    } else {
                        throw new Error(jsonResult.error || 'Unknown error from Google Sheets');
                    }
                } catch (parseError) {
                    // If response is not JSON, assume success (some Apps Script versions return plain text)

                    updateConnectionStatus(true);
                    return { success: true, message: 'Data sent successfully' };
                }
                
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);

                updateConnectionStatus(false);
                
                // Show error to user but don't break the app
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function getFromGoogleSheets(sheet) {
            try {
                console.log('Getting from Google Sheets:', sheet);

                
                const response = await fetch(`${API_URL}?action=get&sheet=${sheet}`, {
                    method: 'GET'
                });
                
                const result = await response.text();
                console.log('Google Sheets GET response:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success && jsonResult.data) {

                        updateConnectionStatus(true);
                        return jsonResult.data;
                    } else {
                        throw new Error(jsonResult.error || 'No data returned');
                    }
                } catch (parseError) {
                    console.log('Failed to parse response, using demo data');

                    updateConnectionStatus(false);
                    return getDemoData(sheet);
                }
                
            } catch (error) {
                console.error('Error getting from Google Sheets:', error);

                updateConnectionStatus(false);
                return getDemoData(sheet);
            }
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Demo data for testing
        function getDemoData(sheet) {
            const demoData = {
                'Users': [
                    {
                        userId: 'Uc55b7ece3e62dbc0cb0e8353935671e5',
                        displayName: 'Ton Samaiklag',
                        pictureUrl: '',
                        tags: 'vip, ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•',
                        ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: '998/96',
                        timestamp: new Date().toLocaleString('th-TH')
                    }
                ],
                'Tags': [
                    { tagName: 'vip', timestamp: new Date().toLocaleString('th-TH') },
                    { tagName: '‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', timestamp: new Date().toLocaleString('th-TH') },
                    { tagName: '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', timestamp: new Date().toLocaleString('th-TH') }
                ],
                'Messages': [
                    {
                        id: 'a123',
                        name: '‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                        type: 'Flex',
                        content: JSON.stringify([{
                            "type": "flex",
                            "altText": "‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©!",
                            "contents": {
                                "type": "bubble",
                                "body": {
                                    "type": "box",
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "üéâ ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©!",
                                            "weight": "bold",
                                            "size": "xl",
                                            "color": "#FF6B6B"
                                        },
                                        {
                                            "type": "text",
                                            "text": "‚ú® ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
                                            "size": "sm",
                                            "color": "#666666",
                                            "margin": "md"
                                        }
                                    ]
                                }
                            }
                        }], null, 2),
                        timestamp: new Date().toLocaleString('th-TH')
                    },
                    {
                        id: 'b456',
                        name: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                        type: 'Text',
                        content: JSON.stringify([{
                            "type": "text",
                            "text": "üè† ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á\n\n‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n\nüí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: 1,500 ‡∏ö‡∏≤‡∏ó\nüìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞: 5 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2567\n\n‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö üôè"
                        }], null, 2),
                        timestamp: new Date().toLocaleString('th-TH')
                    }
                ],
                'Logs': [
                    {
                        date: new Date().toLocaleDateString('th-TH'),
                        time: new Date().toLocaleTimeString('th-TH'),
                        messageId: 'a123',
                        tags: 'vip',
                        totalUsers: 1,
                        successCount: 1,
                        failedCount: 0,
                        errors: '[]'
                    }
                ]
            };
            
            return demoData[sheet] || [];
        }

        // Test connection on startup
        async function testConnection() {
            try {

                const response = await fetch(`${API_URL}?action=get&sheet=Users`, {
                    method: 'GET'
                });
                
                const result = await response.text();
                const jsonResult = JSON.parse(result);
                
                if (jsonResult.success !== undefined) {
                    updateConnectionStatus(true);

                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                updateConnectionStatus(false);

            }
        }

        // Load Tab Data
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'users':
                    await loadUsers();
                    break;
                case 'tags':
                    await loadTags();
                    break;
                case 'messages':
                    await loadMessages();
                    break;
                case 'logs':
                    await loadLogs();
                    break;
                case 'line-push':
                    await loadLinePushData();
                    break;
            }
        }

        // LINE API Functions
        async function testLineApiConnection() {
            try {
                const response = await fetch(`${LINE_API_URL}?action=test`, {
                    method: 'GET'
                });
                
                const result = await response.text();
                console.log('LINE API test response:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success !== undefined) {
                        updateLineConnectionStatus(true);
                        return true;
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (parseError) {
                    updateLineConnectionStatus(false);
                    return false;
                }
            } catch (error) {
                console.error('LINE API connection test failed:', error);
                updateLineConnectionStatus(false);
                return false;
            }
        }

        function updateLineConnectionStatus(connected, message = '') {
            const statusDiv = document.getElementById('line-connection-status');
            lineApiConnected = connected;
            
            if (connected) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-green-700">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                    </div>
                `;
                statusDiv.className = 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200';
            } else {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="text-sm text-red-700">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE API (‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Demo)</span>
                    </div>
                `;
                statusDiv.className = 'mb-6 p-4 rounded-lg bg-red-50 border border-red-200';
            }
        }

        async function sendLineMessage(messageData) {
            try {
                console.log('Sending LINE message:', messageData);
                
                const payload = {
                    action: 'sendMessage',
                    messageId: messageData.messageId,
                    tags: messageData.tags,
                    testMode: messageData.testMode || false
                };
                
                const response = await fetch(LINE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(payload).toString()
                });
                
                const result = await response.text();
                console.log('LINE API send response:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    return jsonResult;
                } catch (parseError) {
                    // If response is not JSON, assume success
                    return { 
                        success: true, 
                        totalUsers: 1, 
                        successCount: 1, 
                        failedCount: 0,
                        message: 'Message sent successfully'
                    };
                }
                
            } catch (error) {
                console.error('Error sending LINE message:', error);
                return { 
                    success: false, 
                    error: error.message,
                    totalUsers: 0,
                    successCount: 0,
                    failedCount: 1
                };
            }
        }

        async function getLinePushHistory() {
            try {
                const response = await fetch(`${LINE_API_URL}?action=getHistory`, {
                    method: 'GET'
                });
                
                const result = await response.text();
                console.log('LINE push history response:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success && jsonResult.data) {
                        return jsonResult.data;
                    } else {
                        throw new Error('No history data');
                    }
                } catch (parseError) {
                    // Return demo data if API fails
                    return getDemoLinePushHistory();
                }
                
            } catch (error) {
                console.error('Error getting LINE push history:', error);
                return getDemoLinePushHistory();
            }
        }

        function getDemoLinePushHistory() {
            return [
                {
                    timestamp: new Date().toLocaleString('th-TH'),
                    messageId: 'a123',
                    messageName: '‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                    tags: 'vip, ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•',
                    totalUsers: 15,
                    successCount: 14,
                    failedCount: 1,
                    testMode: false,
                    status: 'completed'
                },
                {
                    timestamp: new Date(Date.now() - 3600000).toLocaleString('th-TH'),
                    messageId: 'b456',
                    messageName: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                    tags: '‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                    totalUsers: 8,
                    successCount: 8,
                    failedCount: 0,
                    testMode: false,
                    status: 'completed'
                }
            ];
        }

        // Users Functions
        async function loadUsers() {
            try {
                const users = await getFromGoogleSheets('Users');
                const usersList = document.getElementById('users-list');
                
                if (users && users.length > 0) {
                    usersList.innerHTML = users.map((user, index) => `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in" id="user-${index}">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start space-y-3 sm:space-y-0">
                                <div class="flex items-start space-x-3 flex-1">
                                    ${user.pictureUrl ? `<img src="${user.pictureUrl}" alt="Profile" class="w-12 h-12 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none'">` : '<div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 flex-shrink-0">üë§</div>'}
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-semibold text-gray-800 text-base">${user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                                        <p class="text-gray-500 text-sm font-mono break-all">${user.userId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ User ID'}</p>
                                        <p class="text-gray-600 text-sm">üè† ${user.‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'}</p>
                                        ${user.tags ? `<div class="mt-2">
                                            ${user.tags.split(',').map(tag => `<span class="inline-block ${getTagColor(tag.trim())} text-xs px-2 py-1 rounded-full mr-1 mb-1 border font-medium">${tag.trim()}</span>`).join('')}
                                        </div>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-row sm:flex-col items-center sm:items-end justify-between sm:justify-start space-x-2 sm:space-x-0 sm:space-y-2">
                                    <span class="text-xs text-gray-400 order-2 sm:order-1">${user.timestamp || ''}</span>
                                    <div class="flex space-x-2 order-1 sm:order-2">
                                        <button onclick="editUser(${index}, ${JSON.stringify(user).replace(/"/g, '&quot;')})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded transition duration-200 touch-manipulation">
                                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                        </button>
                                        <button onclick="deleteUser(${index}, '${user.userId}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-2 rounded transition duration-200 touch-manipulation">
                                            üóëÔ∏è ‡∏•‡∏ö
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
                }
            } catch (error) {
                document.getElementById('users-list').innerHTML = '<p class="text-center text-red-500 py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        }

        // Tags Functions
        let availableTags = [];
        let selectedTags = [];
        
        // Tag colors for visual enhancement
        const tagColors = [
            'bg-red-100 text-red-800 border-red-200',
            'bg-blue-100 text-blue-800 border-blue-200', 
            'bg-green-100 text-green-800 border-green-200',
            'bg-yellow-100 text-yellow-800 border-yellow-200',
            'bg-purple-100 text-purple-800 border-purple-200',
            'bg-pink-100 text-pink-800 border-pink-200',
            'bg-indigo-100 text-indigo-800 border-indigo-200',
            'bg-orange-100 text-orange-800 border-orange-200',
            'bg-teal-100 text-teal-800 border-teal-200',
            'bg-cyan-100 text-cyan-800 border-cyan-200'
        ];
        
        function getTagColor(tagName) {
            // Generate consistent color based on tag name
            let hash = 0;
            for (let i = 0; i < tagName.length; i++) {
                hash = tagName.charCodeAt(i) + ((hash << 5) - hash);
            }
            return tagColors[Math.abs(hash) % tagColors.length];
        }

        async function loadTags() {
            try {
                const tags = await getFromGoogleSheets('Tags');
                availableTags = tags || [];
                const tagsList = document.getElementById('tags-list');
                
                if (tags && tags.length > 0) {
                    tagsList.innerHTML = tags.map((tag, index) => `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in" id="tag-${index}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 mb-2">üè∑Ô∏è ${tag.tagName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                                    <span class="text-xs text-gray-400">${tag.timestamp || ''}</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editTag(${index}, ${JSON.stringify(tag).replace(/"/g, '&quot;')})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </button>
                                    <button onclick="deleteTag(${index}, '${tag.tagName}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    tagsList.innerHTML = '<div class="md:col-span-2 lg:col-span-3"><p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Tags</p></div>';
                }
                
                // Update tags selector in user form
                updateTagsSelector();
            } catch (error) {
                document.getElementById('tags-list').innerHTML = '<div class="md:col-span-2 lg:col-span-3"><p class="text-center text-red-500 py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>';
            }
        }

        function updateTagsSelector() {
            const tagsSelector = document.getElementById('tags-selector');
            if (!tagsSelector) return;
            
            if (availableTags.length === 0) {
                tagsSelector.innerHTML = '<div class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Tags ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
                return;
            }
            
            tagsSelector.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    ${availableTags.map(tag => `
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" value="${tag.tagName}" onchange="toggleTag('${tag.tagName}')" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm">${tag.tagName}</span>
                        </label>
                    `).join('')}
                </div>
                <div id="selected-tags" class="mt-2 flex flex-wrap gap-1"></div>
            `;
        }

        function toggleTag(tagName) {
            const index = selectedTags.indexOf(tagName);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push(tagName);
            }
            
            updateSelectedTagsDisplay();
            document.getElementById('user-tags').value = selectedTags.join(', ');
        }

        function updateSelectedTagsDisplay() {
            const selectedTagsDiv = document.getElementById('selected-tags');
            if (!selectedTagsDiv) return;
            
            selectedTagsDiv.innerHTML = selectedTags.map(tag => `
                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                    ${tag}
                    <button onclick="removeTag('${tag}')" class="ml-1 text-blue-600 hover:text-blue-800">√ó</button>
                </span>
            `).join('');
        }

        function removeTag(tagName) {
            const index = selectedTags.indexOf(tagName);
            if (index > -1) {
                selectedTags.splice(index, 1);
                updateSelectedTagsDisplay();
                document.getElementById('user-tags').value = selectedTags.join(', ');
                
                // Uncheck the checkbox
                const checkbox = document.querySelector(`input[value="${tagName}"]`);
                if (checkbox) checkbox.checked = false;
            }
        }

        // Messages Functions
        async function loadMessages() {
            const messagesList = document.getElementById('messages-list');
            
            try {
                // Show loading state
                messagesList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full mx-auto"></div>
                        <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</p>
                    </div>
                `;
                
                const messages = await getFromGoogleSheets('Messages');
                console.log('Loaded messages:', messages);
                
                if (messages && Array.isArray(messages) && messages.length > 0) {
                    messagesList.innerHTML = messages.map((message, index) => `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in" id="message-${index}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">üí¨ ${message.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                                    <p class="text-gray-500 text-sm">ID: ${message.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | Type: ${message.type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="text-xs text-gray-400">${message.timestamp || ''}</span>
                                    <div class="flex space-x-2">
                                        <button onclick="toggleMessageContent(${index})" class="bg-gray-500 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                                            üëÅÔ∏è ‡∏î‡∏π
                                        </button>
                                        <button onclick="editMessage(${index}, ${JSON.stringify(message).replace(/"/g, '&quot;')})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                        </button>
                                        <button onclick="deleteMessage(${index}, '${message.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                                            üóëÔ∏è ‡∏•‡∏ö
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="message-content-${index}" class="bg-gray-50 rounded p-3 mt-2 hidden">
                                <div class="max-h-60 overflow-y-auto">
                                    <pre class="text-gray-700 text-xs whitespace-pre-wrap font-mono">${escapeHtml(message.content || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤')}</pre>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update message select dropdown for LINE Push
                    const lineMessageSelect = document.getElementById('line-message-select');
                    if (lineMessageSelect) {
                        lineMessageSelect.innerHTML = '<option value="">üîΩ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</option>' + 
                            messages.map(message => `<option value="${message.id}" data-content='${JSON.stringify(message)}'>${message.name} (${message.type})</option>`).join('');
                    }
                } else {
                    messagesList.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 text-4xl mb-3">üí¨</div>
                            <p class="text-gray-500 text-lg font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                            <p class="text-gray-400 text-sm mt-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 text-4xl mb-3">‚ö†Ô∏è</div>
                        <p class="text-red-600 text-lg font-medium">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <p class="text-red-500 text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <button onclick="loadMessages()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                `;
            }
        }

        // Logs Functions
        async function loadLogs() {
            try {
                const logs = await getFromGoogleSheets('Logs');
                const logsList = document.getElementById('logs-list');
                
                if (logs && logs.length > 0) {
                    logsList.innerHTML = logs.map(log => `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="font-medium text-gray-800">üì§ Message ID: ${log.messageId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${log.date || ''} ${log.time || ''}</span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-500">Tags:</span>
                                            <span class="font-medium">${log.tags || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Total Users:</span>
                                            <span class="font-medium text-blue-600">${log.totalUsers || '0'}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Success:</span>
                                            <span class="font-medium text-green-600">${log.successCount || '0'}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Failed:</span>
                                            <span class="font-medium text-red-600">${log.failedCount || '0'}</span>
                                        </div>
                                    </div>
                                    ${log.errors && log.errors !== '[]' ? `<div class="mt-2 p-2 bg-red-50 rounded text-red-700 text-sm">
                                        <strong>Errors:</strong> ${log.errors}
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    logsList.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>';
                }
            } catch (error) {
                document.getElementById('logs-list').innerHTML = '<p class="text-center text-red-500 py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        }

        // Edit and Delete Functions
        let editingIndex = -1;
        let editingType = '';

        function editUser(index, user) {
            editingIndex = index;
            editingType = 'user';
            
            document.getElementById('user-id').value = user.userId || '';
            document.getElementById('display-name').value = user.displayName || '';
            document.getElementById('picture-url').value = user.pictureUrl || '';
            document.getElementById('house-number').value = user.‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà || '';
            
            // Set selected tags
            selectedTags = user.tags ? user.tags.split(',').map(tag => tag.trim()) : [];
            updateSelectedTagsDisplay();
            document.getElementById('user-tags').value = selectedTags.join(', ');
            
            // Update checkboxes
            document.querySelectorAll('#tags-selector input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = selectedTags.includes(checkbox.value);
            });
            
            // Change button text
            const submitBtn = document.querySelector('#user-form button[type="submit"]');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            
            // Scroll to form
            document.getElementById('user-form').scrollIntoView({ behavior: 'smooth' });
        }

        function editTag(index, tag) {
            editingIndex = index;
            editingType = 'tag';
            
            document.getElementById('tag-name').value = tag.tagName || '';
            
            // Change button text
            const submitBtn = document.querySelector('#tag-form button[type="submit"]');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Tag';
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            
            // Scroll to form
            document.getElementById('tag-form').scrollIntoView({ behavior: 'smooth' });
        }

        function editMessage(index, message) {
            editingIndex = index;
            editingType = 'message';
            
            document.getElementById('message-id').value = message.id || '';
            document.getElementById('message-name').value = message.name || '';
            document.getElementById('message-type').value = message.type || '';
            document.getElementById('message-content').value = message.content || '';
            
            // Change button text
            const submitBtn = document.querySelector('#message-form button[type="submit"]');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            
            // Scroll to form
            document.getElementById('message-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Admin password for delete protection
        const ADMIN_PASSWORD = "admin";
        
        // Admin password dialog
        function showPasswordDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl">üîê</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
                    </div>
                    <p class="text-gray-600 mb-4 text-center">${message}</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:</label>
                        <input type="password" id="admin-password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        <p class="text-xs text-gray-500 mt-1">üí° ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: admin</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-3 px-4 rounded-md transition duration-200">
                            ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button id="confirm-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-md transition duration-200">
                            üóëÔ∏è ‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            const passwordInput = overlay.querySelector('#admin-password');
            passwordInput.focus();
            
            overlay.querySelector('#cancel-btn').onclick = () => {
                document.body.removeChild(overlay);
            };
            
            overlay.querySelector('#confirm-btn').onclick = () => {
                const password = passwordInput.value;
                if (password === ADMIN_PASSWORD) {
                    document.body.removeChild(overlay);
                    onConfirm();
                } else {
                    passwordInput.classList.add('border-red-500', 'bg-red-50');
                    passwordInput.value = '';
                    passwordInput.placeholder = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    setTimeout(() => {
                        passwordInput.classList.remove('border-red-500', 'bg-red-50');
                        passwordInput.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                    }, 2000);
                }
            };
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    overlay.querySelector('#confirm-btn').click();
                }
            });
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };
        }

        // Mobile-friendly confirmation dialog
        function showConfirmDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex space-x-3">
                        <button id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-3 px-4 rounded-md transition duration-200">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button id="confirm-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-md transition duration-200">
                            ‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            overlay.querySelector('#cancel-btn').onclick = () => {
                document.body.removeChild(overlay);
            };
            
            overlay.querySelector('#confirm-btn').onclick = () => {
                document.body.removeChild(overlay);
                onConfirm();
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };
        }

        async function deleteUser(index, userId) {
            showPasswordDialog(`üö® ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`, async () => {
                try {
                    await sendToGoogleSheets('deleteUser', { index: index });
                    showToast('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await loadUsers();
                } catch (error) {
                    showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
                }
            });
        }

        async function deleteTag(index, tagName) {
            showPasswordDialog(`üö® ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Tag "${tagName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`, async () => {
                try {
                    await sendToGoogleSheets('deleteTag', { index: index });
                    showToast('‚úÖ ‡∏•‡∏ö Tag ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await loadTags();
                } catch (error) {
                    showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Tag', 'error');
                }
            });
        }

        async function deleteMessage(index, messageId) {
            showPasswordDialog(`üö® ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "${messageId}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`, async () => {
                try {
                    await sendToGoogleSheets('deleteMessage', { index: index });
                    showToast('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await loadMessages();
                } catch (error) {
                    showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
                }
            });
        }

        function resetForm(formType) {
            editingIndex = -1;
            editingType = '';
            
            if (formType === 'user') {
                selectedTags = [];
                updateSelectedTagsDisplay();
                document.getElementById('user-tags').value = '';
                document.querySelectorAll('#tags-selector input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                const submitBtn = document.querySelector('#user-form button[type="submit"]');
                submitBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else if (formType === 'tag') {
                const submitBtn = document.querySelector('#tag-form button[type="submit"]');
                submitBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏° Tag';
                submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else if (formType === 'message') {
                const submitBtn = document.querySelector('#message-form button[type="submit"]');
                submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
                submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            }
        }

        // Form Handlers
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                userId: formData.get('userId'),
                displayName: formData.get('displayName'),
                pictureUrl: formData.get('pictureUrl') || '',
                tags: formData.get('tags') || '',
                ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: formData.get('‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà') || '',
                timestamp: new Date().toLocaleString('th-TH')
            };
            
            // Validate required fields
            if (!userData.userId || !userData.displayName) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User ID ‡πÅ‡∏•‡∏∞ Display Name', 'error');
                return;
            }
            
            try {
                console.log('Submitting user data:', userData);
                
                let result;
                if (editingType === 'user' && editingIndex >= 0) {
                    result = await sendToGoogleSheets('updateUser', { index: editingIndex, data: userData });
                    showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    result = await sendToGoogleSheets('addUser', userData);
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                }
                
                console.log('User operation result:', result);
                
                e.target.reset();
                resetForm('user');
                await loadUsers();
            } catch (error) {
                console.error('User form error:', error);
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            }
        });

        document.getElementById('tag-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const tagData = {
                tagName: formData.get('tagName'),
                timestamp: new Date().toLocaleString('th-TH')
            };
            
            try {
                if (editingType === 'tag' && editingIndex >= 0) {
                    await sendToGoogleSheets('updateTag', { index: editingIndex, data: tagData });
                    showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Tag ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    await sendToGoogleSheets('addTag', tagData);
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏° Tag ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                }
                
                e.target.reset();
                resetForm('tag');
                await loadTags();
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tag', 'error');
            }
        });

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const messageData = {
                id: formData.get('id'),
                name: formData.get('name'),
                type: formData.get('type'),
                content: formData.get('content'),
                timestamp: new Date().toLocaleString('th-TH')
            };
            
            try {
                if (editingType === 'message' && editingIndex >= 0) {
                    await sendToGoogleSheets('updateMessage', { index: editingIndex, data: messageData });
                    showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    await sendToGoogleSheets('addMessage', messageData);
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                }
                
                e.target.reset();
                resetForm('message');
                await loadMessages();
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
            }
        });



        // LINE Push Message Form Handler
        document.getElementById('line-push-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const messageId = formData.get('messageId');
            const tags = formData.get('tags');
            const testMode = document.getElementById('test-mode').checked;
            const confirmSend = document.getElementById('confirm-send').checked;
            
            // Validation
            if (!messageId) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á', 'error');
                return;
            }
            
            if (!tags) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Tags ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á', 'error');
                return;
            }
            
            if (!confirmSend) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
                return;
            }
            
            // Show simple confirmation dialog
            const confirmMessage = `üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á LINE Push Message\n\nüìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${messageId}\nüè∑Ô∏è Tags: ${tags}\n${testMode ? 'üß™ ‡πÇ‡∏´‡∏°‡∏î: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (1 ‡∏Ñ‡∏ô)' : 'üöÄ ‡πÇ‡∏´‡∏°‡∏î: ‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}\n\n‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
            
            showConfirmDialog(confirmMessage, async () => {
                try {
                    // Show progress
                    showSendingProgress();
                    
                    // Prepare message data
                    const messageData = {
                        messageId: messageId,
                        tags: tags,
                        testMode: testMode
                    };
                    
                    // Send message via LINE API
                    const result = await sendLineMessage(messageData);
                    
                    // Update progress
                    updateSendingProgress(result);
                    
                    // Save to logs
                    const logData = {
                        timestamp: new Date().toLocaleString('th-TH'),
                        messageId: messageId,
                        messageName: getMessageNameById(messageId),
                        tags: tags,
                        totalUsers: result.totalUsers || 0,
                        successCount: result.successCount || 0,
                        failedCount: result.failedCount || 0,
                        testMode: testMode,
                        status: result.success ? 'completed' : 'failed'
                    };
                    
                    // Save to both APIs
                    await sendToGoogleSheets('addLog', logData);
                    
                    // Show result
                    if (result.success) {
                        showToast(`üéâ ‡∏™‡πà‡∏á LINE Push Message ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${result.successCount}/${result.totalUsers})`, 'success');
                    } else {
                        showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, 'error');
                    }
                    
                    // Reset form and reload data
                    e.target.reset();
                    document.getElementById('test-mode').checked = false;
                    document.getElementById('confirm-send').checked = false;
                    previewMessage(); // Clear preview
                    
                    // Hide progress after delay
                    setTimeout(() => {
                        hideSendingProgress();
                    }, 3000);
                    
                    // Reload history
                    await loadLinePushHistory();
                    
                } catch (error) {
                    console.error('LINE Push error:', error);
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                    hideSendingProgress();
                }
            });
        });

        function getMessageNameById(messageId) {
            const messageSelect = document.getElementById('line-message-select');
            const option = messageSelect.querySelector(`option[value="${messageId}"]`);
            if (option && option.dataset.content) {
                try {
                    const messageData = JSON.parse(option.dataset.content);
                    return messageData.name;
                } catch (error) {
                    return messageId;
                }
            }
            return messageId;
        }

        function showSendingProgress() {
            const progressDiv = document.getElementById('sending-progress');
            progressDiv.classList.remove('hidden');
            progressDiv.scrollIntoView({ behavior: 'smooth' });
            
            // Reset progress
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á...';
            document.getElementById('total-users').textContent = '0';
            document.getElementById('success-count').textContent = '0';
            document.getElementById('failed-count').textContent = '0';
            
            // Animate progress bar
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '30%';
                document.getElementById('progress-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...';
            }, 500);
        }

        function updateSendingProgress(result) {
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-text').textContent = result.success ? '‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            document.getElementById('total-users').textContent = result.totalUsers || 0;
            document.getElementById('success-count').textContent = result.successCount || 0;
            document.getElementById('failed-count').textContent = result.failedCount || 0;
        }

        function hideSendingProgress() {
            const progressDiv = document.getElementById('sending-progress');
            progressDiv.classList.add('hidden');
        }

        // Message Type Functions
        let selectedMessageTypes = [];
        
        function updateMessageTypes() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][onchange="updateMessageTypes()"]');
            selectedMessageTypes = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedMessageTypes.push(checkbox.value);
                }
            });
            
            document.getElementById('message-type').value = selectedMessageTypes.join(', ');
            updateSelectedMessageTypesDisplay();
        }
        
        function updateSelectedMessageTypesDisplay() {
            const selectedDiv = document.getElementById('selected-message-types');
            if (!selectedDiv) return;
            
            const typeEmojis = {
                'Text': 'üìù',
                'Flex': 'üé®', 
                'Image': 'üñºÔ∏è',
                'Video': 'üé¨'
            };
            
            selectedDiv.innerHTML = selectedMessageTypes.map(type => `
                <span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full border border-purple-200">
                    ${typeEmojis[type] || 'üì±'} ${type}
                    <button onclick="removeMessageType('${type}')" class="ml-1 text-purple-600 hover:text-purple-800">√ó</button>
                </span>
            `).join('');
        }
        
        function removeMessageType(type) {
            const index = selectedMessageTypes.indexOf(type);
            if (index > -1) {
                selectedMessageTypes.splice(index, 1);
                updateSelectedMessageTypesDisplay();
                document.getElementById('message-type').value = selectedMessageTypes.join(', ');
                
                // Uncheck the checkbox
                const checkbox = document.querySelector(`input[value="${type}"][onchange="updateMessageTypes()"]`);
                if (checkbox) checkbox.checked = false;
            }
        }

        // JSON Template Functions
        function formatJSON() {
            const textarea = document.getElementById('message-content');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed, null, 2);
                showToast('JSON formatted successfully!', 'success');
            } catch (error) {
                showToast('Invalid JSON format', 'error');
            }
        }

        function insertTemplate(type) {
            const textarea = document.getElementById('message-content');
            let template = '';
            
            switch(type) {
                case 'base':
                    template = `[{
  "type": "flex",
  "altText": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°",
  "contents": {
    
  }
}]`;
                    break;
                case 'text':
                    template = `[{
  "type": "text",
  "text": "üåü ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö üåü"
}]`;
                    break;
                case 'bubble':
                    template = `[{
  "type": "flex",
  "altText": "üí¨ Bubble Message",
  "contents": {
    "type": "bubble",
    "hero": {
      "type": "image",
      "url": "https://via.placeholder.com/400x200/4F46E5/FFFFFF?text=üéâ+Hello+World",
      "size": "full",
      "aspectRatio": "20:10",
      "aspectMode": "cover"
    },
    "body": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": "üéâ Hello World!",
          "weight": "bold",
          "size": "xl",
          "color": "#333333"
        },
        {
          "type": "text",
          "text": "‚ú® This is a beautiful bubble message with emoji",
          "size": "sm",
          "color": "#666666",
          "margin": "md",
          "wrap": true
        }
      ]
    },
    "footer": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "button",
          "action": {
            "type": "uri",
            "label": "üöÄ Click Me",
            "uri": "https://example.com"
          },
          "style": "primary",
          "color": "#4F46E5"
        }
      ]
    }
  }
}]`;
                    break;
                case 'carousel':
                    template = `[{
  "type": "flex",
  "altText": "üé† Carousel Message",
  "contents": {
    "type": "carousel",
    "contents": [
      {
        "type": "bubble",
        "hero": {
          "type": "image",
          "url": "https://via.placeholder.com/300x200/EF4444/FFFFFF?text=üî•+Card+1",
          "size": "full",
          "aspectRatio": "20:13"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "üî• Card 1",
              "weight": "bold",
              "size": "xl"
            },
            {
              "type": "text",
              "text": "Amazing content here!",
              "size": "sm",
              "color": "#666666"
            }
          ]
        }
      },
      {
        "type": "bubble",
        "hero": {
          "type": "image",
          "url": "https://via.placeholder.com/300x200/10B981/FFFFFF?text=‚≠ê+Card+2",
          "size": "full",
          "aspectRatio": "20:13"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "‚≠ê Card 2",
              "weight": "bold",
              "size": "xl"
            },
            {
              "type": "text",
              "text": "More awesome content!",
              "size": "sm",
              "color": "#666666"
            }
          ]
        }
      }
    ]
  }
}]`;
                    break;
                case 'image':
                    template = `[{
  "type": "image",
  "originalContentUrl": "https://via.placeholder.com/800x600/8B5CF6/FFFFFF?text=üñºÔ∏è+Beautiful+Image",
  "previewImageUrl": "https://via.placeholder.com/400x300/8B5CF6/FFFFFF?text=üñºÔ∏è+Preview"
}]`;
                    break;
                case 'video':
                    template = `[{
  "type": "video",
  "originalContentUrl": "https://example.com/video.mp4",
  "previewImageUrl": "https://via.placeholder.com/800x450/DC2626/FFFFFF?text=üé¨+Video+Preview"
}]`;
                    break;
                case 'location':
                    template = `[{
  "type": "location",
  "title": "üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç",
  "address": "123 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110",
  "latitude": 13.7563,
  "longitude": 100.5018
}]`;
                    break;
            }
            
            textarea.value = template;
            
            // Add animation to textarea
            textarea.classList.add('border-green-400', 'bg-green-50');
            setTimeout(() => {
                textarea.classList.remove('border-green-400', 'bg-green-50');
            }, 1000);
            
            const templateNames = {
                'base': '‚ö° Base Template',
                'text': 'üìù Text Template',
                'bubble': 'üí¨ Bubble Template', 
                'carousel': 'üé† Carousel Template',
                'image': 'üñºÔ∏è Image Template',
                'video': 'üé¨ Video Template',
                'location': 'üìç Location Template'
            };
            
            showToast(`${templateNames[type]} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
        }

        // LINE Push Data Loading
        async function loadLinePushData() {
            try {
                // Test LINE API connection
                await testLineApiConnection();
                
                // Load messages for dropdown
                const messages = await getFromGoogleSheets('Messages');
                const messageSelect = document.getElementById('line-message-select');
                if (messages && messages.length > 0) {
                    messageSelect.innerHTML = '<option value="">üîΩ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</option>' + 
                        messages.map(message => `<option value="${message.id}" data-content='${JSON.stringify(message)}'>${message.name} (${message.type})</option>`).join('');
                } else {
                    messageSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>';
                }
                
                // Load available tags
                const tags = await getFromGoogleSheets('Tags');
                const tagsDisplay = document.getElementById('available-tags-display');
                if (tags && tags.length > 0) {
                    tagsDisplay.innerHTML = tags.map(tag => `
                        <button type="button" onclick="addTagToInput('${tag.tagName}')" class="inline-block ${getTagColor(tag.tagName)} text-xs px-3 py-1 rounded-full cursor-pointer hover:opacity-80 transition-opacity border font-medium">
                            ${tag.tagName}
                        </button>
                    `).join('');
                } else {
                    tagsDisplay.innerHTML = '<div class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ Tags</div>';
                }
                
                // Load push history
                await loadLinePushHistory();
                
            } catch (error) {
                console.error('Error loading LINE push data:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Push', 'error');
            }
        }

        async function loadLinePushHistory() {
            try {
                const history = await getLinePushHistory();
                const historyDiv = document.getElementById('line-push-history');
                
                if (history && history.length > 0) {
                    historyDiv.innerHTML = history.map(item => `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="font-medium text-gray-800">üì§ ${item.messageName || item.messageId}</span>
                                        <span class="text-xs ${item.testMode ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'} px-2 py-1 rounded">
                                            ${item.testMode ? 'üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö' : 'üöÄ ‡∏à‡∏£‡∏¥‡∏á'}
                                        </span>
                                        <span class="text-xs ${item.status === 'completed' ? 'bg-green-100 text-green-800' : item.status === 'failed' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded">
                                            ${item.status === 'completed' ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : item.status === 'failed' ? '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' : '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á'}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        <span class="font-medium">üè∑Ô∏è Tags:</span> ${item.tags}
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-500">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                            <span class="font-medium text-blue-600">${item.totalUsers || 0}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</span>
                                            <span class="font-medium text-green-600">${item.successCount || 0}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:</span>
                                            <span class="font-medium text-red-600">${item.failedCount || 0}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400">${item.timestamp}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á LINE Push Message</p>';
                }
            } catch (error) {
                document.getElementById('line-push-history').innerHTML = '<p class="text-center text-red-500 py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
            }
        }

        function addTagToInput(tagName) {
            const input = document.getElementById('line-tags-input');
            const currentValue = input.value.trim();
            
            if (currentValue === '') {
                input.value = tagName;
            } else {
                const tags = currentValue.split(',').map(tag => tag.trim());
                if (!tags.includes(tagName)) {
                    input.value = currentValue + ', ' + tagName;
                }
            }
            
            // Add visual feedback
            const button = event.target;
            button.classList.add('scale-95');
            setTimeout(() => {
                button.classList.remove('scale-95');
            }, 150);
            
            // Update users preview
            previewUsersByTags();
        }

        async function previewUsersByTags() {
            const tagsInput = document.getElementById('line-tags-input');
            const usersPreview = document.getElementById('users-preview');
            
            if (!tagsInput || !usersPreview) return;
            
            const tagsValue = tagsInput.value.trim();
            
            if (!tagsValue) {
                usersPreview.innerHTML = '<p class="text-gray-500 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tags ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>';
                return;
            }
            
            try {
                // Show loading
                usersPreview.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="loading w-4 h-4 border-2 border-blue-300 border-t-blue-600 rounded-full"></div>
                        <span class="text-sm text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</span>
                    </div>
                `;
                
                // Get users data
                const users = await getFromGoogleSheets('Users');
                const selectedTags = tagsValue.split(',').map(tag => tag.trim().toLowerCase());
                
                // Filter users by tags
                const matchingUsers = users.filter(user => {
                    if (!user.tags) return false;
                    const userTags = user.tags.split(',').map(tag => tag.trim().toLowerCase());
                    return selectedTags.some(selectedTag => userTags.includes(selectedTag));
                });
                
                if (matchingUsers.length > 0) {
                    usersPreview.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-blue-800">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${matchingUsers.length} ‡∏Ñ‡∏ô</span>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">üè∑Ô∏è Tags: ${tagsValue}</span>
                            </div>
                            <div class="space-y-2 max-h-32 overflow-y-auto">
                                ${matchingUsers.map(user => `
                                    <div class="flex items-center space-x-3 p-2 bg-white rounded border border-blue-200">
                                        ${user.pictureUrl ? 
                                            `<img src="${user.pictureUrl}" alt="Profile" class="w-8 h-8 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                             <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0 text-xs" style="display: none;">üë§</div>` : 
                                            `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0 text-xs">üë§</div>`
                                        }
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-800 truncate">${user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                                            <div class="text-xs text-gray-500 truncate">üè† ${user.‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                        </div>
                                        <div class="flex flex-wrap gap-1">
                                            ${user.tags ? user.tags.split(',').map(tag => `
                                                <span class="inline-block ${getTagColor(tag.trim())} text-xs px-1 py-0.5 rounded text-xs border">${tag.trim()}</span>
                                            `).join('') : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    usersPreview.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-yellow-600 text-2xl mb-2">‚ö†Ô∏è</div>
                            <p class="text-yellow-700 text-sm font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ Tags ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                            <p class="text-yellow-600 text-xs mt-1">Tags ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${tagsValue}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error previewing users:', error);
                usersPreview.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-red-600 text-2xl mb-2">‚ùå</div>
                        <p class="text-red-700 text-sm">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                    </div>
                `;
            }
        }

        function toggleMessageContent(index) {
            const contentDiv = document.getElementById(`message-content-${index}`);
            const button = document.querySelector(`#message-${index} button[onclick="toggleMessageContent(${index})"]`);
            
            if (contentDiv.classList.contains('hidden')) {
                contentDiv.classList.remove('hidden');
                contentDiv.classList.add('fade-in');
                button.innerHTML = 'üôà ‡∏ã‡πà‡∏≠‡∏ô';
                button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                button.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                contentDiv.classList.add('hidden');
                contentDiv.classList.remove('fade-in');
                button.innerHTML = 'üëÅÔ∏è ‡∏î‡∏π';
                button.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                button.classList.add('bg-gray-500', 'hover:bg-gray-600');
            }
        }

        function previewMessage() {
            const messageSelect = document.getElementById('line-message-select');
            const selectedOption = messageSelect.options[messageSelect.selectedIndex];
            const previewDiv = document.getElementById('message-preview');
            
            if (selectedOption && selectedOption.value) {
                try {
                    const messageData = JSON.parse(selectedOption.dataset.content);
                    previewDiv.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-gray-800">üìù ${messageData.name}</span>
                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${messageData.type}</span>
                            </div>
                            <div class="bg-white border rounded p-3 max-h-40 overflow-y-auto">
                                <pre class="text-xs text-gray-700 whitespace-pre-wrap">${messageData.content}</pre>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    previewDiv.innerHTML = '<p class="text-red-500 text-sm">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ</p>';
                }
            } else {
                previewDiv.innerHTML = '<p class="text-gray-500 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>';
            }
        }

        // Update message preview when selection changes
        document.addEventListener('DOMContentLoaded', () => {
            const messageSelect = document.getElementById('line-message-select');
            if (messageSelect) {
                messageSelect.addEventListener('change', previewMessage);
            }
            
            // Add event listener for tags input to update users preview
            const tagsInput = document.getElementById('line-tags-input');
            if (tagsInput) {
                tagsInput.addEventListener('input', previewUsersByTags);
                tagsInput.addEventListener('change', previewUsersByTags);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Test connection first
            await testConnection();
            
            // Show first tab and load data
            showTab('users');
            
            // Load tags for the selector
            await loadTags();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99197dbf51117b4a',t:'MTc2MDk3MzU0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
