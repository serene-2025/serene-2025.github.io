function sendToRichmenu(data) {
    // ใส่ URL ของ Supabase Function ที่คุณ Deploy (ดูได้จาก Dashboard)
    const supabaseUrl = 'https://kiumelolsilduqnvrekf.supabase.co/functions/v1/line-richmenu-api';

    // ใช้ fetch API (มาตรฐานใหม่กว่า $.post)
    fetch(supabaseUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(flexMessage => {
        // ตรวจสอบว่าได้ Flex Message กลับมาหรือไม่
        if (flexMessage && flexMessage.type === "flex") {
             liff.sendMessages([flexMessage])
              .then(() => {
                // ถ้าเป็น Message สีแดง (ล้มเหลว) ให้แสดง Error
                if (flexMessage.altText.includes("ล้มเหลว")) {
                    Swal.fire("แจ้งเตือน", "คุณไม่มีสิทธิ์ใช้งาน หรือยังไม่ได้ลงทะเบียน", "warning").then(() => {
                        liff.closeWindow();
                    });
                } else {
                    Swal.fire("สำเร็จ", "เปลี่ยน Rich Menu เรียบร้อยแล้ว", "success").then(() => {
                        liff.closeWindow();
                    });
                }
              })
              .catch((error) => {
                console.error("Line Send Error:", error);
                Swal.fire("ข้อผิดพลาด", "ไม่สามารถส่งข้อความเข้าไลน์ได้", "error");
              });
        } else {
             Swal.fire("ข้อผิดพลาด", "ระบบขัดข้อง (Invalid Response)", "error");
        }
    })
    .catch((error) => {
        console.error("API Error:", error);
        Swal.fire("ข้อผิดพลาด", "ไม่สามารถเชื่อมต่อ Server ได้", "error");
    });
  }
