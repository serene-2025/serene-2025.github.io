<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title id="displayname">กำลังโหลด...</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://bit.ly/fontiton5" type="text/css" charset="utf-8">

  <style>
    title , body { font-family: 'line_seed_sans_th'; }
  </style>
</head>
<body>
  <div id="app" class="h-screen w-screen" >
    <div class="bg-cover bg-no-repeat bg-left h-full w-full"
       style="background-image: url('https://i.pinimg.com/originals/67/91/1b/67911b91af62338cfe3f782fb4ead0ff.gif')"></div>
  </div>

  <script>
  // --- ส่วนการตั้งค่า ---
  const LIFF_ID = "2000143615-dKJTTnFn"; // ใส่ LIFF ID ของคุณที่นี่
  const SUPABASE_FUNCTION_URL = "https://kiumelolsilduqnvrekf.supabase.co/functions/v1/line-richmenu-api"; // ใส่ URL Supabase Function ของคุณ

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      await initializeLiff(LIFF_ID);
    } catch (err) {
      console.error("LIFF Initialization Error:", err);
      Swal.fire("ข้อผิดพลาด", "เกิดปัญหาในการเชื่อมต่อกับ LIFF", "error");
    }
  });

  async function initializeLiff(liffId) {
    try {
      await liff.init({ liffId, withLoginOnExternalBrowser: true });

      if (!liff.isInClient() && !liff.isLoggedIn()) {
        liff.login({ redirectUri: location.href });
        return;
      }

      const friendship = await liff.getFriendship();
      if (!friendship.friendFlag) {
        Swal.fire({
            icon: 'error',
            title: 'เดี๋ยวก่อน!',
            text: 'คุณยังไม่ได้เป็นเพื่อนกับเรา',
            confirmButtonText: 'เพิ่มเพื่อน',
        }).then(() => {
            window.location = 'https://line.me/R/ti/p/@xxxxx'; // ใส่ ID Line OA
        });
        return;
      }

      const profile = await liff.getProfile();
      document.getElementById("displayname").textContent = `รอสักครู่นะคุณ ${profile.displayName}`;
      
      // เรียกฟังก์ชันส่งข้อมูล
      sendToRichmenu({
        userId: profile.userId,
        pictureUrl: profile.pictureUrl,
        displayName: profile.displayName
      });

    } catch (err) {
      console.error("LIFF Error:", err);
      Swal.fire("ข้อผิดพลาด", "เกิดปัญหาในการประมวลผล", "error");
    }
  }

  // --- ฟังก์ชันใหม่ที่เชื่อมต่อ Supabase ---
  function sendToRichmenu(data) {
    fetch(SUPABASE_FUNCTION_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(flexMessage => {
        if (flexMessage && flexMessage.type === "flex") {
             liff.sendMessages([flexMessage])
              .then(() => {
                if (flexMessage.altText.includes("ล้มเหลว")) {
                    Swal.fire("แจ้งเตือน", "คุณไม่มีสิทธิ์ใช้งาน หรือยังไม่ได้ลงทะเบียน", "warning").then(() => {
                        liff.closeWindow();
                    });
                } else {
                    Swal.fire("สำเร็จ", "เปลี่ยน Rich Menu เรียบร้อยแล้ว", "success").then(() => {
                        liff.closeWindow();
                    });
                }
              })
              .catch((error) => {
                console.error("Line Send Error:", error);
                Swal.fire("ข้อผิดพลาด", "ไม่สามารถส่งข้อความเข้าไลน์ได้", "error");
              });
        } else {
             Swal.fire("ข้อผิดพลาด", "ระบบขัดข้อง (Invalid Response)", "error");
        }
    })
    .catch((error) => {
        console.error("API Error:", error);
        Swal.fire("ข้อผิดพลาด", "ไม่สามารถเชื่อมต่อ Server ได้", "error");
    });
  }
  </script>
</body>
</html>
