<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rich Menu API Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Day.js Core & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Global Styles */
        body { 
            font-family: 'Prompt', sans-serif; 
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155); 
            background-size: 300% 300%; 
            color: #F0F0F0; 
        }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Button Gradients */
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-primary:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: translateY(-1px); }
        
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-danger:hover { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); transform: translateY(-1px); }
        
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-success:hover { box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); transform: translateY(-1px); }

        .btn-warning { background: linear-gradient(135deg, #eab308, #ca8a04); color: #1e293b; }
        .btn-warning:hover { box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); transform: translateY(-1px); }
        
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-purple:hover { box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); transform: translateY(-1px); }

        /* Animation Classes */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Transitions */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: scale(1); }
        .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.9); opacity: 0; }

        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: none; z-index: 9999; }
        
        /* Default Menu Highlight */
        .default-menu-card {
            border: 2px solid #fbbf24; /* Amber-400 */
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.1), rgba(0, 0, 0, 0.2));
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <!-- 1. AUTH MODAL (NEW) -->
    <div id="authModal" class="hidden fixed inset-0 z-[9500] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideAuthModal(false)"></div>
        <div class="bg-[#1e293b] border border-red-500/30 rounded-2xl shadow-2xl max-w-xs w-full p-6 modal-card z-10 relative text-center">
            <div class="mx-auto w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mb-4 ring-2 ring-red-500/50">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Admin Access</h3>
            <p class="text-gray-400 text-sm mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
            <input type="password" id="auth-input" class="w-full bg-black/40 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:border-red-500 outline-none mb-4 tracking-widest placeholder-gray-600 font-mono text-lg transition-colors" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="flex gap-2">
                <button onclick="hideAuthModal(false)" class="flex-1 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 text-sm font-medium transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="submitAuth()" class="flex-1 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 font-bold text-sm shadow-lg shadow-red-600/20 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- 2. SCHEDULE MODAL -->
    <div id="scheduleModal" class="hidden fixed inset-0 z-[9200] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideScheduleModal()"></div>
        <div class="bg-[#1e293b] rounded-2xl shadow-2xl max-w-lg w-full p-6 z-10 modal-card border border-white/10 relative">
            <h3 id="schedule-modal-title" class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="schedule-title-text">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Schedule)</span>
            </h3>
            
            <div class="space-y-4">
                <div class="p-3 bg-white/5 rounded-lg border border-white/5">
                    <p class="text-sm text-gray-400">Menu:</p>
                    <p id="schedule-menu-name" class="font-bold text-blue-300 truncate">Menu Name</p>
                    <p class="text-sm text-gray-400 mt-2">Target:</p>
                    <p id="schedule-target-info" class="font-bold text-green-300">Selected Users</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (Action)</label>
                    <select id="schedule-action" class="w-full bg-black/30 border border-gray-600 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none">
                        <option value="link">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏ô‡∏π (Link)</option>
                        <option value="unlink">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π (Unlink)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)</label>
                    <input type="datetime-local" id="schedule-time" class="w-full bg-black/30 border border-gray-600 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-500">
                    <p class="text-xs text-gray-500 mt-1">*‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ UTC ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>
            </div>
            <div class="flex justify-end pt-6 gap-3">
                <button onclick="hideScheduleModal()" class="px-5 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium rounded-xl transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="schedule-save-btn" class="btn-purple px-6 py-2.5 font-bold rounded-xl shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- 3. TASK MANAGER MODAL -->
    <div id="taskManagerModal" class="hidden fixed inset-0 z-[9300] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="hideTaskManager()"></div>
        <div class="bg-[#1e293b] rounded-2xl shadow-2xl max-w-4xl w-full p-6 z-10 modal-card border border-white/10 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
                </h3>
                <button onclick="hideTaskManager()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mb-4">
                <div class="flex p-1 bg-black/30 rounded-xl border border-white/5 w-full sm:w-auto">
                    <button onclick="switchScheduleTab('pending')" id="tab-pending" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white shadow-lg">‚è≥ ‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                    <button onclick="switchScheduleTab('completed')" id="tab-completed" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-white/5">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                     <button onclick="loadSchedules()" class="flex-1 sm:flex-none px-4 py-2 bg-white/5 text-gray-300 border border-white/10 rounded-lg text-sm hover:bg-white/10 transition flex justify-center items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                     <button onclick="runDueTasks()" class="flex-1 sm:flex-none px-4 py-2 bg-green-600/20 text-green-300 border border-green-500/30 rounded-lg text-sm hover:bg-green-600/30 transition flex justify-center items-center gap-2" title="‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Cron"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>‡∏£‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                </div>
            </div>
            <div id="schedule-list" class="flex-1 overflow-y-auto bg-black/20 rounded-xl border border-white/5 p-2 space-y-2 min-h-[300px] custom-scrollbar">
                <!-- Tasks will be injected here -->
            </div>
        </div>
    </div>

    <!-- 4. LIGHTBOX, 5. LOADING, 6. TOAST, 7. USER SEARCH, 8. CONFIRMATION -->
    <div id="lightbox-modal" class="fixed inset-0 z-[10000] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0 pointer-events-none" onclick="closeLightbox()"><img id="lightbox-image" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl transform transition-transform duration-300 scale-90" onclick="event.stopPropagation()"><button class="absolute top-4 right-4 text-white hover:text-gray-300" onclick="closeLightbox()"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
    <div id="loading-overlay" class="flex flex-col items-center justify-center gap-4"><div class="relative"><div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div></div><p id="loading-text" class="text-xl font-medium text-blue-100 tracking-wide animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
    <div id="toast-container" class="fixed top-4 right-4 z-[9900] space-y-2 pointer-events-none"></div>
    <div id="userSearchModal" class="hidden fixed inset-0 z-[9100] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog"><div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="hideUserSearchModal(null)"></div><div id="search-card" class="glass bg-[#1e293b]/90 rounded-2xl shadow-2xl max-w-xl w-full p-6 z-10 modal-card border border-white/10 flex flex-col max-h-[85vh]"><div class="flex justify-between items-center mb-4"><h3 id="search-modal-title" class="text-xl font-bold text-white"></h3><button onclick="hideUserSearchModal(null)" class="text-gray-400 hover:text-white transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="flex flex-col gap-3"><input id="modal-user-search" class="block w-full px-4 py-3 border border-gray-600 rounded-xl bg-black/20 text-gray-100 placeholder-gray-400 focus:outline-none focus:border-blue-500 transition-all" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ User ID..." autocomplete="off"><div class="flex gap-2"><button id="modal-user-search-btn" class="flex-1 btn-primary py-2.5 rounded-xl font-semibold text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button><button id="modal-user-all-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2.5 rounded-xl font-semibold text-sm">‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div><div id="modal-user-select-all-container" class="hidden"><button id="modal-user-select-all-btn" class="btn-success w-full py-2 rounded-xl font-bold text-sm shadow-lg text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</button></div></div><div id="modal-user-results" class="mt-4 flex-1 overflow-y-auto border border-white/5 rounded-xl bg-black/20 min-h-[250px] p-2 custom-scrollbar"><div class="flex flex-col items-center justify-center h-full text-gray-500 space-y-3"><p>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"</p></div></div><div class="flex justify-end pt-4 mt-2 gap-3 border-t border-white/10"><button id="search-cancel-btn" class="px-6 py-2.5 bg-transparent hover:bg-white/5 text-gray-300 font-medium rounded-xl transition border border-gray-600">‡∏õ‡∏¥‡∏î</button><button id="search-ok-btn" class="btn-primary px-8 py-2.5 rounded-xl font-bold shadow-lg disabled:opacity-50" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (0)</button></div></div></div>
    <div id="confirmationModal" class="hidden fixed inset-0 z-[9000] flex items-center justify-center p-4 modal-leave-to" aria-modal="true" role="dialog"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div><div id="confirm-card" class="bg-[#1e293b] border border-white/10 rounded-2xl shadow-2xl max-w-sm w-full p-6 modal-card z-10 relative"><div class="flex flex-col items-center text-center relative z-10"><div id="confirm-icon-placeholder" class="mb-4 transform transition-transform hover:scale-110"></div><h3 id="confirm-title" class="text-xl font-bold text-white"></h3><p id="confirm-text" class="text-gray-400 mt-2 text-sm leading-relaxed"></p></div><div class="flex justify-end pt-6 space-x-3 w-full relative z-10"><button id="confirm-cancel-btn" class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium rounded-xl transition duration-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="confirm-ok-btn" class="flex-1 px-4 py-2.5 text-white font-medium rounded-xl transition duration-200 shadow-lg"></button></div></div></div>

    <!-- MAIN CONTENT -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 fade-in">
            <div class="text-center md:text-left">
                <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 via-blue-400 to-cyan-300 drop-shadow-sm">
                    Rich Menu Manager
                </h1>
                <p class="text-blue-300/70 mt-1 font-light tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π LINE OA</p>
            </div>
            <div class="flex gap-3 flex-wrap justify-center">
                 <button onclick="showTaskManager()" class="group bg-purple-600/20 hover:bg-purple-600/30 border border-purple-500/30 text-purple-200 px-5 py-2.5 rounded-xl font-medium backdrop-blur transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Schedules)</button>
                <button id="reload-btn" class="group bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-2.5 rounded-xl font-medium backdrop-blur transition flex items-center gap-2"><svg class="w-5 h-5 text-blue-400 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="cancel-default-btn" class="btn-danger px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å (Clear Default)</button>
            </div>
        </header>
        <main id="richmenu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Cards will be injected here -->
        </main>
    </div>
    
    <script type="module">
        // --- CONFIGURATION ---
        const ENABLE_LIFF = false; 
        const ADMIN_PASSWORD = "1234"; // üëà ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)
        const LIFF_ID = "2000143615-RQWZXWKA"; 
        const SUPABASE_URL = "https://kiumelolsilduqnvrekf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJQ14gU";

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const richMenuGrid = document.getElementById('richmenu-grid');
        const cancelDefaultBtn = document.getElementById('cancel-default-btn');
        const reloadBtn = document.getElementById('reload-btn');
        
        let richMenuDataCache = new Map();
        let currentDefaultMenuId = null;

        // --- Init Day.js ---
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th');

        // --- Helpers & UI ---
        window.fireConfetti = () => { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        window.openLightbox = (imageUrl) => { const m=document.getElementById('lightbox-modal'),i=document.getElementById('lightbox-image'); i.src=imageUrl; m.classList.remove('hidden'); requestAnimationFrame(()=>{m.classList.remove('opacity-0','pointer-events-none');i.classList.remove('scale-90');i.classList.add('scale-100');}); };
        window.closeLightbox = () => { const m=document.getElementById('lightbox-modal'),i=document.getElementById('lightbox-image'); m.classList.add('opacity-0','pointer-events-none'); i.classList.remove('scale-100');i.classList.add('scale-90'); setTimeout(()=>{m.classList.add('hidden');i.src='';},300); };
        const showToast = (icon, title) => {
            const container = document.getElementById('toast-container');
            const color = icon === 'success' ? 'bg-green-600' : icon === 'error' ? 'bg-red-600' : 'bg-blue-600';
            const iconSvg = icon === 'success' ? '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            const toast = document.createElement('div');
            toast.className = `p-4 flex items-center rounded-xl shadow-xl text-white ${color} transition-all duration-300 ease-out transform translate-x-full opacity-0 backdrop-blur-md bg-opacity-95 border border-white/10`;
            toast.innerHTML = iconSvg + `<span class="font-medium">${title}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('translate-x-full', 'opacity-0'); toast.classList.add('translate-x-0', 'opacity-100'); });
            setTimeout(() => { toast.classList.remove('translate-x-0', 'opacity-100'); toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
        };

        // --- AUTH MODAL LOGIC (NEW) ---
        let resolveAuth = null;
        const authModal = document.getElementById('authModal');
        const authInput = document.getElementById('auth-input');

        window.showAuthModal = () => {
            return new Promise((resolve) => {
                resolveAuth = resolve;
                authInput.value = '';
                authModal.style.display = 'flex';
                setTimeout(() => { authModal.classList.add('modal-enter-active'); authModal.classList.remove('modal-leave-to'); authInput.focus(); }, 10);
                
                authInput.onkeydown = (e) => { if (e.key === 'Enter') window.submitAuth(); };
            });
        };

        window.hideAuthModal = (isAuthenticated) => {
            authModal.classList.add('modal-leave-to'); authModal.classList.remove('modal-enter-active');
            setTimeout(() => { authModal.style.display = 'none'; if (resolveAuth) { resolveAuth(isAuthenticated); resolveAuth = null; } }, 300);
        };

        window.submitAuth = () => {
            const val = authInput.value;
            if (val === ADMIN_PASSWORD) {
                hideAuthModal(true);
            } else {
                showToast('error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
                authInput.value = '';
                authInput.classList.add('animate-bounce');
                setTimeout(() => authInput.classList.remove('animate-bounce'), 500);
            }
        };

        // --- Confirmation ---
        let resolveConfirmation=null; const confirmationModal=document.getElementById('confirmationModal');
        const showConfirmationModal = (title,text,type,confirmText='‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',confirmClass='btn-primary') => { return new Promise((resolve)=>{ resolveConfirmation=resolve; document.getElementById('confirm-title').textContent=title;document.getElementById('confirm-text').textContent=text; const b=document.getElementById('confirm-ok-btn'); b.textContent=confirmText; b.className=b.className.replace(/btn-primary|btn-danger|btn-success|btn-warning|btn-purple/g,''); b.classList.add(confirmClass); const ip=document.getElementById('confirm-icon-placeholder'); const c=type==='warning'?'text-yellow-400':'text-red-400'; ip.innerHTML=`<svg class="w-16 h-16 ${c}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>`; confirmationModal.style.display='flex'; setTimeout(()=>{confirmationModal.classList.add('modal-enter-active');confirmationModal.classList.remove('modal-leave-to');},10); document.getElementById('confirm-ok-btn').onclick=()=>hideConfirmationModal(true); document.getElementById('confirm-cancel-btn').onclick=()=>hideConfirmationModal(false); }); };
        const hideConfirmationModal = (v) => { confirmationModal.classList.add('modal-leave-to');confirmationModal.classList.remove('modal-enter-active'); setTimeout(()=>{confirmationModal.style.display='none';if(resolveConfirmation){resolveConfirmation({isConfirmed:v});resolveConfirmation=null;}},300); };

        let resolveUserSearch=null; let selectedUsers=new Set(); const userSearchModal=document.getElementById('userSearchModal'); const resultsContainer=document.getElementById('modal-user-results');
        const updateSelectedCount=()=>{document.getElementById('search-ok-btn').textContent=`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${selectedUsers.size})`;document.getElementById('search-ok-btn').disabled=selectedUsers.size===0;};
        const hideUserSearchModal=(v)=>{userSearchModal.classList.add('modal-leave-to');userSearchModal.classList.remove('modal-enter-active');setTimeout(()=>{userSearchModal.style.display='none';if(resolveUserSearch){resolveUserSearch(v);resolveUserSearch=null;}},300);};
        async function showUserSearchModal(title){ return new Promise((resolve)=>{ resolveUserSearch=(v)=>resolve(v); selectedUsers.clear(); document.getElementById('modal-user-search').value=''; resultsContainer.innerHTML='<div class="flex flex-col items-center justify-center h-full text-gray-500"><p>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"</p></div>'; document.getElementById('search-modal-title').textContent=title; document.getElementById('modal-user-select-all-container').classList.add('hidden'); updateSelectedCount(); userSearchModal.style.display='flex'; setTimeout(()=>{userSearchModal.classList.add('modal-enter-active');userSearchModal.classList.remove('modal-leave-to');},10); document.getElementById('modal-user-search-btn').onclick=async()=>{ const t=document.getElementById('modal-user-search').value.trim(); if(t.length<2)return; renderUsers((await invokeFunction({action:'getUsersWithRichMenu',searchTerm:t})).users); }; document.getElementById('modal-user-all-btn').onclick=async()=>{ renderUsers((await invokeFunction({action:'getUsersWithRichMenu',allUsers:true})).users); }; document.getElementById('modal-user-select-all-btn').onclick=()=>{ resultsContainer.querySelectorAll('input[type="checkbox"]').forEach(c=>{c.checked=true;selectedUsers.add(c.dataset.userid);c.closest('label').classList.add('bg-blue-900/20');}); updateSelectedCount(); }; document.getElementById('search-ok-btn').onclick=()=>hideUserSearchModal(Array.from(selectedUsers)); document.getElementById('search-cancel-btn').onclick=()=>hideUserSearchModal(null); }); }
        
        const renderUsers = (users) => {
            resultsContainer.innerHTML = '';
            if (!users || users.length === 0) { resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
            document.getElementById('modal-user-select-all-container').classList.remove('hidden');
            users.forEach(u => {
                const el = document.createElement('label');
                el.className = 'flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 cursor-pointer transition-all mb-1 border border-transparent group relative';
                let currentMenuHtml = '';
                if (u.linkedRichMenuId) {
                    const menuData = richMenuDataCache.get(u.linkedRichMenuId);
                    const imgSrc = (menuData && menuData.imageBase64) ? menuData.imageBase64 : '';
                    if (imgSrc) currentMenuHtml = `<div class="ml-auto flex flex-col items-end"><span class="text-[10px] text-gray-400 mb-0.5">‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><div class="w-16 h-8 bg-gray-800 rounded border border-white/10 overflow-hidden relative"><img src="${imgSrc}" class="w-full h-full object-cover"></div></div>`;
                    else currentMenuHtml = `<div class="ml-auto flex flex-col items-end"><span class="text-[10px] text-gray-400">‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><span class="text-xs text-gray-500 italic">Unknown ID</span></div>`;
                } else { currentMenuHtml = `<div class="ml-auto flex flex-col items-end opacity-50"><span class="text-[10px] text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</span></div>`; }
                el.innerHTML = `<div class="flex items-center gap-3 flex-1 min-w-0"><input type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-transparent text-blue-500 focus:ring-0 flex-shrink-0" data-userid="${u.userId}"><img src="${u.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="w-10 h-10 rounded-full object-cover border border-white/10 flex-shrink-0"><div class="min-w-0"><p class="font-bold text-gray-200 truncate text-sm">${u.displayName}</p><p class="text-xs text-gray-500 truncate font-mono">${u.userId}</p></div></div>${currentMenuHtml}`;
                const c = el.querySelector('input'); c.checked = selectedUsers.has(u.userId); if (c.checked) el.classList.add('bg-blue-900/20', 'border-blue-500/30');
                c.onchange = (e) => { if (e.target.checked) { selectedUsers.add(u.userId); el.classList.add('bg-blue-900/20', 'border-blue-500/30'); } else { selectedUsers.delete(u.userId); el.classList.remove('bg-blue-900/20', 'border-blue-500/30'); } updateSelectedCount(); };
                resultsContainer.appendChild(el);
            });
        };

        // --- SCHEDULE & TASK MANAGER (Unchanged Logic, Condensed) ---
        const scheduleModal=document.getElementById('scheduleModal'); let currentScheduleData=null;
        window.openScheduleModal=async(m,n,e=null)=>{let t='specific',ids=[];if(e){t=e.target_type;ids=e.user_ids||[];currentScheduleData={isEdit:true,id:e.id,richMenuId:m,targetType:t,targetIds:ids};document.getElementById('schedule-title-text').textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Edit)";document.getElementById('schedule-save-btn').textContent="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";document.getElementById('schedule-action').value=e.action_type;const d=new Date(e.scheduled_time);const o=d.getTimezoneOffset()*60000;document.getElementById('schedule-time').value=(new Date(d-o)).toISOString().slice(0,16);}else{const r=await showUserSearchModal(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${n}"`);if(r===null)return;if(r.length===0){const{isConfirmed}=await showConfirmationModal('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?','‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô" (All Users)','warning');if(!isConfirmed)return;t='all';}else{ids=r;}currentScheduleData={isEdit:false,richMenuId:m,targetType:t,targetIds:ids};document.getElementById('schedule-title-text').textContent="‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Create)";document.getElementById('schedule-save-btn').textContent="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";document.getElementById('schedule-time').value='';document.getElementById('schedule-action').value='link';}document.getElementById('schedule-menu-name').textContent=n;document.getElementById('schedule-target-info').textContent=t==='all'?'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (All Users)':`${ids.length} ‡∏Ñ‡∏ô`;scheduleModal.style.display='flex';setTimeout(()=>{scheduleModal.classList.add('modal-enter-active');scheduleModal.classList.remove('modal-leave-to');},10);};
        window.hideScheduleModal=()=>{scheduleModal.classList.add('modal-leave-to');scheduleModal.classList.remove('modal-enter-active');setTimeout(()=>{scheduleModal.style.display='none';currentScheduleData=null;},300);};
        document.getElementById('schedule-save-btn').onclick=async()=>{const tv=document.getElementById('schedule-time').value;const av=document.getElementById('schedule-action').value;if(!tv){showToast('error','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤');return;}if(new Date(tv)<=new Date()){showToast('error','‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï');return;}showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');try{await invokeFunction({action:currentScheduleData.isEdit?'updateSchedule':'createSchedule',id:currentScheduleData.id,richMenuId:currentScheduleData.richMenuId,userIds:currentScheduleData.targetIds,targetType:currentScheduleData.targetType,actionType:av,scheduledTime:new Date(tv).toISOString()});showToast('success','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');fireConfetti();hideScheduleModal();if(document.getElementById('taskManagerModal').style.display==='flex')loadSchedules();}catch(e){showToast('error',e.message);}finally{hideLoading();}};
        const taskManagerModal=document.getElementById('taskManagerModal');let currentScheduleTab='pending';
        window.showTaskManager=async()=>{taskManagerModal.style.display='flex';setTimeout(()=>{taskManagerModal.classList.add('modal-enter-active');taskManagerModal.classList.remove('modal-leave-to');},10);loadSchedules();};window.hideTaskManager=()=>{taskManagerModal.classList.add('modal-leave-to');taskManagerModal.classList.remove('modal-enter-active');setTimeout(()=>{taskManagerModal.style.display='none';},300);};
        window.switchScheduleTab=(t)=>{currentScheduleTab=t;const pb=document.getElementById('tab-pending'),cb=document.getElementById('tab-completed');if(t==='pending'){pb.className="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white shadow-lg";cb.className="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-white/5";}else{pb.className="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-white/5";cb.className="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white shadow-lg";}loadSchedules();};
        window.loadSchedules=async()=>{const lc=document.getElementById('schedule-list');lc.innerHTML='<div class="text-center p-4 text-gray-400">Loading...</div>';try{const{schedules}=await invokeFunction({action:'getSchedules',status:currentScheduleTab});if(!schedules||schedules.length===0){lc.innerHTML=`<div class="text-center p-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${currentScheduleTab==='pending'?'‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô':'‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'})</div>`;return;}lc.innerHTML='';schedules.forEach(t=>{const isDue=new Date(t.scheduled_time)<=new Date()&&t.status==='pending',isFailed=t.status==='failed';const sc=isFailed?'border-red-500/30 bg-red-900/10':(isDue?'border-yellow-500/50 bg-yellow-900/10':'border-white/5 bg-white/5');const d=dayjs(t.scheduled_time);const mn=richMenuDataCache.get(t.rich_menu_id)?.name||t.rich_menu_id;const img=richMenuDataCache.get(t.rich_menu_id)?.imageBase64||'https://placehold.co/100x33/1e293b/FFF?text=No+Img';const ab=currentScheduleTab==='pending'?`<button onclick='editTask(${JSON.stringify(t).replace(/'/g,"&#39;")})' class="p-2 text-gray-400 hover:text-white bg-gray-700/50 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button onclick="deleteTask(${t.id})" class="p-2 text-gray-400 hover:text-white bg-gray-700/50 rounded-lg hover:bg-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`:`<div class="px-3 py-1 rounded-lg text-xs font-bold ${isFailed?'bg-red-500/20 text-red-300':'bg-green-500/20 text-green-300'}">${isFailed?'‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß':'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</div>`;const el=document.createElement('div');el.className=`p-3 rounded-xl border ${sc} flex items-center gap-4 transition hover:bg-white/10`;el.innerHTML=`<div class="w-20 h-14 bg-gray-800 rounded-lg overflow-hidden flex-shrink-0 border border-white/10 shadow-sm relative group cursor-pointer" onclick="openLightbox('${img}')"><img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform"></div><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-1"><span class="text-sm font-mono text-gray-300">${d.format('D MMM BB HH:mm')}</span>${currentScheduleTab==='pending'?`<span class="px-2 py-0.5 rounded text-[10px] bg-blue-900/50 text-blue-300 border border-blue-500/30 whitespace-nowrap">${d.fromNow()}</span>`:''}</div><p class="font-bold text-gray-200 truncate"><span class="${t.action_type==='link'?'text-green-400':'text-red-400'}">${t.action_type==='link'?'üîó ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á':'üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'}</span> <span class="text-blue-300 mx-1">${mn}</span></p><p class="text-xs text-gray-500 mt-0.5">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${t.target_type==='all'?'‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (All)':`${t.user_ids?.length||0} ‡∏Ñ‡∏ô`}</p></div><div class="flex gap-2 flex-shrink-0">${ab}</div>`;lc.appendChild(el);});}catch(e){lc.innerHTML=`<div class="text-center p-4 text-red-400">Error: ${e.message}</div>`;}};
        window.editTask=(t)=>{const mn=richMenuDataCache.get(t.rich_menu_id)?.name||t.rich_menu_id;openScheduleModal(t.rich_menu_id,mn,t);};
        window.deleteTask=async(id)=>{if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?'))return;try{await invokeFunction({action:'deleteSchedule',id});loadSchedules();showToast('success','‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');}catch(e){showToast('error',e.message);}};
        window.runDueTasks=async()=>{if(!confirm('‡∏£‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ?'))return;showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');try{const r=await invokeFunction({action:'runSchedule'});showToast('success',r.message);loadSchedules();}catch(e){showToast('error',e.message);}finally{hideLoading();}};

        // --- MAIN APP ---
        const showLoading = (text) => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
        const hideLoading = () => { loadingOverlay.style.display = 'none'; };
        async function invokeFunction(payload) { const { data, error } = await supabaseClient.functions.invoke('manage-rich-menu', { body: payload }); if (error) throw error; return data; }

        function renderRichMenuCard(menu) {
            const isDefault = menu.richMenuId === currentDefaultMenuId;
            const card = document.createElement('div');
            card.id = `menu-${menu.richMenuId}`;
            const defaultClass = isDefault ? 'default-menu-card' : 'glass';
            card.className = `${defaultClass} rounded-2xl p-5 flex flex-col gap-4 fade-in transition-all duration-300 transform hover:-translate-y-2 hover:shadow-blue-500/10 hover:border-blue-500/30 relative`;
            const aspectRatio = menu.size ? `${menu.size.width} / ${menu.size.height}` : '2500 / 843';
            const badgeHTML = isDefault ? `<div class="absolute top-0 left-0 bg-yellow-500 text-black text-xs font-bold px-3 py-1 rounded-br-lg z-10 shadow-md flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>MENU ‡∏´‡∏•‡∏±‡∏Å</div>` : '';

            card.innerHTML = `${badgeHTML}<div class="relative group cursor-zoom-in" onclick="openLightbox(this.querySelector('img').src)"><div class="img-container bg-gray-800/50 rounded-xl overflow-hidden aspect-[${aspectRatio}] relative border border-white/5"><img src="data:image/png;base64,${menu.imageBase64 || ''}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" style="aspect-ratio:${aspectRatio};" /><div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></div></div><div class="absolute top-2 right-2 bg-black/70 backdrop-blur text-[10px] px-2 py-1 rounded-md text-white border border-white/10 shadow-lg">${menu.chatBarText || 'Menu'}</div><button onclick="event.stopPropagation(); openScheduleModal('${menu.richMenuId}', '${menu.name}')" class="absolute top-2 left-2 bg-purple-600/90 hover:bg-purple-500 text-white p-1.5 rounded-lg shadow-lg border border-white/20 transition active:scale-95" title="‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤" style="top: ${isDefault ? '40px' : '8px'}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button></div><div class="space-y-1"><h3 class="font-bold text-lg text-blue-100 truncate" title="${menu.name}">${menu.name}</h3><div class="flex items-center gap-2 group/id cursor-pointer" onclick="navigator.clipboard.writeText('${menu.richMenuId}');showToast('success','‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÅ‡∏•‡πâ‡∏ß')"><p class="text-[10px] text-gray-500 font-mono truncate max-w-[80%] group-hover/id:text-blue-400 transition-colors">${menu.richMenuId}</p></div></div><div class="mt-auto pt-4 border-t border-white/5 grid grid-cols-2 gap-2 text-xs font-semibold"><button class="link-user-btn btn-success py-2 rounded-lg flex justify-center items-center gap-1.5 active:scale-95">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button><button class="unlink-user-btn btn-warning py-2 rounded-lg flex justify-center items-center gap-1.5 active:scale-95">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="set-default-btn btn-primary py-2 rounded-lg col-span-2 active:scale-95" ${isDefault ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>${isDefault ? '‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å'}</button><button class="delete-menu-btn btn-danger py-2 rounded-lg col-span-2 active:scale-95">‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button></div>`;
            
            card.querySelector('.link-user-btn').onclick = () => handleLinkUser(menu.richMenuId);
            card.querySelector('.unlink-user-btn').onclick = () => handleUnlinkUser(menu.richMenuId);
            if(!isDefault) {
                card.querySelector('.set-default-btn').onclick = () => handleSetDefault(menu.richMenuId, menu.name);
            }
            // ‚úÖ Protected Delete Button
            card.querySelector('.delete-menu-btn').onclick = async () => {
                const isAuthenticated = await showAuthModal();
                if (isAuthenticated) {
                    handleDeleteMenu(menu.richMenuId, menu.name);
                }
            };
            return card;
        }

        async function loadRichMenus() {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
            richMenuGrid.innerHTML = '';
            try {
                const [listRes, defaultRes] = await Promise.all([
                    invokeFunction({ action: 'getList' }),
                    invokeFunction({ action: 'getDefault' }).catch(() => ({ richMenuId: null }))
                ]);
                currentDefaultMenuId = defaultRes.richMenuId;
                const { richmenus } = listRes;
                if (!richmenus || richmenus.length === 0) { richMenuGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Rich Menu</div>'; hideLoading(); return; }
                richmenus.forEach(menu => { richMenuGrid.appendChild(renderRichMenuCard(menu)); richMenuDataCache.set(menu.richMenuId, menu); });
                const imagePromises = richmenus.map(async (menu) => {
                     try {
                         const { imageBase64 } = await invokeFunction({ action: 'getRichMenuImage', richMenuId: menu.richMenuId });
                         const card = document.getElementById(`menu-${menu.richMenuId}`);
                         if(card && imageBase64) {
                             richMenuDataCache.get(menu.richMenuId).imageBase64 = imageBase64;
                             card.querySelector('img').src = imageBase64;
                         }
                     } catch(e){}
                });
                await Promise.all(imagePromises);
            } catch (err) { showToast('error', err.message); console.error(err); } finally { hideLoading(); }
        }

        async function handleLinkUser(id) { const u = await showUserSearchModal('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á'); if(u&&u.length>0) { showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á...'); try{ await invokeFunction({action:'bulkLink', userIds:u, richMenuId:id}); showToast('success','‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fireConfetti(); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleUnlinkUser(id) { const u = await showUserSearchModal('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'); if(u&&u.length>0) { showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...'); try{ await invokeFunction({action:'bulkUnlink', userIds:u}); showToast('success','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleSetDefault(id, name) { const {isConfirmed} = await showConfirmationModal('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å', `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á "${name}" ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?`, 'warning'); if(isConfirmed){ showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); try{ await invokeFunction({action:'setDefault', richMenuId:id}); showToast('success','‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fireConfetti(); loadRichMenus(); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }
        async function handleDeleteMenu(id, name) { const {isConfirmed} = await showConfirmationModal('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π', `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}"?`, 'error'); if(isConfirmed){ showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'); try{ await invokeFunction({action:'delete', richMenuId:id}); showToast('success','‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); document.getElementById(`menu-${id}`).remove(); }catch(e){showToast('error',e.message);}finally{hideLoading();} } }

        // ‚úÖ Protected Cancel Default Button
        document.getElementById('cancel-default-btn').onclick = async () => {
            const isAuthenticated = await showAuthModal();
            if (isAuthenticated) {
                const {isConfirmed} = await showConfirmationModal('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?', 'warning');
                if(isConfirmed){
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');
                    try{
                        await invokeFunction({action:'cancelDefault'});
                        showToast('success','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        loadRichMenus();
                    } catch(e){ showToast('error',e.message); }
                    finally{ hideLoading(); }
                }
            }
        };
        
        document.getElementById('reload-btn').onclick = loadRichMenus;

        window.onload = async () => { if (ENABLE_LIFF) { try { await liff.init({ liffId: LIFF_ID }); } catch (e) { console.error(e); } } await loadRichMenus(); };
    </script>
</body>
</html>
