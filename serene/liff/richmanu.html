<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rich Menu API-LINE OA</title>
  <meta name="description" content="Rich Menu API Admin for LIFF" />
  <meta name="author" content="9one" />
  <meta property="og:title" content="Rich Menu API Admin-9one" />
  <meta property="og:description" content="Rich Menu API for LIFF" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://lh3.googleusercontent.com/d/1diz2KXxiOna6_ltL_GKxvfT3JkJCZtvG" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap');
    body { font-family: 'Prompt', sans-serif; background-color: #272838; color: #F0F0F0; }
    .gradient-bg { background: linear-gradient(135deg, #272838 0%, #5d536b 100%); }
    .btn-primary { background: linear-gradient(135deg, #347fc4 0%, #5d536b 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 127, 196, 0.2); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 127, 196, 0.3); }
    .btn-danger { background: linear-gradient(135deg, #c43434 0%, #6b5353 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(196, 52, 52, 0.2); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(196, 52, 52, 0.3); }
    
    .swal2-popup { background-color: #272838 !important; color: #73B305 !important; border: 1px solid #7d6b91; border-radius: 1rem !important; }
    .swal2-title { color: #989fce !important; }
    .swal2-html-container { color: #F0F0F0 !important; margin: 0 !important; }
    .swal2-input { 
      background-color: #272838 !important; 
      border: 1px solid #7d6b91 !important;
      color: #F0F0F0 !important;
      border-radius: 0.5rem !important;
    }
    .swal2-input:focus { box-shadow: 0 0 0 3px rgba(152, 159, 206, 0.5) !important; }
    .swal2-container { align-items: center !important; }

    button, a, label, [role=button], input[type=checkbox] {
      -webkit-tap-highlight-color: transparent;
    }

  
    #swal-user-results {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

   .img-container {
  position: relative;
  width: 100%;
  border-radius: 0.5rem;
  overflow: hidden;
  background: #222;
}


.img-container img {
  width: 100%;
  height: auto;
  aspect-ratio: 2500 / 843;  
  object-fit: contain;        
  display: block;
  pointer-events: none;        
  user-select: none;          
}

    #loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: rgba(39, 40, 56, 0.8); backdrop-filter: blur(5px); 
      display: none; justify-content: center; align-items: center; 
      z-index: 9999; flex-direction: column; gap: 1rem; 
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">

  <div id="loading-overlay">
    <img src="https://developers.line.biz/media/line-mini-app/LINE_spinner_light.svg" alt="Loading..." class="w-16 h-16">
    <p id="loading-text" class="text-lg text-[#989fce]">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8 fade-in">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#989fce] to-[#347fc4]">
        Rich Menu API
      </h1>
      <p class="text-lg text-gray-300">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Rich Menu API ‡∏Ç‡∏≠‡∏á LINE OA</p>
    </header>

    <div class="mb-8 flex justify-center gap-4 fade-in" style="animation-delay: 0.2s;">
      <button id="cancel-default-btn" class="btn-danger font-bold py-2 px-6 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
    </div>

    <main id="richmenu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <!-- Rich Menu -->
    </main>
  </div>
    <script type="module">
        const LIFF_ID = "2000143615-RQWZXWKA";
        const SUPABASE_URL = "https://kiumelolsilduqnvrekf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU";

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const richMenuGrid = document.getElementById('richmenu-grid');
        const cancelDefaultBtn = document.getElementById('cancel-default-btn');
        
        let richMenuDataCache = new Map();

        const showLoading = (text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') => {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        };
        const hideLoading = () => {
            loadingOverlay.style.display = 'none';
        };
        const showToast = (icon, title) => {
            Swal.fire({
                icon: icon, title: title, toast: true, position: 'top-end',
                showConfirmButton: false, timer: 3000, timerProgressBar: true,
                customClass: { popup: '!bg-[#5d536b] !text-white' }
            });
        };

        async function invokeFunction(payload) {
            const { data, error } = await supabaseClient.functions.invoke('manage-rich-menu', { body: payload });
            if (error) throw error;
            return data;
        }

        async function showUserSearchModal(title) {
      return new Promise((resolve) => {
        let selectedUsers = new Set();
        Swal.fire({
          title: title,
          width: 'clamp(300px, 90%, 600px)',
          html: `
            <div class="p-2 text-left">
              <div class="space-y-2 sm:flex sm:gap-2 sm:items-center">
                <input id="swal-user-search"
                  class="flex-1 min-w-0 px-3 py-2 rounded-lg border bg-[#1c1c28] text-white"
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå userId ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠...">
                <button id="swal-user-search-btn" class="btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button id="swal-user-all-btn" class="btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              </div>
              <div id="swal-user-results" class="mt-4 max-h-60 overflow-y-auto border rounded-lg">
                <p class="text-center text-gray-400 p-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
              </div>
            </div>`,
          showCancelButton: true,
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
          preConfirm: () => Array.from(selectedUsers),
          didOpen: () => {
            const searchInput = document.getElementById('swal-user-search');
            const searchBtn = document.getElementById('swal-user-search-btn');
            const allBtn = document.getElementById('swal-user-all-btn');
            const resultsContainer = document.getElementById('swal-user-results');
            const confirmBtn = Swal.getConfirmButton();
            confirmBtn.disabled = true;

            const updateSelectedCount = () => {
              const count = selectedUsers.size;
              confirmBtn.textContent = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${count})`;
              confirmBtn.disabled = count === 0;
            };

            // üîπ render users function (‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
            const renderUsers = (data) => {
              if (!data || data.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
                return;
              }
              resultsContainer.innerHTML = '';
              data.forEach(user => {
                const userEl = document.createElement('label');
                userEl.className = 'flex gap-3 p-2 rounded-lg hover:bg-blue-900 cursor-pointer';
                userEl.innerHTML = `
                  <input type="checkbox" class="form-checkbox mt-2" data-userid="${user.userId}">
                  <img src="${user.pictureUrl || 'https://img.icons8.com/?size=80&id=492ILERveW8G&format=png'}"
                       class="w-10 h-10 rounded-full object-cover mt-1">
                  <div>
                    <p class="font-semibold">${user.displayName}</p>
                    <p class="text-xs text-gray-300">${user.userId}</p>
                  </div>`;
                const checkbox = userEl.querySelector('input[type="checkbox"]');
                checkbox.checked = selectedUsers.has(user.userId);
                checkbox.addEventListener('change', (e) => {
                  if (e.target.checked) selectedUsers.add(user.userId);
                  else selectedUsers.delete(user.userId);
                  updateSelectedCount();
                });
                resultsContainer.appendChild(userEl);
              });
            };

            // üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ (searchTerm)
            const performSearch = async () => {
              const searchTerm = searchInput.value.trim();
              if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>';
                return;
              }
              resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';
              try {
                const { users: data } = await invokeFunction({ action: 'getUsersWithRichMenu', searchTerm });
                renderUsers(data);
              } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>`;
              }
            };

            // üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const performAllSearch = async () => {
              resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...</p>';
              try {
                const { users: data } = await invokeFunction({ action: 'getUsersWithRichMenu', allUsers: true });
                renderUsers(data);
              } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>`;
              }
            };

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); performSearch(); }});
            allBtn.addEventListener('click', performAllSearch);

            searchInput.focus();
            updateSelectedCount();
          }
        }).then((result) => resolve(result.isConfirmed ? result.value : null));
      });
    }

       function renderRichMenuCard(menu) {
    const card = document.createElement('div');
    card.id = `menu-${menu.richMenuId}`;
    card.className =
        'bg-[#5d536b]/50 border border-white/10 rounded-2xl p-4 flex flex-col gap-4 fade-in hover:border-white/20 transition-all';

    
    const aspectRatio =
        menu.size && menu.size.width && menu.size.height
            ? `${menu.size.width} / ${menu.size.height}`
            : '2500 / 843';

    card.innerHTML = `
        <div class="img-container">
            <img src="data:image/png;base64,${menu.imageBase64 || ''}" 
                 alt="${menu.name}" 
                 style="aspect-ratio:${aspectRatio};" />
        </div>
        <div>
            <h3 class="font-bold text-lg text-[#989fce] truncate">${menu.name}</h3>
            <p class="text-xs text-gray-400 font-mono break-all">${menu.richMenuId}</p>
        </div>
        <div class="mt-auto grid grid-cols-2 gap-2 text-sm">
            <button class="link-user-btn btn-primary p-2 rounded-lg">‡πÄ‡∏ã‡πá‡∏ï Users</button>
            <button class="unlink-user-btn btn-primary p-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Users</button>
            <button class="set-default-btn btn-primary p-2 rounded-lg col-span-2">Set ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="delete-menu-btn btn-danger p-2 rounded-lg col-span-2">‡∏•‡∏ö Menu</button>
        </div>`;

    
    card.querySelector('.link-user-btn').addEventListener('click', () =>
        handleLinkUser(menu.richMenuId)
    );
    card.querySelector('.unlink-user-btn').addEventListener('click', () =>
        handleUnlinkUser(menu.richMenuId)
    );
    card.querySelector('.set-default-btn').addEventListener('click', () =>
        handleSetDefault(menu.richMenuId)
    );
    card.querySelector('.delete-menu-btn').addEventListener('click', () =>
        handleDeleteMenu(menu.richMenuId, menu.name)
    );

    return card;
}




        async function loadRichMenus() {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Rich Menu API...');
            richMenuGrid.innerHTML = '';
            richMenuDataCache.clear();

            try {
                const { richmenus } = await invokeFunction({ action: 'getList' });
                if (!richmenus || richmenus.length === 0) {
                    richMenuGrid.innerHTML = '<p class="text-center col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö Rich Menu</p>';
                    hideLoading();
                    return;
                }

                richmenus.forEach(menu => {
                    richMenuGrid.appendChild(renderRichMenuCard(menu));
                    richMenuDataCache.set(menu.richMenuId, menu);
                });

                const imageFetchPromises = richmenus.map(async (menu) => {
                    try {
                        const { imageBase64 } = await invokeFunction({ action: 'getRichMenuImage', richMenuId: menu.richMenuId });
                        const cardElement = document.getElementById(`menu-${menu.richMenuId}`);
                        if (cardElement && imageBase64) {
                            const imgContainer = cardElement.querySelector('.img-container');
                            imgContainer.classList.remove('animate-pulse');
                            const aspectRatio = (menu.size && menu.size.width && menu.size.height) ? `${menu.size.width} / ${menu.size.height}` : '2500 / 843';
                            imgContainer.innerHTML = `<img src="${imageBase64}" alt="${menu.name}" class="w-full object-cover" style="aspect-ratio: ${aspectRatio};">`;
                            
                            const cachedMenu = richMenuDataCache.get(menu.richMenuId);
                            if (cachedMenu) cachedMenu.imageBase64 = imageBase64;
                        }
                    } catch (imgErr) {
                        console.error(`Failed to load image for ${menu.richMenuId}`, imgErr);
                    }
                });

                await Promise.all(imageFetchPromises);

            } catch (err) {
                console.error(err);
                showToast('error', `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function handleLinkUser(richMenuId) {
            const userIds = await showUserSearchModal('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ User ‡∏ó‡∏µ‡πà‡∏à‡∏∞ Link Rich Menu');
            if (userIds && userIds.length > 0) {
                showLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Rich Menu ‡πÉ‡∏´‡πâ ${userIds.length} ‡∏Ñ‡∏ô...`);
                try {
                    await invokeFunction({ action: 'bulkLink', userIds, richMenuId });
                    showToast('success', '‡∏•‡∏¥‡∏á‡∏Å‡πå Rich Menu ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } catch (err) {
                    console.error(err);
                    showToast('error', `‡∏•‡∏¥‡∏á‡∏Å‡πå Rich Menu ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }
        
        async function handleUnlinkUser(richMenuId) {
            const userIds = await showUserSearchModal('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ User ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu');
            if (userIds && userIds.length > 0) {
                showLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu ‡∏Ç‡∏≠‡∏á ${userIds.length} ‡∏Ñ‡∏ô...`);
                try {
                    const data = await invokeFunction({ action: 'bulkUnlink', userIds });
                    showToast('success', data.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } catch (err) {
                    console.error(err);
                    showToast('error', `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }

        async function handleSetDefault(richMenuId) {
            Swal.fire({
                title: '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?', text: 'Rich Menu ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Rich Menu ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á', icon: 'warning',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...');
                    try {
                        await invokeFunction({ action: 'setDefault', richMenuId });
                        showToast('success', '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }
        
        cancelDefaultBtn.addEventListener('click', () => {
             Swal.fire({
                title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?', text: '‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', icon: 'warning',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...');
                    try {
                        await invokeFunction({ action: 'cancelDefault' });
                        showToast('success', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        });

        async function handleDeleteMenu(richMenuId, menuName) {
            Swal.fire({
                title: `‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö Rich Menu "${menuName}"?`, text: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!", icon: 'error',
                showCancelButton: true, confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonClass: 'btn-danger', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö Rich Menu...');
                    try {
                        await invokeFunction({ action: 'deleteMenu', richMenuId });
                        showToast('success', '‡∏•‡∏ö Rich Menu ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        await loadRichMenus();
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡∏•‡∏ö Rich Menu ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF...');
            try {
                await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                await loadRichMenus();
            } catch (err) {
                console.error('Critical Error:', err);
                showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ');
                richMenuGrid.innerHTML = `<p class="text-center col-span-full text-red-400 p-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LIFF ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>`;
                hideLoading();
            }
        });
    </script>
</body>
</html>
