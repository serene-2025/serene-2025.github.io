<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rich Menu API-LINE OA</title>
  <meta name="description" content="Rich Menu API Admin for LIFF" />
  <meta name="author" content="9one" />
  <meta property="og:title" content="Rich Menu API Admin-9one" />
  <meta property="og:description" content="Rich Menu API for LIFF" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://lh3.googleusercontent.com/d/1diz2KXxiOna6_ltL_GKxvfT3JkJCZtvG" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap');
    body { font-family: 'Prompt', sans-serif; background-color: #272838; color: #F0F0F0; }
    .gradient-bg { background: linear-gradient(135deg, #272838 0%, #5d536b 100%); }
    .btn-primary { background: linear-gradient(135deg, #347fc4 0%, #5d536b 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 127, 196, 0.2); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 127, 196, 0.3); }
    .btn-danger { background: linear-gradient(135deg, #c43434 0%, #6b5353 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(196, 52, 52, 0.2); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(196, 52, 52, 0.3); }
    
    .swal2-popup { background-color: #272838 !important; color: #73B305 !important; border: 1px solid #7d6b91; border-radius: 1rem !important; }
    .swal2-title { color: #989fce !important; }
    .swal2-html-container { color: #F0F0F0 !important; margin: 0 !important; }
    .swal2-input { 
      background-color: #272838 !important; 
      border: 1px solid #7d6b91 !important;
      color: #F0F0F0 !important;
      border-radius: 0.5rem !important;
    }
    .swal2-input:focus { box-shadow: 0 0 0 3px rgba(152, 159, 206, 0.5) !important; }
    .swal2-container { align-items: center !important; }

    button, a, label, [role=button], input[type=checkbox] {
      -webkit-tap-highlight-color: transparent;
    }

  
    #swal-user-results {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

   .img-container {
  position: relative;
  width: 100%;
  border-radius: 0.5rem;
  overflow: hidden;
  background: #222;
}


.img-container img {
  width: 100%;
  height: auto;
  aspect-ratio: 2500 / 843;  
  object-fit: contain;        
  display: block;
  pointer-events: none;        
  user-select: none;          
}

    #loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: rgba(39, 40, 56, 0.8); backdrop-filter: blur(5px); 
      display: none; justify-content: center; align-items: center; 
      z-index: 9999; flex-direction: column; gap: 1rem; 
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">

  <div id="loading-overlay">
    <img src="https://developers.line.biz/media/line-mini-app/LINE_spinner_light.svg" alt="Loading..." class="w-16 h-16">
    <p id="loading-text" class="text-lg text-[#989fce]">กำลังโหลด...</p>
  </div>

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8 fade-in">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#989fce] to-[#347fc4]">
        Rich Menu API
      </h1>
      <p class="text-lg text-gray-300">จัดการ Rich Menu API ของ LINE OA</p>
    </header>

    <div class="mb-8 flex justify-center gap-4 fade-in" style="animation-delay: 0.2s;">
      <button id="cancel-default-btn" class="btn-danger font-bold py-2 px-6 rounded-lg">ยกเลิก Rich Menu เริ่มต้น</button>
    </div>

    <main id="richmenu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <!-- Rich Menu -->
    </main>
  </div>
    <script type="module">
        const LIFF_ID = "2000143615-RQWZXWKA";
        const SUPABASE_URL = "https://kiumelolsilduqnvrekf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU";

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const richMenuGrid = document.getElementById('richmenu-grid');
        const cancelDefaultBtn = document.getElementById('cancel-default-btn');
        
        let richMenuDataCache = new Map();

        const showLoading = (text = 'กำลังโหลด...') => {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        };
        const hideLoading = () => {
            loadingOverlay.style.display = 'none';
        };
        const showToast = (icon, title) => {
            Swal.fire({
                icon: icon, title: title, toast: true, position: 'top-end',
                showConfirmButton: false, timer: 3000, timerProgressBar: true,
                customClass: { popup: '!bg-[#5d536b] !text-white' }
            });
        };

        async function invokeFunction(payload) {
            const { data, error } = await supabaseClient.functions.invoke('manage-rich-menu', { body: payload });
            if (error) throw error;
            return data;
        }

         async function showUserSearchModal(title) {
    return new Promise((resolve) => {
      let selectedUsers = new Set();
      Swal.fire({
        title: title,
        width: 'clamp(300px, 90%, 600px)',
        html: `
          <div class="p-2 text-left">
            <div class="space-y-2 sm:space-y-0 sm:flex sm:gap-2 sm:items-center">
              <input 
                id="swal-user-search" 
                class="flex-1 min-w-0 px-3 py-2 rounded-lg border border-[#5d536b] bg-[#1c1c28] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                placeholder="พิมพ์ userId หรือชื่อ..."
              >
              <button id="swal-user-search-btn" class="btn-primary py-2 px-5 rounded-lg font-semibold">ค้นหา</button>
              <button id="swal-user-all-btn" class="btn-primary py-2 px-5 rounded-lg font-semibold">ค้นหาทั้งหมด</button>
            </div>
                        <div id="swal-user-select-all-container" class="mt-2 hidden">
              <button id="swal-user-select-all-btn" class="btn-primary w-full">เลือกทั้งหมด</button>
            </div>
            <div id="swal-user-results" class="mt-4 max-h-60 overflow-y-auto border border-[#5d536b] rounded-lg">
              <p class="text-center text-gray-400 p-4">กรุณาพิมพ์เพื่อค้นหาผู้ใช้ หรือกด "ค้นหาทั้งหมด"</p>
            </div>
          </div>
        `,
        showCancelButton: true,
        cancelButtonText: 'ยกเลิก',
        showConfirmButton: true,
        confirmButtonText: 'ยืนยัน',
        preConfirm: () => Array.from(selectedUsers),
        didOpen: () => {
          const searchInput = document.getElementById('swal-user-search');
          const searchBtn = document.getElementById('swal-user-search-btn');
          const allBtn = document.getElementById('swal-user-all-btn');
          const resultsContainer = document.getElementById('swal-user-results');
          const confirmBtn = Swal.getConfirmButton();
          confirmBtn.disabled = true;

          const updateSelectedCount = () => {
            const count = selectedUsers.size;
            confirmBtn.textContent = `ยืนยัน (${count})`;
            confirmBtn.disabled = count === 0;
          };

          // ฟังก์ชันแสดงผล user
          const renderUsers = (users) => {
            if (!users || users.length === 0) {
              resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">ไม่พบผู้ใช้</p>';
              return;
            }
            resultsContainer.innerHTML = '';
            users.forEach(user => {
              const userEl = document.createElement('label');
              userEl.className = 'flex items-start gap-3 p-2 rounded-lg hover:bg-[#7d6b91] cursor-pointer transition-colors m-1';

              const linkedMenuInfo = richMenuDataCache.get(user.linkedRichMenuId);
              let linkedMenuInfoHTML = `<p class="text-xs mt-1 text-gray-400">ใช้ Rich Menu เริ่มต้น</p>`;
              if (linkedMenuInfo) {
                linkedMenuInfoHTML = `
                  <div class="mt-1 p-1 bg-black/20 rounded-md">
                    <p class="text-xs text-green-400 truncate mb-1" title="${linkedMenuInfo.name}">เมนู: ${linkedMenuInfo.name}</p>
                    <img src="${linkedMenuInfo.imageBase64}" class="w-24 h-auto rounded-sm">
                  </div>`;
              }

              userEl.innerHTML = `
                <input type="checkbox" class="form-checkbox h-5 w-5 mt-2 bg-transparent rounded border-[#989fce] text-[#347fc4] focus:ring-0" data-userid="${user.userId}">
                <img src="${user.pictureUrl || ''}" onerror="this.onerror=null;this.src='https://img.icons8.com/?size=80&id=492ILERveW8G&format=png'" alt="Profile" class="w-10 h-10 rounded-full object-cover flex-shrink-0 mt-1">
                <div class="overflow-hidden flex-grow">
                  <p class="font-semibold truncate">${user.displayName}</p>
                  <p class="text-xs text-gray-300 font-mono break-all truncate">${user.userId}</p>
                  ${linkedMenuInfoHTML}
                </div>`;
              const checkbox = userEl.querySelector('input[type="checkbox"]');
              checkbox.checked = selectedUsers.has(user.userId);
              checkbox.addEventListener('change', (e) => {
                if (e.target.checked) selectedUsers.add(user.userId);
                else selectedUsers.delete(user.userId);
                updateSelectedCount();
              });
              resultsContainer.appendChild(userEl);
            });
          };
   selectAllContainer.classList.toggle(data === allUsersData && data.length > 0);
          };
          // ค้นหาเฉพาะ
          const performSearch = async () => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length < 2) {
              resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">กรุณาพิมพ์อย่างน้อย 2 ตัวอักษร</p>';
              return;
            }
            resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">กำลังค้นหา...</p>';
            try {
              const { users } = await invokeFunction({ action: 'getUsersWithRichMenu', searchTerm });
              renderUsers(users);
            } catch (err) {
              console.error("Search error:", err);
              resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">เกิดข้อผิดพลาดในการค้นหา</p>`;
            }
          };

          // ค้นหาทั้งหมด
          const performAllSearch = async () => {
            resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">กำลังโหลดผู้ใช้ทั้งหมด...</p>';
            try {
              const { users } = await invokeFunction({ action: 'getUsersWithRichMenu', allUsers: true });
              renderUsers(users);
            } catch (err) {
              console.error("All search error:", err);
              resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">เกิดข้อผิดพลาดในการโหลดผู้ใช้ทั้งหมด</p>`;
            }
          };

          selectAllBtn.addEventListener('click', () => {
            allUsersData.forEach(u=>selectedUsers.add(u.userId));
            resultsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
            updateSelectedCount();
          });

          searchBtn.addEventListener('click', performSearch);
          searchInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); performSearch(); }});
          allBtn.addEventListener('click', performAllSearch);
          searchInput.focus();
          updateSelectedCount();
        }
      }).then((result) => resolve(result.isConfirmed ? result.value : null));
   
  }

       function renderRichMenuCard(menu) {
    const card = document.createElement('div');
    card.id = `menu-${menu.richMenuId}`;
    card.className =
        'bg-[#5d536b]/50 border border-white/10 rounded-2xl p-4 flex flex-col gap-4 fade-in hover:border-white/20 transition-all';

    
    const aspectRatio =
        menu.size && menu.size.width && menu.size.height
            ? `${menu.size.width} / ${menu.size.height}`
            : '2500 / 843';

    card.innerHTML = `
        <div class="img-container">
            <img src="data:image/png;base64,${menu.imageBase64 || ''}" 
                 alt="${menu.name}" 
                 style="aspect-ratio:${aspectRatio};" />
        </div>
        <div>
            <h3 class="font-bold text-lg text-[#989fce] truncate">${menu.name}</h3>
            <p class="text-xs text-gray-400 font-mono break-all">${menu.richMenuId}</p>
        </div>
        <div class="mt-auto grid grid-cols-2 gap-2 text-sm">
            <button class="link-user-btn btn-primary p-2 rounded-lg">เซ็ต Users</button>
            <button class="unlink-user-btn btn-primary p-2 rounded-lg">ยกเลิก Users</button>
            <button class="set-default-btn btn-primary p-2 rounded-lg col-span-2">Set ทั้งหมด</button>
            <button class="delete-menu-btn btn-danger p-2 rounded-lg col-span-2">ลบ Menu</button>
        </div>`;

    
    card.querySelector('.link-user-btn').addEventListener('click', () =>
        handleLinkUser(menu.richMenuId)
    );
    card.querySelector('.unlink-user-btn').addEventListener('click', () =>
        handleUnlinkUser(menu.richMenuId)
    );
    card.querySelector('.set-default-btn').addEventListener('click', () =>
        handleSetDefault(menu.richMenuId)
    );
    card.querySelector('.delete-menu-btn').addEventListener('click', () =>
        handleDeleteMenu(menu.richMenuId, menu.name)
    );

    return card;
}




        async function loadRichMenus() {
            showLoading('กำลังโหลดข้อมูล Rich Menu API...');
            richMenuGrid.innerHTML = '';
            richMenuDataCache.clear();

            try {
                const { richmenus } = await invokeFunction({ action: 'getList' });
                if (!richmenus || richmenus.length === 0) {
                    richMenuGrid.innerHTML = '<p class="text-center col-span-full">ไม่พบ Rich Menu</p>';
                    hideLoading();
                    return;
                }

                richmenus.forEach(menu => {
                    richMenuGrid.appendChild(renderRichMenuCard(menu));
                    richMenuDataCache.set(menu.richMenuId, menu);
                });

                const imageFetchPromises = richmenus.map(async (menu) => {
                    try {
                        const { imageBase64 } = await invokeFunction({ action: 'getRichMenuImage', richMenuId: menu.richMenuId });
                        const cardElement = document.getElementById(`menu-${menu.richMenuId}`);
                        if (cardElement && imageBase64) {
                            const imgContainer = cardElement.querySelector('.img-container');
                            imgContainer.classList.remove('animate-pulse');
                            const aspectRatio = (menu.size && menu.size.width && menu.size.height) ? `${menu.size.width} / ${menu.size.height}` : '2500 / 843';
                            imgContainer.innerHTML = `<img src="${imageBase64}" alt="${menu.name}" class="w-full object-cover" style="aspect-ratio: ${aspectRatio};">`;
                            
                            const cachedMenu = richMenuDataCache.get(menu.richMenuId);
                            if (cachedMenu) cachedMenu.imageBase64 = imageBase64;
                        }
                    } catch (imgErr) {
                        console.error(`Failed to load image for ${menu.richMenuId}`, imgErr);
                    }
                });

                await Promise.all(imageFetchPromises);

            } catch (err) {
                console.error(err);
                showToast('error', `โหลดข้อมูลไม่สำเร็จ: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function handleLinkUser(richMenuId) {
            const userIds = await showUserSearchModal('ค้นหา User ที่จะ Link Rich Menu');
            if (userIds && userIds.length > 0) {
                showLoading(`กำลังลิงก์ Rich Menu ให้ ${userIds.length} คน...`);
                try {
                    await invokeFunction({ action: 'bulkLink', userIds, richMenuId });
                    showToast('success', 'ลิงก์ Rich Menu สำเร็จ');
                } catch (err) {
                    console.error(err);
                    showToast('error', `ลิงก์ Rich Menu ไม่สำเร็จ: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }
        
        async function handleUnlinkUser(richMenuId) {
            const userIds = await showUserSearchModal('ค้นหา User ที่จะยกเลิก Rich Menu');
            if (userIds && userIds.length > 0) {
                showLoading(`กำลังยกเลิก Rich Menu ของ ${userIds.length} คน...`);
                try {
                    const data = await invokeFunction({ action: 'bulkUnlink', userIds });
                    showToast('success', data.message || 'ยกเลิกการลิงก์สำเร็จ');
                } catch (err) {
                    console.error(err);
                    showToast('error', `ยกเลิกการลิงก์ไม่สำเร็จ: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }

        async function handleSetDefault(richMenuId) {
            Swal.fire({
                title: 'ตั้งเป็น Rich Menu เริ่มต้น?', text: 'Rich Menu นี้จะแสดงให้ผู้ใช้ทุกคนที่ยังไม่มี Rich Menu เฉพาะของตัวเอง', icon: 'warning',
                showCancelButton: true, confirmButtonText: 'ยืนยัน', cancelButtonText: 'ยกเลิก', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('กำลังตั้งค่า...');
                    try {
                        await invokeFunction({ action: 'setDefault', richMenuId });
                        showToast('success', 'ตั้งเป็น Rich Menu เริ่มต้นสำเร็จ');
                    } catch (err) {
                        console.error(err);
                        showToast('error', `ตั้งค่าไม่สำเร็จ: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }
        
        cancelDefaultBtn.addEventListener('click', () => {
             Swal.fire({
                title: 'ยกเลิก Rich Menu เริ่มต้น?', text: 'จะไม่มี Rich Menu เริ่มต้นสำหรับผู้ใช้ใหม่ทั้งหมด', icon: 'warning',
                showCancelButton: true, confirmButtonText: 'ยืนยัน', cancelButtonText: 'ยกเลิก', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('กำลังยกเลิก...');
                    try {
                        await invokeFunction({ action: 'cancelDefault' });
                        showToast('success', 'ยกเลิก Rich Menu เริ่มต้นสำเร็จ');
                    } catch (err) {
                        console.error(err);
                        showToast('error', `ยกเลิกไม่สำเร็จ: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        });

        async function handleDeleteMenu(richMenuId, menuName) {
            Swal.fire({
                title: `แน่ใจหรือไม่ที่จะลบ Rich Menu "${menuName}"?`, text: "การกระทำนี้ไม่สามารถย้อนกลับได้!", icon: 'error',
                showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก',
                confirmButtonClass: 'btn-danger', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('กำลังลบ Rich Menu...');
                    try {
                        await invokeFunction({ action: 'deleteMenu', richMenuId });
                        showToast('success', 'ลบ Rich Menu สำเร็จ');
                        await loadRichMenus();
                    } catch (err) {
                        console.error(err);
                        showToast('error', `ลบ Rich Menu ไม่สำเร็จ: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('กำลังเริ่มต้น LIFF...');
            try {
                await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                await loadRichMenus();
            } catch (err) {
                console.error('Critical Error:', err);
                showToast('error', 'เกิดข้อผิดพลาด ไม่สามารถโหลดแอปได้');
                richMenuGrid.innerHTML = `<p class="text-center col-span-full text-red-400 p-8">เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน ไม่สามารถเชื่อมต่อกับ LIFF หรือโหลดข้อมูลได้</p>`;
                hideLoading();
            }
        });
    </script>
</body>
</html>
