<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* (‡πÉ‡∏ä‡πâ CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) */
    body { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; position: relative; overflow-x: hidden; }
    /* ... (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á CSS ‡πÄ‡∏î‡∏¥‡∏°) ... */
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
  <!-- Floating Elements -->
  <div class="floating-elements"></div>
  <div class="form-container max-w-2xl w-full rounded-2xl shadow-2xl p-8 relative z-10">
    <!-- Header -->
    <div class="text-center mb-10">
      <div class="w-24 h-24 header-icon rounded-full mx-auto mb-6 flex items-center justify-center text-4xl"> üè† </div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-pink-600 bg-clip-text text-transparent mb-3"> ‚ú® ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚ú® </h1>
      <p class="text-gray-600 text-lg">üåü ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å üåü</p>
      <div class="flex justify-center gap-2 mt-4 text-2xl">
        <span class="animate-bounce">üéâ</span>
        <span class="animate-bounce" style="animation-delay: 0.1s;">üéä</span>
        <span class="animate-bounce" style="animation-delay: 0.2s;">üéà</span>
      </div>
    </div>

    <!-- Registration Form -->
    <form id="registrationForm" class="space-y-6">
      <!-- (‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- UID -->
        <div class="md:col-span-2">
          <label for="uid" class="form-label text-sm mb-2"> üÜî ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <span class="required-star">*</span> </label>
          <input type="text" id="uid" name="uid" required class="input-focus w-full px-4 py-3 rounded-lg transition-all duration-300" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        </div>
        <!-- ... (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°) ... -->
      </div>

      <!-- Terms and Conditions -->
      <div class="pt-6">
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-200">
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="agreeTerms" name="agreeTerms" class="mt-1 w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-300">
            <label for="agreeTerms" class="text-sm text-gray-700 leading-relaxed cursor-pointer">
              <span class="font-semibold text-purple-700">üìã ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><br>
              ‡∏â‡∏±‡∏ô‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÇ‡∏î‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô <span class="text-purple-600 font-medium cursor-pointer hover:underline" onclick="showPDPAInfo()">üîí PDPA</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pt-6">
        <button type="submit" id="submitBtn" disabled class="submit-btn w-full text-white py-4 px-6 rounded-xl font-bold text-lg focus:outline-none focus:ring-4 focus:ring-purple-300 transform hover:scale-105 transition-all duration-300 flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
          <span class="mr-2">üöÄ</span>
          <span id="submitText">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢!</span>
          <div id="loadingSpinner" class="loading-spinner ml-3 hidden"></div>
        </button>
        <p id="agreeMessage" class="text-center text-sm text-gray-500 mt-3"> ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô </p>
      </div>
    </form>

    <!-- Footer -->
    <div class="text-center mt-8 space-y-4">
      <div class="text-gray-500 text-sm">
        <p>üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
      </div>
      <div class="copyright rounded-lg py-3 px-4 mx-auto max-w-xs">
        <p class="text-white text-sm font-medium"> ¬© 2025 <span class="font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">9one</span> </p>
        <p class="text-white text-xs opacity-80 mt-1"> ‚ú® All rights reserved ‚ú® </p>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const supabaseUrl = 'https://kiumelolsilduqnvrekf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdW1lbG9sc2lsZHVxbnZyZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODUyNzYsImV4cCI6MjA3MjY2MTI3Nn0.3hCFJiDrkgNJQEggS8MkRnxlhvqIMAax_a73NJq14gU';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // LIFF Variables
    let liffProfile = null;
    let replyToken = null;

    // LINE Bot Configuration
    const LINE_BOT_CONFIG = {
      channelAccessToken: 'y1v3UxzR5qvBoffq9y5bQXgxVwHgvCc7BciNiIw4wJkq/iV9Yh1gpwjHgqo5STMHjRaeZqu1Dz7qSsv8c5CxyN5Q4qPFyvqYJpKGa52HCkwI+hiCyKKHoWzqm2y+/Umo193Q1rz+EeW6fl+JpapFzQdB04t89/1O/w1cDnyilFU=',
      messagingApiUrl: 'https://api.line.me/v2/bot/message/reply'
    };

    // Telegram Bot Configuration
    const TELEGRAM_CONFIG = {
      botToken: '8285069899:AAF-L27XDknWC98-FMRvSod5ikV2tGO8Jgo',
      chatId: '7585120244',
      apiUrl: 'https://api.telegram.org/bot'
    };

    // Initialize LIFF
    async function initializeLiff(liffId) {
      try {
        await liff.init({ liffId: liffId });
        if (liff.isLoggedIn()) {
          liffProfile = await liff.getProfile();
          console.log('LIFF Profile:', liffProfile);
          fillFormWithLiffData();
          Swal.fire({
            icon: 'success',
            title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${liffProfile.displayName}`,
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#667eea',
            timer: 2000,
            timerProgressBar: true
          });
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#667eea'
        });
      }
    }

    // Fill form with LIFF data
    function fillFormWithLiffData() {
      if (liffProfile) {
        document.getElementById('uid').value = liffProfile.userId;
        document.getElementById('uid').readOnly = true;
        document.getElementById('uid').classList.add('bg-gray-100');
        document.getElementById('line_name').value = liffProfile.displayName;
        document.getElementById('line_name').readOnly = true;
        document.getElementById('line_name').classList.add('bg-gray-100');
        if (liffProfile.pictureUrl) {
          const headerIcon = document.querySelector('.header-icon');
          headerIcon.innerHTML = `<img src="${liffProfile.pictureUrl}" alt="Profile" class="w-full h-full rounded-full object-cover">`;
        }
        const headerTitle = document.querySelector('h1');
        headerTitle.innerHTML = `‚ú® ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚ú®<br><small class="text-lg font-normal">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${liffProfile.displayName}! üëã</small>`;
      }
    }

    // Get Reply Token from URL parameters
    function getReplyTokenFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('replyToken');
      if (token) {
        replyToken = token;
        console.log('‚úÖ Reply Token found:', token);
      } else {
        console.log('‚ö†Ô∏è No Reply Token in URL - will not send LINE message to save quota');
      }
    }

    // Initialize LIFF on page load
    window.onload = function () {
      getReplyTokenFromURL();
      initializeLiff("2000143615-GxkrLkE5");
    };

    // Form elements
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const agreeTerms = document.getElementById('agreeTerms');
    const agreeMessage = document.getElementById('agreeMessage');

    // Check agreement status
    function checkAgreement() {
      if (agreeTerms.checked) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        agreeMessage.textContent = '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';
        agreeMessage.classList.remove('text-gray-500');
        agreeMessage.classList.add('text-green-600');
      } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        agreeMessage.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
        agreeMessage.classList.remove('text-green-600');
        agreeMessage.classList.add('text-gray-500');
      }
    }

    // Set loading state
    function setLoading(loading) {
      if (loading) {
        submitBtn.disabled = true;
        submitText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
        loadingSpinner.classList.remove('hidden');
        submitBtn.classList.add('opacity-75');
      } else {
        checkAgreement();
        submitText.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢!';
        loadingSpinner.classList.add('hidden');
        submitBtn.classList.remove('opacity-75');
      }
    }

    // Agreement checkbox event listener
    agreeTerms.addEventListener('change', checkAgreement);

    // Initialize agreement check on page load
    checkAgreement();

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);

      try {
        const formData = new FormData(form);
        const data = {
          uid: formData.get('uid'),
          line_name: formData.get('line_name') || null,
          fullname: formData.get('fullname') || null,
          house_no: formData.get('house_no') || null,
          soi: formData.get('soi') || null,
          living_status: formData.get('living_status') || null,
          member_count: formData.get('member_count') ? parseInt(formData.get('member_count')) : null,
          phone: formData.get('phone') || null,
          email: formData.get('email') || null,
          line_id: formData.get('line_id') || null,
          profile: liffProfile ? liffProfile.pictureUrl : null,
          richmenu: 'richmenu-0bd347b4edc64174ace50549713b0a3b',
          visit_count: 0
        };

        // Check agreement
        if (!agreeTerms.checked) {
          await Swal.fire({
            icon: 'warning',
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#667eea'
          });
          return;
        }

        // Validate required fields
        if (!data.uid || !data.fullname || !data.house_no || !data.soi || !data.living_status || !data.member_count || !data.phone) {
          await Swal.fire({
            icon: 'warning',
            title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#667eea'
          });
          return;
        }

        // Insert data to Supabase
        const { error } = await supabase
          .from('userhome')
          .insert([data]);

        if (error) {
          if (error.code === '23505') {
            await Swal.fire({
              icon: 'error',
              title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
              text: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô',
              confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
              confirmButtonColor: '#667eea'
            });
            return;
          }
          throw new Error(error.message);
        }

        // Success - Send Messages
        try {
          // Send welcome message to user via LINE (using Reply Token if available)
          if (replyToken) {
            const welcomeFlexMessage = createWelcomeFlexMessage(data);
            const messageSent = await sendFlexMessageToUser(replyToken, welcomeFlexMessage);
            if (messageSent) {
              console.log('‚úÖ Reply message sent (no quota used)');
            } else {
              console.log('‚ö†Ô∏è Failed to send reply message');
            }
          } else {
            console.log('‚ö†Ô∏è No Reply Token available - message not sent to save quota');
          }

          // Send notification to admin via Telegram
          await sendTelegramNotification(data);
          console.log('‚úÖ Messages processed successfully');

        } catch (messageError) {
          console.error('‚ùå Error sending messages:', messageError);
        }

        await Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
          html: `
            <div class="text-center">
              <p class="mb-4">üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö!</p>
              <p class="text-sm text-gray-600 mb-2">‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</p>
              ${replyToken ? '<p class="text-sm text-green-600 mb-1">üì± ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤)</p>' : '<p class="text-sm text-orange-600 mb-1">üì± ‡πÑ‡∏°‡πà‡∏°‡∏µ Reply Token - ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤</p>'}
              <p class="text-sm text-gray-600">üì¢ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô Telegram ‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `,
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#667eea',
          timer: 4000,
          timerProgressBar: true,
          showClass: {
            popup: 'animate__animated animate__bounceIn'
          }
        });

        form.reset();
        if (liffProfile) {
          setTimeout(() => {
            fillFormWithLiffData();
          }, 100);
        }

      } catch (error) {
        console.error('Registration error:', error);
        await Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#667eea'
        });
      } finally {
        setLoading(false);
      }
    });

    // Input validation and formatting
    document.getElementById('phone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 10) value = value.slice(0, 10);
      if (value.length >= 6) {
        value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
      } else if (value.length >= 3) {
        value = value.replace(/(\d{3})(\d+)/, '$1-$2');
      }
      e.target.value = value;
    });

    // Auto-generate UID suggestion
    document.getElementById('uid').addEventListener('focus', function(e) {
      if (!e.target.value) {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5);
        e.target.placeholder = ` ‡πÄ‡∏ä‡πà‡∏ô: USER${timestamp}${random}`;
      }
    });

    // Create Welcome Flex Message
    function createWelcomeFlexMessage(userData) {
      return {
        type: "flex",
        altText: "üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà!",
        contents: {
          type: "bubble",
          size: "kilo",
          header: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "üéâ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                    weight: "bold",
                    size: "xl",
                    color: "#ffffff",
                    align: "center"
                  },
                  {
                    type: "text",
                    text: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
                    size: "sm",
                    color: "#ffffff",
                    align: "center",
                    margin: "sm"
                  }
                ]
              }
            ],
            backgroundColor: "#667eea",
            paddingAll: "20px"
          },
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üë§ ‡∏ä‡∏∑‡πà‡∏≠:",
                    size: "sm",
                    color: "#666666",
                    flex: 2
                  },
                  {
                    type: "text",
                    text: userData.fullname || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
                    size: "sm",
                    color: "#333333",
                    flex: 3,
                    weight: "bold"
                  }
                ],
                margin: "md"
              },
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:",
                    size: "sm",
                    color: "#666666",
                    flex: 2
                  },
                  {
                    type: "text",
                    text: `${userData.house_no || ""} ${userData.soi || ""}`,
                    size: "sm",
                    color: "#333333",
                    flex: 3,
                    weight: "bold"
                  }
                ],
                margin: "md"
              },
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå:",
                    size: "sm",
                    color: "#666666",
                    flex: 2
                  },
                  {
                    type: "text",
                    text: userData.phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
                    size: "sm",
                    color: "#333333",
                    flex: 3,
                    weight: "bold"
                  }
                ],
                margin: "md"
              },
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "text",
                    text: "üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:",
                    size: "sm",
                    color: "#666666",
                    flex: 2
                  },
                  {
                    type: "text",
                    text: `${userData.member_count || 0} ‡∏Ñ‡∏ô`,
                    size: "sm",
                    color: "#333333",
                    flex: 3,
                    weight: "bold"
                  }
                ],
                margin: "md"
              },
              {
                type: "separator",
                margin: "xl"
              },
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "‚ú® ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤!",
                    size: "sm",
                    color: "#667eea",
                    align: "center",
                    weight: "bold"
                  },
                  {
                    type: "text",
                    text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                    size: "xs",
                    color: "#999999",
                    align: "center",
                    margin: "sm"
                  }
                ],
                margin: "xl"
              }
            ],
            spacing: "sm",
            paddingAll: "20px"
          },
          footer: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "button",
                style: "primary",
                height: "sm",
                action: {
                  type: "uri",
                  label: "üè† ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å",
                  uri: "https://line.me/R/app/2000143615-GxkrLkE5"
                },
                color: "#667eea"
              }
            ],
            spacing: "sm",
            paddingAll: "20px"
          }
        }
      };
    }

    // Send Flex Message to User using Reply Token (via Supabase Edge Function)
    async function sendFlexMessageToUser(replyToken, flexMessage) {
      try {
        const response = await fetch(
          "https://kiumelolsilduqnvrekf.supabase.co/functions/v1/line-webhook",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${supabaseKey}`,
            },
            body: JSON.stringify({
              replyToken: replyToken,
              messages: [flexMessage],
            }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply message");
        }

        return true;
      } catch (error) {
        console.error("Error sending flex reply message:", error);
        return false;
      }
    }

    // Send notification to admin via Telegram
    async function sendTelegramNotification(userData) {
      try {
        const message = createTelegramMessage(userData);
        console.log('Sending Telegram notification...');
        console.log('Message:', message);

        const response = await fetch(
          `${TELEGRAM_CONFIG.apiUrl}${TELEGRAM_CONFIG.botToken}/sendMessage`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: TELEGRAM_CONFIG.chatId,
              text: message,
              parse_mode: 'HTML'
            })
          }
        );

        if (!response.ok) {
          throw new Error('Failed to send Telegram message');
        }
        return true;
      } catch (error) {
        console.error('Error sending Telegram notification:', error);
        return false;
      }
    }

    // Create Telegram message format
    function createTelegramMessage(userData) {
      const timestamp = new Date().toLocaleString('th-TH');
      return `
        üîî <b>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô!</b>
        üìÖ <i>${timestamp}</i>
        üë§ <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</b>
        üÜî UID: <code>${userData.uid || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</code>
        üí¨ Line: ${userData.line_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        üë§ ‡∏ä‡∏∑‡πà‡∏≠: <b>${userData.fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</b>
        üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${userData.house_no || ''} ${userData.soi || ''}
        üè° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${userData.living_status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: <b>${userData.member_count || 0}</b> ‡∏Ñ‡∏ô
        üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå: <code>${userData.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</code>
        üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${userData.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        üÜî Line ID: ${userData.line_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        ‚úÖ <i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</i>
      `;
    }

    // Show PDPA Information
    function showPDPAInfo() {
      Swal.fire({
        title: 'üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö PDPA',
        html: `
          <div class="text-left space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-bold text-blue-800 mb-2">üìã PDPA ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</h4>
              <p class="text-sm text-gray-700">
                <strong>Personal Data Protection Act (PDPA)</strong> ‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
              </p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <h4 class="font-bold text-green-800 mb-2">üõ°Ô∏è ‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?</h4>
              <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                <li>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</li>
                <li>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢</li>
                <li>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•</li>
                <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Line ID (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)</li>
              </ul>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <h4 class="font-bold text-purple-800 mb-2">üéØ ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</h4>
              <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                <li>‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>
                <li>‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</li>
                <li>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</li>
                <li>‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</li>
              </ul>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg">
              <h4 class="font-bold text-orange-800 mb-2">üîê ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
              <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                <li>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                <li>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                <li>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                <li>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</li>
              </ul>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
              <p class="text-sm text-red-700">
                <strong>üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤:</strong> ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              </p>
            </div>
          </div>
        `,
        width: '600px',
        confirmButtonText: '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
        confirmButtonColor: '#667eea',
        showClass: {
          popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
          popup: 'animate__animated animate__fadeOutUp'
        }
      });
    }
  </script>
</body>
</html>
